<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>194</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    194
                    <a href="193.html">prev</a>
                    <a href="195.html">next</a>
                    <a href="194_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.money.Money;
  23 import org.broadleafcommerce.common.service.GenericEntityService;
  24 import org.broadleafcommerce.core.offer.dao.OfferDao;
  25 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  26 import org.broadleafcommerce.core.offer.domain.Offer;
  27 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;
  28 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;
  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  30 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  31 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  32 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  43 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  44 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;
  45 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  46 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  47 import org.broadleafcommerce.core.order.domain.Order;
  48 import org.broadleafcommerce.core.order.domain.OrderItem;
  49 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  50 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  51 import org.springframework.stereotype.Service;
  52 
  53 import java.util.ArrayList;
  54 import java.util.Collections;
  55 import java.util.HashMap;
  56 import java.util.Iterator;
  57 import java.util.List;
  58 import java.util.Map;
  59 
  60 import javax.annotation.Resource;
  61 
  62 /**
  63  * @author jfischer, bpolster
  64  */
  65 @Service(&quot;blOrderOfferProcessor&quot;)
  66 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {
  67 
  68     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);
  69     
  70     @Resource(name = &quot;blPromotableItemFactory&quot;)
  71     protected PromotableItemFactory promotableItemFactory;
  72 
  73     @Resource(name = &quot;blOrderItemDao&quot;)
  74     protected OrderItemDao orderItemDao;
  75 
  76     @Resource(name = &quot;blOfferDao&quot;)
  77     protected OfferDao offerDao;
  78 
  79     @Resource(name = &quot;blOfferServiceUtilities&quot;)
  80     protected OfferServiceUtilities offerServiceUtilities;
  81 
  82 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         super(promotableOfferUtility);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85     }</span>
  86 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  89     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
  90 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91     @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92     protected GenericEntityService entityService;</span>
  93 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  94 
  95     @Override
<abbr title="  96     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  96     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr>
  97         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {
<abbr title="  98             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  98             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr>
  99             return;
 100         }
 101         boolean orderLevelQualification = false;
 102         //Order Qualification
 103         orderQualification:
 104         {
 105             if (couldOfferApplyToOrder(offer, promotableOrder)) {
 106                 orderLevelQualification = true;
 107                 break orderQualification;
 108             }
<abbr title=" 109             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 109             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr>
 110                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {
 111                     orderLevelQualification = true;
 112                     break orderQualification;
 113                 }
 114             }
 115             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {
 116                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {
 117                     orderLevelQualification = true;
 118                     break orderQualification;
 119                 }
 120             }
 121         }
 122         //Item Qualification - new for 1.5!
 123         if (orderLevelQualification) {
<abbr title=" 124             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 124             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr>
 125             if (candidates.isMatchedQualifier()) {
<abbr title=" 126                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 126                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr>
<abbr title=" 127                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 127                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr>
 128             }
 129         }
 130     }
 131 
 132     @Override
 133     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {
 134         return couldOfferApplyToOrder(offer, promotableOrder, null, null);
 135     }
 136 
 137     /**
 138      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 139      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 140      *
 141      * @param offer
 142      * @param order
 143      * @param orderItem
 144      * @return true if offer can be applied, otherwise false
 145      */
<abbr title=" 146     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 146     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 147         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);
 148     }
 149 
 150     /**
 151      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 152      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 153      *
 154      * @param offer
 155      * @param order
 156      * @param fulfillmentGroup
 157      * @return true if offer can be applied, otherwise false
 158      */
<abbr title=" 159     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 159     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr>
 160         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);
 161     }
 162 
 163     /**
 164      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 165      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 166      *
 167      * @param offer
 168      * @param order
 169      * @param promotableOrderItem
 170      * @param promotableFulfillmentGroup
 171      * @return true if offer can be applied, otherwise false
 172      */
<abbr title=" 173     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 173     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 174         boolean appliesToItem = false;
 175         String rule = null;
 176         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());
 177         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {
 178             rule = orderRule.getOfferRule().getMatchRule();
 179         }
 180 
 181         if (rule != null) {
 182 
 183             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 184             promotableOrder.updateRuleVariables(vars);
 185             vars.put(&quot;offer&quot;, offer);
 186             if (promotableFulfillmentGroup != null) {
 187                 promotableFulfillmentGroup.updateRuleVariables(vars);
 188             }
 189             if (promotableOrderItem != null) {
 190                 promotableOrderItem.updateRuleVariables(vars);
 191             }
 192             Boolean expressionOutcome = executeExpression(rule, vars);
 193             if (expressionOutcome != null &amp;&amp; expressionOutcome) {
 194                 appliesToItem = true;
 195             }
 196         } else {
 197             appliesToItem = true;
 198         }
 199 
 200         return appliesToItem;
 201     }
 202 
<abbr title=" 203     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 203     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr>
<abbr title=" 204         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 204         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr>
 205         qualifiedOrderOffers.add(promotableCandidateOrderOffer);
 206 
 207         return promotableCandidateOrderOffer;
 208     }
 209 
 210     @Override
<abbr title=" 211     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 211     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr>
<abbr title=" 212         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 212         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr>
 213         int offerCount = 0;
 214         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {
 215             if (offerCount == 0) {
 216                 remainingCandidateOffers.add(candidateOffer);
 217             } else {
 218                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;
 219                         !candidateOffer.getOffer().isTotalitarianOffer()) {
 220                     remainingCandidateOffers.add(candidateOffer);
 221                 }
 222             }
 223             offerCount++;
 224         }
 225         return remainingCandidateOffers;
 226     }
 227 
 228     @Override
<abbr title=" 229     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 229     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr>
<abbr title=" 230         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 230         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr>
 231         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();
 232         while (orderOfferIterator.hasNext()) {
 233             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();
 234             
 235             if (promotableOrder.canApplyOrderOffer(orderOffer)) {
<abbr title=" 236                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 236                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr>
 237                     applyOrderOffer(promotableOrder, orderOffer);
 238 
<abbr title=" 239                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 239                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr>
 240                         if (LOG.isTraceEnabled()) {
<abbr title=" 241                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 241                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr>
 242                         }
 243                         compareAndAdjustOrderAndItemOffers(promotableOrder);
<abbr title=" 244                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 244                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr>
<abbr title=" 245                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 245                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr>
 246                         continue;
 247                     }
 248 
 249                     if (!orderOffer.isCombinable()) {
 250                         if (LOG.isTraceEnabled()) {
<abbr title=" 251                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 251                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr>
 252                         }
 253                         break;
 254                     }
 255                 }
 256             }
 257         }
 258         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());
 259     }
 260 
<abbr title=" 261     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 261     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr>
<abbr title=" 262         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 262         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr>
 263     }
 264 
<abbr title=" 265     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 265     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr>
 266         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());
 267     }
 268 
 269     /**
 270      * Called when the system must determine whether to apply order or item adjustments.
 271      * @param promotableOrder
 272      * @param orderOffersApplied
 273      */
 274     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {
 275         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();
 276         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();
 277 
 278         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {
 279             promotableOrder.removeAllCandidateItemOfferAdjustments();
 280         } else {
 281             promotableOrder.removeAllCandidateOrderOfferAdjustments();
 282         }
 283     }
 284 
 285     /**
 286      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer
 287      * and associates the OrderAdjustment to the Order.
 288      *
 289      * @param orderOffer a CandidateOrderOffer to apply to an Order
 290      */
<abbr title=" 291     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 291     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr>
<abbr title=" 292         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 292         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr>
 293         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);
 294     }
 295 
 296     @Override
 297     public PromotableItemFactory getPromotableItemFactory() {
 298         return promotableItemFactory;
 299     }
 300 
 301     @Override
 302     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 303         this.promotableItemFactory = promotableItemFactory;
 304     }
 305     
<abbr title=" 306     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 306     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr>
<abbr title=" 307         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 307         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr>
 308         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {
 309             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);
 310         }
 311         return adjustmentsMap;
 312     }
 313 
 314     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {
 315         Order order = promotableOrder.getOrder();
 316 
<abbr title=" 317         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 317         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr>
 318             return;
 319         }
 320 
<abbr title=" 321         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 321         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr>
 322         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();
 323 
 324         while (orderAdjIterator.hasNext()) {
 325             OrderAdjustment adjustment = orderAdjIterator.next();
 326             if (adjustment.getOffer() != null) {
 327                 Long offerId = adjustment.getOffer().getId();
 328                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);
 329                 if (promotableAdjustment != null) {
 330                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);
 331                 } else {
 332                     // No longer using this order adjustment, remove it.
 333                     orderAdjIterator.remove();
 334                     entityService.remove(adjustment);
 335                 }
 336             }
 337         }
 338 
 339         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {
 340             // Add the newly introduced adjustments.
 341             Offer offer = promotableOrderAdjustment.getOffer();
 342             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();
 343             orderAdjustment.init(order, offer, offer.getName());
 344             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());
 345             order.getOrderAdjustments().add(orderAdjustment);
 346         }
 347     }
 348 
<abbr title=" 349     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 349     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr>
 350         Long offerId = adjustment.getOffer().getId();
 351         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {
 352             if (LOG.isDebugEnabled()) {
 353                 LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +
 354                         promotableAdjustment.getAdjustmentValue());
 355             }
 356             adjustment.setValue(promotableAdjustment.getAdjustmentValue());
 357         }
 358         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {
 359             if (LOG.isDebugEnabled()) {
<abbr title=" 360                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +"> 360                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to ðŸ”µ</abbr>
 361                         promotableAdjustment.isFutureCredit());
 362             }
 363             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());
 364         }
 365     }
 366 
 367     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {
 368         Order order = promotableOrder.getOrder();
<abbr title=" 369         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 369         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr>
 370 
 371         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);
 372 
 373         for (OrderItem orderItem : orderItemList) {
 374             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);
 375             if (promotableItem == null) {
 376                 continue;
 377             }
 378             synchronizeItemPriceDetails(orderItem, promotableItem);
 379             synchronizeItemQualifiers(orderItem, promotableItem);
 380 
 381         }
 382     }
 383 
<abbr title=" 384     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 384     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr>
<abbr title=" 385         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 385         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr>
 386         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();
 387 
 388         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {
 389             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);
 390             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);
 391             if (promotableDetail != null) {
 392                 processMatchingDetails(orderItemPriceDetail, promotableDetail);
 393             } else {
 394                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);
 395             }
 396         }
 397 
<abbr title=" 398         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 398         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr>
 399 
 400         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {
 401             if (unmatchedDetailsIterator.hasNext()) {
 402                 // Reuse an existing priceDetail
 403                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();
 404 
 405                 // Reset use Sale flag to true
 406                 existingDetail.setUseSalePrice(true);
 407 
 408                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);
 409                 unmatchedDetailsIterator.remove();
 410             } else {
 411                 // Create a new priceDetail
 412                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();
 413                 newPriceDetail.setOrderItem(orderItem);
 414                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);
 415                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);
 416             }
 417         }
 418 
 419         // Remove any unmatched details        
 420         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();
 421         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);
 422     }
 423 
<abbr title=" 424     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 424     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr>
 425         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);
 426         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();
 427 
 428         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {
<abbr title=" 429             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 429             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr>
 430             if (promotableQualifier != null) {
 431                 // Offer was used as a qualifier on previous run.   Update quantity if needed.
 432                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {
 433                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));
 434                 }
 435             } else {
 436                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);
 437             }
 438         }
 439 
<abbr title=" 440         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 440         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr>
 441 
 442         for (PromotionQualifier qualifier : qualifiersMap.values()) {
 443             if (unmatchedQualifiersIterator.hasNext()) {
 444                 // Reuse an existing qualifier
 445                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();
 446                 existingQualifier.setOffer(qualifier.getPromotion());
 447                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 448                 unmatchedQualifiersIterator.remove();
 449             } else {
 450                 // Create a new qualifier
 451                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();
 452                 newQualifier.setOrderItem(orderItem);
 453                 newQualifier.setOffer(qualifier.getPromotion());
 454                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 455                 orderItem.getOrderItemQualifiers().add(newQualifier);
 456             }
 457         }
 458 
 459         // Remove any unmatched qualifiers        
 460         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();
 461         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);
 462     }
 463 
 464     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,
 465             PromotableOrderItemPriceDetail promotableItemDetail) {
 466         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 467                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);
 468 
 469         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {
 470             itemDetail.setQuantity(promotableItemDetail.getQuantity());
 471         }
 472         
<abbr title=" 473         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 473         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr>
<abbr title=" 474             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 474             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr>
 475             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 476                 itemAdjustment.setValue(adjustment.getAdjustmentValue());
 477                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());
 478             }
 479         }
 480     }
 481 
 482     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {
 483         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();
<abbr title=" 484         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 484         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 485             Long offerId = adjustment.getOffer().getId();
 486             offerIds.add(offerId);
 487         }
 488         Collections.sort(offerIds);
 489         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();
 490     }
 491 
<abbr title=" 492     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 492     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr>
<abbr title=" 493         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 493         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr>
 494         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 495             detailsMap.put(detail.buildDetailKey(), detail);
 496         }
 497         return detailsMap;
 498     }
 499 
 500     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {
 501         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();
 502         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 503             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {
<abbr title=" 504                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 504                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr>
 505                 if (existingQualifier != null) {
<abbr title=" 506                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 506                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr>
 507                 } else {
 508                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);
 509                 }
 510             }
 511         }
 512         return qualifiersMap;
 513     }
 514 
 515     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {
 516         Order order = promotableOrder.getOrder();
<abbr title=" 517         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 517         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr>
 518         
 519         boolean syncNeededOnTotal = false;
 520 
 521         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 522             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));
 523             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);
 524             if (syncNeeded) {
 525                 syncFulfillmentPrice(fg);
 526                 syncNeededOnTotal = true;
 527             }
 528         }
 529         
 530         if (syncNeededOnTotal) {
 531             Money syncFulfillmentPrice = Money.ZERO;
 532 
 533             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 534                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());
 535             }
 536             order.setTotalFulfillmentCharges(syncFulfillmentPrice);
 537         }
 538     }
 539 
 540     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {
 541         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);
 542     }
 543 
 544     protected void syncFulfillmentPrice(FulfillmentGroup fg) {
 545         Money retailPrice = fg.getRetailFulfillmentPrice();
 546         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();
 547         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);
 548 
 549         fg.setFulfillmentPrice(fulfillmentPrice);
 550     }
 551 
<abbr title=" 552     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 552     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr>
 553         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();
 554         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 555             fgMap.put(fg.getFulfillmentGroup().getId(), fg);
 556         }
 557         return fgMap;
 558     }
 559 
<abbr title=" 560     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 560     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr>
<abbr title=" 561         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 561         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr>
<abbr title=" 562         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 562         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr>
<abbr title=" 563             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 563             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr>
 564         }
 565         return fgMap;
 566     }
 567 
<abbr title=" 568     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 568     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr>
<abbr title=" 569         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 569         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr>
<abbr title=" 570         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 570         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr>
 571 
 572         // First try and update existing adjustment records
 573         while (adjustmentIterator.hasNext()) {
 574             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();
<abbr title=" 575             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 575             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr>
 576             if (newAdj != null) {
 577                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {
 578                     // Update the currentAdj.
 579                     currentAdj.setValue(newAdj.getAdjustmentValue());
 580                 }
 581             } else {
 582                 // Removing no longer valid adjustment
 583                 adjustmentIterator.remove();
 584                 entityService.remove(currentAdj);
 585             }
 586         }
 587 
 588         // Now add missing adjustments
 589         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {
 590             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();
 591             fa.setFulfillmentGroup(fg);
 592             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);
 593             fa.setValue(newAdj.getAdjustmentValue());
 594             fg.getFulfillmentGroupAdjustments().add(fa);
 595         }
 596 
 597     }
 598 
 599     @Override
 600     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {
 601         synchronizeOrderAdjustments(promotableOrder);
 602         synchronizeOrderItems(promotableOrder);
 603         if (extensionManager != null) {
 604             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);
 605         }
 606         synchronizeFulfillmentGroups(promotableOrder);
 607     }
 608 
 609     @Override
 610     public void setOfferDao(OfferDao offerDao) {
 611         this.offerDao = offerDao;
 612     }
 613 
 614     @Override
 615     public void setOrderItemDao(OrderItemDao orderItemDao) {
 616         this.orderItemDao = orderItemDao;
 617     }
 618 
 619     public OfferServiceUtilities getOfferServiceUtilities() {
 620         return offerServiceUtilities;
 621     }
 622 
 623     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {
 624         this.offerServiceUtilities = offerServiceUtilities;
 625     }
 626 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.money.Money;
  23 import org.broadleafcommerce.common.service.GenericEntityService;
  24 import org.broadleafcommerce.core.offer.dao.OfferDao;
  25 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  26 import org.broadleafcommerce.core.offer.domain.Offer;
  27 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;
  28 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;
  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  30 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  31 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  32 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;
  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  43 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  44 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;
  45 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  46 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  47 import org.broadleafcommerce.core.order.domain.Order;
  48 import org.broadleafcommerce.core.order.domain.OrderItem;
  49 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  50 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  51 import org.springframework.stereotype.Service;
  52 
  53 import java.util.ArrayList;
  54 import java.util.Collections;
  55 import java.util.HashMap;
  56 import java.util.Iterator;
  57 import java.util.List;
  58 import java.util.Map;
  59 
  60 import javax.annotation.Resource;
  61 
  62 /**
  63  * @author jfischer, bpolster
  64  */
  65 @Service(&quot;blOrderOfferProcessor&quot;)
  66 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {
  67 
  68     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);
  69 
  70     @Resource(name = &quot;blPromotableItemFactory&quot;)
  71     protected PromotableItemFactory promotableItemFactory;
  72 
  73     @Resource(name = &quot;blOrderItemDao&quot;)
  74     protected OrderItemDao orderItemDao;
  75 
  76     @Resource(name = &quot;blOfferDao&quot;)
  77     protected OfferDao offerDao;
  78 
  79     @Resource(name = &quot;blOfferServiceUtilities&quot;)
  80     protected OfferServiceUtilities offerServiceUtilities;
  81 
  82     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {
  83         super(promotableOfferUtility);
  84     }
  85 
  86     @Resource(name = &quot;blGenericEntityService&quot;)
  87     protected GenericEntityService entityService;
  88 
  89     @Override
<abbr title="  90     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  90     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr>
  91         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {
<abbr title="  92             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  92             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr>
  93             return;
  94         }
  95         boolean orderLevelQualification = false;
  96         //Order Qualification
  97         orderQualification:
  98         {
  99             if (couldOfferApplyToOrder(offer, promotableOrder)) {
 100                 orderLevelQualification = true;
 101                 break orderQualification;
 102             }
<abbr title=" 103             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 103             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr>
 104                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {
 105                     orderLevelQualification = true;
 106                     break orderQualification;
 107                 }
 108             }
 109             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {
 110                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {
 111                     orderLevelQualification = true;
 112                     break orderQualification;
 113                 }
 114             }
 115         }
 116         //Item Qualification - new for 1.5!
 117         if (orderLevelQualification) {
<abbr title=" 118             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 118             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr>
 119             if (candidates.isMatchedQualifier()) {
<abbr title=" 120                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 120                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr>
<abbr title=" 121                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 121                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr>
 122             }
 123         }
 124     }
 125 
 126     @Override
 127     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {
 128         return couldOfferApplyToOrder(offer, promotableOrder, null, null);
 129     }
 130 
 131     /**
 132      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 133      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 134      *
 135      * @param offer
 136      * @param order
 137      * @param orderItem
 138      * @return true if offer can be applied, otherwise false
 139      */
<abbr title=" 140     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 140     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 141         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);
 142     }
 143 
 144     /**
 145      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 146      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 147      *
 148      * @param offer
 149      * @param order
 150      * @param fulfillmentGroup
 151      * @return true if offer can be applied, otherwise false
 152      */
<abbr title=" 153     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 153     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr>
 154         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);
 155     }
 156 
 157     /**
 158      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 159      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 160      *
 161      * @param offer
 162      * @param order
 163      * @param promotableOrderItem
 164      * @param promotableFulfillmentGroup
 165      * @return true if offer can be applied, otherwise false
 166      */
<abbr title=" 167     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 167     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 168         boolean appliesToItem = false;
 169         String rule = null;
 170         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());
 171         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {
 172             rule = orderRule.getOfferRule().getMatchRule();
 173         }
 174 
 175         if (rule != null) {
 176 
 177             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 178             promotableOrder.updateRuleVariables(vars);
 179             vars.put(&quot;offer&quot;, offer);
 180             if (promotableFulfillmentGroup != null) {
 181                 promotableFulfillmentGroup.updateRuleVariables(vars);
 182             }
 183             if (promotableOrderItem != null) {
 184                 promotableOrderItem.updateRuleVariables(vars);
 185             }
 186             Boolean expressionOutcome = executeExpression(rule, vars);
 187             if (expressionOutcome != null &amp;&amp; expressionOutcome) {
 188                 appliesToItem = true;
 189             }
 190         } else {
 191             appliesToItem = true;
 192         }
 193 
 194         return appliesToItem;
 195     }
 196 
<abbr title=" 197     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 197     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr>
<abbr title=" 198         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 198         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr>
 199         qualifiedOrderOffers.add(promotableCandidateOrderOffer);
 200 
 201         return promotableCandidateOrderOffer;
 202     }
 203 
 204     @Override
<abbr title=" 205     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 205     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr>
<abbr title=" 206         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 206         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr>
 207         int offerCount = 0;
 208         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {
 209             if (offerCount == 0) {
 210                 remainingCandidateOffers.add(candidateOffer);
 211             } else {
 212                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;
 213                         !candidateOffer.getOffer().isTotalitarianOffer()) {
 214                     remainingCandidateOffers.add(candidateOffer);
 215                 }
 216             }
 217             offerCount++;
 218         }
 219         return remainingCandidateOffers;
 220     }
 221 
 222     @Override
<abbr title=" 223     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 223     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr>
<abbr title=" 224         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 224         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr>
 225         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();
 226         while (orderOfferIterator.hasNext()) {
 227             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();
 228 
 229             if (promotableOrder.canApplyOrderOffer(orderOffer)) {
<abbr title=" 230                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 230                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr>
 231                     applyOrderOffer(promotableOrder, orderOffer);
 232 
<abbr title=" 233                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 233                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr>
 234                         if (LOG.isTraceEnabled()) {
<abbr title=" 235                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 235                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr>
 236                         }
 237                         compareAndAdjustOrderAndItemOffers(promotableOrder);
<abbr title=" 238                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 238                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr>
<abbr title=" 239                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 239                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr>
 240                         continue;
 241                     }
 242 
 243                     if (!orderOffer.isCombinable()) {
 244                         if (LOG.isTraceEnabled()) {
<abbr title=" 245                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 245                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr>
 246                         }
 247                         break;
 248                     }
 249                 }
 250             }
 251         }
 252         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());
 253     }
 254 
<abbr title=" 255     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 255     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr>
<abbr title=" 256         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 256         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr>
 257     }
 258 
<abbr title=" 259     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 259     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr>
 260         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());
 261     }
 262 
 263     /**
 264      * Called when the system must determine whether to apply order or item adjustments.
 265      * @param promotableOrder
 266      * @param orderOffersApplied
 267      */
 268     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {
 269         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();
 270         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();
 271 
 272         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {
 273             promotableOrder.removeAllCandidateItemOfferAdjustments();
 274         } else {
 275             promotableOrder.removeAllCandidateOrderOfferAdjustments();
 276         }
 277     }
 278 
 279     /**
 280      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer
 281      * and associates the OrderAdjustment to the Order.
 282      *
 283      * @param orderOffer a CandidateOrderOffer to apply to an Order
 284      */
<abbr title=" 285     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 285     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr>
<abbr title=" 286         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 286         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr>
 287         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);
 288     }
 289 
 290     @Override
 291     public PromotableItemFactory getPromotableItemFactory() {
 292         return promotableItemFactory;
 293     }
 294 
 295     @Override
 296     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 297         this.promotableItemFactory = promotableItemFactory;
 298     }
 299 
<abbr title=" 300     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 300     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr>
<abbr title=" 301         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 301         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr>
 302         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {
 303             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);
 304         }
 305         return adjustmentsMap;
 306     }
 307 
 308     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {
 309         Order order = promotableOrder.getOrder();
 310 
<abbr title=" 311         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 311         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr>
 312             return;
 313         }
 314 
<abbr title=" 315         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 315         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr>
 316         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();
 317 
 318         while (orderAdjIterator.hasNext()) {
 319             OrderAdjustment adjustment = orderAdjIterator.next();
 320             if (adjustment.getOffer() != null) {
 321                 Long offerId = adjustment.getOffer().getId();
 322                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);
 323                 if (promotableAdjustment != null) {
 324                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);
 325                 } else {
 326                     // No longer using this order adjustment, remove it.
 327                     orderAdjIterator.remove();
 328                     entityService.remove(adjustment);
 329                 }
 330             }
 331         }
 332 
 333         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {
 334             // Add the newly introduced adjustments.
 335             Offer offer = promotableOrderAdjustment.getOffer();
 336             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();
 337             orderAdjustment.init(order, offer, offer.getName());
 338             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());
 339             order.getOrderAdjustments().add(orderAdjustment);
 340         }
 341     }
 342 
<abbr title=" 343     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 343     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr>
 344         Long offerId = adjustment.getOffer().getId();
 345         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {
 346             if (LOG.isDebugEnabled()) {
 347                 LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +
 348                         promotableAdjustment.getAdjustmentValue());
 349             }
 350             adjustment.setValue(promotableAdjustment.getAdjustmentValue());
 351         }
 352         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {
 353             if (LOG.isDebugEnabled()) {
<abbr title=" 354                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +"> 354                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to ðŸ”µ</abbr>
 355                         promotableAdjustment.isFutureCredit());
 356             }
 357             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());
 358         }
 359     }
 360 
 361     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {
 362         Order order = promotableOrder.getOrder();
<abbr title=" 363         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 363         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr>
 364 
 365         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);
 366 
 367         for (OrderItem orderItem : orderItemList) {
 368             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);
 369             if (promotableItem == null) {
 370                 continue;
 371             }
 372             synchronizeItemPriceDetails(orderItem, promotableItem);
 373             synchronizeItemQualifiers(orderItem, promotableItem);
 374 
 375         }
 376     }
 377 
<abbr title=" 378     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 378     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr>
<abbr title=" 379         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 379         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr>
 380         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();
 381 
 382         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {
 383             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);
 384             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);
 385             if (promotableDetail != null) {
 386                 processMatchingDetails(orderItemPriceDetail, promotableDetail);
 387             } else {
 388                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);
 389             }
 390         }
 391 
<abbr title=" 392         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 392         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr>
 393 
 394         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {
 395             if (unmatchedDetailsIterator.hasNext()) {
 396                 // Reuse an existing priceDetail
 397                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();
 398 
 399                 // Reset use Sale flag to true
 400                 existingDetail.setUseSalePrice(true);
 401 
 402                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);
 403                 unmatchedDetailsIterator.remove();
 404             } else {
 405                 // Create a new priceDetail
 406                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();
 407                 newPriceDetail.setOrderItem(orderItem);
 408                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);
 409                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);
 410             }
 411         }
 412 
 413         // Remove any unmatched details
 414         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();
 415         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);
 416     }
 417 
<abbr title=" 418     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 418     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr>
 419         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);
 420         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();
 421 
 422         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {
<abbr title=" 423             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 423             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr>
 424             if (promotableQualifier != null) {
 425                 // Offer was used as a qualifier on previous run.   Update quantity if needed.
 426                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {
 427                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));
 428                 }
 429             } else {
 430                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);
 431             }
 432         }
 433 
<abbr title=" 434         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 434         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr>
 435 
 436         for (PromotionQualifier qualifier : qualifiersMap.values()) {
 437             if (unmatchedQualifiersIterator.hasNext()) {
 438                 // Reuse an existing qualifier
 439                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();
 440                 existingQualifier.setOffer(qualifier.getPromotion());
 441                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 442                 unmatchedQualifiersIterator.remove();
 443             } else {
 444                 // Create a new qualifier
 445                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();
 446                 newQualifier.setOrderItem(orderItem);
 447                 newQualifier.setOffer(qualifier.getPromotion());
 448                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 449                 orderItem.getOrderItemQualifiers().add(newQualifier);
 450             }
 451         }
 452 
 453         // Remove any unmatched qualifiers
 454         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();
 455         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);
 456     }
 457 
 458     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,
 459             PromotableOrderItemPriceDetail promotableItemDetail) {
 460         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 461                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);
 462 
 463         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {
 464             itemDetail.setQuantity(promotableItemDetail.getQuantity());
 465         }
 466 
<abbr title=" 467         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 467         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr>
<abbr title=" 468             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 468             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr>
 469             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 470                 itemAdjustment.setValue(adjustment.getAdjustmentValue());
 471                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());
 472             }
 473         }
 474     }
 475 
 476     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {
 477         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();
<abbr title=" 478         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 478         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 479             Long offerId = adjustment.getOffer().getId();
 480             offerIds.add(offerId);
 481         }
 482         Collections.sort(offerIds);
 483         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();
 484     }
 485 
<abbr title=" 486     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 486     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr>
<abbr title=" 487         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 487         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr>
 488         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 489             detailsMap.put(detail.buildDetailKey(), detail);
 490         }
 491         return detailsMap;
 492     }
 493 
 494     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {
 495         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();
 496         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 497             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {
<abbr title=" 498                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 498                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr>
 499                 if (existingQualifier != null) {
<abbr title=" 500                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 500                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr>
 501                 } else {
 502                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);
 503                 }
 504             }
 505         }
 506         return qualifiersMap;
 507     }
 508 
 509     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {
 510         Order order = promotableOrder.getOrder();
<abbr title=" 511         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 511         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr>
 512 
 513         boolean syncNeededOnTotal = false;
 514 
 515         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 516             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));
 517             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);
 518             if (syncNeeded) {
 519                 syncFulfillmentPrice(fg);
 520                 syncNeededOnTotal = true;
 521             }
 522         }
 523 
 524         if (syncNeededOnTotal) {
 525             Money syncFulfillmentPrice = Money.ZERO;
 526 
 527             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 528                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());
 529             }
 530             order.setTotalFulfillmentCharges(syncFulfillmentPrice);
 531         }
 532     }
 533 
 534     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {
 535         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);
 536     }
 537 
 538     protected void syncFulfillmentPrice(FulfillmentGroup fg) {
 539         Money retailPrice = fg.getRetailFulfillmentPrice();
 540         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();
 541         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);
 542 
 543         fg.setFulfillmentPrice(fulfillmentPrice);
 544     }
 545 
<abbr title=" 546     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 546     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr>
 547         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();
 548         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 549             fgMap.put(fg.getFulfillmentGroup().getId(), fg);
 550         }
 551         return fgMap;
 552     }
 553 
<abbr title=" 554     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 554     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr>
<abbr title=" 555         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 555         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr>
<abbr title=" 556         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 556         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr>
<abbr title=" 557             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 557             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr>
 558         }
 559         return fgMap;
 560     }
 561 
<abbr title=" 562     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 562     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr>
<abbr title=" 563         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 563         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr>
<abbr title=" 564         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 564         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr>
 565 
 566         // First try and update existing adjustment records
 567         while (adjustmentIterator.hasNext()) {
 568             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();
<abbr title=" 569             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 569             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr>
 570             if (newAdj != null) {
 571                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {
 572                     // Update the currentAdj.
 573                     currentAdj.setValue(newAdj.getAdjustmentValue());
 574                 }
 575             } else {
 576                 // Removing no longer valid adjustment
 577                 adjustmentIterator.remove();
 578                 entityService.remove(currentAdj);
 579             }
 580         }
 581 
 582         // Now add missing adjustments
 583         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {
 584             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();
 585             fa.setFulfillmentGroup(fg);
 586             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);
 587             fa.setValue(newAdj.getAdjustmentValue());
 588             fg.getFulfillmentGroupAdjustments().add(fa);
 589         }
 590 
 591     }
 592 
 593     @Override
 594     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {
 595         synchronizeOrderAdjustments(promotableOrder);
 596         synchronizeOrderItems(promotableOrder);
 597         if (extensionManager != null) {
 598             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);
 599         }
 600         synchronizeFulfillmentGroups(promotableOrder);
 601     }
 602 
 603     @Override
 604     public void setOfferDao(OfferDao offerDao) {
 605         this.offerDao = offerDao;
 606     }
 607 
 608     @Override
 609     public void setOrderItemDao(OrderItemDao orderItemDao) {
 610         this.orderItemDao = orderItemDao;
 611     }
 612 
 613     public OfferServiceUtilities getOfferServiceUtilities() {
 614         return offerServiceUtilities;
 615     }
 616 
 617     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {
 618         this.offerServiceUtilities = offerServiceUtilities;
 619     }
 620 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Collections;
  22 import java.util.HashMap;
  23 import java.util.Iterator;
  24 import java.util.List;
  25 import java.util.Map;
  26 import javax.annotation.Resource;
  27 import org.apache.commons.logging.Log;
  28 import org.apache.commons.logging.LogFactory;
  29 import org.broadleafcommerce.common.money.Money;
  30 import org.broadleafcommerce.common.service.GenericEntityService;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  33 import org.broadleafcommerce.core.offer.domain.Offer;
  34 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;
  35 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;
  36 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  37 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  38 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  39 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;
  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  50 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  51 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;
  52 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  53 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  54 import org.broadleafcommerce.core.order.domain.Order;
  55 import org.broadleafcommerce.core.order.domain.OrderItem;
  56 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  57 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  58 import org.springframework.stereotype.Service;
  59 
  60 
  61 /**
  62  * @author jfischer, bpolster
  63  */
  64 @Service(&quot;blOrderOfferProcessor&quot;)
  65 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {
  66     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);
  67 
  68     @Resource(name = &quot;blPromotableItemFactory&quot;)
  69     protected PromotableItemFactory promotableItemFactory;
  70 
  71     @Resource(name = &quot;blOrderItemDao&quot;)
  72     protected OrderItemDao orderItemDao;
  73 
  74     @Resource(name = &quot;blOfferDao&quot;)
  75     protected OfferDao offerDao;
  76 
  77     @Resource(name = &quot;blOfferServiceUtilities&quot;)
  78     protected OfferServiceUtilities offerServiceUtilities;
  79 
  80     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {
  81         super(promotableOfferUtility);
  82     }
  83 
  84     @Resource(name = &quot;blGenericEntityService&quot;)
  85     protected GenericEntityService entityService;
  86 
  87     @Override
<abbr title="  88     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  88     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr>
  89         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {
<abbr title="  90             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  90             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr>
  91             return;
  92         }
  93         boolean orderLevelQualification = false;
  94         //Order Qualification
  95         orderQualification:
  96         {
  97             if (couldOfferApplyToOrder(offer, promotableOrder)) {
  98                 orderLevelQualification = true;
  99                 break orderQualification;
 100             }
<abbr title=" 101             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 101             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr>
 102                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {
 103                     orderLevelQualification = true;
 104                     break orderQualification;
 105                 }
 106             }
 107             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {
 108                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {
 109                     orderLevelQualification = true;
 110                     break orderQualification;
 111                 }
 112             }
 113         }
 114         //Item Qualification - new for 1.5!
 115         if (orderLevelQualification) {
<abbr title=" 116             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 116             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr>
 117             if (candidates.isMatchedQualifier()) {
<abbr title=" 118                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 118                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr>
<abbr title=" 119                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 119                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr>
 120             }
 121         }
 122     }
 123 
 124     @Override
 125     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {
 126         return couldOfferApplyToOrder(offer, promotableOrder, null, null);
 127     }
 128 
 129     /**
 130      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 131      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 132      *
 133      * @param offer
 134      * @param order
 135      * @param orderItem
 136      * @return true if offer can be applied, otherwise false
 137      */
<abbr title=" 138     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 138     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 139         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);
 140     }
 141 
 142     /**
 143      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 144      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 145      *
 146      * @param offer
 147      * @param order
 148      * @param fulfillmentGroup
 149      * @return true if offer can be applied, otherwise false
 150      */
<abbr title=" 151     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 151     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr>
 152         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);
 153     }
 154 
 155     /**
 156      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 157      * can be applied to the Order, OrderItem, or FulfillmentGroup.
 158      *
 159      * @param offer
 160      * @param order
 161      * @param promotableOrderItem
 162      * @param promotableFulfillmentGroup
 163      * @return true if offer can be applied, otherwise false
 164      */
<abbr title=" 165     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 165     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr>
 166         boolean appliesToItem = false;
 167         String rule = null;
 168         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());
 169         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {
 170             rule = orderRule.getOfferRule().getMatchRule();
 171         }
 172 
 173         if (rule != null) {
 174 
 175             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 176             promotableOrder.updateRuleVariables(vars);
 177             vars.put(&quot;offer&quot;, offer);
 178             if (promotableFulfillmentGroup != null) {
 179                 promotableFulfillmentGroup.updateRuleVariables(vars);
 180             }
 181             if (promotableOrderItem != null) {
 182                 promotableOrderItem.updateRuleVariables(vars);
 183             }
 184             Boolean expressionOutcome = executeExpression(rule, vars);
 185             if (expressionOutcome != null &amp;&amp; expressionOutcome) {
 186                 appliesToItem = true;
 187             }
 188         } else {
 189             appliesToItem = true;
 190         }
 191 
 192         return appliesToItem;
 193     }
 194 
<abbr title=" 195     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 195     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr>
<abbr title=" 196         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 196         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr>
 197         qualifiedOrderOffers.add(promotableCandidateOrderOffer);
 198 
 199         return promotableCandidateOrderOffer;
 200     }
 201 
 202     @Override
<abbr title=" 203     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 203     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr>
<abbr title=" 204         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 204         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr>
 205         int offerCount = 0;
 206         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {
 207             if (offerCount == 0) {
 208                 remainingCandidateOffers.add(candidateOffer);
 209             } else {
 210                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;
 211                         !candidateOffer.getOffer().isTotalitarianOffer()) {
 212                     remainingCandidateOffers.add(candidateOffer);
 213                 }
 214             }
 215             offerCount++;
 216         }
 217         return remainingCandidateOffers;
 218     }
 219 
 220     @Override
<abbr title=" 221     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 221     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr>
<abbr title=" 222         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 222         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr>
 223         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();
 224         while (orderOfferIterator.hasNext()) {
 225             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();
 226 
 227             if (promotableOrder.canApplyOrderOffer(orderOffer)) {
<abbr title=" 228                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 228                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr>
 229                     applyOrderOffer(promotableOrder, orderOffer);
 230 
<abbr title=" 231                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 231                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr>
 232                         if (LOG.isTraceEnabled()) {
<abbr title=" 233                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 233                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr>
 234                         }
 235                         compareAndAdjustOrderAndItemOffers(promotableOrder);
<abbr title=" 236                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 236                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr>
<abbr title=" 237                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 237                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr>
 238                         continue;
 239                     }
 240 
 241                     if (!orderOffer.isCombinable()) {
 242                         if (LOG.isTraceEnabled()) {
<abbr title=" 243                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 243                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr>
 244                         }
 245                         break;
 246                     }
 247                 }
 248             }
 249         }
 250         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());
 251     }
 252 
<abbr title=" 253     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 253     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr>
<abbr title=" 254         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 254         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr>
 255     }
 256 
<abbr title=" 257     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 257     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr>
 258         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());
 259     }
 260 
 261     /**
 262      * Called when the system must determine whether to apply order or item adjustments.
 263      * @param promotableOrder
 264      * @param orderOffersApplied
 265      */
 266     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {
 267         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();
 268         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();
 269 
 270         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {
 271             promotableOrder.removeAllCandidateItemOfferAdjustments();
 272         } else {
 273             promotableOrder.removeAllCandidateOrderOfferAdjustments();
 274         }
 275     }
 276 
 277     /**
 278      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer
 279      * and associates the OrderAdjustment to the Order.
 280      *
 281      * @param orderOffer a CandidateOrderOffer to apply to an Order
 282      */
<abbr title=" 283     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 283     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr>
<abbr title=" 284         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 284         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr>
 285         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);
 286     }
 287 
 288     @Override
 289     public PromotableItemFactory getPromotableItemFactory() {
 290         return promotableItemFactory;
 291     }
 292 
 293     @Override
 294     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 295         this.promotableItemFactory = promotableItemFactory;
 296     }
 297 
<abbr title=" 298     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 298     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr>
<abbr title=" 299         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 299         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr>
 300         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {
 301             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);
 302         }
 303         return adjustmentsMap;
 304     }
 305 
 306     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {
 307         Order order = promotableOrder.getOrder();
<abbr title=" 308         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 308         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr>
 309             return;
 310         }
<abbr title=" 311         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 311         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr>
 312         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();
 313         while (orderAdjIterator.hasNext()) {
 314             OrderAdjustment adjustment = orderAdjIterator.next();
 315             if (adjustment.getOffer() != null) {
 316                 Long offerId = adjustment.getOffer().getId();
 317                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);
 318                 if (promotableAdjustment != null) {
 319                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);
 320                 } else {
 321                     // No longer using this order adjustment, remove it.
 322                     orderAdjIterator.remove();
 323                     entityService.remove(adjustment);
 324                 }
 325             }
 326         }
 327         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {
 328             // Add the newly introduced adjustments.
 329             Offer offer = promotableOrderAdjustment.getOffer();
 330             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();
 331             orderAdjustment.init(order, offer, offer.getName());
 332             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());
 333             order.getOrderAdjustments().add(orderAdjustment);
 334         }
 335     }
 336 
<abbr title=" 337     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 337     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr>
 338         Long offerId = adjustment.getOffer().getId();
 339         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {
 340             if (LOG.isDebugEnabled()) {
<abbr title=" 341                 LOG.debug(((&quot;Updating value for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + promotableAdjustment.getAdjustmentValue());"> 341                 LOG.debug(((&quot;Updating value for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + pðŸ”µ</abbr>
 342             }
 343             adjustment.setValue(promotableAdjustment.getAdjustmentValue());
 344         }
 345         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {
 346             if (LOG.isDebugEnabled()) {
<abbr title=" 347                 LOG.debug(((&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + promotableAdjustment.isFutureCredit());"> 347                 LOG.debug(((&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId) + &quot; ðŸ”µ</abbr>
 348             }
 349             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());
 350         }
 351     }
 352 
 353     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {
 354         Order order = promotableOrder.getOrder();
<abbr title=" 355         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 355         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr>
 356 
 357         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);
 358 
 359         for (OrderItem orderItem : orderItemList) {
 360             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);
 361             if (promotableItem == null) {
 362                 continue;
 363             }
 364             synchronizeItemPriceDetails(orderItem, promotableItem);
 365             synchronizeItemQualifiers(orderItem, promotableItem);
 366 
 367         }
 368     }
 369 
<abbr title=" 370     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 370     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr>
<abbr title=" 371         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 371         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr>
 372         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();
 373 
 374         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {
 375             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);
 376             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);
 377             if (promotableDetail != null) {
 378                 processMatchingDetails(orderItemPriceDetail, promotableDetail);
 379             } else {
 380                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);
 381             }
 382         }
 383 
<abbr title=" 384         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 384         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr>
 385 
 386         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {
 387             if (unmatchedDetailsIterator.hasNext()) {
 388                 // Reuse an existing priceDetail
 389                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();
 390 
 391                 // Reset use Sale flag to true
 392                 existingDetail.setUseSalePrice(true);
 393 
 394                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);
 395                 unmatchedDetailsIterator.remove();
 396             } else {
 397                 // Create a new priceDetail
 398                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();
 399                 newPriceDetail.setOrderItem(orderItem);
 400                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);
 401                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);
 402             }
 403         }
 404 
 405         // Remove any unmatched details
 406         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();
 407         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);
 408     }
 409 
<abbr title=" 410     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 410     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr>
 411         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);
 412         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();
 413 
 414         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {
<abbr title=" 415             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 415             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr>
 416             if (promotableQualifier != null) {
 417                 // Offer was used as a qualifier on previous run.   Update quantity if needed.
 418                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {
 419                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));
 420                 }
 421             } else {
 422                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);
 423             }
 424         }
 425 
<abbr title=" 426         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 426         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr>
 427 
 428         for (PromotionQualifier qualifier : qualifiersMap.values()) {
 429             if (unmatchedQualifiersIterator.hasNext()) {
 430                 // Reuse an existing qualifier
 431                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();
 432                 existingQualifier.setOffer(qualifier.getPromotion());
 433                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 434                 unmatchedQualifiersIterator.remove();
 435             } else {
 436                 // Create a new qualifier
 437                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();
 438                 newQualifier.setOrderItem(orderItem);
 439                 newQualifier.setOffer(qualifier.getPromotion());
 440                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 441                 orderItem.getOrderItemQualifiers().add(newQualifier);
 442             }
 443         }
 444 
 445         // Remove any unmatched qualifiers
 446         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();
 447         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);
 448     }
 449 
 450     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,
 451             PromotableOrderItemPriceDetail promotableItemDetail) {
 452         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 453                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);
 454 
 455         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {
 456             itemDetail.setQuantity(promotableItemDetail.getQuantity());
 457         }
 458 
<abbr title=" 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr>
<abbr title=" 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr>
 461             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 462                 itemAdjustment.setValue(adjustment.getAdjustmentValue());
 463                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());
 464             }
 465         }
 466     }
 467 
 468     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {
 469         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();
<abbr title=" 470         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 470         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr>
 471             Long offerId = adjustment.getOffer().getId();
 472             offerIds.add(offerId);
 473         }
 474         Collections.sort(offerIds);
 475         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();
 476     }
 477 
<abbr title=" 478     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 478     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr>
<abbr title=" 479         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 479         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr>
 480         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 481             detailsMap.put(detail.buildDetailKey(), detail);
 482         }
 483         return detailsMap;
 484     }
 485 
 486     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {
 487         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();
 488         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 489             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {
<abbr title=" 490                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 490                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr>
 491                 if (existingQualifier != null) {
<abbr title=" 492                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 492                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr>
 493                 } else {
 494                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);
 495                 }
 496             }
 497         }
 498         return qualifiersMap;
 499     }
 500 
 501     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {
 502         Order order = promotableOrder.getOrder();
<abbr title=" 503         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 503         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr>
 504         boolean syncNeededOnTotal = false;
 505         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 506             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));
 507             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);
 508             if (syncNeeded) {
 509                 syncFulfillmentPrice(fg);
 510                 syncNeededOnTotal = true;
 511             }
 512         }
 513         if (syncNeededOnTotal) {
 514             Money syncFulfillmentPrice = Money.ZERO;
 515             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 516                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());
 517             }
 518             order.setTotalFulfillmentCharges(syncFulfillmentPrice);
 519         }
 520     }
 521 
 522     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {
 523         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);
 524     }
 525 
 526     protected void syncFulfillmentPrice(FulfillmentGroup fg) {
 527         Money retailPrice = fg.getRetailFulfillmentPrice();
 528         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();
 529         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);
 530 
 531         fg.setFulfillmentPrice(fulfillmentPrice);
 532     }
 533 
<abbr title=" 534     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 534     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr>
 535         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();
 536         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 537             fgMap.put(fg.getFulfillmentGroup().getId(), fg);
 538         }
 539         return fgMap;
 540     }
 541 
<abbr title=" 542     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 542     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr>
<abbr title=" 543         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 543         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr>
<abbr title=" 544         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 544         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr>
<abbr title=" 545             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 545             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr>
 546         }
 547         return fgMap;
 548     }
 549 
<abbr title=" 550     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 550     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr>
<abbr title=" 551         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 551         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr>
<abbr title=" 552         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 552         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr>
 553         // First try and update existing adjustment records
 554         while (adjustmentIterator.hasNext()) {
 555             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();
<abbr title=" 556             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 556             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr>
 557             if (newAdj != null) {
 558                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {
 559                     // Update the currentAdj.
 560                     currentAdj.setValue(newAdj.getAdjustmentValue());
 561                 }
 562             } else {
 563                 // Removing no longer valid adjustment
 564                 adjustmentIterator.remove();
 565                 entityService.remove(currentAdj);
 566             }
 567         }
 568         // Now add missing adjustments
 569         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {
 570             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();
 571             fa.setFulfillmentGroup(fg);
 572             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);
 573             fa.setValue(newAdj.getAdjustmentValue());
 574             fg.getFulfillmentGroupAdjustments().add(fa);
 575         }
 576     }
 577 
 578     @Override
 579     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {
 580         synchronizeOrderAdjustments(promotableOrder);
 581         synchronizeOrderItems(promotableOrder);
 582         if (extensionManager != null) {
 583             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);
 584         }
 585         synchronizeFulfillmentGroups(promotableOrder);
 586     }
 587 
 588     @Override
 589     public void setOfferDao(OfferDao offerDao) {
 590         this.offerDao = offerDao;
 591     }
 592 
 593     @Override
 594     public void setOrderItemDao(OrderItemDao orderItemDao) {
 595         this.orderItemDao = orderItemDao;
 596     }
 597 
 598     public OfferServiceUtilities getOfferServiceUtilities() {
 599         return offerServiceUtilities;
 600     }
 601 
 602     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {
 603         this.offerServiceUtilities = offerServiceUtilities;
 604     }
 605 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.money.Money;

  23  import org.broadleafcommerce.core.offer.dao.OfferDao;
  24  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  25  import org.broadleafcommerce.core.offer.domain.Offer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;</span>
  27  import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;
  28  import org.broadleafcommerce.core.offer.domain.OrderAdjustment;
  29  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  30  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  31  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  32  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;</span>
  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;
  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;</span>
  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  44  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  45  import org.broadleafcommerce.core.offer.service.type.OfferRuleType;
  46  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  48  import org.broadleafcommerce.core.order.domain.Order;
  49  import org.broadleafcommerce.core.order.domain.OrderItem;
  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  51  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  52  import org.springframework.stereotype.Service;
  53  
  54  import java.util.ArrayList;
  55  import java.util.Collections;
  56  import java.util.HashMap;
  57  import java.util.Iterator;
  58  import java.util.List;
  59  import java.util.Map;
  60  
  61  import javax.annotation.Resource;
  62  
  63  /**
  64   * @author jfischer, bpolster
  65   */
  66  @Service(&quot;blOrderOfferProcessor&quot;)
  67  public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {
  68  
  69      private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);
  70  
  71      @Resource(name = &quot;blPromotableItemFactory&quot;)
  72      protected PromotableItemFactory promotableItemFactory;
  73  
  74      @Resource(name = &quot;blOrderItemDao&quot;)
  75      protected OrderItemDao orderItemDao;
  76  
  77      @Resource(name = &quot;blOfferDao&quot;)
  78      protected OfferDao offerDao;
  79  
  80      @Resource(name = &quot;blOfferServiceUtilities&quot;)
  81      protected OfferServiceUtilities offerServiceUtilities;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        super(promotableOfferUtility);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    }</span>
  86  



  87      @Override
<abbr title="  88      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  88      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiðŸ”µ</abbr>
  89          if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {
<abbr title="  90              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  90              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot;ðŸ”µ</abbr>
  91              return;
  92          }
  93          boolean orderLevelQualification = false;
  94          //Order Qualification
  95          orderQualification:
  96          {
  97              if (couldOfferApplyToOrder(offer, promotableOrder)) {
  98                  orderLevelQualification = true;
  99                  break orderQualification;
 100              }
<abbr title=" 101              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 101              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountTðŸ”µ</abbr>
 102                  if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {
 103                      orderLevelQualification = true;
 104                      break orderQualification;
 105                  }
 106              }
 107              for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {
 108                  if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {
 109                      orderLevelQualification = true;
 110                      break orderQualification;
 111                  }
 112              }
 113          }
 114          //Item Qualification - new for 1.5!
 115          if (orderLevelQualification) {
<abbr title=" 116              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 116              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountablðŸ”µ</abbr>
 117              if (candidates.isMatchedQualifier()) {
<abbr title=" 118                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 118                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifieðŸ”µ</abbr>
 119                  candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());
 120              }
 121          }
 122      }
 123  
 124      @Override
 125      public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {
 126          return couldOfferApplyToOrder(offer, promotableOrder, null, null);
 127      }
 128  
 129      /**
 130       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 131       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 132       *
 133       * @param offer
 134       * @param order
 135       * @param orderItem
 136       * @return true if offer can be applied, otherwise false
 137       */
<abbr title=" 138      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 138      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem ordðŸ”µ</abbr>
 139          return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);
 140      }
 141  
 142      /**
 143       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 144       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 145       *
 146       * @param offer
 147       * @param order
 148       * @param fulfillmentGroup
 149       * @return true if offer can be applied, otherwise false
 150       */
<abbr title=" 151      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 151      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGrðŸ”µ</abbr>
 152          return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);
 153      }
 154  
 155      /**
 156       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 157       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 158       *
 159       * @param offer
 160       * @param order
 161       * @param promotableOrderItem
 162       * @param promotableFulfillmentGroup
 163       * @return true if offer can be applied, otherwise false
 164       */
<abbr title=" 165      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 165      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem proðŸ”µ</abbr>
 166          boolean appliesToItem = false;
 167          String rule = null;
 168          OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());
 169          if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {
 170              rule = orderRule.getOfferRule().getMatchRule();
 171          }
 172  
 173          if (rule != null) {
 174  
 175              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 176              promotableOrder.updateRuleVariables(vars);
 177              vars.put(&quot;offer&quot;, offer);
 178              if (promotableFulfillmentGroup != null) {
 179                  promotableFulfillmentGroup.updateRuleVariables(vars);
 180              }
 181              if (promotableOrderItem != null) {
 182                  promotableOrderItem.updateRuleVariables(vars);
 183              }
 184              Boolean expressionOutcome = executeExpression(rule, vars);
 185              if (expressionOutcome != null &amp;&amp; expressionOutcome) {
 186                  appliesToItem = true;
 187              }
 188          } else {
 189              appliesToItem = true;
 190          }
 191  
 192          return appliesToItem;
 193      }
 194  
<abbr title=" 195      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 195      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotðŸ”µ</abbr>
<abbr title=" 196          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 196          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidðŸ”µ</abbr>
 197          qualifiedOrderOffers.add(promotableCandidateOrderOffer);
 198  
 199          return promotableCandidateOrderOffer;
 200      }
 201  
 202      @Override
<abbr title=" 203      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 203      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrdeðŸ”µ</abbr>
<abbr title=" 204          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 204          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOfferðŸ”µ</abbr>
 205          int offerCount = 0;
 206          for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {
 207              if (offerCount == 0) {
 208                  remainingCandidateOffers.add(candidateOffer);
 209              } else {
 210                  if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;
 211                          !candidateOffer.getOffer().isTotalitarianOffer()) {
 212                      remainingCandidateOffers.add(candidateOffer);
 213                  }
 214              }
 215              offerCount++;
 216          }
 217          return remainingCandidateOffers;
 218      }
 219  
 220      @Override
<abbr title=" 221      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 221      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrdðŸ”µ</abbr>
<abbr title=" 222          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 222          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discountðŸ”µ</abbr>
 223          Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();
 224          while (orderOfferIterator.hasNext()) {
 225              PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();
 226  
 227              if (promotableOrder.canApplyOrderOffer(orderOffer)) {
<abbr title=" 228                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 228                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalReqðŸ”µ</abbr>
 229                      applyOrderOffer(promotableOrder, orderOffer);
 230  
 231                      if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {
 232                          if (LOG.isTraceEnabled()) {
<abbr title=" 233                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 233                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for besðŸ”µ</abbr>
 234                          }
 235                          compareAndAdjustOrderAndItemOffers(promotableOrder);
<abbr title=" 236                          // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 236                          // We continue because this could be the first offer and marked as totalitarian, but not aðŸ”µ</abbr>
<abbr title=" 237                          // item offer. There could be other order offers that are not totalitarian that also qualify."> 237                          // item offer. There could be other order offers that are not totalitarian that also qualiðŸ”µ</abbr>
 238                          continue;
 239                      }
 240  
 241                      if (!orderOffer.isCombinable()) {
 242                          if (LOG.isTraceEnabled()) {
<abbr title=" 243                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 243                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getIdðŸ”µ</abbr>
 244                          }
 245                          break;
 246                      }
 247                  }
 248              }
 249          }
 250          promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());
 251      }
 252  
<abbr title=" 253      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 253      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffeðŸ”µ</abbr>
<abbr title=" 254          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 254          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOðŸ”µ</abbr>
 255      }
 256  
<abbr title=" 257      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 257      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffðŸ”µ</abbr>
 258          return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());
 259      }
 260  
 261      /**
 262       * Called when the system must determine whether to apply order or item adjustments.
 263       * @param promotableOrder
 264       * @param orderOffersApplied
 265       */
 266      protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {
 267          Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();
 268          Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();
 269  
 270          if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {
 271              promotableOrder.removeAllCandidateItemOfferAdjustments();
 272          } else {
 273              promotableOrder.removeAllCandidateOrderOfferAdjustments();
 274          }
 275      }
 276  
 277      /**
 278       * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer
 279       * and associates the OrderAdjustment to the Order.
 280       *
 281       * @param orderOffer a CandidateOrderOffer to apply to an Order
 282       */
 283      protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {
<abbr title=" 284          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 284          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustmenðŸ”µ</abbr>
 285          promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);
 286      }
 287  
 288      @Override
 289      public PromotableItemFactory getPromotableItemFactory() {
 290          return promotableItemFactory;
 291      }
 292  
 293      @Override
 294      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 295          this.promotableItemFactory = promotableItemFactory;
 296      }
 297  
<abbr title=" 298      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 298      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrðŸ”µ</abbr>
 299          Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();
 300          for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {
 301              adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);
 302          }
 303          return adjustmentsMap;
 304      }
 305  
 306      protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {
 307          Order order = promotableOrder.getOrder();
 308  
 309          if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {
 310              return;
 311          }
 312  
<abbr title=" 313          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 313          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrdeðŸ”µ</abbr>
 314          Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();
 315  
 316          while (orderAdjIterator.hasNext()) {
 317              OrderAdjustment adjustment = orderAdjIterator.next();
 318              if (adjustment.getOffer() != null) {
 319                  Long offerId = adjustment.getOffer().getId();
 320                  PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);
 321                  if (promotableAdjustment != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -                    if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -                        if (LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -                            LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -                                    promotableAdjustment.getAdjustmentValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -                        adjustment.setValue(promotableAdjustment.getAdjustmentValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                    updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);</span>
 330                  } else {
 331                      // No longer using this order adjustment, remove it.
 332                      orderAdjIterator.remove();

 333                  }
 334              }
 335          }
 336  
 337          for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {
 338              // Add the newly introduced adjustments.
 339              Offer offer = promotableOrderAdjustment.getOffer();
 340              OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();
 341              orderAdjustment.init(order, offer, offer.getName());
 342              orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());
 343              order.getOrderAdjustments().add(orderAdjustment);
 344          }
 345      }
 346  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 348 +    protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 348 +    protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        Long offerId = adjustment.getOffer().getId();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +            if (LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                        promotableAdjustment.getAdjustmentValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            adjustment.setValue(promotableAdjustment.getAdjustmentValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            if (LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +                LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                        promotableAdjustment.isFutureCredit());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +            adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +    }</span>
 365  
 366      protected void synchronizeOrderItems(PromotableOrder promotableOrder) {
 367          Order order = promotableOrder.getOrder();
<abbr title=" 368          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 368          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promoðŸ”µ</abbr>
 369  
 370          List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);
 371  
 372          for (OrderItem orderItem : orderItemList) {
 373              PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);
 374              if (promotableItem == null) {
 375                  continue;
 376              }
 377              synchronizeItemPriceDetails(orderItem, promotableItem);
 378              synchronizeItemQualifiers(orderItem, promotableItem);
 379  
 380          }
 381      }
 382  
 383      protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {
<abbr title=" 384          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 384          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrdðŸ”µ</abbr>
 385          Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();
 386  
 387          for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {
 388              String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);
 389              PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);
 390              if (promotableDetail != null) {
 391                  processMatchingDetails(orderItemPriceDetail, promotableDetail);
 392              } else {
 393                  unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);
 394              }
 395          }
 396  
 397          Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();
 398  
 399          for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {
 400              if (unmatchedDetailsIterator.hasNext()) {
 401                  // Reuse an existing priceDetail
 402                  OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();
 403  
 404                  // Reset use Sale flag to true
 405                  existingDetail.setUseSalePrice(true);
 406  
 407                  offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);
 408                  unmatchedDetailsIterator.remove();
 409              } else {
 410                  // Create a new priceDetail
 411                  OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();
 412                  newPriceDetail.setOrderItem(orderItem);
 413                  offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);
 414                  orderItem.getOrderItemPriceDetails().add(newPriceDetail);
 415              }
 416          }
 417  
 418          // Remove any unmatched details
 419          Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();
 420          offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);
 421      }
 422  
 423      protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {
 424          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);
 425          Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();
 426  
 427          for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {
 428              PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());
 429              if (promotableQualifier != null) {
 430                  // Offer was used as a qualifier on previous run.   Update quantity if needed.
 431                  if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {
 432                      orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));
 433                  }
 434              } else {
 435                  unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);
 436              }
 437          }
 438  
 439          Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();
 440  
 441          for (PromotionQualifier qualifier : qualifiersMap.values()) {
 442              if (unmatchedQualifiersIterator.hasNext()) {
 443                  // Reuse an existing qualifier
 444                  OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();
 445                  existingQualifier.setOffer(qualifier.getPromotion());
 446                  existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 447                  unmatchedQualifiersIterator.remove();
 448              } else {
 449                  // Create a new qualifier
 450                  OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();
 451                  newQualifier.setOrderItem(orderItem);
 452                  newQualifier.setOffer(qualifier.getPromotion());
 453                  newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 454                  orderItem.getOrderItemQualifiers().add(newQualifier);
 455              }
 456          }
 457  
 458          // Remove any unmatched qualifiers
 459          Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();
 460          offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);
 461      }
 462  
 463      protected void processMatchingDetails(OrderItemPriceDetail itemDetail,
 464              PromotableOrderItemPriceDetail promotableItemDetail) {
 465          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 466                  offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);
 467  
 468          if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {
 469              itemDetail.setQuantity(promotableItemDetail.getQuantity());
 470          }
 471  
<abbr title=" 472          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 472          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustmentðŸ”µ</abbr>
 473              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());
 474              if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 475                  itemAdjustment.setValue(adjustment.getAdjustmentValue());
 476                  itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());
 477              }
 478          }
 479      }
 480  
 481      protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {
 482          List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();
 483          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {
 484              Long offerId = adjustment.getOffer().getId();
 485              offerIds.add(offerId);
 486          }
 487          Collections.sort(offerIds);
 488          return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();
 489      }
 490  
 491      protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {
<abbr title=" 492          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 492          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetaiðŸ”µ</abbr>
 493          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 494              detailsMap.put(detail.buildDetailKey(), detail);
 495          }
 496          return detailsMap;
 497      }
 498  
 499      protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {
 500          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();
 501          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 502              for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {
 503                  PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());
 504                  if (existingQualifier != null) {
 505                      existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());
 506                  } else {
 507                      qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);
 508                  }
 509              }
 510          }
 511          return qualifiersMap;
 512      }
 513  
 514      protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {
 515          Order order = promotableOrder.getOrder();
 516          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);
 517  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        boolean syncNeededOnTotal = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +</span>
 520          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 521              synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 523 +            boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +            if (syncNeeded) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 525 +                syncFulfillmentPrice(fg);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +                syncNeededOnTotal = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 528 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 529 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 530 +        if (syncNeededOnTotal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 531 +            Money syncFulfillmentPrice = Money.ZERO;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 532 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +            for (FulfillmentGroup fg : order.getFulfillmentGroups()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +                syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 536 +            order.setTotalFulfillmentCharges(syncFulfillmentPrice);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 538 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 539 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +    protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +        return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +    protected void syncFulfillmentPrice(FulfillmentGroup fg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +        Money retailPrice = fg.getRetailFulfillmentPrice();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +        Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 547 +        Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 548 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +        fg.setFulfillmentPrice(fulfillmentPrice);</span>
 550      }
 551  
 552      protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {
 553          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();
 554          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 555              fgMap.put(fg.getFulfillmentGroup().getId(), fg);
 556          }
 557          return fgMap;
 558      }
 559  
<abbr title=" 560      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 560      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGrouðŸ”µ</abbr>
<abbr title=" 561          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 561          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustðŸ”µ</abbr>
 562          for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {
 563              fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);
 564          }
 565          return fgMap;
 566      }
 567  
<abbr title=" 568      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 568      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotabðŸ”µ</abbr>
 569          Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();
<abbr title=" 570          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 570          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFGðŸ”µ</abbr>
 571  
 572          // First try and update existing adjustment records
 573          while (adjustmentIterator.hasNext()) {
 574              FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();
 575              PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());
 576              if (newAdj != null) {
 577                  if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {
 578                      // Update the currentAdj.
 579                      currentAdj.setValue(newAdj.getAdjustmentValue());
 580                  }
 581              } else {
 582                  // Removing no longer valid adjustment
 583                  adjustmentIterator.remove();

 584              }
 585          }
 586  
 587          // Now add missing adjustments
 588          for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {
 589              FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();
 590              fa.setFulfillmentGroup(fg);
 591              fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);
 592              fa.setValue(newAdj.getAdjustmentValue());
 593              fg.getFulfillmentGroupAdjustments().add(fa);
 594          }
 595  
 596      }
 597  
 598      @Override
 599      public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {
 600          synchronizeOrderAdjustments(promotableOrder);
 601          synchronizeOrderItems(promotableOrder);
 602          if (extensionManager != null) {
 603              extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);
 604          }
 605          synchronizeFulfillmentGroups(promotableOrder);
 606      }
 607  
 608      @Override
 609      public void setOfferDao(OfferDao offerDao) {
 610          this.offerDao = offerDao;
 611      }
 612  
 613      @Override
 614      public void setOrderItemDao(OrderItemDao orderItemDao) {
 615          this.orderItemDao = orderItemDao;
 616      }
 617  
 618      public OfferServiceUtilities getOfferServiceUtilities() {
 619          return offerServiceUtilities;
 620      }
 621  
 622      public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {
 623          this.offerServiceUtilities = offerServiceUtilities;
 624      }
 625  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.money.Money;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  24  import org.broadleafcommerce.core.offer.dao.OfferDao;
  25  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  26  import org.broadleafcommerce.core.offer.domain.Offer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;</span>
  28  import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;
  29  import org.broadleafcommerce.core.offer.domain.OrderAdjustment;
  30  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;
  31  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  32  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  33  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;</span>
  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;
  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;
  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;

  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;
  44  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  45  import org.broadleafcommerce.core.offer.service.type.OfferRuleType;
  46  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  48  import org.broadleafcommerce.core.order.domain.Order;
  49  import org.broadleafcommerce.core.order.domain.OrderItem;
  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  51  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;
  52  import org.springframework.stereotype.Service;
  53  
  54  import java.util.ArrayList;
  55  import java.util.Collections;
  56  import java.util.HashMap;
  57  import java.util.Iterator;
  58  import java.util.List;
  59  import java.util.Map;
  60  
  61  import javax.annotation.Resource;
  62  
  63  /**
  64   * @author jfischer, bpolster
  65   */
  66  @Service(&quot;blOrderOfferProcessor&quot;)
  67  public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {
  68  
  69      private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);
  70  
  71      @Resource(name = &quot;blPromotableItemFactory&quot;)
  72      protected PromotableItemFactory promotableItemFactory;
  73  
  74      @Resource(name = &quot;blOrderItemDao&quot;)
  75      protected OrderItemDao orderItemDao;
  76  
  77      @Resource(name = &quot;blOfferDao&quot;)
  78      protected OfferDao offerDao;
  79  
  80      @Resource(name = &quot;blOfferServiceUtilities&quot;)
  81      protected OfferServiceUtilities offerServiceUtilities;




  82  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    protected GenericEntityService entityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +</span>
  86      @Override
<abbr title="  87      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  87      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiðŸ”µ</abbr>
  88          if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {
<abbr title="  89              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  89              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot;ðŸ”µ</abbr>
  90              return;
  91          }
  92          boolean orderLevelQualification = false;
  93          //Order Qualification
  94          orderQualification:
  95          {
  96              if (couldOfferApplyToOrder(offer, promotableOrder)) {
  97                  orderLevelQualification = true;
  98                  break orderQualification;
  99              }
<abbr title=" 100              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 100              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountTðŸ”µ</abbr>
 101                  if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {
 102                      orderLevelQualification = true;
 103                      break orderQualification;
 104                  }
 105              }
 106              for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {
 107                  if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {
 108                      orderLevelQualification = true;
 109                      break orderQualification;
 110                  }
 111              }
 112          }
 113          //Item Qualification - new for 1.5!
 114          if (orderLevelQualification) {
<abbr title=" 115              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 115              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountablðŸ”µ</abbr>
 116              if (candidates.isMatchedQualifier()) {
<abbr title=" 117                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 117                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifieðŸ”µ</abbr>
 118                  candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());
 119              }
 120          }
 121      }
 122  
 123      @Override
 124      public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {
 125          return couldOfferApplyToOrder(offer, promotableOrder, null, null);
 126      }
 127  
 128      /**
 129       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 130       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 131       *
 132       * @param offer
 133       * @param order
 134       * @param orderItem
 135       * @return true if offer can be applied, otherwise false
 136       */
<abbr title=" 137      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 137      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem ordðŸ”µ</abbr>
 138          return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);
 139      }
 140  
 141      /**
 142       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 143       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 144       *
 145       * @param offer
 146       * @param order
 147       * @param fulfillmentGroup
 148       * @return true if offer can be applied, otherwise false
 149       */
<abbr title=" 150      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 150      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGrðŸ”µ</abbr>
 151          return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);
 152      }
 153  
 154      /**
 155       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer
 156       * can be applied to the Order, OrderItem, or FulfillmentGroup.
 157       *
 158       * @param offer
 159       * @param order
 160       * @param promotableOrderItem
 161       * @param promotableFulfillmentGroup
 162       * @return true if offer can be applied, otherwise false
 163       */
<abbr title=" 164      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 164      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem proðŸ”µ</abbr>
 165          boolean appliesToItem = false;
 166          String rule = null;
 167          OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());
 168          if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {
 169              rule = orderRule.getOfferRule().getMatchRule();
 170          }
 171  
 172          if (rule != null) {
 173  
 174              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 175              promotableOrder.updateRuleVariables(vars);
 176              vars.put(&quot;offer&quot;, offer);
 177              if (promotableFulfillmentGroup != null) {
 178                  promotableFulfillmentGroup.updateRuleVariables(vars);
 179              }
 180              if (promotableOrderItem != null) {
 181                  promotableOrderItem.updateRuleVariables(vars);
 182              }
 183              Boolean expressionOutcome = executeExpression(rule, vars);
 184              if (expressionOutcome != null &amp;&amp; expressionOutcome) {
 185                  appliesToItem = true;
 186              }
 187          } else {
 188              appliesToItem = true;
 189          }
 190  
 191          return appliesToItem;
 192      }
 193  
<abbr title=" 194      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 194      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotðŸ”µ</abbr>
<abbr title=" 195          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 195          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidðŸ”µ</abbr>
 196          qualifiedOrderOffers.add(promotableCandidateOrderOffer);
 197  
 198          return promotableCandidateOrderOffer;
 199      }
 200  
 201      @Override
<abbr title=" 202      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 202      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrdeðŸ”µ</abbr>
<abbr title=" 203          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 203          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOfferðŸ”µ</abbr>
 204          int offerCount = 0;
 205          for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {
 206              if (offerCount == 0) {
 207                  remainingCandidateOffers.add(candidateOffer);
 208              } else {
 209                  if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;
 210                          !candidateOffer.getOffer().isTotalitarianOffer()) {
 211                      remainingCandidateOffers.add(candidateOffer);
 212                  }
 213              }
 214              offerCount++;
 215          }
 216          return remainingCandidateOffers;
 217      }
 218  
 219      @Override
<abbr title=" 220      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 220      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrdðŸ”µ</abbr>
<abbr title=" 221          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 221          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discountðŸ”µ</abbr>
 222          Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();
 223          while (orderOfferIterator.hasNext()) {
 224              PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();
 225  
 226              if (promotableOrder.canApplyOrderOffer(orderOffer)) {
<abbr title=" 227                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 227                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalReqðŸ”µ</abbr>
 228                      applyOrderOffer(promotableOrder, orderOffer);
 229  
 230                      if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {
 231                          if (LOG.isTraceEnabled()) {
<abbr title=" 232                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 232                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for besðŸ”µ</abbr>
 233                          }
 234                          compareAndAdjustOrderAndItemOffers(promotableOrder);
<abbr title=" 235                          // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 235                          // We continue because this could be the first offer and marked as totalitarian, but not aðŸ”µ</abbr>
<abbr title=" 236                          // item offer. There could be other order offers that are not totalitarian that also qualify."> 236                          // item offer. There could be other order offers that are not totalitarian that also qualiðŸ”µ</abbr>
 237                          continue;
 238                      }
 239  
 240                      if (!orderOffer.isCombinable()) {
 241                          if (LOG.isTraceEnabled()) {
<abbr title=" 242                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 242                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getIdðŸ”µ</abbr>
 243                          }
 244                          break;
 245                      }
 246                  }
 247              }
 248          }
 249          promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());
 250      }
 251  
<abbr title=" 252      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 252      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffeðŸ”µ</abbr>
<abbr title=" 253          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 253          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOðŸ”µ</abbr>
 254      }
 255  
<abbr title=" 256      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 256      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffðŸ”µ</abbr>
 257          return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());
 258      }
 259  
 260      /**
 261       * Called when the system must determine whether to apply order or item adjustments.
 262       * @param promotableOrder
 263       * @param orderOffersApplied
 264       */
 265      protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {
 266          Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();
 267          Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();
 268  
 269          if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {
 270              promotableOrder.removeAllCandidateItemOfferAdjustments();
 271          } else {
 272              promotableOrder.removeAllCandidateOrderOfferAdjustments();
 273          }
 274      }
 275  
 276      /**
 277       * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer
 278       * and associates the OrderAdjustment to the Order.
 279       *
 280       * @param orderOffer a CandidateOrderOffer to apply to an Order
 281       */
 282      protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {
<abbr title=" 283          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 283          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustmenðŸ”µ</abbr>
 284          promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);
 285      }
 286  
 287      @Override
 288      public PromotableItemFactory getPromotableItemFactory() {
 289          return promotableItemFactory;
 290      }
 291  
 292      @Override
 293      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {
 294          this.promotableItemFactory = promotableItemFactory;
 295      }
 296  
<abbr title=" 297      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 297      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrðŸ”µ</abbr>
 298          Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();
 299          for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {
 300              adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);
 301          }
 302          return adjustmentsMap;
 303      }
 304  
 305      protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {
 306          Order order = promotableOrder.getOrder();
 307  
 308          if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {
 309              return;
 310          }
 311  
<abbr title=" 312          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 312          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrdeðŸ”µ</abbr>
 313          Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();
 314  
 315          while (orderAdjIterator.hasNext()) {
 316              OrderAdjustment adjustment = orderAdjIterator.next();
 317              if (adjustment.getOffer() != null) {
 318                  Long offerId = adjustment.getOffer().getId();
 319                  PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);
 320                  if (promotableAdjustment != null) {
 321                      if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {
 322                          if (LOG.isDebugEnabled()) {
 323                              LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +
 324                                      promotableAdjustment.getAdjustmentValue());
 325                          }
 326                          adjustment.setValue(promotableAdjustment.getAdjustmentValue());
 327                      }

 328                  } else {
 329                      // No longer using this order adjustment, remove it.
 330                      orderAdjIterator.remove();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +                    entityService.remove(adjustment);</span>
 332                  }
 333              }
 334          }
 335  
 336          for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {
 337              // Add the newly introduced adjustments.
 338              Offer offer = promotableOrderAdjustment.getOffer();
 339              OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();
 340              orderAdjustment.init(order, offer, offer.getName());
 341              orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());
 342              order.getOrderAdjustments().add(orderAdjustment);
 343          }
 344      }
 345  
 346  

















 347  
 348      protected void synchronizeOrderItems(PromotableOrder promotableOrder) {
 349          Order order = promotableOrder.getOrder();
<abbr title=" 350          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 350          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promoðŸ”µ</abbr>
 351  
 352          List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);
 353  
 354          for (OrderItem orderItem : orderItemList) {
 355              PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);
 356              if (promotableItem == null) {
 357                  continue;
 358              }
 359              synchronizeItemPriceDetails(orderItem, promotableItem);
 360              synchronizeItemQualifiers(orderItem, promotableItem);
 361  
 362          }
 363      }
 364  
 365      protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {
<abbr title=" 366          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 366          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrdðŸ”µ</abbr>
 367          Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();
 368  
 369          for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {
 370              String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);
 371              PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);
 372              if (promotableDetail != null) {
 373                  processMatchingDetails(orderItemPriceDetail, promotableDetail);
 374              } else {
 375                  unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);
 376              }
 377          }
 378  
 379          Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();
 380  
 381          for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {
 382              if (unmatchedDetailsIterator.hasNext()) {
 383                  // Reuse an existing priceDetail
 384                  OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();
 385  
 386                  // Reset use Sale flag to true
 387                  existingDetail.setUseSalePrice(true);
 388  
 389                  offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);
 390                  unmatchedDetailsIterator.remove();
 391              } else {
 392                  // Create a new priceDetail
 393                  OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();
 394                  newPriceDetail.setOrderItem(orderItem);
 395                  offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);
 396                  orderItem.getOrderItemPriceDetails().add(newPriceDetail);
 397              }
 398          }
 399  
 400          // Remove any unmatched details
 401          Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();
 402          offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);
 403      }
 404  
 405      protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {
 406          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);
 407          Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();
 408  
 409          for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {
 410              PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());
 411              if (promotableQualifier != null) {
 412                  // Offer was used as a qualifier on previous run.   Update quantity if needed.
 413                  if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {
 414                      orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));
 415                  }
 416              } else {
 417                  unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);
 418              }
 419          }
 420  
 421          Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();
 422  
 423          for (PromotionQualifier qualifier : qualifiersMap.values()) {
 424              if (unmatchedQualifiersIterator.hasNext()) {
 425                  // Reuse an existing qualifier
 426                  OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();
 427                  existingQualifier.setOffer(qualifier.getPromotion());
 428                  existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 429                  unmatchedQualifiersIterator.remove();
 430              } else {
 431                  // Create a new qualifier
 432                  OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();
 433                  newQualifier.setOrderItem(orderItem);
 434                  newQualifier.setOffer(qualifier.getPromotion());
 435                  newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));
 436                  orderItem.getOrderItemQualifiers().add(newQualifier);
 437              }
 438          }
 439  
 440          // Remove any unmatched qualifiers
 441          Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();
 442          offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);
 443      }
 444  
 445      protected void processMatchingDetails(OrderItemPriceDetail itemDetail,
 446              PromotableOrderItemPriceDetail promotableItemDetail) {
 447          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =
 448                  offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);
 449  
 450          if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {
 451              itemDetail.setQuantity(promotableItemDetail.getQuantity());
 452          }
 453  
<abbr title=" 454          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 454          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustmentðŸ”µ</abbr>
 455              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());
 456              if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {
 457                  itemAdjustment.setValue(adjustment.getAdjustmentValue());
 458                  itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());
 459              }
 460          }
 461      }
 462  
 463      protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {
 464          List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();
 465          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {
 466              Long offerId = adjustment.getOffer().getId();
 467              offerIds.add(offerId);
 468          }
 469          Collections.sort(offerIds);
 470          return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();
 471      }
 472  
 473      protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {
<abbr title=" 474          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 474          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetaiðŸ”µ</abbr>
 475          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 476              detailsMap.put(detail.buildDetailKey(), detail);
 477          }
 478          return detailsMap;
 479      }
 480  
 481      protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {
 482          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();
 483          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {
 484              for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {
 485                  PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());
 486                  if (existingQualifier != null) {
 487                      existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());
 488                  } else {
 489                      qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);
 490                  }
 491              }
 492          }
 493          return qualifiersMap;
 494      }
 495  
 496      protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {
 497          Order order = promotableOrder.getOrder();
 498          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);
 499  


 500          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 501              synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));
 502          }



























 503      }
 504  
 505      protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {
 506          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();
 507          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 508              fgMap.put(fg.getFulfillmentGroup().getId(), fg);
 509          }
 510          return fgMap;
 511      }
 512  
<abbr title=" 513      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 513      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGrouðŸ”µ</abbr>
<abbr title=" 514          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 514          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustðŸ”µ</abbr>
 515          for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {
 516              fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);
 517          }
 518          return fgMap;
 519      }
 520  
<abbr title=" 521      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 521      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotabðŸ”µ</abbr>
 522          Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();
<abbr title=" 523          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 523          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFGðŸ”µ</abbr>
 524  
 525          // First try and update existing adjustment records
 526          while (adjustmentIterator.hasNext()) {
 527              FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();
 528              PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());
 529              if (newAdj != null) {
 530                  if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {
 531                      // Update the currentAdj.
 532                      currentAdj.setValue(newAdj.getAdjustmentValue());
 533                  }
 534              } else {
 535                  // Removing no longer valid adjustment
 536                  adjustmentIterator.remove();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +                entityService.remove(currentAdj);</span>
 538              }
 539          }
 540  
 541          // Now add missing adjustments
 542          for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {
 543              FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();
 544              fa.setFulfillmentGroup(fg);
 545              fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);
 546              fa.setValue(newAdj.getAdjustmentValue());
 547              fg.getFulfillmentGroupAdjustments().add(fa);
 548          }
 549  
 550      }
 551  
 552      @Override
 553      public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {
 554          synchronizeOrderAdjustments(promotableOrder);
 555          synchronizeOrderItems(promotableOrder);
 556          if (extensionManager != null) {
 557              extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);
 558          }
 559          synchronizeFulfillmentGroups(promotableOrder);
 560      }
 561  
 562      @Override
 563      public void setOfferDao(OfferDao offerDao) {
 564          this.offerDao = offerDao;
 565      }
 566  
 567      @Override
 568      public void setOrderItemDao(OrderItemDao orderItemDao) {
 569          this.orderItemDao = orderItemDao;
 570      }
 571  
 572      public OfferServiceUtilities getOfferServiceUtilities() {
 573          return offerServiceUtilities;
 574      }
 575  
 576      public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {
 577          this.offerServiceUtilities = offerServiceUtilities;
 578      }
 579  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            