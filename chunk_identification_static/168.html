<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>168</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    168
                    <a href="167.html">prev</a>
                    <a href="169.html">next</a>
                    <a href="168_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CyanogenMod/android_packages_apps_Trebuchet_42d88768c528d0101b78426ba7bb82043576b15c_WallpaperPicker/src/com/android/gallery3d/common/BitmapUtils.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;42d88768c528d0101b78426ba7bb82043576b15c:WallpaperPicker/src/com/android/gallery3d/common/BitmapUtils.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;42d88768c528d0101b78426ba7bb82043576b15c^1:WallpaperPicker/src/com/android/gallery3d/common/BitmapUtils.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;42d88768c528d0101b78426ba7bb82043576b15c^2:WallpaperPicker/src/com/android/gallery3d/common/BitmapUtils.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;249a510ab318db461ce1ac86baca01021fe41a2c:WallpaperPicker/src/com/android/gallery3d/common/BitmapUtils.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [j], [j]], subset: [[b], [bj], [b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2010 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.gallery3d.common;
  18 
  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.content.Context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.content.res.Resources;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.net.Uri;</span>
  23 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import android.graphics.Bitmap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import android.graphics.Bitmap.CompressFormat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import android.graphics.BitmapFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import android.graphics.Canvas;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import android.graphics.Matrix;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import android.graphics.Paint;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import android.os.Build;</span>
  31 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import android.graphics.Bitmap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import android.graphics.Bitmap.CompressFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import android.graphics.BitmapFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import android.graphics.Canvas;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import android.graphics.Matrix;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import android.graphics.Paint;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import android.os.Build;</span>
  39 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  40 import android.util.Log;
  41 
  42 import com.android.gallery3d.exif.ExifInterface;
  43 
  44 import java.io.BufferedInputStream;
  45 import java.io.IOException;
  46 import java.io.InputStream;
  47 
  48 public class BitmapUtils {
  49 
  50     private static final String TAG = &quot;BitmapUtils&quot;;
  51 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  52 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 public class BitmapUtils {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54     private static final String TAG = &quot;BitmapUtils&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     private static final int DEFAULT_JPEG_QUALITY = 90;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56     public static final int UNCONSTRAINED = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private BitmapUtils(){}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61      * Compute the sample size as a function of minSideLength</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62      * and maxNumOfPixels.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63      * minSideLength is used to specify that minimal width or height of a</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64      * bitmap.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65      * maxNumOfPixels is used to specify the maximal size in pixels that is</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66      * tolerable in terms of memory usage.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68      * The function returns a sample size based on the constraints.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69      * Both size and minSideLength can be passed in as UNCONSTRAINED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70      * which indicates no care of the corresponding constraint.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71      * The functions prefers returning a sample size that</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72      * generates a smaller bitmap, unless minSideLength = UNCONSTRAINED.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74      * Also, the function rounds up the sample size to a power of 2 or multiple</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75      * of 8 because BitmapFactory only honors sample size this way.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76      * For example, BitmapFactory downsamples an image by 2 even though the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77      * request is 3. So we round up the sample size to avoid OOM.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79     public static int computeSampleSize(int width, int height,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         int initialSize = computeInitialSampleSize(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82                 width, height, minSideLength, maxNumOfPixels);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86                 : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92                 &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                 (int) FloatMath.ceil(FloatMath.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98             return lowerBound;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100             int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101             return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     // This computes a sample size which makes the longer side at least</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106     // minSideLength long. If that&#x27;s not possible, return 1.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107     public static int computeSampleSizeLarger(int w, int h,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108             int minSideLength) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         int initialSize = Math.max(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         if (initialSize &lt;= 1) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113                 ? Utils.prevPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 : initialSize / 8 * 8;</span>
 115 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116     private static final int DEFAULT_JPEG_QUALITY = 90;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117     public static final int UNCONSTRAINED = -1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119     private BitmapUtils(){}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121     /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122      * Compute the sample size as a function of minSideLength</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123      * and maxNumOfPixels.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124      * minSideLength is used to specify that minimal width or height of a</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125      * bitmap.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126      * maxNumOfPixels is used to specify the maximal size in pixels that is</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127      * tolerable in terms of memory usage.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129      * The function returns a sample size based on the constraints.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130      * Both size and minSideLength can be passed in as UNCONSTRAINED,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131      * which indicates no care of the corresponding constraint.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132      * The functions prefers returning a sample size that</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133      * generates a smaller bitmap, unless minSideLength = UNCONSTRAINED.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135      * Also, the function rounds up the sample size to a power of 2 or multiple</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136      * of 8 because BitmapFactory only honors sample size this way.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137      * For example, BitmapFactory downsamples an image by 2 even though the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138      * request is 3. So we round up the sample size to avoid OOM.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140     public static int computeSampleSize(int width, int height,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         int initialSize = computeInitialSampleSize(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                 width, height, minSideLength, maxNumOfPixels);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                 : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150     private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152         if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                 &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                 (int) Math.ceil(Math.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             return lowerBound;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162             return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     // This computes a sample size which makes the longer side at least</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167     // minSideLength long. If that&#x27;s not possible, return 1.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168     public static int computeSampleSizeLarger(int w, int h,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169             int minSideLength) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170         int initialSize = Math.max(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171         if (initialSize &lt;= 1) return 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174                 ? Utils.prevPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175                 : initialSize / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176     }</span>
 177 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 178 
 179     // Find the min x that 1 / x &gt;= scale
 180     public static int computeSampleSizeLarger(float scale) {
 181         int initialSize = (int) Math.floor(1f / scale);
 182         if (initialSize &lt;= 1) return 1;
 183 
 184         return initialSize &lt;= 8
 185                 ? Utils.prevPowerOf2(initialSize)
 186                 : initialSize / 8 * 8;
 187     }
 188 
 189 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190     public static int getRotationFromExif(Context context, Uri uri) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191         return BitmapUtils.getRotationFromExifHelper(null, 0, context, uri);</span>
 192 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193      * bitmap.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194      * maxNumOfPixels is used to specify the maximal size in pixels that is</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195      * tolerable in terms of memory usage.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197      * The function returns a sample size based on the constraints.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198      * Both size and minSideLength can be passed in as UNCONSTRAINED,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199      * which indicates no care of the corresponding constraint.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200      * The functions prefers returning a sample size that</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201      * generates a smaller bitmap, unless minSideLength = UNCONSTRAINED.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203      * Also, the function rounds up the sample size to a power of 2 or multiple</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204      * of 8 because BitmapFactory only honors sample size this way.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205      * For example, BitmapFactory downsamples an image by 2 even though the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206      * request is 3. So we round up the sample size to avoid OOM.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208     public static int computeSampleSize(int width, int height,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         int initialSize = computeInitialSampleSize(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 width, height, minSideLength, maxNumOfPixels);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                 : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218     private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                 &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223         int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                 (int) FloatMath.ceil(FloatMath.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226         if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227             return lowerBound;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229             int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230             return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     // This computes a sample size which makes the longer side at least</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235     // minSideLength long. If that&#x27;s not possible, return 1.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236     public static int computeSampleSizeLarger(int w, int h,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             int minSideLength) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238         int initialSize = Math.max(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         if (initialSize &lt;= 1) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                 ? Utils.prevPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                 : initialSize / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246     // Find the min x that 1 / x &gt;= scale</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247     public static int computeSampleSizeLarger(float scale) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         int initialSize = (int) FloatMath.floor(1f / scale);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         if (initialSize &lt;= 1) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                 ? Utils.prevPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                 : initialSize / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256     // Find the max x that 1 / x &lt;= scale.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257     public static int computeSampleSize(float scale) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         Utils.assertTrue(scale &gt; 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         int initialSize = Math.max(1, (int) FloatMath.ceil(1 / scale));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                 ? Utils.nextPowerOf2(initialSize)</span>
 262 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     // Find the max x that 1 / x &lt;= scale.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264     public static int computeSampleSize(float scale) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         Utils.assertTrue(scale &gt; 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266         int initialSize = Math.max(1, (int) Math.ceil(1 / scale));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                 : (initialSize + 7) / 8 * 8;</span>
 270 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 271     }
 272 
 273     public static int getRotationFromExif(Resources res, int resId) {
 274         return BitmapUtils.getRotationFromExifHelper(res, resId, null, null);
 275     }
 276 
 277     private static int getRotationFromExifHelper(Resources res, int resId, Context context, Uri uri) {
 278         ExifInterface ei = new ExifInterface();
 279         InputStream is = null;
 280         BufferedInputStream bis = null;
 281         try {
 282             if (uri != null) {
 283                 is = context.getContentResolver().openInputStream(uri);
 284                 bis = new BufferedInputStream(is);
 285                 ei.readExif(bis);
 286             } else {
 287                 is = res.openRawResource(resId);
 288                 bis = new BufferedInputStream(is);
 289                 ei.readExif(bis);
 290             }
 291             Integer ori = ei.getTagIntValue(ExifInterface.TAG_ORIENTATION);
 292             if (ori != null) {
 293                 return ExifInterface.getRotationForOrientationValue(ori.shortValue());
 294             }
 295         } catch (IOException e) {
 296             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
 297         } catch (NullPointerException e) {
 298             // Sometimes the ExifInterface has an internal NPE if Exif data isn&#x27;t valid
 299             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
 300         } finally {
 301             Utils.closeSilently(bis);
 302             Utils.closeSilently(is);
 303         }
 304         return 0;
 305     }
 306 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2010 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.gallery3d.common;
  18 
  19 import android.content.Context;
  20 import android.content.res.Resources;
  21 import android.net.Uri;
  22 import android.util.Log;
  23 
  24 import com.android.gallery3d.exif.ExifInterface;
  25 
  26 import java.io.BufferedInputStream;
  27 import java.io.IOException;
  28 import java.io.InputStream;
  29 
  30 public class BitmapUtils {
  31 
  32     private static final String TAG = &quot;BitmapUtils&quot;;
  33 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  34 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37         if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38                 &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40         int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41                 (int) FloatMath.ceil(FloatMath.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43         if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44             return lowerBound;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46             int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47             return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49     }</span>
  50 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52             int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53         if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54                 &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56         int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57                 (int) Math.ceil(Math.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59         if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60             return lowerBound;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62             int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63             return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65     }</span>
  66 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  67 
  68 
  69     // Find the min x that 1 / x &gt;= scale
  70     public static int computeSampleSizeLarger(float scale) {
  71         int initialSize = (int) Math.floor(1f / scale);
  72         if (initialSize &lt;= 1) return 1;
  73 
  74         return initialSize &lt;= 8
  75                 ? Utils.prevPowerOf2(initialSize)
  76                 : initialSize / 8 * 8;
  77     }
  78 
  79     public static int getRotationFromExif(Context context, Uri uri) {
  80         return BitmapUtils.getRotationFromExifHelper(null, 0, context, uri);
  81     }
  82 
  83     public static int getRotationFromExif(Resources res, int resId) {
  84         return BitmapUtils.getRotationFromExifHelper(res, resId, null, null);
  85     }
  86 
  87     private static int getRotationFromExifHelper(Resources res, int resId, Context context, Uri uri) {
  88         ExifInterface ei = new ExifInterface();
  89         InputStream is = null;
  90         BufferedInputStream bis = null;
  91         try {
  92             if (uri != null) {
  93                 is = context.getContentResolver().openInputStream(uri);
  94                 bis = new BufferedInputStream(is);
  95                 ei.readExif(bis);
  96             } else {
  97                 is = res.openRawResource(resId);
  98                 bis = new BufferedInputStream(is);
  99                 ei.readExif(bis);
 100             }
 101             Integer ori = ei.getTagIntValue(ExifInterface.TAG_ORIENTATION);
 102             if (ori != null) {
 103                 return ExifInterface.getRotationForOrientationValue(ori.shortValue());
 104             }
 105         } catch (IOException e) {
 106             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
 107         } catch (NullPointerException e) {
 108             // Sometimes the ExifInterface has an internal NPE if Exif data isn&#x27;t valid
 109             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
 110         } finally {
 111             Utils.closeSilently(bis);
 112             Utils.closeSilently(is);
 113         }
 114         return 0;
 115     }
 116 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 117 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 public static int computeSampleSize(float scale) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         Utils.assertTrue(scale &gt; 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         int initialSize = Math.max(1, (int) FloatMath.ceil(1 / scale));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124     }</span>
 125 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126 public static int computeSampleSize(float scale) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         Utils.assertTrue(scale &gt; 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         int initialSize = Math.max(1, (int) Math.ceil(1 / scale));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         return initialSize &lt;= 8</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130                 ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131                 : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132     }</span>
 133 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 134 
 135 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2010 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.android.gallery3d.common;
  17 
  18 import android.content.Context;
  19 import android.content.res.Resources;
  20 import android.net.Uri;
  21 import android.util.Log;
  22 import com.android.gallery3d.exif.ExifInterface;
  23 import java.io.BufferedInputStream;
  24 import java.io.IOException;
  25 import java.io.InputStream;
  26 
  27 
  28 public class BitmapUtils {
  29     private static final String TAG = &quot;BitmapUtils&quot;;
  30 
  31     // Find the min x that 1 / x &gt;= scale
  32     public static int computeSampleSizeLarger(float scale) {
  33         int initialSize = ((int) (Math.floor(1.0F / scale)));
  34         if (initialSize &lt;= 1) {
  35             return 1;
  36         }
  37         return initialSize &lt;= 8 ? Utils.prevPowerOf2(initialSize) : (initialSize / 8) * 8;
  38     }
  39 
  40     public static int getRotationFromExif(Context context, Uri uri) {
  41         return BitmapUtils.getRotationFromExifHelper(null, 0, context, uri);
  42     }
  43 
  44     public static int getRotationFromExif(Resources res, int resId) {
  45         return BitmapUtils.getRotationFromExifHelper(res, resId, null, null);
  46     }
  47 
  48     private static int getRotationFromExifHelper(Resources res, int resId, Context context, Uri uri) {
  49         ExifInterface ei = new ExifInterface();
  50         InputStream is = null;
  51         BufferedInputStream bis = null;
  52         try {
  53             if (uri != null) {
  54                 is = context.getContentResolver().openInputStream(uri);
  55                 bis = new BufferedInputStream(is);
  56                 ei.readExif(bis);
  57             } else {
  58                 is = res.openRawResource(resId);
  59                 bis = new BufferedInputStream(is);
  60                 ei.readExif(bis);
  61             }
  62             Integer ori = ei.getTagIntValue(ExifInterface.TAG_ORIENTATION);
  63             if (ori != null) {
  64                 return ExifInterface.getRotationForOrientationValue(ori.shortValue());
  65             }
  66         } catch (IOException e) {
  67             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
  68         } catch (java.lang.NullPointerException e) {
  69             // Sometimes the ExifInterface has an internal NPE if Exif data isn&#x27;t valid
  70             Log.w(TAG, &quot;Getting exif data failed&quot;, e);
  71         } finally {
  72             Utils.closeSilently(bis);
  73             Utils.closeSilently(is);
  74         }
  75         return 0;
  76     }
  77 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2010 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.gallery3d.common;
  18  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.graphics.Bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import android.graphics.Bitmap.CompressFormat;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import android.graphics.BitmapFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import android.graphics.Canvas;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import android.graphics.Matrix;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import android.graphics.Paint;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import android.os.Build;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.util.FloatMath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import android.content.Context;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import android.content.res.Resources;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import android.net.Uri;</span>
  30  import android.util.Log;
  31  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.android.gallery3d.exif.ExifInterface;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import java.io.BufferedInputStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import java.io.IOException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import java.io.InputStream;</span>
  40  
  41  public class BitmapUtils {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +</span>
  43      private static final String TAG = &quot;BitmapUtils&quot;;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -    private static final int DEFAULT_JPEG_QUALITY = 90;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -    public static final int UNCONSTRAINED = -1;</span>
  46  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -    private BitmapUtils(){}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -    /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -     * Compute the sample size as a function of minSideLength</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -     * and maxNumOfPixels.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -     * minSideLength is used to specify that minimal width or height of a</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -     * bitmap.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -     * maxNumOfPixels is used to specify the maximal size in pixels that is</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -     * tolerable in terms of memory usage.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -     * The function returns a sample size based on the constraints.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -     * Both size and minSideLength can be passed in as UNCONSTRAINED,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -     * which indicates no care of the corresponding constraint.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -     * The functions prefers returning a sample size that</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -     * generates a smaller bitmap, unless minSideLength = UNCONSTRAINED.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -     * Also, the function rounds up the sample size to a power of 2 or multiple</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -     * of 8 because BitmapFactory only honors sample size this way.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -     * For example, BitmapFactory downsamples an image by 2 even though the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -     * request is 3. So we round up the sample size to avoid OOM.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    public static int computeSampleSize(int width, int height,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -            int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -        int initialSize = computeInitialSampleSize(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -                width, height, minSideLength, maxNumOfPixels);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        return initialSize &lt;= 8</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -                ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -                : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    private static int computeInitialSampleSize(int w, int h,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -            int minSideLength, int maxNumOfPixels) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        if (maxNumOfPixels == UNCONSTRAINED</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -                &amp;&amp; minSideLength == UNCONSTRAINED) return 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -                (int) FloatMath.ceil(FloatMath.sqrt((float) (w * h) / maxNumOfPixels));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        if (minSideLength == UNCONSTRAINED) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -            return lowerBound;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -            int sampleSize = Math.min(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -            return Math.max(sampleSize, lowerBound);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    // This computes a sample size which makes the longer side at least</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    // minSideLength long. If that&#x27;s not possible, return 1.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    public static int computeSampleSizeLarger(int w, int h,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -            int minSideLength) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        int initialSize = Math.max(w / minSideLength, h / minSideLength);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    // Find the min x that 1 / x &gt;= scale</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    public static int computeSampleSizeLarger(float scale) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        int initialSize = (int) Math.floor(1f / scale);</span>
 102          if (initialSize &lt;= 1) return 1;
 103  
 104          return initialSize &lt;= 8
 105                  ? Utils.prevPowerOf2(initialSize)
 106                  : initialSize / 8 * 8;
 107      }
 108  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -    // Find the min x that 1 / x &gt;= scale</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -    public static int computeSampleSizeLarger(float scale) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        int initialSize = (int) FloatMath.floor(1f / scale);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        if (initialSize &lt;= 1) return 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        return initialSize &lt;= 8</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -                ? Utils.prevPowerOf2(initialSize)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -                : initialSize / 8 * 8;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    public static int getRotationFromExif(Context context, Uri uri) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        return BitmapUtils.getRotationFromExifHelper(null, 0, context, uri);</span>
 119      }
 120  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    // Find the max x that 1 / x &lt;= scale.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -    public static int computeSampleSize(float scale) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        Utils.assertTrue(scale &gt; 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        int initialSize = Math.max(1, (int) FloatMath.ceil(1 / scale));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        return initialSize &lt;= 8</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -                ? Utils.nextPowerOf2(initialSize)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                : (initialSize + 7) / 8 * 8;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    public static int getRotationFromExif(Resources res, int resId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        return BitmapUtils.getRotationFromExifHelper(res, resId, null, null);</span>
 130      }
 131  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -    public static Bitmap resizeBitmapByScale(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            Bitmap bitmap, float scale, boolean recycle) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        int width = Math.round(bitmap.getWidth() * scale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        int height = Math.round(bitmap.getHeight() * scale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        if (width == bitmap.getWidth()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                &amp;&amp; height == bitmap.getHeight()) return bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        Bitmap target = Bitmap.createBitmap(width, height, getConfig(bitmap));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        Canvas canvas = new Canvas(target);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        canvas.scale(scale, scale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        Paint paint = new Paint(Paint.FILTER_BITMAP_FLAG | Paint.DITHER_FLAG);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        canvas.drawBitmap(bitmap, 0, 0, paint);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        if (recycle) bitmap.recycle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        return target;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    private static Bitmap.Config getConfig(Bitmap bitmap) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        Bitmap.Config config = bitmap.getConfig();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        if (config == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            config = Bitmap.Config.ARGB_8888;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    private static int getRotationFromExifHelper(Resources res, int resId, Context context, Uri uri) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        ExifInterface ei = new ExifInterface();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        InputStream is = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +        BufferedInputStream bis = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            if (uri != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                is = context.getContentResolver().openInputStream(uri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                bis = new BufferedInputStream(is);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                ei.readExif(bis);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                is = res.openRawResource(resId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                bis = new BufferedInputStream(is);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                ei.readExif(bis);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +            Integer ori = ei.getTagIntValue(ExifInterface.TAG_ORIENTATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +            if (ori != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                return ExifInterface.getRotationForOrientationValue(ori.shortValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +        } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +            Log.w(TAG, &quot;Getting exif data failed&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +        } catch (NullPointerException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +            // Sometimes the ExifInterface has an internal NPE if Exif data isn&#x27;t valid</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +            Log.w(TAG, &quot;Getting exif data failed&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +        } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +            Utils.closeSilently(bis);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +            Utils.closeSilently(is);</span>
 177          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -        return config;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    public static Bitmap resizeDownBySideLength(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -            Bitmap bitmap, int maxLength, boolean recycle) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -        int srcWidth = bitmap.getWidth();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -        int srcHeight = bitmap.getHeight();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -        float scale = Math.min(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                (float) maxLength / srcWidth, (float) maxLength / srcHeight);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -        if (scale &gt;= 1.0f) return bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -        return resizeBitmapByScale(bitmap, scale, recycle);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    public static Bitmap resizeAndCropCenter(Bitmap bitmap, int size, boolean recycle) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -        int w = bitmap.getWidth();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        int h = bitmap.getHeight();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        if (w == size &amp;&amp; h == size) return bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        // scale the image so that the shorter side equals to the target;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -        // the longer side will be center-cropped.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -        float scale = (float) size / Math.min(w,  h);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        Bitmap target = Bitmap.createBitmap(size, size, getConfig(bitmap));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -        int width = Math.round(scale * bitmap.getWidth());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        int height = Math.round(scale * bitmap.getHeight());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        Canvas canvas = new Canvas(target);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        canvas.translate((size - width) / 2f, (size - height) / 2f);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        canvas.scale(scale, scale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        Paint paint = new Paint(Paint.FILTER_BITMAP_FLAG | Paint.DITHER_FLAG);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        canvas.drawBitmap(bitmap, 0, 0, paint);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        if (recycle) bitmap.recycle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        return target;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -    public static void recycleSilently(Bitmap bitmap) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        if (bitmap == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            bitmap.recycle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -        } catch (Throwable t) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -            Log.w(TAG, &quot;unable recycle bitmap&quot;, t);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -    public static Bitmap rotateBitmap(Bitmap source, int rotation, boolean recycle) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -        if (rotation == 0) return source;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        int w = source.getWidth();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        int h = source.getHeight();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -        Matrix m = new Matrix();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -        m.postRotate(rotation);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        Bitmap bitmap = Bitmap.createBitmap(source, 0, 0, w, h, m, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        if (recycle) source.recycle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -        return bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -    public static Bitmap createVideoThumbnail(String filePath) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -        // MediaMetadataRetriever is available on API Level 8</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -        // but is hidden until API Level 10</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -        Class&lt;?&gt; clazz = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        Object instance = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -            clazz = Class.forName(&quot;android.media.MediaMetadataRetriever&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -            instance = clazz.newInstance();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -            Method method = clazz.getMethod(&quot;setDataSource&quot;, String.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -            method.invoke(instance, filePath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -            // The method name changes between API Level 9 and 10.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -            if (Build.VERSION.SDK_INT &lt;= 9) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                return (Bitmap) clazz.getMethod(&quot;captureFrame&quot;).invoke(instance);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                byte[] data = (byte[]) clazz.getMethod(&quot;getEmbeddedPicture&quot;).invoke(instance);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -                if (data != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                    Bitmap bitmap = BitmapFactory.decodeByteArray(data, 0, data.length);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                    if (bitmap != null) return bitmap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                return (Bitmap) clazz.getMethod(&quot;getFrameAtTime&quot;).invoke(instance);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -        } catch (IllegalArgumentException ex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -            // Assume this is a corrupt video file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -        } catch (RuntimeException ex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -            // Assume this is a corrupt video file.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -        } catch (InstantiationException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -            Log.e(TAG, &quot;createVideoThumbnail&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -        } catch (InvocationTargetException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -            Log.e(TAG, &quot;createVideoThumbnail&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -        } catch (ClassNotFoundException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -            Log.e(TAG, &quot;createVideoThumbnail&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -        } catch (NoSuchMethodException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -            Log.e(TAG, &quot;createVideoThumbnail&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -        } catch (IllegalAccessException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -            Log.e(TAG, &quot;createVideoThumbnail&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -                if (instance != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                    clazz.getMethod(&quot;release&quot;).invoke(instance);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -            } catch (Exception ignored) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -    public static byte[] compressToBytes(Bitmap bitmap) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        return compressToBytes(bitmap, DEFAULT_JPEG_QUALITY);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -    public static byte[] compressToBytes(Bitmap bitmap, int quality) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        ByteArrayOutputStream baos = new ByteArrayOutputStream(65536);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        bitmap.compress(CompressFormat.JPEG, quality, baos);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        return baos.toByteArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -    public static boolean isSupportedByRegionDecoder(String mimeType) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -        if (mimeType == null) return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -        mimeType = mimeType.toLowerCase();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -        return mimeType.startsWith(&quot;image/&quot;) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -                (!mimeType.equals(&quot;image/gif&quot;) &amp;&amp; !mimeType.endsWith(&quot;bmp&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -    public static boolean isRotationSupported(String mimeType) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -        if (mimeType == null) return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -        mimeType = mimeType.toLowerCase();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -        return mimeType.equals(&quot;image/jpeg&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        return 0;</span>
 302      }
 303  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2010 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.gallery3d.common;
  18  
  19  import android.graphics.Bitmap;
  20  import android.graphics.Bitmap.CompressFormat;
  21  import android.graphics.BitmapFactory;
  22  import android.graphics.Canvas;
  23  import android.graphics.Matrix;
  24  import android.graphics.Paint;
  25  import android.os.Build;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.util.FloatMath;</span>



  27  import android.util.Log;
  28  
  29  import java.io.ByteArrayOutputStream;
  30  import java.lang.reflect.InvocationTargetException;
  31  import java.lang.reflect.Method;





  32  
  33  public class BitmapUtils {

  34      private static final String TAG = &quot;BitmapUtils&quot;;
  35      private static final int DEFAULT_JPEG_QUALITY = 90;
  36      public static final int UNCONSTRAINED = -1;
  37  
  38      private BitmapUtils(){}
  39  
  40      /*
  41       * Compute the sample size as a function of minSideLength
  42       * and maxNumOfPixels.
  43       * minSideLength is used to specify that minimal width or height of a
  44       * bitmap.
  45       * maxNumOfPixels is used to specify the maximal size in pixels that is
  46       * tolerable in terms of memory usage.
  47       *
  48       * The function returns a sample size based on the constraints.
  49       * Both size and minSideLength can be passed in as UNCONSTRAINED,
  50       * which indicates no care of the corresponding constraint.
  51       * The functions prefers returning a sample size that
  52       * generates a smaller bitmap, unless minSideLength = UNCONSTRAINED.
  53       *
  54       * Also, the function rounds up the sample size to a power of 2 or multiple
  55       * of 8 because BitmapFactory only honors sample size this way.
  56       * For example, BitmapFactory downsamples an image by 2 even though the
  57       * request is 3. So we round up the sample size to avoid OOM.
  58       */
  59      public static int computeSampleSize(int width, int height,
  60              int minSideLength, int maxNumOfPixels) {
  61          int initialSize = computeInitialSampleSize(
  62                  width, height, minSideLength, maxNumOfPixels);
  63  
  64          return initialSize &lt;= 8
  65                  ? Utils.nextPowerOf2(initialSize)
  66                  : (initialSize + 7) / 8 * 8;
  67      }
  68  
  69      private static int computeInitialSampleSize(int w, int h,
  70              int minSideLength, int maxNumOfPixels) {
  71          if (maxNumOfPixels == UNCONSTRAINED
  72                  &amp;&amp; minSideLength == UNCONSTRAINED) return 1;
  73  
  74          int lowerBound = (maxNumOfPixels == UNCONSTRAINED) ? 1 :
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -                (int) FloatMath.ceil(FloatMath.sqrt((float) (w * h) / maxNumOfPixels));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +                (int) Math.ceil(Math.sqrt((float) (w * h) / maxNumOfPixels));</span>
  77  
  78          if (minSideLength == UNCONSTRAINED) {
  79              return lowerBound;
  80          } else {
  81              int sampleSize = Math.min(w / minSideLength, h / minSideLength);
  82              return Math.max(sampleSize, lowerBound);
  83          }
  84      }
  85  
  86      // This computes a sample size which makes the longer side at least
  87      // minSideLength long. If that&#x27;s not possible, return 1.
  88      public static int computeSampleSizeLarger(int w, int h,
  89              int minSideLength) {
  90          int initialSize = Math.max(w / minSideLength, h / minSideLength);



  91          if (initialSize &lt;= 1) return 1;
  92  
  93          return initialSize &lt;= 8
  94                  ? Utils.prevPowerOf2(initialSize)
  95                  : initialSize / 8 * 8;
  96      }
  97  
  98      // Find the min x that 1 / x &gt;= scale
  99      public static int computeSampleSizeLarger(float scale) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        int initialSize = (int) FloatMath.floor(1f / scale);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        int initialSize = (int) Math.floor(1f / scale);</span>
 102          if (initialSize &lt;= 1) return 1;
 103  
 104          return initialSize &lt;= 8
 105                  ? Utils.prevPowerOf2(initialSize)
 106                  : initialSize / 8 * 8;


 107      }
 108  
 109      // Find the max x that 1 / x &lt;= scale.
 110      public static int computeSampleSize(float scale) {
 111          Utils.assertTrue(scale &gt; 0);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        int initialSize = Math.max(1, (int) FloatMath.ceil(1 / scale));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        int initialSize = Math.max(1, (int) Math.ceil(1 / scale));</span>
 114          return initialSize &lt;= 8
 115                  ? Utils.nextPowerOf2(initialSize)
 116                  : (initialSize + 7) / 8 * 8;


 117      }
 118  
 119      public static Bitmap resizeBitmapByScale(
 120              Bitmap bitmap, float scale, boolean recycle) {
 121          int width = Math.round(bitmap.getWidth() * scale);
 122          int height = Math.round(bitmap.getHeight() * scale);
 123          if (width == bitmap.getWidth()
 124                  &amp;&amp; height == bitmap.getHeight()) return bitmap;
 125          Bitmap target = Bitmap.createBitmap(width, height, getConfig(bitmap));
 126          Canvas canvas = new Canvas(target);
 127          canvas.scale(scale, scale);
 128          Paint paint = new Paint(Paint.FILTER_BITMAP_FLAG | Paint.DITHER_FLAG);
 129          canvas.drawBitmap(bitmap, 0, 0, paint);
 130          if (recycle) bitmap.recycle();
 131          return target;
 132      }
 133  
 134      private static Bitmap.Config getConfig(Bitmap bitmap) {
 135          Bitmap.Config config = bitmap.getConfig();
 136          if (config == null) {
 137              config = Bitmap.Config.ARGB_8888;


























 138          }
 139          return config;
 140      }
 141  
 142      public static Bitmap resizeDownBySideLength(
 143              Bitmap bitmap, int maxLength, boolean recycle) {
 144          int srcWidth = bitmap.getWidth();
 145          int srcHeight = bitmap.getHeight();
 146          float scale = Math.min(
 147                  (float) maxLength / srcWidth, (float) maxLength / srcHeight);
 148          if (scale &gt;= 1.0f) return bitmap;
 149          return resizeBitmapByScale(bitmap, scale, recycle);
 150      }
 151  
 152      public static Bitmap resizeAndCropCenter(Bitmap bitmap, int size, boolean recycle) {
 153          int w = bitmap.getWidth();
 154          int h = bitmap.getHeight();
 155          if (w == size &amp;&amp; h == size) return bitmap;
 156  
 157          // scale the image so that the shorter side equals to the target;
 158          // the longer side will be center-cropped.
 159          float scale = (float) size / Math.min(w,  h);
 160  
 161          Bitmap target = Bitmap.createBitmap(size, size, getConfig(bitmap));
 162          int width = Math.round(scale * bitmap.getWidth());
 163          int height = Math.round(scale * bitmap.getHeight());
 164          Canvas canvas = new Canvas(target);
 165          canvas.translate((size - width) / 2f, (size - height) / 2f);
 166          canvas.scale(scale, scale);
 167          Paint paint = new Paint(Paint.FILTER_BITMAP_FLAG | Paint.DITHER_FLAG);
 168          canvas.drawBitmap(bitmap, 0, 0, paint);
 169          if (recycle) bitmap.recycle();
 170          return target;
 171      }
 172  
 173      public static void recycleSilently(Bitmap bitmap) {
 174          if (bitmap == null) return;
 175          try {
 176              bitmap.recycle();
 177          } catch (Throwable t) {
 178              Log.w(TAG, &quot;unable recycle bitmap&quot;, t);
 179          }
 180      }
 181  
 182      public static Bitmap rotateBitmap(Bitmap source, int rotation, boolean recycle) {
 183          if (rotation == 0) return source;
 184          int w = source.getWidth();
 185          int h = source.getHeight();
 186          Matrix m = new Matrix();
 187          m.postRotate(rotation);
 188          Bitmap bitmap = Bitmap.createBitmap(source, 0, 0, w, h, m, true);
 189          if (recycle) source.recycle();
 190          return bitmap;
 191      }
 192  
 193      public static Bitmap createVideoThumbnail(String filePath) {
 194          // MediaMetadataRetriever is available on API Level 8
 195          // but is hidden until API Level 10
 196          Class&lt;?&gt; clazz = null;
 197          Object instance = null;
 198          try {
 199              clazz = Class.forName(&quot;android.media.MediaMetadataRetriever&quot;);
 200              instance = clazz.newInstance();
 201  
 202              Method method = clazz.getMethod(&quot;setDataSource&quot;, String.class);
 203              method.invoke(instance, filePath);
 204  
 205              // The method name changes between API Level 9 and 10.
 206              if (Build.VERSION.SDK_INT &lt;= 9) {
 207                  return (Bitmap) clazz.getMethod(&quot;captureFrame&quot;).invoke(instance);
 208              } else {
 209                  byte[] data = (byte[]) clazz.getMethod(&quot;getEmbeddedPicture&quot;).invoke(instance);
 210                  if (data != null) {
 211                      Bitmap bitmap = BitmapFactory.decodeByteArray(data, 0, data.length);
 212                      if (bitmap != null) return bitmap;
 213                  }
 214                  return (Bitmap) clazz.getMethod(&quot;getFrameAtTime&quot;).invoke(instance);
 215              }
 216          } catch (IllegalArgumentException ex) {
 217              // Assume this is a corrupt video file
 218          } catch (RuntimeException ex) {
 219              // Assume this is a corrupt video file.
 220          } catch (InstantiationException e) {
 221              Log.e(TAG, &quot;createVideoThumbnail&quot;, e);
 222          } catch (InvocationTargetException e) {
 223              Log.e(TAG, &quot;createVideoThumbnail&quot;, e);
 224          } catch (ClassNotFoundException e) {
 225              Log.e(TAG, &quot;createVideoThumbnail&quot;, e);
 226          } catch (NoSuchMethodException e) {
 227              Log.e(TAG, &quot;createVideoThumbnail&quot;, e);
 228          } catch (IllegalAccessException e) {
 229              Log.e(TAG, &quot;createVideoThumbnail&quot;, e);
 230          } finally {
 231              try {
 232                  if (instance != null) {
 233                      clazz.getMethod(&quot;release&quot;).invoke(instance);
 234                  }
 235              } catch (Exception ignored) {
 236              }
 237          }
 238          return null;
 239      }
 240  
 241      public static byte[] compressToBytes(Bitmap bitmap) {
 242          return compressToBytes(bitmap, DEFAULT_JPEG_QUALITY);
 243      }
 244  
 245      public static byte[] compressToBytes(Bitmap bitmap, int quality) {
 246          ByteArrayOutputStream baos = new ByteArrayOutputStream(65536);
 247          bitmap.compress(CompressFormat.JPEG, quality, baos);
 248          return baos.toByteArray();
 249      }
 250  
 251      public static boolean isSupportedByRegionDecoder(String mimeType) {
 252          if (mimeType == null) return false;
 253          mimeType = mimeType.toLowerCase();
 254          return mimeType.startsWith(&quot;image/&quot;) &amp;&amp;
 255                  (!mimeType.equals(&quot;image/gif&quot;) &amp;&amp; !mimeType.endsWith(&quot;bmp&quot;));
 256      }
 257  
 258      public static boolean isRotationSupported(String mimeType) {
 259          if (mimeType == null) return false;
 260          mimeType = mimeType.toLowerCase();
 261          return mimeType.equals(&quot;image/jpeg&quot;);

 262      }
 263  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            