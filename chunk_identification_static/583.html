<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>583</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    583
                    <a href="582.html">prev</a>
                    <a href="584.html">next</a>
                    <a href="583_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    GoogleCloudPlatform/bank-of-anthos_dd24cdbe5963bb7e17d733ae9fad547db32617bc_src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;dd24cdbe5963bb7e17d733ae9fad547db32617bc:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;dd24cdbe5963bb7e17d733ae9fad547db32617bc^1:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;dd24cdbe5963bb7e17d733ae9fad547db32617bc^2:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;7888f9d2c30420529eaa3a7d630e52df486a642b:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bsj], [bj], [j]], subset: [[b], [b], [bsj], [bj], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  19 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  20 import java.util.logging.Logger;                                                                         </span>
<span  style="">  21                                                                                                          </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  22 import  org.springframework.web.client.HttpServerErrorException;                                         </span>
<span  style="">  23                                                                                                          </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  24 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  25 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  26 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  27 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  28 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  30 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  31 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  32 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  33 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  34 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  35 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  36 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  37 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  38 import org.springframework.web.client.RestTemplate;                                                      </span>
<span  style="">  39                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  40 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  41 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  42 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span  style="">  43                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  44 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import com.google.common.cache.CacheBuilder;                                                             </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  47 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 public final class LedgerWriterController {                                                              </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  53 =======                                                                                                  </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55         EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  58 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style="">  59                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  60 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  61 public final class LedgerWriterController {                                                              </span>
<span  style="">  62                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  63     private static final Logger LOGGER =                                                                 </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  64             Logger.getLogger(LedgerWriterController.class.getName());                                    </span>
<span  style="">  65                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  66     private TransactionRepository transactionRepository;                                                 </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  67     private TransactionValidator transactionValidator;                                                   </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  68     private JWTVerifier verifier;                                                                        </span>
<span  style="">  69                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  70     private String localRoutingNum;                                                                      </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  71     private String balancesApiUri;                                                                       </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  72     private String version;                                                                              </span>
<span  style="">  73                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  74 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76                                                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  77 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-5180537597001962089" onmouseenter="enter('-5180537597001962089');" onmouseout="out('-5180537597001962089');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78     // account ids should be 10 digits between 0 and 9                                                   </span>
<span class="5114768822238164604" onmouseenter="enter('5114768822238164604');" onmouseout="out('5114768822238164604');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79     private static final Pattern ACCT_REGEX = Pattern.compile(&quot;^[0-9]{10}$&quot;);                            </span>
<span class="-932074474812291239" onmouseenter="enter('-932074474812291239');" onmouseout="out('-932074474812291239');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80     // route numbers should be 9 digits between 0 and 9                                                  </span>
<span class="5641026526418219727" onmouseenter="enter('5641026526418219727');" onmouseout="out('5641026526418219727');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81     private static final Pattern ROUTE_REGEX = Pattern.compile(&quot;^[0-9]{9}$&quot;);                            </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  82 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  83 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  84     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  85     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  86     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style="">  87                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  88     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  89     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  90     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  91     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  92     */                                                                                                   </span>
<span  style="">  93                                                                                                          </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  94     public LedgerWriterController(                                                                       </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  95             JWTVerifier verifier,                                                                        </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="">  96             TransactionRepository transactionRepository,                                                 </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="">  97             TransactionValidator transactionValidator,                                                   </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  98             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  99             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style=""> 100                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style=""> 101             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style=""> 102         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style=""> 103         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style=""> 104         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style=""> 105         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style=""> 106         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style=""> 107         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style=""> 108         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style=""> 109         this.cache = CacheBuilder.newBuilder()                                                           </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style=""> 110                             .expireAfterWrite(1, TimeUnit.HOURS)                                         </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style=""> 111                             .build();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112     }                                                                                                    </span>
<span  style=""> 113                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 114     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style=""> 115      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 116      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 117      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 118      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 119     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 120     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 121         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 124     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 125      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 126      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 127      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 128      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 129     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 130     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 131     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 132         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133     }                                                                                                    </span>
<span  style=""> 134                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 135     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 136      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 137      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 138      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 139      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 140      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 141      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 142      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 143     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 144     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 145     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 146             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 147             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 148         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 149             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 151         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 152             if (bearerToken == null) {                                                                   </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 153                 throw new IllegalArgumentException(                                                      </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 154                         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 156             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 157 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                                                                                                          </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="4729078722672136378" onmouseenter="enter('4729078722672136378');" onmouseout="out('4729078722672136378');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                 throw new IllegalStateException(&quot;duplicate transaction uuid&quot;);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162             }                                                                                            </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                                                                                                          </span>
<span class="3711941965633674030" onmouseenter="enter('3711941965633674030');" onmouseout="out('3711941965633674030');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164             // Validate transaction                                                                      </span>
<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165             validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                                                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 167 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="8710345981270163862" onmouseenter="enter('8710345981270163862');" onmouseout="out('8710345981270163862');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168             // No exceptions thrown. Add to ledger.                                                      </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169             submitTransaction(transaction);                                                              </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170             return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                 </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                          </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="621163550797770344" onmouseenter="enter('621163550797770344');" onmouseout="out('621163550797770344');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             return new ResponseEntity&lt;String&gt;(e.toString(),                                              </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         } catch (ResourceAccessException                                                                 </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 179 =======                                                                                                  </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             // validate transaction                                                                      </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181             transactionValidator.validateTransaction(localRoutingNum,                                    </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182                     jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                              </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183             // Ensure sender balance can cover transaction.                                              </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 184 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 185             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 186                 int balance = getAvailableBalance(                                                       </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 187                         bearerToken, transaction.getFromAccountNum());                                   </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 188                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 189                     throw new IllegalStateException(                                                     </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 190                             EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192             }                                                                                            </span>
<span  style=""> 193                                                                                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 194             // No exceptions thrown. Add to ledger                                                       </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style=""> 195             LOGGER.fine(&quot;Submitting transaction &quot;                                                        </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style=""> 196                     + transaction.toString());                                                           </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 197             transactionRepository.save(transaction);                                                     </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 198             return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                            </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 199                     HttpStatus.CREATED);                                                                 </span>
<span  style=""> 200                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 201         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 202             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 203                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 204         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 205             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 206                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 207         } catch (ResourceAccessException                                                                 </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 208                 | CannotCreateTransactionException                                                       </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 209                 | HttpServerErrorException e) {                                                          </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 210             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 211                                               HttpStatus.INTERNAL_SERVER_ERROR);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213     }                                                                                                    </span>
<span  style=""> 214                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 215     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 216      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 217      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 218      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 219      * @param fromAcct  sender account number                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 220      *                                                                                                   </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 221      * @return available balance of the sender account                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 222      *                                                                                                   </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 223      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 224      */                                                                                                  </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 225     protected int getAvailableBalance(String token, String fromAcct)                                     </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 226             throws HttpServerErrorException {                                                            </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 227         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 228         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 229         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 230         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 231         String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                    </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 232         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                        </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 233             uri, HttpMethod.GET, entity, Integer.class);                                                 </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 234         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 235         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236     }                                                                                                    </span>
<span  style=""> 237                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 238 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239     private void submitTransaction(Transaction transaction) {                                            </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240         LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                 </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241         transactionRepository.save(transaction);                                                         </span>
<span class="7776191786658703771" onmouseenter="enter('7776191786658703771');" onmouseout="out('7776191786658703771');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242         this.cache.put(                                                                                  </span>
<span class="1583036088999436599" onmouseenter="enter('1583036088999436599');" onmouseout="out('1583036088999436599');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243             transaction.getRequestUuid(), transaction.getTransactionId());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244     }                                                                                                    </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 245 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         // Ensure amount is valid value.                                                                 </span>
<span class="5562717371907301652" onmouseenter="enter('5562717371907301652');" onmouseout="out('5562717371907301652');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         if (amount &lt;= 0) {                                                                               </span>
<span class="1959483747532664293" onmouseenter="enter('1959483747532664293');" onmouseout="out('1959483747532664293');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             throw new IllegalArgumentException(&quot;invalid amount&quot;);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252     /**                                                                                                  </span>
<span class="-3067421476871724105" onmouseenter="enter('-3067421476871724105');" onmouseout="out('-3067421476871724105');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253      * Check there is available funds for this transaction.                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255      * @param token  the token used to authenticate request                                              </span>
<span class="558860488720865184" onmouseenter="enter('558860488720865184');" onmouseout="out('558860488720865184');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256      * @param transaction  the transaction object                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257      *                                                                                                   </span>
<span class="-6090067309985679431" onmouseenter="enter('-6090067309985679431');" onmouseout="out('-6090067309985679431');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258      * @throws IllegalStateException     if insufficient funds                                           </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260      */                                                                                                  </span>
<span class="-5773238618088886857" onmouseenter="enter('-5773238618088886857');" onmouseout="out('-5773238618088886857');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261     private void checkAvailableBalance(String token, Transaction transaction)                            </span>
<span class="6517357040700263768" onmouseenter="enter('6517357040700263768');" onmouseout="out('6517357040700263768');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262             throws IllegalStateException, HttpServerErrorException {                                     </span>
<span class="-572407210123738711" onmouseenter="enter('-572407210123738711');" onmouseout="out('-572407210123738711');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         final String fromAcct = transaction.getFromAccountNum();                                         </span>
<span class="8925465647239632188" onmouseenter="enter('8925465647239632188');" onmouseout="out('8925465647239632188');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264         final Integer amount = transaction.getAmount();                                                  </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                                                                                                          </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266         // Ensure sender balance can cover transaction.                                                  </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                    </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                        </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273             uri, HttpMethod.GET, entity, Integer.class);                                                 </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274         Integer senderBalance = response.getBody();                                                      </span>
<span class="4414663458313766444" onmouseenter="enter('4414663458313766444');" onmouseout="out('4414663458313766444');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         if (senderBalance &lt; amount) {                                                                    </span>
<span class="3725575623610824210" onmouseenter="enter('3725575623610824210');" onmouseout="out('3725575623610824210');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276             throw new IllegalStateException(&quot;insufficient balance&quot;);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                                                                                                          </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280     private void submitTransaction(Transaction transaction) {                                            </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281         LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                 </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282         transactionRepository.save(transaction);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 }                                                                                                        </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 285 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 286 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  19 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  20 import java.util.logging.Logger;                                                                         </span>
<span  style="">  21                                                                                                          </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  22 import  org.springframework.web.client.HttpServerErrorException;                                         </span>
<span  style="">  23                                                                                                          </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  24 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  25 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  26 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  27 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  28 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  30 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  31 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  32 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  33 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  34 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  35 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  36 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  37 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  38 import org.springframework.web.client.RestTemplate;                                                      </span>
<span  style="">  39                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  40 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  41 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  42 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span  style="">  43                                                                                                          </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="">  44 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="">  45 import com.google.common.cache.CacheBuilder;                                                             </span>
<span  style="">  46                                                                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  47 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="">  48         EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                          </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="">  49 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                 </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="">  50         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                </span>
<span  style="">  51                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  52 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  53 public final class LedgerWriterController {                                                              </span>
<span  style="">  54                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  55     private static final Logger LOGGER =                                                                 </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  56             Logger.getLogger(LedgerWriterController.class.getName());                                    </span>
<span  style="">  57                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  58         private TransactionRepository transactionRepository;                                             </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  59     private TransactionValidator transactionValidator;                                                   </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  60     private JWTVerifier verifier;                                                                        </span>
<span  style="">  61                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  62     private String localRoutingNum;                                                                      </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  63     private String balancesApiUri;                                                                       </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  64     private String version;                                                                              </span>
<span  style="">  65                                                                                                          </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="">  66     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="">  67                                                                                                          </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  68     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style="">  69 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70 public LedgerWriterController(                                                                           </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71             JWTVerifier verifier,                                                                        </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         this.verifier = verifier;                                                                        </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         this.cache = CacheBuilder.newBuilder()                                                           </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82                             .expireAfterWrite(1, TimeUnit.HOURS)                                         </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83                             .build();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     }                                                                                                    </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">  85 ||||||| BASE                                                                                             </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 public LedgerWriterController(                                                                           </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87             JWTVerifier verifier,                                                                        </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         this.verifier = verifier;                                                                        </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         this.version = version;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96     }                                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  97 =======                                                                                                  </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style="">  98 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span  style="">  99                                                                                                          </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style=""> 100     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style=""> 101     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style=""> 102                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 103     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style=""> 104     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 105     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style=""> 106     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 107     */                                                                                                   </span>
<span  style=""> 108                                                                                                          </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style=""> 109     public LedgerWriterController(                                                                       </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style=""> 110             JWTVerifier verifier,                                                                        </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style=""> 111             TransactionRepository transactionRepository,                                                 </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style=""> 112             TransactionValidator transactionValidator,                                                   </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style=""> 113             @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                       </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style=""> 114             @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                               </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style=""> 115                     String balancesApiUri,                                                               </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style=""> 116             @Value(&quot;${VERSION}&quot;) String version) {                                                       </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style=""> 117         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style=""> 118         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style=""> 119         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style=""> 120         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style=""> 121         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style=""> 122         this.version = version;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123     }                                                                                                    </span>
<span  style=""> 124                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 125     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style=""> 126      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 127      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 128      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 129      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 130     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 131     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 132         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133     }                                                                                                    </span>
<span  style=""> 134                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 135     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 136      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 137      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 138      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 139      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 140     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 141     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 142     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 143         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144     }                                                                                                    </span>
<span  style=""> 145                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 146     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 147      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 148      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 149      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 150      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 151      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 152      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 153      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 154     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 155     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 156     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 157             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 158             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 159         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 160             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 162         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 163             if (bearerToken == null) {                                                                   </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 164                 throw new IllegalArgumentException(                                                      </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 165                         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 167             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 168 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                                                                                                          </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="4729078722672136378" onmouseenter="enter('4729078722672136378');" onmouseout="out('4729078722672136378');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172                 throw new IllegalStateException(&quot;duplicate transaction uuid&quot;);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173             }                                                                                            </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174                                                                                                          </span>
<span class="3711941965633674030" onmouseenter="enter('3711941965633674030');" onmouseout="out('3711941965633674030');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175             // Validate transaction                                                                      </span>
<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176             validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                                                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 178 ||||||| BASE                                                                                             </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             // validate transaction                                                                      </span>
<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                                                                                                          </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="-3863348159007948159" onmouseenter="enter('-3863348159007948159');" onmouseout="out('-3863348159007948159');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                 checkAvailableBalance(bearerToken, transaction);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             }                                                                                            </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                                                                                                          </span>
<span class="8710345981270163862" onmouseenter="enter('8710345981270163862');" onmouseout="out('8710345981270163862');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186             // No exceptions thrown. Add to ledger.                                                      </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187             submitTransaction(transaction);                                                              </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 188 =======                                                                                                  </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189             // validate transaction                                                                      </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190             transactionValidator.validateTransaction(localRoutingNum,                                    </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191                     jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                              </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192             // Ensure sender balance can cover transaction.                                              </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 193 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 194             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 195                 int balance = getAvailableBalance(                                                       </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 196                         bearerToken, transaction.getFromAccountNum());                                   </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 197                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 198                     throw new IllegalStateException(                                                     </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 199                             EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201             }                                                                                            </span>
<span  style=""> 202                                                                                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 203             // No exceptions thrown. Add to ledger                                                       </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style=""> 204             LOGGER.fine(&quot;Submitting transaction &quot;                                                        </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style=""> 205                     + transaction.toString());                                                           </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 206             transactionRepository.save(transaction);                                                     </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 207             return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                            </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 208                     HttpStatus.CREATED);                                                                 </span>
<span  style=""> 209                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 210         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style=""> 211             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                         </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 212                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 213         } catch (IllegalArgumentException | IllegalStateException e) {                                   </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 214             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 215                                               HttpStatus.BAD_REQUEST);                                   </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 216         } catch (ResourceAccessException                                                                 </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 217                 | CannotCreateTransactionException                                                       </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 218                 | HttpServerErrorException e) {                                                          </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style=""> 219             return new ResponseEntity&lt;String&gt;(e.getMessage(),                                            </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 220                                               HttpStatus.INTERNAL_SERVER_ERROR);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222     }                                                                                                    </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 223 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224 private void submitTransaction(Transaction transaction) {                                                </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225         LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                 </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         transactionRepository.save(transaction);                                                         </span>
<span class="7776191786658703771" onmouseenter="enter('7776191786658703771');" onmouseout="out('7776191786658703771');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227         this.cache.put(                                                                                  </span>
<span class="1583036088999436599" onmouseenter="enter('1583036088999436599');" onmouseout="out('1583036088999436599');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228             transaction.getRequestUuid(), transaction.getTransactionId());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229     }                                                                                                    </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 230 ||||||| BASE                                                                                             </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 private void submitTransaction(Transaction transaction) {                                                </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232         LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                 </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233         transactionRepository.save(transaction);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     }                                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 235 =======                                                                                                  </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 236 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span  style=""> 237                                                                                                          </span>
<span  style=""> 238                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 239     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 240      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 241      *                                                                                                   </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 242      * @param token  the token used to authenticate request                                              </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style=""> 243      * @param fromAcct  sender account number                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 244      *                                                                                                   </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style=""> 245      * @return available balance of the sender account                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 246      *                                                                                                   </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 247      * @throws HttpServerErrorException  if balance service returns 500                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 248      */                                                                                                  </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style=""> 249     protected int getAvailableBalance(String token, String fromAcct)                                     </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style=""> 250             throws HttpServerErrorException {                                                            </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 251         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 252         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 253         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 254         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 255         String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                    </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 256         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                        </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 257             uri, HttpMethod.GET, entity, Integer.class);                                                 </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 258         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 259         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260     }                                                                                                    </span>
<span  style=""> 261                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262 }                                                                                                        </span>























</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  16 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  17                                                                                                          </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  18 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  19 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  20 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="">  21 import com.google.common.cache.Cache;                                                                    </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="">  22 import com.google.common.cache.CacheBuilder;                                                             </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="">  23 import java.util.concurrent.TimeUnit;                                                                    </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  24 import java.util.logging.Logger;                                                                         </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  25 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  26 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  27 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  28 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  29 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  30 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  31 import org.springframework.transaction.CannotCreateTransactionException;                                 </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  32 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  33 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  34 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  35 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  36 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  37 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="6025390803839303694" onmouseenter="enter('6025390803839303694');" onmouseout="out('6025390803839303694');" style="">  38 import org.springframework.web.client.HttpServerErrorException;                                          </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  39 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  40 import org.springframework.web.client.RestTemplate;                                                      </span>
<span class="8038844644609144748" onmouseenter="enter('8038844644609144748');" onmouseout="out('8038844644609144748');" style=""><abbr title="  41 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;">  41 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_INSUFFICIENT_BA</abbr></span>
<span class="6364632962761087598" onmouseenter="enter('6364632962761087598');" onmouseout="out('6364632962761087598');" style=""><abbr title="  42 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;">  42 import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.EXCEPTION_MESSAGE_WHEN_AUTHORIZAT</abbr></span>
<span  style="">  43                                                                                                          </span>
<span  style="">  44                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  45 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  46 public final class LedgerWriterController {                                                              </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  47     private static final Logger LOGGER =                                                                 </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  48             Logger.getLogger(LedgerWriterController.class.getName());                                    </span>
<span  style="">  49                                                                                                          </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  50     private TransactionRepository transactionRepository;                                                 </span>
<span  style="">  51                                                                                                          </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="">  52     private TransactionValidator transactionValidator;                                                   </span>
<span  style="">  53                                                                                                          </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  54     private JWTVerifier verifier;                                                                        </span>
<span  style="">  55                                                                                                          </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  56     private String localRoutingNum;                                                                      </span>
<span  style="">  57                                                                                                          </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  58     private String balancesApiUri;                                                                       </span>
<span  style="">  59                                                                                                          </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  60     private String version;                                                                              </span>
<span  style="">  61                                                                                                          </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="">  62     private Cache&lt;String, Long&gt; cache;                                                                   </span>
<span  style="">  63                                                                                                          </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  64     public static final String READINESS_CODE = &quot;ok&quot;;                                                    </span>
<span  style="">  65                                                                                                          </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="">  66     public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                     </span>
<span  style="">  67                                                                                                          </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="">  68     public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                 </span>
<span  style="">  69                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  70     /**                                                                                                  </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  71     * Constructor.                                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  72     *                                                                                                    </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  73     * Initializes JWT verifier.                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74     */                                                                                                   </span>
<span class="-8402264985000865690" onmouseenter="enter('-8402264985000865690');" onmouseout="out('-8402264985000865690');" style=""><abbr title="  75     public LedgerWriterController(JWTVerifier verifier, TransactionRepository transactionRepository, TransactionValidator transactionValidator, @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)">  75     public LedgerWriterController(JWTVerifier verifier, TransactionRepository transactionRepository, Tran</abbr></span>
<span class="-2409824870740125493" onmouseenter="enter('-2409824870740125493');" onmouseout="out('-2409824870740125493');" style="">  76     String localRoutingNum, @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                               </span>
<span class="6405472557125496080" onmouseenter="enter('6405472557125496080');" onmouseout="out('6405472557125496080');" style="">  77     String balancesApiUri, @Value(&quot;${VERSION}&quot;)                                                          </span>
<span class="-6479799029361189940" onmouseenter="enter('-6479799029361189940');" onmouseout="out('-6479799029361189940');" style="">  78     String version) {                                                                                    </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  79         this.verifier = verifier;                                                                        </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="">  80         this.transactionRepository = transactionRepository;                                              </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="">  81         this.transactionValidator = transactionValidator;                                                </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  82         this.localRoutingNum = localRoutingNum;                                                          </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  83         this.balancesApiUri = balancesApiUri;                                                            </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  84         this.version = version;                                                                          </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="">  85         // Initialize cache to ignore duplicate transactions                                             </span>
<span class="-8013717381260139809" onmouseenter="enter('-8013717381260139809');" onmouseout="out('-8013717381260139809');" style="">  86         this.cache = CacheBuilder.newBuilder().expireAfterWrite(1, TimeUnit.HOURS).build();              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87     }                                                                                                    </span>
<span  style="">  88                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  89     /**                                                                                                  </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style="">  90      * Version endpoint.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  91      *                                                                                                   </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style="">  92      * @return  service version string                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  93      */                                                                                                  </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style="">  94     @GetMapping(&quot;/version&quot;)                                                                              </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style="">  95     public ResponseEntity version() {                                                                    </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style="">  96         return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  97     }                                                                                                    </span>
<span  style="">  98                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  99     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 100      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 101      *                                                                                                   </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 102      * @return HTTP Status 200 if server is ready to receive requests.                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 103      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 104     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 105     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 106     public ResponseEntity&lt;String&gt; readiness() {                                                          </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 107         return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108     }                                                                                                    </span>
<span  style=""> 109                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 110     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 111      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 112      *                                                                                                   </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 113      * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                           </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 114      * @param transaction  transaction to submit                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 115      *                                                                                                   </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 116      * @return  HTTP Status 200 if transaction was successfully submitted                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 117      */                                                                                                  </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 118     @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                 </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 119     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="5470864294584925323" onmouseenter="enter('5470864294584925323');" onmouseout="out('5470864294584925323');" style=""> 120     public ResponseEntity&lt;?&gt; addTransaction(@RequestHeader(&quot;Authorization&quot;)                              </span>
<span class="-5836505278597876000" onmouseenter="enter('-5836505278597876000');" onmouseout="out('-5836505278597876000');" style=""> 121     String bearerToken, @RequestBody                                                                     </span>
<span class="395989369435282996" onmouseenter="enter('395989369435282996');" onmouseout="out('395989369435282996');" style=""> 122     Transaction transaction) {                                                                           </span>
<span class="-6149106221954289698" onmouseenter="enter('-6149106221954289698');" onmouseout="out('-6149106221954289698');" style=""> 123         if ((bearerToken != null) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 124             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 125         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 126         try {                                                                                            </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style=""> 127             if (bearerToken == null) {                                                                   </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style=""> 128                 throw new IllegalArgumentException(                                                      </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style=""> 129                         EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130             }                                                                                            </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 131             final DecodedJWT jwt = this.verifier.verify(bearerToken);                                    </span>
<span  style=""> 132                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 133 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                                                                                                          </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135             // Check against cache for duplicate transactions                                            </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                          </span>
<span class="4729078722672136378" onmouseenter="enter('4729078722672136378');" onmouseout="out('4729078722672136378');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                 throw new IllegalStateException(&quot;duplicate transaction uuid&quot;);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             }                                                                                            </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                                                                                                          </span>
<span class="3711941965633674030" onmouseenter="enter('3711941965633674030');" onmouseout="out('3711941965633674030');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             // Validate transaction                                                                      </span>
<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141             validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                           </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                                                                                                          </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                                                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 144 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 145 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 146 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                                                                                                          </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148             // validate transaction                                                                      </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             transactionValidator.validateTransaction(localRoutingNum,                                    </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                     jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                              </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151             // Ensure sender balance can cover transaction.                                              </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                                                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 153 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 154             if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                               </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style=""> 155                 int balance = getAvailableBalance(                                                       </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style=""> 156                         bearerToken, transaction.getFromAccountNum());                                   </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style=""> 157                 if (balance &lt; transaction.getAmount()) {                                                 </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style=""> 158                     throw new IllegalStateException(                                                     </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style=""> 159                             EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161             }                                                                                            </span>
<span  style=""> 162                                                                                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style=""> 163             // No exceptions thrown. Add to ledger                                                       </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style=""> 164             LOGGER.fine(&quot;Submitting transaction &quot;                                                        </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style=""> 165                     + transaction.toString());                                                           </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 166             transactionRepository.save(transaction);                                                     </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style=""> 167             return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                            </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style=""> 168                     HttpStatus.CREATED);                                                                 </span>
<span  style=""> 169                                                                                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 170         } catch (JWTVerificationException e) {                                                           </span>
<span class="-1619102264012411381" onmouseenter="enter('-1619102264012411381');" onmouseout="out('-1619102264012411381');" style=""> 171             return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE, HttpStatus.UNAUTHORIZED);               </span>
<span class="7469340751764207194" onmouseenter="enter('7469340751764207194');" onmouseout="out('7469340751764207194');" style=""> 172         } catch (java.lang.IllegalArgumentException | java.lang.IllegalStateException e) {               </span>
<span class="-2722904246444290120" onmouseenter="enter('-2722904246444290120');" onmouseout="out('-2722904246444290120');" style=""> 173             return new ResponseEntity&lt;String&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);                   </span>
<span class="786637002087973023" onmouseenter="enter('786637002087973023');" onmouseout="out('786637002087973023');" style=""><abbr title=" 174         } catch (ResourceAccessException | CannotCreateTransactionException | HttpServerErrorException e) {"> 174         } catch (ResourceAccessException | CannotCreateTransactionException | HttpServerErrorException e)</abbr></span>
<span class="-6944296864182889898" onmouseenter="enter('-6944296864182889898');" onmouseout="out('-6944296864182889898');" style=""> 175             return new ResponseEntity&lt;String&gt;(e.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177     }                                                                                                    </span>
<span  style=""> 178                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 179     /**                                                                                                  </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style=""> 180      * Retrieve the balance for the transaction&#x27;s sender.                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 181      *                                                                                                   </span>
<span class="7401483982219248523" onmouseenter="enter('7401483982219248523');" onmouseout="out('7401483982219248523');" style=""> 182      * @param token                                                                                      </span>
<span class="-6940003789197397692" onmouseenter="enter('-6940003789197397692');" onmouseout="out('-6940003789197397692');" style=""> 183      * 		the token used to authenticate request                                                          </span>
<span class="-404159422700591307" onmouseenter="enter('-404159422700591307');" onmouseout="out('-404159422700591307');" style=""> 184      * @param transaction                                                                                </span>
<span class="-3868525042437347812" onmouseenter="enter('-3868525042437347812');" onmouseout="out('-3868525042437347812');" style=""> 185      * 		the transaction object                                                                          </span>
<span class="135153539608018056" onmouseenter="enter('135153539608018056');" onmouseout="out('135153539608018056');" style=""> 186      * @throws IllegalStateException                                                                     </span>
<span class="-7322441807725665387" onmouseenter="enter('-7322441807725665387');" onmouseout="out('-7322441807725665387');" style=""> 187      * 		if insufficient funds                                                                           </span>
<span class="2017633050679912998" onmouseenter="enter('2017633050679912998');" onmouseout="out('2017633050679912998');" style=""> 188      * @throws HttpServerErrorException                                                                  </span>
<span class="-2987081787545795820" onmouseenter="enter('-2987081787545795820');" onmouseout="out('-2987081787545795820');" style=""> 189      * 		if balance service returns 500                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 190      */                                                                                                  </span>
<span class="-5956584025775144244" onmouseenter="enter('-5956584025775144244');" onmouseout="out('-5956584025775144244');" style=""> 191     protected int getAvailableBalance(String token, String fromAcct) throws HttpServerErrorException {   </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 192         HttpHeaders headers = new HttpHeaders();                                                         </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 193         headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                 </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 194         HttpEntity entity = new HttpEntity(headers);                                                     </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 195         RestTemplate restTemplate = new RestTemplate();                                                  </span>
<span class="-369342590083106532" onmouseenter="enter('-369342590083106532');" onmouseout="out('-369342590083106532');" style=""> 196         String uri = (balancesApiUri + &quot;/&quot;) + fromAcct;                                                  </span>
<span class="1359361039333264780" onmouseenter="enter('1359361039333264780');" onmouseout="out('1359361039333264780');" style=""><abbr title=" 197         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(uri, HttpMethod.GET, entity, java.lang.Integer.class);"> 197         ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(uri, HttpMethod.GET, entity, java.lang.I</abbr></span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 198         Integer senderBalance = response.getBody();                                                      </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style=""> 199         return senderBalance.intValue();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201 }                                                                                                        </span>




















































































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>
<span class="-6356287537734540725" onmouseenter="enter('-6356287537734540725');" onmouseout="out('-6356287537734540725');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import java.util.concurrent.TimeUnit;                                                                             </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  20  import java.util.logging.Logger;                                                                                  </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="">  21  import java.util.regex.Pattern;                                                                                   </span>
<span  style="">  22                                                                                                                    </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  23  import  org.springframework.web.client.HttpServerErrorException;                                                  </span>
<span  style="">  24                                                                                                                    </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  25  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  26  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  27  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  28  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  29  import org.springframework.http.HttpMethod;                                                                       </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  30  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  31  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  32  import org.springframework.transaction.CannotCreateTransactionException;                                          </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  33  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  34  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  35  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  36  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  37  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  38  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  39  import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  40  import org.springframework.web.client.RestTemplate;                                                               </span>
<span  style="">  41                                                                                                                    </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  42  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  43  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  44  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span  style="">  45                                                                                                                    </span>
<span class="8064918626260915349" onmouseenter="enter('8064918626260915349');" onmouseout="out('8064918626260915349');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import com.google.common.cache.Cache;                                                                             </span>
<span class="-5185947672099267182" onmouseenter="enter('-5185947672099267182');" onmouseout="out('-5185947672099267182');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.google.common.cache.CacheBuilder;                                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +                                                                                                                  </span>


<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  49  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  50  public final class LedgerWriterController {                                                                       </span>
<span  style="">  51                                                                                                                    </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  52      private static final Logger LOGGER =                                                                          </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  53              Logger.getLogger(LedgerWriterController.class.getName());                                             </span>
<span  style="">  54                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  55      @Autowired                                                                                                    </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  56      private TransactionRepository transactionRepository;                                                          </span>
<span  style="">  57                                                                                                                    </span>

<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  58      private JWTVerifier verifier;                                                                                 </span>
<span  style="">  59                                                                                                                    </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  60      private String localRoutingNum;                                                                               </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  61      private String balancesApiUri;                                                                                </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  62      private String version;                                                                                       </span>
<span  style="">  63                                                                                                                    </span>
<span class="998797035934579942" onmouseenter="enter('998797035934579942');" onmouseout="out('998797035934579942');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +    private Cache&lt;String, Long&gt; cache;                                                                            </span>
<span  style="">  65                                                                                                                    </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  66      public static final String READINESS_CODE = &quot;ok&quot;;                                                             </span>
<span class="-5180537597001962089" onmouseenter="enter('-5180537597001962089');" onmouseout="out('-5180537597001962089');" style="">  67      // account ids should be 10 digits between 0 and 9                                                            </span>
<span class="5114768822238164604" onmouseenter="enter('5114768822238164604');" onmouseout="out('5114768822238164604');" style="">  68      private static final Pattern ACCT_REGEX = Pattern.compile(&quot;^[0-9]{10}$&quot;);                                     </span>
<span class="-932074474812291239" onmouseenter="enter('-932074474812291239');" onmouseout="out('-932074474812291239');" style="">  69      // route numbers should be 9 digits between 0 and 9                                                           </span>
<span class="5641026526418219727" onmouseenter="enter('5641026526418219727');" onmouseout="out('5641026526418219727');" style="">  70      private static final Pattern ROUTE_REGEX = Pattern.compile(&quot;^[0-9]{9}$&quot;);                                     </span>


<span  style="">  71                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72      /**                                                                                                           </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  73      * Constructor.                                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  74      *                                                                                                             </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  75      * Initializes JWT verifier.                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  76      */                                                                                                            </span>
<span  style="">  77                                                                                                                    </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  78      public LedgerWriterController(                                                                                </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  79              JWTVerifier verifier,                                                                                 </span>


<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  80              @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                                </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  81              @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                                        </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  82                      String balancesApiUri,                                                                        </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  83              @Value(&quot;${VERSION}&quot;) String version) {                                                                </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  84          this.verifier = verifier;                                                                                 </span>


<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  85          this.localRoutingNum = localRoutingNum;                                                                   </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  86          this.balancesApiUri = balancesApiUri;                                                                     </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  87          this.version = version;                                                                                   </span>
<span class="8244837015881776783" onmouseenter="enter('8244837015881776783');" onmouseout="out('8244837015881776783');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        // Initialize cache to ignore duplicate transactions                                                      </span>
<span class="-1757741908889032370" onmouseenter="enter('-1757741908889032370');" onmouseout="out('-1757741908889032370');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +        this.cache = CacheBuilder.newBuilder()                                                                    </span>
<span class="8658036842979585808" onmouseenter="enter('8658036842979585808');" onmouseout="out('8658036842979585808');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +                            .expireAfterWrite(1, TimeUnit.HOURS)                                                  </span>
<span class="-368814941510255410" onmouseenter="enter('-368814941510255410');" onmouseout="out('-368814941510255410');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +                            .build();                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92      }                                                                                                             </span>
<span  style="">  93                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  94      /**                                                                                                           </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style="">  95       * Version endpoint.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  96       *                                                                                                            </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style="">  97       * @return  service version string                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  98       */                                                                                                           </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style="">  99      @GetMapping(&quot;/version&quot;)                                                                                       </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 100      public ResponseEntity version() {                                                                             </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 101          return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 102      }                                                                                                             </span>
<span  style=""> 103                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 104      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 105       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 106       *                                                                                                            </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 107       * @return HTTP Status 200 if server is ready to receive requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 108       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 109      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 110      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 111      public ResponseEntity&lt;String&gt; readiness() {                                                                   </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 112          return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113      }                                                                                                             </span>
<span  style=""> 114                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 115      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 116       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 117       *                                                                                                            </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 118       * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                                    </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 119       * @param transaction  transaction to submit                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 120       *                                                                                                            </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 121       * @return  HTTP Status 200 if transaction was successfully submitted                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 122       */                                                                                                           </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 123      @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                          </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 124      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 125      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 126              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 127              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 128          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 129              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 131          try {                                                                                                     </span>




<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 132              final DecodedJWT jwt = this.verifier.verify(bearerToken);                                             </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 133 -            // validate transaction                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                                                                                                                  </span>
<span class="-7357029865885638695" onmouseenter="enter('-7357029865885638695');" onmouseout="out('-7357029865885638695');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +            // Check against cache for duplicate transactions                                                     </span>
<span class="-7254451175943600487" onmouseenter="enter('-7254451175943600487');" onmouseout="out('-7254451175943600487');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +            if (this.cache.asMap().containsKey(transaction.getRequestUuid())) {                                   </span>
<span class="4729078722672136378" onmouseenter="enter('4729078722672136378');" onmouseout="out('4729078722672136378');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                throw new IllegalStateException(&quot;duplicate transaction uuid&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +                                                                                                                  </span>
<span class="3711941965633674030" onmouseenter="enter('3711941965633674030');" onmouseout="out('3711941965633674030');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            // Validate transaction                                                                               </span>
<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style=""> 141              validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                                    </span>
<span  style=""> 142                                                                                                                    </span>



<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 143              if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                                        </span>
<span class="-3863348159007948159" onmouseenter="enter('-3863348159007948159');" onmouseout="out('-3863348159007948159');" style=""> 144                  checkAvailableBalance(bearerToken, transaction);                                                  </span>






<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145              }                                                                                                     </span>
<span  style=""> 146                                                                                                                    </span>
<span class="8710345981270163862" onmouseenter="enter('8710345981270163862');" onmouseout="out('8710345981270163862');" style=""> 147              // No exceptions thrown. Add to ledger.                                                               </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 148              submitTransaction(transaction);                                                                       </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 149              return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                          </span>






<span  style=""> 150                                                                                                                    </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 151          } catch (JWTVerificationException e) {                                                                    </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 152              return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                                   </span>

<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 153                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 154          } catch (IllegalArgumentException | IllegalStateException e) {                                            </span>
<span class="621163550797770344" onmouseenter="enter('621163550797770344');" onmouseout="out('621163550797770344');" style=""> 155              return new ResponseEntity&lt;String&gt;(e.toString(),                                                       </span>

<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 156                                                HttpStatus.BAD_REQUEST);                                            </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 157          } catch (ResourceAccessException                                                                          </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 158                  | CannotCreateTransactionException                                                                </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 159                  | HttpServerErrorException e) {                                                                   </span>
<span class="621163550797770344" onmouseenter="enter('621163550797770344');" onmouseout="out('621163550797770344');" style=""> 160              return new ResponseEntity&lt;String&gt;(e.toString(),                                                       </span>

<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 161                                                HttpStatus.INTERNAL_SERVER_ERROR);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163      }                                                                                                             </span>
<span  style=""> 164                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 165      /**                                                                                                           </span>
<span class="2229364433563066002" onmouseenter="enter('2229364433563066002');" onmouseout="out('2229364433563066002');" style=""> 166       * Authenticate transaction details before adding to the ledger.                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 167       *                                                                                                            </span>
<span class="-3652963788986572783" onmouseenter="enter('-3652963788986572783');" onmouseout="out('-3652963788986572783');" style=""> 168       *   - Ensure sender is the same user authenticated by auth token                                             </span>
<span class="-2701545659745935460" onmouseenter="enter('-2701545659745935460');" onmouseout="out('-2701545659745935460');" style=""> 169       *   - Ensure account and routing numbers are in the correct format                                           </span>
<span class="-856713901437325008" onmouseenter="enter('-856713901437325008');" onmouseout="out('-856713901437325008');" style=""> 170       *   - Ensure sender and receiver are different accounts                                                      </span>
<span class="-544897620880383062" onmouseenter="enter('-544897620880383062');" onmouseout="out('-544897620880383062');" style=""> 171       *   - Ensure amount is positive, and sender has proper balance                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 172       *                                                                                                            </span>
<span class="7748711066914526017" onmouseenter="enter('7748711066914526017');" onmouseout="out('7748711066914526017');" style=""> 173       * @param authedAccount  the currently authenticated user account                                             </span>
<span class="8852919027990443396" onmouseenter="enter('8852919027990443396');" onmouseout="out('8852919027990443396');" style=""> 174       * @param transaction    the transaction object                                                               </span>
<span class="1290099720709631956" onmouseenter="enter('1290099720709631956');" onmouseout="out('1290099720709631956');" style=""> 175       * @param bearerToken    the token used to authenticate request                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 176       *                                                                                                            </span>
<span class="-4762603704368785065" onmouseenter="enter('-4762603704368785065');" onmouseout="out('-4762603704368785065');" style=""> 177       * @throws IllegalArgumentException  on validation error                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 178       */                                                                                                           </span>
<span class="-2754892727072734813" onmouseenter="enter('-2754892727072734813');" onmouseout="out('-2754892727072734813');" style=""> 179      private void validateTransaction(String authedAcct, Transaction transaction)                                  </span>
<span class="8276413186315260233" onmouseenter="enter('8276413186315260233');" onmouseout="out('8276413186315260233');" style=""> 180              throws IllegalArgumentException {                                                                     </span>
<span class="-572407210123738711" onmouseenter="enter('-572407210123738711');" onmouseout="out('-572407210123738711');" style=""> 181          final String fromAcct = transaction.getFromAccountNum();                                                  </span>
<span class="-4980365605840155054" onmouseenter="enter('-4980365605840155054');" onmouseout="out('-4980365605840155054');" style=""> 182          final String fromRoute = transaction.getFromRoutingNum();                                                 </span>
<span class="-9044635464691099094" onmouseenter="enter('-9044635464691099094');" onmouseout="out('-9044635464691099094');" style=""> 183          final String toAcct = transaction.getToAccountNum();                                                      </span>
<span class="7977059686940048367" onmouseenter="enter('7977059686940048367');" onmouseout="out('7977059686940048367');" style=""> 184          final String toRoute = transaction.getToRoutingNum();                                                     </span>
<span class="8925465647239632188" onmouseenter="enter('8925465647239632188');" onmouseout="out('8925465647239632188');" style=""> 185          final Integer amount = transaction.getAmount();                                                           </span>
<span  style=""> 186                                                                                                                    </span>
<span class="6349755352144865613" onmouseenter="enter('6349755352144865613');" onmouseout="out('6349755352144865613');" style=""> 187          // If this is an internal transaction,                                                                    </span>
<span class="1470014127388460925" onmouseenter="enter('1470014127388460925');" onmouseout="out('1470014127388460925');" style=""> 188          // ensure it originated from the authenticated user.                                                      </span>
<span class="2648333930953883001" onmouseenter="enter('2648333930953883001');" onmouseout="out('2648333930953883001');" style=""> 189          if (fromRoute.equals(localRoutingNum) &amp;&amp; !fromAcct.equals(authedAcct)) {                                  </span>
<span class="6449485187039532232" onmouseenter="enter('6449485187039532232');" onmouseout="out('6449485187039532232');" style=""> 190              throw new IllegalArgumentException(&quot;sender not authenticated&quot;);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191          }                                                                                                         </span>
<span class="-491817045492860844" onmouseenter="enter('-491817045492860844');" onmouseout="out('-491817045492860844');" style=""> 192          // Validate account and routing numbers.                                                                  </span>
<span class="1675023046800976040" onmouseenter="enter('1675023046800976040');" onmouseout="out('1675023046800976040');" style=""> 193          if (!ACCT_REGEX.matcher(fromAcct).matches()                                                               </span>
<span class="-9222526400148724710" onmouseenter="enter('-9222526400148724710');" onmouseout="out('-9222526400148724710');" style=""> 194                || !ACCT_REGEX.matcher(toAcct).matches()                                                            </span>
<span class="5713413885974004611" onmouseenter="enter('5713413885974004611');" onmouseout="out('5713413885974004611');" style=""> 195                || !ROUTE_REGEX.matcher(fromRoute).matches()                                                        </span>
<span class="-1340324477153524756" onmouseenter="enter('-1340324477153524756');" onmouseout="out('-1340324477153524756');" style=""> 196                || !ROUTE_REGEX.matcher(toRoute).matches()) {                                                       </span>
<span class="7432263930558648421" onmouseenter="enter('7432263930558648421');" onmouseout="out('7432263930558648421');" style=""> 197              throw new IllegalArgumentException(&quot;invalid account details&quot;);                                        </span>
<span  style=""> 198                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199          }                                                                                                         </span>
<span class="-5387244944573007311" onmouseenter="enter('-5387244944573007311');" onmouseout="out('-5387244944573007311');" style=""> 200          // Ensure sender isn&#x27;t receiver.                                                                          </span>
<span class="3531636840399895126" onmouseenter="enter('3531636840399895126');" onmouseout="out('3531636840399895126');" style=""> 201          if (fromAcct.equals(toAcct) &amp;&amp; fromRoute.equals(toRoute)) {                                               </span>
<span class="-9070036533700907498" onmouseenter="enter('-9070036533700907498');" onmouseout="out('-9070036533700907498');" style=""> 202              throw new IllegalArgumentException(&quot;can&#x27;t send to self&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203          }                                                                                                         </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 204          // Ensure amount is valid value.                                                                          </span>
<span class="5562717371907301652" onmouseenter="enter('5562717371907301652');" onmouseout="out('5562717371907301652');" style=""> 205          if (amount &lt;= 0) {                                                                                        </span>
<span class="1959483747532664293" onmouseenter="enter('1959483747532664293');" onmouseout="out('1959483747532664293');" style=""> 206              throw new IllegalArgumentException(&quot;invalid amount&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208      }                                                                                                             </span>
<span  style=""> 209                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 210      /**                                                                                                           </span>
<span class="-3067421476871724105" onmouseenter="enter('-3067421476871724105');" onmouseout="out('-3067421476871724105');" style=""> 211       * Check there is available funds for this transaction.                                                       </span>

<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 212       *                                                                                                            </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 213       * @param token  the token used to authenticate request                                                       </span>
<span class="558860488720865184" onmouseenter="enter('558860488720865184');" onmouseout="out('558860488720865184');" style=""> 214       * @param transaction  the transaction object                                                                 </span>

<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 215       *                                                                                                            </span>
<span class="-6090067309985679431" onmouseenter="enter('-6090067309985679431');" onmouseout="out('-6090067309985679431');" style=""> 216       * @throws IllegalStateException     if insufficient funds                                                    </span>


<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 217       * @throws HttpServerErrorException  if balance service returns 500                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 218       */                                                                                                           </span>
<span class="-5773238618088886857" onmouseenter="enter('-5773238618088886857');" onmouseout="out('-5773238618088886857');" style=""> 219      private void checkAvailableBalance(String token, Transaction transaction)                                     </span>
<span class="6517357040700263768" onmouseenter="enter('6517357040700263768');" onmouseout="out('6517357040700263768');" style=""> 220              throws IllegalStateException, HttpServerErrorException {                                              </span>
<span class="-572407210123738711" onmouseenter="enter('-572407210123738711');" onmouseout="out('-572407210123738711');" style=""> 221          final String fromAcct = transaction.getFromAccountNum();                                                  </span>
<span class="8925465647239632188" onmouseenter="enter('8925465647239632188');" onmouseout="out('8925465647239632188');" style=""> 222          final Integer amount = transaction.getAmount();                                                           </span>
<span  style=""> 223                                                                                                                    </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 224          // Ensure sender balance can cover transaction.                                                           </span>


<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 225          HttpHeaders headers = new HttpHeaders();                                                                  </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 226          headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                          </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 227          HttpEntity entity = new HttpEntity(headers);                                                              </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 228          RestTemplate restTemplate = new RestTemplate();                                                           </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 229          String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                             </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 230          ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                                 </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 231              uri, HttpMethod.GET, entity, Integer.class);                                                          </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 232          Integer senderBalance = response.getBody();                                                               </span>
<span class="4414663458313766444" onmouseenter="enter('4414663458313766444');" onmouseout="out('4414663458313766444');" style=""> 233          if (senderBalance &lt; amount) {                                                                             </span>
<span class="3725575623610824210" onmouseenter="enter('3725575623610824210');" onmouseout="out('3725575623610824210');" style=""> 234              throw new IllegalStateException(&quot;insufficient balance&quot;);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235          }                                                                                                         </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236      }                                                                                                             </span>
<span  style=""> 237                                                                                                                    </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 238      private void submitTransaction(Transaction transaction) {                                                     </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style=""> 239          LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                          </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style=""> 240          transactionRepository.save(transaction);                                                                  </span>
<span class="7776191786658703771" onmouseenter="enter('7776191786658703771');" onmouseout="out('7776191786658703771');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        this.cache.put(                                                                                           </span>
<span class="1583036088999436599" onmouseenter="enter('1583036088999436599');" onmouseout="out('1583036088999436599');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +            transaction.getRequestUuid(), transaction.getTransactionId());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>

<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="">  19  import java.util.logging.Logger;                                                                                  </span>
<span class="1513108047920599059" onmouseenter="enter('1513108047920599059');" onmouseout="out('1513108047920599059');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  20 -import java.util.regex.Pattern;                                                                                   </span>
<span  style="">  21                                                                                                                    </span>
<span class="3248634983943737307" onmouseenter="enter('3248634983943737307');" onmouseout="out('3248634983943737307');" style="">  22  import  org.springframework.web.client.HttpServerErrorException;                                                  </span>
<span  style="">  23                                                                                                                    </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  24 -import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  25  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  26  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  27  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  28  import org.springframework.http.HttpMethod;                                                                       </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  29  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  30  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="5341219335560996028" onmouseenter="enter('5341219335560996028');" onmouseout="out('5341219335560996028');" style="">  31  import org.springframework.transaction.CannotCreateTransactionException;                                          </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  32  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  33  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  34  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  35  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  36  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  37  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  38  import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  39  import org.springframework.web.client.RestTemplate;                                                               </span>
<span  style="">  40                                                                                                                    </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  41  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  42  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  43  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span  style="">  44                                                                                                                    </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="5485927036637514847" onmouseenter="enter('5485927036637514847');" onmouseout="out('5485927036637514847');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +        EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE;                                                                   </span>
<span class="6997167230740553376" onmouseenter="enter('6997167230740553376');" onmouseout="out('6997167230740553376');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import static anthos.samples.financedemo.ledgerwriter.ExceptionMessages.                                          </span>
<span class="-8362488606383815534" onmouseenter="enter('-8362488606383815534');" onmouseout="out('-8362488606383815534');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +        EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL;                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +                                                                                                                  </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  50  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  51  public final class LedgerWriterController {                                                                       </span>
<span  style="">  52                                                                                                                    </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  53      private static final Logger LOGGER =                                                                          </span>
<span class="-7957956039430515397" onmouseenter="enter('-7957956039430515397');" onmouseout="out('-7957956039430515397');" style="">  54              Logger.getLogger(LedgerWriterController.class.getName());                                             </span>
<span  style="">  55                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  56 -    @Autowired                                                                                                    </span>
<span class="-728019112929028725" onmouseenter="enter('-728019112929028725');" onmouseout="out('-728019112929028725');" style="">  57      private TransactionRepository transactionRepository;                                                          </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  58 -                                                                                                                  </span>
<span class="-4578700528226723750" onmouseenter="enter('-4578700528226723750');" onmouseout="out('-4578700528226723750');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    private TransactionValidator transactionValidator;                                                            </span>
<span class="-5049251535661215052" onmouseenter="enter('-5049251535661215052');" onmouseout="out('-5049251535661215052');" style="">  60      private JWTVerifier verifier;                                                                                 </span>
<span  style="">  61                                                                                                                    </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  62      private String localRoutingNum;                                                                               </span>
<span class="-469486944919448386" onmouseenter="enter('-469486944919448386');" onmouseout="out('-469486944919448386');" style="">  63      private String balancesApiUri;                                                                                </span>
<span class="6148824265517010025" onmouseenter="enter('6148824265517010025');" onmouseout="out('6148824265517010025');" style="">  64      private String version;                                                                                       </span>
<span  style="">  65                                                                                                                    </span>

<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  66 -                                                                                                                  </span>
<span class="-6505034648581184544" onmouseenter="enter('-6505034648581184544');" onmouseout="out('-6505034648581184544');" style="">  67      public static final String READINESS_CODE = &quot;ok&quot;;                                                             </span>
<span class="-5180537597001962089" onmouseenter="enter('-5180537597001962089');" onmouseout="out('-5180537597001962089');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  68 -    // account ids should be 10 digits between 0 and 9                                                            </span>
<span class="5114768822238164604" onmouseenter="enter('5114768822238164604');" onmouseout="out('5114768822238164604');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  69 -    private static final Pattern ACCT_REGEX = Pattern.compile(&quot;^[0-9]{10}$&quot;);                                     </span>
<span class="-932074474812291239" onmouseenter="enter('-932074474812291239');" onmouseout="out('-932074474812291239');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  70 -    // route numbers should be 9 digits between 0 and 9                                                           </span>
<span class="5641026526418219727" onmouseenter="enter('5641026526418219727');" onmouseout="out('5641026526418219727');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  71 -    private static final Pattern ROUTE_REGEX = Pattern.compile(&quot;^[0-9]{9}$&quot;);                                     </span>
<span class="-9149089262416743429" onmouseenter="enter('-9149089262416743429');" onmouseout="out('-9149089262416743429');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +    public static final String UNAUTHORIZED_CODE = &quot;not authorized&quot;;                                              </span>
<span class="6290000176908202808" onmouseenter="enter('6290000176908202808');" onmouseout="out('6290000176908202808');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    public static final String JWT_ACCOUNT_KEY = &quot;acct&quot;;                                                          </span>
<span  style="">  74                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  75      /**                                                                                                           </span>
<span class="-1436741038288612910" onmouseenter="enter('-1436741038288612910');" onmouseout="out('-1436741038288612910');" style="">  76      * Constructor.                                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  77      *                                                                                                             </span>
<span class="-5348532432243399187" onmouseenter="enter('-5348532432243399187');" onmouseout="out('-5348532432243399187');" style="">  78      * Initializes JWT verifier.                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  79      */                                                                                                            </span>
<span  style="">  80                                                                                                                    </span>
<span class="8937474768837710123" onmouseenter="enter('8937474768837710123');" onmouseout="out('8937474768837710123');" style="">  81      public LedgerWriterController(                                                                                </span>
<span class="2780303771851218368" onmouseenter="enter('2780303771851218368');" onmouseout="out('2780303771851218368');" style="">  82              JWTVerifier verifier,                                                                                 </span>
<span class="1132068715177995291" onmouseenter="enter('1132068715177995291');" onmouseout="out('1132068715177995291');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +            TransactionRepository transactionRepository,                                                          </span>
<span class="5479269793478582431" onmouseenter="enter('5479269793478582431');" onmouseout="out('5479269793478582431');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +            TransactionValidator transactionValidator,                                                            </span>
<span class="-822564396537268339" onmouseenter="enter('-822564396537268339');" onmouseout="out('-822564396537268339');" style="">  85              @Value(&quot;${LOCAL_ROUTING_NUM}&quot;) String localRoutingNum,                                                </span>
<span class="-2250521274199702466" onmouseenter="enter('-2250521274199702466');" onmouseout="out('-2250521274199702466');" style="">  86              @Value(&quot;http://${BALANCES_API_ADDR}/balances&quot;)                                                        </span>
<span class="5760341242560825698" onmouseenter="enter('5760341242560825698');" onmouseout="out('5760341242560825698');" style="">  87                      String balancesApiUri,                                                                        </span>
<span class="3727660980762547349" onmouseenter="enter('3727660980762547349');" onmouseout="out('3727660980762547349');" style="">  88              @Value(&quot;${VERSION}&quot;) String version) {                                                                </span>
<span class="2791682847397564046" onmouseenter="enter('2791682847397564046');" onmouseout="out('2791682847397564046');" style="">  89          this.verifier = verifier;                                                                                 </span>
<span class="5620916918385755227" onmouseenter="enter('5620916918385755227');" onmouseout="out('5620916918385755227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        this.transactionRepository = transactionRepository;                                                       </span>
<span class="7194621662788445012" onmouseenter="enter('7194621662788445012');" onmouseout="out('7194621662788445012');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        this.transactionValidator = transactionValidator;                                                         </span>
<span class="5248812605098956146" onmouseenter="enter('5248812605098956146');" onmouseout="out('5248812605098956146');" style="">  92          this.localRoutingNum = localRoutingNum;                                                                   </span>
<span class="-1729773563907748731" onmouseenter="enter('-1729773563907748731');" onmouseout="out('-1729773563907748731');" style="">  93          this.balancesApiUri = balancesApiUri;                                                                     </span>
<span class="8734022701570323791" onmouseenter="enter('8734022701570323791');" onmouseout="out('8734022701570323791');" style="">  94          this.version = version;                                                                                   </span>




<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  95      }                                                                                                             </span>
<span  style="">  96                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  97      /**                                                                                                           </span>
<span class="559132540195676827" onmouseenter="enter('559132540195676827');" onmouseout="out('559132540195676827');" style="">  98       * Version endpoint.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  99       *                                                                                                            </span>
<span class="-3837725526160323045" onmouseenter="enter('-3837725526160323045');" onmouseout="out('-3837725526160323045');" style=""> 100       * @return  service version string                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 101       */                                                                                                           </span>
<span class="6685475051439146687" onmouseenter="enter('6685475051439146687');" onmouseout="out('6685475051439146687');" style=""> 102      @GetMapping(&quot;/version&quot;)                                                                                       </span>
<span class="580444279607563843" onmouseenter="enter('580444279607563843');" onmouseout="out('580444279607563843');" style=""> 103      public ResponseEntity version() {                                                                             </span>
<span class="5343850267959959664" onmouseenter="enter('5343850267959959664');" onmouseout="out('5343850267959959664');" style=""> 104          return new ResponseEntity&lt;String&gt;(version, HttpStatus.OK);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105      }                                                                                                             </span>
<span  style=""> 106                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 107      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style=""> 108       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 109       *                                                                                                            </span>
<span class="8463518254556868911" onmouseenter="enter('8463518254556868911');" onmouseout="out('8463518254556868911');" style=""> 110       * @return HTTP Status 200 if server is ready to receive requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 111       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style=""> 112      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 113      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="7271346341917529010" onmouseenter="enter('7271346341917529010');" onmouseout="out('7271346341917529010');" style=""> 114      public ResponseEntity&lt;String&gt; readiness() {                                                                   </span>
<span class="-4075762798656461919" onmouseenter="enter('-4075762798656461919');" onmouseout="out('-4075762798656461919');" style=""> 115          return new ResponseEntity&lt;String&gt;(READINESS_CODE, HttpStatus.OK);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116      }                                                                                                             </span>
<span  style=""> 117                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 118      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 119       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 120       *                                                                                                            </span>
<span class="-1661212859137511783" onmouseenter="enter('-1661212859137511783');" onmouseout="out('-1661212859137511783');" style=""> 121       * @param bearerToken  HTTP request &#x27;Authorization&#x27; header                                                    </span>
<span class="5399615509278749127" onmouseenter="enter('5399615509278749127');" onmouseout="out('5399615509278749127');" style=""> 122       * @param transaction  transaction to submit                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 123       *                                                                                                            </span>
<span class="7486646966745340100" onmouseenter="enter('7486646966745340100');" onmouseout="out('7486646966745340100');" style=""> 124       * @return  HTTP Status 200 if transaction was successfully submitted                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 125       */                                                                                                           </span>
<span class="5323932416516552401" onmouseenter="enter('5323932416516552401');" onmouseout="out('5323932416516552401');" style=""> 126      @PostMapping(value = &quot;/transactions&quot;, consumes = &quot;application/json&quot;)                                          </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 127      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 128      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 129              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 130              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 131          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 132              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 134          try {                                                                                                     </span>
<span class="-4457463381546497224" onmouseenter="enter('-4457463381546497224');" onmouseout="out('-4457463381546497224');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +            if (bearerToken == null) {                                                                            </span>
<span class="-5454936540258631376" onmouseenter="enter('-5454936540258631376');" onmouseout="out('-5454936540258631376');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                throw new IllegalArgumentException(                                                               </span>
<span class="-4688472594501119643" onmouseenter="enter('-4688472594501119643');" onmouseout="out('-4688472594501119643');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                        EXCEPTION_MESSAGE_WHEN_AUTHORIZATION_HEADER_NULL);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +            }                                                                                                     </span>
<span class="-5768910099284843906" onmouseenter="enter('-5768910099284843906');" onmouseout="out('-5768910099284843906');" style=""> 139              final DecodedJWT jwt = this.verifier.verify(bearerToken);                                             </span>
<span class="-6962791519859020761" onmouseenter="enter('-6962791519859020761');" onmouseout="out('-6962791519859020761');" style=""> 140              // validate transaction                                                                               </span>







<span class="3240960694302950410" onmouseenter="enter('3240960694302950410');" onmouseout="out('3240960694302950410');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 141 -            validateTransaction(jwt.getClaim(&quot;acct&quot;).asString(), transaction);                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 142 -                                                                                                                  </span>
<span class="776637986685870327" onmouseenter="enter('776637986685870327');" onmouseout="out('776637986685870327');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +            transactionValidator.validateTransaction(localRoutingNum,                                             </span>
<span class="-4879758647615452357" onmouseenter="enter('-4879758647615452357');" onmouseout="out('-4879758647615452357');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    jwt.getClaim(JWT_ACCOUNT_KEY).asString(), transaction);                                       </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +            // Ensure sender balance can cover transaction.                                                       </span>
<span class="-6144219964793655128" onmouseenter="enter('-6144219964793655128');" onmouseout="out('-6144219964793655128');" style=""> 146              if (transaction.getFromRoutingNum().equals(localRoutingNum)) {                                        </span>
<span class="-3863348159007948159" onmouseenter="enter('-3863348159007948159');" onmouseout="out('-3863348159007948159');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 147 -                checkAvailableBalance(bearerToken, transaction);                                                  </span>
<span class="7239735847198029864" onmouseenter="enter('7239735847198029864');" onmouseout="out('7239735847198029864');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                int balance = getAvailableBalance(                                                                </span>
<span class="7702083458280016025" onmouseenter="enter('7702083458280016025');" onmouseout="out('7702083458280016025');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                        bearerToken, transaction.getFromAccountNum());                                            </span>
<span class="-8424323426889164999" onmouseenter="enter('-8424323426889164999');" onmouseout="out('-8424323426889164999');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                if (balance &lt; transaction.getAmount()) {                                                          </span>
<span class="-8046945014218387655" onmouseenter="enter('-8046945014218387655');" onmouseout="out('-8046945014218387655');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                    throw new IllegalStateException(                                                              </span>
<span class="-5146115328615515543" onmouseenter="enter('-5146115328615515543');" onmouseout="out('-5146115328615515543');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                            EXCEPTION_MESSAGE_INSUFFICIENT_BALANCE);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154              }                                                                                                     </span>
<span  style=""> 155                                                                                                                    </span>
<span class="8710345981270163862" onmouseenter="enter('8710345981270163862');" onmouseout="out('8710345981270163862');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 156 -            // No exceptions thrown. Add to ledger.                                                               </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 157 -            submitTransaction(transaction);                                                                       </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 158 -            return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                          </span>
<span class="-3539745766511737220" onmouseenter="enter('-3539745766511737220');" onmouseout="out('-3539745766511737220');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            // No exceptions thrown. Add to ledger                                                                </span>
<span class="613498208305766257" onmouseenter="enter('613498208305766257');" onmouseout="out('613498208305766257');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            LOGGER.fine(&quot;Submitting transaction &quot;                                                                 </span>
<span class="2531207035820706002" onmouseenter="enter('2531207035820706002');" onmouseout="out('2531207035820706002');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    + transaction.toString());                                                                    </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +            transactionRepository.save(transaction);                                                              </span>
<span class="-5231725033690787161" onmouseenter="enter('-5231725033690787161');" onmouseout="out('-5231725033690787161');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +            return new ResponseEntity&lt;String&gt;(READINESS_CODE,                                                     </span>
<span class="-8527330892964817671" onmouseenter="enter('-8527330892964817671');" onmouseout="out('-8527330892964817671');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                    HttpStatus.CREATED);                                                                          </span>
<span  style=""> 165                                                                                                                    </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 166          } catch (JWTVerificationException e) {                                                                    </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 167 -            return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                                   </span>
<span class="-4154758301555607236" onmouseenter="enter('-4154758301555607236');" onmouseout="out('-4154758301555607236');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            return new ResponseEntity&lt;String&gt;(UNAUTHORIZED_CODE,                                                  </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 169                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-16261657306661328" onmouseenter="enter('-16261657306661328');" onmouseout="out('-16261657306661328');" style=""> 170          } catch (IllegalArgumentException | IllegalStateException e) {                                            </span>
<span class="621163550797770344" onmouseenter="enter('621163550797770344');" onmouseout="out('621163550797770344');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 171 -            return new ResponseEntity&lt;String&gt;(e.toString(),                                                       </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +            return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 173                                                HttpStatus.BAD_REQUEST);                                            </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 174          } catch (ResourceAccessException                                                                          </span>
<span class="7920423166678117814" onmouseenter="enter('7920423166678117814');" onmouseout="out('7920423166678117814');" style=""> 175                  | CannotCreateTransactionException                                                                </span>
<span class="-7265908382255363783" onmouseenter="enter('-7265908382255363783');" onmouseout="out('-7265908382255363783');" style=""> 176                  | HttpServerErrorException e) {                                                                   </span>
<span class="621163550797770344" onmouseenter="enter('621163550797770344');" onmouseout="out('621163550797770344');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 177 -            return new ResponseEntity&lt;String&gt;(e.toString(),                                                       </span>
<span class="4951897796013672092" onmouseenter="enter('4951897796013672092');" onmouseout="out('4951897796013672092');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +            return new ResponseEntity&lt;String&gt;(e.getMessage(),                                                     </span>
<span class="862392687202373996" onmouseenter="enter('862392687202373996');" onmouseout="out('862392687202373996');" style=""> 179                                                HttpStatus.INTERNAL_SERVER_ERROR);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181      }                                                                                                             </span>
<span  style=""> 182                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 183      /**                                                                                                           </span>
<span class="2229364433563066002" onmouseenter="enter('2229364433563066002');" onmouseout="out('2229364433563066002');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 184 -     * Authenticate transaction details before adding to the ledger.                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 185 -     *                                                                                                            </span>
<span class="-3652963788986572783" onmouseenter="enter('-3652963788986572783');" onmouseout="out('-3652963788986572783');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 186 -     *   - Ensure sender is the same user authenticated by auth token                                             </span>
<span class="-2701545659745935460" onmouseenter="enter('-2701545659745935460');" onmouseout="out('-2701545659745935460');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 187 -     *   - Ensure account and routing numbers are in the correct format                                           </span>
<span class="-856713901437325008" onmouseenter="enter('-856713901437325008');" onmouseout="out('-856713901437325008');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 188 -     *   - Ensure sender and receiver are different accounts                                                      </span>
<span class="-544897620880383062" onmouseenter="enter('-544897620880383062');" onmouseout="out('-544897620880383062');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 189 -     *   - Ensure amount is positive, and sender has proper balance                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 190 -     *                                                                                                            </span>
<span class="7748711066914526017" onmouseenter="enter('7748711066914526017');" onmouseout="out('7748711066914526017');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 191 -     * @param authedAccount  the currently authenticated user account                                             </span>
<span class="8852919027990443396" onmouseenter="enter('8852919027990443396');" onmouseout="out('8852919027990443396');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 192 -     * @param transaction    the transaction object                                                               </span>
<span class="1290099720709631956" onmouseenter="enter('1290099720709631956');" onmouseout="out('1290099720709631956');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 193 -     * @param bearerToken    the token used to authenticate request                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 194 -     *                                                                                                            </span>
<span class="-4762603704368785065" onmouseenter="enter('-4762603704368785065');" onmouseout="out('-4762603704368785065');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 195 -     * @throws IllegalArgumentException  on validation error                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 196 -     */                                                                                                           </span>
<span class="-2754892727072734813" onmouseenter="enter('-2754892727072734813');" onmouseout="out('-2754892727072734813');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 197 -    private void validateTransaction(String authedAcct, Transaction transaction)                                  </span>
<span class="8276413186315260233" onmouseenter="enter('8276413186315260233');" onmouseout="out('8276413186315260233');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 198 -            throws IllegalArgumentException {                                                                     </span>
<span class="-572407210123738711" onmouseenter="enter('-572407210123738711');" onmouseout="out('-572407210123738711');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 199 -        final String fromAcct = transaction.getFromAccountNum();                                                  </span>
<span class="-4980365605840155054" onmouseenter="enter('-4980365605840155054');" onmouseout="out('-4980365605840155054');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 200 -        final String fromRoute = transaction.getFromRoutingNum();                                                 </span>
<span class="-9044635464691099094" onmouseenter="enter('-9044635464691099094');" onmouseout="out('-9044635464691099094');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 201 -        final String toAcct = transaction.getToAccountNum();                                                      </span>
<span class="7977059686940048367" onmouseenter="enter('7977059686940048367');" onmouseout="out('7977059686940048367');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 202 -        final String toRoute = transaction.getToRoutingNum();                                                     </span>
<span class="8925465647239632188" onmouseenter="enter('8925465647239632188');" onmouseout="out('8925465647239632188');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 203 -        final Integer amount = transaction.getAmount();                                                           </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 204 -                                                                                                                  </span>
<span class="6349755352144865613" onmouseenter="enter('6349755352144865613');" onmouseout="out('6349755352144865613');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 205 -        // If this is an internal transaction,                                                                    </span>
<span class="1470014127388460925" onmouseenter="enter('1470014127388460925');" onmouseout="out('1470014127388460925');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 206 -        // ensure it originated from the authenticated user.                                                      </span>
<span class="2648333930953883001" onmouseenter="enter('2648333930953883001');" onmouseout="out('2648333930953883001');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 207 -        if (fromRoute.equals(localRoutingNum) &amp;&amp; !fromAcct.equals(authedAcct)) {                                  </span>
<span class="6449485187039532232" onmouseenter="enter('6449485187039532232');" onmouseout="out('6449485187039532232');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 208 -            throw new IllegalArgumentException(&quot;sender not authenticated&quot;);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 209 -        }                                                                                                         </span>
<span class="-491817045492860844" onmouseenter="enter('-491817045492860844');" onmouseout="out('-491817045492860844');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 210 -        // Validate account and routing numbers.                                                                  </span>
<span class="1675023046800976040" onmouseenter="enter('1675023046800976040');" onmouseout="out('1675023046800976040');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 211 -        if (!ACCT_REGEX.matcher(fromAcct).matches()                                                               </span>
<span class="-9222526400148724710" onmouseenter="enter('-9222526400148724710');" onmouseout="out('-9222526400148724710');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 212 -              || !ACCT_REGEX.matcher(toAcct).matches()                                                            </span>
<span class="5713413885974004611" onmouseenter="enter('5713413885974004611');" onmouseout="out('5713413885974004611');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 213 -              || !ROUTE_REGEX.matcher(fromRoute).matches()                                                        </span>
<span class="-1340324477153524756" onmouseenter="enter('-1340324477153524756');" onmouseout="out('-1340324477153524756');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 214 -              || !ROUTE_REGEX.matcher(toRoute).matches()) {                                                       </span>
<span class="7432263930558648421" onmouseenter="enter('7432263930558648421');" onmouseout="out('7432263930558648421');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 215 -            throw new IllegalArgumentException(&quot;invalid account details&quot;);                                        </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 216 -                                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 217 -        }                                                                                                         </span>
<span class="-5387244944573007311" onmouseenter="enter('-5387244944573007311');" onmouseout="out('-5387244944573007311');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 218 -        // Ensure sender isn&#x27;t receiver.                                                                          </span>
<span class="3531636840399895126" onmouseenter="enter('3531636840399895126');" onmouseout="out('3531636840399895126');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 219 -        if (fromAcct.equals(toAcct) &amp;&amp; fromRoute.equals(toRoute)) {                                               </span>
<span class="-9070036533700907498" onmouseenter="enter('-9070036533700907498');" onmouseout="out('-9070036533700907498');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 220 -            throw new IllegalArgumentException(&quot;can&#x27;t send to self&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 221 -        }                                                                                                         </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 222 -        // Ensure amount is valid value.                                                                          </span>
<span class="5562717371907301652" onmouseenter="enter('5562717371907301652');" onmouseout="out('5562717371907301652');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 223 -        if (amount &lt;= 0) {                                                                                        </span>
<span class="1959483747532664293" onmouseenter="enter('1959483747532664293');" onmouseout="out('1959483747532664293');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 224 -            throw new IllegalArgumentException(&quot;invalid amount&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 225 -        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 226 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 227 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 228 -    /**                                                                                                           </span>
<span class="-3067421476871724105" onmouseenter="enter('-3067421476871724105');" onmouseout="out('-3067421476871724105');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 229 -     * Check there is available funds for this transaction.                                                       </span>
<span class="-840803106370353754" onmouseenter="enter('-840803106370353754');" onmouseout="out('-840803106370353754');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +     * Retrieve the balance for the transaction&#x27;s sender.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 231       *                                                                                                            </span>
<span class="-5399624366599429167" onmouseenter="enter('-5399624366599429167');" onmouseout="out('-5399624366599429167');" style=""> 232       * @param token  the token used to authenticate request                                                       </span>
<span class="558860488720865184" onmouseenter="enter('558860488720865184');" onmouseout="out('558860488720865184');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 233 -     * @param transaction  the transaction object                                                                 </span>
<span class="5530241027805460636" onmouseenter="enter('5530241027805460636');" onmouseout="out('5530241027805460636');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +     * @param fromAcct  sender account number                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 235       *                                                                                                            </span>
<span class="-6090067309985679431" onmouseenter="enter('-6090067309985679431');" onmouseout="out('-6090067309985679431');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 236 -     * @throws IllegalStateException     if insufficient funds                                                    </span>
<span class="-4671862933441611565" onmouseenter="enter('-4671862933441611565');" onmouseout="out('-4671862933441611565');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +     * @return available balance of the sender account                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +     *                                                                                                            </span>
<span class="7966166498405371741" onmouseenter="enter('7966166498405371741');" onmouseout="out('7966166498405371741');" style=""> 239       * @throws HttpServerErrorException  if balance service returns 500                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 240       */                                                                                                           </span>
<span class="-5773238618088886857" onmouseenter="enter('-5773238618088886857');" onmouseout="out('-5773238618088886857');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 241 -    private void checkAvailableBalance(String token, Transaction transaction)                                     </span>
<span class="6517357040700263768" onmouseenter="enter('6517357040700263768');" onmouseout="out('6517357040700263768');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 242 -            throws IllegalStateException, HttpServerErrorException {                                              </span>
<span class="-572407210123738711" onmouseenter="enter('-572407210123738711');" onmouseout="out('-572407210123738711');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 243 -        final String fromAcct = transaction.getFromAccountNum();                                                  </span>
<span class="8925465647239632188" onmouseenter="enter('8925465647239632188');" onmouseout="out('8925465647239632188');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 244 -        final Integer amount = transaction.getAmount();                                                           </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 245 -                                                                                                                  </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 246 -        // Ensure sender balance can cover transaction.                                                           </span>
<span class="-4867839573468993721" onmouseenter="enter('-4867839573468993721');" onmouseout="out('-4867839573468993721');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +    protected int getAvailableBalance(String token, String fromAcct)                                              </span>
<span class="7044480961715798280" onmouseenter="enter('7044480961715798280');" onmouseout="out('7044480961715798280');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +            throws HttpServerErrorException {                                                                     </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 249          HttpHeaders headers = new HttpHeaders();                                                                  </span>
<span class="3201291767686862102" onmouseenter="enter('3201291767686862102');" onmouseout="out('3201291767686862102');" style=""> 250          headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + token);                                                          </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 251          HttpEntity entity = new HttpEntity(headers);                                                              </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 252          RestTemplate restTemplate = new RestTemplate();                                                           </span>
<span class="5149154134365859036" onmouseenter="enter('5149154134365859036');" onmouseout="out('5149154134365859036');" style=""> 253          String uri = balancesApiUri + &quot;/&quot; + fromAcct;                                                             </span>
<span class="-697674251075958280" onmouseenter="enter('-697674251075958280');" onmouseout="out('-697674251075958280');" style=""> 254          ResponseEntity&lt;Integer&gt; response = restTemplate.exchange(                                                 </span>
<span class="6083870125336786698" onmouseenter="enter('6083870125336786698');" onmouseout="out('6083870125336786698');" style=""> 255              uri, HttpMethod.GET, entity, Integer.class);                                                          </span>
<span class="6400740982500579689" onmouseenter="enter('6400740982500579689');" onmouseout="out('6400740982500579689');" style=""> 256          Integer senderBalance = response.getBody();                                                               </span>
<span class="4414663458313766444" onmouseenter="enter('4414663458313766444');" onmouseout="out('4414663458313766444');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 257 -        if (senderBalance &lt; amount) {                                                                             </span>
<span class="3725575623610824210" onmouseenter="enter('3725575623610824210');" onmouseout="out('3725575623610824210');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 258 -            throw new IllegalStateException(&quot;insufficient balance&quot;);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 259 -        }                                                                                                         </span>
<span class="8092340863849585815" onmouseenter="enter('8092340863849585815');" onmouseout="out('8092340863849585815');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +        return senderBalance.intValue();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261      }                                                                                                             </span>
<span  style=""> 262                                                                                                                    </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 263 -    private void submitTransaction(Transaction transaction) {                                                     </span>
<span class="2309451821633502245" onmouseenter="enter('2309451821633502245');" onmouseout="out('2309451821633502245');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 264 -        LOGGER.fine(&quot;Submitting transaction &quot; + transaction.toString());                                          </span>
<span class="-7584575581620960643" onmouseenter="enter('-7584575581620960643');" onmouseout="out('-7584575581620960643');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 265 -        transactionRepository.save(transaction);                                                                  </span>


<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 266 -    }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            