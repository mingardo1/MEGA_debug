<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>200</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    200
                    <a href="199.html">prev</a>
                    <a href="201.html">next</a>
                    <a href="200_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_6bb99c2e165c1531f99c2c66b0212e1f0df50635_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/security/XssRequestWrapper.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/security/XssRequestWrapper.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/security/XssRequestWrapper.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/security/XssRequestWrapper.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;df478ca5d04870811a3cd35fc095ce4923365ab4:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/security/XssRequestWrapper.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2020 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.security;
  19 
  20 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import org.broadleafcommerce.common.util.StringUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import javax.servlet.http.HttpServletRequestWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.util.regex.Pattern;</span>
  29 ||||||| GitAnalyzerPlus_base
  30 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import java.util.regex.Pattern;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import javax.servlet.http.HttpServletRequestWrapper;</span>
  39 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  40 
  41 public class XssRequestWrapper extends HttpServletRequestWrapper {
  42 
  43     protected final Environment environment;
  44     private String[] whiteListParamNames;
  45 
<abbr title="  46     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNames) {">  46     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteLiðŸ”µ</abbr>
  47         super(servletRequest);
  48         this.environment = environment;
  49         this.whiteListParamNames = whiteListParamNames;
  50     }
  51 
  52     @Override
  53     public String[] getParameterValues(String parameter) {
  54 
  55         String[] values = super.getParameterValues(parameter);
  56         if(checkWhitelist(parameter)){
  57             return values;
  58         }
  59         if (values == null) {
  60             return null;
  61         }
  62 
  63         int count = values.length;
  64         String[] encodedValues = new String[count];
  65         for (int i = 0; i &lt; count; i++) {
  66             encodedValues[i] = stripXSS(values[i]);
  67         }
  68 
  69         return encodedValues;
  70     }
  71 
  72     private boolean checkWhitelist(String parameter) {
  73         for (String whiteListParamName : whiteListParamNames) {
  74             if(whiteListParamName.equals(parameter)){
  75                 return true;
  76             }
  77         }
  78         return false;
  79     }
  80 
  81     @Override
  82     public String getParameter(String parameter) {
  83         String value = super.getParameter(parameter);
  84         if(checkWhitelist(parameter)){
  85             return value;
  86         }
  87         return stripXSS(value);
  88     }
  89 
  90     private String stripXSS(String value) {
  91         if (value != null) {
<abbr title="  92             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;false&quot;));">  92             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;faðŸ”µ</abbr>
  93             if (customStripXss) {
  94                 value = customStripXss(value);
  95             } else {
  96                 String newValue;
  97                 try {
  98                     newValue = ESAPI.validator().getValidSafeHTML(&quot;context&quot;, value, 99999, true);
  99                 } catch (ValidationException e) {
 100                     newValue = ESAPI.encoder().encodeForHTML(value);
 101                 }
 102                 value = newValue;
 103             }
 104         }
 105         return value;
 106     }
 107 
 108     private String customStripXss(String value) {
 109         // Avoid null characters
 110         value = value.replaceAll(&quot;&quot;, &quot;&quot;);
 111 
 112         // Avoid anything between script tags
 113         Pattern scriptPattern = Pattern.compile(&quot;&lt;script&gt;(.*?)&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
 114         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 115 
 116         // Avoid anything in a src=&#x27;...&#x27; type of expression
<abbr title=" 117         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 117         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | PatðŸ”µ</abbr>
 118         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 119 
<abbr title=" 120         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 120         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | PatðŸ”µ</abbr>
 121         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 122 
 123         // Remove any lonesome &lt;/script&gt; tag
 124         scriptPattern = Pattern.compile(&quot;&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
 125         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 126 
 127         // Remove any lonesome &lt;script ...&gt; tag
<abbr title=" 128         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 128         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PðŸ”µ</abbr>
 129         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 130 
 131         // Avoid eval(...) expressions
<abbr title=" 132         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 132         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE |ðŸ”µ</abbr>
 133         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 134 
 135         // Avoid expression(...) expressions
<abbr title=" 136         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 136         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTIðŸ”µ</abbr>
 137         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 138 
 139         // Avoid javascript:... expressions
 140         scriptPattern = Pattern.compile(&quot;javascript:&quot;, Pattern.CASE_INSENSITIVE);
 141         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 142 
 143         // Avoid vbscript:... expressions
 144         scriptPattern = Pattern.compile(&quot;vbscript:&quot;, Pattern.CASE_INSENSITIVE);
 145         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 146 
 147         // Avoid onload= expressions
<abbr title=" 148         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 148         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PaðŸ”µ</abbr>
 149         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 150         return value;
 151     }
 152 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2020 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.security;
  19 
  20 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import org.broadleafcommerce.common.util.StringUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import javax.servlet.http.HttpServletRequestWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.util.regex.Pattern;</span>
  29 ||||||| BASE
  30 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import java.util.regex.Pattern;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import javax.servlet.http.HttpServletRequestWrapper;</span>
  39 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  40 
  41 public class XssRequestWrapper extends HttpServletRequestWrapper {
  42 
  43     protected final Environment environment;
  44     private String[] whiteListParamNames;
  45 
<abbr title="  46     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNames) {">  46     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteLiðŸ”µ</abbr>
  47         super(servletRequest);
  48         this.environment = environment;
  49         this.whiteListParamNames = whiteListParamNames;
  50     }
  51 
  52     @Override
  53     public String[] getParameterValues(String parameter) {
  54 
  55         String[] values = super.getParameterValues(parameter);
  56         if(checkWhitelist(parameter)){
  57             return values;
  58         }
  59         if (values == null) {
  60             return null;
  61         }
  62 
  63         int count = values.length;
  64         String[] encodedValues = new String[count];
  65         for (int i = 0; i &lt; count; i++) {
  66             encodedValues[i] = stripXSS(values[i]);
  67         }
  68 
  69         return encodedValues;
  70     }
  71 
  72     private boolean checkWhitelist(String parameter) {
  73         for (String whiteListParamName : whiteListParamNames) {
  74             if(whiteListParamName.equals(parameter)){
  75                 return true;
  76             }
  77         }
  78         return false;
  79     }
  80 
  81     @Override
  82     public String getParameter(String parameter) {
  83         String value = super.getParameter(parameter);
  84         if(checkWhitelist(parameter)){
  85             return value;
  86         }
  87         return stripXSS(value);
  88     }
  89 
  90     private String stripXSS(String value) {
  91         if (value != null) {
<abbr title="  92             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;false&quot;));">  92             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;faðŸ”µ</abbr>
  93             if (customStripXss) {
  94                 value = customStripXss(value);
  95             } else {
  96                 String newValue;
  97                 try {
  98                     newValue = ESAPI.validator().getValidSafeHTML(&quot;context&quot;, value, 99999, true);
  99                 } catch (ValidationException e) {
 100                     newValue = ESAPI.encoder().encodeForHTML(value);
 101                 }
 102                 value = newValue;
 103             }
 104         }
 105         return value;
 106     }
 107 
 108     private String customStripXss(String value) {
 109         // Avoid null characters
 110         value = value.replaceAll(&quot;&quot;, &quot;&quot;);
 111 
 112         // Avoid anything between script tags
 113         Pattern scriptPattern = Pattern.compile(&quot;&lt;script&gt;(.*?)&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
 114         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 115 
 116         // Avoid anything in a src=&#x27;...&#x27; type of expression
<abbr title=" 117         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 117         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | PatðŸ”µ</abbr>
 118         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 119 
<abbr title=" 120         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 120         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | PatðŸ”µ</abbr>
 121         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 122 
 123         // Remove any lonesome &lt;/script&gt; tag
 124         scriptPattern = Pattern.compile(&quot;&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
 125         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 126 
 127         // Remove any lonesome &lt;script ...&gt; tag
<abbr title=" 128         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 128         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PðŸ”µ</abbr>
 129         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 130 
 131         // Avoid eval(...) expressions
<abbr title=" 132         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 132         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE |ðŸ”µ</abbr>
 133         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 134 
 135         // Avoid expression(...) expressions
<abbr title=" 136         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 136         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTIðŸ”µ</abbr>
 137         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 138 
 139         // Avoid javascript:... expressions
 140         scriptPattern = Pattern.compile(&quot;javascript:&quot;, Pattern.CASE_INSENSITIVE);
 141         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 142 
 143         // Avoid vbscript:... expressions
 144         scriptPattern = Pattern.compile(&quot;vbscript:&quot;, Pattern.CASE_INSENSITIVE);
 145         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 146 
 147         // Avoid onload= expressions
<abbr title=" 148         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 148         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PaðŸ”µ</abbr>
 149         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 150         return value;
 151     }
 152 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework Web
   4  * %%
   5  * Copyright (C) 2009 - 2020 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.web.security;
  19 
  20 import java.util.regex.Pattern;
  21 import javax.servlet.http.HttpServletRequest;
  22 import javax.servlet.http.HttpServletRequestWrapper;
  23 import org.broadleafcommerce.common.util.StringUtil;
  24 import org.owasp.esapi.ESAPI;
  25 import org.owasp.esapi.errors.ValidationException;
  26 import org.springframework.core.env.Environment;
  27 
  28 
  29 public class XssRequestWrapper extends HttpServletRequestWrapper {
  30     protected final Environment environment;
  31 
  32     private String[] whiteListParamNames;
  33 
<abbr title="  34     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNames) {">  34     public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteLiðŸ”µ</abbr>
  35         super(servletRequest);
  36         this.environment = environment;
  37         this.whiteListParamNames = whiteListParamNames;
  38     }
  39 
  40     @Override
  41     public String[] getParameterValues(String parameter) {
  42         String[] values = super.getParameterValues(parameter);
  43         if (checkWhitelist(parameter)) {
  44             return values;
  45         }
  46         if (values == null) {
  47             return null;
  48         }
  49         int count = values.length;
  50         String[] encodedValues = new String[count];
  51         for (int i = 0; i &lt; count; i++) {
  52             encodedValues[i] = stripXSS(values[i]);
  53         }
  54         return encodedValues;
  55     }
  56 
  57     private boolean checkWhitelist(String parameter) {
  58         for (String whiteListParamName : whiteListParamNames) {
  59             if (whiteListParamName.equals(parameter)) {
  60                 return true;
  61             }
  62         }
  63         return false;
  64     }
  65 
  66     @Override
  67     public String getParameter(String parameter) {
  68         String value = super.getParameter(parameter);
  69         if (checkWhitelist(parameter)) {
  70             return value;
  71         }
  72         return stripXSS(value);
  73     }
  74 
  75     private String stripXSS(String value) {
  76         if (value != null) {
<abbr title="  77             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;false&quot;));">  77             boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;faðŸ”µ</abbr>
  78             if (customStripXss) {
  79                 value = customStripXss(value);
  80             } else {
  81                 String newValue;
  82                 try {
  83                     newValue = ESAPI.validator().getValidSafeHTML(&quot;context&quot;, value, 99999, true);
  84                 } catch (ValidationException e) {
  85                     newValue = ESAPI.encoder().encodeForHTML(value);
  86                 }
  87                 value = newValue;
  88             }
  89         }
  90         return value;
  91     }
  92 
  93     private String customStripXss(String value) {
  94         // Avoid null characters
  95         value = value.replaceAll(&quot;&quot;, &quot;&quot;);
  96         // Avoid anything between script tags
  97         Pattern scriptPattern = Pattern.compile(&quot;&lt;script&gt;(.*?)&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
  98         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
  99         // Avoid anything in a src=&#x27;...&#x27; type of expression
<abbr title=" 100         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 100         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, (Pattern.CASE_INSENSITIVE | PaðŸ”µ</abbr>
 101         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
<abbr title=" 102         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 102         scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, (Pattern.CASE_INSENSITIVE | PaðŸ”µ</abbr>
 103         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 104         // Remove any lonesome &lt;/script&gt; tag
 105         scriptPattern = Pattern.compile(&quot;&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);
 106         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 107         // Remove any lonesome &lt;script ...&gt; tag
<abbr title=" 108         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 108         scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) |ðŸ”µ</abbr>
 109         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 110         // Avoid eval(...) expressions
<abbr title=" 111         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 111         scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE)ðŸ”µ</abbr>
 112         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 113         // Avoid expression(...) expressions
<abbr title=" 114         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 114         scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTðŸ”µ</abbr>
 115         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 116         // Avoid javascript:... expressions
 117         scriptPattern = Pattern.compile(&quot;javascript:&quot;, Pattern.CASE_INSENSITIVE);
 118         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 119         // Avoid vbscript:... expressions
 120         scriptPattern = Pattern.compile(&quot;vbscript:&quot;, Pattern.CASE_INSENSITIVE);
 121         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 122         // Avoid onload= expressions
<abbr title=" 123         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | Pattern.DOTALL);"> 123         scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, (Pattern.CASE_INSENSITIVE | Pattern.MULTILINE) | ðŸ”µ</abbr>
 124         value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);
 125         return value;
 126     }
 127 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * #%L</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * BroadleafCommerce Framework Web</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * Copyright (C) 2009 - 2020 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * shall apply.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * #L%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +package org.broadleafcommerce.core.web.security;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.broadleafcommerce.common.util.StringUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import javax.servlet.http.HttpServletRequestWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import java.util.regex.Pattern;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +public class XssRequestWrapper extends HttpServletRequestWrapper {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +    protected final Environment environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +    private String[] whiteListParamNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  34 +    public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNames) {">  34 +    public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +        super(servletRequest);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +        this.environment = environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +        this.whiteListParamNames = whiteListParamNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +    public String[] getParameterValues(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +        String[] values = super.getParameterValues(parameter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +        if(checkWhitelist(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +            return values;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +        if (values == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +            return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +        int count = values.length;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +        String[] encodedValues = new String[count];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +        for (int i = 0; i &lt; count; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +            encodedValues[i] = stripXSS(values[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +        return encodedValues;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private boolean checkWhitelist(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +        for (String whiteListParamName : whiteListParamNames) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +            if(whiteListParamName.equals(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +        return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    public String getParameter(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        String value = super.getParameter(parameter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +        if(checkWhitelist(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +            return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        return stripXSS(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    private String stripXSS(String value) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        if (value != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +            boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;false&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +            if (customStripXss) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                value = customStripXss(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +                String newValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +                    newValue = ESAPI.validator().getValidSafeHTML(&quot;context&quot;, value, 99999, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +                } catch (ValidationException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                    newValue = ESAPI.encoder().encodeForHTML(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +                value = newValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    private String customStripXss(String value) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        // Avoid null characters</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        value = value.replaceAll(&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        // Avoid anything between script tags</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        Pattern scriptPattern = Pattern.compile(&quot;&lt;script&gt;(.*?)&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        // Avoid anything in a src=&#x27;...&#x27; type of expression</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 105 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 105 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 108 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 108 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        // Remove any lonesome &lt;/script&gt; tag</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        scriptPattern = Pattern.compile(&quot;&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        // Remove any lonesome &lt;script ...&gt; tag</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 116 +        scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 116 +        scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        // Avoid eval(...) expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 120 +        scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 120 +        scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        // Avoid expression(...) expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 124 +        scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 124 +        scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        // Avoid javascript:... expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        scriptPattern = Pattern.compile(&quot;javascript:&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        // Avoid vbscript:... expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        scriptPattern = Pattern.compile(&quot;vbscript:&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        // Avoid onload= expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 136 +        scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 136 +        scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +}</span></pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * #%L</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * BroadleafCommerce Framework Web</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * Copyright (C) 2009 - 2020 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * shall apply.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * #L%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +package org.broadleafcommerce.core.web.security;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.owasp.esapi.ESAPI;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.owasp.esapi.errors.ValidationException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import java.util.regex.Pattern;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import javax.servlet.http.HttpServletRequestWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +public class XssRequestWrapper extends HttpServletRequestWrapper {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +    protected final Environment environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +    private String[] whiteListParamNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  34 +    public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNames) {">  34 +    public XssRequestWrapper(HttpServletRequest servletRequest, Environment environment, String[] whiteListParamNaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +        super(servletRequest);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +        this.environment = environment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +        this.whiteListParamNames = whiteListParamNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +    public String[] getParameterValues(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +        String[] values = super.getParameterValues(parameter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +        if(checkWhitelist(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +            return values;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +        if (values == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +            return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +        int count = values.length;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +        String[] encodedValues = new String[count];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +        for (int i = 0; i &lt; count; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +            encodedValues[i] = stripXSS(values[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +        return encodedValues;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private boolean checkWhitelist(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +        for (String whiteListParamName : whiteListParamNames) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +            if(whiteListParamName.equals(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +        return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    public String getParameter(String parameter) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        String value = super.getParameter(parameter);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +        if(checkWhitelist(parameter)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +            return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        return stripXSS(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    private String stripXSS(String value) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        if (value != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +            boolean customStripXss = Boolean.parseBoolean(environment.getProperty(&quot;custom.strip.xss&quot;, &quot;false&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +            if (customStripXss) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                value = customStripXss(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +                String newValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +                    newValue = ESAPI.validator().getValidSafeHTML(&quot;context&quot;, value, 99999, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +                } catch (ValidationException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                    newValue = ESAPI.encoder().encodeForHTML(value);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +                value = newValue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    private String customStripXss(String value) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        // Avoid null characters</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        value = value.replaceAll(&quot;&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        // Avoid anything between script tags</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        Pattern scriptPattern = Pattern.compile(&quot;&lt;script&gt;(.*?)&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        // Avoid anything in a src=&#x27;...&#x27; type of expression</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 105 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 105 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&#x27;(.*?)\\\&#x27;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 108 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 108 +        scriptPattern = Pattern.compile(&quot;src[\r\n]*=[\r\n]*\\\&quot;(.*?)\\\&quot;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        // Remove any lonesome &lt;/script&gt; tag</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        scriptPattern = Pattern.compile(&quot;&lt;/script&gt;&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        // Remove any lonesome &lt;script ...&gt; tag</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 116 +        scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 116 +        scriptPattern = Pattern.compile(&quot;&lt;script(.*?)&gt;&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        // Avoid eval(...) expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 120 +        scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 120 +        scriptPattern = Pattern.compile(&quot;eval\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        // Avoid expression(...) expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 124 +        scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 124 +        scriptPattern = Pattern.compile(&quot;expression\\((.*?)\\)&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | PaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        // Avoid javascript:... expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        scriptPattern = Pattern.compile(&quot;javascript:&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        // Avoid vbscript:... expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        scriptPattern = Pattern.compile(&quot;vbscript:&quot;, Pattern.CASE_INSENSITIVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        // Avoid onload= expressions</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 136 +        scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);"> 136 +        scriptPattern = Pattern.compile(&quot;onload(.*?)=&quot;, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        value = scriptPattern.matcher(value).replaceAll(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        return value;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            