<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>211</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    211
                    <a href="210.html">prev</a>
                    <a href="212.html">next</a>
                    <a href="211_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_47fec386683d4f12911413ae693bacd60e1538d7_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a996923be2b09711d11d2a5df4df667dc9a00b19:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  30 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  31 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  32 import org.broadleafcommerce.common.util.BLCArrayUtils;
  33 import org.broadleafcommerce.common.util.BLCMessageUtils;
  34 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  35 import org.broadleafcommerce.common.web.JsonResponse;
  36 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  37 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  38 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  40 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  41 import org.broadleafcommerce.openadmin.dto.ClassTree;
  42 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  43 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  44 import org.broadleafcommerce.openadmin.dto.Entity;
  45 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  46 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  47 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  48 import org.broadleafcommerce.openadmin.dto.Property;
  49 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  52 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  53 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  54 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  55 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  56 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  57 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  59 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  59 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  60 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  61 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  62 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  63 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  64 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  65 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  66 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  67 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  68 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  69 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  70 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  71 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  72 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  73 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  74 import org.springframework.stereotype.Controller;
  75 import org.springframework.ui.Model;
  76 import org.springframework.util.MultiValueMap;
  77 import org.springframework.validation.BindingResult;
  78 import org.springframework.web.bind.WebDataBinder;
  79 import org.springframework.web.bind.annotation.InitBinder;
  80 import org.springframework.web.bind.annotation.ModelAttribute;
  81 import org.springframework.web.bind.annotation.PathVariable;
  82 import org.springframework.web.bind.annotation.RequestMapping;
  83 import org.springframework.web.bind.annotation.RequestMethod;
  84 import org.springframework.web.bind.annotation.RequestParam;
  85 import org.springframework.web.bind.annotation.ResponseBody;
  86 import org.springframework.web.servlet.DispatcherServlet;
  87 import org.springframework.web.servlet.FlashMap;
  88 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  89 import org.springframework.web.util.UrlPathHelper;
  90 import com.fasterxml.jackson.databind.ObjectMapper;
  91 
  92 import java.net.URLDecoder;
  93 import java.util.ArrayList;
  94 import java.util.Arrays;
  95 import java.util.HashMap;
  96 import java.util.List;
  97 import java.util.Map;
  98 import java.util.Map.Entry;
  99 import java.util.Set;
 100 import java.util.stream.Stream;
 101 
 102 import javax.annotation.Resource;
 103 import javax.servlet.http.HttpServletRequest;
 104 import javax.servlet.http.HttpServletResponse;
 105 
 106 /**
<abbr title=" 107  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 107  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates everðŸ”µ</abbr>
<abbr title=" 108  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 108  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for ðŸ”µ</abbr>
 109  * that is not explicitly customized by its own controller.
 110  *
 111  * @author Andre Azzolini (apazzolini)
 112  * @author Jeff Fischer
 113  */
 114 @Controller(&quot;blAdminBasicEntityController&quot;)
 115 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 116 public class AdminBasicEntityController extends AdminAbstractController {
 117 
 118     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 119 
 120     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 121     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 122     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 123 
 124     @Resource(name=&quot;blSandBoxHelper&quot;)
 125     protected SandBoxHelper sandBoxHelper;
 126 
 127     @Resource(name = &quot;blAdminUserDao&quot;)
 128     protected AdminUserDao adminUserDao;
 129 
 130     @Resource(name=&quot;blDynamicEntityDao&quot;)
 131     protected DynamicEntityDao dynamicEntityDao;
 132 
 133     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 134     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 135 
 136     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 137     protected RowLevelSecurityService rowLevelSecurityService;
 138 
 139     // ******************************************
 140     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 141     // ******************************************
 142 
 143     /**
<abbr title=" 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 145      * criteria.
 146      *
 147      * @param request
 148      * @param response
 149      * @param model
 150      * @param pathVars
 151      * @param requestParams a Map of property name -&gt; list critiera values
 152      * @return the return view path
 153      * @throws Exception
 154      */
 155     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 156     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 157             @PathVariable Map&lt;String, String&gt; pathVars,
 158             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 159         String sectionKey = getSectionKey(pathVars);
 160         String sectionClassName = getClassNameForSection(sectionKey);
 161         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 163         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 164         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 165 
 166         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 167         listGrid.setSelectType(ListGrid.SelectType.NONE);
 168 
 169         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 170         if (CollectionUtils.isNotEmpty(headerFields)) {
 171             Field firstField = headerFields.iterator().next();
 172             if (requestParams.containsKey(firstField.getName())) {
 173                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 174             }
 175         }
 176 
 177         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 178 
 179         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 180         model.addAttribute(&quot;listGrid&quot;, listGrid);
 181 
 182         return &quot;modules/defaultContainer&quot;;
 183     }
 184 
<abbr title=" 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 186             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 187         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 188         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 189         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 190         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 191 
 192         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 193         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 194             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 195         }
 196 
 197         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 198         String requestUri = request.getRequestURI();
 199         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 201         }
 202 
 203         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 204         model.addAttribute(&quot;currentUri&quot;, requestUri);
 205         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 206         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 207         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 208         model.addAttribute(&quot;mainActions&quot;, mainActions);
 209         setModelAttributes(model, sectionKey);
 210         setTypedEntityModelAttributes(request, model);
 211     }
 212 
 213     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 214     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 215              HttpServletResponse response, Model model,
 216              @PathVariable Map&lt;String, String&gt; pathVars,
 217              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 218         String sectionKey = getSectionKey(pathVars);
 219         String sectionClassName = getClassNameForSection(sectionKey);
 220         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 222                 .withCustomCriteria(getCustomCriteria(requestParams));
 223 
 224         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 225 
 226         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 227         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 228 
 229         return formService.constructSelectizeOptionMap(drs, cmd);
 230     }
 231 
 232     /**
 233      * Obtains the requested criteria parameter
 234      *
 235      * @param requestParams
 236      * @return
 237      */
 238     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 239         if (requestParams == null || requestParams.isEmpty()) {
 240             return null;
 241         }
 242 
 243         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 244         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 245         return new String[] {response};
 246     }
 247 
 248     /**
<abbr title=" 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 250      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 251      *
 252      * @param sectionClassName
 253      * @param cmd
 254      * @param mainActions
 255      */
<abbr title=" 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 257         if (isAddActionAllowed(sectionClassName, cmd)) {
 258             mainActions.add(DefaultMainActions.ADD);
 259         }
 260     }
 261 
 262     protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {
 263         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 264         boolean canCreate = true;
 265         try {
 266             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 267         } catch (ServiceException e) {
 268             if (e instanceof SecurityServiceException) {
 269                 canCreate = false;
 270             }
 271         }
 272 
 273         if (canCreate) {
 274             checkReadOnly: {
 275                 //check if all the metadata is read only
 276                 for (Property property : cmd.getProperties()) {
 277                     if (property.getMetadata() instanceof BasicFieldMetadata) {
 278                         if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 279                                 !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 280                             break checkReadOnly;
 281                         }
 282                     }
 283                 }
 284                 canCreate = false;
 285             }
 286         }
 287 
 288         if (canCreate) {
<abbr title=" 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(ðŸ”µ</abbr>
 290         }
 291 
 292         return canCreate;
 293     }
 294 
 295     /**
<abbr title=" 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 297      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 297      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 299      * they can then perform operations on sub collections.
 300      *
 301      * @param request
 302      * @param response
 303      * @param model
 304      * @param pathVars
 305      * @param entityType
 306      * @return the return view path
 307      * @throws Exception
 308      */
 309     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 311             @PathVariable  Map&lt;String, String&gt; pathVars,
 312             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 313         String sectionKey = getSectionKey(pathVars);
 314         String sectionClassName = getClassNameForSection(sectionKey);
 315         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 317         ppr.setAddOperationInspect(true);
 318         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 319 
<abbr title=" 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic typeðŸ”µ</abbr>
 321         if (StringUtils.isBlank(entityType)) {
 322             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 323                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 324             } else {
 325                 entityType = getDefaultEntityType();
 326             }
 327         } else {
 328             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 329         }
 330 
 331         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 332 
<abbr title=" 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 334         // is set to the type we&#x27;re going to be creating.
 335         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 336         entityForm.setEntityType(entityType);
 337 
<abbr title=" 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 340         // fields that are not applicable for this given entity type.
 341         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 342 
 343         modifyAddEntityForm(entityForm, pathVars);
 344 
 345         model.addAttribute(&quot;entityForm&quot;, entityForm);
 346         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 347 
 348         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 349         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 350         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 351         setModelAttributes(model, sectionKey);
 352         return &quot;modules/modalContainer&quot;;
 353     }
 354 
 355     /**
<abbr title=" 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 357      *
 358      * @param request
 359      * @param response
 360      * @param model
 361      * @param pathVars
 362      * @param entityForm
 363      * @param result
 364      * @return the return view path
 365      * @throws Exception
 366      */
 367     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 368     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 369             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 371         String sectionKey = getSectionKey(pathVars);
 372         String sectionClassName = getClassNameForSection(sectionKey);
 373         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 375 
 376         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 378         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 379         entityFormValidator.validate(entityForm, entity, result);
 380 
 381         if (result.hasErrors()) {
 382             entityForm.clearFieldsMap();
 383             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 384 
 385             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 386 
 387             modifyAddEntityForm(entityForm, pathVars);
 388 
 389             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 390             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 391             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 392             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 393             setModelAttributes(model, sectionKey);
 394             return &quot;modules/modalContainer&quot;;
 395         }
 396 
 397         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 399     }
 400 
 401     /**
 402      * Renders the main entity form for the specified entity
 403      *
 404      * @param request
 405      * @param response
 406      * @param model
 407      * @param pathVars
 408      * @param id
 409      * @return the return view path
 410      * @throws Exception
 411      */
 412     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 413     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 414             @PathVariable  Map&lt;String, String&gt; pathVars,
 415             @PathVariable(&quot;id&quot;) String id) throws Exception {
 416         String sectionKey = getSectionKey(pathVars);
 417         String sectionClassName = getClassNameForSection(sectionKey);
 418         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 420 
 421         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 422         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 423 
<abbr title=" 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 425 
 426         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 427 
 428         if (isAddRequest(entity)) {
 429             modifyAddEntityForm(entityForm, pathVars);
 430         } else {
 431             modifyEntityForm(entityForm, pathVars);
 432         }
 433 
 434         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 435             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 436         }
 437 
 438         // Set the sectionKey again incase this is a typed entity
 439         entityForm.setSectionKey(sectionKey);
 440 
 441         // Build the current url in the cast that this is a typed entity
 442         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 443         int startIndex = request.getContextPath().length();
 444 
 445         // Remove the context path from servlet path
 446         String currentUrl = originatingUri.substring(startIndex);
 447 
 448         model.addAttribute(&quot;entity&quot;, entity);
 449         model.addAttribute(&quot;entityForm&quot;, entityForm);
 450         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 451 
 452         setModelAttributes(model, sectionKey);
 453 
 454         // We want to replace author ids with their names
 455         addAuditableDisplayFields(entityForm);
 456 
 457         if (isAjaxRequest(request)) {
 458             entityForm.setReadOnly();
 459             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 460             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 461             return &quot;modules/modalContainer&quot;;
 462         } else {
 463             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 464             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 465             return &quot;modules/defaultContainer&quot;;
 466         }
 467     }
 468 
<abbr title=" 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 470                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 471                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 471                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 472         String tabName = pathVars.get(&quot;tabName&quot;);
 473         if (StringUtils.isEmpty(tabName)) {
 474             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 475         }
 476         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 477     }
 478 
 479     private boolean isAddRequest(Entity entity) {
 480         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 482         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 483             return false;
 484         }
 485 
 486         return resultHolder.getResult();
 487     }
 488 
 489     /**
 490      * Attempts to get the List Grid for the selected tab.
 491      *
 492      * @param request
 493      * @param response
 494      * @param model
 495      * @param pathVars
 496      * @param id
 497      * @param tabName
 498      * @param entityForm
 499      * @param entity
 500      * @return the return view path
 501      * @throws Exception
 502      */
 503     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 504     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 505             @PathVariable Map&lt;String, String&gt; pathVars,
 506             @PathVariable(value = &quot;id&quot;) String id,
 507             @PathVariable(value = &quot;tabName&quot;) String tabName,
 508             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 509             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 510         String sectionKey = getSectionKey(pathVars);
 511         String sectionClassName = getClassNameForSection(sectionKey);
 512         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 514         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 515         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 517         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 518 
 519         if (isAddRequest(entity)) {
 520             modifyAddEntityForm(entityForm, pathVars);
 521         } else {
 522             modifyEntityForm(entityForm, pathVars);
 523         }
 524 
 525         model.addAttribute(&quot;entity&quot;, entity);
 526         model.addAttribute(&quot;entityForm&quot;, entityForm);
 527         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 528 
 529         setModelAttributes(model, sectionKey);
 530 
 531         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 532         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 533         return &quot;modules/defaultContainer&quot;;
 534     }
 535 
 536     /**
 537      * Builds JSON that looks like this:
 538      *
 539      * {&quot;errors&quot;:
 540      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 541      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 542      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 543      *        &quot;errorType&quot;, &quot;field&quot;,
 544      *        &quot;tab&quot;: &quot;General&quot;
 545      *        },
 546      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 547      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 548      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 549      *        &quot;errorType&quot;, &quot;field&quot;,
 550      *        &quot;tab&quot;: &quot;General&quot;
 551      *        }]
 552      * }
 553      *
 554      */
 555     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 556     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 557             @PathVariable Map&lt;String, String&gt; pathVars,
 558             @PathVariable(value = &quot;id&quot;) String id,
 559             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 560             RedirectAttributes ra) throws Exception {
 561 
 562         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 563 
 564         JsonResponse json = new JsonResponse(response);
 565         if (result.hasErrors()) {
 566             populateJsonValidationErrors(entityForm, result, json);
 567         }
 568         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 569         if (CollectionUtils.isNotEmpty(dirtyList)) {
 570             json.with(&quot;dirty&quot;, dirtyList);
 571         }
 572 
 573         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 575         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 576             return resultHolder.getResult();
 577         }
 578 
 579         return json.done();
 580     }
 581 
<abbr title=" 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 583         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 584         String sectionKey = getSectionKey(pathVars);
 585         String sectionClassName = getClassNameForSection(sectionKey);
 586         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 588         ClassMetadata cmd = null;
 589         Entity entity = null;
 590         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 591         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 592 
 593         for (Property p: entity.getProperties()) {
 594             if (p.getIsDirty()) {
 595                 dirtyList.add(p.getName());
 596             }
 597         }
 598         return dirtyList;
 599     }
 600 
 601     /**
<abbr title=" 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 603      * error fields highlighted. On a successful save, it will refresh the entity page.
 604      *
 605      * @param request
 606      * @param response
 607      * @param model
 608      * @param pathVars
 609      * @param id
 610      * @param entityForm
 611      * @param result
 612      * @return the return view path
 613      * @throws Exception
 614      */
 615     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 616     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 617             @PathVariable  Map&lt;String, String&gt; pathVars,
 618             @PathVariable(value=&quot;id&quot;) String id,
 619             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620             RedirectAttributes ra) throws Exception {
 621         String sectionKey = getSectionKey(pathVars);
 622         String sectionClassName = getClassNameForSection(sectionKey);
 623         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 625         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 626 
 627         extractDynamicFormFields(cmd, entityForm);
 628 
<abbr title=" 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 630         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 631 
 632         entityFormValidator.validate(entityForm, entity, result);
 633         if (result.hasErrors()) {
 634             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 635             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 636 
<abbr title=" 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 638             entityForm.clearFieldsMap();
 639             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 640 
 641             if (isAddRequest(entity)) {
 642                 modifyAddEntityForm(entityForm, pathVars);
 643             } else {
 644                 modifyEntityForm(entityForm, pathVars);
 645             }
 646 
 647             model.addAttribute(&quot;entity&quot;, entity);
 648             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 649 
 650             setModelAttributes(model, sectionKey);
 651 
 652             if (isAjaxRequest(request)) {
 653                 entityForm.setReadOnly();
 654                 model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 655                 model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 656                 return &quot;modules/modalContainer&quot;;
 657             } else {
 658                 model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 659                 model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 660                 return &quot;modules/defaultContainer&quot;;
 661             }
 662         }
 663 
 664         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 665 
 666         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 667     }
 668 
 669     /**
 670      * Attempts to remove the given entity.
 671      *
 672      * @param request
 673      * @param response
 674      * @param model
 675      * @param pathVars
 676      * @param id
 677      * @return the return view path
 678      * @throws Exception
 679      */
 680     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 681     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 682             @PathVariable  Map&lt;String, String&gt; pathVars,
 683             @PathVariable(value=&quot;id&quot;) String id,
 684             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685             RedirectAttributes ra) throws Exception {
 686         String sectionKey = getSectionKey(pathVars);
 687         String sectionClassName = getClassNameForSection(sectionKey);
 688         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 689 
<abbr title=" 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 691         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 692         // Removal does not normally return an Entity unless there is some validation error
 693         if (entity != null) {
 694             entityFormValidator.validate(entityForm, entity, result);
 695             if (result.hasErrors()) {
 696                 // Create a flash attribute for the unsuccessful delete
 697                 FlashMap fm = new FlashMap();
 698                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 699                 fm.put(&quot;headerFlashAlert&quot;, true);
 700                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 701 
 702                 // Re-look back up the entity so that we can return something populated
<abbr title=" 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 705                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 707                 entityForm.clearFieldsMap();
 708                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 709                 modifyEntityForm(entityForm, pathVars);
 710 
 711                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 712                         .done();
 713             }
 714         }
 715 
 716         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 717         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 718 
 719         if (isAjaxRequest(request)) {
 720             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 722         } else {
 723             return &quot;redirect:/&quot; + sectionKey;
 724         }
 725     }
 726 
 727     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 729             @PathVariable  Map&lt;String, String&gt; pathVars,
 730             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 731             @RequestParam String ids,
 732             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 733         String sectionKey = getSectionKey(pathVars);
 734         String sectionClassName = getClassNameForSection(sectionKey);
 735         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 738         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 739         FieldMetadata md = collectionProperty.getMetadata();
 740 
 741         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 742         ppr.setStartIndex(getStartIndex(requestParams));
 743         ppr.setMaxIndex(getMaxIndex(requestParams));
 744 
 745         if (md instanceof BasicFieldMetadata) {
 746             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 747             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 748 
 749             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 750             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 751 
 752             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 753             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 754 
 755             for (Entity e : drs.getRecords()) {
 756                 String id = e.getPMap().get(idProp).getValue();
 757                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 758 
 759                 if (StringUtils.isBlank(disp)) {
 760                     disp = e.getPMap().get(displayProp).getValue();
 761                 }
 762 
 763                 returnMap.put(id,  disp);
 764             }
 765 
 766             return returnMap;
 767         }
 768 
 769         return null;
 770     }
 771 
 772     /**
<abbr title=" 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 774      * then this method is invoked when a user clicks on the name of the default category field.
 775      *
 776      * @param request
 777      * @param response
 778      * @param model
 779      * @param pathVars
 780      * @param collectionField
 781      * @param id
 782      * @return
 783      * @throws Exception
 784      */
 785     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 787             @PathVariable  Map&lt;String, String&gt; pathVars,
 788             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 789             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 790         String sectionKey = getSectionKey(pathVars);
 791         String mainClassName = getClassNameForSection(sectionKey);
 792         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 794         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 795         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 796 
<abbr title=" 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 799         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 800         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 801         return viewEntityForm(request, response, model, varsForField, id);
 802     }
 803 
 804     @RequestMapping(
 805             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 806             method = RequestMethod.POST
 807     )
<abbr title=" 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 809                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 810                                         @PathVariable(value=&quot;id&quot;) String id,
 811                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 812                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 813                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 815 
<abbr title=" 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 817     }
 818 
 819 
 820     @RequestMapping(
 821             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 822             method = RequestMethod.POST
 823     )
<abbr title=" 824     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 824     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
 825                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 826                                         @PathVariable(value=&quot;id&quot;) String id,
 827                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 828                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 829                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 830                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 830                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 831 
<abbr title=" 832         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 832         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 833     }
 834 
 835 
 836     /**
 837      * Returns the records for a given collectionField filtered by a particular criteria
 838      *
 839      * @param request
 840      * @param response
 841      * @param model
 842      * @param pathVars
 843      * @param collectionField
 844      * @param requestParams
 845      * @return the return view path
 846      * @throws Exception
 847      */
 848     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 849     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 849     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 850             @PathVariable  Map&lt;String, String&gt; pathVars,
 851             @PathVariable(value=&quot;id&quot;) String id,
 852             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 853             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 854         String sectionKey = getSectionKey(pathVars);
 855         String mainClassName = getClassNameForSection(sectionKey);
 856         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 857         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 857         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 858         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 858         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 859         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 860 
 861         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 862         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 862         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 863 
 864         // Next, we must get the new list grid that represents this collection
<abbr title=" 865         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 865         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 866         model.addAttribute(&quot;listGrid&quot;, listGrid);
 867 
 868         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 869 
 870         // We return the new list grid so that it can replace the currently visible one
 871         setModelAttributes(model, sectionKey);
 872         return &quot;views/standaloneListGrid&quot;;
 873     }
 874 
 875     /**
<abbr title=" 876      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 876      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 877      * of this call depending on the type of the specified collection field.
 878      *
 879      * &lt;ul&gt;
 880      *  &lt;li&gt;
<abbr title=" 881      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 881      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 882      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 882      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 883      *  &lt;/li&gt;
 884      *  &lt;li&gt;
<abbr title=" 885      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 885      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 886      *    Used by fields such as &quot;allParentCategories&quot;.
 887      *  &lt;/li&gt;
 888      *  &lt;li&gt;
<abbr title=" 889      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 889      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 890      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 890      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 891      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 891      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 892      *  &lt;/li&gt;
 893      *  &lt;li&gt;
<abbr title=" 894      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 894      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 895      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 895      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 896      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 896      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 897      *    to linking an entity, provide extra fields, such as a promotional message.
 898      *  &lt;/li&gt;
 899      *  &lt;li&gt;
<abbr title=" 900      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 900      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 901      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 901      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 902      *    entity. Used by fields such as the mediaMap on a Sku.
 903      *  &lt;/li&gt;
 904      *
 905      * @param request
 906      * @param response
 907      * @param model
 908      * @param pathVars
 909      * @param id
 910      * @param collectionField
 911      * @param requestParams
 912      * @return the return view path
 913      * @throws Exception
 914      */
 915     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 916     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 916     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 917             @PathVariable Map&lt;String, String&gt; pathVars,
 918             @PathVariable(value = &quot;id&quot;) String id,
 919             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 920             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 921         String sectionKey = getSectionKey(pathVars);
 922         String mainClassName = getClassNameForSection(sectionKey);
 923         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 924         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 924         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 925                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 926         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 927         FieldMetadata md = collectionProperty.getMetadata();
 928 
 929         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 930                 .withFilterAndSortCriteria(getCriteria(requestParams))
 931                 .withStartIndex(getStartIndex(requestParams))
 932                 .withMaxIndex(getMaxIndex(requestParams))
 933                 .withLastId(getLastId(requestParams))
 934                 .withFirstId(getFirstId(requestParams))
 935                 .withUpperCount(getUpperCount(requestParams))
 936                 .withLowerCount(getLowerCount(requestParams))
 937                 .withPageSize(getPageSize(requestParams))
 938                 .withPresentationFetch(true);
 939 
 940         if (md instanceof BasicCollectionMetadata) {
 941             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 942             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 943                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 943                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title=" 944                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types"> 944                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
 945                 // for this entity.
 946                 String entityType = null;
 947                 if (requestParams.containsKey(&quot;entityType&quot;)) {
 948                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
 949                 }
 950                 if (StringUtils.isBlank(entityType)) {
 951                     if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 952                         entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 953                     } else {
 954                         entityType = getDefaultEntityType();
 955                     }
 956                 } else {
 957                     entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 958                 }
 959 
 960                 if (StringUtils.isBlank(entityType)) {
 961                     List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 962                     model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 963                     model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
<abbr title=" 964                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());"> 964                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyNameðŸ”µ</abbr>
 965                     String requestUri = request.getRequestURI();
<abbr title=" 966                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 966                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextðŸ”µ</abbr>
<abbr title=" 967                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 967                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUðŸ”µ</abbr>
 968                     }
 969                     model.addAttribute(&quot;currentUri&quot;, requestUri);
 970                     model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 971                     setModelAttributes(model, sectionKey);
 972                     return &quot;modules/modalContainer&quot;;
 973                 } else {
 974                     ppr = ppr.withCeilingEntityClassname(entityType);
 975                 }
 976             }
 977         } else if (md instanceof MapMetadata) {
<abbr title=" 978             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 978             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
 979             if (result.equals(ExtensionResultStatusType.HANDLED)) {
 980                 model.addAttribute(&quot;entityId&quot;, id);
 981                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 982                 model.addAttribute(&quot;collectionField&quot;, collectionField);
 983                 return &quot;modules/modalContainer&quot;;
 984             }
 985         }
 986 
 987         //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);
 988 
 989         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 990 
<abbr title=" 991         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 991         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
 992     }
 993 
<abbr title=" 994     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 994     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title=" 995     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 995     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
 996             @PathVariable Map&lt;String, String&gt; pathVars,
 997             @PathVariable(value=&quot;id&quot;) String id,
 998             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 999             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1000         String sectionKey = getSectionKey(pathVars);
1001         String mainClassName = getClassNameForSection(sectionKey);
1002         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1004         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1005         FieldMetadata md = collectionProperty.getMetadata();
1006         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1007         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1008             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1008             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1009                     collectionField,
1010                     collectionItemId, responseMap);
1011         }
1012         return responseMap;
1013     }
1014 
1015     /**
1016      *
1017      * @param request
1018      * @param response
1019      * @param model
1020      * @param pathVars
1021      * @param id
1022      * @param collectionField
1023      * @param requestParams
1024      * @return Json collection data
1025      * @throws Exception
1026      */
1027     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1028     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1028     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1029             @PathVariable Map&lt;String, String&gt; pathVars,
1030             @PathVariable(value = &quot;id&quot;) String id,
1031             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1032             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1033         String sectionKey = getSectionKey(pathVars);
1034         String mainClassName = getClassNameForSection(sectionKey);
1035         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1036         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1036         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1037                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1038         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1039         FieldMetadata md = collectionProperty.getMetadata();
1040 
1041         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1042                 .withFilterAndSortCriteria(getCriteria(requestParams))
1043                 .withStartIndex(getStartIndex(requestParams))
1044                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1045         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1045         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1046                 .toArray(String[]::new);
1047         ppr = ppr.withCustomCriteria( both);
1048 
1049         if (md instanceof AdornedTargetCollectionMetadata) {
1050             ppr.setOperationTypesOverride(null);
1051             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1052             ppr.setSectionEntityField(collectionField);
1053         }
1054 
1055         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1056 
<abbr title="1057         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1057         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1058     }
1059 
1060     protected String[] buildSelectizeCustomCriteria() {
1061         return new String[]{ IS_SELECTIZE_REQUEST };
1062     }
1063 
1064     /**
1065      * Adds the requested collection item via Selectize
1066      *
1067      * @param request
1068      * @param response
1069      * @param model
1070      * @param pathVars
1071      * @param id
1072      * @param collectionField
1073      * @param entityForm
1074      * @return the return view path
1075      * @throws Exception
1076      */
1077     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1078     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1078     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1079             @PathVariable Map&lt;String, String&gt; pathVars,
1080             @PathVariable(value=&quot;id&quot;) String id,
1081             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1082             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1082             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1083         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1084         String sectionKey = getSectionKey(pathVars);
1085         String mainClassName = getClassNameForSection(sectionKey);
1086         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1087         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1087         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1088         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1089 
1090         if (StringUtils.isBlank(entityForm.getEntityType())) {
1091             FieldMetadata fmd = collectionProperty.getMetadata();
1092             if (fmd instanceof BasicCollectionMetadata) {
1093                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1094             }
1095         }
1096 
<abbr title="1097         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1097         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1098         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1099         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1100         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1100         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1101 
1102         // First, we must save the collection entity
<abbr title="1103         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1103         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1104         Entity savedEntity = persistenceResponse.getEntity();
1105         entityFormValidator.validate(entityForm, savedEntity, result);
1106 
1107         if (result.hasErrors()) {
1108             returnVal.put(&quot;error&quot;, result.getFieldError());
1109             return returnVal;
1110         }
1111 
1112         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1113             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1114         }
1115         return returnVal;
1116     }
1117 
1118     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1119         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1119         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1120         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1121     }
1122 
1123     /**
1124      * Adds the requested collection item
1125      *
1126      * @param request
1127      * @param response
1128      * @param model
1129      * @param pathVars
1130      * @param id
1131      * @param collectionField
1132      * @param entityForm
1133      * @return the return view path
1134      * @throws Exception
1135      */
1136     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1137     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1137     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1138             @PathVariable Map&lt;String, String&gt; pathVars,
1139             @PathVariable(value=&quot;id&quot;) String id,
1140             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1141             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1141             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1142         String sectionKey = getSectionKey(pathVars);
1143         String mainClassName = getClassNameForSection(sectionKey);
1144         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1146         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1147 
1148         if (StringUtils.isBlank(entityForm.getEntityType())) {
1149             FieldMetadata fmd = collectionProperty.getMetadata();
1150             if (fmd instanceof BasicCollectionMetadata) {
1151                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1152             }
1153         }
1154 
<abbr title="1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1156         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1157         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1157         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1158         service.clearEntityManager();
1159         // First, we must save the collection entity
<abbr title="1160         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1160         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1161         Entity savedEntity = persistenceResponse.getEntity();
1162         entityFormValidator.validate(entityForm, savedEntity, result);
1163 
1164         if (result.hasErrors()) {
1165             FieldMetadata md = collectionProperty.getMetadata();
1166             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1167             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1167             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1168                     md, ppr, entityForm, savedEntity);
1169         }
1170 
1171         // Next, we must get the new list grid that represents this collection
<abbr title="1172         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1172         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1173         model.addAttribute(&quot;listGrid&quot;, listGrid);
1174 
1175         // We return the new list grid so that it can replace the currently visible one
1176         model.addAttribute(&quot;actualEntityId&quot;, id);
1177         setModelAttributes(model, sectionKey);
1178         return &quot;views/standaloneListGrid&quot;;
1179     }
1180 
1181     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1182     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1182     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1183             @PathVariable Map&lt;String, String&gt; pathVars,
1184             @PathVariable(value=&quot;id&quot;) String id,
1185             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1186             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1186             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1187         String sectionKey = getSectionKey(pathVars);
1188         String mainClassName = getClassNameForSection(sectionKey);
1189         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1190         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1190         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1191         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1192 
1193         if (StringUtils.isBlank(entityForm.getEntityType())) {
1194             FieldMetadata fmd = collectionProperty.getMetadata();
1195             if (fmd instanceof BasicCollectionMetadata) {
1196                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1197             }
1198         }
1199 
<abbr title="1200         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1200         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1201         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1201         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1202         entity.setIsPreAdd(true);
1203         // First, we must save the collection entity
<abbr title="1204         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1204         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1205         Entity savedEntity = persistenceResponse.getEntity();
1206 
1207         return new JsonResponse(response)
1208                 .with(&quot;status&quot;, &quot;complete&quot;)
1209                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1210                 .done();
1211     }
1212 
1213     /**
<abbr title="1214      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1214      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1215      * as well as after a POST with validation errors
1216      *
1217      * @param request
1218      * @param model
1219      * @param id
1220      * @param collectionField
1221      * @param sectionKey
1222      * @param collectionProperty
1223      * @param md
1224      * @param ppr
1225      * @return the appropriate view to display for the modal
<abbr title="1226      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1226      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1227      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1227      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1228      * @throws ServiceException
1229      */
<abbr title="1230     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1230     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1231             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1231             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1232             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1232             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1233 
<abbr title="1234         // For requests to add a new collection item include the main class that the subsequent request comes from.">1234         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1235         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1235         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1236         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1236         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1237         // fixes all cases.
1238         String mainClassName = getClassNameForSection(sectionKey);
1239         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1240         ppr.setAddOperationInspect(true);
1241 
1242         if (entityForm != null) {
1243             entityForm.clearFieldsMap();
1244         }
1245         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1246         if (md instanceof BasicCollectionMetadata) {
1247             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1248 
<abbr title="1249             // When adding items to basic collections, we will sometimes show a form to persist a new record">1249             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1250             // and sometimes show a list grid to allow the user to associate an existing record.
1251             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1252                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1252                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1253                 if (entityForm == null) {
1254                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1255                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1256                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1257                 } else {
1258                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1259                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1260                 }
<abbr title="1261                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1261                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1262                 entityForm.getTabs().iterator().next().getIsVisible();
1263 
1264                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1265                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1266             } else {
1267                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1268                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1268                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1269                 listGrid.setPathOverride(request.getRequestURL().toString());
1270 
<abbr title="1271                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1271                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1272                     listGrid.removeAllRowActions();
1273                 }
1274 
1275                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1276                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1277             }
1278         } else if (md instanceof AdornedTargetCollectionMetadata) {
1279             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1280 
<abbr title="1281             // Even though this field represents an adorned target collection, the list we want to show in the modal">1281             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1282             // is the standard list grid for the target entity of this field
1283             ppr.setOperationTypesOverride(null);
1284             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1285             ppr.setSectionEntityField(collectionField);
1286 
<abbr title="1287             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1287             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1288 
1289             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1290             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1290             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1291             listGrid.setSubCollectionFieldName(collectionField);
1292             listGrid.setPathOverride(request.getRequestURL().toString());
1293             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1294             if (entityForm == null) {
<abbr title="1295                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1295                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1296                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1296                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1297             } else {
<abbr title="1298                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1298                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1299                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1300             }
1301 
1302             listGrid.setListGridType(ListGrid.Type.ADORNED);
1303             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1304                 if (entry.getValue().getIsVisible()) {
1305                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1306                     break;
1307                 }
1308             }
1309 
1310             // This is part of an add, so we want to be able to filter/sort the listgrid
1311             listGrid.setIsSortable(false);
1312             listGrid.setCanFilterAndSort(true);
1313             listGrid.removeAllRowActions();
1314 
1315             model.addAttribute(&quot;listGrid&quot;, listGrid);
1316             model.addAttribute(&quot;entityForm&quot;, entityForm);
1317             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1318         } else if (md instanceof MapMetadata) {
1319             MapMetadata fmd = (MapMetadata) md;
<abbr title="1320             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1320             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1321 
1322             if (entityForm == null) {
<abbr title="1323                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1323                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1324             } else {
1325                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1326                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1327             }
1328             model.addAttribute(&quot;entityForm&quot;, entityForm);
1329             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1330         }
1331 
1332         // Set the parent id on the entity form
1333         if (entityForm != null) {
1334             entityForm.setParentId(id);
1335         }
1336 
1337         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1338         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1339         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1340         setModelAttributes(model, sectionKey);
1341         return &quot;modules/modalContainer&quot;;
1342     }
1343 
1344     /**
1345      * Shows the appropriate modal dialog to edit the selected collection item
1346      *
1347      * @param request
1348      * @param response
1349      * @param model
1350      * @param pathVars
1351      * @param id
1352      * @param collectionField
1353      * @param collectionItemId
1354      * @return the return view path
1355      * @throws Exception
1356      */
<abbr title="1357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1358     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1358     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1359             @PathVariable  Map&lt;String, String&gt; pathVars,
1360             @PathVariable(value=&quot;id&quot;) String id,
1361             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1362             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1363             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1365                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1366     }
1367 
1368     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1369     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1369     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1370             @PathVariable  Map&lt;String, String&gt; pathVars,
1371             @PathVariable(value=&quot;id&quot;) String id,
1372             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1373             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1374         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1374         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1375                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1376     }
1377 
1378     /**
<abbr title="1379      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1379      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1380      *
1381      * @param request
1382      * @param response
1383      * @param model
1384      * @param pathVars
1385      * @param id
1386      * @param collectionField
1387      * @param collectionItemId
1388      * @return the return view path
1389      * @throws Exception
1390      */
<abbr title="1391     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1391     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1392     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1392     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1393             @PathVariable  Map&lt;String, String&gt; pathVars,
1394             @PathVariable(value=&quot;id&quot;) String id,
1395             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1396             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1397             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1398         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1398         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1399                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1400 
1401         // Since this is a read-only view, actions don&#x27;t make sense in this context
1402         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1403         addAuditableDisplayFields(ef);
1404         ef.removeAllActions();
1405         ef.setReadOnly();
1406 
1407         return returnPath;
1408     }
1409 
<abbr title="1410     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1410     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1411     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1411     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1412             @PathVariable  Map&lt;String, String&gt; pathVars,
1413             @PathVariable(value=&quot;id&quot;) String id,
1414             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1415             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1416         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1416         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1417                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1418 
1419         // Since this is a read-only view, actions don&#x27;t make sense in this context
1420         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1421         ef.removeAllActions();
1422         ef.setReadOnly();
1423 
1424         return returnPath;
1425     }
1426 
<abbr title="1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1428             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1428             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1430     }
1431 
<abbr title="1432     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1432     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1433             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1433             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1434         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1434         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1435     }
1436 
<abbr title="1437     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1437     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1438                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1438                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1440     }
1441 
1442     /**
<abbr title="1443      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1443      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1444      * which are optional. If they are not passed in then they are automatically looked up
1445      *
1446      * @param request
1447      * @param model
1448      * @param pathVars
1449      * @param id
1450      * @param collectionField
1451      * @param collectionItemId
1452      * @param modalHeaderType
1453      * @param entityForm
1454      * @param entity
1455      * @return
1456      * @throws ServiceException
1457      */
<abbr title="1458     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1458     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1459             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1459             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
1460         String sectionKey = getSectionKey(pathVars);
1461         String mainClassName = getClassNameForSection(sectionKey);
1462         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1463         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1463         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1464         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1465         FieldMetadata md = collectionProperty.getMetadata();
1466         SectionCrumb nextCrumb = new SectionCrumb();
1467         if (md instanceof MapMetadata) {
1468             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1469         } else {
1470             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1471         }
1472         nextCrumb.setSectionId(collectionItemId);
1473         if (!sectionCrumbs.contains(nextCrumb)) {
1474             sectionCrumbs.add(nextCrumb);
1475         }
1476 
<abbr title="1477         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1477         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1478         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1478         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1479 
1480         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1481 
1482         if (md instanceof BasicCollectionMetadata &amp;&amp;
1483                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1484                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1484                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1485             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1486 
<abbr title="1487             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1487             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1488             if (entity == null) {
<abbr title="1489                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1489                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1490             }
1491 
1492             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1493             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1493             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1494             if (entityForm == null) {
<abbr title="1495                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1495                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectðŸ”µ</abbr>
1496             } else {
1497                 entityForm.clearFieldsMap();
<abbr title="1498                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1498                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, secðŸ”µ</abbr>
1499                 //remove all the actions since we&#x27;re not trying to redisplay them on the form
1500                 entityForm.removeAllActions();
1501             }
1502             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1503             addAuditableDisplayFields(entityForm);
1504             model.addAttribute(&quot;entityForm&quot;, entityForm);
1505             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1506         } else if (md instanceof AdornedTargetCollectionMetadata) {
1507             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1508 
1509             if (entity == null) {
<abbr title="1510                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1510                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1511                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1512             }
1513 
1514             boolean populateTypeAndId = true;
<abbr title="1515             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1515             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1516             if (entityForm == null) {
<abbr title="1517                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1517                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1518                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1519                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1520             } else {
1521                 entityForm.clearFieldsMap();
1522                 String entityType = entityForm.getEntityType();
<abbr title="1523                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1523                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1524                 entityForm.setEntityType(entityType);
1525                 populateTypeAndId = false;
1526             }
1527 
1528             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1529             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1529             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1530                     collectionField,
1531                     collectionItemId, responseMap);
1532 
<abbr title="1533             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1533             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1534             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1534             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1535             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1536             entityForm.setTranslationId(alternateId);
1537 
1538             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1539             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1540                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1541                     continue;
1542                 }
1543                 Property p = cmd.getPMap().get(field);
1544                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1545                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1545                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1546                     // directly on the first adorned target collection. Because of this, we need the actual id property">1546                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1547                     // from the entity that models the adorned target relationship, and not the id of the target object.">1547                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1548                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1548                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1549                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1549                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1550                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1551 
<abbr title="1552                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1552                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1553                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1554                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1555 
1556                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1557                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1557                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1558                     } else {
<abbr title="1559                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1559                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1560                     }
1561                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1562                     // See above comment for AdornedTargetCollectionMetadata
1563                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1564 
<abbr title="1565                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1565                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1566                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1566                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1567                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1568 
<abbr title="1569                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1569                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1570                             mmd.getTargetClass(), sectionCrumbs);
1571                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1572 
1573                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1574                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1574                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1575                     } else {
<abbr title="1576                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1576                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1577                     }
1578                 }
1579             }
1580 
<abbr title="1581             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1581             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1582             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1583 
1584             boolean atLeastOneBasicField = false;
1585             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1586                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1586                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1587                     atLeastOneBasicField = true;
1588                     break;
1589                 }
1590             }
1591             if (!atLeastOneBasicField) {
1592                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1593             }
1594             addAuditableDisplayFields(entityForm);
1595             model.addAttribute(&quot;entityForm&quot;, entityForm);
1596             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1597         } else if (md instanceof MapMetadata) {
1598             MapMetadata fmd = (MapMetadata) md;
1599 
<abbr title="1600             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1600             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1601             if (entity == null) {
<abbr title="1602                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1602                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1603                     collectionItemId, sectionCrumbs, null).getEntity();
1604             }
1605 
1606             boolean populateTypeAndId = true;
1607             if (entityForm == null) {
<abbr title="1608                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1608                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1609             } else {
1610                 //save off the prior key before clearing out the fields map as it will not appear
1611                 //back on the saved entity
1612                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1613                 entityForm.clearFieldsMap();
1614                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1615                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1616                 populateTypeAndId = false;
1617             }
1618 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1619 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1620             //For MappedCollections, we need to be specific on what ceilingEntity and translationId is used.">1620             //For MappedCollections, we need to be specific on what ceilingEntity and translationId is usðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1621             //It should be the entity and referenced Id of the value entity (not the target entity and Id).">1621             //It should be the entity and referenced Id of the value entity (not the target entity and IdðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1622             if (entityForm.getCeilingEntityClassname() == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1623                 entityForm.setCeilingEntityClassname(fmd.getValueClassName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1624             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1625             entityForm.setTranslationId(collectionItemId);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1626             </span>
1627 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1628             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1629         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1630 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1631         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1632         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1633         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1634         setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1635         return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1636     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1637 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1638     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1639      * Updates the specified collection item</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1640      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1641      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1642      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1643      * @param model</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1644      * @param pathVars</span>
1645 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1646             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1647                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1647                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1648             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1649                 LOG.error(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1650             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1651             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValue());">1651             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValueðŸ”µ</abbr></span>
1652 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
<abbr title="1653             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1653             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1654             formService.populateMapEntityFormFields(entityForm, entity);
1655             addAuditableDisplayFields(entityForm);
1656             model.addAttribute(&quot;entityForm&quot;, entityForm);
1657             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1658         }
1659 
1660         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1661         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1662         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1663         setModelAttributes(model, sectionKey);
1664         return &quot;modules/modalContainer&quot;;
1665     }
1666 
1667     /**
1668      * Updates the specified collection item
1669      *
1670      * @param request
1671      * @param response
1672      * @param model
1673      * @param pathVars
1674      * @param id
1675      * @param collectionField
<abbr title="1676      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1676      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1677      * @param entityForm
1678      * @param result
1679      * @return the return view path
1680      * @throws Exception
1681      */
1682     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1683     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1683     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1684             @PathVariable  Map&lt;String, String&gt; pathVars,
1685             @PathVariable(value=&quot;id&quot;) String id,
1686             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1687             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1688             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1689             BindingResult result) throws Exception {
<abbr title="1690         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1690         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1691     }
1692 
1693     /**
1694      * Updates the specified collection item
1695      *
1696      * @param request
1697      * @param response
1698      * @param model
1699      * @param pathVars
1700      * @param id
1701      * @param collectionField
<abbr title="1702      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1702      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1703      * @param entityForm
<abbr title="1704      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1704      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1705      * @param result
1706      * @return the return view path
1707      * @throws Exception
1708      */
<abbr title="1709     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1709     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1710     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1710     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1711             @PathVariable  Map&lt;String, String&gt; pathVars,
1712             @PathVariable(value=&quot;id&quot;) String id,
1713             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1714             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1715             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1716             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1717             BindingResult result) throws Exception {
1718         String sectionKey = getSectionKey(pathVars);
1719         String mainClassName = getClassNameForSection(sectionKey);
1720         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1721         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1721         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1722         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1723 
<abbr title="1724         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1724         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1725         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1725         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1726         service.clearEntityManager();
1727         // First, we must save the collection entity
<abbr title="1728         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1728         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1729         Entity savedEntity = persistenceResponse.getEntity();
1730         entityFormValidator.validate(entityForm, savedEntity, result);
1731 
1732         if (result.hasErrors()) {
<abbr title="1733             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1733             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1734                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1735         }
1736 
1737         // Next, we must get the new list grid that represents this collection
1738         // We return the new list grid so that it can replace the currently visible one
<abbr title="1739         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1739         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1740 
1741         model.addAttribute(&quot;listGrid&quot;, listGrid);
1742         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1743         setModelAttributes(model, sectionKey);
1744         return &quot;views/standaloneListGrid&quot;;
1745     }
1746 
<abbr title="1747     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1747     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1748     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1749             HttpServletResponse response, Model model,
1750             @PathVariable  Map&lt;String, String&gt; pathVars,
1751             @PathVariable(value=&quot;id&quot;) String id,
1752             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1753             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1754             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1755         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1755         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1756     }
1757 
1758     /**
<abbr title="1759      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1759      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1760      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1760      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1761      *
1762      * @param request
1763      * @param response
1764      * @param model
1765      * @param pathVars
1766      * @param id
1767      * @param collectionField
1768      * @param collectionItemId
1769      * @return an object explaining the state of the operation
1770      * @throws Exception
1771      */
<abbr title="1772     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1772     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1773     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1774             HttpServletResponse response, Model model,
1775             @PathVariable  Map&lt;String, String&gt; pathVars,
1776             @PathVariable(value=&quot;id&quot;) String id,
1777             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1778             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1779             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1780             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1781         String sectionKey = getSectionKey(pathVars);
1782         String mainClassName = getClassNameForSection(sectionKey);
1783         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1784         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1784         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1785         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1786         FieldMetadata md = collectionProperty.getMetadata();
1787 
<abbr title="1788         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1788         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1789         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1790 
<abbr title="1791         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1791         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1792 
1793         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1794 
1795         if (md instanceof AdornedTargetCollectionMetadata) {
1796             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1797             AdornedTargetList atl = ppr.getAdornedList();
1798 
1799             // Get an entity form for the entity
<abbr title="1800             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1800             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1801             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1801             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1802                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1802                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1803                     .getDynamicResultSet().getRecords()[0];
1804             formService.populateEntityFormFields(entityForm, entity);
1805             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1806 
<abbr title="1807             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1807             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1808             int sequenceValue = Integer.parseInt(newSequence) + 1;
1809             Field field = entityForm.findField(atl.getSortField());
1810             field.setValue(String.valueOf(sequenceValue));
1811 
1812             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1813             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1813             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1814             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1815 
1816             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1817             responseMap.put(&quot;field&quot;, collectionField);
1818             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1819             return responseMap;
1820         } else if (md instanceof BasicCollectionMetadata) {
1821             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1822             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1823             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1823             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1824 
<abbr title="1825             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1825             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1826             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="1827             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1827             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
1828             if(listGridReadOnly){
1829                         throw new SecurityServiceException();
1830             }
1831             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1832                 Field f = new Field()
1833                         .withName(cd.getSortProperty())
1834                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1835                 entityForm.addHiddenField(mainMetadata, f);
1836             }
1837             formService.populateEntityFormFields(entityForm, entity);
1838 
1839             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1840                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1841                 Field field = entityForm.findField(cd.getSortProperty());
1842                 field.setValue(String.valueOf(sequenceValue));
1843             }
1844 
<abbr title="1845             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1845             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1846             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1847 
1848             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1849             responseMap.put(&quot;field&quot;, collectionField);
1850             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1851             return responseMap;
1852         } else {
<abbr title="1853             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1853             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1854         }
1855     }
1856 
1857     /**
1858      * Removes the requested collection item
1859      *
<abbr title="1860      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1860      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1861      * map collection.
1862      *
1863      * @param request
1864      * @param response
1865      * @param model
1866      * @param pathVars
1867      * @param id
1868      * @param collectionField
1869      * @param collectionItemId
1870      * @return the return view path
1871      * @throws Exception
1872      */
<abbr title="1873     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1873     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1874     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1874     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1875             @PathVariable  Map&lt;String, String&gt; pathVars,
1876             @PathVariable(value=&quot;id&quot;) String id,
1877             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1878             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1879         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1879         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1880     }
1881 
1882     /**
1883      * Removes the requested collection item
1884      *
<abbr title="1885      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1885      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1886      * map collection.
1887      *
1888      * @param request
1889      * @param response
1890      * @param model
1891      * @param pathVars
1892      * @param id
1893      * @param collectionField
1894      * @param collectionItemId
1895      * @return the return view path
1896      * @throws Exception
1897      */
<abbr title="1898     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1898     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1899     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1899     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1900             @PathVariable  Map&lt;String, String&gt; pathVars,
1901             @PathVariable(value=&quot;id&quot;) String id,
1902             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1903             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1904             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1905         String sectionKey = getSectionKey(pathVars);
1906         String mainClassName = getClassNameForSection(sectionKey);
1907         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1908         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1908         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1909         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1910 
1911         String priorKey = request.getParameter(&quot;key&quot;);
1912 
<abbr title="1913         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1913         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1914         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1915         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1915         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1916         service.clearEntityManager();
1917         // First, we must remove the collection entity
<abbr title="1918         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1918         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1919         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1919         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1920             String error = &quot;There was an error removing the whatever&quot;;
1921             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1922                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1923                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1923                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1924             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1924             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1925                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1926             }
1927             return new JsonResponse(response)
1928                 .with(&quot;status&quot;, &quot;error&quot;)
1929                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1930                 .done();
1931         }
1932 
1933         // Next, we must get the new list grid that represents this collection
1934         // We return the new list grid so that it can replace the currently visible one
<abbr title="1935         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1935         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1936 
1937         model.addAttribute(&quot;listGrid&quot;, listGrid);
1938         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1939         setModelAttributes(model, sectionKey);
1940         return &quot;views/standaloneListGrid&quot;;
1941     }
1942 
1943     public void addAuditableDisplayFields(EntityForm entityForm) {
1944         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1945         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1946             addAuditableDisplayField(entityForm, createdBy);
1947 
1948             createdBy.setIsVisible(false);
1949         }
1950         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1951         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1952             addAuditableDisplayField(entityForm, updatedBy);
1953 
1954             updatedBy.setIsVisible(false);
1955         }
1956     }
1957 
1958     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1959         Field displayField = buildAuditableDisplayField(userField);
1960 
1961         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1962         String userName = user == null ? null : user.getName();
1963         displayField.setValue(userName);
1964 
1965         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1966         if (auditGroup != null) {
1967             auditGroup.addField(displayField);
1968         }
1969     }
1970 
1971     private Field buildAuditableDisplayField(Field auditableField) {
1972         return new Field().withFieldType(SupportedFieldType.STRING.toString())
1973                 .withName(auditableField.getName() + &quot;Display&quot;)
1974                 .withFriendlyName(auditableField.getFriendlyName())
1975                 .withOrder(auditableField.getOrder())
1976                 .withOwningEntityClass(auditableField.getOwningEntityClass())
1977                 .withReadOnly(true);
1978     }
1979 
1980     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1981         String tabName = pathVars.get(&quot;tabName&quot;);
1982         if (StringUtils.isBlank(tabName)) {
1983             TabMetadata firstTab = cmd.getFirstTab();
1984             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1985         }
1986         return tabName;
1987     }
1988 
1989     // *****************************************
1990     // Typed Entity Helper Methods
1991     // *****************************************
1992 
1993     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1994         // Check if this is a typed entity
1995         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1996         if (typedEntitySection != null) {
1997             // Update the friendly name for this Entity Type
1998             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1999         }
2000     }
2001 
2002     // *********************************
2003     // ADDITIONAL SPRING-BOUND METHODS *
2004     // *********************************
2005 
2006     /**
<abbr title="2007      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2007      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2008      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2008      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2009      * or false. If the value is passed in as null, it will treat it as false.
2010      *
2011      * @param binder
2012      */
2013     @InitBinder
2014     public void initBinder(WebDataBinder binder) {
2015         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2016         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2017     }
2018 
2019 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  30 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  31 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  32 import org.broadleafcommerce.common.util.BLCArrayUtils;
  33 import org.broadleafcommerce.common.util.BLCMessageUtils;
  34 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  35 import org.broadleafcommerce.common.web.JsonResponse;
  36 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  37 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  38 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  40 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  41 import org.broadleafcommerce.openadmin.dto.ClassTree;
  42 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  43 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  44 import org.broadleafcommerce.openadmin.dto.Entity;
  45 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  46 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  47 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  48 import org.broadleafcommerce.openadmin.dto.Property;
  49 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  52 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  53 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  54 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  55 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  56 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  57 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  59 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  59 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  60 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  61 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  62 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  63 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  64 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  65 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  66 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  67 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  68 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  69 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  70 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  71 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  72 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  73 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  74 import org.springframework.stereotype.Controller;
  75 import org.springframework.ui.Model;
  76 import org.springframework.util.MultiValueMap;
  77 import org.springframework.validation.BindingResult;
  78 import org.springframework.web.bind.WebDataBinder;
  79 import org.springframework.web.bind.annotation.InitBinder;
  80 import org.springframework.web.bind.annotation.ModelAttribute;
  81 import org.springframework.web.bind.annotation.PathVariable;
  82 import org.springframework.web.bind.annotation.RequestMapping;
  83 import org.springframework.web.bind.annotation.RequestMethod;
  84 import org.springframework.web.bind.annotation.RequestParam;
  85 import org.springframework.web.bind.annotation.ResponseBody;
  86 import org.springframework.web.servlet.DispatcherServlet;
  87 import org.springframework.web.servlet.FlashMap;
  88 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  89 import org.springframework.web.util.UrlPathHelper;
  90 import com.fasterxml.jackson.databind.ObjectMapper;
  91 
  92 import java.net.URLDecoder;
  93 import java.util.ArrayList;
  94 import java.util.Arrays;
  95 import java.util.HashMap;
  96 import java.util.List;
  97 import java.util.Map;
  98 import java.util.Map.Entry;
  99 import java.util.Set;
 100 import java.util.stream.Stream;
 101 
 102 import javax.annotation.Resource;
 103 import javax.servlet.http.HttpServletRequest;
 104 import javax.servlet.http.HttpServletResponse;
 105 
 106 /**
<abbr title=" 107  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 107  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates everðŸ”µ</abbr>
<abbr title=" 108  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 108  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for ðŸ”µ</abbr>
 109  * that is not explicitly customized by its own controller.
 110  *
 111  * @author Andre Azzolini (apazzolini)
 112  * @author Jeff Fischer
 113  */
 114 @Controller(&quot;blAdminBasicEntityController&quot;)
 115 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 116 public class AdminBasicEntityController extends AdminAbstractController {
 117 
 118     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 119 
 120     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 121     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 122     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 123 
 124     @Resource(name=&quot;blSandBoxHelper&quot;)
 125     protected SandBoxHelper sandBoxHelper;
 126 
 127     @Resource(name = &quot;blAdminUserDao&quot;)
 128     protected AdminUserDao adminUserDao;
 129 
 130     @Resource(name=&quot;blDynamicEntityDao&quot;)
 131     protected DynamicEntityDao dynamicEntityDao;
 132 
 133     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 134     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 135 
 136     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 137     protected RowLevelSecurityService rowLevelSecurityService;
 138 
 139     // ******************************************
 140     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 141     // ******************************************
 142 
 143     /**
<abbr title=" 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 145      * criteria.
 146      *
 147      * @param request
 148      * @param response
 149      * @param model
 150      * @param pathVars
 151      * @param requestParams a Map of property name -&gt; list critiera values
 152      * @return the return view path
 153      * @throws Exception
 154      */
 155     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 156     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 157             @PathVariable Map&lt;String, String&gt; pathVars,
 158             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 159         String sectionKey = getSectionKey(pathVars);
 160         String sectionClassName = getClassNameForSection(sectionKey);
 161         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 163         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 164         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 165 
 166         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 167         listGrid.setSelectType(ListGrid.SelectType.NONE);
 168 
 169         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 170         if (CollectionUtils.isNotEmpty(headerFields)) {
 171             Field firstField = headerFields.iterator().next();
 172             if (requestParams.containsKey(firstField.getName())) {
 173                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 174             }
 175         }
 176 
 177         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 178 
 179         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 180         model.addAttribute(&quot;listGrid&quot;, listGrid);
 181 
 182         return &quot;modules/defaultContainer&quot;;
 183     }
 184 
<abbr title=" 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 186             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 187         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 188         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 189         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 190         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 191 
 192         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 193         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 194             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 195         }
 196 
 197         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 198         String requestUri = request.getRequestURI();
 199         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 201         }
 202 
 203         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 204         model.addAttribute(&quot;currentUri&quot;, requestUri);
 205         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 206         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 207         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 208         model.addAttribute(&quot;mainActions&quot;, mainActions);
 209         setModelAttributes(model, sectionKey);
 210         setTypedEntityModelAttributes(request, model);
 211     }
 212 
 213     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 214     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 215              HttpServletResponse response, Model model,
 216              @PathVariable Map&lt;String, String&gt; pathVars,
 217              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 218         String sectionKey = getSectionKey(pathVars);
 219         String sectionClassName = getClassNameForSection(sectionKey);
 220         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 222                 .withCustomCriteria(getCustomCriteria(requestParams));
 223 
 224         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 225 
 226         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 227         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 228 
 229         return formService.constructSelectizeOptionMap(drs, cmd);
 230     }
 231 
 232     /**
 233      * Obtains the requested criteria parameter
 234      *
 235      * @param requestParams
 236      * @return
 237      */
 238     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 239         if (requestParams == null || requestParams.isEmpty()) {
 240             return null;
 241         }
 242 
 243         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 244         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 245         return new String[] {response};
 246     }
 247 
 248     /**
<abbr title=" 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 250      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 251      *
 252      * @param sectionClassName
 253      * @param cmd
 254      * @param mainActions
 255      */
<abbr title=" 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 257         if (isAddActionAllowed(sectionClassName, cmd)) {
 258             mainActions.add(DefaultMainActions.ADD);
 259         }
 260     }
 261 
 262     protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {
 263         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 264         boolean canCreate = true;
 265         try {
 266             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 267         } catch (ServiceException e) {
 268             if (e instanceof SecurityServiceException) {
 269                 canCreate = false;
 270             }
 271         }
 272 
 273         if (canCreate) {
 274             checkReadOnly: {
 275                 //check if all the metadata is read only
 276                 for (Property property : cmd.getProperties()) {
 277                     if (property.getMetadata() instanceof BasicFieldMetadata) {
 278                         if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 279                                 !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 280                             break checkReadOnly;
 281                         }
 282                     }
 283                 }
 284                 canCreate = false;
 285             }
 286         }
 287 
 288         if (canCreate) {
<abbr title=" 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(ðŸ”µ</abbr>
 290         }
 291 
 292         return canCreate;
 293     }
 294 
 295     /**
<abbr title=" 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 297      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 297      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 299      * they can then perform operations on sub collections.
 300      *
 301      * @param request
 302      * @param response
 303      * @param model
 304      * @param pathVars
 305      * @param entityType
 306      * @return the return view path
 307      * @throws Exception
 308      */
 309     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 311             @PathVariable  Map&lt;String, String&gt; pathVars,
 312             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 313         String sectionKey = getSectionKey(pathVars);
 314         String sectionClassName = getClassNameForSection(sectionKey);
 315         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 317         ppr.setAddOperationInspect(true);
 318         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 319 
<abbr title=" 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic typeðŸ”µ</abbr>
 321         if (StringUtils.isBlank(entityType)) {
 322             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 323                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 324             } else {
 325                 entityType = getDefaultEntityType();
 326             }
 327         } else {
 328             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 329         }
 330 
 331         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 332 
<abbr title=" 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 334         // is set to the type we&#x27;re going to be creating.
 335         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 336         entityForm.setEntityType(entityType);
 337 
<abbr title=" 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 340         // fields that are not applicable for this given entity type.
 341         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 342 
 343         modifyAddEntityForm(entityForm, pathVars);
 344 
 345         model.addAttribute(&quot;entityForm&quot;, entityForm);
 346         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 347 
 348         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 349         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 350         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 351         setModelAttributes(model, sectionKey);
 352         return &quot;modules/modalContainer&quot;;
 353     }
 354 
 355     /**
<abbr title=" 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 357      *
 358      * @param request
 359      * @param response
 360      * @param model
 361      * @param pathVars
 362      * @param entityForm
 363      * @param result
 364      * @return the return view path
 365      * @throws Exception
 366      */
 367     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 368     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 369             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 371         String sectionKey = getSectionKey(pathVars);
 372         String sectionClassName = getClassNameForSection(sectionKey);
 373         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 375 
 376         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 378         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 379         entityFormValidator.validate(entityForm, entity, result);
 380 
 381         if (result.hasErrors()) {
 382             entityForm.clearFieldsMap();
 383             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 384 
 385             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 386 
 387             modifyAddEntityForm(entityForm, pathVars);
 388 
 389             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 390             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 391             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 392             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 393             setModelAttributes(model, sectionKey);
 394             return &quot;modules/modalContainer&quot;;
 395         }
 396 
 397         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 399     }
 400 
 401     /**
 402      * Renders the main entity form for the specified entity
 403      *
 404      * @param request
 405      * @param response
 406      * @param model
 407      * @param pathVars
 408      * @param id
 409      * @return the return view path
 410      * @throws Exception
 411      */
 412     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 413     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 414             @PathVariable  Map&lt;String, String&gt; pathVars,
 415             @PathVariable(&quot;id&quot;) String id) throws Exception {
 416         String sectionKey = getSectionKey(pathVars);
 417         String sectionClassName = getClassNameForSection(sectionKey);
 418         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 420 
 421         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 422         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 423 
<abbr title=" 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 425 
 426         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 427 
 428         if (isAddRequest(entity)) {
 429             modifyAddEntityForm(entityForm, pathVars);
 430         } else {
 431             modifyEntityForm(entityForm, pathVars);
 432         }
 433 
 434         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 435             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 436         }
 437 
 438         // Set the sectionKey again incase this is a typed entity
 439         entityForm.setSectionKey(sectionKey);
 440 
 441         // Build the current url in the cast that this is a typed entity
 442         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 443         int startIndex = request.getContextPath().length();
 444 
 445         // Remove the context path from servlet path
 446         String currentUrl = originatingUri.substring(startIndex);
 447 
 448         model.addAttribute(&quot;entity&quot;, entity);
 449         model.addAttribute(&quot;entityForm&quot;, entityForm);
 450         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 451 
 452         setModelAttributes(model, sectionKey);
 453 
 454         // We want to replace author ids with their names
 455         addAuditableDisplayFields(entityForm);
 456 
 457         if (isAjaxRequest(request)) {
 458             entityForm.setReadOnly();
 459             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 460             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 461             return &quot;modules/modalContainer&quot;;
 462         } else {
 463             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 464             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 465             return &quot;modules/defaultContainer&quot;;
 466         }
 467     }
 468 
<abbr title=" 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 470                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 471                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 471                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 472         String tabName = pathVars.get(&quot;tabName&quot;);
 473         if (StringUtils.isEmpty(tabName)) {
 474             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 475         }
 476         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 477     }
 478 
 479     private boolean isAddRequest(Entity entity) {
 480         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 482         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 483             return false;
 484         }
 485 
 486         return resultHolder.getResult();
 487     }
 488 
 489     /**
 490      * Attempts to get the List Grid for the selected tab.
 491      *
 492      * @param request
 493      * @param response
 494      * @param model
 495      * @param pathVars
 496      * @param id
 497      * @param tabName
 498      * @param entityForm
 499      * @param entity
 500      * @return the return view path
 501      * @throws Exception
 502      */
 503     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 504     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 505             @PathVariable Map&lt;String, String&gt; pathVars,
 506             @PathVariable(value = &quot;id&quot;) String id,
 507             @PathVariable(value = &quot;tabName&quot;) String tabName,
 508             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 509             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 510         String sectionKey = getSectionKey(pathVars);
 511         String sectionClassName = getClassNameForSection(sectionKey);
 512         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 514         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 515         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 517         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 518 
 519         if (isAddRequest(entity)) {
 520             modifyAddEntityForm(entityForm, pathVars);
 521         } else {
 522             modifyEntityForm(entityForm, pathVars);
 523         }
 524 
 525         model.addAttribute(&quot;entity&quot;, entity);
 526         model.addAttribute(&quot;entityForm&quot;, entityForm);
 527         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 528 
 529         setModelAttributes(model, sectionKey);
 530 
 531         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 532         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 533         return &quot;modules/defaultContainer&quot;;
 534     }
 535 
 536     /**
 537      * Builds JSON that looks like this:
 538      *
 539      * {&quot;errors&quot;:
 540      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 541      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 542      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 543      *        &quot;errorType&quot;, &quot;field&quot;,
 544      *        &quot;tab&quot;: &quot;General&quot;
 545      *        },
 546      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 547      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 548      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 549      *        &quot;errorType&quot;, &quot;field&quot;,
 550      *        &quot;tab&quot;: &quot;General&quot;
 551      *        }]
 552      * }
 553      *
 554      */
 555     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 556     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 557             @PathVariable Map&lt;String, String&gt; pathVars,
 558             @PathVariable(value = &quot;id&quot;) String id,
 559             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 560             RedirectAttributes ra) throws Exception {
 561 
 562         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 563 
 564         JsonResponse json = new JsonResponse(response);
 565         if (result.hasErrors()) {
 566             populateJsonValidationErrors(entityForm, result, json);
 567         }
 568         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 569         if (CollectionUtils.isNotEmpty(dirtyList)) {
 570             json.with(&quot;dirty&quot;, dirtyList);
 571         }
 572 
 573         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 575         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 576             return resultHolder.getResult();
 577         }
 578 
 579         return json.done();
 580     }
 581 
<abbr title=" 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 583         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 584         String sectionKey = getSectionKey(pathVars);
 585         String sectionClassName = getClassNameForSection(sectionKey);
 586         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 588         ClassMetadata cmd = null;
 589         Entity entity = null;
 590         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 591         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 592 
 593         for (Property p: entity.getProperties()) {
 594             if (p.getIsDirty()) {
 595                 dirtyList.add(p.getName());
 596             }
 597         }
 598         return dirtyList;
 599     }
 600 
 601     /**
<abbr title=" 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 603      * error fields highlighted. On a successful save, it will refresh the entity page.
 604      *
 605      * @param request
 606      * @param response
 607      * @param model
 608      * @param pathVars
 609      * @param id
 610      * @param entityForm
 611      * @param result
 612      * @return the return view path
 613      * @throws Exception
 614      */
 615     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 616     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 617             @PathVariable  Map&lt;String, String&gt; pathVars,
 618             @PathVariable(value=&quot;id&quot;) String id,
 619             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620             RedirectAttributes ra) throws Exception {
 621         String sectionKey = getSectionKey(pathVars);
 622         String sectionClassName = getClassNameForSection(sectionKey);
 623         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 625         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 626 
 627         extractDynamicFormFields(cmd, entityForm);
 628 
<abbr title=" 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 630         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 631 
 632         entityFormValidator.validate(entityForm, entity, result);
 633         if (result.hasErrors()) {
 634             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 635             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 636 
<abbr title=" 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 638             entityForm.clearFieldsMap();
 639             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 640 
 641             if (isAddRequest(entity)) {
 642                 modifyAddEntityForm(entityForm, pathVars);
 643             } else {
 644                 modifyEntityForm(entityForm, pathVars);
 645             }
 646 
 647             model.addAttribute(&quot;entity&quot;, entity);
 648             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 649 
 650             setModelAttributes(model, sectionKey);
 651 
 652             if (isAjaxRequest(request)) {
 653                 entityForm.setReadOnly();
 654                 model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 655                 model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 656                 return &quot;modules/modalContainer&quot;;
 657             } else {
 658                 model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 659                 model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 660                 return &quot;modules/defaultContainer&quot;;
 661             }
 662         }
 663 
 664         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 665 
 666         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 667     }
 668 
 669     /**
 670      * Attempts to remove the given entity.
 671      *
 672      * @param request
 673      * @param response
 674      * @param model
 675      * @param pathVars
 676      * @param id
 677      * @return the return view path
 678      * @throws Exception
 679      */
 680     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 681     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 682             @PathVariable  Map&lt;String, String&gt; pathVars,
 683             @PathVariable(value=&quot;id&quot;) String id,
 684             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685             RedirectAttributes ra) throws Exception {
 686         String sectionKey = getSectionKey(pathVars);
 687         String sectionClassName = getClassNameForSection(sectionKey);
 688         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 689 
<abbr title=" 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 691         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 692         // Removal does not normally return an Entity unless there is some validation error
 693         if (entity != null) {
 694             entityFormValidator.validate(entityForm, entity, result);
 695             if (result.hasErrors()) {
 696                 // Create a flash attribute for the unsuccessful delete
 697                 FlashMap fm = new FlashMap();
 698                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 699                 fm.put(&quot;headerFlashAlert&quot;, true);
 700                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 701 
 702                 // Re-look back up the entity so that we can return something populated
<abbr title=" 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 705                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 707                 entityForm.clearFieldsMap();
 708                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 709                 modifyEntityForm(entityForm, pathVars);
 710 
 711                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 712                         .done();
 713             }
 714         }
 715 
 716         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 717         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 718 
 719         if (isAjaxRequest(request)) {
 720             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 722         } else {
 723             return &quot;redirect:/&quot; + sectionKey;
 724         }
 725     }
 726 
 727     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 729             @PathVariable  Map&lt;String, String&gt; pathVars,
 730             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 731             @RequestParam String ids,
 732             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 733         String sectionKey = getSectionKey(pathVars);
 734         String sectionClassName = getClassNameForSection(sectionKey);
 735         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 738         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 739         FieldMetadata md = collectionProperty.getMetadata();
 740 
 741         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 742         ppr.setStartIndex(getStartIndex(requestParams));
 743         ppr.setMaxIndex(getMaxIndex(requestParams));
 744 
 745         if (md instanceof BasicFieldMetadata) {
 746             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 747             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 748 
 749             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 750             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 751 
 752             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 753             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 754 
 755             for (Entity e : drs.getRecords()) {
 756                 String id = e.getPMap().get(idProp).getValue();
 757                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 758 
 759                 if (StringUtils.isBlank(disp)) {
 760                     disp = e.getPMap().get(displayProp).getValue();
 761                 }
 762 
 763                 returnMap.put(id,  disp);
 764             }
 765 
 766             return returnMap;
 767         }
 768 
 769         return null;
 770     }
 771 
 772     /**
<abbr title=" 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 774      * then this method is invoked when a user clicks on the name of the default category field.
 775      *
 776      * @param request
 777      * @param response
 778      * @param model
 779      * @param pathVars
 780      * @param collectionField
 781      * @param id
 782      * @return
 783      * @throws Exception
 784      */
 785     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 787             @PathVariable  Map&lt;String, String&gt; pathVars,
 788             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 789             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 790         String sectionKey = getSectionKey(pathVars);
 791         String mainClassName = getClassNameForSection(sectionKey);
 792         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 794         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 795         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 796 
<abbr title=" 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 799         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 800         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 801         return viewEntityForm(request, response, model, varsForField, id);
 802     }
 803 
 804     @RequestMapping(
 805             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 806             method = RequestMethod.POST
 807     )
<abbr title=" 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 809                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 810                                         @PathVariable(value=&quot;id&quot;) String id,
 811                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 812                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 813                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 815 
<abbr title=" 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 817     }
 818 
 819 
 820     @RequestMapping(
 821             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 822             method = RequestMethod.POST
 823     )
<abbr title=" 824     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 824     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
 825                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 826                                         @PathVariable(value=&quot;id&quot;) String id,
 827                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 828                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 829                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 830                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 830                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 831 
<abbr title=" 832         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 832         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 833     }
 834 
 835 
 836     /**
 837      * Returns the records for a given collectionField filtered by a particular criteria
 838      *
 839      * @param request
 840      * @param response
 841      * @param model
 842      * @param pathVars
 843      * @param collectionField
 844      * @param requestParams
 845      * @return the return view path
 846      * @throws Exception
 847      */
 848     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 849     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 849     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 850             @PathVariable  Map&lt;String, String&gt; pathVars,
 851             @PathVariable(value=&quot;id&quot;) String id,
 852             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 853             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 854         String sectionKey = getSectionKey(pathVars);
 855         String mainClassName = getClassNameForSection(sectionKey);
 856         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 857         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 857         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 858         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 858         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 859         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 860 
 861         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 862         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 862         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 863 
 864         // Next, we must get the new list grid that represents this collection
<abbr title=" 865         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 865         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 866         model.addAttribute(&quot;listGrid&quot;, listGrid);
 867 
 868         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 869 
 870         // We return the new list grid so that it can replace the currently visible one
 871         setModelAttributes(model, sectionKey);
 872         return &quot;views/standaloneListGrid&quot;;
 873     }
 874 
 875     /**
<abbr title=" 876      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 876      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 877      * of this call depending on the type of the specified collection field.
 878      *
 879      * &lt;ul&gt;
 880      *  &lt;li&gt;
<abbr title=" 881      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 881      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 882      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 882      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 883      *  &lt;/li&gt;
 884      *  &lt;li&gt;
<abbr title=" 885      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 885      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 886      *    Used by fields such as &quot;allParentCategories&quot;.
 887      *  &lt;/li&gt;
 888      *  &lt;li&gt;
<abbr title=" 889      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 889      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 890      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 890      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 891      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 891      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 892      *  &lt;/li&gt;
 893      *  &lt;li&gt;
<abbr title=" 894      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 894      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 895      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 895      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 896      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 896      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 897      *    to linking an entity, provide extra fields, such as a promotional message.
 898      *  &lt;/li&gt;
 899      *  &lt;li&gt;
<abbr title=" 900      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 900      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 901      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 901      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 902      *    entity. Used by fields such as the mediaMap on a Sku.
 903      *  &lt;/li&gt;
 904      *
 905      * @param request
 906      * @param response
 907      * @param model
 908      * @param pathVars
 909      * @param id
 910      * @param collectionField
 911      * @param requestParams
 912      * @return the return view path
 913      * @throws Exception
 914      */
 915     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 916     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 916     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 917             @PathVariable Map&lt;String, String&gt; pathVars,
 918             @PathVariable(value = &quot;id&quot;) String id,
 919             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 920             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 921         String sectionKey = getSectionKey(pathVars);
 922         String mainClassName = getClassNameForSection(sectionKey);
 923         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 924         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 924         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 925                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 926         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 927         FieldMetadata md = collectionProperty.getMetadata();
 928 
 929         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 930                 .withFilterAndSortCriteria(getCriteria(requestParams))
 931                 .withStartIndex(getStartIndex(requestParams))
 932                 .withMaxIndex(getMaxIndex(requestParams))
 933                 .withLastId(getLastId(requestParams))
 934                 .withFirstId(getFirstId(requestParams))
 935                 .withUpperCount(getUpperCount(requestParams))
 936                 .withLowerCount(getLowerCount(requestParams))
 937                 .withPageSize(getPageSize(requestParams))
 938                 .withPresentationFetch(true);
 939 
 940         if (md instanceof BasicCollectionMetadata) {
 941             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 942             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 943                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 943                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title=" 944                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types"> 944                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
 945                 // for this entity.
 946                 String entityType = null;
 947                 if (requestParams.containsKey(&quot;entityType&quot;)) {
 948                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
 949                 }
 950                 if (StringUtils.isBlank(entityType)) {
 951                     if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 952                         entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 953                     } else {
 954                         entityType = getDefaultEntityType();
 955                     }
 956                 } else {
 957                     entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 958                 }
 959 
 960                 if (StringUtils.isBlank(entityType)) {
 961                     List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 962                     model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 963                     model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
<abbr title=" 964                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());"> 964                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyNameðŸ”µ</abbr>
 965                     String requestUri = request.getRequestURI();
<abbr title=" 966                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 966                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextðŸ”µ</abbr>
<abbr title=" 967                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 967                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUðŸ”µ</abbr>
 968                     }
 969                     model.addAttribute(&quot;currentUri&quot;, requestUri);
 970                     model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 971                     setModelAttributes(model, sectionKey);
 972                     return &quot;modules/modalContainer&quot;;
 973                 } else {
 974                     ppr = ppr.withCeilingEntityClassname(entityType);
 975                 }
 976             }
 977         } else if (md instanceof MapMetadata) {
<abbr title=" 978             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 978             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
 979             if (result.equals(ExtensionResultStatusType.HANDLED)) {
 980                 model.addAttribute(&quot;entityId&quot;, id);
 981                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 982                 model.addAttribute(&quot;collectionField&quot;, collectionField);
 983                 return &quot;modules/modalContainer&quot;;
 984             }
 985         }
 986 
 987         //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);
 988 
 989         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 990 
<abbr title=" 991         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 991         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
 992     }
 993 
<abbr title=" 994     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 994     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title=" 995     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 995     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
 996             @PathVariable Map&lt;String, String&gt; pathVars,
 997             @PathVariable(value=&quot;id&quot;) String id,
 998             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 999             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1000         String sectionKey = getSectionKey(pathVars);
1001         String mainClassName = getClassNameForSection(sectionKey);
1002         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1004         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1005         FieldMetadata md = collectionProperty.getMetadata();
1006         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1007         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1008             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1008             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1009                     collectionField,
1010                     collectionItemId, responseMap);
1011         }
1012         return responseMap;
1013     }
1014 
1015     /**
1016      *
1017      * @param request
1018      * @param response
1019      * @param model
1020      * @param pathVars
1021      * @param id
1022      * @param collectionField
1023      * @param requestParams
1024      * @return Json collection data
1025      * @throws Exception
1026      */
1027     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1028     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1028     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1029             @PathVariable Map&lt;String, String&gt; pathVars,
1030             @PathVariable(value = &quot;id&quot;) String id,
1031             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1032             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1033         String sectionKey = getSectionKey(pathVars);
1034         String mainClassName = getClassNameForSection(sectionKey);
1035         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1036         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1036         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1037                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1038         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1039         FieldMetadata md = collectionProperty.getMetadata();
1040 
1041         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1042                 .withFilterAndSortCriteria(getCriteria(requestParams))
1043                 .withStartIndex(getStartIndex(requestParams))
1044                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1045         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1045         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1046                 .toArray(String[]::new);
1047         ppr = ppr.withCustomCriteria( both);
1048 
1049         if (md instanceof AdornedTargetCollectionMetadata) {
1050             ppr.setOperationTypesOverride(null);
1051             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1052             ppr.setSectionEntityField(collectionField);
1053         }
1054 
1055         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1056 
<abbr title="1057         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1057         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1058     }
1059 
1060     protected String[] buildSelectizeCustomCriteria() {
1061         return new String[]{ IS_SELECTIZE_REQUEST };
1062     }
1063 
1064     /**
1065      * Adds the requested collection item via Selectize
1066      *
1067      * @param request
1068      * @param response
1069      * @param model
1070      * @param pathVars
1071      * @param id
1072      * @param collectionField
1073      * @param entityForm
1074      * @return the return view path
1075      * @throws Exception
1076      */
1077     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1078     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1078     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1079             @PathVariable Map&lt;String, String&gt; pathVars,
1080             @PathVariable(value=&quot;id&quot;) String id,
1081             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1082             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1082             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1083         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1084         String sectionKey = getSectionKey(pathVars);
1085         String mainClassName = getClassNameForSection(sectionKey);
1086         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1087         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1087         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1088         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1089 
1090         if (StringUtils.isBlank(entityForm.getEntityType())) {
1091             FieldMetadata fmd = collectionProperty.getMetadata();
1092             if (fmd instanceof BasicCollectionMetadata) {
1093                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1094             }
1095         }
1096 
<abbr title="1097         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1097         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1098         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1099         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1100         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1100         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1101 
1102         // First, we must save the collection entity
<abbr title="1103         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1103         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1104         Entity savedEntity = persistenceResponse.getEntity();
1105         entityFormValidator.validate(entityForm, savedEntity, result);
1106 
1107         if (result.hasErrors()) {
1108             returnVal.put(&quot;error&quot;, result.getFieldError());
1109             return returnVal;
1110         }
1111 
1112         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1113             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1114         }
1115         return returnVal;
1116     }
1117 
1118     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1119         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1119         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1120         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1121     }
1122 
1123     /**
1124      * Adds the requested collection item
1125      *
1126      * @param request
1127      * @param response
1128      * @param model
1129      * @param pathVars
1130      * @param id
1131      * @param collectionField
1132      * @param entityForm
1133      * @return the return view path
1134      * @throws Exception
1135      */
1136     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1137     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1137     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1138             @PathVariable Map&lt;String, String&gt; pathVars,
1139             @PathVariable(value=&quot;id&quot;) String id,
1140             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1141             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1141             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1142         String sectionKey = getSectionKey(pathVars);
1143         String mainClassName = getClassNameForSection(sectionKey);
1144         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1146         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1147 
1148         if (StringUtils.isBlank(entityForm.getEntityType())) {
1149             FieldMetadata fmd = collectionProperty.getMetadata();
1150             if (fmd instanceof BasicCollectionMetadata) {
1151                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1152             }
1153         }
1154 
<abbr title="1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1156         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1157         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1157         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1158         service.clearEntityManager();
1159         // First, we must save the collection entity
<abbr title="1160         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1160         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1161         Entity savedEntity = persistenceResponse.getEntity();
1162         entityFormValidator.validate(entityForm, savedEntity, result);
1163 
1164         if (result.hasErrors()) {
1165             FieldMetadata md = collectionProperty.getMetadata();
1166             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1167             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1167             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1168                     md, ppr, entityForm, savedEntity);
1169         }
1170 
1171         // Next, we must get the new list grid that represents this collection
<abbr title="1172         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1172         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1173         model.addAttribute(&quot;listGrid&quot;, listGrid);
1174 
1175         // We return the new list grid so that it can replace the currently visible one
1176         model.addAttribute(&quot;actualEntityId&quot;, id);
1177         setModelAttributes(model, sectionKey);
1178         return &quot;views/standaloneListGrid&quot;;
1179     }
1180 
1181     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1182     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1182     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1183             @PathVariable Map&lt;String, String&gt; pathVars,
1184             @PathVariable(value=&quot;id&quot;) String id,
1185             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1186             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1186             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1187         String sectionKey = getSectionKey(pathVars);
1188         String mainClassName = getClassNameForSection(sectionKey);
1189         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1190         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1190         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1191         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1192 
1193         if (StringUtils.isBlank(entityForm.getEntityType())) {
1194             FieldMetadata fmd = collectionProperty.getMetadata();
1195             if (fmd instanceof BasicCollectionMetadata) {
1196                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1197             }
1198         }
1199 
<abbr title="1200         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1200         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1201         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1201         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1202         entity.setIsPreAdd(true);
1203         // First, we must save the collection entity
<abbr title="1204         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1204         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1205         Entity savedEntity = persistenceResponse.getEntity();
1206 
1207         return new JsonResponse(response)
1208                 .with(&quot;status&quot;, &quot;complete&quot;)
1209                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1210                 .done();
1211     }
1212 
1213     /**
<abbr title="1214      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1214      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1215      * as well as after a POST with validation errors
1216      *
1217      * @param request
1218      * @param model
1219      * @param id
1220      * @param collectionField
1221      * @param sectionKey
1222      * @param collectionProperty
1223      * @param md
1224      * @param ppr
1225      * @return the appropriate view to display for the modal
<abbr title="1226      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1226      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1227      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1227      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1228      * @throws ServiceException
1229      */
<abbr title="1230     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1230     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1231             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1231             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1232             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1232             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1233 
<abbr title="1234         // For requests to add a new collection item include the main class that the subsequent request comes from.">1234         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1235         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1235         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1236         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1236         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1237         // fixes all cases.
1238         String mainClassName = getClassNameForSection(sectionKey);
1239         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1240         ppr.setAddOperationInspect(true);
1241 
1242         if (entityForm != null) {
1243             entityForm.clearFieldsMap();
1244         }
1245         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1246         if (md instanceof BasicCollectionMetadata) {
1247             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1248 
<abbr title="1249             // When adding items to basic collections, we will sometimes show a form to persist a new record">1249             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1250             // and sometimes show a list grid to allow the user to associate an existing record.
1251             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1252                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1252                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1253                 if (entityForm == null) {
1254                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1255                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1256                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1257                 } else {
1258                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1259                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1260                 }
<abbr title="1261                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1261                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1262                 entityForm.getTabs().iterator().next().getIsVisible();
1263 
1264                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1265                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1266             } else {
1267                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1268                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1268                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1269                 listGrid.setPathOverride(request.getRequestURL().toString());
1270 
<abbr title="1271                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1271                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1272                     listGrid.removeAllRowActions();
1273                 }
1274 
1275                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1276                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1277             }
1278         } else if (md instanceof AdornedTargetCollectionMetadata) {
1279             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1280 
<abbr title="1281             // Even though this field represents an adorned target collection, the list we want to show in the modal">1281             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1282             // is the standard list grid for the target entity of this field
1283             ppr.setOperationTypesOverride(null);
1284             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1285             ppr.setSectionEntityField(collectionField);
1286 
<abbr title="1287             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1287             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1288 
1289             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1290             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1290             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1291             listGrid.setSubCollectionFieldName(collectionField);
1292             listGrid.setPathOverride(request.getRequestURL().toString());
1293             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1294             if (entityForm == null) {
<abbr title="1295                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1295                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1296                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1296                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1297             } else {
<abbr title="1298                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1298                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1299                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1300             }
1301 
1302             listGrid.setListGridType(ListGrid.Type.ADORNED);
1303             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1304                 if (entry.getValue().getIsVisible()) {
1305                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1306                     break;
1307                 }
1308             }
1309 
1310             // This is part of an add, so we want to be able to filter/sort the listgrid
1311             listGrid.setIsSortable(false);
1312             listGrid.setCanFilterAndSort(true);
1313             listGrid.removeAllRowActions();
1314 
1315             model.addAttribute(&quot;listGrid&quot;, listGrid);
1316             model.addAttribute(&quot;entityForm&quot;, entityForm);
1317             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1318         } else if (md instanceof MapMetadata) {
1319             MapMetadata fmd = (MapMetadata) md;
<abbr title="1320             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1320             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1321 
1322             if (entityForm == null) {
<abbr title="1323                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1323                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1324             } else {
1325                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1326                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1327             }
1328             model.addAttribute(&quot;entityForm&quot;, entityForm);
1329             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1330         }
1331 
1332         // Set the parent id on the entity form
1333         if (entityForm != null) {
1334             entityForm.setParentId(id);
1335         }
1336 
1337         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1338         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1339         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1340         setModelAttributes(model, sectionKey);
1341         return &quot;modules/modalContainer&quot;;
1342     }
1343 
1344     /**
1345      * Shows the appropriate modal dialog to edit the selected collection item
1346      *
1347      * @param request
1348      * @param response
1349      * @param model
1350      * @param pathVars
1351      * @param id
1352      * @param collectionField
1353      * @param collectionItemId
1354      * @return the return view path
1355      * @throws Exception
1356      */
<abbr title="1357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1358     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1358     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1359             @PathVariable  Map&lt;String, String&gt; pathVars,
1360             @PathVariable(value=&quot;id&quot;) String id,
1361             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1362             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1363             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1365                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1366     }
1367 
1368     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1369     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1369     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1370             @PathVariable  Map&lt;String, String&gt; pathVars,
1371             @PathVariable(value=&quot;id&quot;) String id,
1372             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1373             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1374         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1374         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1375                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1376     }
1377 
1378     /**
<abbr title="1379      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1379      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1380      *
1381      * @param request
1382      * @param response
1383      * @param model
1384      * @param pathVars
1385      * @param id
1386      * @param collectionField
1387      * @param collectionItemId
1388      * @return the return view path
1389      * @throws Exception
1390      */
<abbr title="1391     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1391     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1392     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1392     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1393             @PathVariable  Map&lt;String, String&gt; pathVars,
1394             @PathVariable(value=&quot;id&quot;) String id,
1395             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1396             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1397             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1398         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1398         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1399                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1400 
1401         // Since this is a read-only view, actions don&#x27;t make sense in this context
1402         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1403         addAuditableDisplayFields(ef);
1404         ef.removeAllActions();
1405         ef.setReadOnly();
1406 
1407         return returnPath;
1408     }
1409 
<abbr title="1410     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1410     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1411     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1411     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1412             @PathVariable  Map&lt;String, String&gt; pathVars,
1413             @PathVariable(value=&quot;id&quot;) String id,
1414             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1415             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1416         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1416         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1417                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1418 
1419         // Since this is a read-only view, actions don&#x27;t make sense in this context
1420         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1421         ef.removeAllActions();
1422         ef.setReadOnly();
1423 
1424         return returnPath;
1425     }
1426 
<abbr title="1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1428             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1428             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1430     }
1431 
<abbr title="1432     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1432     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1433             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1433             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1434         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1434         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1435     }
1436 
<abbr title="1437     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1437     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1438                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1438                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1440     }
1441 
1442     /**
<abbr title="1443      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1443      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1444      * which are optional. If they are not passed in then they are automatically looked up
1445      *
1446      * @param request
1447      * @param model
1448      * @param pathVars
1449      * @param id
1450      * @param collectionField
1451      * @param collectionItemId
1452      * @param modalHeaderType
1453      * @param entityForm
1454      * @param entity
1455      * @return
1456      * @throws ServiceException
1457      */
<abbr title="1458     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1458     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1459             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1459             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
1460         String sectionKey = getSectionKey(pathVars);
1461         String mainClassName = getClassNameForSection(sectionKey);
1462         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1463         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1463         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1464         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1465         FieldMetadata md = collectionProperty.getMetadata();
1466         SectionCrumb nextCrumb = new SectionCrumb();
1467         if (md instanceof MapMetadata) {
1468             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1469         } else {
1470             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1471         }
1472         nextCrumb.setSectionId(collectionItemId);
1473         if (!sectionCrumbs.contains(nextCrumb)) {
1474             sectionCrumbs.add(nextCrumb);
1475         }
1476 
<abbr title="1477         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1477         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1478         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1478         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1479 
1480         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1481 
1482         if (md instanceof BasicCollectionMetadata &amp;&amp;
1483                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1484                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1484                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1485             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1486 
<abbr title="1487             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1487             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1488             if (entity == null) {
<abbr title="1489                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1489                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1490             }
1491 
1492             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1493             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1493             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1494             if (entityForm == null) {
<abbr title="1495                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1495                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectðŸ”µ</abbr>
1496             } else {
1497                 entityForm.clearFieldsMap();
<abbr title="1498                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1498                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, secðŸ”µ</abbr>
1499                 //remove all the actions since we&#x27;re not trying to redisplay them on the form
1500                 entityForm.removeAllActions();
1501             }
1502             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1503             addAuditableDisplayFields(entityForm);
1504             model.addAttribute(&quot;entityForm&quot;, entityForm);
1505             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1506         } else if (md instanceof AdornedTargetCollectionMetadata) {
1507             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1508 
1509             if (entity == null) {
<abbr title="1510                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1510                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1511                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1512             }
1513 
1514             boolean populateTypeAndId = true;
<abbr title="1515             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1515             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1516             if (entityForm == null) {
<abbr title="1517                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1517                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1518                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1519                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1520             } else {
1521                 entityForm.clearFieldsMap();
1522                 String entityType = entityForm.getEntityType();
<abbr title="1523                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1523                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1524                 entityForm.setEntityType(entityType);
1525                 populateTypeAndId = false;
1526             }
1527 
1528             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1529             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1529             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1530                     collectionField,
1531                     collectionItemId, responseMap);
1532 
<abbr title="1533             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1533             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1534             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1534             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1535             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1536             entityForm.setTranslationId(alternateId);
1537 
1538             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1539             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1540                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1541                     continue;
1542                 }
1543                 Property p = cmd.getPMap().get(field);
1544                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1545                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1545                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1546                     // directly on the first adorned target collection. Because of this, we need the actual id property">1546                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1547                     // from the entity that models the adorned target relationship, and not the id of the target object.">1547                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1548                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1548                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1549                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1549                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1550                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1551 
<abbr title="1552                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1552                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1553                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1554                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1555 
1556                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1557                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1557                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1558                     } else {
<abbr title="1559                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1559                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1560                     }
1561                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1562                     // See above comment for AdornedTargetCollectionMetadata
1563                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1564 
<abbr title="1565                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1565                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1566                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1566                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1567                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1568 
<abbr title="1569                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1569                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1570                             mmd.getTargetClass(), sectionCrumbs);
1571                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1572 
1573                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1574                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1574                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1575                     } else {
<abbr title="1576                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1576                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1577                     }
1578                 }
1579             }
1580 
<abbr title="1581             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1581             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1582             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1583 
1584             boolean atLeastOneBasicField = false;
1585             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1586                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1586                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1587                     atLeastOneBasicField = true;
1588                     break;
1589                 }
1590             }
1591             if (!atLeastOneBasicField) {
1592                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1593             }
1594             addAuditableDisplayFields(entityForm);
1595             model.addAttribute(&quot;entityForm&quot;, entityForm);
1596             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1597         } else if (md instanceof MapMetadata) {
1598             MapMetadata fmd = (MapMetadata) md;
1599 
<abbr title="1600             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1600             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1601             if (entity == null) {
<abbr title="1602                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1602                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1603                     collectionItemId, sectionCrumbs, null).getEntity();
1604             }
1605 
1606             boolean populateTypeAndId = true;
1607             if (entityForm == null) {
<abbr title="1608                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1608                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1609             } else {
1610                 //save off the prior key before clearing out the fields map as it will not appear
1611                 //back on the saved entity
1612                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1613                 entityForm.clearFieldsMap();
1614                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1615                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1616                 populateTypeAndId = false;
1617             }
1618 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1619 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1620             //For MappedCollections, we need to be specific on what ceilingEntity and translationId is used.">1620             //For MappedCollections, we need to be specific on what ceilingEntity and translationId is usðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1621             //It should be the entity and referenced Id of the value entity (not the target entity and Id).">1621             //It should be the entity and referenced Id of the value entity (not the target entity and IdðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1622             if (entityForm.getCeilingEntityClassname() == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1623                 entityForm.setCeilingEntityClassname(fmd.getValueClassName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1624             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1625             entityForm.setTranslationId(collectionItemId);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1626 </span>
1627 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1628 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1629             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1629             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1630             formService.populateMapEntityFormFields(entityForm, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1631             addAuditableDisplayFields(entityForm);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1632             model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1633             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1634         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1635 </span>
1636 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1637             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1638                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1638                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1639             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1640                 LOG.error(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1641             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1642             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValue());">1642             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValueðŸ”µ</abbr></span>
1643 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
<abbr title="1644             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1644             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1645             formService.populateMapEntityFormFields(entityForm, entity);
1646             addAuditableDisplayFields(entityForm);
1647             model.addAttribute(&quot;entityForm&quot;, entityForm);
1648             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1649         }
1650 
1651         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1652         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1653         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1654         setModelAttributes(model, sectionKey);
1655         return &quot;modules/modalContainer&quot;;
1656     }
1657 
1658     /**
1659      * Updates the specified collection item
1660      *
1661      * @param request
1662      * @param response
1663      * @param model
1664      * @param pathVars
1665      * @param id
1666      * @param collectionField
<abbr title="1667      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1667      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1668      * @param entityForm
1669      * @param result
1670      * @return the return view path
1671      * @throws Exception
1672      */
1673     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1674     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1674     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1675             @PathVariable  Map&lt;String, String&gt; pathVars,
1676             @PathVariable(value=&quot;id&quot;) String id,
1677             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1678             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1679             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1680             BindingResult result) throws Exception {
<abbr title="1681         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1681         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1682     }
1683 
1684     /**
1685      * Updates the specified collection item
1686      *
1687      * @param request
1688      * @param response
1689      * @param model
1690      * @param pathVars
1691      * @param id
1692      * @param collectionField
<abbr title="1693      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1693      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1694      * @param entityForm
<abbr title="1695      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1695      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1696      * @param result
1697      * @return the return view path
1698      * @throws Exception
1699      */
<abbr title="1700     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1700     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1701     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1701     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1702             @PathVariable  Map&lt;String, String&gt; pathVars,
1703             @PathVariable(value=&quot;id&quot;) String id,
1704             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1705             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1706             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1707             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1708             BindingResult result) throws Exception {
1709         String sectionKey = getSectionKey(pathVars);
1710         String mainClassName = getClassNameForSection(sectionKey);
1711         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1712         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1712         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1713         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1714 
<abbr title="1715         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1715         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1716         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1716         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1717         service.clearEntityManager();
1718         // First, we must save the collection entity
<abbr title="1719         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1719         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1720         Entity savedEntity = persistenceResponse.getEntity();
1721         entityFormValidator.validate(entityForm, savedEntity, result);
1722 
1723         if (result.hasErrors()) {
<abbr title="1724             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1724             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1725                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1726         }
1727 
1728         // Next, we must get the new list grid that represents this collection
1729         // We return the new list grid so that it can replace the currently visible one
<abbr title="1730         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1730         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1731 
1732         model.addAttribute(&quot;listGrid&quot;, listGrid);
1733         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1734         setModelAttributes(model, sectionKey);
1735         return &quot;views/standaloneListGrid&quot;;
1736     }
1737 
<abbr title="1738     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1738     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1739     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1740             HttpServletResponse response, Model model,
1741             @PathVariable  Map&lt;String, String&gt; pathVars,
1742             @PathVariable(value=&quot;id&quot;) String id,
1743             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1744             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1745             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1746         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1746         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1747     }
1748 
1749     /**
<abbr title="1750      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1750      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1751      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1751      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1752      *
1753      * @param request
1754      * @param response
1755      * @param model
1756      * @param pathVars
1757      * @param id
1758      * @param collectionField
1759      * @param collectionItemId
1760      * @return an object explaining the state of the operation
1761      * @throws Exception
1762      */
<abbr title="1763     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1763     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1764     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1765             HttpServletResponse response, Model model,
1766             @PathVariable  Map&lt;String, String&gt; pathVars,
1767             @PathVariable(value=&quot;id&quot;) String id,
1768             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1769             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1770             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1771             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1772         String sectionKey = getSectionKey(pathVars);
1773         String mainClassName = getClassNameForSection(sectionKey);
1774         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1775         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1775         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1776         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1777         FieldMetadata md = collectionProperty.getMetadata();
1778 
<abbr title="1779         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1779         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1780         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1781 
<abbr title="1782         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1782         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1783 
1784         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1785 
1786         if (md instanceof AdornedTargetCollectionMetadata) {
1787             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1788             AdornedTargetList atl = ppr.getAdornedList();
1789 
1790             // Get an entity form for the entity
<abbr title="1791             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1791             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1792             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1792             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1793                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1793                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1794                     .getDynamicResultSet().getRecords()[0];
1795             formService.populateEntityFormFields(entityForm, entity);
1796             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1797 
<abbr title="1798             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1798             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1799             int sequenceValue = Integer.parseInt(newSequence) + 1;
1800             Field field = entityForm.findField(atl.getSortField());
1801             field.setValue(String.valueOf(sequenceValue));
1802 
1803             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1804             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1804             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1805             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1806 
1807             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1808             responseMap.put(&quot;field&quot;, collectionField);
1809             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1810             return responseMap;
1811         } else if (md instanceof BasicCollectionMetadata) {
1812             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1813             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1814             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1814             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1815 
<abbr title="1816             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1816             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1817             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="1818             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1818             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
1819             if(listGridReadOnly){
1820                         throw new SecurityServiceException();
1821             }
1822             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1823                 Field f = new Field()
1824                         .withName(cd.getSortProperty())
1825                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1826                 entityForm.addHiddenField(mainMetadata, f);
1827             }
1828             formService.populateEntityFormFields(entityForm, entity);
1829 
1830             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1831                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1832                 Field field = entityForm.findField(cd.getSortProperty());
1833                 field.setValue(String.valueOf(sequenceValue));
1834             }
1835 
<abbr title="1836             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1836             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1837             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1838 
1839             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1840             responseMap.put(&quot;field&quot;, collectionField);
1841             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1842             return responseMap;
1843         } else {
<abbr title="1844             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1844             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1845         }
1846     }
1847 
1848     /**
1849      * Removes the requested collection item
1850      *
<abbr title="1851      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1851      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1852      * map collection.
1853      *
1854      * @param request
1855      * @param response
1856      * @param model
1857      * @param pathVars
1858      * @param id
1859      * @param collectionField
1860      * @param collectionItemId
1861      * @return the return view path
1862      * @throws Exception
1863      */
<abbr title="1864     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1864     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1865     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1865     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1866             @PathVariable  Map&lt;String, String&gt; pathVars,
1867             @PathVariable(value=&quot;id&quot;) String id,
1868             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1869             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1870         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1870         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1871     }
1872 
1873     /**
1874      * Removes the requested collection item
1875      *
<abbr title="1876      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1876      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1877      * map collection.
1878      *
1879      * @param request
1880      * @param response
1881      * @param model
1882      * @param pathVars
1883      * @param id
1884      * @param collectionField
1885      * @param collectionItemId
1886      * @return the return view path
1887      * @throws Exception
1888      */
<abbr title="1889     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1889     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1890     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1890     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1891             @PathVariable  Map&lt;String, String&gt; pathVars,
1892             @PathVariable(value=&quot;id&quot;) String id,
1893             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1894             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1895             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1896         String sectionKey = getSectionKey(pathVars);
1897         String mainClassName = getClassNameForSection(sectionKey);
1898         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1899         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1899         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1900         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1901 
1902         String priorKey = request.getParameter(&quot;key&quot;);
1903 
<abbr title="1904         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1904         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1905         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1906         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1906         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1907         service.clearEntityManager();
1908         // First, we must remove the collection entity
<abbr title="1909         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1909         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1910         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1910         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1911             String error = &quot;There was an error removing the whatever&quot;;
1912             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1913                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1914                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1914                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1915             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1915             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1916                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1917             }
1918             return new JsonResponse(response)
1919                 .with(&quot;status&quot;, &quot;error&quot;)
1920                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1921                 .done();
1922         }
1923 
1924         // Next, we must get the new list grid that represents this collection
1925         // We return the new list grid so that it can replace the currently visible one
<abbr title="1926         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1926         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1927 
1928         model.addAttribute(&quot;listGrid&quot;, listGrid);
1929         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1930         setModelAttributes(model, sectionKey);
1931         return &quot;views/standaloneListGrid&quot;;
1932     }
1933 
1934     public void addAuditableDisplayFields(EntityForm entityForm) {
1935         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1936         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1937             addAuditableDisplayField(entityForm, createdBy);
1938 
1939             createdBy.setIsVisible(false);
1940         }
1941         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1942         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1943             addAuditableDisplayField(entityForm, updatedBy);
1944 
1945             updatedBy.setIsVisible(false);
1946         }
1947     }
1948 
1949     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1950         Field displayField = buildAuditableDisplayField(userField);
1951 
1952         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1953         String userName = user == null ? null : user.getName();
1954         displayField.setValue(userName);
1955 
1956         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1957         if (auditGroup != null) {
1958             auditGroup.addField(displayField);
1959         }
1960     }
1961 
1962     private Field buildAuditableDisplayField(Field auditableField) {
1963         return new Field().withFieldType(SupportedFieldType.STRING.toString())
1964                 .withName(auditableField.getName() + &quot;Display&quot;)
1965                 .withFriendlyName(auditableField.getFriendlyName())
1966                 .withOrder(auditableField.getOrder())
1967                 .withOwningEntityClass(auditableField.getOwningEntityClass())
1968                 .withReadOnly(true);
1969     }
1970 
1971     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1972         String tabName = pathVars.get(&quot;tabName&quot;);
1973         if (StringUtils.isBlank(tabName)) {
1974             TabMetadata firstTab = cmd.getFirstTab();
1975             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1976         }
1977         return tabName;
1978     }
1979 
1980     // *****************************************
1981     // Typed Entity Helper Methods
1982     // *****************************************
1983 
1984     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1985         // Check if this is a typed entity
1986         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1987         if (typedEntitySection != null) {
1988             // Update the friendly name for this Entity Type
1989             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1990         }
1991     }
1992 
1993     // *********************************
1994     // ADDITIONAL SPRING-BOUND METHODS *
1995     // *********************************
1996 
1997     /**
<abbr title="1998      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">1998      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="1999      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1999      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2000      * or false. If the value is passed in as null, it will treat it as false.
2001      *
2002      * @param binder
2003      */
2004     @InitBinder
2005     public void initBinder(WebDataBinder binder) {
2006         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2007         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2008     }
2009 
2010 }
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import com.fasterxml.jackson.databind.ObjectMapper;
  21 import java.net.URLDecoder;
  22 import java.util.ArrayList;
  23 import java.util.Arrays;
  24 import java.util.HashMap;
  25 import java.util.List;
  26 import java.util.Map.Entry;
  27 import java.util.Map;
  28 import java.util.Set;
  29 import java.util.stream.Stream;
  30 import javax.annotation.Resource;
  31 import javax.servlet.http.HttpServletRequest;
  32 import javax.servlet.http.HttpServletResponse;
  33 import org.apache.commons.collections.CollectionUtils;
  34 import org.apache.commons.collections.MapUtils;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.apache.commons.logging.Log;
  37 import org.apache.commons.logging.LogFactory;
  38 import org.broadleafcommerce.common.exception.SecurityServiceException;
  39 import org.broadleafcommerce.common.exception.ServiceException;
  40 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  41 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  42 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  43 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  44 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  45 import org.broadleafcommerce.common.util.BLCArrayUtils;
  46 import org.broadleafcommerce.common.util.BLCMessageUtils;
  47 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  48 import org.broadleafcommerce.common.web.JsonResponse;
  49 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  50 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  51 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  52 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  53 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  54 import org.broadleafcommerce.openadmin.dto.ClassTree;
  55 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  56 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  57 import org.broadleafcommerce.openadmin.dto.Entity;
  58 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  59 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  60 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  61 import org.broadleafcommerce.openadmin.dto.Property;
  62 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  63 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  64 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  65 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  66 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  67 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  68 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  69 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  70 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  71 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  72 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  72 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  73 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  74 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  75 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  76 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  77 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  78 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  79 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  80 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  81 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  82 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  83 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  84 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  85 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  86 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  87 import org.springframework.stereotype.Controller;
  88 import org.springframework.ui.Model;
  89 import org.springframework.util.MultiValueMap;
  90 import org.springframework.validation.BindingResult;
  91 import org.springframework.web.bind.WebDataBinder;
  92 import org.springframework.web.bind.annotation.InitBinder;
  93 import org.springframework.web.bind.annotation.ModelAttribute;
  94 import org.springframework.web.bind.annotation.PathVariable;
  95 import org.springframework.web.bind.annotation.RequestMapping;
  96 import org.springframework.web.bind.annotation.RequestMethod;
  97 import org.springframework.web.bind.annotation.RequestParam;
  98 import org.springframework.web.bind.annotation.ResponseBody;
  99 import org.springframework.web.servlet.DispatcherServlet;
 100 import org.springframework.web.servlet.FlashMap;
 101 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
 102 import org.springframework.web.util.UrlPathHelper;
 103 
 104 
 105 /**
<abbr title=" 106  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 106  * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates everðŸ”µ</abbr>
<abbr title=" 107  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 107  * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for ðŸ”µ</abbr>
 108  * that is not explicitly customized by its own controller.
 109  *
 110  * @author Andre Azzolini (apazzolini)
 111  * @author Jeff Fischer
 112  */
 113 @Controller(&quot;blAdminBasicEntityController&quot;)
 114 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 115 public class AdminBasicEntityController extends AdminAbstractController {
 116     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 117 
 118     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 119 
 120     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 121 
 122     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 123 
 124     @Resource(name=&quot;blSandBoxHelper&quot;)
 125     protected SandBoxHelper sandBoxHelper;
 126 
 127     @Resource(name = &quot;blAdminUserDao&quot;)
 128     protected AdminUserDao adminUserDao;
 129 
 130     @Resource(name=&quot;blDynamicEntityDao&quot;)
 131     protected DynamicEntityDao dynamicEntityDao;
 132 
 133     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 134     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 135 
 136     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 137     protected RowLevelSecurityService rowLevelSecurityService;
 138 
 139     // ******************************************
 140     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 141     // ******************************************
 142 
 143     /**
<abbr title=" 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 144      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 145      * criteria.
 146      *
 147      * @param request
 148      * @param response
 149      * @param model
 150      * @param pathVars
 151      * @param requestParams a Map of property name -&gt; list critiera values
 152      * @return the return view path
 153      * @throws Exception
 154      */
 155     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 156     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 157             @PathVariable Map&lt;String, String&gt; pathVars,
 158             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 159         String sectionKey = getSectionKey(pathVars);
 160         String sectionClassName = getClassNameForSection(sectionKey);
 161         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 162         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 163         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 164         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 165 
 166         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 167         listGrid.setSelectType(ListGrid.SelectType.NONE);
 168 
 169         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 170         if (CollectionUtils.isNotEmpty(headerFields)) {
 171             Field firstField = headerFields.iterator().next();
 172             if (requestParams.containsKey(firstField.getName())) {
 173                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 174             }
 175         }
 176 
 177         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 178 
 179         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 180         model.addAttribute(&quot;listGrid&quot;, listGrid);
 181 
 182         return &quot;modules/defaultContainer&quot;;
 183     }
 184 
<abbr title=" 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 185     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 186             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 187         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 188         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 189         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 190         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 191 
 192         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 193         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 194             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 195         }
 196 
 197         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 198         String requestUri = request.getRequestURI();
 199         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 200             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 201         }
 202 
 203         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 204         model.addAttribute(&quot;currentUri&quot;, requestUri);
 205         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 206         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 207         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 208         model.addAttribute(&quot;mainActions&quot;, mainActions);
 209         setModelAttributes(model, sectionKey);
 210         setTypedEntityModelAttributes(request, model);
 211     }
 212 
 213     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 214     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 215              HttpServletResponse response, Model model,
 216              @PathVariable Map&lt;String, String&gt; pathVars,
 217              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 218         String sectionKey = getSectionKey(pathVars);
 219         String sectionClassName = getClassNameForSection(sectionKey);
 220         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 221         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 222                 .withCustomCriteria(getCustomCriteria(requestParams));
 223 
 224         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 225 
 226         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 227         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 228 
 229         return formService.constructSelectizeOptionMap(drs, cmd);
 230     }
 231 
 232     /**
 233      * Obtains the requested criteria parameter
 234      *
 235      * @param requestParams
 236      * @return
 237      */
 238     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 239         if (requestParams == null || requestParams.isEmpty()) {
 240             return null;
 241         }
 242 
 243         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 244         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 245         return new String[] {response};
 246     }
 247 
 248     /**
<abbr title=" 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 249      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 250      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 251      *
 252      * @param sectionClassName
 253      * @param cmd
 254      * @param mainActions
 255      */
<abbr title=" 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 256     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 257         if (isAddActionAllowed(sectionClassName, cmd)) {
 258             mainActions.add(DefaultMainActions.ADD);
 259         }
 260     }
 261 
 262     protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {
 263         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 264         boolean canCreate = true;
 265         try {
 266             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 267         } catch (ServiceException e) {
 268             if (e instanceof SecurityServiceException) {
 269                 canCreate = false;
 270             }
 271         }
 272 
 273         if (canCreate) {
 274             checkReadOnly: {
 275                 //check if all the metadata is read only
 276                 for (Property property : cmd.getProperties()) {
 277                     if (property.getMetadata() instanceof BasicFieldMetadata) {
 278                         if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 279                                 !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 280                             break checkReadOnly;
 281                         }
 282                     }
 283                 }
 284                 canCreate = false;
 285             }
 286         }
 287 
 288         if (canCreate) {
<abbr title=" 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 289             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(ðŸ”µ</abbr>
 290         }
 291 
 292         return canCreate;
 293     }
 294 
 295     /**
<abbr title=" 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 296      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 297      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 297      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 298      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 299      * they can then perform operations on sub collections.
 300      *
 301      * @param request
 302      * @param response
 303      * @param model
 304      * @param pathVars
 305      * @param entityType
 306      * @return the return view path
 307      * @throws Exception
 308      */
 309     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 310     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 311             @PathVariable  Map&lt;String, String&gt; pathVars,
 312             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 313         String sectionKey = getSectionKey(pathVars);
 314         String sectionClassName = getClassNameForSection(sectionKey);
 315         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 316         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 317         ppr.setAddOperationInspect(true);
 318         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 319 
<abbr title=" 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 320         // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic typeðŸ”µ</abbr>
 321         if (StringUtils.isBlank(entityType)) {
 322             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 323                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 324             } else {
 325                 entityType = getDefaultEntityType();
 326             }
 327         } else {
 328             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 329         }
 330 
 331         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 332 
<abbr title=" 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 333         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 334         // is set to the type we&#x27;re going to be creating.
 335         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 336         entityForm.setEntityType(entityType);
 337 
<abbr title=" 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 338         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 339         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 340         // fields that are not applicable for this given entity type.
 341         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 342 
 343         modifyAddEntityForm(entityForm, pathVars);
 344 
 345         model.addAttribute(&quot;entityForm&quot;, entityForm);
 346         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 347 
 348         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 349         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 350         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 351         setModelAttributes(model, sectionKey);
 352         return &quot;modules/modalContainer&quot;;
 353     }
 354 
 355     /**
<abbr title=" 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 356      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 357      *
 358      * @param request
 359      * @param response
 360      * @param model
 361      * @param pathVars
 362      * @param entityForm
 363      * @param result
 364      * @return the return view path
 365      * @throws Exception
 366      */
 367     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 368     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 369             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 370             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 371         String sectionKey = getSectionKey(pathVars);
 372         String sectionClassName = getClassNameForSection(sectionKey);
 373         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 374         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 375 
 376         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 377         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 378         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 379         entityFormValidator.validate(entityForm, entity, result);
 380 
 381         if (result.hasErrors()) {
 382             entityForm.clearFieldsMap();
 383             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 384 
 385             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 386 
 387             modifyAddEntityForm(entityForm, pathVars);
 388 
 389             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 390             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 391             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 392             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 393             setModelAttributes(model, sectionKey);
 394             return &quot;modules/modalContainer&quot;;
 395         }
 396 
 397         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 398         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 399     }
 400 
 401     /**
 402      * Renders the main entity form for the specified entity
 403      *
 404      * @param request
 405      * @param response
 406      * @param model
 407      * @param pathVars
 408      * @param id
 409      * @return the return view path
 410      * @throws Exception
 411      */
 412     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 413     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 414             @PathVariable  Map&lt;String, String&gt; pathVars,
 415             @PathVariable(&quot;id&quot;) String id) throws Exception {
 416         String sectionKey = getSectionKey(pathVars);
 417         String sectionClassName = getClassNameForSection(sectionKey);
 418         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 419         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 420 
 421         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 422         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 423 
<abbr title=" 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 424         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 425 
 426         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 427 
 428         if (isAddRequest(entity)) {
 429             modifyAddEntityForm(entityForm, pathVars);
 430         } else {
 431             modifyEntityForm(entityForm, pathVars);
 432         }
 433 
 434         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 435             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 436         }
 437 
 438         // Set the sectionKey again incase this is a typed entity
 439         entityForm.setSectionKey(sectionKey);
 440 
 441         // Build the current url in the cast that this is a typed entity
 442         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 443         int startIndex = request.getContextPath().length();
 444 
 445         // Remove the context path from servlet path
 446         String currentUrl = originatingUri.substring(startIndex);
 447 
 448         model.addAttribute(&quot;entity&quot;, entity);
 449         model.addAttribute(&quot;entityForm&quot;, entityForm);
 450         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 451 
 452         setModelAttributes(model, sectionKey);
 453 
 454         // We want to replace author ids with their names
 455         addAuditableDisplayFields(entityForm);
 456 
 457         if (isAjaxRequest(request)) {
 458             entityForm.setReadOnly();
 459             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 460             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 461             return &quot;modules/modalContainer&quot;;
 462         } else {
 463             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 464             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 465             return &quot;modules/defaultContainer&quot;;
 466         }
 467     }
 468 
<abbr title=" 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 469     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 470                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 471                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 471                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 472         String tabName = pathVars.get(&quot;tabName&quot;);
 473         if (StringUtils.isEmpty(tabName)) {
 474             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 475         }
 476         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 477     }
 478 
 479     private boolean isAddRequest(Entity entity) {
 480         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 481         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 482         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 483             return false;
 484         }
 485 
 486         return resultHolder.getResult();
 487     }
 488 
 489     /**
 490      * Attempts to get the List Grid for the selected tab.
 491      *
 492      * @param request
 493      * @param response
 494      * @param model
 495      * @param pathVars
 496      * @param id
 497      * @param tabName
 498      * @param entityForm
 499      * @param entity
 500      * @return the return view path
 501      * @throws Exception
 502      */
 503     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 504     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 505             @PathVariable Map&lt;String, String&gt; pathVars,
 506             @PathVariable(value = &quot;id&quot;) String id,
 507             @PathVariable(value = &quot;tabName&quot;) String tabName,
 508             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 509             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 510         String sectionKey = getSectionKey(pathVars);
 511         String sectionClassName = getClassNameForSection(sectionKey);
 512         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 513         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 514         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 515         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 516         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 517         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 518 
 519         if (isAddRequest(entity)) {
 520             modifyAddEntityForm(entityForm, pathVars);
 521         } else {
 522             modifyEntityForm(entityForm, pathVars);
 523         }
 524 
 525         model.addAttribute(&quot;entity&quot;, entity);
 526         model.addAttribute(&quot;entityForm&quot;, entityForm);
 527         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 528 
 529         setModelAttributes(model, sectionKey);
 530 
 531         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 532         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 533         return &quot;modules/defaultContainer&quot;;
 534     }
 535 
 536     /**
 537      * Builds JSON that looks like this:
 538      *
 539      * {&quot;errors&quot;:
 540      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 541      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 542      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 543      *        &quot;errorType&quot;, &quot;field&quot;,
 544      *        &quot;tab&quot;: &quot;General&quot;
 545      *        },
 546      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 547      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 548      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 549      *        &quot;errorType&quot;, &quot;field&quot;,
 550      *        &quot;tab&quot;: &quot;General&quot;
 551      *        }]
 552      * }
 553      *
 554      */
 555     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 556     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 557             @PathVariable Map&lt;String, String&gt; pathVars,
 558             @PathVariable(value = &quot;id&quot;) String id,
 559             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 560             RedirectAttributes ra) throws Exception {
 561 
 562         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 563 
 564         JsonResponse json = new JsonResponse(response);
 565         if (result.hasErrors()) {
 566             populateJsonValidationErrors(entityForm, result, json);
 567         }
 568         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 569         if (CollectionUtils.isNotEmpty(dirtyList)) {
 570             json.with(&quot;dirty&quot;, dirtyList);
 571         }
 572 
 573         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 574         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 575         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 576             return resultHolder.getResult();
 577         }
 578 
 579         return json.done();
 580     }
 581 
<abbr title=" 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 582     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 583         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 584         String sectionKey = getSectionKey(pathVars);
 585         String sectionClassName = getClassNameForSection(sectionKey);
 586         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 587         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 588         ClassMetadata cmd = null;
 589         Entity entity = null;
 590         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 591         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 592 
 593         for (Property p: entity.getProperties()) {
 594             if (p.getIsDirty()) {
 595                 dirtyList.add(p.getName());
 596             }
 597         }
 598         return dirtyList;
 599     }
 600 
 601     /**
<abbr title=" 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 602      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 603      * error fields highlighted. On a successful save, it will refresh the entity page.
 604      *
 605      * @param request
 606      * @param response
 607      * @param model
 608      * @param pathVars
 609      * @param id
 610      * @param entityForm
 611      * @param result
 612      * @return the return view path
 613      * @throws Exception
 614      */
 615     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 616     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 617             @PathVariable  Map&lt;String, String&gt; pathVars,
 618             @PathVariable(value=&quot;id&quot;) String id,
 619             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620             RedirectAttributes ra) throws Exception {
 621         String sectionKey = getSectionKey(pathVars);
 622         String sectionClassName = getClassNameForSection(sectionKey);
 623         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 624         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 625         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 626 
 627         extractDynamicFormFields(cmd, entityForm);
 628 
<abbr title=" 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 629         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 630         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 631 
 632         entityFormValidator.validate(entityForm, entity, result);
 633         if (result.hasErrors()) {
 634             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 635             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 636 
<abbr title=" 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 637             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 638             entityForm.clearFieldsMap();
 639             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 640 
 641             if (isAddRequest(entity)) {
 642                 modifyAddEntityForm(entityForm, pathVars);
 643             } else {
 644                 modifyEntityForm(entityForm, pathVars);
 645             }
 646 
 647             model.addAttribute(&quot;entity&quot;, entity);
 648             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 649 
 650             setModelAttributes(model, sectionKey);
 651 
 652             if (isAjaxRequest(request)) {
 653                 entityForm.setReadOnly();
 654                 model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 655                 model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 656                 return &quot;modules/modalContainer&quot;;
 657             } else {
 658                 model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 659                 model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 660                 return &quot;modules/defaultContainer&quot;;
 661             }
 662         }
 663 
 664         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 665 
 666         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 667     }
 668 
 669     /**
 670      * Attempts to remove the given entity.
 671      *
 672      * @param request
 673      * @param response
 674      * @param model
 675      * @param pathVars
 676      * @param id
 677      * @return the return view path
 678      * @throws Exception
 679      */
 680     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 681     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 682             @PathVariable  Map&lt;String, String&gt; pathVars,
 683             @PathVariable(value=&quot;id&quot;) String id,
 684             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685             RedirectAttributes ra) throws Exception {
 686         String sectionKey = getSectionKey(pathVars);
 687         String sectionClassName = getClassNameForSection(sectionKey);
 688         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 689 
<abbr title=" 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 690         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 691         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 692         // Removal does not normally return an Entity unless there is some validation error
 693         if (entity != null) {
 694             entityFormValidator.validate(entityForm, entity, result);
 695             if (result.hasErrors()) {
 696                 // Create a flash attribute for the unsuccessful delete
 697                 FlashMap fm = new FlashMap();
 698                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 699                 fm.put(&quot;headerFlashAlert&quot;, true);
 700                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 701 
 702                 // Re-look back up the entity so that we can return something populated
<abbr title=" 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 703                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 704                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 705                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 706                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 707                 entityForm.clearFieldsMap();
 708                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 709                 modifyEntityForm(entityForm, pathVars);
 710 
 711                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 712                         .done();
 713             }
 714         }
 715 
 716         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 717         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 718 
 719         if (isAjaxRequest(request)) {
 720             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 721             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 722         } else {
 723             return &quot;redirect:/&quot; + sectionKey;
 724         }
 725     }
 726 
 727     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 728     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 729             @PathVariable  Map&lt;String, String&gt; pathVars,
 730             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 731             @RequestParam String ids,
 732             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 733         String sectionKey = getSectionKey(pathVars);
 734         String sectionClassName = getClassNameForSection(sectionKey);
 735         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 736         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 737         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 738         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 739         FieldMetadata md = collectionProperty.getMetadata();
 740 
 741         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 742         ppr.setStartIndex(getStartIndex(requestParams));
 743         ppr.setMaxIndex(getMaxIndex(requestParams));
 744 
 745         if (md instanceof BasicFieldMetadata) {
 746             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 747             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 748 
 749             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 750             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 751 
 752             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 753             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 754 
 755             for (Entity e : drs.getRecords()) {
 756                 String id = e.getPMap().get(idProp).getValue();
 757                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 758 
 759                 if (StringUtils.isBlank(disp)) {
 760                     disp = e.getPMap().get(displayProp).getValue();
 761                 }
 762 
 763                 returnMap.put(id,  disp);
 764             }
 765 
 766             return returnMap;
 767         }
 768 
 769         return null;
 770     }
 771 
 772     /**
<abbr title=" 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 773      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 774      * then this method is invoked when a user clicks on the name of the default category field.
 775      *
 776      * @param request
 777      * @param response
 778      * @param model
 779      * @param pathVars
 780      * @param collectionField
 781      * @param id
 782      * @return
 783      * @throws Exception
 784      */
 785     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 786     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 787             @PathVariable  Map&lt;String, String&gt; pathVars,
 788             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 789             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 790         String sectionKey = getSectionKey(pathVars);
 791         String mainClassName = getClassNameForSection(sectionKey);
 792         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 793         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 794         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 795         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 796 
<abbr title=" 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 797         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 798         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 799         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 800         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 801         return viewEntityForm(request, response, model, varsForField, id);
 802     }
 803 
 804     @RequestMapping(
 805             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 806             method = RequestMethod.POST
 807     )
<abbr title=" 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 808     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 809                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 810                                         @PathVariable(value=&quot;id&quot;) String id,
 811                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 812                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 813                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 814                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 815 
<abbr title=" 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 816         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 817     }
 818 
 819     @RequestMapping(
 820             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 821             method = RequestMethod.POST
 822     )
<abbr title=" 823     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 823     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
 824                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 825                                         @PathVariable(value=&quot;id&quot;) String id,
 826                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 827                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 828                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 829                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 829                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 830 
<abbr title=" 831         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 831         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 832     }
 833 
 834     /**
 835      * Returns the records for a given collectionField filtered by a particular criteria
 836      *
 837      * @param request
 838      * @param response
 839      * @param model
 840      * @param pathVars
 841      * @param collectionField
 842      * @param requestParams
 843      * @return the return view path
 844      * @throws Exception
 845      */
 846     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 847     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 847     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 848             @PathVariable  Map&lt;String, String&gt; pathVars,
 849             @PathVariable(value=&quot;id&quot;) String id,
 850             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 851             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 852         String sectionKey = getSectionKey(pathVars);
 853         String mainClassName = getClassNameForSection(sectionKey);
 854         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 855         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 855         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 856         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 856         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 857         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 858 
 859         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 860         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 860         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 861 
 862         // Next, we must get the new list grid that represents this collection
<abbr title=" 863         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 863         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 864         model.addAttribute(&quot;listGrid&quot;, listGrid);
 865 
 866         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 867 
 868         // We return the new list grid so that it can replace the currently visible one
 869         setModelAttributes(model, sectionKey);
 870         return &quot;views/standaloneListGrid&quot;;
 871     }
 872 
 873     /**
<abbr title=" 874      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 874      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 875      * of this call depending on the type of the specified collection field.
 876      *
 877      * &lt;ul&gt;
 878      *  &lt;li&gt;
<abbr title=" 879      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 879      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 880      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 880      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 881      *  &lt;/li&gt;
 882      *  &lt;li&gt;
<abbr title=" 883      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 883      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 884      *    Used by fields such as &quot;allParentCategories&quot;.
 885      *  &lt;/li&gt;
 886      *  &lt;li&gt;
<abbr title=" 887      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 887      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 888      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 888      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 889      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 889      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 890      *  &lt;/li&gt;
 891      *  &lt;li&gt;
<abbr title=" 892      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 892      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 893      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 893      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 894      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 894      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 895      *    to linking an entity, provide extra fields, such as a promotional message.
 896      *  &lt;/li&gt;
 897      *  &lt;li&gt;
<abbr title=" 898      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 898      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 899      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 899      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 900      *    entity. Used by fields such as the mediaMap on a Sku.
 901      *  &lt;/li&gt;
 902      *
 903      * @param request
 904      * @param response
 905      * @param model
 906      * @param pathVars
 907      * @param id
 908      * @param collectionField
 909      * @param requestParams
 910      * @return the return view path
 911      * @throws Exception
 912      */
 913     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 914     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 914     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 915             @PathVariable Map&lt;String, String&gt; pathVars,
 916             @PathVariable(value = &quot;id&quot;) String id,
 917             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 918             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 919         String sectionKey = getSectionKey(pathVars);
 920         String mainClassName = getClassNameForSection(sectionKey);
 921         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 922         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 922         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 923                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 924         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 925         FieldMetadata md = collectionProperty.getMetadata();
 926 
 927         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 928                 .withFilterAndSortCriteria(getCriteria(requestParams))
 929                 .withStartIndex(getStartIndex(requestParams))
 930                 .withMaxIndex(getMaxIndex(requestParams))
 931                 .withLastId(getLastId(requestParams))
 932                 .withFirstId(getFirstId(requestParams))
 933                 .withUpperCount(getUpperCount(requestParams))
 934                 .withLowerCount(getLowerCount(requestParams))
 935                 .withPageSize(getPageSize(requestParams))
 936                 .withPresentationFetch(true);
 937 
 938         if (md instanceof BasicCollectionMetadata) {
 939             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 940             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 941                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 941                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title=" 942                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types"> 942                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
 943                 // for this entity.
 944                 String entityType = null;
 945                 if (requestParams.containsKey(&quot;entityType&quot;)) {
 946                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
 947                 }
 948                 if (StringUtils.isBlank(entityType)) {
 949                     if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 950                         entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 951                     } else {
 952                         entityType = getDefaultEntityType();
 953                     }
 954                 } else {
 955                     entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 956                 }
 957 
 958                 if (StringUtils.isBlank(entityType)) {
 959                     List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 960                     model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 961                     model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
<abbr title=" 962                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());"> 962                     model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyNameðŸ”µ</abbr>
 963                     String requestUri = request.getRequestURI();
<abbr title=" 964                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 964                     if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextðŸ”µ</abbr>
<abbr title=" 965                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 965                         requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUðŸ”µ</abbr>
 966                     }
 967                     model.addAttribute(&quot;currentUri&quot;, requestUri);
 968                     model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 969                     setModelAttributes(model, sectionKey);
 970                     return &quot;modules/modalContainer&quot;;
 971                 } else {
 972                     ppr = ppr.withCeilingEntityClassname(entityType);
 973                 }
 974             }
 975         } else if (md instanceof MapMetadata) {
<abbr title=" 976             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 976             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
 977             if (result.equals(ExtensionResultStatusType.HANDLED)) {
 978                 model.addAttribute(&quot;entityId&quot;, id);
 979                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 980                 model.addAttribute(&quot;collectionField&quot;, collectionField);
 981                 return &quot;modules/modalContainer&quot;;
 982             }
 983         }
 984 
 985         //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);
 986 
 987         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 988 
<abbr title=" 989         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 989         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
 990     }
 991 
<abbr title=" 992     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 992     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title=" 993     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 993     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
 994             @PathVariable Map&lt;String, String&gt; pathVars,
 995             @PathVariable(value=&quot;id&quot;) String id,
 996             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 997             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
 998         String sectionKey = getSectionKey(pathVars);
 999         String mainClassName = getClassNameForSection(sectionKey);
1000         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1001         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1001         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1002         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1003         FieldMetadata md = collectionProperty.getMetadata();
1004         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1005         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1006             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1006             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1007                     collectionField,
1008                     collectionItemId, responseMap);
1009         }
1010         return responseMap;
1011     }
1012 
1013     /**
1014      *
1015      * @param request
1016      * @param response
1017      * @param model
1018      * @param pathVars
1019      * @param id
1020      * @param collectionField
1021      * @param requestParams
1022      * @return Json collection data
1023      * @throws Exception
1024      */
1025     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
1026     @ResponseBody
<abbr title="1027     public Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable">1027     public Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletRespoðŸ”µ</abbr>
1028     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
1029     String id, @PathVariable(&quot;collectionField&quot;)
1030     String collectionField, @RequestParam
1031     MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1032         String sectionKey = getSectionKey(pathVars);
1033         String mainClassName = getClassNameForSection(sectionKey);
1034         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1035         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1035         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1036         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1037         FieldMetadata md = collectionProperty.getMetadata();
<abbr title="1038         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilterAndSortCriteria(getCriteria(requestParams)).withStartIndex(getStartIndex(requestParams)).withMaxIndex(getMaxIndex(requestParams));">1038         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilðŸ”µ</abbr>
<abbr title="1039         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria())).toArray(String[]::new);">1039         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1040         ppr = ppr.withCustomCriteria(both);
1041         if (md instanceof AdornedTargetCollectionMetadata) {
1042             ppr.setOperationTypesOverride(null);
1043             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1044             ppr.setSectionEntityField(collectionField);
1045         }
1046         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1047         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1047         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1048     }
1049 
1050     protected String[] buildSelectizeCustomCriteria() {
1051         return new String[]{ IS_SELECTIZE_REQUEST };
1052     }
1053 
1054     /**
1055      * Adds the requested collection item via Selectize
1056      *
1057      * @param request
1058      * @param response
1059      * @param model
1060      * @param pathVars
1061      * @param id
1062      * @param collectionField
1063      * @param entityForm
1064      * @return the return view path
1065      * @throws Exception
1066      */
1067     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1068     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1068     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1069             @PathVariable Map&lt;String, String&gt; pathVars,
1070             @PathVariable(value=&quot;id&quot;) String id,
1071             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1072             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1072             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1073         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1074         String sectionKey = getSectionKey(pathVars);
1075         String mainClassName = getClassNameForSection(sectionKey);
1076         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1077         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1077         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1078         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1079 
1080         if (StringUtils.isBlank(entityForm.getEntityType())) {
1081             FieldMetadata fmd = collectionProperty.getMetadata();
1082             if (fmd instanceof BasicCollectionMetadata) {
1083                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1084             }
1085         }
1086 
<abbr title="1087         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1087         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1088         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1089         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1090         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1090         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1091 
1092         // First, we must save the collection entity
<abbr title="1093         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1093         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1094         Entity savedEntity = persistenceResponse.getEntity();
1095         entityFormValidator.validate(entityForm, savedEntity, result);
1096 
1097         if (result.hasErrors()) {
1098             returnVal.put(&quot;error&quot;, result.getFieldError());
1099             return returnVal;
1100         }
1101 
1102         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1103             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1104         }
1105         return returnVal;
1106     }
1107 
1108     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1109         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1109         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1110         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1111     }
1112 
1113     /**
1114      * Adds the requested collection item
1115      *
1116      * @param request
1117      * @param response
1118      * @param model
1119      * @param pathVars
1120      * @param id
1121      * @param collectionField
1122      * @param entityForm
1123      * @return the return view path
1124      * @throws Exception
1125      */
1126     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1127     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1127     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1128             @PathVariable Map&lt;String, String&gt; pathVars,
1129             @PathVariable(value=&quot;id&quot;) String id,
1130             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1131             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1131             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1132         String sectionKey = getSectionKey(pathVars);
1133         String mainClassName = getClassNameForSection(sectionKey);
1134         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1135         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1135         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1136         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1137 
1138         if (StringUtils.isBlank(entityForm.getEntityType())) {
1139             FieldMetadata fmd = collectionProperty.getMetadata();
1140             if (fmd instanceof BasicCollectionMetadata) {
1141                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1142             }
1143         }
1144 
<abbr title="1145         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1145         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1146         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1147         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1147         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1148         service.clearEntityManager();
1149         // First, we must save the collection entity
<abbr title="1150         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1150         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1151         Entity savedEntity = persistenceResponse.getEntity();
1152         entityFormValidator.validate(entityForm, savedEntity, result);
1153 
1154         if (result.hasErrors()) {
1155             FieldMetadata md = collectionProperty.getMetadata();
1156             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1157             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1157             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1158                     md, ppr, entityForm, savedEntity);
1159         }
1160 
1161         // Next, we must get the new list grid that represents this collection
<abbr title="1162         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1162         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1163         model.addAttribute(&quot;listGrid&quot;, listGrid);
1164 
1165         // We return the new list grid so that it can replace the currently visible one
1166         model.addAttribute(&quot;actualEntityId&quot;, id);
1167         setModelAttributes(model, sectionKey);
1168         return &quot;views/standaloneListGrid&quot;;
1169     }
1170 
1171     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1172     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1172     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1173             @PathVariable Map&lt;String, String&gt; pathVars,
1174             @PathVariable(value=&quot;id&quot;) String id,
1175             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1176             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1176             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1177         String sectionKey = getSectionKey(pathVars);
1178         String mainClassName = getClassNameForSection(sectionKey);
1179         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1180         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1180         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1181         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1182 
1183         if (StringUtils.isBlank(entityForm.getEntityType())) {
1184             FieldMetadata fmd = collectionProperty.getMetadata();
1185             if (fmd instanceof BasicCollectionMetadata) {
1186                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1187             }
1188         }
1189 
<abbr title="1190         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1190         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1191         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1191         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1192         entity.setIsPreAdd(true);
1193         // First, we must save the collection entity
<abbr title="1194         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1194         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1195         Entity savedEntity = persistenceResponse.getEntity();
1196 
1197         return new JsonResponse(response)
1198                 .with(&quot;status&quot;, &quot;complete&quot;)
1199                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1200                 .done();
1201     }
1202 
1203     /**
<abbr title="1204      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1204      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1205      * as well as after a POST with validation errors
1206      *
1207      * @param request
1208      * @param model
1209      * @param id
1210      * @param collectionField
1211      * @param sectionKey
1212      * @param collectionProperty
1213      * @param md
1214      * @param ppr
1215      * @return the appropriate view to display for the modal
<abbr title="1216      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1216      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1217      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1217      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1218      * @throws ServiceException
1219      */
<abbr title="1220     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1220     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1221             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1221             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1222             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1222             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1223 
<abbr title="1224         // For requests to add a new collection item include the main class that the subsequent request comes from.">1224         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1225         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1225         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1226         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1226         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1227         // fixes all cases.
1228         String mainClassName = getClassNameForSection(sectionKey);
1229         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1230         ppr.setAddOperationInspect(true);
1231 
1232         if (entityForm != null) {
1233             entityForm.clearFieldsMap();
1234         }
1235         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1236         if (md instanceof BasicCollectionMetadata) {
1237             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1238 
<abbr title="1239             // When adding items to basic collections, we will sometimes show a form to persist a new record">1239             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1240             // and sometimes show a list grid to allow the user to associate an existing record.
1241             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1242                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1242                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1243                 if (entityForm == null) {
1244                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1245                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1246                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1247                 } else {
1248                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1249                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1250                 }
<abbr title="1251                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1251                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1252                 entityForm.getTabs().iterator().next().getIsVisible();
1253 
1254                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1255                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1256             } else {
1257                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1258                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1258                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1259                 listGrid.setPathOverride(request.getRequestURL().toString());
1260 
<abbr title="1261                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1261                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1262                     listGrid.removeAllRowActions();
1263                 }
1264 
1265                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1266                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1267             }
1268         } else if (md instanceof AdornedTargetCollectionMetadata) {
1269             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1270 
<abbr title="1271             // Even though this field represents an adorned target collection, the list we want to show in the modal">1271             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1272             // is the standard list grid for the target entity of this field
1273             ppr.setOperationTypesOverride(null);
1274             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1275             ppr.setSectionEntityField(collectionField);
1276 
<abbr title="1277             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1277             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1278 
1279             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1280             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1280             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1281             listGrid.setSubCollectionFieldName(collectionField);
1282             listGrid.setPathOverride(request.getRequestURL().toString());
1283             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1284             if (entityForm == null) {
<abbr title="1285                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1285                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1286                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1286                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1287             } else {
<abbr title="1288                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1288                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1289                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1290             }
1291 
1292             listGrid.setListGridType(ListGrid.Type.ADORNED);
1293             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1294                 if (entry.getValue().getIsVisible()) {
1295                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1296                     break;
1297                 }
1298             }
1299 
1300             // This is part of an add, so we want to be able to filter/sort the listgrid
1301             listGrid.setIsSortable(false);
1302             listGrid.setCanFilterAndSort(true);
1303             listGrid.removeAllRowActions();
1304 
1305             model.addAttribute(&quot;listGrid&quot;, listGrid);
1306             model.addAttribute(&quot;entityForm&quot;, entityForm);
1307             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1308         } else if (md instanceof MapMetadata) {
1309             MapMetadata fmd = (MapMetadata) md;
<abbr title="1310             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1310             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1311 
1312             if (entityForm == null) {
<abbr title="1313                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1313                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1314             } else {
1315                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1316                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1317             }
1318             model.addAttribute(&quot;entityForm&quot;, entityForm);
1319             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1320         }
1321 
1322         // Set the parent id on the entity form
1323         if (entityForm != null) {
1324             entityForm.setParentId(id);
1325         }
1326 
1327         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1328         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1329         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1330         setModelAttributes(model, sectionKey);
1331         return &quot;modules/modalContainer&quot;;
1332     }
1333 
1334     /**
1335      * Shows the appropriate modal dialog to edit the selected collection item
1336      *
1337      * @param request
1338      * @param response
1339      * @param model
1340      * @param pathVars
1341      * @param id
1342      * @param collectionField
1343      * @param collectionItemId
1344      * @return the return view path
1345      * @throws Exception
1346      */
<abbr title="1347     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1347     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1348     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1348     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1349             @PathVariable  Map&lt;String, String&gt; pathVars,
1350             @PathVariable(value=&quot;id&quot;) String id,
1351             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1352             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1353             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1354         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1354         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1355                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1356     }
1357 
1358     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1359     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1359     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1360             @PathVariable  Map&lt;String, String&gt; pathVars,
1361             @PathVariable(value=&quot;id&quot;) String id,
1362             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1363             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1364         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1365                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1366     }
1367 
1368     /**
<abbr title="1369      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1369      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1370      *
1371      * @param request
1372      * @param response
1373      * @param model
1374      * @param pathVars
1375      * @param id
1376      * @param collectionField
1377      * @param collectionItemId
1378      * @return the return view path
1379      * @throws Exception
1380      */
<abbr title="1381     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1381     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1382     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1382     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1383             @PathVariable  Map&lt;String, String&gt; pathVars,
1384             @PathVariable(value=&quot;id&quot;) String id,
1385             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1386             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1387             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1388         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1388         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1389                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1390 
1391         // Since this is a read-only view, actions don&#x27;t make sense in this context
1392         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1393         addAuditableDisplayFields(ef);
1394         ef.removeAllActions();
1395         ef.setReadOnly();
1396 
1397         return returnPath;
1398     }
1399 
<abbr title="1400     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1400     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1401     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1401     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1402             @PathVariable  Map&lt;String, String&gt; pathVars,
1403             @PathVariable(value=&quot;id&quot;) String id,
1404             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1405             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1406         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1406         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1407                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1408 
1409         // Since this is a read-only view, actions don&#x27;t make sense in this context
1410         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1411         ef.removeAllActions();
1412         ef.setReadOnly();
1413 
1414         return returnPath;
1415     }
1416 
<abbr title="1417     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1417     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1418             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1418             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1419         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1419         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1420     }
1421 
<abbr title="1422     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1422     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1423             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1423             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1424         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1424         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1425     }
1426 
<abbr title="1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1427     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1428                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1428                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1429         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1430     }
1431 
1432     /**
<abbr title="1433      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1433      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1434      * which are optional. If they are not passed in then they are automatically looked up
1435      *
1436      * @param request
1437      * @param model
1438      * @param pathVars
1439      * @param id
1440      * @param collectionField
1441      * @param collectionItemId
1442      * @param modalHeaderType
1443      * @param entityForm
1444      * @param entity
1445      * @return
1446      * @throws ServiceException
1447      */
<abbr title="1448     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars, String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1448     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
1449         String sectionKey = getSectionKey(pathVars);
1450         String mainClassName = getClassNameForSection(sectionKey);
1451         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1452         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1452         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1453         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1454         FieldMetadata md = collectionProperty.getMetadata();
1455         SectionCrumb nextCrumb = new SectionCrumb();
1456         if (md instanceof MapMetadata) {
1457             nextCrumb.setSectionIdentifier(((MapMetadata) (md)).getValueClassName());
1458         } else {
1459             nextCrumb.setSectionIdentifier(((CollectionMetadata) (md)).getCollectionCeilingEntity());
1460         }
1461         nextCrumb.setSectionId(collectionItemId);
1462         if (!sectionCrumbs.contains(nextCrumb)) {
1463             sectionCrumbs.add(nextCrumb);
1464         }
<abbr title="1465         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1465         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1466         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1466         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1467         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1468         if ((md instanceof BasicCollectionMetadata) &amp;&amp; (((BasicCollectionMetadata) (md)).getAddMethodType().equals(AddMethodType.PERSIST) || ((BasicCollectionMetadata) (md)).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1468         if ((md instanceof BasicCollectionMetadata) &amp;&amp; (((BasicCollectionMetadata) (md)).getAddMethodTypeðŸ”µ</abbr>
1469             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
<abbr title="1470             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1470             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1471             if (entity == null) {
<abbr title="1472                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1472                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1473             }
1474             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1475             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1475             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1476             if (entityForm == null) {
<abbr title="1477                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1477                 entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectðŸ”µ</abbr>
1478             } else {
1479                 entityForm.clearFieldsMap();
<abbr title="1480                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1480                 formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, secðŸ”µ</abbr>
1481                 // remove all the actions since we&#x27;re not trying to redisplay them on the form
1482                 entityForm.removeAllActions();
1483             }
1484             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1485             addAuditableDisplayFields(entityForm);
1486             model.addAttribute(&quot;entityForm&quot;, entityForm);
1487             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1488         } else if (md instanceof AdornedTargetCollectionMetadata) {
1489             AdornedTargetCollectionMetadata fmd = ((AdornedTargetCollectionMetadata) (md));
1490             if (entity == null) {
<abbr title="1491                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];">1491                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1492             }
1493             boolean populateTypeAndId = true;
<abbr title="1494             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1494             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1495             if (entityForm == null) {
<abbr title="1496                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1496                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1497                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1498                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1499             } else {
1500                 entityForm.clearFieldsMap();
1501                 String entityType = entityForm.getEntityType();
<abbr title="1502                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1502                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1503                 entityForm.setEntityType(entityType);
1504                 populateTypeAndId = false;
1505             }
1506             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1507             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id, collectionField, collectionItemId, responseMap);">1507             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
<abbr title="1508             // For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1508             // For AdornedTargetCollections, we need to be specific on what translation ceilingEntity andðŸ”µ</abbr>
<abbr title="1509             // It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1509             // It should be the entity and referenced Id of the adorned entity (not the target entity andðŸ”µ</abbr>
1510             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1511             entityForm.setTranslationId(alternateId);
1512             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1513             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1514                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1515                     continue;
1516                 }
1517                 Property p = cmd.getPMap().get(field);
1518                 if ((p != null) &amp;&amp; (p.getMetadata() instanceof AdornedTargetCollectionMetadata)) {
<abbr title="1519                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1519                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1520                     // directly on the first adorned target collection. Because of this, we need the actual id property">1520                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1521                     // from the entity that models the adorned target relationship, and not the id of the target object.">1521                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1522                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1522                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1523                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null, alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();">1523                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
<abbr title="1524                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p, ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);">1524                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1525                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1526                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1527                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1527                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1528                     } else {
<abbr title="1529                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1529                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1530                     }
1531                 } else if ((p != null) &amp;&amp; (p.getMetadata() instanceof MapMetadata)) {
1532                     // See above comment for AdornedTargetCollectionMetadata
1533                     MapMetadata mmd = ((MapMetadata) (p.getMetadata()));
<abbr title="1534                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1534                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1535                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null, alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();">1535                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
<abbr title="1536                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p, mmd.getTargetClass(), sectionCrumbs);">1536                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1537                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1538                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1539                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1539                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1540                     } else {
<abbr title="1541                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1541                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1542                     }
1543                 }
1544             }
<abbr title="1545             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1545             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1546             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1547             boolean atLeastOneBasicField = false;
1548             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1549                 if ((entry.getValue().getIsVisible() &amp;&amp; (!responseMap.containsKey(entry.getValue().getName()))) &amp;&amp; (!responseMap.containsKey(&quot;autoSubmit&quot;))) {">1549                 if ((entry.getValue().getIsVisible() &amp;&amp; (!responseMap.containsKey(entry.getValue().getNamðŸ”µ</abbr>
1550                     atLeastOneBasicField = true;
1551                     break;
1552                 }
1553             }
1554             if (!atLeastOneBasicField) {
1555                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1556             }
1557             addAuditableDisplayFields(entityForm);
1558             model.addAttribute(&quot;entityForm&quot;, entityForm);
1559             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1560         } else if (md instanceof MapMetadata) {
1561             MapMetadata fmd = ((MapMetadata) (md));
<abbr title="1562             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1562             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1563             if (entity == null) {
<abbr title="1564                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty, collectionItemId, sectionCrumbs, null).getEntity();">1564                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1565             }
1566             boolean populateTypeAndId = true;
1567             if (entityForm == null) {
<abbr title="1568                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1568                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1569             } else {
1570                 // save off the prior key before clearing out the fields map as it will not appear
1571                 // back on the saved entity
1572                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1573                 entityForm.clearFieldsMap();
1574                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1575                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1576                 populateTypeAndId = false;
1577             }
1578 
1579 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1580             if (entityForm.getCeilingEntityClassname() == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1581                 entityForm.setCeilingEntityClassname(fmd.getValueClassName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1582             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1583             entityForm.setTranslationId(collectionItemId);</span>
1584 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1585 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">1585 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
1586 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1587 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1588             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1589                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1589                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1590             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1591                 LOG.error(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1592             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1593             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValue());">1593             entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValueðŸ”µ</abbr></span>
1594 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
1595 
<abbr title="1596             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1596             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1597             formService.populateMapEntityFormFields(entityForm, entity);
1598             addAuditableDisplayFields(entityForm);
1599             model.addAttribute(&quot;entityForm&quot;, entityForm);
1600             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1601         }
1602         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1603         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1604         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1605         setModelAttributes(model, sectionKey);
1606         return &quot;modules/modalContainer&quot;;
1607     }
1608 
1609     /**
1610      * Updates the specified collection item
1611      *
1612      * @param request
1613      * @param response
1614      * @param model
1615      * @param pathVars
1616      * @param id
1617      * @param collectionField
<abbr title="1618      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1618      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1619      * @param entityForm
1620      * @param result
1621      * @return the return view path
1622      * @throws Exception
1623      */
1624     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1625     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1625     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1626             @PathVariable  Map&lt;String, String&gt; pathVars,
1627             @PathVariable(value=&quot;id&quot;) String id,
1628             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1629             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1630             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1631             BindingResult result) throws Exception {
<abbr title="1632         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1632         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1633     }
1634 
1635     /**
1636      * Updates the specified collection item
1637      *
1638      * @param request
1639      * @param response
1640      * @param model
1641      * @param pathVars
1642      * @param id
1643      * @param collectionField
<abbr title="1644      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1644      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1645      * @param entityForm
<abbr title="1646      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1646      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1647      * @param result
1648      * @return the return view path
1649      * @throws Exception
1650      */
<abbr title="1651     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1651     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1652     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1652     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1653             @PathVariable  Map&lt;String, String&gt; pathVars,
1654             @PathVariable(value=&quot;id&quot;) String id,
1655             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1656             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1657             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1658             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1659             BindingResult result) throws Exception {
1660         String sectionKey = getSectionKey(pathVars);
1661         String mainClassName = getClassNameForSection(sectionKey);
1662         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1663         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1663         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1664         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1665 
<abbr title="1666         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1666         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1667         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1667         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1668         service.clearEntityManager();
1669         // First, we must save the collection entity
<abbr title="1670         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1670         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1671         Entity savedEntity = persistenceResponse.getEntity();
1672         entityFormValidator.validate(entityForm, savedEntity, result);
1673 
1674         if (result.hasErrors()) {
<abbr title="1675             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1675             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1676                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1677         }
1678 
1679         // Next, we must get the new list grid that represents this collection
1680         // We return the new list grid so that it can replace the currently visible one
<abbr title="1681         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1681         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1682 
1683         model.addAttribute(&quot;listGrid&quot;, listGrid);
1684         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1685         setModelAttributes(model, sectionKey);
1686         return &quot;views/standaloneListGrid&quot;;
1687     }
1688 
<abbr title="1689     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1689     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1690     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1691             HttpServletResponse response, Model model,
1692             @PathVariable  Map&lt;String, String&gt; pathVars,
1693             @PathVariable(value=&quot;id&quot;) String id,
1694             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1695             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1696             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1697         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1697         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1698     }
1699 
1700     /**
<abbr title="1701      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1701      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1702      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1702      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1703      *
1704      * @param request
1705      * @param response
1706      * @param model
1707      * @param pathVars
1708      * @param id
1709      * @param collectionField
1710      * @param collectionItemId
1711      * @return an object explaining the state of the operation
1712      * @throws Exception
1713      */
<abbr title="1714     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1714     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1715     @ResponseBody
<abbr title="1716     public Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable">1716     public Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request, HttpServletResponðŸ”µ</abbr>
1717     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
1718     String id, @PathVariable(&quot;collectionField&quot;)
1719     String collectionField, @PathVariable(&quot;collectionItemId&quot;)
1720     String collectionItemId, @RequestParam(&quot;newSequence&quot;)
1721     String newSequence, @PathVariable(&quot;alternateId&quot;)
1722     String alternateId) throws Exception {
1723         String sectionKey = getSectionKey(pathVars);
1724         String mainClassName = getClassNameForSection(sectionKey);
1725         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1726         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1726         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1727         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1728         FieldMetadata md = collectionProperty.getMetadata();
<abbr title="1729         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1729         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1730         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
<abbr title="1731         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1731         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1732         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1733         if (md instanceof AdornedTargetCollectionMetadata) {
1734             AdornedTargetCollectionMetadata fmd = ((AdornedTargetCollectionMetadata) (md));
1735             AdornedTargetList atl = ppr.getAdornedList();
1736             // Get an entity form for the entity
<abbr title="1737             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1737             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1738             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, new String[]{ &quot;reorderChildEntityFetch&quot; }).getDynamicResultSet().getRecords()[0];">1738             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
1739             formService.populateEntityFormFields(entityForm, entity);
1740             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
<abbr title="1741             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1741             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1742             int sequenceValue = Integer.parseInt(newSequence) + 1;
1743             Field field = entityForm.findField(atl.getSortField());
1744             field.setValue(String.valueOf(sequenceValue));
1745             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1746             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1746             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1747             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1748             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1749             responseMap.put(&quot;field&quot;, collectionField);
1750             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1751             return responseMap;
1752         } else if (md instanceof BasicCollectionMetadata) {
1753             BasicCollectionMetadata cd = ((BasicCollectionMetadata) (md));
1754             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1755             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1755             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
<abbr title="1756             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1756             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1757             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="1758             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1758             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
1759             if (listGridReadOnly) {
1760                 throw new SecurityServiceException();
1761             }
1762             if (!StringUtils.isEmpty(cd.getSortProperty())) {
<abbr title="1763                 Field f = new Field().withName(cd.getSortProperty()).withFieldType(SupportedFieldType.HIDDEN.toString());">1763                 Field f = new Field().withName(cd.getSortProperty()).withFieldType(SupportedFieldType.HIDðŸ”µ</abbr>
1764                 entityForm.addHiddenField(mainMetadata, f);
1765             }
1766             formService.populateEntityFormFields(entityForm, entity);
1767             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1768                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1769                 Field field = entityForm.findField(cd.getSortProperty());
1770                 field.setValue(String.valueOf(sequenceValue));
1771             }
<abbr title="1772             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1772             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1773             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1774             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1775             responseMap.put(&quot;field&quot;, collectionField);
1776             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1777             return responseMap;
1778         } else {
<abbr title="1779             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1779             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1780         }
1781     }
1782 
1783     /**
1784      * Removes the requested collection item
1785      *
<abbr title="1786      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1786      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1787      * map collection.
1788      *
1789      * @param request
1790      * @param response
1791      * @param model
1792      * @param pathVars
1793      * @param id
1794      * @param collectionField
1795      * @param collectionItemId
1796      * @return the return view path
1797      * @throws Exception
1798      */
<abbr title="1799     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1799     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1800     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1800     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1801             @PathVariable  Map&lt;String, String&gt; pathVars,
1802             @PathVariable(value=&quot;id&quot;) String id,
1803             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1804             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1805         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1805         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1806     }
1807 
1808     /**
1809      * Removes the requested collection item
1810      *
<abbr title="1811      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1811      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1812      * map collection.
1813      *
1814      * @param request
1815      * @param response
1816      * @param model
1817      * @param pathVars
1818      * @param id
1819      * @param collectionField
1820      * @param collectionItemId
1821      * @return the return view path
1822      * @throws Exception
1823      */
<abbr title="1824     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1824     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1825     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1825     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1826             @PathVariable  Map&lt;String, String&gt; pathVars,
1827             @PathVariable(value=&quot;id&quot;) String id,
1828             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1829             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1830             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1831         String sectionKey = getSectionKey(pathVars);
1832         String mainClassName = getClassNameForSection(sectionKey);
1833         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1834         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1834         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1835         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1836 
1837         String priorKey = request.getParameter(&quot;key&quot;);
1838 
<abbr title="1839         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1839         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1840         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1841         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1841         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1842         service.clearEntityManager();
1843         // First, we must remove the collection entity
<abbr title="1844         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1844         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1845         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1845         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1846             String error = &quot;There was an error removing the whatever&quot;;
1847             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1848                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1849                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1849                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1850             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1850             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1851                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1852             }
1853             return new JsonResponse(response)
1854                 .with(&quot;status&quot;, &quot;error&quot;)
1855                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1856                 .done();
1857         }
1858 
1859         // Next, we must get the new list grid that represents this collection
1860         // We return the new list grid so that it can replace the currently visible one
<abbr title="1861         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1861         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1862 
1863         model.addAttribute(&quot;listGrid&quot;, listGrid);
1864         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1865         setModelAttributes(model, sectionKey);
1866         return &quot;views/standaloneListGrid&quot;;
1867     }
1868 
1869     public void addAuditableDisplayFields(EntityForm entityForm) {
1870         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1871         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1872             addAuditableDisplayField(entityForm, createdBy);
1873 
1874             createdBy.setIsVisible(false);
1875         }
1876         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1877         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1878             addAuditableDisplayField(entityForm, updatedBy);
1879 
1880             updatedBy.setIsVisible(false);
1881         }
1882     }
1883 
1884     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1885         Field displayField = buildAuditableDisplayField(userField);
1886 
1887         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1888         String userName = user == null ? null : user.getName();
1889         displayField.setValue(userName);
1890 
1891         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1892         if (auditGroup != null) {
1893             auditGroup.addField(displayField);
1894         }
1895     }
1896 
1897     private Field buildAuditableDisplayField(Field auditableField) {
1898         return new Field().withFieldType(SupportedFieldType.STRING.toString())
1899                 .withName(auditableField.getName() + &quot;Display&quot;)
1900                 .withFriendlyName(auditableField.getFriendlyName())
1901                 .withOrder(auditableField.getOrder())
1902                 .withOwningEntityClass(auditableField.getOwningEntityClass())
1903                 .withReadOnly(true);
1904     }
1905 
1906     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1907         String tabName = pathVars.get(&quot;tabName&quot;);
1908         if (StringUtils.isBlank(tabName)) {
1909             TabMetadata firstTab = cmd.getFirstTab();
1910             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1911         }
1912         return tabName;
1913     }
1914 
1915     // *****************************************
1916     // Typed Entity Helper Methods
1917     // *****************************************
1918 
1919     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1920         // Check if this is a typed entity
1921         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1922         if (typedEntitySection != null) {
1923             // Update the friendly name for this Entity Type
1924             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1925         }
1926     }
1927 
1928     // *********************************
1929     // ADDITIONAL SPRING-BOUND METHODS *
1930     // *********************************
1931 
1932     /**
<abbr title="1933      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">1933      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="1934      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1934      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
1935      * or false. If the value is passed in as null, it will treat it as false.
1936      *
1937      * @param binder
1938      */
1939     @InitBinder
1940     public void initBinder(WebDataBinder binder) {
1941         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
1942         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
1943     }
1944 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  30  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  31  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  32  import org.broadleafcommerce.common.util.BLCArrayUtils;
  33  import org.broadleafcommerce.common.util.BLCMessageUtils;
  34  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  35  import org.broadleafcommerce.common.web.JsonResponse;
  36  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  37  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  38  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  40  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  41  import org.broadleafcommerce.openadmin.dto.ClassTree;
  42  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  43  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  44  import org.broadleafcommerce.openadmin.dto.Entity;
  45  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  46  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  47  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  48  import org.broadleafcommerce.openadmin.dto.Property;
  49  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  52  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  53  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  54  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  55  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  56  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  57  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  60  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  61  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  62  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  63  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  64  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  65  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  66  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  67  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  68  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  69  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  70  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  71  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  72  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  73  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  74  import org.springframework.stereotype.Controller;
  75  import org.springframework.ui.Model;
  76  import org.springframework.util.MultiValueMap;
  77  import org.springframework.validation.BindingResult;
  78  import org.springframework.web.bind.WebDataBinder;
  79  import org.springframework.web.bind.annotation.InitBinder;
  80  import org.springframework.web.bind.annotation.ModelAttribute;
  81  import org.springframework.web.bind.annotation.PathVariable;
  82  import org.springframework.web.bind.annotation.RequestMapping;
  83  import org.springframework.web.bind.annotation.RequestMethod;
  84  import org.springframework.web.bind.annotation.RequestParam;
  85  import org.springframework.web.bind.annotation.ResponseBody;
  86  import org.springframework.web.servlet.DispatcherServlet;
  87  import org.springframework.web.servlet.FlashMap;
  88  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  89  import org.springframework.web.util.UrlPathHelper;
  90  import com.fasterxml.jackson.databind.ObjectMapper;
  91  
  92  import java.net.URLDecoder;
  93  import java.util.ArrayList;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +import java.util.Arrays;</span>
  95  import java.util.HashMap;
  96  import java.util.List;
  97  import java.util.Map;
  98  import java.util.Map.Entry;
  99  import java.util.Set;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +import java.util.stream.Stream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +</span>
 102  import javax.annotation.Resource;
 103  import javax.servlet.http.HttpServletRequest;
 104  import javax.servlet.http.HttpServletResponse;
 105  
 106  /**
<abbr title=" 107   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 107   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr>
<abbr title=" 108   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 108   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr>
 109   * that is not explicitly customized by its own controller.
 110   *
 111   * @author Andre Azzolini (apazzolini)
 112   * @author Jeff Fischer
 113   */
 114  @Controller(&quot;blAdminBasicEntityController&quot;)
 115  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 116  public class AdminBasicEntityController extends AdminAbstractController {
 117  
 118      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 119  
 120      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 121      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 122      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 123  
 124      @Resource(name=&quot;blSandBoxHelper&quot;)
 125      protected SandBoxHelper sandBoxHelper;
 126  
 127      @Resource(name = &quot;blAdminUserDao&quot;)
 128      protected AdminUserDao adminUserDao;
 129  
 130      @Resource(name=&quot;blDynamicEntityDao&quot;)
 131      protected DynamicEntityDao dynamicEntityDao;
 132  
 133      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 134      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 135  
 136      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 137      protected RowLevelSecurityService rowLevelSecurityService;
 138  
 139      // ******************************************
 140      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 141      // ******************************************
 142  
 143      /**
<abbr title=" 144       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 144       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 145       * criteria.
 146       *
 147       * @param request
 148       * @param response
 149       * @param model
 150       * @param pathVars
 151       * @param requestParams a Map of property name -&gt; list critiera values
 152       * @return the return view path
 153       * @throws Exception
 154       */
 155      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 156      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 157              @PathVariable Map&lt;String, String&gt; pathVars,
 158              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 159          String sectionKey = getSectionKey(pathVars);
 160          String sectionClassName = getClassNameForSection(sectionKey);
 161          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 162          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 162          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 163          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 164          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 165  
 166          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 167          listGrid.setSelectType(ListGrid.SelectType.NONE);
 168  
 169          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 170          if (CollectionUtils.isNotEmpty(headerFields)) {
 171              Field firstField = headerFields.iterator().next();
 172              if (requestParams.containsKey(firstField.getName())) {
 173                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 174              }
 175          }
 176  
 177          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 178  
 179          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 180          model.addAttribute(&quot;listGrid&quot;, listGrid);
 181  
 182          return &quot;modules/defaultContainer&quot;;
 183      }
 184  
 185      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 186              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 187          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 188          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 189          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 190          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 191  
 192          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 193          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 194              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 195          }
 196  
 197          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 198          String requestUri = request.getRequestURI();
 199          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 200              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 201          }
 202  
 203          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 204          model.addAttribute(&quot;currentUri&quot;, requestUri);
 205          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 206          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 207          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 208          model.addAttribute(&quot;mainActions&quot;, mainActions);
 209          setModelAttributes(model, sectionKey);
 210          setTypedEntityModelAttributes(request, model);
 211      }
 212  
 213      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 214      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 215               HttpServletResponse response, Model model,
 216               @PathVariable Map&lt;String, String&gt; pathVars,
 217               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 218          String sectionKey = getSectionKey(pathVars);
 219          String sectionClassName = getClassNameForSection(sectionKey);
 220          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 221          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 221          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 222                  .withCustomCriteria(getCustomCriteria(requestParams));
 223  
 224          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 225  
 226          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 227          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 228  
 229          return formService.constructSelectizeOptionMap(drs, cmd);
 230      }
 231  
 232      /**
 233       * Obtains the requested criteria parameter
 234       *
 235       * @param requestParams
 236       * @return
 237       */
 238      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 239          if (requestParams == null || requestParams.isEmpty()) {
 240              return null;
 241          }
 242  
 243          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 244          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 245          return new String[] {response};
 246      }
 247  
 248      /**
 249       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 250       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 251       *
 252       * @param sectionClassName
 253       * @param cmd
 254       * @param mainActions
 255       */
<abbr title=" 256      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 256      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 257          if (isAddActionAllowed(sectionClassName, cmd)) {
 258              mainActions.add(DefaultMainActions.ADD);
 259          }
 260      }
 261  
 262      protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {
 263          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 264          boolean canCreate = true;
 265          try {
 266              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 267          } catch (ServiceException e) {
 268              if (e instanceof SecurityServiceException) {
 269                  canCreate = false;
 270              }
 271          }
 272  
 273          if (canCreate) {
 274              checkReadOnly: {
 275                  //check if all the metadata is read only
 276                  for (Property property : cmd.getProperties()) {
 277                      if (property.getMetadata() instanceof BasicFieldMetadata) {
 278                          if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 279                                  !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 280                              break checkReadOnly;
 281                          }
 282                      }
 283                  }
 284                  canCreate = false;
 285              }
 286          }
 287  
 288          if (canCreate) {
<abbr title=" 289              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 289              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr>
 290          }
 291  
 292          return canCreate;
 293      }
 294  
 295      /**
 296       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 297       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 297       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 298       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 298       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 299       * they can then perform operations on sub collections.
 300       *
 301       * @param request
 302       * @param response
 303       * @param model
 304       * @param pathVars
 305       * @param entityType
 306       * @return the return view path
 307       * @throws Exception
 308       */
 309      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 310      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 311              @PathVariable  Map&lt;String, String&gt; pathVars,
 312              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 313          String sectionKey = getSectionKey(pathVars);
 314          String sectionClassName = getClassNameForSection(sectionKey);
 315          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 316          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 316          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 317          ppr.setAddOperationInspect(true);
 318          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 319  
<abbr title=" 320          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 320          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr>
 321          if (StringUtils.isBlank(entityType)) {
 322              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 323                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 324              } else {
 325                  entityType = getDefaultEntityType();
 326              }
 327          } else {
 328              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 329          }
 330  
 331          EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 332  
 333          // We need to make sure that the ceiling entity is set to the interface and the specific entity type
 334          // is set to the type we&#x27;re going to be creating.
 335          entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 336          entityForm.setEntityType(entityType);
 337  
 338          // When we initially build the class metadata (and thus, the entity form), we had all of the possible
 339          // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the
 340          // fields that are not applicable for this given entity type.
 341          formService.removeNonApplicableFields(cmd, entityForm, entityType);
 342  
 343          modifyAddEntityForm(entityForm, pathVars);
 344  
 345          model.addAttribute(&quot;entityForm&quot;, entityForm);
 346          model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 347  
 348          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 349          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 350          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 351          setModelAttributes(model, sectionKey);
 352          return &quot;modules/modalContainer&quot;;
 353      }
 354  
 355      /**
 356       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 357       *
 358       * @param request
 359       * @param response
 360       * @param model
 361       * @param pathVars
 362       * @param entityForm
 363       * @param result
 364       * @return the return view path
 365       * @throws Exception
 366       */
 367      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 368      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 369              @PathVariable  Map&lt;String, String&gt; pathVars,
 370              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 371          String sectionKey = getSectionKey(pathVars);
 372          String sectionClassName = getClassNameForSection(sectionKey);
 373          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 374          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 374          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 375  
 376          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 377          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 377          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 378          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 379          entityFormValidator.validate(entityForm, entity, result);
 380  
 381          if (result.hasErrors()) {
 382              entityForm.clearFieldsMap();
 383              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 384  
 385              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 386  
 387              modifyAddEntityForm(entityForm, pathVars);
 388  
 389              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 390              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 391              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 392              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 393              setModelAttributes(model, sectionKey);
 394              return &quot;modules/modalContainer&quot;;
 395          }
 396  
 397          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 398          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 398          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>
 399      }
 400  
 401      /**
 402       * Renders the main entity form for the specified entity
 403       *
 404       * @param request
 405       * @param response
 406       * @param model
 407       * @param pathVars
 408       * @param id
 409       * @return the return view path
 410       * @throws Exception
 411       */
 412      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 413      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 414              @PathVariable  Map&lt;String, String&gt; pathVars,
 415              @PathVariable(&quot;id&quot;) String id) throws Exception {
 416          String sectionKey = getSectionKey(pathVars);
 417          String sectionClassName = getClassNameForSection(sectionKey);
 418          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 419          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 420  
 421          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 422          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 423  
 424          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 425  
 426          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 427  
 428          if (isAddRequest(entity)) {
 429              modifyAddEntityForm(entityForm, pathVars);
 430          } else {
 431              modifyEntityForm(entityForm, pathVars);
 432          }
 433  
 434          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 435              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 436          }
 437  
 438          // Set the sectionKey again incase this is a typed entity
 439          entityForm.setSectionKey(sectionKey);
 440  
 441          // Build the current url in the cast that this is a typed entity
 442          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 443          int startIndex = request.getContextPath().length();
 444  
 445          // Remove the context path from servlet path
 446          String currentUrl = originatingUri.substring(startIndex);
 447  
 448          model.addAttribute(&quot;entity&quot;, entity);
 449          model.addAttribute(&quot;entityForm&quot;, entityForm);
 450          model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 451  
 452          setModelAttributes(model, sectionKey);
 453  
 454          // We want to replace author ids with their names
 455          addAuditableDisplayFields(entityForm);
 456  
 457          if (isAjaxRequest(request)) {
 458              entityForm.setReadOnly();
 459              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 460              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 461              return &quot;modules/modalContainer&quot;;
 462          } else {
 463              model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 464              model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 465              return &quot;modules/defaultContainer&quot;;
 466          }
 467      }
 468  
<abbr title=" 469      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 469      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 470                                                                ClassMetadata cmd, Entity entity,
 471                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 472          String tabName = pathVars.get(&quot;tabName&quot;);
 473          if (StringUtils.isEmpty(tabName)) {
 474              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 475          }
 476          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 477      }
 478  
 479      private boolean isAddRequest(Entity entity) {
 480          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 481          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 482          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 483              return false;
 484          }
 485  
 486          return resultHolder.getResult();
 487      }
 488  
 489      /**
 490       * Attempts to get the List Grid for the selected tab.
 491       *
 492       * @param request
 493       * @param response
 494       * @param model
 495       * @param pathVars
 496       * @param id
 497       * @param tabName
 498       * @param entityForm
 499       * @param entity
 500       * @return the return view path
 501       * @throws Exception
 502       */
 503      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 504      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 505              @PathVariable Map&lt;String, String&gt; pathVars,
 506              @PathVariable(value = &quot;id&quot;) String id,
 507              @PathVariable(value = &quot;tabName&quot;) String tabName,
 508              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 509              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 510          String sectionKey = getSectionKey(pathVars);
 511          String sectionClassName = getClassNameForSection(sectionKey);
 512          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 513          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 514          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 515          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 516          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 517          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 518  
 519          if (isAddRequest(entity)) {
 520              modifyAddEntityForm(entityForm, pathVars);
 521          } else {
 522              modifyEntityForm(entityForm, pathVars);
 523          }
 524  
 525          model.addAttribute(&quot;entity&quot;, entity);
 526          model.addAttribute(&quot;entityForm&quot;, entityForm);
 527          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 528  
 529          setModelAttributes(model, sectionKey);
 530  
 531          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 532          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 533          return &quot;modules/defaultContainer&quot;;
 534      }
 535  
 536      /**
 537       * Builds JSON that looks like this:
 538       *
 539       * {&quot;errors&quot;:
 540       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 541       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 542       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 543       *        &quot;errorType&quot;, &quot;field&quot;,
 544       *        &quot;tab&quot;: &quot;General&quot;
 545       *        },
 546       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 547       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 548       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 549       *        &quot;errorType&quot;, &quot;field&quot;,
 550       *        &quot;tab&quot;: &quot;General&quot;
 551       *        }]
 552       * }
 553       *
 554       */
 555      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 556      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 557              @PathVariable Map&lt;String, String&gt; pathVars,
 558              @PathVariable(value = &quot;id&quot;) String id,
 559              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 560              RedirectAttributes ra) throws Exception {
 561  
 562          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 563  
 564          JsonResponse json = new JsonResponse(response);
 565          if (result.hasErrors()) {
 566              populateJsonValidationErrors(entityForm, result, json);
 567          }
 568          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 569          if (CollectionUtils.isNotEmpty(dirtyList)) {
 570              json.with(&quot;dirty&quot;, dirtyList);
 571          }
 572  
 573          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 574          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 574          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 575          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 576              return resultHolder.getResult();
 577          }
 578  
 579          return json.done();
 580      }
 581  
<abbr title=" 582      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 582      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 583          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 584          String sectionKey = getSectionKey(pathVars);
 585          String sectionClassName = getClassNameForSection(sectionKey);
 586          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 587          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 587          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 588          ClassMetadata cmd = null;
 589          Entity entity = null;
 590          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 591          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 592  
 593          for (Property p: entity.getProperties()) {
 594              if (p.getIsDirty()) {
 595                  dirtyList.add(p.getName());
 596              }
 597          }
 598          return dirtyList;
 599      }
 600  
 601      /**
 602       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 603       * error fields highlighted. On a successful save, it will refresh the entity page.
 604       *
 605       * @param request
 606       * @param response
 607       * @param model
 608       * @param pathVars
 609       * @param id
 610       * @param entityForm
 611       * @param result
 612       * @return the return view path
 613       * @throws Exception
 614       */
 615      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 616      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 617              @PathVariable  Map&lt;String, String&gt; pathVars,
 618              @PathVariable(value=&quot;id&quot;) String id,
 619              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620              RedirectAttributes ra) throws Exception {
 621          String sectionKey = getSectionKey(pathVars);
 622          String sectionClassName = getClassNameForSection(sectionKey);
 623          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 624          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 624          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 625          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 626  
 627          extractDynamicFormFields(cmd, entityForm);
 628  
<abbr title=" 629          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 629          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 630          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 631  
 632          entityFormValidator.validate(entityForm, entity, result);
 633          if (result.hasErrors()) {
 634              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 635              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 636  
<abbr title=" 637              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 637              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 638              entityForm.clearFieldsMap();
 639              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 640  
 641              if (isAddRequest(entity)) {
 642                  modifyAddEntityForm(entityForm, pathVars);
 643              } else {
 644                  modifyEntityForm(entityForm, pathVars);
 645              }
 646  
 647              model.addAttribute(&quot;entity&quot;, entity);
 648              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 649  
 650              setModelAttributes(model, sectionKey);
 651  
 652              if (isAjaxRequest(request)) {
 653                  entityForm.setReadOnly();
 654                  model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 655                  model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 656                  return &quot;modules/modalContainer&quot;;
 657              } else {
 658                  model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 659                  model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 660                  return &quot;modules/defaultContainer&quot;;
 661              }
 662          }
 663  
 664          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 665  
 666          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 667      }
 668  
 669      /**
 670       * Attempts to remove the given entity.
 671       *
 672       * @param request
 673       * @param response
 674       * @param model
 675       * @param pathVars
 676       * @param id
 677       * @return the return view path
 678       * @throws Exception
 679       */
 680      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 681      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 682              @PathVariable  Map&lt;String, String&gt; pathVars,
 683              @PathVariable(value=&quot;id&quot;) String id,
 684              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685              RedirectAttributes ra) throws Exception {
 686          String sectionKey = getSectionKey(pathVars);
 687          String sectionClassName = getClassNameForSection(sectionKey);
 688          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 689  
<abbr title=" 690          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 690          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 691          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 692          // Removal does not normally return an Entity unless there is some validation error
 693          if (entity != null) {
 694              entityFormValidator.validate(entityForm, entity, result);
 695              if (result.hasErrors()) {
 696                  // Create a flash attribute for the unsuccessful delete
 697                  FlashMap fm = new FlashMap();
 698                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 699                  fm.put(&quot;headerFlashAlert&quot;, true);
 700                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 701  
 702                  // Re-look back up the entity so that we can return something populated
<abbr title=" 703                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 703                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 704                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 705                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 706                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 706                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 707                  entityForm.clearFieldsMap();
 708                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 709                  modifyEntityForm(entityForm, pathVars);
 710  
 711                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 712                          .done();
 713              }
 714          }
 715  
 716          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 717          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 718  
 719          if (isAjaxRequest(request)) {
 720              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 721              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 722          } else {
 723              return &quot;redirect:/&quot; + sectionKey;
 724          }
 725      }
 726  
 727      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 728      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 728      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 729              @PathVariable  Map&lt;String, String&gt; pathVars,
 730              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 731              @RequestParam String ids,
 732              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 733          String sectionKey = getSectionKey(pathVars);
 734          String sectionClassName = getClassNameForSection(sectionKey);
 735          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 736          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 736          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 737          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 738          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 739          FieldMetadata md = collectionProperty.getMetadata();
 740  
 741          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 742          ppr.setStartIndex(getStartIndex(requestParams));
 743          ppr.setMaxIndex(getMaxIndex(requestParams));
 744  
 745          if (md instanceof BasicFieldMetadata) {
 746              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 747              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 748  
 749              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 750              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 751  
 752              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 753              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 754  
 755              for (Entity e : drs.getRecords()) {
 756                  String id = e.getPMap().get(idProp).getValue();
 757                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 758  
 759                  if (StringUtils.isBlank(disp)) {
 760                      disp = e.getPMap().get(displayProp).getValue();
 761                  }
 762  
 763                  returnMap.put(id,  disp);
 764              }
 765  
 766              return returnMap;
 767          }
 768  
 769          return null;
 770      }
 771  
 772      /**
<abbr title=" 773       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 773       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 774       * then this method is invoked when a user clicks on the name of the default category field.
 775       *
 776       * @param request
 777       * @param response
 778       * @param model
 779       * @param pathVars
 780       * @param collectionField
 781       * @param id
 782       * @return
 783       * @throws Exception
 784       */
 785      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 786      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 787              @PathVariable  Map&lt;String, String&gt; pathVars,
 788              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 789              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 790          String sectionKey = getSectionKey(pathVars);
 791          String mainClassName = getClassNameForSection(sectionKey);
 792          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 793          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 793          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 794          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 795          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 796  
<abbr title=" 797          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 797          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 798          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 798          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 799          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 800          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 801          return viewEntityForm(request, response, model, varsForField, id);
 802      }
 803  
 804      @RequestMapping(
 805              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 806              method = RequestMethod.POST
 807      )
 808      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 809                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 810                                          @PathVariable(value=&quot;id&quot;) String id,
 811                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 812                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 813                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 814                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 814                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 815  
<abbr title=" 816          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 816          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 817      }
 818  
 819  
















 820      /**
 821       * Returns the records for a given collectionField filtered by a particular criteria
 822       *
 823       * @param request
 824       * @param response
 825       * @param model
 826       * @param pathVars
 827       * @param collectionField
 828       * @param requestParams
 829       * @return the return view path
 830       * @throws Exception
 831       */
 832      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
 833      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
 834              @PathVariable  Map&lt;String, String&gt; pathVars,
 835              @PathVariable(value=&quot;id&quot;) String id,
 836              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 837              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 838          String sectionKey = getSectionKey(pathVars);
 839          String mainClassName = getClassNameForSection(sectionKey);
 840          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 841          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 841          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
 842          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 843          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 844  
 845          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
 846          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
 847  
 848          // Next, we must get the new list grid that represents this collection
<abbr title=" 849          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 849          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
 850          model.addAttribute(&quot;listGrid&quot;, listGrid);
 851  
 852          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 853  
 854          // We return the new list grid so that it can replace the currently visible one
 855          setModelAttributes(model, sectionKey);
 856          return &quot;views/standaloneListGrid&quot;;
 857      }
 858  
 859      /**
<abbr title=" 860       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 860       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
 861       * of this call depending on the type of the specified collection field.
 862       *
 863       * &lt;ul&gt;
 864       *  &lt;li&gt;
<abbr title=" 865       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 865       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title=" 866       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 866       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
 867       *  &lt;/li&gt;
 868       *  &lt;li&gt;
<abbr title=" 869       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 869       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
 870       *    Used by fields such as &quot;allParentCategories&quot;.
 871       *  &lt;/li&gt;
 872       *  &lt;li&gt;
<abbr title=" 873       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 873       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title=" 874       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 874       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title=" 875       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 875       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
 876       *  &lt;/li&gt;
 877       *  &lt;li&gt;
<abbr title=" 878       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 878       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title=" 879       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 879       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title=" 880       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 880       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
 881       *    to linking an entity, provide extra fields, such as a promotional message.
 882       *  &lt;/li&gt;
 883       *  &lt;li&gt;
<abbr title=" 884       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 884       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title=" 885       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 885       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
 886       *    entity. Used by fields such as the mediaMap on a Sku.
 887       *  &lt;/li&gt;
 888       *
 889       * @param request
 890       * @param response
 891       * @param model
 892       * @param pathVars
 893       * @param id
 894       * @param collectionField
 895       * @param requestParams
 896       * @return the return view path
 897       * @throws Exception
 898       */
 899      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
 900      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
 901              @PathVariable Map&lt;String, String&gt; pathVars,
 902              @PathVariable(value = &quot;id&quot;) String id,
 903              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 904              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 905          String sectionKey = getSectionKey(pathVars);
 906          String mainClassName = getClassNameForSection(sectionKey);
 907          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 908          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
 909                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 910          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 911          FieldMetadata md = collectionProperty.getMetadata();
 912  
 913          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 914                  .withFilterAndSortCriteria(getCriteria(requestParams))
 915                  .withStartIndex(getStartIndex(requestParams))
 916                  .withMaxIndex(getMaxIndex(requestParams))
 917                  .withLastId(getLastId(requestParams))
 918                  .withFirstId(getFirstId(requestParams))
 919                  .withUpperCount(getUpperCount(requestParams))
 920                  .withLowerCount(getLowerCount(requestParams))
 921                  .withPageSize(getPageSize(requestParams))
 922                  .withPresentationFetch(true);
 923  
 924          if (md instanceof BasicCollectionMetadata) {
 925              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 926              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
 927                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 928                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
 929                  // for this entity.
 930                  String entityType = null;
 931                  if (requestParams.containsKey(&quot;entityType&quot;)) {
 932                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
 933                  }
 934                  if (StringUtils.isBlank(entityType)) {
 935                      if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 936                          entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 937                      } else {
 938                          entityType = getDefaultEntityType();
 939                      }
 940                  } else {
 941                      entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 942                  }
 943  
 944                  if (StringUtils.isBlank(entityType)) {
 945                      List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 946                      model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 947                      model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
 948                      model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 949                      String requestUri = request.getRequestURI();
<abbr title=" 950                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 950                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr>
<abbr title=" 951                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 951                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr>
 952                      }
 953                      model.addAttribute(&quot;currentUri&quot;, requestUri);
 954                      model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 955                      setModelAttributes(model, sectionKey);
 956                      return &quot;modules/modalContainer&quot;;
 957                  } else {
 958                      ppr = ppr.withCeilingEntityClassname(entityType);
 959                  }
 960              }
 961          } else if (md instanceof MapMetadata) {
<abbr title=" 962              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 962              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
 963              if (result.equals(ExtensionResultStatusType.HANDLED)) {
 964                  model.addAttribute(&quot;entityId&quot;, id);
 965                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 966                  model.addAttribute(&quot;collectionField&quot;, collectionField);
 967                  return &quot;modules/modalContainer&quot;;
 968              }
 969          }
 970  
 971          //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);
 972  
 973          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 974  
<abbr title=" 975          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 975          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>
 976      }
 977  
<abbr title=" 978      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 978      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title=" 979      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 979      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
 980              @PathVariable Map&lt;String, String&gt; pathVars,
 981              @PathVariable(value=&quot;id&quot;) String id,
 982              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 983              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
 984          String sectionKey = getSectionKey(pathVars);
 985          String mainClassName = getClassNameForSection(sectionKey);
 986          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 987          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 987          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 988          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 989          FieldMetadata md = collectionProperty.getMetadata();
 990          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
 991          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 992              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,"> 992              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
 993                      collectionField,
 994                      collectionItemId, responseMap);
 995          }
 996          return responseMap;
 997      }
 998  
 999      /**
1000       *
1001       * @param request
1002       * @param response
1003       * @param model
1004       * @param pathVars
1005       * @param id
1006       * @param collectionField
1007       * @param requestParams
1008       * @return Json collection data
1009       * @throws Exception
1010       */
1011      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1012      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1012      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1013              @PathVariable Map&lt;String, String&gt; pathVars,
1014              @PathVariable(value = &quot;id&quot;) String id,
1015              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1016              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1017          String sectionKey = getSectionKey(pathVars);
1018          String mainClassName = getClassNameForSection(sectionKey);
1019          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1020          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1021                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1022          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1023          FieldMetadata md = collectionProperty.getMetadata();
1024  
1025          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1026                  .withFilterAndSortCriteria(getCriteria(requestParams))
1027                  .withStartIndex(getStartIndex(requestParams))
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1028 -                .withMaxIndex(getMaxIndex(requestParams))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1029 -                .withCustomCriteria(buildSelectizeCustomCriteria());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1030 +                .withMaxIndex(getMaxIndex(requestParams));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1031 +        String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1031 +        String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCrðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1032 +                .toArray(String[]::new);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1033 +        ppr = ppr.withCustomCriteria( both);</span>
1034  
1035          if (md instanceof AdornedTargetCollectionMetadata) {
1036              ppr.setOperationTypesOverride(null);
1037              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1038              ppr.setSectionEntityField(collectionField);
1039          }
1040  
1041          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1042  
1043          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1044      }
1045  
1046      protected String[] buildSelectizeCustomCriteria() {
1047          return new String[]{ IS_SELECTIZE_REQUEST };
1048      }
1049  
1050      /**
1051       * Adds the requested collection item via Selectize
1052       *
1053       * @param request
1054       * @param response
1055       * @param model
1056       * @param pathVars
1057       * @param id
1058       * @param collectionField
1059       * @param entityForm
1060       * @return the return view path
1061       * @throws Exception
1062       */
1063      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1064      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1064      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1065              @PathVariable Map&lt;String, String&gt; pathVars,
1066              @PathVariable(value=&quot;id&quot;) String id,
1067              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1068              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1069          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1070          String sectionKey = getSectionKey(pathVars);
1071          String mainClassName = getClassNameForSection(sectionKey);
1072          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1073          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1073          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1074          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1075  
1076          if (StringUtils.isBlank(entityForm.getEntityType())) {
1077              FieldMetadata fmd = collectionProperty.getMetadata();
1078              if (fmd instanceof BasicCollectionMetadata) {
1079                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1080              }
1081          }
1082  
<abbr title="1083          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1083          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1084          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1085          declareShouldIgnoreAdditionStatusFilter();
1086          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1087  
1088          // First, we must save the collection entity
<abbr title="1089          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1089          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1090          Entity savedEntity = persistenceResponse.getEntity();
1091          entityFormValidator.validate(entityForm, savedEntity, result);
1092  
1093          if (result.hasErrors()) {
1094              returnVal.put(&quot;error&quot;, result.getFieldError());
1095              return returnVal;
1096          }
1097  
1098          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1099              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1100          }
1101          return returnVal;
1102      }
1103  
1104      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1105          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1105          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1106          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1107      }
1108  
1109      /**
1110       * Adds the requested collection item
1111       *
1112       * @param request
1113       * @param response
1114       * @param model
1115       * @param pathVars
1116       * @param id
1117       * @param collectionField
1118       * @param entityForm
1119       * @return the return view path
1120       * @throws Exception
1121       */
1122      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1123      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1124              @PathVariable Map&lt;String, String&gt; pathVars,
1125              @PathVariable(value=&quot;id&quot;) String id,
1126              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1127              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1128          String sectionKey = getSectionKey(pathVars);
1129          String mainClassName = getClassNameForSection(sectionKey);
1130          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1131          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1131          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1132          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1133  
1134          if (StringUtils.isBlank(entityForm.getEntityType())) {
1135              FieldMetadata fmd = collectionProperty.getMetadata();
1136              if (fmd instanceof BasicCollectionMetadata) {
1137                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1138              }
1139          }
1140  
<abbr title="1141          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1141          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1142          declareShouldIgnoreAdditionStatusFilter();
1143          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1144          service.clearEntityManager();
1145          // First, we must save the collection entity
<abbr title="1146          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1146          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1147          Entity savedEntity = persistenceResponse.getEntity();
1148          entityFormValidator.validate(entityForm, savedEntity, result);
1149  
1150          if (result.hasErrors()) {
1151              FieldMetadata md = collectionProperty.getMetadata();
1152              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1153              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1153              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1154                      md, ppr, entityForm, savedEntity);
1155          }
1156  
1157          // Next, we must get the new list grid that represents this collection
<abbr title="1158          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1158          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1159          model.addAttribute(&quot;listGrid&quot;, listGrid);
1160  
1161          // We return the new list grid so that it can replace the currently visible one
1162          model.addAttribute(&quot;actualEntityId&quot;, id);
1163          setModelAttributes(model, sectionKey);
1164          return &quot;views/standaloneListGrid&quot;;
1165      }
1166  
1167      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1168      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1168      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1169              @PathVariable Map&lt;String, String&gt; pathVars,
1170              @PathVariable(value=&quot;id&quot;) String id,
1171              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1172              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1173          String sectionKey = getSectionKey(pathVars);
1174          String mainClassName = getClassNameForSection(sectionKey);
1175          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1176          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1176          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1177          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1178  
1179          if (StringUtils.isBlank(entityForm.getEntityType())) {
1180              FieldMetadata fmd = collectionProperty.getMetadata();
1181              if (fmd instanceof BasicCollectionMetadata) {
1182                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1183              }
1184          }
1185  
<abbr title="1186          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1186          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1187          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1188          entity.setIsPreAdd(true);
1189          // First, we must save the collection entity
<abbr title="1190          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1190          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1191          Entity savedEntity = persistenceResponse.getEntity();
1192  
1193          return new JsonResponse(response)
1194                  .with(&quot;status&quot;, &quot;complete&quot;)
1195                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1196                  .done();
1197      }
1198  
1199      /**
<abbr title="1200       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1200       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1201       * as well as after a POST with validation errors
1202       *
1203       * @param request
1204       * @param model
1205       * @param id
1206       * @param collectionField
1207       * @param sectionKey
1208       * @param collectionProperty
1209       * @param md
1210       * @param ppr
1211       * @return the appropriate view to display for the modal
<abbr title="1212       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1212       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1213       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1213       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1214       * @throws ServiceException
1215       */
1216      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1217              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1218              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1218              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1219  
<abbr title="1220          // For requests to add a new collection item include the main class that the subsequent request comes from.">1220          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1221          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1221          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1222          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1223          // fixes all cases.
1224          String mainClassName = getClassNameForSection(sectionKey);
1225          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1226          ppr.setAddOperationInspect(true);
1227  
1228          if (entityForm != null) {
1229              entityForm.clearFieldsMap();
1230          }
1231          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1232          if (md instanceof BasicCollectionMetadata) {
1233              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1234  
1235              // When adding items to basic collections, we will sometimes show a form to persist a new record
1236              // and sometimes show a list grid to allow the user to associate an existing record.
1237              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1238                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1238                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1239                  if (entityForm == null) {
1240                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1241                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1242                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1243                  } else {
1244                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1245                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1246                  }
<abbr title="1247                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1247                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1248                  entityForm.getTabs().iterator().next().getIsVisible();
1249  
1250                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1251                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1252              } else {
1253                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1254                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1254                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1255                  listGrid.setPathOverride(request.getRequestURL().toString());
1256  
<abbr title="1257                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1257                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1258                      listGrid.removeAllRowActions();
1259                  }
1260  
1261                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1262                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1263              }
1264          } else if (md instanceof AdornedTargetCollectionMetadata) {
1265              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1266  
<abbr title="1267              // Even though this field represents an adorned target collection, the list we want to show in the modal">1267              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1268              // is the standard list grid for the target entity of this field
1269              ppr.setOperationTypesOverride(null);
1270              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1271              ppr.setSectionEntityField(collectionField);
1272  
<abbr title="1273              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1273              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1274  
1275              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1276              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1276              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1277              listGrid.setSubCollectionFieldName(collectionField);
1278              listGrid.setPathOverride(request.getRequestURL().toString());
1279              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1280              if (entityForm == null) {
<abbr title="1281                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1281                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1282                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1283              } else {
<abbr title="1284                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1284                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1285                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1286              }
1287  
1288              listGrid.setListGridType(ListGrid.Type.ADORNED);
1289              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1290                  if (entry.getValue().getIsVisible()) {
1291                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1292                      break;
1293                  }
1294              }
1295  
1296              // This is part of an add, so we want to be able to filter/sort the listgrid
1297              listGrid.setIsSortable(false);
1298              listGrid.setCanFilterAndSort(true);
1299              listGrid.removeAllRowActions();
1300  
1301              model.addAttribute(&quot;listGrid&quot;, listGrid);
1302              model.addAttribute(&quot;entityForm&quot;, entityForm);
1303              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1304          } else if (md instanceof MapMetadata) {
1305              MapMetadata fmd = (MapMetadata) md;
<abbr title="1306              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1306              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1307  
1308              if (entityForm == null) {
1309                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1310              } else {
1311                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1312                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1313              }
1314              model.addAttribute(&quot;entityForm&quot;, entityForm);
1315              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1316          }
1317  
1318          // Set the parent id on the entity form
1319          if (entityForm != null) {
1320              entityForm.setParentId(id);
1321          }
1322  
1323          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1324          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1325          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1326          setModelAttributes(model, sectionKey);
1327          return &quot;modules/modalContainer&quot;;
1328      }
1329  
1330      /**
1331       * Shows the appropriate modal dialog to edit the selected collection item
1332       *
1333       * @param request
1334       * @param response
1335       * @param model
1336       * @param pathVars
1337       * @param id
1338       * @param collectionField
1339       * @param collectionItemId
1340       * @return the return view path
1341       * @throws Exception
1342       */
<abbr title="1343      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1343      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1344      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1345              @PathVariable  Map&lt;String, String&gt; pathVars,
1346              @PathVariable(value=&quot;id&quot;) String id,
1347              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1348              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1349              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1350          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1350          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1351                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1352      }
1353  
1354      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1355      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1356              @PathVariable  Map&lt;String, String&gt; pathVars,
1357              @PathVariable(value=&quot;id&quot;) String id,
1358              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1359              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1360          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1361                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1362      }
1363  
1364      /**
<abbr title="1365       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1365       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1366       *
1367       * @param request
1368       * @param response
1369       * @param model
1370       * @param pathVars
1371       * @param id
1372       * @param collectionField
1373       * @param collectionItemId
1374       * @return the return view path
1375       * @throws Exception
1376       */
<abbr title="1377      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1377      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1378      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1379              @PathVariable  Map&lt;String, String&gt; pathVars,
1380              @PathVariable(value=&quot;id&quot;) String id,
1381              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1382              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1383              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1384          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1384          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1385                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1386  
1387          // Since this is a read-only view, actions don&#x27;t make sense in this context
1388          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1389          addAuditableDisplayFields(ef);
1390          ef.removeAllActions();
1391          ef.setReadOnly();
1392  
1393          return returnPath;
1394      }
1395  
1396      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1397      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1398              @PathVariable  Map&lt;String, String&gt; pathVars,
1399              @PathVariable(value=&quot;id&quot;) String id,
1400              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1401              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1402          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1402          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1403                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1404  
1405          // Since this is a read-only view, actions don&#x27;t make sense in this context
1406          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1407          ef.removeAllActions();
1408          ef.setReadOnly();
1409  
1410          return returnPath;
1411      }
1412  
<abbr title="1413      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1413      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1414              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1414              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1415          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1415          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1416      }
1417  
<abbr title="1418      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1418      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1419              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1419              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1420          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1420          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1421      }
1422  
<abbr title="1423      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1423      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1424                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1424                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1425          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1425          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1426      }
1427  
1428      /**
<abbr title="1429       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1429       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1430       * which are optional. If they are not passed in then they are automatically looked up
1431       *
1432       * @param request
1433       * @param model
1434       * @param pathVars
1435       * @param id
1436       * @param collectionField
1437       * @param collectionItemId
1438       * @param modalHeaderType
1439       * @param entityForm
1440       * @param entity
1441       * @return
1442       * @throws ServiceException
1443       */
<abbr title="1444      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1444      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1445              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1445              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
1446          String sectionKey = getSectionKey(pathVars);
1447          String mainClassName = getClassNameForSection(sectionKey);
1448          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1449          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1449          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1450          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1451          FieldMetadata md = collectionProperty.getMetadata();
1452          SectionCrumb nextCrumb = new SectionCrumb();
1453          if (md instanceof MapMetadata) {
1454              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1455          } else {
1456              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1457          }
1458          nextCrumb.setSectionId(collectionItemId);
1459          if (!sectionCrumbs.contains(nextCrumb)) {
1460              sectionCrumbs.add(nextCrumb);
1461          }
1462  
<abbr title="1463          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1463          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1464          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1464          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1465  
1466          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1467  
1468          if (md instanceof BasicCollectionMetadata &amp;&amp;
1469                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1470                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1471              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1472  
<abbr title="1473              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1473              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1474              if (entity == null) {
<abbr title="1475                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1475                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1476              }
1477  
1478              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1479              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1479              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
1480              if (entityForm == null) {
<abbr title="1481                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1481                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr>
1482              } else {
1483                  entityForm.clearFieldsMap();
<abbr title="1484                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1484                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr>
1485                  //remove all the actions since we&#x27;re not trying to redisplay them on the form
1486                  entityForm.removeAllActions();
1487              }
1488              entityForm.removeAction(DefaultEntityFormActions.DELETE);
1489              addAuditableDisplayFields(entityForm);
1490              model.addAttribute(&quot;entityForm&quot;, entityForm);
1491              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1492          } else if (md instanceof AdornedTargetCollectionMetadata) {
1493              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1494  
1495              if (entity == null) {
1496                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1497                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1498              }
1499  
1500              boolean populateTypeAndId = true;
1501              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1502              if (entityForm == null) {
<abbr title="1503                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1503                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1504                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1505                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1506              } else {
1507                  entityForm.clearFieldsMap();
1508                  String entityType = entityForm.getEntityType();
<abbr title="1509                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1509                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1510                  entityForm.setEntityType(entityType);
1511                  populateTypeAndId = false;
1512              }
1513  
1514              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1515              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1515              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1516                      collectionField,
1517                      collectionItemId, responseMap);
1518  
<abbr title="1519              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1519              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1520              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1521              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1522              entityForm.setTranslationId(alternateId);
1523  
1524              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1525              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1526                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1527                      continue;
1528                  }
1529                  Property p = cmd.getPMap().get(field);
1530                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1531                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1531                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1532                      // directly on the first adorned target collection. Because of this, we need the actual id property">1532                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1533                      // from the entity that models the adorned target relationship, and not the id of the target object.">1533                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1534                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1534                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1535                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1536                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1537  
<abbr title="1538                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1538                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1539                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1540                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1541  
1542                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1543                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1543                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1544                      } else {
<abbr title="1545                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1545                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1546                      }
1547                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1548                      // See above comment for AdornedTargetCollectionMetadata
1549                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1550  
<abbr title="1551                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1551                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1552                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1553                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1554  
<abbr title="1555                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1555                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1556                              mmd.getTargetClass(), sectionCrumbs);
1557                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1558  
1559                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1560                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1560                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1561                      } else {
<abbr title="1562                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1562                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1563                      }
1564                  }
1565              }
1566  
1567              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1568              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1569  
1570              boolean atLeastOneBasicField = false;
1571              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1572                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1572                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1573                      atLeastOneBasicField = true;
1574                      break;
1575                  }
1576              }
1577              if (!atLeastOneBasicField) {
1578                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1579              }
1580              addAuditableDisplayFields(entityForm);
1581              model.addAttribute(&quot;entityForm&quot;, entityForm);
1582              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1583          } else if (md instanceof MapMetadata) {
1584              MapMetadata fmd = (MapMetadata) md;
1585  
<abbr title="1586              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1586              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1587              if (entity == null) {
1588                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1589                      collectionItemId, sectionCrumbs, null).getEntity();
1590              }
1591  
1592              boolean populateTypeAndId = true;
1593              if (entityForm == null) {
1594                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1595              } else {
1596                  //save off the prior key before clearing out the fields map as it will not appear
1597                  //back on the saved entity
1598                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1599                  entityForm.clearFieldsMap();
1600                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1601                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1602                  populateTypeAndId = false;
1603              }
1604  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1605 +            //For MappedCollections, we need to be specific on what ceilingEntity and translationId is used.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1606 +            //It should be the entity and referenced Id of the value entity (not the target entity and Id).</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1607 +            if (entityForm.getCeilingEntityClassname() == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1608 +                entityForm.setCeilingEntityClassname(fmd.getValueClassName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1609 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1610 +            entityForm.setTranslationId(collectionItemId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1611 +</span>
1612              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1613              formService.populateMapEntityFormFields(entityForm, entity);
1614              addAuditableDisplayFields(entityForm);
1615              model.addAttribute(&quot;entityForm&quot;, entityForm);
1616              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1617          }
1618  
1619          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1620          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1621          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1622          setModelAttributes(model, sectionKey);
1623          return &quot;modules/modalContainer&quot;;
1624      }
1625  
1626      /**
1627       * Updates the specified collection item
1628       *
1629       * @param request
1630       * @param response
1631       * @param model
1632       * @param pathVars
1633       * @param id
1634       * @param collectionField
<abbr title="1635       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1635       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1636       * @param entityForm
1637       * @param result
1638       * @return the return view path
1639       * @throws Exception
1640       */
1641      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1642      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1643              @PathVariable  Map&lt;String, String&gt; pathVars,
1644              @PathVariable(value=&quot;id&quot;) String id,
1645              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1646              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1647              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1648              BindingResult result) throws Exception {
<abbr title="1649          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1649          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1650      }
1651  
1652      /**
1653       * Updates the specified collection item
1654       *
1655       * @param request
1656       * @param response
1657       * @param model
1658       * @param pathVars
1659       * @param id
1660       * @param collectionField
<abbr title="1661       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1661       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1662       * @param entityForm
<abbr title="1663       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1663       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1664       * @param result
1665       * @return the return view path
1666       * @throws Exception
1667       */
<abbr title="1668      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1668      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1669      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1670              @PathVariable  Map&lt;String, String&gt; pathVars,
1671              @PathVariable(value=&quot;id&quot;) String id,
1672              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1673              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1674              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1675              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1676              BindingResult result) throws Exception {
1677          String sectionKey = getSectionKey(pathVars);
1678          String mainClassName = getClassNameForSection(sectionKey);
1679          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1680          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1680          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1681          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1682  
<abbr title="1683          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1683          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1684          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1685          service.clearEntityManager();
1686          // First, we must save the collection entity
<abbr title="1687          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1687          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1688          Entity savedEntity = persistenceResponse.getEntity();
1689          entityFormValidator.validate(entityForm, savedEntity, result);
1690  
1691          if (result.hasErrors()) {
<abbr title="1692              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1692              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1693                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1694          }
1695  
1696          // Next, we must get the new list grid that represents this collection
1697          // We return the new list grid so that it can replace the currently visible one
<abbr title="1698          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1698          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1699  
1700          model.addAttribute(&quot;listGrid&quot;, listGrid);
1701          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1702          setModelAttributes(model, sectionKey);
1703          return &quot;views/standaloneListGrid&quot;;
1704      }
1705  
1706      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1707      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1708              HttpServletResponse response, Model model,
1709              @PathVariable  Map&lt;String, String&gt; pathVars,
1710              @PathVariable(value=&quot;id&quot;) String id,
1711              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1712              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1713              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1714          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1714          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1715      }
1716  
1717      /**
1718       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1719       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1720       *
1721       * @param request
1722       * @param response
1723       * @param model
1724       * @param pathVars
1725       * @param id
1726       * @param collectionField
1727       * @param collectionItemId
1728       * @return an object explaining the state of the operation
1729       * @throws Exception
1730       */
<abbr title="1731      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1731      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1732      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1733              HttpServletResponse response, Model model,
1734              @PathVariable  Map&lt;String, String&gt; pathVars,
1735              @PathVariable(value=&quot;id&quot;) String id,
1736              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1737              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1738              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1739              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1740          String sectionKey = getSectionKey(pathVars);
1741          String mainClassName = getClassNameForSection(sectionKey);
1742          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1743          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1743          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1744          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1745          FieldMetadata md = collectionProperty.getMetadata();
1746  
<abbr title="1747          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1747          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1748          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1749  
<abbr title="1750          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1750          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1751  
1752          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1753  
1754          if (md instanceof AdornedTargetCollectionMetadata) {
1755              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1756              AdornedTargetList atl = ppr.getAdornedList();
1757  
1758              // Get an entity form for the entity
<abbr title="1759              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1759              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
1760              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1761                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
1762                      .getDynamicResultSet().getRecords()[0];
1763              formService.populateEntityFormFields(entityForm, entity);
1764              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1765  
<abbr title="1766              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1766              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
1767              int sequenceValue = Integer.parseInt(newSequence) + 1;
1768              Field field = entityForm.findField(atl.getSortField());
1769              field.setValue(String.valueOf(sequenceValue));
1770  
1771              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1772              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1772              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1773              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1774  
1775              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1776              responseMap.put(&quot;field&quot;, collectionField);
1777              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1778              return responseMap;
1779          } else if (md instanceof BasicCollectionMetadata) {
1780              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1781              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1782              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1782              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
1783  
<abbr title="1784              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1784              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1785              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1786 +            boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1786 +            boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1787 +            if(listGridReadOnly){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1788 +                        throw new SecurityServiceException();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1789 +            }</span>
1790              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1791                  Field f = new Field()
1792                          .withName(cd.getSortProperty())
1793                          .withFieldType(SupportedFieldType.HIDDEN.toString());
1794                  entityForm.addHiddenField(mainMetadata, f);
1795              }
1796              formService.populateEntityFormFields(entityForm, entity);
1797  
1798              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1799                  int sequenceValue = Integer.parseInt(newSequence) + 1;
1800                  Field field = entityForm.findField(cd.getSortProperty());
1801                  field.setValue(String.valueOf(sequenceValue));
1802              }
1803  
<abbr title="1804              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1804              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1805              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1806  
1807              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1808              responseMap.put(&quot;field&quot;, collectionField);
1809              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1810              return responseMap;
1811          } else {
<abbr title="1812              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1812              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
1813          }
1814      }
1815  
1816      /**
1817       * Removes the requested collection item
1818       *
<abbr title="1819       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1819       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1820       * map collection.
1821       *
1822       * @param request
1823       * @param response
1824       * @param model
1825       * @param pathVars
1826       * @param id
1827       * @param collectionField
1828       * @param collectionItemId
1829       * @return the return view path
1830       * @throws Exception
1831       */
1832      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
1833      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1834              @PathVariable  Map&lt;String, String&gt; pathVars,
1835              @PathVariable(value=&quot;id&quot;) String id,
1836              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1837              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1838          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1838          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
1839      }
1840  
1841      /**
1842       * Removes the requested collection item
1843       *
<abbr title="1844       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1844       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1845       * map collection.
1846       *
1847       * @param request
1848       * @param response
1849       * @param model
1850       * @param pathVars
1851       * @param id
1852       * @param collectionField
1853       * @param collectionItemId
1854       * @return the return view path
1855       * @throws Exception
1856       */
<abbr title="1857      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1857      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
1858      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1859              @PathVariable  Map&lt;String, String&gt; pathVars,
1860              @PathVariable(value=&quot;id&quot;) String id,
1861              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1862              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1863              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1864          String sectionKey = getSectionKey(pathVars);
1865          String mainClassName = getClassNameForSection(sectionKey);
1866          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1867          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1867          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1868          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1869  
1870          String priorKey = request.getParameter(&quot;key&quot;);
1871  
<abbr title="1872          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1872          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1873          declareShouldIgnoreAdditionStatusFilter();
1874          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1875          service.clearEntityManager();
1876          // First, we must remove the collection entity
<abbr title="1877          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1877          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
1878          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
1879              String error = &quot;There was an error removing the whatever&quot;;
1880              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1881                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1882                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1882                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
1883              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
1884                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1885              }
1886              return new JsonResponse(response)
1887                  .with(&quot;status&quot;, &quot;error&quot;)
1888                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1889                  .done();
1890          }
1891  
1892          // Next, we must get the new list grid that represents this collection
1893          // We return the new list grid so that it can replace the currently visible one
<abbr title="1894          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1894          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1895  
1896          model.addAttribute(&quot;listGrid&quot;, listGrid);
1897          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1898          setModelAttributes(model, sectionKey);
1899          return &quot;views/standaloneListGrid&quot;;
1900      }
1901  
1902      public void addAuditableDisplayFields(EntityForm entityForm) {
1903          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1904          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1905              addAuditableDisplayField(entityForm, createdBy);
1906  
1907              createdBy.setIsVisible(false);
1908          }
1909          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1910          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1911              addAuditableDisplayField(entityForm, updatedBy);
1912  
1913              updatedBy.setIsVisible(false);
1914          }
1915      }
1916  
1917      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1918          Field displayField = buildAuditableDisplayField(userField);
1919  
1920          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1921          String userName = user == null ? null : user.getName();
1922          displayField.setValue(userName);
1923  
1924          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1925          if (auditGroup != null) {
1926              auditGroup.addField(displayField);
1927          }
1928      }
1929  
1930      private Field buildAuditableDisplayField(Field auditableField) {
1931          return new Field().withFieldType(SupportedFieldType.STRING.toString())
1932                  .withName(auditableField.getName() + &quot;Display&quot;)
1933                  .withFriendlyName(auditableField.getFriendlyName())
1934                  .withOrder(auditableField.getOrder())
1935                  .withOwningEntityClass(auditableField.getOwningEntityClass())
1936                  .withReadOnly(true);
1937      }
1938  
1939      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1940          String tabName = pathVars.get(&quot;tabName&quot;);
1941          if (StringUtils.isBlank(tabName)) {
1942              TabMetadata firstTab = cmd.getFirstTab();
1943              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1944          }
1945          return tabName;
1946      }
1947  
1948      // *****************************************
1949      // Typed Entity Helper Methods
1950      // *****************************************
1951  
1952      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1953          // Check if this is a typed entity
1954          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1955          if (typedEntitySection != null) {
1956              // Update the friendly name for this Entity Type
1957              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1958          }
1959      }
1960  
1961      // *********************************
1962      // ADDITIONAL SPRING-BOUND METHODS *
1963      // *********************************
1964  
1965      /**
1966       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="1967       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1967       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
1968       * or false. If the value is passed in as null, it will treat it as false.
1969       *
1970       * @param binder
1971       */
1972      @InitBinder
1973      public void initBinder(WebDataBinder binder) {
1974          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
1975          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
1976      }
1977  
1978  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  30  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  31  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  32  import org.broadleafcommerce.common.util.BLCArrayUtils;
  33  import org.broadleafcommerce.common.util.BLCMessageUtils;
  34  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  35  import org.broadleafcommerce.common.web.JsonResponse;
  36  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  37  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  38  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  40  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  41  import org.broadleafcommerce.openadmin.dto.ClassTree;
  42  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  43  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  44  import org.broadleafcommerce.openadmin.dto.Entity;
  45  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  46  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  47  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  48  import org.broadleafcommerce.openadmin.dto.Property;
  49  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  52  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  53  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  54  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  55  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  56  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  57  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  60  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  61  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  62  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  63  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  64  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  65  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  66  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  67  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  68  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  69  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  70  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  71  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  72  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  73  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  74  import org.springframework.stereotype.Controller;
  75  import org.springframework.ui.Model;
  76  import org.springframework.util.MultiValueMap;
  77  import org.springframework.validation.BindingResult;
  78  import org.springframework.web.bind.WebDataBinder;
  79  import org.springframework.web.bind.annotation.InitBinder;
  80  import org.springframework.web.bind.annotation.ModelAttribute;
  81  import org.springframework.web.bind.annotation.PathVariable;
  82  import org.springframework.web.bind.annotation.RequestMapping;
  83  import org.springframework.web.bind.annotation.RequestMethod;
  84  import org.springframework.web.bind.annotation.RequestParam;
  85  import org.springframework.web.bind.annotation.ResponseBody;
  86  import org.springframework.web.servlet.DispatcherServlet;
  87  import org.springframework.web.servlet.FlashMap;
  88  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  89  import org.springframework.web.util.UrlPathHelper;
  90  import com.fasterxml.jackson.databind.ObjectMapper;
  91  
  92  import java.net.URLDecoder;
  93  import java.util.ArrayList;

  94  import java.util.HashMap;
  95  import java.util.List;
  96  import java.util.Map;
  97  import java.util.Map.Entry;
  98  import java.util.Set;


  99  import javax.annotation.Resource;
 100  import javax.servlet.http.HttpServletRequest;
 101  import javax.servlet.http.HttpServletResponse;
 102  
 103  /**
<abbr title=" 104   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 104   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr>
<abbr title=" 105   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 105   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr>
 106   * that is not explicitly customized by its own controller.
 107   *
 108   * @author Andre Azzolini (apazzolini)
 109   * @author Jeff Fischer
 110   */
 111  @Controller(&quot;blAdminBasicEntityController&quot;)
 112  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 113  public class AdminBasicEntityController extends AdminAbstractController {
 114  
 115      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 116  
 117      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 118      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 119      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 120  
 121      @Resource(name=&quot;blSandBoxHelper&quot;)
 122      protected SandBoxHelper sandBoxHelper;
 123  
 124      @Resource(name = &quot;blAdminUserDao&quot;)
 125      protected AdminUserDao adminUserDao;
 126  
 127      @Resource(name=&quot;blDynamicEntityDao&quot;)
 128      protected DynamicEntityDao dynamicEntityDao;
 129  
 130      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 131      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 132  
 133      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 134      protected RowLevelSecurityService rowLevelSecurityService;
 135  
 136      // ******************************************
 137      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 138      // ******************************************
 139  
 140      /**
<abbr title=" 141       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 141       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 142       * criteria.
 143       *
 144       * @param request
 145       * @param response
 146       * @param model
 147       * @param pathVars
 148       * @param requestParams a Map of property name -&gt; list critiera values
 149       * @return the return view path
 150       * @throws Exception
 151       */
 152      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 153      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 154              @PathVariable Map&lt;String, String&gt; pathVars,
 155              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 156          String sectionKey = getSectionKey(pathVars);
 157          String sectionClassName = getClassNameForSection(sectionKey);
 158          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 159          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 159          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 160          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 161          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 162  
 163          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 164          listGrid.setSelectType(ListGrid.SelectType.NONE);
 165  
 166          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 167          if (CollectionUtils.isNotEmpty(headerFields)) {
 168              Field firstField = headerFields.iterator().next();
 169              if (requestParams.containsKey(firstField.getName())) {
 170                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 171              }
 172          }
 173  
 174          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 175  
 176          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 177          model.addAttribute(&quot;listGrid&quot;, listGrid);
 178  
 179          return &quot;modules/defaultContainer&quot;;
 180      }
 181  
 182      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 183              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 184          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 185          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 186          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 187          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 188  
 189          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 190          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 191              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 192          }
 193  
 194          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 195          String requestUri = request.getRequestURI();
 196          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 197              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 198          }
 199  
 200          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 201          model.addAttribute(&quot;currentUri&quot;, requestUri);
 202          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 203          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 204          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 205          model.addAttribute(&quot;mainActions&quot;, mainActions);
 206          setModelAttributes(model, sectionKey);
 207          setTypedEntityModelAttributes(request, model);
 208      }
 209  
 210      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 211      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 212               HttpServletResponse response, Model model,
 213               @PathVariable Map&lt;String, String&gt; pathVars,
 214               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 215          String sectionKey = getSectionKey(pathVars);
 216          String sectionClassName = getClassNameForSection(sectionKey);
 217          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 218          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 218          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 219                  .withCustomCriteria(getCustomCriteria(requestParams));
 220  
 221          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 222  
 223          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 224          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 225  
 226          return formService.constructSelectizeOptionMap(drs, cmd);
 227      }
 228  
 229      /**
 230       * Obtains the requested criteria parameter
 231       *
 232       * @param requestParams
 233       * @return
 234       */
 235      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 236          if (requestParams == null || requestParams.isEmpty()) {
 237              return null;
 238          }
 239  
 240          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 241          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 242          return new String[] {response};
 243      }
 244  
 245      /**
 246       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 247       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 248       *
 249       * @param sectionClassName
 250       * @param cmd
 251       * @param mainActions
 252       */
<abbr title=" 253      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 253      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 254          if (isAddActionAllowed(sectionClassName, cmd)) {
 255              mainActions.add(DefaultMainActions.ADD);
 256          }
 257      }
 258  
 259      protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {
 260          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 261          boolean canCreate = true;
 262          try {
 263              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 264          } catch (ServiceException e) {
 265              if (e instanceof SecurityServiceException) {
 266                  canCreate = false;
 267              }
 268          }
 269  
 270          if (canCreate) {
 271              checkReadOnly: {
 272                  //check if all the metadata is read only
 273                  for (Property property : cmd.getProperties()) {
 274                      if (property.getMetadata() instanceof BasicFieldMetadata) {
 275                          if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 276                                  !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 277                              break checkReadOnly;
 278                          }
 279                      }
 280                  }
 281                  canCreate = false;
 282              }
 283          }
 284  
 285          if (canCreate) {
<abbr title=" 286              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 286              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr>
 287          }
 288  
 289          return canCreate;
 290      }
 291  
 292      /**
 293       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 294       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 294       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 295       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 295       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 296       * they can then perform operations on sub collections.
 297       *
 298       * @param request
 299       * @param response
 300       * @param model
 301       * @param pathVars
 302       * @param entityType
 303       * @return the return view path
 304       * @throws Exception
 305       */
 306      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 307      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 308              @PathVariable  Map&lt;String, String&gt; pathVars,
 309              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 310          String sectionKey = getSectionKey(pathVars);
 311          String sectionClassName = getClassNameForSection(sectionKey);
 312          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 313          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 313          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 314          ppr.setAddOperationInspect(true);
 315          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 316  
<abbr title=" 317          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 317          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr>
 318          if (StringUtils.isBlank(entityType)) {
 319              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 320                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 321              } else {
 322                  entityType = getDefaultEntityType();
 323              }
 324          } else {
 325              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 326          }
 327  
 328          EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 329  
 330          // We need to make sure that the ceiling entity is set to the interface and the specific entity type
 331          // is set to the type we&#x27;re going to be creating.
 332          entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 333          entityForm.setEntityType(entityType);
 334  
 335          // When we initially build the class metadata (and thus, the entity form), we had all of the possible
 336          // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the
 337          // fields that are not applicable for this given entity type.
 338          formService.removeNonApplicableFields(cmd, entityForm, entityType);
 339  
 340          modifyAddEntityForm(entityForm, pathVars);
 341  
 342          model.addAttribute(&quot;entityForm&quot;, entityForm);
 343          model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 344  
 345          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 346          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 347          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 348          setModelAttributes(model, sectionKey);
 349          return &quot;modules/modalContainer&quot;;
 350      }
 351  
 352      /**
 353       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 354       *
 355       * @param request
 356       * @param response
 357       * @param model
 358       * @param pathVars
 359       * @param entityForm
 360       * @param result
 361       * @return the return view path
 362       * @throws Exception
 363       */
 364      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 365      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 366              @PathVariable  Map&lt;String, String&gt; pathVars,
 367              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 368          String sectionKey = getSectionKey(pathVars);
 369          String sectionClassName = getClassNameForSection(sectionKey);
 370          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 371          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 371          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 372  
 373          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 374          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 374          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 375          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 376          entityFormValidator.validate(entityForm, entity, result);
 377  
 378          if (result.hasErrors()) {
 379              entityForm.clearFieldsMap();
 380              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 381  
 382              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 383  
 384              modifyAddEntityForm(entityForm, pathVars);
 385  
 386              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 387              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 388              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 389              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 390              setModelAttributes(model, sectionKey);
 391              return &quot;modules/modalContainer&quot;;
 392          }
 393  
 394          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 395          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 395          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>
 396      }
 397  
 398      /**
 399       * Renders the main entity form for the specified entity
 400       *
 401       * @param request
 402       * @param response
 403       * @param model
 404       * @param pathVars
 405       * @param id
 406       * @return the return view path
 407       * @throws Exception
 408       */
 409      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 410      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 411              @PathVariable  Map&lt;String, String&gt; pathVars,
 412              @PathVariable(&quot;id&quot;) String id) throws Exception {
 413          String sectionKey = getSectionKey(pathVars);
 414          String sectionClassName = getClassNameForSection(sectionKey);
 415          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 416          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 417  
 418          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 419          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 420  
 421          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 422  
 423          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 424  
 425          if (isAddRequest(entity)) {
 426              modifyAddEntityForm(entityForm, pathVars);
 427          } else {
 428              modifyEntityForm(entityForm, pathVars);
 429          }
 430  
 431          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 432              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 433          }
 434  
 435          // Set the sectionKey again incase this is a typed entity
 436          entityForm.setSectionKey(sectionKey);
 437  
 438          // Build the current url in the cast that this is a typed entity
 439          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 440          int startIndex = request.getContextPath().length();
 441  
 442          // Remove the context path from servlet path
 443          String currentUrl = originatingUri.substring(startIndex);
 444  
 445          model.addAttribute(&quot;entity&quot;, entity);
 446          model.addAttribute(&quot;entityForm&quot;, entityForm);
 447          model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 448  
 449          setModelAttributes(model, sectionKey);
 450  
 451          // We want to replace author ids with their names
 452          addAuditableDisplayFields(entityForm);
 453  
 454          if (isAjaxRequest(request)) {
 455              entityForm.setReadOnly();
 456              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 457              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 458              return &quot;modules/modalContainer&quot;;
 459          } else {
 460              model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 461              model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 462              return &quot;modules/defaultContainer&quot;;
 463          }
 464      }
 465  
<abbr title=" 466      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 466      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 467                                                                ClassMetadata cmd, Entity entity,
 468                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 469          String tabName = pathVars.get(&quot;tabName&quot;);
 470          if (StringUtils.isEmpty(tabName)) {
 471              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 472          }
 473          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 474      }
 475  
 476      private boolean isAddRequest(Entity entity) {
 477          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 478          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 479          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 480              return false;
 481          }
 482  
 483          return resultHolder.getResult();
 484      }
 485  
 486      /**
 487       * Attempts to get the List Grid for the selected tab.
 488       *
 489       * @param request
 490       * @param response
 491       * @param model
 492       * @param pathVars
 493       * @param id
 494       * @param tabName
 495       * @param entityForm
 496       * @param entity
 497       * @return the return view path
 498       * @throws Exception
 499       */
 500      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 501      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 502              @PathVariable Map&lt;String, String&gt; pathVars,
 503              @PathVariable(value = &quot;id&quot;) String id,
 504              @PathVariable(value = &quot;tabName&quot;) String tabName,
 505              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 506              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 507          String sectionKey = getSectionKey(pathVars);
 508          String sectionClassName = getClassNameForSection(sectionKey);
 509          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 510          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 511          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 512          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 513          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 514          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 515  
 516          if (isAddRequest(entity)) {
 517              modifyAddEntityForm(entityForm, pathVars);
 518          } else {
 519              modifyEntityForm(entityForm, pathVars);
 520          }
 521  
 522          model.addAttribute(&quot;entity&quot;, entity);
 523          model.addAttribute(&quot;entityForm&quot;, entityForm);
 524          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 525  
 526          setModelAttributes(model, sectionKey);
 527  
 528          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 529          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 530          return &quot;modules/defaultContainer&quot;;
 531      }
 532  
 533      /**
 534       * Builds JSON that looks like this:
 535       *
 536       * {&quot;errors&quot;:
 537       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 538       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 539       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 540       *        &quot;errorType&quot;, &quot;field&quot;,
 541       *        &quot;tab&quot;: &quot;General&quot;
 542       *        },
 543       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 544       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 545       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 546       *        &quot;errorType&quot;, &quot;field&quot;,
 547       *        &quot;tab&quot;: &quot;General&quot;
 548       *        }]
 549       * }
 550       *
 551       */
 552      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 553      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 554              @PathVariable Map&lt;String, String&gt; pathVars,
 555              @PathVariable(value = &quot;id&quot;) String id,
 556              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 557              RedirectAttributes ra) throws Exception {
 558  
 559          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 560  
 561          JsonResponse json = new JsonResponse(response);
 562          if (result.hasErrors()) {
 563              populateJsonValidationErrors(entityForm, result, json);
 564          }
 565          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 566          if (CollectionUtils.isNotEmpty(dirtyList)) {
 567              json.with(&quot;dirty&quot;, dirtyList);
 568          }
 569  
 570          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 571          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 571          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 572          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 573              return resultHolder.getResult();
 574          }
 575  
 576          return json.done();
 577      }
 578  
<abbr title=" 579      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 579      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 580          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 581          String sectionKey = getSectionKey(pathVars);
 582          String sectionClassName = getClassNameForSection(sectionKey);
 583          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 584          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 584          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 585          ClassMetadata cmd = null;
 586          Entity entity = null;
 587          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 588          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 589  
 590          for (Property p: entity.getProperties()) {
 591              if (p.getIsDirty()) {
 592                  dirtyList.add(p.getName());
 593              }
 594          }
 595          return dirtyList;
 596      }
 597  
 598      /**
 599       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 600       * error fields highlighted. On a successful save, it will refresh the entity page.
 601       *
 602       * @param request
 603       * @param response
 604       * @param model
 605       * @param pathVars
 606       * @param id
 607       * @param entityForm
 608       * @param result
 609       * @return the return view path
 610       * @throws Exception
 611       */
 612      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 613      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 614              @PathVariable  Map&lt;String, String&gt; pathVars,
 615              @PathVariable(value=&quot;id&quot;) String id,
 616              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 617              RedirectAttributes ra) throws Exception {
 618          String sectionKey = getSectionKey(pathVars);
 619          String sectionClassName = getClassNameForSection(sectionKey);
 620          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 621          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 621          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 622          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 623  
 624          extractDynamicFormFields(cmd, entityForm);
 625  
<abbr title=" 626          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 626          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 627          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 628  
 629          entityFormValidator.validate(entityForm, entity, result);
 630          if (result.hasErrors()) {
 631              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 632              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 633  
<abbr title=" 634              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 634              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 635              entityForm.clearFieldsMap();
 636              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 637  
 638              if (isAddRequest(entity)) {
 639                  modifyAddEntityForm(entityForm, pathVars);
 640              } else {
 641                  modifyEntityForm(entityForm, pathVars);
 642              }
 643  
 644              model.addAttribute(&quot;entity&quot;, entity);
 645              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 646  
 647              setModelAttributes(model, sectionKey);
 648  
 649              if (isAjaxRequest(request)) {
 650                  entityForm.setReadOnly();
 651                  model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 652                  model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 653                  return &quot;modules/modalContainer&quot;;
 654              } else {
 655                  model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 656                  model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 657                  return &quot;modules/defaultContainer&quot;;
 658              }
 659          }
 660  
 661          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 662  
 663          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 664      }
 665  
 666      /**
 667       * Attempts to remove the given entity.
 668       *
 669       * @param request
 670       * @param response
 671       * @param model
 672       * @param pathVars
 673       * @param id
 674       * @return the return view path
 675       * @throws Exception
 676       */
 677      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 678      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 679              @PathVariable  Map&lt;String, String&gt; pathVars,
 680              @PathVariable(value=&quot;id&quot;) String id,
 681              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 682              RedirectAttributes ra) throws Exception {
 683          String sectionKey = getSectionKey(pathVars);
 684          String sectionClassName = getClassNameForSection(sectionKey);
 685          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 686  
<abbr title=" 687          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 687          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 688          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 689          // Removal does not normally return an Entity unless there is some validation error
 690          if (entity != null) {
 691              entityFormValidator.validate(entityForm, entity, result);
 692              if (result.hasErrors()) {
 693                  // Create a flash attribute for the unsuccessful delete
 694                  FlashMap fm = new FlashMap();
 695                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 696                  fm.put(&quot;headerFlashAlert&quot;, true);
 697                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 698  
 699                  // Re-look back up the entity so that we can return something populated
<abbr title=" 700                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 700                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 701                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 702                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 703                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 703                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 704                  entityForm.clearFieldsMap();
 705                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 706                  modifyEntityForm(entityForm, pathVars);
 707  
 708                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 709                          .done();
 710              }
 711          }
 712  
 713          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 714          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 715  
 716          if (isAjaxRequest(request)) {
 717              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 718              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 719          } else {
 720              return &quot;redirect:/&quot; + sectionKey;
 721          }
 722      }
 723  
 724      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 725      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 725      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 726              @PathVariable  Map&lt;String, String&gt; pathVars,
 727              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 728              @RequestParam String ids,
 729              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 730          String sectionKey = getSectionKey(pathVars);
 731          String sectionClassName = getClassNameForSection(sectionKey);
 732          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 733          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 733          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 734          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 735          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 736          FieldMetadata md = collectionProperty.getMetadata();
 737  
 738          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 739          ppr.setStartIndex(getStartIndex(requestParams));
 740          ppr.setMaxIndex(getMaxIndex(requestParams));
 741  
 742          if (md instanceof BasicFieldMetadata) {
 743              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 744              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 745  
 746              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 747              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 748  
 749              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 750              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 751  
 752              for (Entity e : drs.getRecords()) {
 753                  String id = e.getPMap().get(idProp).getValue();
 754                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 755  
 756                  if (StringUtils.isBlank(disp)) {
 757                      disp = e.getPMap().get(displayProp).getValue();
 758                  }
 759  
 760                  returnMap.put(id,  disp);
 761              }
 762  
 763              return returnMap;
 764          }
 765  
 766          return null;
 767      }
 768  
 769      /**
<abbr title=" 770       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 770       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 771       * then this method is invoked when a user clicks on the name of the default category field.
 772       *
 773       * @param request
 774       * @param response
 775       * @param model
 776       * @param pathVars
 777       * @param collectionField
 778       * @param id
 779       * @return
 780       * @throws Exception
 781       */
 782      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 783      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 784              @PathVariable  Map&lt;String, String&gt; pathVars,
 785              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 786              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 787          String sectionKey = getSectionKey(pathVars);
 788          String mainClassName = getClassNameForSection(sectionKey);
 789          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 790          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 790          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 791          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 792          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 793  
<abbr title=" 794          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 794          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 795          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 795          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 796          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 797          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 798          return viewEntityForm(request, response, model, varsForField, id);
 799      }
 800  
 801      @RequestMapping(
 802              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 803              method = RequestMethod.POST
 804      )
 805      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 806                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 807                                          @PathVariable(value=&quot;id&quot;) String id,
 808                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 809                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 810                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 811                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 811                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 812  
<abbr title=" 813          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 813          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 814      }
 815  
 816  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +    @RequestMapping(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +            value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +            method = RequestMethod.POST</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 820 +    )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 821 +    public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 821 +    public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 822 +                                        @PathVariable  Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 823 +                                        @PathVariable(value=&quot;id&quot;) String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 824 +                                        @PathVariable(value=&quot;collectionField&quot;) String collectionField,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 825 +                                        @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 826 +                                        @PathVariable(value=&quot;tabName&quot;) String tabName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 827 +                                        @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 827 +                                        @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 829 +        return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 829 +        return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 830 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 831 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 832 +</span>
 833      /**
 834       * Returns the records for a given collectionField filtered by a particular criteria
 835       *
 836       * @param request
 837       * @param response
 838       * @param model
 839       * @param pathVars
 840       * @param collectionField
 841       * @param requestParams
 842       * @return the return view path
 843       * @throws Exception
 844       */
 845      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
 846      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
 847              @PathVariable  Map&lt;String, String&gt; pathVars,
 848              @PathVariable(value=&quot;id&quot;) String id,
 849              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 850              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 851          String sectionKey = getSectionKey(pathVars);
 852          String mainClassName = getClassNameForSection(sectionKey);
 853          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 854          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 854          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
 855          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 856          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 857  
 858          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
 859          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
 860  
 861          // Next, we must get the new list grid that represents this collection
<abbr title=" 862          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 862          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
 863          model.addAttribute(&quot;listGrid&quot;, listGrid);
 864  
 865          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 866  
 867          // We return the new list grid so that it can replace the currently visible one
 868          setModelAttributes(model, sectionKey);
 869          return &quot;views/standaloneListGrid&quot;;
 870      }
 871  
 872      /**
<abbr title=" 873       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 873       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
 874       * of this call depending on the type of the specified collection field.
 875       *
 876       * &lt;ul&gt;
 877       *  &lt;li&gt;
<abbr title=" 878       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 878       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title=" 879       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 879       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
 880       *  &lt;/li&gt;
 881       *  &lt;li&gt;
<abbr title=" 882       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 882       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
 883       *    Used by fields such as &quot;allParentCategories&quot;.
 884       *  &lt;/li&gt;
 885       *  &lt;li&gt;
<abbr title=" 886       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 886       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title=" 887       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 887       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title=" 888       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 888       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
 889       *  &lt;/li&gt;
 890       *  &lt;li&gt;
<abbr title=" 891       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 891       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title=" 892       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 892       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title=" 893       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 893       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
 894       *    to linking an entity, provide extra fields, such as a promotional message.
 895       *  &lt;/li&gt;
 896       *  &lt;li&gt;
<abbr title=" 897       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 897       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title=" 898       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 898       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
 899       *    entity. Used by fields such as the mediaMap on a Sku.
 900       *  &lt;/li&gt;
 901       *
 902       * @param request
 903       * @param response
 904       * @param model
 905       * @param pathVars
 906       * @param id
 907       * @param collectionField
 908       * @param requestParams
 909       * @return the return view path
 910       * @throws Exception
 911       */
 912      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
 913      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
 914              @PathVariable Map&lt;String, String&gt; pathVars,
 915              @PathVariable(value = &quot;id&quot;) String id,
 916              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 917              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 918          String sectionKey = getSectionKey(pathVars);
 919          String mainClassName = getClassNameForSection(sectionKey);
 920          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 921          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
 922                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 923          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 924          FieldMetadata md = collectionProperty.getMetadata();
 925  
 926          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 927                  .withFilterAndSortCriteria(getCriteria(requestParams))
 928                  .withStartIndex(getStartIndex(requestParams))
 929                  .withMaxIndex(getMaxIndex(requestParams))
 930                  .withLastId(getLastId(requestParams))
 931                  .withFirstId(getFirstId(requestParams))
 932                  .withUpperCount(getUpperCount(requestParams))
 933                  .withLowerCount(getLowerCount(requestParams))
 934                  .withPageSize(getPageSize(requestParams))
 935                  .withPresentationFetch(true);
 936  
 937          if (md instanceof BasicCollectionMetadata) {
 938              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 939              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
 940                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 941                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
 942                  // for this entity.
 943                  String entityType = null;
 944                  if (requestParams.containsKey(&quot;entityType&quot;)) {
 945                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
 946                  }
 947                  if (StringUtils.isBlank(entityType)) {
 948                      if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 949                          entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 950                      } else {
 951                          entityType = getDefaultEntityType();
 952                      }
 953                  } else {
 954                      entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 955                  }
 956  
 957                  if (StringUtils.isBlank(entityType)) {
 958                      List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 959                      model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 960                      model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
 961                      model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 962                      String requestUri = request.getRequestURI();
<abbr title=" 963                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 963                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr>
<abbr title=" 964                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 964                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr>
 965                      }
 966                      model.addAttribute(&quot;currentUri&quot;, requestUri);
 967                      model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 968                      setModelAttributes(model, sectionKey);
 969                      return &quot;modules/modalContainer&quot;;
 970                  } else {
 971                      ppr = ppr.withCeilingEntityClassname(entityType);
 972                  }
 973              }
 974          } else if (md instanceof MapMetadata) {
<abbr title=" 975              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 975              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
 976              if (result.equals(ExtensionResultStatusType.HANDLED)) {
 977                  model.addAttribute(&quot;entityId&quot;, id);
 978                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 979                  model.addAttribute(&quot;collectionField&quot;, collectionField);
 980                  return &quot;modules/modalContainer&quot;;
 981              }
 982          }
 983  
 984          //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);
 985  
 986          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 987  
<abbr title=" 988          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 988          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>
 989      }
 990  
<abbr title=" 991      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 991      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title=" 992      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 992      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
 993              @PathVariable Map&lt;String, String&gt; pathVars,
 994              @PathVariable(value=&quot;id&quot;) String id,
 995              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 996              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
 997          String sectionKey = getSectionKey(pathVars);
 998          String mainClassName = getClassNameForSection(sectionKey);
 999          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1000          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1000          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1001          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1002          FieldMetadata md = collectionProperty.getMetadata();
1003          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1004          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1005              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1005              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1006                      collectionField,
1007                      collectionItemId, responseMap);
1008          }
1009          return responseMap;
1010      }
1011  
1012      /**
1013       *
1014       * @param request
1015       * @param response
1016       * @param model
1017       * @param pathVars
1018       * @param id
1019       * @param collectionField
1020       * @param requestParams
1021       * @return Json collection data
1022       * @throws Exception
1023       */
1024      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1025      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1025      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1026              @PathVariable Map&lt;String, String&gt; pathVars,
1027              @PathVariable(value = &quot;id&quot;) String id,
1028              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1029              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1030          String sectionKey = getSectionKey(pathVars);
1031          String mainClassName = getClassNameForSection(sectionKey);
1032          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1033          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1034                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1035          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1036          FieldMetadata md = collectionProperty.getMetadata();
1037  
1038          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1039                  .withFilterAndSortCriteria(getCriteria(requestParams))
1040                  .withStartIndex(getStartIndex(requestParams))
1041                  .withMaxIndex(getMaxIndex(requestParams))
1042                  .withCustomCriteria(buildSelectizeCustomCriteria());




1043  
1044          if (md instanceof AdornedTargetCollectionMetadata) {
1045              ppr.setOperationTypesOverride(null);
1046              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1047              ppr.setSectionEntityField(collectionField);
1048          }
1049  
1050          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1051  
1052          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1053      }
1054  
1055      protected String[] buildSelectizeCustomCriteria() {
1056          return new String[]{ IS_SELECTIZE_REQUEST };
1057      }
1058  
1059      /**
1060       * Adds the requested collection item via Selectize
1061       *
1062       * @param request
1063       * @param response
1064       * @param model
1065       * @param pathVars
1066       * @param id
1067       * @param collectionField
1068       * @param entityForm
1069       * @return the return view path
1070       * @throws Exception
1071       */
1072      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1073      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1073      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1074              @PathVariable Map&lt;String, String&gt; pathVars,
1075              @PathVariable(value=&quot;id&quot;) String id,
1076              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1077              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1078          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1079          String sectionKey = getSectionKey(pathVars);
1080          String mainClassName = getClassNameForSection(sectionKey);
1081          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1082          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1082          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1083          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1084  
1085          if (StringUtils.isBlank(entityForm.getEntityType())) {
1086              FieldMetadata fmd = collectionProperty.getMetadata();
1087              if (fmd instanceof BasicCollectionMetadata) {
1088                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1089              }
1090          }
1091  
<abbr title="1092          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1092          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1093          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1094          declareShouldIgnoreAdditionStatusFilter();
1095          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1096  
1097          // First, we must save the collection entity
<abbr title="1098          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1098          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1099          Entity savedEntity = persistenceResponse.getEntity();
1100          entityFormValidator.validate(entityForm, savedEntity, result);
1101  
1102          if (result.hasErrors()) {
1103              returnVal.put(&quot;error&quot;, result.getFieldError());
1104              return returnVal;
1105          }
1106  
1107          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1108              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1109          }
1110          return returnVal;
1111      }
1112  
1113      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1114          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1114          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1115          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1116      }
1117  
1118      /**
1119       * Adds the requested collection item
1120       *
1121       * @param request
1122       * @param response
1123       * @param model
1124       * @param pathVars
1125       * @param id
1126       * @param collectionField
1127       * @param entityForm
1128       * @return the return view path
1129       * @throws Exception
1130       */
1131      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1132      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1133              @PathVariable Map&lt;String, String&gt; pathVars,
1134              @PathVariable(value=&quot;id&quot;) String id,
1135              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1136              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1137          String sectionKey = getSectionKey(pathVars);
1138          String mainClassName = getClassNameForSection(sectionKey);
1139          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1140          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1140          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1141          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1142  
1143          if (StringUtils.isBlank(entityForm.getEntityType())) {
1144              FieldMetadata fmd = collectionProperty.getMetadata();
1145              if (fmd instanceof BasicCollectionMetadata) {
1146                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1147              }
1148          }
1149  
<abbr title="1150          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1150          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1151          declareShouldIgnoreAdditionStatusFilter();
1152          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1153          service.clearEntityManager();
1154          // First, we must save the collection entity
<abbr title="1155          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1155          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1156          Entity savedEntity = persistenceResponse.getEntity();
1157          entityFormValidator.validate(entityForm, savedEntity, result);
1158  
1159          if (result.hasErrors()) {
1160              FieldMetadata md = collectionProperty.getMetadata();
1161              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1162              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1162              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1163                      md, ppr, entityForm, savedEntity);
1164          }
1165  
1166          // Next, we must get the new list grid that represents this collection
<abbr title="1167          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1167          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1168          model.addAttribute(&quot;listGrid&quot;, listGrid);
1169  
1170          // We return the new list grid so that it can replace the currently visible one
1171          model.addAttribute(&quot;actualEntityId&quot;, id);
1172          setModelAttributes(model, sectionKey);
1173          return &quot;views/standaloneListGrid&quot;;
1174      }
1175  
1176      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1177      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1177      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1178              @PathVariable Map&lt;String, String&gt; pathVars,
1179              @PathVariable(value=&quot;id&quot;) String id,
1180              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1181              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1182          String sectionKey = getSectionKey(pathVars);
1183          String mainClassName = getClassNameForSection(sectionKey);
1184          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1185          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1185          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1186          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1187  
1188          if (StringUtils.isBlank(entityForm.getEntityType())) {
1189              FieldMetadata fmd = collectionProperty.getMetadata();
1190              if (fmd instanceof BasicCollectionMetadata) {
1191                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1192              }
1193          }
1194  
<abbr title="1195          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1195          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1196          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1197          entity.setIsPreAdd(true);
1198          // First, we must save the collection entity
<abbr title="1199          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1199          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1200          Entity savedEntity = persistenceResponse.getEntity();
1201  
1202          return new JsonResponse(response)
1203                  .with(&quot;status&quot;, &quot;complete&quot;)
1204                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1205                  .done();
1206      }
1207  
1208      /**
<abbr title="1209       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1209       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1210       * as well as after a POST with validation errors
1211       *
1212       * @param request
1213       * @param model
1214       * @param id
1215       * @param collectionField
1216       * @param sectionKey
1217       * @param collectionProperty
1218       * @param md
1219       * @param ppr
1220       * @return the appropriate view to display for the modal
<abbr title="1221       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1221       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1222       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1222       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1223       * @throws ServiceException
1224       */
1225      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1226              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1227              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1227              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1228  
<abbr title="1229          // For requests to add a new collection item include the main class that the subsequent request comes from.">1229          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1230          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1230          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1231          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1232          // fixes all cases.
1233          String mainClassName = getClassNameForSection(sectionKey);
1234          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1235          ppr.setAddOperationInspect(true);
1236  
1237          if (entityForm != null) {
1238              entityForm.clearFieldsMap();
1239          }
1240          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1241          if (md instanceof BasicCollectionMetadata) {
1242              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1243  
1244              // When adding items to basic collections, we will sometimes show a form to persist a new record
1245              // and sometimes show a list grid to allow the user to associate an existing record.
1246              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1247                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1247                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1248                  if (entityForm == null) {
1249                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1250                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1251                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1252                  } else {
1253                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1254                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1255                  }
<abbr title="1256                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1256                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1257                  entityForm.getTabs().iterator().next().getIsVisible();
1258  
1259                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1260                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1261              } else {
1262                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1263                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1263                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1264                  listGrid.setPathOverride(request.getRequestURL().toString());
1265  
<abbr title="1266                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1266                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1267                      listGrid.removeAllRowActions();
1268                  }
1269  
1270                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1271                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1272              }
1273          } else if (md instanceof AdornedTargetCollectionMetadata) {
1274              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1275  
<abbr title="1276              // Even though this field represents an adorned target collection, the list we want to show in the modal">1276              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1277              // is the standard list grid for the target entity of this field
1278              ppr.setOperationTypesOverride(null);
1279              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1280              ppr.setSectionEntityField(collectionField);
1281  
<abbr title="1282              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1282              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1283  
1284              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1285              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1285              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1286              listGrid.setSubCollectionFieldName(collectionField);
1287              listGrid.setPathOverride(request.getRequestURL().toString());
1288              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1289              if (entityForm == null) {
<abbr title="1290                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1290                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1291                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1292              } else {
<abbr title="1293                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1293                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1294                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1295              }
1296  
1297              listGrid.setListGridType(ListGrid.Type.ADORNED);
1298              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1299                  if (entry.getValue().getIsVisible()) {
1300                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1301                      break;
1302                  }
1303              }
1304  
1305              // This is part of an add, so we want to be able to filter/sort the listgrid
1306              listGrid.setIsSortable(false);
1307              listGrid.setCanFilterAndSort(true);
1308              listGrid.removeAllRowActions();
1309  
1310              model.addAttribute(&quot;listGrid&quot;, listGrid);
1311              model.addAttribute(&quot;entityForm&quot;, entityForm);
1312              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1313          } else if (md instanceof MapMetadata) {
1314              MapMetadata fmd = (MapMetadata) md;
<abbr title="1315              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1315              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1316  
1317              if (entityForm == null) {
1318                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1319              } else {
1320                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1321                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1322              }
1323              model.addAttribute(&quot;entityForm&quot;, entityForm);
1324              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1325          }
1326  
1327          // Set the parent id on the entity form
1328          if (entityForm != null) {
1329              entityForm.setParentId(id);
1330          }
1331  
1332          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1333          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1334          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1335          setModelAttributes(model, sectionKey);
1336          return &quot;modules/modalContainer&quot;;
1337      }
1338  
1339      /**
1340       * Shows the appropriate modal dialog to edit the selected collection item
1341       *
1342       * @param request
1343       * @param response
1344       * @param model
1345       * @param pathVars
1346       * @param id
1347       * @param collectionField
1348       * @param collectionItemId
1349       * @return the return view path
1350       * @throws Exception
1351       */
<abbr title="1352      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1352      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1353      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1354              @PathVariable  Map&lt;String, String&gt; pathVars,
1355              @PathVariable(value=&quot;id&quot;) String id,
1356              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1357              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1358              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1359          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1359          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1360                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1361      }
1362  
1363      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1364      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1365              @PathVariable  Map&lt;String, String&gt; pathVars,
1366              @PathVariable(value=&quot;id&quot;) String id,
1367              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1368              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1369          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1370                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1371      }
1372  
1373      /**
<abbr title="1374       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1374       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1375       *
1376       * @param request
1377       * @param response
1378       * @param model
1379       * @param pathVars
1380       * @param id
1381       * @param collectionField
1382       * @param collectionItemId
1383       * @return the return view path
1384       * @throws Exception
1385       */
<abbr title="1386      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1386      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1387      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1388              @PathVariable  Map&lt;String, String&gt; pathVars,
1389              @PathVariable(value=&quot;id&quot;) String id,
1390              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1391              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1392              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1393          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1393          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1394                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1395  
1396          // Since this is a read-only view, actions don&#x27;t make sense in this context
1397          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1398          addAuditableDisplayFields(ef);
1399          ef.removeAllActions();
1400          ef.setReadOnly();
1401  
1402          return returnPath;
1403      }
1404  
1405      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1406      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1407              @PathVariable  Map&lt;String, String&gt; pathVars,
1408              @PathVariable(value=&quot;id&quot;) String id,
1409              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1410              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1411          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1411          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1412                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1413  
1414          // Since this is a read-only view, actions don&#x27;t make sense in this context
1415          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1416          ef.removeAllActions();
1417          ef.setReadOnly();
1418  
1419          return returnPath;
1420      }
1421  
<abbr title="1422      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1422      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1423              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1423              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1424          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1424          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1425      }
1426  
<abbr title="1427      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1427      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1428              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1428              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1429          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1429          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1430      }
1431  
<abbr title="1432      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1432      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1433                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1433                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1434          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1434          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1435      }
1436  
1437      /**
<abbr title="1438       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1438       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1439       * which are optional. If they are not passed in then they are automatically looked up
1440       *
1441       * @param request
1442       * @param model
1443       * @param pathVars
1444       * @param id
1445       * @param collectionField
1446       * @param collectionItemId
1447       * @param modalHeaderType
1448       * @param entityForm
1449       * @param entity
1450       * @return
1451       * @throws ServiceException
1452       */
<abbr title="1453      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1453      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1454              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1454              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
1455          String sectionKey = getSectionKey(pathVars);
1456          String mainClassName = getClassNameForSection(sectionKey);
1457          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1458          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1458          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1459          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1460          FieldMetadata md = collectionProperty.getMetadata();
1461          SectionCrumb nextCrumb = new SectionCrumb();
1462          if (md instanceof MapMetadata) {
1463              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1464          } else {
1465              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1466          }
1467          nextCrumb.setSectionId(collectionItemId);
1468          if (!sectionCrumbs.contains(nextCrumb)) {
1469              sectionCrumbs.add(nextCrumb);
1470          }
1471  
<abbr title="1472          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1472          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1473          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1473          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1474  
1475          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1476  
1477          if (md instanceof BasicCollectionMetadata &amp;&amp;
1478                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1479                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1480              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1481  
<abbr title="1482              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1482              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1483              if (entity == null) {
<abbr title="1484                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1484                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1485              }
1486  
1487              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1488              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1488              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
1489              if (entityForm == null) {
<abbr title="1490                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1490                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr>
1491              } else {
1492                  entityForm.clearFieldsMap();
<abbr title="1493                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1493                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr>
1494                  //remove all the actions since we&#x27;re not trying to redisplay them on the form
1495                  entityForm.removeAllActions();
1496              }
1497              entityForm.removeAction(DefaultEntityFormActions.DELETE);
1498              addAuditableDisplayFields(entityForm);
1499              model.addAttribute(&quot;entityForm&quot;, entityForm);
1500              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1501          } else if (md instanceof AdornedTargetCollectionMetadata) {
1502              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1503  
1504              if (entity == null) {
1505                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1506                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1507              }
1508  
1509              boolean populateTypeAndId = true;
1510              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1511              if (entityForm == null) {
<abbr title="1512                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1512                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1513                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1514                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1515              } else {
1516                  entityForm.clearFieldsMap();
1517                  String entityType = entityForm.getEntityType();
<abbr title="1518                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1518                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1519                  entityForm.setEntityType(entityType);
1520                  populateTypeAndId = false;
1521              }
1522  
1523              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1524              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1524              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1525                      collectionField,
1526                      collectionItemId, responseMap);
1527  
<abbr title="1528              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1528              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1529              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1530              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1531              entityForm.setTranslationId(alternateId);
1532  
1533              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1534              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1535                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1536                      continue;
1537                  }
1538                  Property p = cmd.getPMap().get(field);
1539                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1540                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1540                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1541                      // directly on the first adorned target collection. Because of this, we need the actual id property">1541                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1542                      // from the entity that models the adorned target relationship, and not the id of the target object.">1542                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1543                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1543                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1544                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1545                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1546  
<abbr title="1547                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1547                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1548                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1549                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1550  
1551                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1552                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1552                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1553                      } else {
<abbr title="1554                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1554                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1555                      }
1556                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1557                      // See above comment for AdornedTargetCollectionMetadata
1558                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1559  
<abbr title="1560                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1560                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1561                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1562                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1563  
<abbr title="1564                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1564                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1565                              mmd.getTargetClass(), sectionCrumbs);
1566                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1567  
1568                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1569                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1569                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1570                      } else {
<abbr title="1571                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1571                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1572                      }
1573                  }
1574              }
1575  
1576              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1577              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1578  
1579              boolean atLeastOneBasicField = false;
1580              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1581                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1581                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1582                      atLeastOneBasicField = true;
1583                      break;
1584                  }
1585              }
1586              if (!atLeastOneBasicField) {
1587                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1588              }
1589              addAuditableDisplayFields(entityForm);
1590              model.addAttribute(&quot;entityForm&quot;, entityForm);
1591              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1592          } else if (md instanceof MapMetadata) {
1593              MapMetadata fmd = (MapMetadata) md;
1594  
<abbr title="1595              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1595              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1596              if (entity == null) {
1597                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1598                      collectionItemId, sectionCrumbs, null).getEntity();
1599              }
1600  
1601              boolean populateTypeAndId = true;
1602              if (entityForm == null) {
1603                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1604              } else {
1605                  //save off the prior key before clearing out the fields map as it will not appear
1606                  //back on the saved entity
1607                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1608                  entityForm.clearFieldsMap();
1609                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1610                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1611                  populateTypeAndId = false;
1612              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1613 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1614 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1615 +                entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1615 +                entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1616 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1617 +                LOG.error(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1618 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1619 +            entityForm.setTranslationId(entity.getPMap().get(fmd.getToOneTargetProperty()+&quot;.id&quot;).getValue());</span>

1620              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1621              formService.populateMapEntityFormFields(entityForm, entity);
1622              addAuditableDisplayFields(entityForm);
1623              model.addAttribute(&quot;entityForm&quot;, entityForm);
1624              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1625          }
1626  
1627          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1628          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1629          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1630          setModelAttributes(model, sectionKey);
1631          return &quot;modules/modalContainer&quot;;
1632      }
1633  
1634      /**
1635       * Updates the specified collection item
1636       *
1637       * @param request
1638       * @param response
1639       * @param model
1640       * @param pathVars
1641       * @param id
1642       * @param collectionField
<abbr title="1643       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1643       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1644       * @param entityForm
1645       * @param result
1646       * @return the return view path
1647       * @throws Exception
1648       */
1649      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1650      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1651              @PathVariable  Map&lt;String, String&gt; pathVars,
1652              @PathVariable(value=&quot;id&quot;) String id,
1653              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1654              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1655              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1656              BindingResult result) throws Exception {
<abbr title="1657          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1657          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1658      }
1659  
1660      /**
1661       * Updates the specified collection item
1662       *
1663       * @param request
1664       * @param response
1665       * @param model
1666       * @param pathVars
1667       * @param id
1668       * @param collectionField
<abbr title="1669       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1669       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1670       * @param entityForm
<abbr title="1671       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1671       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1672       * @param result
1673       * @return the return view path
1674       * @throws Exception
1675       */
<abbr title="1676      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1676      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1677      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1678              @PathVariable  Map&lt;String, String&gt; pathVars,
1679              @PathVariable(value=&quot;id&quot;) String id,
1680              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1681              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1682              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1683              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1684              BindingResult result) throws Exception {
1685          String sectionKey = getSectionKey(pathVars);
1686          String mainClassName = getClassNameForSection(sectionKey);
1687          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1688          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1688          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1689          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1690  
<abbr title="1691          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1691          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1692          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1693          service.clearEntityManager();
1694          // First, we must save the collection entity
<abbr title="1695          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1695          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1696          Entity savedEntity = persistenceResponse.getEntity();
1697          entityFormValidator.validate(entityForm, savedEntity, result);
1698  
1699          if (result.hasErrors()) {
<abbr title="1700              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1700              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1701                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1702          }
1703  
1704          // Next, we must get the new list grid that represents this collection
1705          // We return the new list grid so that it can replace the currently visible one
<abbr title="1706          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1706          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1707  
1708          model.addAttribute(&quot;listGrid&quot;, listGrid);
1709          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1710          setModelAttributes(model, sectionKey);
1711          return &quot;views/standaloneListGrid&quot;;
1712      }
1713  
1714      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1715      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1716              HttpServletResponse response, Model model,
1717              @PathVariable  Map&lt;String, String&gt; pathVars,
1718              @PathVariable(value=&quot;id&quot;) String id,
1719              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1720              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1721              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1722          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1722          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1723      }
1724  
1725      /**
1726       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1727       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1728       *
1729       * @param request
1730       * @param response
1731       * @param model
1732       * @param pathVars
1733       * @param id
1734       * @param collectionField
1735       * @param collectionItemId
1736       * @return an object explaining the state of the operation
1737       * @throws Exception
1738       */
<abbr title="1739      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1739      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1740      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1741              HttpServletResponse response, Model model,
1742              @PathVariable  Map&lt;String, String&gt; pathVars,
1743              @PathVariable(value=&quot;id&quot;) String id,
1744              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1745              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1746              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1747              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1748          String sectionKey = getSectionKey(pathVars);
1749          String mainClassName = getClassNameForSection(sectionKey);
1750          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1751          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1751          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1752          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1753          FieldMetadata md = collectionProperty.getMetadata();
1754  
<abbr title="1755          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1755          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1756          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1757  
<abbr title="1758          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1758          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1759  
1760          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1761  
1762          if (md instanceof AdornedTargetCollectionMetadata) {
1763              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1764              AdornedTargetList atl = ppr.getAdornedList();
1765  
1766              // Get an entity form for the entity
<abbr title="1767              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1767              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
1768              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1769                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
1770                      .getDynamicResultSet().getRecords()[0];
1771              formService.populateEntityFormFields(entityForm, entity);
1772              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1773  
<abbr title="1774              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1774              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
1775              int sequenceValue = Integer.parseInt(newSequence) + 1;
1776              Field field = entityForm.findField(atl.getSortField());
1777              field.setValue(String.valueOf(sequenceValue));
1778  
1779              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1780              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1780              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1781              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1782  
1783              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1784              responseMap.put(&quot;field&quot;, collectionField);
1785              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1786              return responseMap;
1787          } else if (md instanceof BasicCollectionMetadata) {
1788              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1789              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1790              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1790              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
1791  
<abbr title="1792              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1792              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1793              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);




1794              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1795                  Field f = new Field()
1796                          .withName(cd.getSortProperty())
1797                          .withFieldType(SupportedFieldType.HIDDEN.toString());
1798                  entityForm.addHiddenField(mainMetadata, f);
1799              }
1800              formService.populateEntityFormFields(entityForm, entity);
1801  
1802              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1803                  int sequenceValue = Integer.parseInt(newSequence) + 1;
1804                  Field field = entityForm.findField(cd.getSortProperty());
1805                  field.setValue(String.valueOf(sequenceValue));
1806              }
1807  
<abbr title="1808              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1808              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1809              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1810  
1811              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1812              responseMap.put(&quot;field&quot;, collectionField);
1813              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1814              return responseMap;
1815          } else {
<abbr title="1816              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1816              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
1817          }
1818      }
1819  
1820      /**
1821       * Removes the requested collection item
1822       *
<abbr title="1823       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1823       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1824       * map collection.
1825       *
1826       * @param request
1827       * @param response
1828       * @param model
1829       * @param pathVars
1830       * @param id
1831       * @param collectionField
1832       * @param collectionItemId
1833       * @return the return view path
1834       * @throws Exception
1835       */
1836      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
1837      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1838              @PathVariable  Map&lt;String, String&gt; pathVars,
1839              @PathVariable(value=&quot;id&quot;) String id,
1840              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1841              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1842          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1842          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
1843      }
1844  
1845      /**
1846       * Removes the requested collection item
1847       *
<abbr title="1848       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1848       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1849       * map collection.
1850       *
1851       * @param request
1852       * @param response
1853       * @param model
1854       * @param pathVars
1855       * @param id
1856       * @param collectionField
1857       * @param collectionItemId
1858       * @return the return view path
1859       * @throws Exception
1860       */
<abbr title="1861      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1861      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
1862      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1863              @PathVariable  Map&lt;String, String&gt; pathVars,
1864              @PathVariable(value=&quot;id&quot;) String id,
1865              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1866              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1867              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1868          String sectionKey = getSectionKey(pathVars);
1869          String mainClassName = getClassNameForSection(sectionKey);
1870          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1871          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1871          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1872          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1873  
1874          String priorKey = request.getParameter(&quot;key&quot;);
1875  
<abbr title="1876          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1876          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1877          declareShouldIgnoreAdditionStatusFilter();
1878          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1879          service.clearEntityManager();
1880          // First, we must remove the collection entity
<abbr title="1881          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1881          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
1882          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
1883              String error = &quot;There was an error removing the whatever&quot;;
1884              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1885                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1886                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1886                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
1887              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
1888                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1889              }
1890              return new JsonResponse(response)
1891                  .with(&quot;status&quot;, &quot;error&quot;)
1892                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1893                  .done();
1894          }
1895  
1896          // Next, we must get the new list grid that represents this collection
1897          // We return the new list grid so that it can replace the currently visible one
<abbr title="1898          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1898          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1899  
1900          model.addAttribute(&quot;listGrid&quot;, listGrid);
1901          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1902          setModelAttributes(model, sectionKey);
1903          return &quot;views/standaloneListGrid&quot;;
1904      }
1905  
1906      public void addAuditableDisplayFields(EntityForm entityForm) {
1907          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1908          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1909              addAuditableDisplayField(entityForm, createdBy);
1910  
1911              createdBy.setIsVisible(false);
1912          }
1913          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1914          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1915              addAuditableDisplayField(entityForm, updatedBy);
1916  
1917              updatedBy.setIsVisible(false);
1918          }
1919      }
1920  
1921      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1922          Field displayField = buildAuditableDisplayField(userField);
1923  
1924          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1925          String userName = user == null ? null : user.getName();
1926          displayField.setValue(userName);
1927  
1928          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1929          if (auditGroup != null) {
1930              auditGroup.addField(displayField);
1931          }
1932      }
1933  
1934      private Field buildAuditableDisplayField(Field auditableField) {
1935          return new Field().withFieldType(SupportedFieldType.STRING.toString())
1936                  .withName(auditableField.getName() + &quot;Display&quot;)
1937                  .withFriendlyName(auditableField.getFriendlyName())
1938                  .withOrder(auditableField.getOrder())
1939                  .withOwningEntityClass(auditableField.getOwningEntityClass())
1940                  .withReadOnly(true);
1941      }
1942  
1943      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1944          String tabName = pathVars.get(&quot;tabName&quot;);
1945          if (StringUtils.isBlank(tabName)) {
1946              TabMetadata firstTab = cmd.getFirstTab();
1947              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1948          }
1949          return tabName;
1950      }
1951  
1952      // *****************************************
1953      // Typed Entity Helper Methods
1954      // *****************************************
1955  
1956      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1957          // Check if this is a typed entity
1958          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1959          if (typedEntitySection != null) {
1960              // Update the friendly name for this Entity Type
1961              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1962          }
1963      }
1964  
1965      // *********************************
1966      // ADDITIONAL SPRING-BOUND METHODS *
1967      // *********************************
1968  
1969      /**
1970       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="1971       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1971       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
1972       * or false. If the value is passed in as null, it will treat it as false.
1973       *
1974       * @param binder
1975       */
1976      @InitBinder
1977      public void initBinder(WebDataBinder binder) {
1978          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
1979          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
1980      }
1981  
1982  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            