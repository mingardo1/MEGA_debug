<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>569</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    569
                    <a href="568.html">prev</a>
                    <a href="570.html">next</a>
                    <a href="569_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_d3f904d1d764e0acb7127ddbeb050c2b3ff060b3_rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^1:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d3f904d1d764e0acb7127ddbeb050c2b3ff060b3^2:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d124305ffe07b66f8eee430b3c0ac1072281dc14:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b]], subset: [[b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.CacheMissVal;
  25 import com.dtstack.flink.sql.side.BaseSideInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  29 import com.dtstack.flink.sql.util.DateUtil;
  30 import io.vertx.core.json.JsonArray;
  31 import io.vertx.core.json.JsonObject;
  32 import io.vertx.ext.sql.SQLClient;
  33 import io.vertx.ext.sql.SQLConnection;
  34 import com.google.common.collect.Lists;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.configuration.Configuration;
  37 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  38 import org.apache.flink.types.Row;
  39 import org.slf4j.Logger;
  40 import org.slf4j.LoggerFactory;
  41 
  42 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  43 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 /**</span>
  50 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.time.Instant;</span>
  54 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  55 import java.util.List;
  56 import java.util.Map;
  57 
  58 /**
  59  * Date: 2018/11/26
  60  * Company: www.dtstack.com
  61  *
  62  * @author maqi
  63  */
  64 
  65 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  66 
  67     private static final long serialVersionUID = 2098635244857937720L;
  68 
  69     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  70 
  71     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  72 
<abbr title="  73     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  73     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  74 
<abbr title="  75     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  75     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  76 
  77     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  78 
  79     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  80 
  81     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  82 
<abbr title="  83     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  83     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  84 
  85     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  86 
  87     private transient SQLClient rdbSqlClient;
  88 
  89     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  90         super(sideInfo);
  91         init(sideInfo);
  92     }
  93 
  94     protected void init(BaseSideInfo sideInfo) {
  95         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  96         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  97         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  97         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  98         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  99     }
 100 
 101     @Override
 102     public void open(Configuration parameters) throws Exception {
 103         super.open(parameters);
 104         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
 105         LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
 106     }
 107 
 108     @Override
<abbr title=" 109     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 109     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr>
 110         Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);
 111 
 112         JsonArray inputParams = new JsonArray();
 113         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 114             Object equalObj = inputCopy.f1.getField(conValIndex);
 115             if (equalObj == null) {
 116                 dealMissKey(inputCopy, resultFuture);
 117                 return;
 118             }
 119             inputParams.add(convertDataType(equalObj));
 120         }
 121 
 122         String key = buildCacheKey(inputParams);
 123         if (openCache()) {
 124             CacheObj val = getFromCache(key);
 125             if (val != null) {
 126                 if (ECacheContentType.MissVal == val.getType()) {
 127                     dealMissKey(inputCopy, resultFuture);
 128                     return;
 129                 } else if (ECacheContentType.MultiLine == val.getType()) {
 130                     try {
<abbr title=" 131                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());"> 131                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContenðŸ”µ</abbr>
 132                         resultFuture.complete(rowList);
 133                     } catch (Exception e) {
 134                         dealFillDataError(resultFuture, e, inputCopy);
 135                     }
 136                 } else {
<abbr title=" 137                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 137                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr>
 138                 }
 139                 return;
 140             }
 141         }
 142 
 143         rdbSqlClient.getConnection(conn -&gt; {
 144             if (conn.failed()) {
 145                 //Treatment failures
 146                 resultFuture.completeExceptionally(conn.cause());
 147                 return;
 148             }
 149 
 150             final SQLConnection connection = conn.result();
 151             String sqlCondition = sideInfo.getSqlCondition();
 152             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 153                 if (rs.failed()) {
 154                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 155                     resultFuture.completeExceptionally(rs.cause());
 156                     return;
 157                 }
 158                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 159                 List&lt;JsonArray&gt; results = rs.result().getResults();
 160                 if (results.size() &gt; 0) {
 161                     try {
 162                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);
<abbr title=" 163                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 163                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr>
 164                         resultFuture.complete(rowList);
 165                     } catch (Exception e){
 166                         dealFillDataError(resultFuture, e, inputCopy);
 167                     }
 168                 } else {
 169                     dealMissKey(inputCopy, resultFuture);
 170                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 171                 }
 172 
 173                 // and close the connection
 174                 connection.close(done -&gt; {
 175                     if (done.failed()) {
 176                         throw new RuntimeException(done.cause());
 177                     }
 178                 });
 179             });
 180         });
 181     }
 182 
 183 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 184     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 184     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
 186 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         for (JsonArray line : results) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 cacheContent.add(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         return rowList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201     public Row fillData(Row input, Object line) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         JsonArray jsonArray = (JsonArray) line;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 207             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 207             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             if (jsonArray == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 219                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 219                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.gðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                 row.setField(entry.getKey(), object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         return row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     public void close() throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         super.close();</span>
 230 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232     private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         if (val == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257         } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258             val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260             val = DateUtil.dateToString((java.util.Date)val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262             val = val.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         return val;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
 269 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 270         for (JsonArray line : results) {
 271             Row row = fillData(inputRow.f1, line);
 272             if (null != cacheContent &amp;&amp; openCache()) {
 273                 cacheContent.add(line);
 274             }
 275             rowList.add(Tuple2.of(inputRow.f0, row));
 276         }
 277         return rowList;
 278     }
 279 
 280     @Override
 281     public Row fillData(Row input, Object line) {
 282         JsonArray jsonArray = (JsonArray) line;
 283         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 284         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 285         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 286             Object obj = input.getField(entry.getValue());
 287             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 288             row.setField(entry.getKey(), obj);
 289         }
 290 
 291         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 292             if (jsonArray == null) {
 293                 row.setField(entry.getKey(), null);
 294             } else {
<abbr title=" 295                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 295                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.gðŸ”µ</abbr>
 296                 row.setField(entry.getKey(), object);
 297             }
 298         }
 299 
 300         return row;
 301     }
 302 
 303     @Override
 304     public void close() throws Exception {
 305         super.close();
 306         if (rdbSqlClient != null) {
 307             rdbSqlClient.close();
 308         }
 309 
 310     }
 311 
 312     public String buildCacheKey(JsonArray jsonArray) {
 313         StringBuilder sb = new StringBuilder();
 314         for (Object ele : jsonArray.getList()) {
 315             sb.append(ele.toString())
 316                     .append(&quot;_&quot;);
 317         }
 318 
 319         return sb.toString();
 320     }
 321 
 322     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 323         this.rdbSqlClient = rdbSqlClient;
 324     }
 325 
 326 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.CacheMissVal;
  25 import com.dtstack.flink.sql.side.BaseSideInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  29 import com.dtstack.flink.sql.util.DateUtil;
  30 import io.vertx.core.json.JsonArray;
  31 import io.vertx.core.json.JsonObject;
  32 import io.vertx.ext.sql.SQLClient;
  33 import io.vertx.ext.sql.SQLConnection;
  34 import com.google.common.collect.Lists;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.configuration.Configuration;
  37 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  38 import org.apache.flink.types.Row;
  39 import org.slf4j.Logger;
  40 import org.slf4j.LoggerFactory;
  41 
  42 import java.math.BigDecimal;
  43 import java.time.Instant;
  44 
  45 import java.util.List;
  46 import java.util.Map;
  47 
  48 /**
  49  * Date: 2018/11/26
  50  * Company: www.dtstack.com
  51  *
  52  * @author maqi
  53  */
  54 
  55 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  56 
  57     private static final long serialVersionUID = 2098635244857937720L;
  58 
  59     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  60 
  61     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  62 
<abbr title="  63     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  63     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  64 
<abbr title="  65     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  65     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  66 
  67     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  68 
  69     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  70 
  71     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  72 
<abbr title="  73     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  73     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  74 
  75     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  76 
  77     private transient SQLClient rdbSqlClient;
  78 
  79     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  80         super(sideInfo);
  81         init(sideInfo);
  82     }
  83 
  84     protected void init(BaseSideInfo sideInfo) {
  85         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  86         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  87         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  87         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  88         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  89     }
  90 
  91     @Override
  92     public void open(Configuration parameters) throws Exception {
  93         super.open(parameters);
  94         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  95         LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
  96     }
  97 
  98     @Override
<abbr title="  99     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  99     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr>
 100         Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);
 101 
 102         JsonArray inputParams = new JsonArray();
 103         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 104             Object equalObj = inputCopy.f1.getField(conValIndex);
 105             if (equalObj == null) {
 106                 dealMissKey(inputCopy, resultFuture);
 107                 return;
 108             }
 109             inputParams.add(convertDataType(equalObj));
 110         }
 111 
 112         String key = buildCacheKey(inputParams);
 113         if (openCache()) {
 114             CacheObj val = getFromCache(key);
 115             if (val != null) {
 116                 if (ECacheContentType.MissVal == val.getType()) {
 117                     dealMissKey(inputCopy, resultFuture);
 118                     return;
 119                 } else if (ECacheContentType.MultiLine == val.getType()) {
 120                     try {
<abbr title=" 121                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());"> 121                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContenðŸ”µ</abbr>
 122                         resultFuture.complete(rowList);
 123                     } catch (Exception e) {
 124                         dealFillDataError(resultFuture, e, inputCopy);
 125                     }
 126                 } else {
<abbr title=" 127                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 127                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr>
 128                 }
 129                 return;
 130             }
 131         }
 132 
 133         rdbSqlClient.getConnection(conn -&gt; {
 134             if (conn.failed()) {
 135                 //Treatment failures
 136                 resultFuture.completeExceptionally(conn.cause());
 137                 return;
 138             }
 139 
 140             final SQLConnection connection = conn.result();
 141             String sqlCondition = sideInfo.getSqlCondition();
 142             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 143                 if (rs.failed()) {
 144                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 145                     resultFuture.completeExceptionally(rs.cause());
 146                     return;
 147                 }
 148                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 149                 List&lt;JsonArray&gt; results = rs.result().getResults();
 150                 if (results.size() &gt; 0) {
 151                     try {
 152                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);
<abbr title=" 153                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 153                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr>
 154                         resultFuture.complete(rowList);
 155                     } catch (Exception e){
 156                         dealFillDataError(resultFuture, e, inputCopy);
 157                     }
 158                 } else {
 159                     dealMissKey(inputCopy, resultFuture);
 160                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 161                 }
 162 
 163                 // and close the connection
 164                 connection.close(done -&gt; {
 165                     if (done.failed()) {
 166                         throw new RuntimeException(done.cause());
 167                     }
 168                 });
 169             });
 170         });
 171     }
 172 
<abbr title=" 173     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 173     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContðŸ”µ</abbr>
 174         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 175         for (JsonArray line : results) {
 176             Row row = fillData(inputRow.f1, line);
 177             if (null != cacheContent &amp;&amp; openCache()) {
 178                 cacheContent.add(line);
 179             }
 180             rowList.add(Tuple2.of(inputRow.f0, row));
 181         }
 182         return rowList;
 183     }
 184 
 185 
 186     private Object convertDataType(Object val) {
 187         if (val == null) {
 188             // OK
 189         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 190             // OK
 191         } else if (val instanceof Boolean) {
 192             // OK
 193         } else if (val instanceof String) {
 194             // OK
 195         } else if (val instanceof Character) {
 196             // OK
 197         } else if (val instanceof CharSequence) {
 198 
 199         } else if (val instanceof JsonObject) {
 200 
 201         } else if (val instanceof JsonArray) {
 202 
 203         } else if (val instanceof Map) {
 204 
 205         } else if (val instanceof List) {
 206 
 207         } else if (val instanceof byte[]) {
 208 
 209         } else if (val instanceof Instant) {
 210 
 211         } else if (val instanceof Timestamp) {
 212             val = DateUtil.timestampToString((Timestamp) val);
 213         } else if (val instanceof java.util.Date) {
 214             val = DateUtil.dateToString((java.util.Date)val);
 215         } else {
 216             val = val.toString();
 217         }
 218         return val;
 219     }
 220 
 221     @Override
 222     public Row fillData(Row input, Object line) {
 223         JsonArray jsonArray = (JsonArray) line;
 224         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 225         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 226         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 227             Object obj = input.getField(entry.getValue());
 228             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 229             row.setField(entry.getKey(), obj);
 230         }
 231 
 232         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 233             if (jsonArray == null) {
 234                 row.setField(entry.getKey(), null);
 235             } else {
<abbr title=" 236                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 236                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.gðŸ”µ</abbr>
 237                 row.setField(entry.getKey(), object);
 238             }
 239         }
 240 
 241         return row;
 242     }
 243 
 244     @Override
 245     public void close() throws Exception {
 246         super.close();
 247         if (rdbSqlClient != null) {
 248             rdbSqlClient.close();
 249         }
 250 
 251     }
 252 
 253     public String buildCacheKey(JsonArray jsonArray) {
 254         StringBuilder sb = new StringBuilder();
 255         for (Object ele : jsonArray.getList()) {
 256             sb.append(ele.toString())
 257                     .append(&quot;_&quot;);
 258         }
 259 
 260         return sb.toString();
 261     }
 262 
 263     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 264         this.rdbSqlClient = rdbSqlClient;
 265     }
 266 
 267 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.rdb.async;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  22 import com.dtstack.flink.sql.side.BaseSideInfo;
  23 import com.dtstack.flink.sql.side.CacheMissVal;
  24 import com.dtstack.flink.sql.side.cache.CacheObj;
  25 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  26 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  27 import com.dtstack.flink.sql.util.DateUtil;
  28 import com.google.common.collect.Lists;
  29 import io.vertx.core.json.JsonArray;
  30 import io.vertx.core.json.JsonObject;
  31 import io.vertx.ext.sql.SQLClient;
  32 import io.vertx.ext.sql.SQLConnection;
  33 import java.math.BigDecimal;
  34 import java.time.Instant;
  35 import java.util.List;
  36 import java.util.Map;
  37 import org.apache.flink.api.java.tuple.Tuple2;
  38 import org.apache.flink.configuration.Configuration;
  39 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40 import org.apache.flink.types.Row;
  41 import org.slf4j.Logger;
  42 import org.slf4j.LoggerFactory;
  43 
  44 
  45 /**
  46  * Date: 2018/11/26
  47  * Company: www.dtstack.com
  48  *
  49  * @author maqi
  50  */
  51 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  52     private static final long serialVersionUID = 2098635244857937720L;
  53 
  54     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  55 
  56     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  57 
<abbr title="  58     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  58     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  59 
<abbr title="  60     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  60     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  61 
  62     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  63 
  64     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  65 
  66     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  67 
<abbr title="  68     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  68     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  69 
  70     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  71 
  72     private transient SQLClient rdbSqlClient;
  73 
  74     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  75         super(sideInfo);
  76         init(sideInfo);
  77     }
  78 
  79     protected void init(BaseSideInfo sideInfo) {
  80         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  81         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  82         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  82         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  83         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  84     }
  85 
  86     @Override
  87     public void open(Configuration parameters) throws Exception {
  88         super.open(parameters);
  89         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  90         LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
  91     }
  92 
  93     @Override
<abbr title="  94     public void asyncInvoke(Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) throws Exception {">  94     public void asyncInvoke(Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) ðŸ”µ</abbr>
  95         Tuple2&lt;Boolean, Row&gt; inputCopy = Tuple2.of(input.f0, input.f1);
  96         JsonArray inputParams = new JsonArray();
  97         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
  98             Object equalObj = inputCopy.f1.getField(conValIndex);
  99             if (equalObj == null) {
 100                 dealMissKey(inputCopy, resultFuture);
 101                 return;
 102             }
 103             inputParams.add(convertDataType(equalObj));
 104         }
 105         String key = buildCacheKey(inputParams);
 106         if (openCache()) {
 107             CacheObj val = getFromCache(key);
 108             if (val != null) {
 109                 if (ECacheContentType.MissVal == val.getType()) {
 110                     dealMissKey(inputCopy, resultFuture);
 111                     return;
 112                 } else if (ECacheContentType.MultiLine == val.getType()) {
 113                     try {
<abbr title=" 114                         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = getRows(inputCopy, null, ((List) (val.getContent())));"> 114                         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = getRows(inputCopy, null, ((List) (val.getConðŸ”µ</abbr>
 115                         resultFuture.complete(rowList);
 116                     } catch (java.lang.Exception e) {
 117                         dealFillDataError(resultFuture, e, inputCopy);
 118                     }
 119                 } else {
<abbr title=" 120                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 120                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr>
 121                 }
 122                 return;
 123             }
 124         }
 125         rdbSqlClient.getConnection(( conn) -&gt; {
 126             if (conn.failed()) {
 127                 // Treatment failures
 128                 resultFuture.completeExceptionally(conn.cause());
 129                 return;
 130             }
 131             final SQLConnection connection = conn.result();
 132             String sqlCondition = sideInfo.getSqlCondition();
 133             connection.queryWithParams(sqlCondition, inputParams, ( rs) -&gt; {
 134                 if (rs.failed()) {
 135                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 136                     resultFuture.completeExceptionally(rs.cause());
 137                     return;
 138                 }
 139                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 140                 List&lt;JsonArray&gt; results = rs.result().getResults();
 141                 if (results.size() &gt; 0) {
 142                     try {
 143                         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);
<abbr title=" 144                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 144                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr>
 145                         resultFuture.complete(rowList);
 146                     } catch ( e) {
 147                         dealFillDataError(resultFuture, e, inputCopy);
 148                     }
 149                 } else {
 150                     dealMissKey(inputCopy, resultFuture);
 151                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 152                 }
 153                 // and close the connection
 154                 connection.close(( done) -&gt; {
 155                     if (done.failed()) {
 156                         throw new RuntimeException(done.cause());
 157                     }
 158                 });
 159             });
 160         });
 161     }
 162 
 163     private Object convertDataType(Object val) {
 164         if (val == null) {
 165             // OK
 166         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 167             // OK
 168         } else if (val instanceof Boolean) {
 169             // OK
 170         } else if (val instanceof String) {
 171             // OK
 172         } else if (val instanceof Character) {
 173             // OK
 174         } else if (val instanceof CharSequence) {
 175 
 176         } else if (val instanceof JsonObject) {
 177 
 178         } else if (val instanceof JsonArray) {
 179 
 180         } else if (val instanceof Map) {
 181 
 182         } else if (val instanceof List) {
 183 
 184         } else if (val instanceof byte[]) {
 185 
 186         } else if (val instanceof Instant) {
 187 
 188         } else if (val instanceof Timestamp) {
 189             val = DateUtil.timestampToString((Timestamp) val);
 190         } else if (val instanceof java.util.Date) {
 191             val = DateUtil.dateToString((java.util.Date)val);
 192         } else {
 193             val = val.toString();
 194         }
 195         return val;
 196     }
 197 
<abbr title=" 198     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 198     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContðŸ”µ</abbr>
 199         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 200         for (JsonArray line : results) {
 201             Row row = fillData(inputRow.f1, line);
 202             if ((null != cacheContent) &amp;&amp; openCache()) {
 203                 cacheContent.add(line);
 204             }
 205             rowList.add(Tuple2.of(inputRow.f0, row));
 206         }
 207         return rowList;
 208     }
 209 
 210     @Override
 211     public Row fillData(Row input, Object line) {
 212         JsonArray jsonArray = ((JsonArray) (line));
 213         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 214         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 215         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 216             Object obj = input.getField(entry.getValue());
 217             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 218             row.setField(entry.getKey(), obj);
 219         }
 220         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 221             if (jsonArray == null) {
 222                 row.setField(entry.getKey(), null);
 223             } else {
<abbr title=" 224                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 224                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.gðŸ”µ</abbr>
 225                 row.setField(entry.getKey(), object);
 226             }
 227         }
 228         return row;
 229     }
 230 
 231     @Override
 232     public void close() throws Exception {
 233         super.close();
 234         if (rdbSqlClient != null) {
 235             rdbSqlClient.close();
 236         }
 237 
 238     }
 239 
 240     public String buildCacheKey(JsonArray jsonArray) {
 241         StringBuilder sb = new StringBuilder();
 242         for (Object ele : jsonArray.getList()) {
 243             sb.append(ele.toString())
 244                     .append(&quot;_&quot;);
 245         }
 246 
 247         return sb.toString();
 248     }
 249 
 250     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 251         this.rdbSqlClient = rdbSqlClient;
 252     }
 253 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;
  23  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24  import com.dtstack.flink.sql.side.CacheMissVal;
  25  import com.dtstack.flink.sql.side.BaseSideInfo;
  26  import com.dtstack.flink.sql.side.cache.CacheObj;
  27  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;

  29  import io.vertx.core.json.JsonArray;

  30  import io.vertx.ext.sql.SQLClient;
  31  import io.vertx.ext.sql.SQLConnection;
  32  import com.google.common.collect.Lists;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  34  import org.apache.flink.configuration.Configuration;
  35  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
  38  import org.apache.flink.types.Row;
  39  import org.slf4j.Logger;
  40  import org.slf4j.LoggerFactory;
  41  

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.sql.Timestamp;</span>

  43  import java.util.List;
  44  import java.util.Map;
  45  
  46  /**
  47   * Date: 2018/11/26
  48   * Company: www.dtstack.com
  49   *
  50   * @author maqi
  51   */
  52  
  53  public class RdbAsyncReqRow extends BaseAsyncReqRow {
  54  
  55      private static final long serialVersionUID = 2098635244857937720L;
  56  
  57      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  58  
  59      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  60  
  61      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  62  
<abbr title="  63      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  63      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  64  
  65      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  66  
  67      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  68  
  69      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  70  
<abbr title="  71      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  71      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  72  
  73      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  74  
  75      private transient SQLClient rdbSqlClient;
  76  
  77      public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  78          super(sideInfo);
  79          init(sideInfo);
  80      }
  81  
  82      protected void init(BaseSideInfo sideInfo) {
  83          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  84          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  85          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  85          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
  86          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  87      }
  88  
  89      @Override
  90      public void open(Configuration parameters) throws Exception {
  91          super.open(parameters);
  92          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  93          LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
  94      }
  95  
  96      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  99 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  99 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws ExceðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +</span>
 102          JsonArray inputParams = new JsonArray();
 103          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            Object equalObj = inputCopy.f1.getField(conValIndex);</span>
 106              if (equalObj == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                dealMissKey(inputCopy, resultFuture);</span>
 109                  return;
 110              }
 111              inputParams.add(equalObj);

 112          }
 113  
 114          String key = buildCacheKey(inputParams);
 115          if (openCache()) {
 116              CacheObj val = getFromCache(key);
 117              if (val != null) {
 118                  if (ECacheContentType.MissVal == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                    dealMissKey(inputCopy, resultFuture);</span>
 121                      return;
 122                  } else if (ECacheContentType.MultiLine == val.getType()) {
 123                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());</span>
 126                          resultFuture.complete(rowList);
 127                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                        dealFillDataError(resultFuture, e, inputCopy);</span>
 130                      }
 131                  } else {
<abbr title=" 132                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 132                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr>
 133                  }
 134                  return;
 135              }
 136          }
 137  
 138          rdbSqlClient.getConnection(conn -&gt; {
 139              if (conn.failed()) {
 140                  //Treatment failures
 141                  resultFuture.completeExceptionally(conn.cause());
 142                  return;
 143              }
 144  
 145              final SQLConnection connection = conn.result();
 146              String sqlCondition = sideInfo.getSqlCondition();
 147              connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 148                  if (rs.failed()) {
 149                      LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 150                      resultFuture.completeExceptionally(rs.cause());
 151                      return;
 152                  }
 153                  List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 154                  List&lt;JsonArray&gt; results = rs.result().getResults();
 155                  if (results.size() &gt; 0) {
 156                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);</span>
 159                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 160                          resultFuture.complete(rowList);
 161                      } catch (Exception e){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                        dealFillDataError(resultFuture, e, inputCopy);</span>
 164                      }
 165                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                    dealMissKey(inputCopy, resultFuture);</span>
 168                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 169                  }
 170  
 171                  // and close the connection
 172                  connection.close(done -&gt; {
 173                      if (done.failed()) {
 174                          throw new RuntimeException(done.cause());
 175                      }
 176                  });
 177              });
 178          });
 179      }
 180  




































<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 183 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 183 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, ListðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
 185          for (JsonArray line : results) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -            Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +            Row row = fillData(inputRow.f1, line);</span>
 188              if (null != cacheContent &amp;&amp; openCache()) {
 189                  cacheContent.add(line);
 190              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +            rowList.add(Tuple2.of(inputRow.f0, row));</span>
 193          }
 194          return rowList;
 195      }
 196  
 197      @Override
 198      public Row fillData(Row input, Object line) {
 199          JsonArray jsonArray = (JsonArray) line;
 200          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 201          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 202          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 203              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 204 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 204 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 210              row.setField(entry.getKey(), obj);
 211          }
 212  
 213          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 214              if (jsonArray == null) {
 215                  row.setField(entry.getKey(), null);
 216              } else {
<abbr title=" 217                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 217                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()ðŸ”µ</abbr>
 218                  row.setField(entry.getKey(), object);
 219              }
 220          }
 221  
 222          return row;
 223      }
 224  
 225      @Override
 226      public void close() throws Exception {
 227          super.close();
 228          if (rdbSqlClient != null) {
 229              rdbSqlClient.close();
 230          }
 231  
 232      }
 233  
 234      public String buildCacheKey(JsonArray jsonArray) {
 235          StringBuilder sb = new StringBuilder();
 236          for (Object ele : jsonArray.getList()) {
 237              sb.append(ele.toString())
 238                      .append(&quot;_&quot;);
 239          }
 240  
 241          return sb.toString();
 242      }
 243  
 244      public void setRdbSqlClient(SQLClient rdbSqlClient) {
 245          this.rdbSqlClient = rdbSqlClient;
 246      }
 247  
 248  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;
  23  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24  import com.dtstack.flink.sql.side.CacheMissVal;
  25  import com.dtstack.flink.sql.side.BaseSideInfo;
  26  import com.dtstack.flink.sql.side.cache.CacheObj;
  27  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.dtstack.flink.sql.util.DateUtil;</span>
  30  import io.vertx.core.json.JsonArray;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import io.vertx.core.json.JsonObject;</span>
  32  import io.vertx.ext.sql.SQLClient;
  33  import io.vertx.ext.sql.SQLConnection;
  34  import com.google.common.collect.Lists;

  35  import org.apache.flink.configuration.Configuration;
  36  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  37  import org.apache.flink.table.runtime.types.CRow;
  38  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  39  import org.apache.flink.types.Row;
  40  import org.slf4j.Logger;
  41  import org.slf4j.LoggerFactory;
  42  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import java.math.BigDecimal;</span>
  44  import java.sql.Timestamp;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import java.time.Instant;</span>
  46  import java.util.List;
  47  import java.util.Map;
  48  
  49  /**
  50   * Date: 2018/11/26
  51   * Company: www.dtstack.com
  52   *
  53   * @author maqi
  54   */
  55  
  56  public class RdbAsyncReqRow extends BaseAsyncReqRow {
  57  
  58      private static final long serialVersionUID = 2098635244857937720L;
  59  
  60      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  61  
  62      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  63  
  64      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  65  
<abbr title="  66      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  66      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  67  
  68      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  69  
  70      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  71  
  72      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  73  
<abbr title="  74      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  74      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  75  
  76      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  77  
  78      private transient SQLClient rdbSqlClient;
  79  
  80      public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  81          super(sideInfo);
  82          init(sideInfo);
  83      }
  84  
  85      protected void init(BaseSideInfo sideInfo) {
  86          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  87          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  88          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  88          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
  89          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  90      }
  91  
  92      @Override
  93      public void open(Configuration parameters) throws Exception {
  94          super.open(parameters);
  95          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  96          LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
  97      }
  98  
  99      @Override
 100      public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {
 101          CRow copyCrow = new CRow(input.row(), input.change());



 102          JsonArray inputParams = new JsonArray();
 103          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 104              Object equalObj = copyCrow.row().getField(conValIndex);

 105              if (equalObj == null) {
 106                  dealMissKey(copyCrow, resultFuture);

 107                  return;
 108              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            inputParams.add(convertDataType(equalObj));</span>
 111          }
 112  
 113          String key = buildCacheKey(inputParams);
 114          if (openCache()) {
 115              CacheObj val = getFromCache(key);
 116              if (val != null) {
 117                  if (ECacheContentType.MissVal == val.getType()) {
 118                      dealMissKey(copyCrow, resultFuture);

 119                      return;
 120                  } else if (ECacheContentType.MultiLine == val.getType()) {
 121                      try {
 122                          List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());

 123                          resultFuture.complete(rowList);
 124                      } catch (Exception e) {
 125                          dealFillDataError(resultFuture, e, copyCrow);

 126                      }
 127                  } else {
<abbr title=" 128                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 128                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr>
 129                  }
 130                  return;
 131              }
 132          }
 133  
 134          rdbSqlClient.getConnection(conn -&gt; {
 135              if (conn.failed()) {
 136                  //Treatment failures
 137                  resultFuture.completeExceptionally(conn.cause());
 138                  return;
 139              }
 140  
 141              final SQLConnection connection = conn.result();
 142              String sqlCondition = sideInfo.getSqlCondition();
 143              connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 144                  if (rs.failed()) {
 145                      LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 146                      resultFuture.completeExceptionally(rs.cause());
 147                      return;
 148                  }
 149                  List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 150                  List&lt;JsonArray&gt; results = rs.result().getResults();
 151                  if (results.size() &gt; 0) {
 152                      try {
 153                          List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);

 154                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 155                          resultFuture.complete(rowList);
 156                      } catch (Exception e){
 157                          dealFillDataError(resultFuture, e, copyCrow);

 158                      }
 159                  } else {
 160                      dealMissKey(copyCrow, resultFuture);

 161                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 162                  }
 163  
 164                  // and close the connection
 165                  connection.close(done -&gt; {
 166                      if (done.failed()) {
 167                          throw new RuntimeException(done.cause());
 168                      }
 169                  });
 170              });
 171          });
 172      }
 173  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +    private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +        if (val == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            // OK</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +        } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +            // OK</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +        } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +            // OK</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +            // OK</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +            // OK</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +        } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +        } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +        } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +        } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +        } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +        } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +        } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +            val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +        } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +            val = DateUtil.dateToString((java.util.Date)val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +            val = val.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        return val;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +</span>
 210      protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {
 211          List&lt;CRow&gt; rowList = Lists.newArrayList();


 212          for (JsonArray line : results) {
 213              Row row = fillData(inputRow.row(), line);

 214              if (null != cacheContent &amp;&amp; openCache()) {
 215                  cacheContent.add(line);
 216              }
 217              rowList.add(new CRow(row, inputRow.change()));

 218          }
 219          return rowList;
 220      }
 221  
 222      @Override
 223      public Row fillData(Row input, Object line) {
 224          JsonArray jsonArray = (JsonArray) line;
 225          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 226          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 227          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 228              Object obj = input.getField(entry.getValue());
<abbr title=" 229              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 229              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 230              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 231                  obj = ((Timestamp) obj).getTime();
 232              }
 233  

 234              row.setField(entry.getKey(), obj);
 235          }
 236  
 237          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 238              if (jsonArray == null) {
 239                  row.setField(entry.getKey(), null);
 240              } else {
<abbr title=" 241                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 241                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()ðŸ”µ</abbr>
 242                  row.setField(entry.getKey(), object);
 243              }
 244          }
 245  
 246          return row;
 247      }
 248  
 249      @Override
 250      public void close() throws Exception {
 251          super.close();
 252          if (rdbSqlClient != null) {
 253              rdbSqlClient.close();
 254          }
 255  
 256      }
 257  
 258      public String buildCacheKey(JsonArray jsonArray) {
 259          StringBuilder sb = new StringBuilder();
 260          for (Object ele : jsonArray.getList()) {
 261              sb.append(ele.toString())
 262                      .append(&quot;_&quot;);
 263          }
 264  
 265          return sb.toString();
 266      }
 267  
 268      public void setRdbSqlClient(SQLClient rdbSqlClient) {
 269          this.rdbSqlClient = rdbSqlClient;
 270      }
 271  
 272  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            