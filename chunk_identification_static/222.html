<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>222</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    222
                    <a href="221.html">prev</a>
                    <a href="223.html">next</a>
                    <a href="222_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_c412990ee88a2479725586dcc88d504f38a5244c_common/src/main/java/org/broadleafcommerce/common/extensibility/jpa/cache/RemoveCacheClassTransformer.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c412990ee88a2479725586dcc88d504f38a5244c:common/src/main/java/org/broadleafcommerce/common/extensibility/jpa/cache/RemoveCacheClassTransformer.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c412990ee88a2479725586dcc88d504f38a5244c^1:common/src/main/java/org/broadleafcommerce/common/extensibility/jpa/cache/RemoveCacheClassTransformer.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c412990ee88a2479725586dcc88d504f38a5244c^2:common/src/main/java/org/broadleafcommerce/common/extensibility/jpa/cache/RemoveCacheClassTransformer.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce5c9279711e306f5901899835666ffa510d85bd:common/src/main/java/org/broadleafcommerce/common/extensibility/jpa/cache/RemoveCacheClassTransformer.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bs]], subset: [[bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * Copyright (C) 2009 - 2020 Broadleaf Commerce</span>
   7 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8 import javassist.CtClass;</span>
   9 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * Copyright (C) 2009 - 2019 Broadleaf Commerce</span>
  11 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  12  * %%
  13  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  14  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  15  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  16  * the Broadleaf End User License Agreement (EULA), Version 1.1
  17  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  18  * shall apply.
  19  * 
<abbr title="  20  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  20  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  21  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  21  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  22  * #L%
  23  */
  24 package org.broadleafcommerce.common.extensibility.jpa.cache;
  25 
  26 
  27 import javassist.ClassPool;
  28 import javassist.CtClass;
  29 import javassist.bytecode.AnnotationsAttribute;
  30 import javassist.bytecode.ClassFile;
  31 import javassist.bytecode.ConstPool;
  32 import javassist.bytecode.FieldInfo;
  33 import javassist.bytecode.annotation.Annotation;
  34 import javassist.bytecode.annotation.MemberValue;
  35 import javassist.bytecode.annotation.StringMemberValue;
  36 
  37 import org.apache.commons.logging.Log;
  38 import org.apache.commons.logging.LogFactory;
  39 import org.broadleafcommerce.common.extensibility.context.merge.Merge;
  40 import org.broadleafcommerce.common.extensibility.jpa.convert.BroadleafClassTransformer;
  41 import org.broadleafcommerce.common.extensibility.jpa.copy.AbstractClassTransformer;
  42 import org.springframework.beans.BeansException;
  43 import org.springframework.beans.factory.BeanFactory;
  44 import org.springframework.beans.factory.BeanFactoryAware;
  45 import org.springframework.beans.factory.config.ConfigurableBeanFactory;
  46 
  47 import java.io.ByteArrayInputStream;
  48 import java.lang.instrument.IllegalClassFormatException;
  49 import java.security.ProtectionDomain;
  50 import java.util.ArrayList;
  51 import java.util.Iterator;
  52 import java.util.List;
  53 import java.util.Properties;
  54 
  55 /**
  56  * Strip the cache annotation from classes and the class fields
  57  * 
  58  * Example configuration
  59  * 
  60  * &lt;pre&gt;
  61  * {@code
  62  * @Merge(&quot;blMergedClassTransformers&quot;)
  63  * public RemoveCacheClassTransformer RemoveProductCache() {
  64  *     RemoveCacheClassTransformer transformer = new RemoveCacheClassTransformer(&quot;Remove Product Cache&quot;);
  65  *     //optional property that can be enabled/disabled as needed
  66  *     transformer.setConditionalPropertyName(&quot;remove.order.customer.entity.l2cache&quot;);
  67  *     List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  68  *     cacheRegions.add(&quot;blCustomerElements&quot;);
  69  *     cacheRegions.add(&quot;blOrderElements&quot;);
  70  *     transformer.setCacheRegions(cacheRegions);
  71  *     return transformer;
  72  * }
  73  * }
  74  * &lt;/pre&gt;
  75  * 
  76  * @author Jeff Fischer
  77  * @author Daniel Colgrove
  78  */
<abbr title="  79 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeanFactoryAware {">  79 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransfðŸ”µ</abbr>
  80 
  81     private static final Log logger = LogFactory.getLog(RemoveCacheClassTransformer.class);
  82 
  83     protected String moduleName;
  84     protected List&lt;String&gt; classNames = new ArrayList&lt;String&gt;();
  85     protected List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  86     protected String annotationClass = &quot;org.hibernate.annotations.Cache&quot;;
  87     protected String conditionalPropertyName;
  88     protected ConfigurableBeanFactory beanFactory;
  89 
  90     public RemoveCacheClassTransformer(String moduleName) {
  91         this.moduleName = moduleName;
  92     }
  93 
  94     @Override
  95     public void compileJPAProperties(Properties props, Object key) throws Exception {
<abbr title="  96         // When simply copying properties over for Java class files, JPA properties do not need modification">  96         // When simply copying properties over for Java class files, JPA properties do not need modificatðŸ”µ</abbr>
  97     }
  98 
  99     @Override
 100     public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
 101         this.beanFactory = (ConfigurableBeanFactory) beanFactory;
 102     }
 103 
 104     @Override
 105     public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
<abbr title=" 106             ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {"> 106             ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatExceptionðŸ”µ</abbr>
 107 
<abbr title=" 108         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation should be done"> 108         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformatðŸ”µ</abbr>
 109         if (className == null) {
 110             return null;
 111         }
 112 
<abbr title=" 113         //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCircularityError"> 113         //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause aðŸ”µ</abbr>
 114         //under JRebel. Favor not including outside libraries and unnecessary classes.
 115         CtClass clazz = null;
 116         try {
 117             String convertedClassName = className.replace(&#x27;/&#x27;, &#x27;.&#x27;);
 118             
<abbr title=" 119             // If there is a class list specified, make sure the current class qualifies to have the annotation removed"> 119             // If there is a class list specified, make sure the current class qualifies to have the annoðŸ”µ</abbr>
 120             if (conditionalPropertyEnabled() &amp;&amp; classQualifies(convertedClassName)) {
 121                 ClassPool classPool = ClassPool.getDefault();
 122                 clazz = classPool.makeClass(new ByteArrayInputStream(classfileBuffer), false);
 123                 clazz.defrost();
 124                 ClassFile classFile = clazz.getClassFile();
 125                 ConstPool constantPool = classFile.getConstPool();
 126                 List&lt;?&gt; classAttributes = classFile.getAttributes();
 127 
 128                 // Only remove the annotation if it is for one of the specified regions
 129                 if (annotationQualifies(constantPool, classAttributes)) {
<abbr title=" 130                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributes);"> 130                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAðŸ”µ</abbr>
 131                     classFile.addAttribute(classAnnotationsAttribute);
 132 
 133                     List&lt;FieldInfo&gt; fieldInfos = classFile.getFields();
 134                     for (FieldInfo myField : fieldInfos) {
 135                         List&lt;?&gt; attributes = myField.getAttributes();
<abbr title=" 136                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes);"> 136                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, atðŸ”µ</abbr>
 137                         myField.addAttribute(fieldAnnotationsAttribute);
 138                     }
 139 
 140                     return clazz.toBytecode();
 141                     
 142                 }
 143             }
 144         } catch (ClassCircularityError error) {
 145             error.printStackTrace();
 146             throw error;
 147         } catch (Exception e) {
 148             throw new RuntimeException(&quot;Unable to transform class&quot;, e);
 149         } finally {
 150             if (clazz != null) {
 151                 try {
 152                     clazz.detach();
 153                 } catch (Exception e) {
 154                     //do nothing
 155                 }
 156             }
 157         }
 158 
 159         return null;
 160     }
 161 
<abbr title=" 162     // If there is a conditional, it should be true.  Also verifies that region names are set, which is required"> 162     // If there is a conditional, it should be true.  Also verifies that region names are set, which is rðŸ”µ</abbr>
 163     protected Boolean conditionalPropertyEnabled() {
<abbr title=" 164         Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyEnabled(conditionalPropertyName) );"> 164         Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; iðŸ”µ</abbr>
 165         return conditionTrue &amp;&amp; !cacheRegions.isEmpty();
 166     }
 167     
 168     // Checks that the passes class name qualifies to be transformed
 169     protected Boolean classQualifies(String className) {
<abbr title=" 170         Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className) );"> 170         Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(cðŸ”µ</abbr>
 171         return classQualifies;
 172     }
 173 
 174     // Checks is the annotation matches the &quot;annotationClass&quot;
 175     protected Boolean annotationQualifies(ConstPool constantPool, List&lt;?&gt; attributes) {
 176         boolean qualifies = false;
 177         
 178         Iterator&lt;?&gt; itr = attributes.iterator();        
 179         while (itr.hasNext()) {
 180             Object object = itr.next();
 181             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 182                 AnnotationsAttribute attr = (AnnotationsAttribute) object;
 183                 Annotation[] items = attr.getAnnotations();
 184                 for (Annotation annotation : items) {
 185                     String typeName = annotation.getTypeName();
 186                     if (typeName.equals(annotationClass) &amp;&amp; cacheRegionQualifies(annotation)) {
 187                         qualifies = true;
 188                         break;
 189                     }
 190                 }
 191             }
 192         }
 193         return qualifies;        
 194     }
 195 
 196     // Checks that the Annotation &quot;region&quot; is in the list of cacheRegions to be removed
 197     protected Boolean cacheRegionQualifies(Annotation annotation) {
 198         MemberValue memberValue = annotation.getMemberValue(&quot;region&quot;);
 199         if (StringMemberValue.class.isAssignableFrom(memberValue.getClass())) {
 200             StringMemberValue smv = (StringMemberValue) memberValue;
 201             if (cacheRegions.contains(smv.getValue())) {
 202                 return true;
 203             }
 204         }
 205         return false;
 206     }
 207 
<abbr title=" 208     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been verified)"> 208     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been veriðŸ”µ</abbr>
 209     protected AnnotationsAttribute stripAnnotation(ConstPool constantPool, List&lt;?&gt; attributes) {
 210         Iterator&lt;?&gt; itr = attributes.iterator();
<abbr title=" 211         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.visibleTag);"> 211         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttðŸ”µ</abbr>
 212 
 213         while (itr.hasNext()) {
 214             Object object = itr.next();
 215             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 216                 AnnotationsAttribute attr = (AnnotationsAttribute) object;
 217                 Annotation[] items = attr.getAnnotations();
 218                 for (Annotation annotation : items) {
 219                     String typeName = annotation.getTypeName();
 220                     if (typeName.equals(annotationClass)) {
 221                         logger.debug(String.format(&quot;Stripping out %s annotation&quot;, annotationClass));
 222                         continue;
 223                     }
 224                     annotationsAttribute.addAnnotation(annotation);
 225                 }
 226                 itr.remove();
 227             }
 228         }
 229         return annotationsAttribute;
 230     }
 231     
 232     protected Boolean isPropertyEnabled(String propertyName) {
 233         Boolean shouldProceed;
 234         try {
 235             String value = beanFactory.resolveEmbeddedValue(&quot;${&quot; + propertyName + &quot;:false}&quot;);
 236             shouldProceed = Boolean.parseBoolean(value);
 237         } catch (Exception e) {
 238             shouldProceed = false;
 239         }
 240         return shouldProceed;
 241     }
 242 
 243     /**
 244      * The list of fully-qualified classes to be impacted by this transformer
 245      *
 246      * @return
 247      */
 248     public List&lt;String&gt; getClassNames() {
 249         return classNames;
 250     }
 251 
 252     public void setClassNames(List&lt;String&gt; classNames) {
 253         this.classNames = classNames;
 254     }
 255 
 256     /**
 257      * The list of cache region names to be removed by this transformer
 258      *
 259      * @return
 260      */
 261     public List&lt;String&gt; getCacheRegions() {
 262         return cacheRegions;
 263     }
 264 
 265     public void setCacheRegions(List&lt;String&gt; cacheRegions) {
 266         this.cacheRegions = cacheRegions;
 267     }
 268     
 269     /**
 270      * The fully-qualified classname of the annotation to remove at the class and field level
 271      *
 272      * @return
 273      */
 274     public String getAnnotationClass() {
 275         return annotationClass;
 276     }
 277 
 278     public void setAnnotationClass(String annotationClass) {
 279         this.annotationClass = annotationClass;
 280     }
 281 
 282     /**
<abbr title=" 283      * Optional property to declare to gate the activity of this instance of the class tranformer. If a property is specified,"> 283      * Optional property to declare to gate the activity of this instance of the class tranformer. If a pðŸ”µ</abbr>
 284      * and it does not exist or is set to &quot;false&quot;, the class transformation will be skipped.
 285      *
 286      * @return
 287      */
 288     public String getConditionalPropertyName() {
 289         return conditionalPropertyName;
 290     }
 291 
 292     public void setConditionalPropertyName(String conditionalPropertyName) {
 293         this.conditionalPropertyName = conditionalPropertyName;
 294     }
 295 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2020 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.extensibility.jpa.cache;
  19 
  20 
  21 import javassist.ClassPool;
  22 import javassist.CtClass;
  23 import javassist.bytecode.AnnotationsAttribute;
  24 import javassist.bytecode.ClassFile;
  25 import javassist.bytecode.ConstPool;
  26 import javassist.bytecode.FieldInfo;
  27 import javassist.bytecode.annotation.Annotation;
  28 import javassist.bytecode.annotation.MemberValue;
  29 import javassist.bytecode.annotation.StringMemberValue;
  30 
  31 import org.apache.commons.logging.Log;
  32 import org.apache.commons.logging.LogFactory;
  33 import org.broadleafcommerce.common.extensibility.context.merge.Merge;
  34 import org.broadleafcommerce.common.extensibility.jpa.convert.BroadleafClassTransformer;
  35 import org.broadleafcommerce.common.extensibility.jpa.copy.AbstractClassTransformer;
  36 import org.springframework.beans.BeansException;
  37 import org.springframework.beans.factory.BeanFactory;
  38 import org.springframework.beans.factory.BeanFactoryAware;
  39 import org.springframework.beans.factory.config.ConfigurableBeanFactory;
  40 
  41 import java.io.ByteArrayInputStream;
  42 import java.lang.instrument.IllegalClassFormatException;
  43 import java.security.ProtectionDomain;
  44 import java.util.ArrayList;
  45 import java.util.Iterator;
  46 import java.util.List;
  47 import java.util.Properties;
  48 
  49 /**
  50  * Strip the cache annotation from classes and the class fields
  51  *
  52  * Example configuration
  53  *
  54  * &lt;pre&gt;
  55  * {@code
  56  * @Merge(&quot;blMergedClassTransformers&quot;)
  57  * public RemoveCacheClassTransformer RemoveProductCache() {
  58  *     RemoveCacheClassTransformer transformer = new RemoveCacheClassTransformer(&quot;Remove Product Cache&quot;);
  59  *     //optional property that can be enabled/disabled as needed
  60  *     transformer.setConditionalPropertyName(&quot;remove.order.customer.entity.l2cache&quot;);
  61  *     List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  62  *     cacheRegions.add(&quot;blCustomerElements&quot;);
  63  *     cacheRegions.add(&quot;blOrderElements&quot;);
  64  *     transformer.setCacheRegions(cacheRegions);
  65  *     return transformer;
  66  * }
  67  * }
  68  * &lt;/pre&gt;
  69  *
  70  * @author Jeff Fischer
  71  * @author Daniel Colgrove
  72  */
<abbr title="  73 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeanFactoryAware {">  73 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransfðŸ”µ</abbr>
  74 
  75     private static final Log logger = LogFactory.getLog(RemoveCacheClassTransformer.class);
  76 
  77     protected String moduleName;
  78     protected List&lt;String&gt; classNames = new ArrayList&lt;String&gt;();
  79     protected List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  80     protected String annotationClass = &quot;org.hibernate.annotations.Cache&quot;;
  81     protected String conditionalPropertyName;
  82     protected ConfigurableBeanFactory beanFactory;
  83 
  84     public RemoveCacheClassTransformer(String moduleName) {
  85         this.moduleName = moduleName;
  86     }
  87 
  88     @Override
  89     public void compileJPAProperties(Properties props, Object key) throws Exception {
<abbr title="  90         // When simply copying properties over for Java class files, JPA properties do not need modification">  90         // When simply copying properties over for Java class files, JPA properties do not need modificatðŸ”µ</abbr>
  91     }
  92 
  93     @Override
  94     public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
  95         this.beanFactory = (ConfigurableBeanFactory) beanFactory;
  96     }
  97 
  98     @Override
  99     public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
<abbr title=" 100             ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {"> 100             ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatExceptionðŸ”µ</abbr>
 101 
<abbr title=" 102         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation should be done"> 102         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformatðŸ”µ</abbr>
 103         if (className == null) {
 104             return null;
 105         }
 106 
<abbr title=" 107         //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCircularityError"> 107         //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause aðŸ”µ</abbr>
 108         //under JRebel. Favor not including outside libraries and unnecessary classes.
 109         CtClass clazz = null;
 110         try {
 111             String convertedClassName = className.replace(&#x27;/&#x27;, &#x27;.&#x27;);
 112 
<abbr title=" 113             // If there is a class list specified, make sure the current class qualifies to have the annotation removed"> 113             // If there is a class list specified, make sure the current class qualifies to have the annoðŸ”µ</abbr>
 114             if (conditionalPropertyEnabled() &amp;&amp; classQualifies(convertedClassName)) {
 115                 ClassPool classPool = ClassPool.getDefault();
 116                 clazz = classPool.makeClass(new ByteArrayInputStream(classfileBuffer), false);
 117                 clazz.defrost();
 118                 ClassFile classFile = clazz.getClassFile();
 119                 ConstPool constantPool = classFile.getConstPool();
 120                 List&lt;?&gt; classAttributes = classFile.getAttributes();
 121 
 122                 // Only remove the annotation if it is for one of the specified regions
 123                 if (annotationQualifies(constantPool, classAttributes)) {
<abbr title=" 124                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributes);"> 124                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAðŸ”µ</abbr>
 125                     classFile.addAttribute(classAnnotationsAttribute);
 126 
 127                     List&lt;FieldInfo&gt; fieldInfos = classFile.getFields();
 128                     for (FieldInfo myField : fieldInfos) {
 129                         List&lt;?&gt; attributes = myField.getAttributes();
<abbr title=" 130                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes);"> 130                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, atðŸ”µ</abbr>
 131                         myField.addAttribute(fieldAnnotationsAttribute);
 132                     }
 133 
 134                     return clazz.toBytecode();
 135 
 136                 }
 137             }
 138         } catch (ClassCircularityError error) {
 139             error.printStackTrace();
 140             throw error;
 141         } catch (Exception e) {
 142             throw new RuntimeException(&quot;Unable to transform class&quot;, e);
 143         } finally {
 144             if (clazz != null) {
 145                 try {
 146                     clazz.detach();
 147                 } catch (Exception e) {
 148                     //do nothing
 149                 }
 150             }
 151         }
 152 
 153         return null;
 154     }
 155 
<abbr title=" 156     // If there is a conditional, it should be true.  Also verifies that region names are set, which is required"> 156     // If there is a conditional, it should be true.  Also verifies that region names are set, which is rðŸ”µ</abbr>
 157     protected Boolean conditionalPropertyEnabled() {
<abbr title=" 158         Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyEnabled(conditionalPropertyName) );"> 158         Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; iðŸ”µ</abbr>
 159         return conditionTrue &amp;&amp; !cacheRegions.isEmpty();
 160     }
 161 
 162     // Checks that the passes class name qualifies to be transformed
 163     protected Boolean classQualifies(String className) {
<abbr title=" 164         Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className) );"> 164         Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(cðŸ”µ</abbr>
 165         return classQualifies;
 166     }
 167 
 168     // Checks is the annotation matches the &quot;annotationClass&quot;
 169     protected Boolean annotationQualifies(ConstPool constantPool, List&lt;?&gt; attributes) {
 170         boolean qualifies = false;
 171 
 172         Iterator&lt;?&gt; itr = attributes.iterator();
 173         while (itr.hasNext()) {
 174             Object object = itr.next();
 175             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 176                 AnnotationsAttribute attr = (AnnotationsAttribute) object;
 177                 Annotation[] items = attr.getAnnotations();
 178                 for (Annotation annotation : items) {
 179                     String typeName = annotation.getTypeName();
 180                     if (typeName.equals(annotationClass) &amp;&amp; cacheRegionQualifies(annotation)) {
 181                         qualifies = true;
 182                         break;
 183                     }
 184                 }
 185             }
 186         }
 187         return qualifies;
 188     }
 189 
 190     // Checks that the Annotation &quot;region&quot; is in the list of cacheRegions to be removed
 191     protected Boolean cacheRegionQualifies(Annotation annotation) {
 192         MemberValue memberValue = annotation.getMemberValue(&quot;region&quot;);
 193         if (StringMemberValue.class.isAssignableFrom(memberValue.getClass())) {
 194             StringMemberValue smv = (StringMemberValue) memberValue;
 195             if (cacheRegions.contains(smv.getValue())) {
 196                 return true;
 197             }
 198         }
 199         return false;
 200     }
 201 
<abbr title=" 202     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been verified)"> 202     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been veriðŸ”µ</abbr>
 203     protected AnnotationsAttribute stripAnnotation(ConstPool constantPool, List&lt;?&gt; attributes) {
 204         Iterator&lt;?&gt; itr = attributes.iterator();
<abbr title=" 205         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.visibleTag);"> 205         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttðŸ”µ</abbr>
 206 
 207         while (itr.hasNext()) {
 208             Object object = itr.next();
 209             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 210                 AnnotationsAttribute attr = (AnnotationsAttribute) object;
 211                 Annotation[] items = attr.getAnnotations();
 212                 for (Annotation annotation : items) {
 213                     String typeName = annotation.getTypeName();
 214                     if (typeName.equals(annotationClass)) {
 215                         logger.debug(String.format(&quot;Stripping out %s annotation&quot;, annotationClass));
 216                         continue;
 217                     }
 218                     annotationsAttribute.addAnnotation(annotation);
 219                 }
 220                 itr.remove();
 221             }
 222         }
 223         return annotationsAttribute;
 224     }
 225 
 226     protected Boolean isPropertyEnabled(String propertyName) {
 227         Boolean shouldProceed;
 228         try {
 229             String value = beanFactory.resolveEmbeddedValue(&quot;${&quot; + propertyName + &quot;:false}&quot;);
 230             shouldProceed = Boolean.parseBoolean(value);
 231         } catch (Exception e) {
 232             shouldProceed = false;
 233         }
 234         return shouldProceed;
 235     }
 236 
 237     /**
 238      * The list of fully-qualified classes to be impacted by this transformer
 239      *
 240      * @return
 241      */
 242     public List&lt;String&gt; getClassNames() {
 243         return classNames;
 244     }
 245 
 246     public void setClassNames(List&lt;String&gt; classNames) {
 247         this.classNames = classNames;
 248     }
 249 
 250     /**
 251      * The list of cache region names to be removed by this transformer
 252      *
 253      * @return
 254      */
 255     public List&lt;String&gt; getCacheRegions() {
 256         return cacheRegions;
 257     }
 258 
 259     public void setCacheRegions(List&lt;String&gt; cacheRegions) {
 260         this.cacheRegions = cacheRegions;
 261     }
 262 
 263     /**
 264      * The fully-qualified classname of the annotation to remove at the class and field level
 265      *
 266      * @return
 267      */
 268     public String getAnnotationClass() {
 269         return annotationClass;
 270     }
 271 
 272     public void setAnnotationClass(String annotationClass) {
 273         this.annotationClass = annotationClass;
 274     }
 275 
 276     /**
<abbr title=" 277      * Optional property to declare to gate the activity of this instance of the class tranformer. If a property is specified,"> 277      * Optional property to declare to gate the activity of this instance of the class tranformer. If a pðŸ”µ</abbr>
 278      * and it does not exist or is set to &quot;false&quot;, the class transformation will be skipped.
 279      *
 280      * @return
 281      */
 282     public String getConditionalPropertyName() {
 283         return conditionalPropertyName;
 284     }
 285 
 286     public void setConditionalPropertyName(String conditionalPropertyName) {
 287         this.conditionalPropertyName = conditionalPropertyName;
 288     }
 289 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * Copyright (C) 2009 - 2020 Broadleaf Commerce</span>
   7 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   8 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   8 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
   9 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * Copyright (C) 2009 - 2019 Broadleaf Commerce</span>
  12 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  13  * %%
  14  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  15  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  16  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  17  * the Broadleaf End User License Agreement (EULA), Version 1.1
  18  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  19  * shall apply.
  20  *
<abbr title="  21  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  21  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  22  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  22  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  23  * #L%
  24  */
  25 package org.broadleafcommerce.common.extensibility.jpa.cache;
  26 
  27 import java.io.ByteArrayInputStream;
  28 import java.lang.instrument.IllegalClassFormatException;
  29 import java.security.ProtectionDomain;
  30 import java.util.ArrayList;
  31 import java.util.Iterator;
  32 import java.util.List;
  33 import java.util.Properties;
  34 import javassist.ClassPool;
  35 import javassist.CtClass;
  36 import javassist.bytecode.AnnotationsAttribute;
  37 import javassist.bytecode.ClassFile;
  38 import javassist.bytecode.ConstPool;
  39 import javassist.bytecode.FieldInfo;
  40 import javassist.bytecode.annotation.Annotation;
  41 import javassist.bytecode.annotation.MemberValue;
  42 import javassist.bytecode.annotation.StringMemberValue;
  43 import org.apache.commons.logging.Log;
  44 import org.apache.commons.logging.LogFactory;
  45 import org.broadleafcommerce.common.extensibility.context.merge.Merge;
  46 import org.broadleafcommerce.common.extensibility.jpa.convert.BroadleafClassTransformer;
  47 import org.broadleafcommerce.common.extensibility.jpa.copy.AbstractClassTransformer;
  48 import org.springframework.beans.BeansException;
  49 import org.springframework.beans.factory.BeanFactory;
  50 import org.springframework.beans.factory.BeanFactoryAware;
  51 import org.springframework.beans.factory.config.ConfigurableBeanFactory;
  52 
  53 
  54 /**
  55  * Strip the cache annotation from classes and the class fields
  56  *
  57  * Example configuration
  58  *
  59  * &lt;pre&gt;
  60  * {@code
  61  *
  62  * @unknown public RemoveCacheClassTransformer RemoveProductCache() {
  63 RemoveCacheClassTransformer transformer = new RemoveCacheClassTransformer(&quot;Remove Product Cache&quot;);
  64 //optional property that can be enabled/disabled as needed
  65 transformer.setConditionalPropertyName(&quot;remove.order.customer.entity.l2cache&quot;);
  66 List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  67 cacheRegions.add(&quot;blCustomerElements&quot;);
  68 cacheRegions.add(&quot;blOrderElements&quot;);
  69 transformer.setCacheRegions(cacheRegions);
  70 return transformer;
  71 }
  72 }
  73 &lt;/pre&gt;
  74  * @author Jeff Fischer
  75  * @author Daniel Colgrove
  76  */
<abbr title="  77 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer , BeanFactoryAware {">  77 public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransfðŸ”µ</abbr>
  78     private static final Log logger = LogFactory.getLog(RemoveCacheClassTransformer.class);
  79 
  80     protected String moduleName;
  81 
  82     protected List&lt;String&gt; classNames = new ArrayList&lt;String&gt;();
  83 
  84     protected List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  85 
  86     protected String annotationClass = &quot;org.hibernate.annotations.Cache&quot;;
  87 
  88     protected String conditionalPropertyName;
  89 
  90     protected ConfigurableBeanFactory beanFactory;
  91 
  92     public RemoveCacheClassTransformer(String moduleName) {
  93         this.moduleName = moduleName;
  94     }
  95 
  96     @Override
  97     public void compileJPAProperties(Properties props, Object key) throws Exception {
<abbr title="  98         // When simply copying properties over for Java class files, JPA properties do not need modification">  98         // When simply copying properties over for Java class files, JPA properties do not need modificatðŸ”µ</abbr>
  99     }
 100 
 101     @Override
 102     public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
 103         this.beanFactory = ((ConfigurableBeanFactory) (beanFactory));
 104     }
 105 
 106     @Override
<abbr title=" 107     public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {"> 107     public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectioðŸ”µ</abbr>
<abbr title=" 108         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation should be done"> 108         // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformatðŸ”µ</abbr>
 109         if (className == null) {
 110             return null;
 111         }
<abbr title=" 112         // Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCircularityError"> 112         // Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause ðŸ”µ</abbr>
 113         // under JRebel. Favor not including outside libraries and unnecessary classes.
 114         CtClass clazz = null;
 115         try {
 116             String convertedClassName = className.replace(&#x27;/&#x27;, &#x27;.&#x27;);
<abbr title=" 117             // If there is a class list specified, make sure the current class qualifies to have the annotation removed"> 117             // If there is a class list specified, make sure the current class qualifies to have the annoðŸ”µ</abbr>
 118             if (conditionalPropertyEnabled() &amp;&amp; classQualifies(convertedClassName)) {
 119                 ClassPool classPool = ClassPool.getDefault();
 120                 clazz = classPool.makeClass(new ByteArrayInputStream(classfileBuffer), false);
 121                 clazz.defrost();
 122                 ClassFile classFile = clazz.getClassFile();
 123                 ConstPool constantPool = classFile.getConstPool();
 124                 List&lt;?&gt; classAttributes = classFile.getAttributes();
 125                 // Only remove the annotation if it is for one of the specified regions
 126                 if (annotationQualifies(constantPool, classAttributes)) {
<abbr title=" 127                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributes);"> 127                     AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAðŸ”µ</abbr>
 128                     classFile.addAttribute(classAnnotationsAttribute);
 129                     List&lt;FieldInfo&gt; fieldInfos = classFile.getFields();
 130                     for (FieldInfo myField : fieldInfos) {
 131                         List&lt;?&gt; attributes = myField.getAttributes();
<abbr title=" 132                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes);"> 132                         AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, atðŸ”µ</abbr>
 133                         myField.addAttribute(fieldAnnotationsAttribute);
 134                     }
 135                     return clazz.toBytecode();
 136                 }
 137             }
 138         } catch (java.lang.ClassCircularityError error) {
 139             error.printStackTrace();
 140             throw error;
 141         } catch (java.lang.Exception e) {
 142             throw new RuntimeException(&quot;Unable to transform class&quot;, e);
 143         } finally {
 144             if (clazz != null) {
 145                 try {
 146                     clazz.detach();
 147                 } catch (java.lang.Exception e) {
 148                     // do nothing
 149                 }
 150             }
 151         }
 152         return null;
 153     }
 154 
<abbr title=" 155     // If there is a conditional, it should be true.  Also verifies that region names are set, which is required"> 155     // If there is a conditional, it should be true.  Also verifies that region names are set, which is rðŸ”µ</abbr>
 156     protected Boolean conditionalPropertyEnabled() {
<abbr title=" 157         Boolean conditionTrue = (conditionalPropertyName == null) || ((conditionalPropertyName != null) &amp;&amp; isPropertyEnabled(conditionalPropertyName));"> 157         Boolean conditionTrue = (conditionalPropertyName == null) || ((conditionalPropertyName != null) &amp;ðŸ”µ</abbr>
 158         return conditionTrue &amp;&amp; (!cacheRegions.isEmpty());
 159     }
 160 
 161     // Checks that the passes class name qualifies to be transformed
 162     protected Boolean classQualifies(String className) {
<abbr title=" 163         Boolean classQualifies = classNames.isEmpty() || ((!classNames.isEmpty()) &amp;&amp; classNames.contains(className));"> 163         Boolean classQualifies = classNames.isEmpty() || ((!classNames.isEmpty()) &amp;&amp; classNames.contains(ðŸ”µ</abbr>
 164         return classQualifies;
 165     }
 166 
 167     // Checks is the annotation matches the &quot;annotationClass&quot;
 168     protected Boolean annotationQualifies(ConstPool constantPool, List&lt;?&gt; attributes) {
 169         boolean qualifies = false;
 170         Iterator&lt;?&gt; itr = attributes.iterator();
 171         while (itr.hasNext()) {
 172             Object object = itr.next();
 173             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 174                 AnnotationsAttribute attr = ((AnnotationsAttribute) (object));
 175                 Annotation[] items = attr.getAnnotations();
 176                 for (Annotation annotation : items) {
 177                     String typeName = annotation.getTypeName();
 178                     if (typeName.equals(annotationClass) &amp;&amp; cacheRegionQualifies(annotation)) {
 179                         qualifies = true;
 180                         break;
 181                     }
 182                 }
 183             }
 184         }
 185         return qualifies;
 186     }
 187 
 188     // Checks that the Annotation &quot;region&quot; is in the list of cacheRegions to be removed
 189     protected Boolean cacheRegionQualifies(Annotation annotation) {
 190         MemberValue memberValue = annotation.getMemberValue(&quot;region&quot;);
 191         if (StringMemberValue.class.isAssignableFrom(memberValue.getClass())) {
 192             StringMemberValue smv = ((StringMemberValue) (memberValue));
 193             if (cacheRegions.contains(smv.getValue())) {
 194                 return true;
 195             }
 196         }
 197         return false;
 198     }
 199 
<abbr title=" 200     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been verified)"> 200     // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been veriðŸ”µ</abbr>
 201     protected AnnotationsAttribute stripAnnotation(ConstPool constantPool, List&lt;?&gt; attributes) {
 202         Iterator&lt;?&gt; itr = attributes.iterator();
<abbr title=" 203         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.visibleTag);"> 203         AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttðŸ”µ</abbr>
 204         while (itr.hasNext()) {
 205             Object object = itr.next();
 206             if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 207                 AnnotationsAttribute attr = ((AnnotationsAttribute) (object));
 208                 Annotation[] items = attr.getAnnotations();
 209                 for (Annotation annotation : items) {
 210                     String typeName = annotation.getTypeName();
 211                     if (typeName.equals(annotationClass)) {
 212                         logger.debug(String.format(&quot;Stripping out %s annotation&quot;, annotationClass));
 213                         continue;
 214                     }
 215                     annotationsAttribute.addAnnotation(annotation);
 216                 }
 217                 itr.remove();
 218             }
 219         }
 220         return annotationsAttribute;
 221     }
 222 
 223     protected Boolean isPropertyEnabled(String propertyName) {
 224         Boolean shouldProceed;
 225         try {
 226             String value = beanFactory.resolveEmbeddedValue((&quot;${&quot; + propertyName) + &quot;:false}&quot;);
 227             shouldProceed = Boolean.parseBoolean(value);
 228         } catch (java.lang.Exception e) {
 229             shouldProceed = false;
 230         }
 231         return shouldProceed;
 232     }
 233 
 234     /**
 235      * The list of fully-qualified classes to be impacted by this transformer
 236      *
 237      * @return
 238      */
 239     public List&lt;String&gt; getClassNames() {
 240         return classNames;
 241     }
 242 
 243     public void setClassNames(List&lt;String&gt; classNames) {
 244         this.classNames = classNames;
 245     }
 246 
 247     /**
 248      * The list of cache region names to be removed by this transformer
 249      *
 250      * @return
 251      */
 252     public List&lt;String&gt; getCacheRegions() {
 253         return cacheRegions;
 254     }
 255 
 256     public void setCacheRegions(List&lt;String&gt; cacheRegions) {
 257         this.cacheRegions = cacheRegions;
 258     }
 259 
 260     /**
 261      * The fully-qualified classname of the annotation to remove at the class and field level
 262      *
 263      * @return
 264      */
 265     public String getAnnotationClass() {
 266         return annotationClass;
 267     }
 268 
 269     public void setAnnotationClass(String annotationClass) {
 270         this.annotationClass = annotationClass;
 271     }
 272 
 273     /**
<abbr title=" 274      * Optional property to declare to gate the activity of this instance of the class tranformer. If a property is specified,"> 274      * Optional property to declare to gate the activity of this instance of the class tranformer. If a pðŸ”µ</abbr>
 275      * and it does not exist or is set to &quot;false&quot;, the class transformation will be skipped.
 276      *
 277      * @return
 278      */
 279     public String getConditionalPropertyName() {
 280         return conditionalPropertyName;
 281     }
 282 
 283     public void setConditionalPropertyName(String conditionalPropertyName) {
 284         this.conditionalPropertyName = conditionalPropertyName;
 285     }
 286 }
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * #%L</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * Copyright (C) 2009 - 2020 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * shall apply.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * #L%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
  18  package org.broadleafcommerce.common.extensibility.jpa.cache;
  19  
  20  
  21  import javassist.ClassPool;
  22  import javassist.CtClass;
  23  import javassist.bytecode.AnnotationsAttribute;
  24  import javassist.bytecode.ClassFile;
  25  import javassist.bytecode.ConstPool;
  26  import javassist.bytecode.FieldInfo;
  27  import javassist.bytecode.annotation.Annotation;
  28  import javassist.bytecode.annotation.MemberValue;
  29  import javassist.bytecode.annotation.StringMemberValue;
  30  
  31  import org.apache.commons.logging.Log;
  32  import org.apache.commons.logging.LogFactory;
  33  import org.broadleafcommerce.common.extensibility.context.merge.Merge;
  34  import org.broadleafcommerce.common.extensibility.jpa.convert.BroadleafClassTransformer;
  35  import org.broadleafcommerce.common.extensibility.jpa.copy.AbstractClassTransformer;
  36  import org.springframework.beans.BeansException;
  37  import org.springframework.beans.factory.BeanFactory;
  38  import org.springframework.beans.factory.BeanFactoryAware;
  39  import org.springframework.beans.factory.config.ConfigurableBeanFactory;
  40  
  41  import java.io.ByteArrayInputStream;
  42  import java.lang.instrument.IllegalClassFormatException;
  43  import java.security.ProtectionDomain;
  44  import java.util.ArrayList;
  45  import java.util.Iterator;
  46  import java.util.List;
  47  import java.util.Properties;
  48  
  49  /**
  50   * Strip the cache annotation from classes and the class fields
  51   *
  52   * Example configuration
  53   *
  54   * &lt;pre&gt;
  55   * {@code
  56   * @Merge(&quot;blMergedClassTransformers&quot;)
  57   * public RemoveCacheClassTransformer RemoveProductCache() {
  58   *     RemoveCacheClassTransformer transformer = new RemoveCacheClassTransformer(&quot;Remove Product Cache&quot;);
  59   *     //optional property that can be enabled/disabled as needed
  60   *     transformer.setConditionalPropertyName(&quot;remove.order.customer.entity.l2cache&quot;);
  61   *     List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  62   *     cacheRegions.add(&quot;blCustomerElements&quot;);
  63   *     cacheRegions.add(&quot;blOrderElements&quot;);
  64   *     transformer.setCacheRegions(cacheRegions);
  65   *     return transformer;
  66   * }
  67   * }
  68   * &lt;/pre&gt;
  69   *
  70   * @author Jeff Fischer
  71   * @author Daniel Colgrove
  72   */
<abbr title="  73  public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeanFactoryAware {">  73  public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeðŸ”µ</abbr>
  74  
  75      private static final Log logger = LogFactory.getLog(RemoveCacheClassTransformer.class);
  76  
  77      protected String moduleName;
  78      protected List&lt;String&gt; classNames = new ArrayList&lt;String&gt;();
  79      protected List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  80      protected String annotationClass = &quot;org.hibernate.annotations.Cache&quot;;
  81      protected String conditionalPropertyName;
  82      protected ConfigurableBeanFactory beanFactory;
  83  
  84      public RemoveCacheClassTransformer(String moduleName) {
  85          this.moduleName = moduleName;
  86      }
  87  
  88      @Override
  89      public void compileJPAProperties(Properties props, Object key) throws Exception {
  90          // When simply copying properties over for Java class files, JPA properties do not need modification
  91      }
  92  
  93      @Override
  94      public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
  95          this.beanFactory = (ConfigurableBeanFactory) beanFactory;
  96      }
  97  
  98      @Override
  99      public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
 100              ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
 101  
<abbr title=" 102          // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation should be done"> 102          // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation shoulðŸ”µ</abbr>
 103          if (className == null) {
 104              return null;
 105          }
 106  
<abbr title=" 107          //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCircularityError"> 107          //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCirðŸ”µ</abbr>
 108          //under JRebel. Favor not including outside libraries and unnecessary classes.
 109          CtClass clazz = null;
 110          try {
 111              String convertedClassName = className.replace(&#x27;/&#x27;, &#x27;.&#x27;);
 112  
<abbr title=" 113              // If there is a class list specified, make sure the current class qualifies to have the annotation removed"> 113              // If there is a class list specified, make sure the current class qualifies to have the annotation reðŸ”µ</abbr>
 114              if (conditionalPropertyEnabled() &amp;&amp; classQualifies(convertedClassName)) {
 115                  ClassPool classPool = ClassPool.getDefault();
 116                  clazz = classPool.makeClass(new ByteArrayInputStream(classfileBuffer), false);
 117                  clazz.defrost();
 118                  ClassFile classFile = clazz.getClassFile();
 119                  ConstPool constantPool = classFile.getConstPool();
 120                  List&lt;?&gt; classAttributes = classFile.getAttributes();
 121  
 122                  // Only remove the annotation if it is for one of the specified regions
 123                  if (annotationQualifies(constantPool, classAttributes)) {
<abbr title=" 124                      AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributes);"> 124                      AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributesðŸ”µ</abbr>
 125                      classFile.addAttribute(classAnnotationsAttribute);
 126  
 127                      List&lt;FieldInfo&gt; fieldInfos = classFile.getFields();
 128                      for (FieldInfo myField : fieldInfos) {
 129                          List&lt;?&gt; attributes = myField.getAttributes();
<abbr title=" 130                          AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes);"> 130                          AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes)ðŸ”µ</abbr>
 131                          myField.addAttribute(fieldAnnotationsAttribute);
 132                      }
 133  
 134                      return clazz.toBytecode();
 135  
 136                  }
 137              }
 138          } catch (ClassCircularityError error) {
 139              error.printStackTrace();
 140              throw error;
 141          } catch (Exception e) {
 142              throw new RuntimeException(&quot;Unable to transform class&quot;, e);
 143          } finally {
 144              if (clazz != null) {
 145                  try {
 146                      clazz.detach();
 147                  } catch (Exception e) {
 148                      //do nothing
 149                  }
 150              }
 151          }
 152  
 153          return null;
 154      }
 155  
 156      // If there is a conditional, it should be true.  Also verifies that region names are set, which is required
 157      protected Boolean conditionalPropertyEnabled() {
<abbr title=" 158          Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyEnabled(conditionalPropertyName) );"> 158          Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyðŸ”µ</abbr>
 159          return conditionTrue &amp;&amp; !cacheRegions.isEmpty();
 160      }
 161  
 162      // Checks that the passes class name qualifies to be transformed
 163      protected Boolean classQualifies(String className) {
<abbr title=" 164          Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className) );"> 164          Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className)ðŸ”µ</abbr>
 165          return classQualifies;
 166      }
 167  
 168      // Checks is the annotation matches the &quot;annotationClass&quot;
 169      protected Boolean annotationQualifies(ConstPool constantPool, List&lt;?&gt; attributes) {
 170          boolean qualifies = false;
 171  
 172          Iterator&lt;?&gt; itr = attributes.iterator();
 173          while (itr.hasNext()) {
 174              Object object = itr.next();
 175              if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 176                  AnnotationsAttribute attr = (AnnotationsAttribute) object;
 177                  Annotation[] items = attr.getAnnotations();
 178                  for (Annotation annotation : items) {
 179                      String typeName = annotation.getTypeName();
 180                      if (typeName.equals(annotationClass) &amp;&amp; cacheRegionQualifies(annotation)) {
 181                          qualifies = true;
 182                          break;
 183                      }
 184                  }
 185              }
 186          }
 187          return qualifies;
 188      }
 189  
 190      // Checks that the Annotation &quot;region&quot; is in the list of cacheRegions to be removed
 191      protected Boolean cacheRegionQualifies(Annotation annotation) {
 192          MemberValue memberValue = annotation.getMemberValue(&quot;region&quot;);
 193          if (StringMemberValue.class.isAssignableFrom(memberValue.getClass())) {
 194              StringMemberValue smv = (StringMemberValue) memberValue;
 195              if (cacheRegions.contains(smv.getValue())) {
 196                  return true;
 197              }
 198          }
 199          return false;
 200      }
 201  
 202      // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been verified)
 203      protected AnnotationsAttribute stripAnnotation(ConstPool constantPool, List&lt;?&gt; attributes) {
 204          Iterator&lt;?&gt; itr = attributes.iterator();
<abbr title=" 205          AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.visibleTag);"> 205          AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.viðŸ”µ</abbr>
 206  
 207          while (itr.hasNext()) {
 208              Object object = itr.next();
 209              if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 210                  AnnotationsAttribute attr = (AnnotationsAttribute) object;
 211                  Annotation[] items = attr.getAnnotations();
 212                  for (Annotation annotation : items) {
 213                      String typeName = annotation.getTypeName();
 214                      if (typeName.equals(annotationClass)) {
 215                          logger.debug(String.format(&quot;Stripping out %s annotation&quot;, annotationClass));
 216                          continue;
 217                      }
 218                      annotationsAttribute.addAnnotation(annotation);
 219                  }
 220                  itr.remove();
 221              }
 222          }
 223          return annotationsAttribute;
 224      }
 225  
 226      protected Boolean isPropertyEnabled(String propertyName) {
 227          Boolean shouldProceed;
 228          try {
 229              String value = beanFactory.resolveEmbeddedValue(&quot;${&quot; + propertyName + &quot;:false}&quot;);
 230              shouldProceed = Boolean.parseBoolean(value);
 231          } catch (Exception e) {
 232              shouldProceed = false;
 233          }
 234          return shouldProceed;
 235      }
 236  
 237      /**
 238       * The list of fully-qualified classes to be impacted by this transformer
 239       *
 240       * @return
 241       */
 242      public List&lt;String&gt; getClassNames() {
 243          return classNames;
 244      }
 245  
 246      public void setClassNames(List&lt;String&gt; classNames) {
 247          this.classNames = classNames;
 248      }
 249  
 250      /**
 251       * The list of cache region names to be removed by this transformer
 252       *
 253       * @return
 254       */
 255      public List&lt;String&gt; getCacheRegions() {
 256          return cacheRegions;
 257      }
 258  
 259      public void setCacheRegions(List&lt;String&gt; cacheRegions) {
 260          this.cacheRegions = cacheRegions;
 261      }
 262  
 263      /**
 264       * The fully-qualified classname of the annotation to remove at the class and field level
 265       *
 266       * @return
 267       */
 268      public String getAnnotationClass() {
 269          return annotationClass;
 270      }
 271  
 272      public void setAnnotationClass(String annotationClass) {
 273          this.annotationClass = annotationClass;
 274      }
 275  
 276      /**
<abbr title=" 277       * Optional property to declare to gate the activity of this instance of the class tranformer. If a property is specified,"> 277       * Optional property to declare to gate the activity of this instance of the class tranformer. If a property iðŸ”µ</abbr>
 278       * and it does not exist or is set to &quot;false&quot;, the class transformation will be skipped.
 279       *
 280       * @return
 281       */
 282      public String getConditionalPropertyName() {
 283          return conditionalPropertyName;
 284      }
 285  
 286      public void setConditionalPropertyName(String conditionalPropertyName) {
 287          this.conditionalPropertyName = conditionalPropertyName;
 288      }
 289  }</pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * #%L</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * Copyright (C) 2009 - 2019 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * %%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * shall apply.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 + * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * #L%</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
  18  package org.broadleafcommerce.common.extensibility.jpa.cache;
  19  
  20  
  21  import javassist.ClassPool;
  22  import javassist.CtClass;
  23  import javassist.bytecode.AnnotationsAttribute;
  24  import javassist.bytecode.ClassFile;
  25  import javassist.bytecode.ConstPool;
  26  import javassist.bytecode.FieldInfo;
  27  import javassist.bytecode.annotation.Annotation;
  28  import javassist.bytecode.annotation.MemberValue;
  29  import javassist.bytecode.annotation.StringMemberValue;
  30  
  31  import org.apache.commons.logging.Log;
  32  import org.apache.commons.logging.LogFactory;
  33  import org.broadleafcommerce.common.extensibility.context.merge.Merge;
  34  import org.broadleafcommerce.common.extensibility.jpa.convert.BroadleafClassTransformer;
  35  import org.broadleafcommerce.common.extensibility.jpa.copy.AbstractClassTransformer;
  36  import org.springframework.beans.BeansException;
  37  import org.springframework.beans.factory.BeanFactory;
  38  import org.springframework.beans.factory.BeanFactoryAware;
  39  import org.springframework.beans.factory.config.ConfigurableBeanFactory;
  40  
  41  import java.io.ByteArrayInputStream;
  42  import java.lang.instrument.IllegalClassFormatException;
  43  import java.security.ProtectionDomain;
  44  import java.util.ArrayList;
  45  import java.util.Iterator;
  46  import java.util.List;
  47  import java.util.Properties;
  48  
  49  /**
  50   * Strip the cache annotation from classes and the class fields
  51   *
  52   * Example configuration
  53   *
  54   * &lt;pre&gt;
  55   * {@code
  56   * @Merge(&quot;blMergedClassTransformers&quot;)
  57   * public RemoveCacheClassTransformer RemoveProductCache() {
  58   *     RemoveCacheClassTransformer transformer = new RemoveCacheClassTransformer(&quot;Remove Product Cache&quot;);
  59   *     //optional property that can be enabled/disabled as needed
  60   *     transformer.setConditionalPropertyName(&quot;remove.order.customer.entity.l2cache&quot;);
  61   *     List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  62   *     cacheRegions.add(&quot;blCustomerElements&quot;);
  63   *     cacheRegions.add(&quot;blOrderElements&quot;);
  64   *     transformer.setCacheRegions(cacheRegions);
  65   *     return transformer;
  66   * }
  67   * }
  68   * &lt;/pre&gt;
  69   *
  70   * @author Jeff Fischer
  71   * @author Daniel Colgrove
  72   */
<abbr title="  73  public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeanFactoryAware {">  73  public class RemoveCacheClassTransformer extends AbstractClassTransformer implements BroadleafClassTransformer, BeðŸ”µ</abbr>
  74  
  75      private static final Log logger = LogFactory.getLog(RemoveCacheClassTransformer.class);
  76  
  77      protected String moduleName;
  78      protected List&lt;String&gt; classNames = new ArrayList&lt;String&gt;();
  79      protected List&lt;String&gt; cacheRegions = new ArrayList&lt;String&gt;();
  80      protected String annotationClass = &quot;org.hibernate.annotations.Cache&quot;;
  81      protected String conditionalPropertyName;
  82      protected ConfigurableBeanFactory beanFactory;
  83  
  84      public RemoveCacheClassTransformer(String moduleName) {
  85          this.moduleName = moduleName;
  86      }
  87  
  88      @Override
  89      public void compileJPAProperties(Properties props, Object key) throws Exception {
  90          // When simply copying properties over for Java class files, JPA properties do not need modification
  91      }
  92  
  93      @Override
  94      public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
  95          this.beanFactory = (ConfigurableBeanFactory) beanFactory;
  96      }
  97  
  98      @Override
  99      public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
 100              ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
 101  
<abbr title=" 102          // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation should be done"> 102          // Lambdas and anonymous methods in Java 8 do not have a class name defined and so no transformation shoulðŸ”µ</abbr>
 103          if (className == null) {
 104              return null;
 105          }
 106  
<abbr title=" 107          //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCircularityError"> 107          //Be careful with Apache library usage in this class (e.g. ArrayUtils). Usage will likely cause a ClassCirðŸ”µ</abbr>
 108          //under JRebel. Favor not including outside libraries and unnecessary classes.
 109          CtClass clazz = null;
 110          try {
 111              String convertedClassName = className.replace(&#x27;/&#x27;, &#x27;.&#x27;);
 112  
<abbr title=" 113              // If there is a class list specified, make sure the current class qualifies to have the annotation removed"> 113              // If there is a class list specified, make sure the current class qualifies to have the annotation reðŸ”µ</abbr>
 114              if (conditionalPropertyEnabled() &amp;&amp; classQualifies(convertedClassName)) {
 115                  ClassPool classPool = ClassPool.getDefault();
 116                  clazz = classPool.makeClass(new ByteArrayInputStream(classfileBuffer), false);
 117                  clazz.defrost();
 118                  ClassFile classFile = clazz.getClassFile();
 119                  ConstPool constantPool = classFile.getConstPool();
 120                  List&lt;?&gt; classAttributes = classFile.getAttributes();
 121  
 122                  // Only remove the annotation if it is for one of the specified regions
 123                  if (annotationQualifies(constantPool, classAttributes)) {
<abbr title=" 124                      AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributes);"> 124                      AnnotationsAttribute classAnnotationsAttribute = stripAnnotation(constantPool, classAttributesðŸ”µ</abbr>
 125                      classFile.addAttribute(classAnnotationsAttribute);
 126  
 127                      List&lt;FieldInfo&gt; fieldInfos = classFile.getFields();
 128                      for (FieldInfo myField : fieldInfos) {
 129                          List&lt;?&gt; attributes = myField.getAttributes();
<abbr title=" 130                          AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes);"> 130                          AnnotationsAttribute fieldAnnotationsAttribute = stripAnnotation(constantPool, attributes)ðŸ”µ</abbr>
 131                          myField.addAttribute(fieldAnnotationsAttribute);
 132                      }
 133  
 134                      return clazz.toBytecode();
 135  
 136                  }
 137              }
 138          } catch (ClassCircularityError error) {
 139              error.printStackTrace();
 140              throw error;
 141          } catch (Exception e) {
 142              throw new RuntimeException(&quot;Unable to transform class&quot;, e);
 143          } finally {
 144              if (clazz != null) {
 145                  try {
 146                      clazz.detach();
 147                  } catch (Exception e) {
 148                      //do nothing
 149                  }
 150              }
 151          }
 152  
 153          return null;
 154      }
 155  
 156      // If there is a conditional, it should be true.  Also verifies that region names are set, which is required
 157      protected Boolean conditionalPropertyEnabled() {
<abbr title=" 158          Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyEnabled(conditionalPropertyName) );"> 158          Boolean conditionTrue = conditionalPropertyName == null || ( conditionalPropertyName != null &amp;&amp; isPropertyðŸ”µ</abbr>
 159          return conditionTrue &amp;&amp; !cacheRegions.isEmpty();
 160      }
 161  
 162      // Checks that the passes class name qualifies to be transformed
 163      protected Boolean classQualifies(String className) {
<abbr title=" 164          Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className) );"> 164          Boolean classQualifies = classNames.isEmpty() || ( !classNames.isEmpty() &amp;&amp; classNames.contains(className)ðŸ”µ</abbr>
 165          return classQualifies;
 166      }
 167  
 168      // Checks is the annotation matches the &quot;annotationClass&quot;
 169      protected Boolean annotationQualifies(ConstPool constantPool, List&lt;?&gt; attributes) {
 170          boolean qualifies = false;
 171  
 172          Iterator&lt;?&gt; itr = attributes.iterator();
 173          while (itr.hasNext()) {
 174              Object object = itr.next();
 175              if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 176                  AnnotationsAttribute attr = (AnnotationsAttribute) object;
 177                  Annotation[] items = attr.getAnnotations();
 178                  for (Annotation annotation : items) {
 179                      String typeName = annotation.getTypeName();
 180                      if (typeName.equals(annotationClass) &amp;&amp; cacheRegionQualifies(annotation)) {
 181                          qualifies = true;
 182                          break;
 183                      }
 184                  }
 185              }
 186          }
 187          return qualifies;
 188      }
 189  
 190      // Checks that the Annotation &quot;region&quot; is in the list of cacheRegions to be removed
 191      protected Boolean cacheRegionQualifies(Annotation annotation) {
 192          MemberValue memberValue = annotation.getMemberValue(&quot;region&quot;);
 193          if (StringMemberValue.class.isAssignableFrom(memberValue.getClass())) {
 194              StringMemberValue smv = (StringMemberValue) memberValue;
 195              if (cacheRegions.contains(smv.getValue())) {
 196                  return true;
 197              }
 198          }
 199          return false;
 200      }
 201  
 202      // Assumes the annotation qualifies to be removed (e.g. the annotationQualifies has already been verified)
 203      protected AnnotationsAttribute stripAnnotation(ConstPool constantPool, List&lt;?&gt; attributes) {
 204          Iterator&lt;?&gt; itr = attributes.iterator();
<abbr title=" 205          AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.visibleTag);"> 205          AnnotationsAttribute annotationsAttribute = new AnnotationsAttribute(constantPool, AnnotationsAttribute.viðŸ”µ</abbr>
 206  
 207          while (itr.hasNext()) {
 208              Object object = itr.next();
 209              if (AnnotationsAttribute.class.isAssignableFrom(object.getClass())) {
 210                  AnnotationsAttribute attr = (AnnotationsAttribute) object;
 211                  Annotation[] items = attr.getAnnotations();
 212                  for (Annotation annotation : items) {
 213                      String typeName = annotation.getTypeName();
 214                      if (typeName.equals(annotationClass)) {
 215                          logger.debug(String.format(&quot;Stripping out %s annotation&quot;, annotationClass));
 216                          continue;
 217                      }
 218                      annotationsAttribute.addAnnotation(annotation);
 219                  }
 220                  itr.remove();
 221              }
 222          }
 223          return annotationsAttribute;
 224      }
 225  
 226      protected Boolean isPropertyEnabled(String propertyName) {
 227          Boolean shouldProceed;
 228          try {
 229              String value = beanFactory.resolveEmbeddedValue(&quot;${&quot; + propertyName + &quot;:false}&quot;);
 230              shouldProceed = Boolean.parseBoolean(value);
 231          } catch (Exception e) {
 232              shouldProceed = false;
 233          }
 234          return shouldProceed;
 235      }
 236  
 237      /**
 238       * The list of fully-qualified classes to be impacted by this transformer
 239       *
 240       * @return
 241       */
 242      public List&lt;String&gt; getClassNames() {
 243          return classNames;
 244      }
 245  
 246      public void setClassNames(List&lt;String&gt; classNames) {
 247          this.classNames = classNames;
 248      }
 249  
 250      /**
 251       * The list of cache region names to be removed by this transformer
 252       *
 253       * @return
 254       */
 255      public List&lt;String&gt; getCacheRegions() {
 256          return cacheRegions;
 257      }
 258  
 259      public void setCacheRegions(List&lt;String&gt; cacheRegions) {
 260          this.cacheRegions = cacheRegions;
 261      }
 262  
 263      /**
 264       * The fully-qualified classname of the annotation to remove at the class and field level
 265       *
 266       * @return
 267       */
 268      public String getAnnotationClass() {
 269          return annotationClass;
 270      }
 271  
 272      public void setAnnotationClass(String annotationClass) {
 273          this.annotationClass = annotationClass;
 274      }
 275  
 276      /**
<abbr title=" 277       * Optional property to declare to gate the activity of this instance of the class tranformer. If a property is specified,"> 277       * Optional property to declare to gate the activity of this instance of the class tranformer. If a property iðŸ”µ</abbr>
 278       * and it does not exist or is set to &quot;false&quot;, the class transformation will be skipped.
 279       *
 280       * @return
 281       */
 282      public String getConditionalPropertyName() {
 283          return conditionalPropertyName;
 284      }
 285  
 286      public void setConditionalPropertyName(String conditionalPropertyName) {
 287          this.conditionalPropertyName = conditionalPropertyName;
 288      }
 289  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            