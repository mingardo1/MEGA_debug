<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>415</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    415
                    <a href="414.html">prev</a>
                    <a href="416.html">next</a>
                    <a href="415_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e408d12c730a7397701e361d52cac823c1694111_mongo/mongo-side/mongo-all-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAllReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111:mongo/mongo-side/mongo-all-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAllReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^1:mongo/mongo-side/mongo-all-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAllReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e408d12c730a7397701e361d52cac823c1694111^2:mongo/mongo-side/mongo-all-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAllReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;09a8d23c2b8c9e6955f6f68bed4a2fe16cc7fbd3:mongo/mongo-side/mongo-all-side/src/main/java/com/dtstack/flink/sql/side/mongo/MongoAllReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.mongo;
  20 
  21 import com.dtstack.flink.sql.side.BaseAllReqRow;
  22 import com.dtstack.flink.sql.side.FieldInfo;
  23 import com.dtstack.flink.sql.side.JoinInfo;
  24 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  25 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  26 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  27 import com.dtstack.flink.sql.util.RowDataComplete;
  28 import com.google.common.collect.Lists;
  29 import com.google.common.collect.Maps;
  30 import com.mongodb.BasicDBObject;
  31 import com.mongodb.MongoClient;
  32 import com.mongodb.MongoClientURI;
  33 import com.mongodb.client.FindIterable;
  34 import com.mongodb.client.MongoCollection;
  35 import com.mongodb.client.MongoCursor;
  36 import com.mongodb.client.MongoDatabase;
  37 import org.apache.calcite.sql.JoinType;
  38 import org.apache.commons.collections.CollectionUtils;
  39 import org.apache.commons.lang3.StringUtils;
  40 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  41 import org.apache.flink.table.dataformat.BaseRow;
  42 import org.apache.flink.types.Row;
  43 import org.apache.flink.util.Collector;
  44 import org.bson.Document;
  45 import org.slf4j.Logger;
  46 import org.slf4j.LoggerFactory;
  47 
  48 import java.sql.SQLException;
  49 import java.util.Calendar;
  50 import java.util.List;
  51 import java.util.Map;
  52 import java.util.concurrent.atomic.AtomicReference;
  53 
  54 /**
  55  * Reason:
  56  * Date: 2018/11/6
  57  *
  58  * @author xuqianjin
  59  */
  60 public class MongoAllReqRow extends BaseAllReqRow {
  61 
  62     private static final long serialVersionUID = -675332795591842778L;
  63 
  64     private static final Logger LOG = LoggerFactory.getLogger(MongoAllReqRow.class);
  65 
  66     private static final int CONN_RETRY_NUM = 3;
  67 
  68     private static final int FETCH_SIZE = 1000;
  69 
  70     private MongoClient mongoClient;
  71 
  72     private MongoDatabase db;
  73 
  74     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  75 
<abbr title="  76     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  76     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  77         super(new MongoAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  78     }
  79 
  80     @Override
  81 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92             if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         return row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     @Override</span>
 103 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 110             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 110             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 112             //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long."> 112             //Type information for indicating event or processing time. However, it behaves like a regula🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                 //去除上一层OutputRowtimeProcessFunction 调用时区导致的影响</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 115                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 115                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122             if (cacheInfo == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124             } else {</span>
 125 =======
 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 127     protected void initCache() throws SQLException {
 128         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 129         cacheRef.set(newCache);
 130         loadData(newCache);
 131     }
 132 
 133     @Override
 134     protected void reloadCache() {
 135         //reload cacheRef and replace to old cacheRef
 136         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 137         try {
 138             loadData(newCache);
 139         } catch (SQLException e) {
 140             LOG.error(&quot;&quot;, e);
 141         }
 142 
 143         cacheRef.set(newCache);
 144         LOG.info(&quot;----- Mongo all cacheRef reload end:{}&quot;, Calendar.getInstance());
 145     }
 146 
 147     @Override
 148     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {
 149         List&lt;Object&gt; inputParams = Lists.newArrayList();
 150         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 151             Object equalObj = input.getField(conValIndex);
 152             if (equalObj == null) {
 153                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 154                     Row data = fillData(input, null);
 155                     RowDataComplete.collectRow(out, data);
 156                 }
 157                 return;
 158             }
 159             inputParams.add(equalObj);
 160         }
 161 
 162         String key = buildKey(inputParams);
 163         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 164         if (CollectionUtils.isEmpty(cacheList)) {
 165             if (sideInfo.getJoinType() == JoinType.LEFT) {
 166                 Row row = fillData(input, null);
 167                 RowDataComplete.collectRow(out, row);
 168             } else {
 169                 return;
 170             }
 171 
 172             return;
 173         }
 174 
 175         for (Map&lt;String, Object&gt; one : cacheList) {
 176             Row row = fillData(input, one);
 177             RowDataComplete.collectRow(out, row);
 178         }
 179     }
 180 
 181     private String buildKey(List&lt;Object&gt; equalValList) {
 182         StringBuilder sb = new StringBuilder(&quot;&quot;);
 183         for (Object equalVal : equalValList) {
 184             sb.append(equalVal).append(&quot;_&quot;);
 185         }
 186 
 187         return sb.toString();
 188     }
 189 
 190     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 191         StringBuilder sb = new StringBuilder(&quot;&quot;);
 192         for (String equalField : equalFieldList) {
 193             sb.append(val.get(equalField)).append(&quot;_&quot;);
 194         }
 195 
 196         return sb.toString();
 197     }
 198 
<abbr title=" 199     private MongoCollection getConn(String host, String userName, String password, String database, String tableName) {"> 199     private MongoCollection getConn(String host, String userName, String password, String database, Strin🔵</abbr>
 200 
 201         MongoCollection dbCollection;
 202         mongoClient = new MongoClient(new MongoClientURI(getConnectionUrl(host, userName, password)));
 203         db = mongoClient.getDatabase(database);
 204         dbCollection = db.getCollection(tableName, Document.class);
 205         return dbCollection;
 206 
 207     }
 208 
 209     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 210         MongoSideTableInfo tableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 211         MongoCollection dbCollection = null;
 212 
 213         try {
 214             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 215                 try {
<abbr title=" 216                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(),"> 216                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.get🔵</abbr>
 217                             tableInfo.getDatabase(), tableInfo.getTableName());
 218                     break;
 219                 } catch (Exception e) {
 220                     if (i == CONN_RETRY_NUM - 1) {
 221                         throw new RuntimeException(&quot;&quot;, e);
 222                     }
 223 
 224                     try {
<abbr title=" 225                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 225                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getU🔵</abbr>
 226                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 227                         Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 228                     } catch (InterruptedException e1) {
 229                         LOG.error(&quot;&quot;, e1);
 230                     }
 231                 }
 232             }
 233 
 234             //load data from table
 235             String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
 236             BasicDBObject basicDBObject = new BasicDBObject();
 237             for (String selectField : sideFieldNames) {
 238                 basicDBObject.append(selectField, 1);
 239             }
 240             BasicDBObject filterObject = new BasicDBObject();
 241             try {
 242                 // 填充谓词
 243                 sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 244                     BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 245                     if (null != filterCondition) {
 246                         filterObject.append(info.getFieldName(), filterCondition);
 247                     }
 248                     return info;
 249                 }).count();
 250             } catch (Exception e) {
 251                 LOG.info(&quot;add predicate infoes error &quot;, e);
 252             }
 253 
 254 
<abbr title=" 255             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(FETCH_SIZE);"> 255             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObjec🔵</abbr>
 256             MongoCursor&lt;Document&gt; mongoCursor = findIterable.iterator();
 257             while (mongoCursor.hasNext()) {
 258                 Document doc = mongoCursor.next();
 259                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 260                 for (String fieldName : sideFieldNames) {
 261                     oneRow.put(fieldName.trim(), doc.get(fieldName.trim()));
 262                 }
 263                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
<abbr title=" 264                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 264                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArray🔵</abbr>
 265                 list.add(oneRow);
 266             }
 267         } catch (Exception e) {
 268             LOG.error(&quot;&quot;, e);
 269         } finally {
 270             if (mongoClient != null) {
 271                 mongoClient.close();
 272             }
 273         }
 274     }
 275     private String getConnectionUrl(String address, String userName, String password){
 276         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 277             return  address;
 278         }
 279         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 280             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 281         }
 282         return String.format(&quot;mongodb://%s&quot;, address);
 283     }
 284 
 285 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.mongo;
  20 
  21 import com.dtstack.flink.sql.side.BaseAllReqRow;
  22 import com.dtstack.flink.sql.side.FieldInfo;
  23 import com.dtstack.flink.sql.side.JoinInfo;
  24 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  25 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  26 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  27 import com.dtstack.flink.sql.util.RowDataComplete;
  28 import com.google.common.collect.Lists;
  29 import com.google.common.collect.Maps;
  30 import com.mongodb.BasicDBObject;
  31 import com.mongodb.MongoClient;
  32 import com.mongodb.MongoClientURI;
  33 import com.mongodb.client.FindIterable;
  34 import com.mongodb.client.MongoCollection;
  35 import com.mongodb.client.MongoCursor;
  36 import com.mongodb.client.MongoDatabase;
  37 import org.apache.calcite.sql.JoinType;
  38 import org.apache.commons.collections.CollectionUtils;
  39 import org.apache.commons.lang3.StringUtils;
  40 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  41 import org.apache.flink.table.dataformat.BaseRow;
  42 import org.apache.flink.types.Row;
  43 import org.apache.flink.util.Collector;
  44 import org.bson.Document;
  45 import org.slf4j.Logger;
  46 import org.slf4j.LoggerFactory;
  47 
  48 import java.sql.SQLException;
  49 import java.util.Calendar;
  50 import java.util.List;
  51 import java.util.Map;
  52 import java.util.concurrent.atomic.AtomicReference;
  53 
  54 /**
  55  * Reason:
  56  * Date: 2018/11/6
  57  *
  58  * @author xuqianjin
  59  */
  60 public class MongoAllReqRow extends BaseAllReqRow {
  61 
  62     private static final long serialVersionUID = -675332795591842778L;
  63 
  64     private static final Logger LOG = LoggerFactory.getLogger(MongoAllReqRow.class);
  65 
  66     private static final int CONN_RETRY_NUM = 3;
  67 
  68     private static final int FETCH_SIZE = 1000;
  69 
  70     private MongoClient mongoClient;
  71 
  72     private MongoDatabase db;
  73 
  74     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  75 
<abbr title="  76     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  76     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  77         super(new MongoAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  78     }
  79 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91             if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         return row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99     }</span>
 100 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 107             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 107             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 109             //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long."> 109             //Type information for indicating event or processing time. However, it behaves like a regula🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                 //去除上一层OutputRowtimeProcessFunction 调用时区导致的影响</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 112                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 112                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             if (cacheInfo == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         return row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     }</span>
 128 =======
 129 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 130 
 131 
 132     @Override
 133     protected void initCache() throws SQLException {
 134         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 135         cacheRef.set(newCache);
 136         loadData(newCache);
 137     }
 138 
 139     @Override
 140     protected void reloadCache() {
 141         //reload cacheRef and replace to old cacheRef
 142         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 143         try {
 144             loadData(newCache);
 145         } catch (SQLException e) {
 146             LOG.error(&quot;&quot;, e);
 147         }
 148 
 149         cacheRef.set(newCache);
 150         LOG.info(&quot;----- Mongo all cacheRef reload end:{}&quot;, Calendar.getInstance());
 151     }
 152 
 153     @Override
 154     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {
 155         List&lt;Object&gt; inputParams = Lists.newArrayList();
 156         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 157             Object equalObj = input.getField(conValIndex);
 158             if (equalObj == null) {
 159                 if(sideInfo.getJoinType() == JoinType.LEFT){
 160                     Row data = fillData(input, null);
 161                     RowDataComplete.collectRow(out, data);
 162                 }
 163                 return;
 164             }
 165             inputParams.add(equalObj);
 166         }
 167 
 168         String key = buildKey(inputParams);
 169         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 170         if (CollectionUtils.isEmpty(cacheList)) {
 171             if (sideInfo.getJoinType() == JoinType.LEFT) {
 172                 Row row = fillData(input, null);
 173                 RowDataComplete.collectRow(out, row);
 174             } else {
 175                 return;
 176             }
 177 
 178             return;
 179         }
 180 
 181         for (Map&lt;String, Object&gt; one : cacheList) {
 182             Row row = fillData(input, one);
 183             RowDataComplete.collectRow(out, row);
 184         }
 185     }
 186 
 187     private String buildKey(List&lt;Object&gt; equalValList) {
 188         StringBuilder sb = new StringBuilder(&quot;&quot;);
 189         for (Object equalVal : equalValList) {
 190             sb.append(equalVal).append(&quot;_&quot;);
 191         }
 192 
 193         return sb.toString();
 194     }
 195 
 196     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 197         StringBuilder sb = new StringBuilder(&quot;&quot;);
 198         for (String equalField : equalFieldList) {
 199             sb.append(val.get(equalField)).append(&quot;_&quot;);
 200         }
 201 
 202         return sb.toString();
 203     }
 204 
<abbr title=" 205     private MongoCollection getConn(String host, String userName, String password, String database, String tableName) {"> 205     private MongoCollection getConn(String host, String userName, String password, String database, Strin🔵</abbr>
 206 
 207         MongoCollection dbCollection;
 208         mongoClient = new MongoClient(new MongoClientURI(getConnectionUrl(host, userName, password)));
 209         db = mongoClient.getDatabase(database);
 210         dbCollection = db.getCollection(tableName, Document.class);
 211         return dbCollection;
 212 
 213     }
 214 
 215     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 216         MongoSideTableInfo tableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 217         MongoCollection dbCollection = null;
 218 
 219         try {
 220             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 221                 try {
<abbr title=" 222                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(),"> 222                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.get🔵</abbr>
 223                             tableInfo.getDatabase(), tableInfo.getTableName());
 224                     break;
 225                 } catch (Exception e) {
 226                     if (i == CONN_RETRY_NUM - 1) {
 227                         throw new RuntimeException(&quot;&quot;, e);
 228                     }
 229 
 230                     try {
<abbr title=" 231                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 231                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getU🔵</abbr>
 232                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 233                         Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 234                     } catch (InterruptedException e1) {
 235                         LOG.error(&quot;&quot;, e1);
 236                     }
 237                 }
 238             }
 239 
 240             //load data from table
 241             String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
 242             BasicDBObject basicDBObject = new BasicDBObject();
 243             for (String selectField : sideFieldNames) {
 244                 basicDBObject.append(selectField, 1);
 245             }
 246             BasicDBObject filterObject = new BasicDBObject();
 247             try {
 248                 // 填充谓词
 249                 sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 250                     BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 251                     if (null != filterCondition) {
 252                         filterObject.append(info.getFieldName(), filterCondition);
 253                     }
 254                     return info;
 255                 }).count();
 256             } catch (Exception e) {
 257                 LOG.info(&quot;add predicate infoes error &quot;, e);
 258             }
 259 
 260 
<abbr title=" 261             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(FETCH_SIZE);"> 261             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObjec🔵</abbr>
 262             MongoCursor&lt;Document&gt; mongoCursor = findIterable.iterator();
 263             while (mongoCursor.hasNext()) {
 264                 Document doc = mongoCursor.next();
 265                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 266                 for (String fieldName : sideFieldNames) {
 267                     oneRow.put(fieldName.trim(), doc.get(fieldName.trim()));
 268                 }
 269                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
<abbr title=" 270                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 270                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArray🔵</abbr>
 271                 list.add(oneRow);
 272             }
 273         } catch (Exception e) {
 274             LOG.error(&quot;&quot;, e);
 275         } finally {
 276             if (mongoClient != null) {
 277                 mongoClient.close();
 278             }
 279         }
 280     }
 281     private String getConnectionUrl(String address, String userName, String password){
 282         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 283             return  address;
 284         }
 285         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 286             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 287         }
 288         return String.format(&quot;mongodb://%s&quot;, address);
 289     }
 290 
 291 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.mongo;
  19 
  20 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  21 import com.dtstack.flink.sql.side.BaseAllReqRow;
  22 import com.dtstack.flink.sql.side.FieldInfo;
  23 import com.dtstack.flink.sql.side.JoinInfo;
  24 import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  25 import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
  26 import com.dtstack.flink.sql.util.RowDataComplete;
  27 import com.google.common.collect.Lists;
  28 import com.google.common.collect.Maps;
  29 import com.mongodb.BasicDBObject;
  30 import com.mongodb.MongoClient;
  31 import com.mongodb.MongoClientURI;
  32 import com.mongodb.client.FindIterable;
  33 import com.mongodb.client.MongoCollection;
  34 import com.mongodb.client.MongoCursor;
  35 import com.mongodb.client.MongoDatabase;
  36 import java.sql.SQLException;
  37 import java.util.Calendar;
  38 import java.util.List;
  39 import java.util.Map;
  40 import java.util.concurrent.atomic.AtomicReference;
  41 import org.apache.calcite.sql.JoinType;
  42 import org.apache.commons.collections.CollectionUtils;
  43 import org.apache.commons.lang3.StringUtils;
  44 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  45 import org.apache.flink.table.dataformat.BaseRow;
  46 import org.apache.flink.types.Row;
  47 import org.apache.flink.util.Collector;
  48 import org.bson.Document;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 
  52 
  53 /**
  54  * Reason:
  55  * Date: 2018/11/6
  56  *
  57  * @author xuqianjin
  58  */
  59 public class MongoAllReqRow extends BaseAllReqRow {
  60     private static final long serialVersionUID = -675332795591842778L;
  61 
  62     private static final Logger LOG = LoggerFactory.getLogger(MongoAllReqRow.class);
  63 
  64     private static final int CONN_RETRY_NUM = 3;
  65 
  66     private static final int FETCH_SIZE = 1000;
  67 
  68     private MongoClient mongoClient;
  69 
  70     private MongoDatabase db;
  71 
  72     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  73 
<abbr title="  74     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  74     public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, A🔵</abbr>
  75         super(new MongoAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  76     }
  77 
  78     @Override
  79     protected void initCache() throws SQLException {
  80         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
  81         cacheRef.set(newCache);
  82         loadData(newCache);
  83     }
  84 
  85     @Override
  86     protected void reloadCache() {
  87         //reload cacheRef and replace to old cacheRef
  88         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
  89         try {
  90             loadData(newCache);
  91         } catch (SQLException e) {
  92             LOG.error(&quot;&quot;, e);
  93         }
  94 
  95         cacheRef.set(newCache);
  96         LOG.info(&quot;----- Mongo all cacheRef reload end:{}&quot;, Calendar.getInstance());
  97     }
  98 
  99     @Override
 100     public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {
 101         List&lt;Object&gt; inputParams = Lists.newArrayList();
 102         for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 103             Object equalObj = input.getField(conValIndex);
 104             if (equalObj == null) {
 105                 if (sideInfo.getJoinType() == JoinType.LEFT) {
 106                     Row data = fillData(input, null);
 107                     RowDataComplete.collectRow(out, data);
 108                 }
 109                 return;
 110             }
 111             inputParams.add(equalObj);
 112         }
 113         String key = buildKey(inputParams);
 114         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 115         if (CollectionUtils.isEmpty(cacheList)) {
 116             if (sideInfo.getJoinType() == JoinType.LEFT) {
 117                 Row row = fillData(input, null);
 118                 RowDataComplete.collectRow(out, row);
 119             } else {
 120                 return;
 121             }
 122             return;
 123         }
 124         for (Map&lt;String, Object&gt; one : cacheList) {
 125             Row row = fillData(input, one);
 126             RowDataComplete.collectRow(out, row);
 127         }
 128     }
 129 
 130     private String buildKey(List&lt;Object&gt; equalValList) {
 131         StringBuilder sb = new StringBuilder(&quot;&quot;);
 132         for (Object equalVal : equalValList) {
 133             sb.append(equalVal).append(&quot;_&quot;);
 134         }
 135 
 136         return sb.toString();
 137     }
 138 
 139     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 140         StringBuilder sb = new StringBuilder(&quot;&quot;);
 141         for (String equalField : equalFieldList) {
 142             sb.append(val.get(equalField)).append(&quot;_&quot;);
 143         }
 144 
 145         return sb.toString();
 146     }
 147 
<abbr title=" 148     private MongoCollection getConn(String host, String userName, String password, String database, String tableName) {"> 148     private MongoCollection getConn(String host, String userName, String password, String database, Strin🔵</abbr>
 149 
 150         MongoCollection dbCollection;
 151         mongoClient = new MongoClient(new MongoClientURI(getConnectionUrl(host, userName, password)));
 152         db = mongoClient.getDatabase(database);
 153         dbCollection = db.getCollection(tableName, Document.class);
 154         return dbCollection;
 155 
 156     }
 157 
 158     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 159         MongoSideTableInfo tableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 160         MongoCollection dbCollection = null;
 161 
 162         try {
 163             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 164                 try {
<abbr title=" 165                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(),"> 165                     dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.get🔵</abbr>
 166                             tableInfo.getDatabase(), tableInfo.getTableName());
 167                     break;
 168                 } catch (Exception e) {
 169                     if (i == CONN_RETRY_NUM - 1) {
 170                         throw new RuntimeException(&quot;&quot;, e);
 171                     }
 172 
 173                     try {
<abbr title=" 174                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 174                         String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getU🔵</abbr>
 175                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 176                         Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 177                     } catch (InterruptedException e1) {
 178                         LOG.error(&quot;&quot;, e1);
 179                     }
 180                 }
 181             }
 182 
 183             //load data from table
 184             String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
 185             BasicDBObject basicDBObject = new BasicDBObject();
 186             for (String selectField : sideFieldNames) {
 187                 basicDBObject.append(selectField, 1);
 188             }
 189             BasicDBObject filterObject = new BasicDBObject();
 190             try {
 191                 // 填充谓词
 192                 sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 193                     BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 194                     if (null != filterCondition) {
 195                         filterObject.append(info.getFieldName(), filterCondition);
 196                     }
 197                     return info;
 198                 }).count();
 199             } catch (Exception e) {
 200                 LOG.info(&quot;add predicate infoes error &quot;, e);
 201             }
 202 
 203 
<abbr title=" 204             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(FETCH_SIZE);"> 204             FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObjec🔵</abbr>
 205             MongoCursor&lt;Document&gt; mongoCursor = findIterable.iterator();
 206             while (mongoCursor.hasNext()) {
 207                 Document doc = mongoCursor.next();
 208                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 209                 for (String fieldName : sideFieldNames) {
 210                     oneRow.put(fieldName.trim(), doc.get(fieldName.trim()));
 211                 }
 212                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
<abbr title=" 213                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 213                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArray🔵</abbr>
 214                 list.add(oneRow);
 215             }
 216         } catch (Exception e) {
 217             LOG.error(&quot;&quot;, e);
 218         } finally {
 219             if (mongoClient != null) {
 220                 mongoClient.close();
 221             }
 222         }
 223     }
 224 
 225     private String getConnectionUrl(String address, String userName, String password){
 226         if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 227             return  address;
 228         }
 229         if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 230             return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 231         }
 232         return String.format(&quot;mongodb://%s&quot;, address);
 233     }
 234 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.mongo;
  20  
  21  import com.dtstack.flink.sql.side.BaseAllReqRow;
  22  import com.dtstack.flink.sql.side.FieldInfo;
  23  import com.dtstack.flink.sql.side.JoinInfo;
  24  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  25  import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  26  import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.dtstack.flink.sql.util.RowDataComplete;</span>
  28  import com.google.common.collect.Lists;
  29  import com.google.common.collect.Maps;
  30  import com.mongodb.BasicDBObject;
  31  import com.mongodb.MongoClient;
  32  import com.mongodb.MongoClientURI;
  33  import com.mongodb.client.FindIterable;
  34  import com.mongodb.client.MongoCollection;
  35  import com.mongodb.client.MongoCursor;
  36  import com.mongodb.client.MongoDatabase;
  37  import org.apache.calcite.sql.JoinType;
  38  import org.apache.commons.collections.CollectionUtils;
  39  import org.apache.commons.lang3.StringUtils;
  40  import org.apache.flink.api.java.typeutils.RowTypeInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import org.apache.flink.table.dataformat.BaseRow;</span>
  44  import org.apache.flink.types.Row;
  45  import org.apache.flink.util.Collector;
  46  import org.bson.Document;
  47  import org.slf4j.Logger;
  48  import org.slf4j.LoggerFactory;
  49  
  50  import java.sql.SQLException;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.sql.Timestamp;</span>
  52  import java.util.Calendar;
  53  import java.util.List;
  54  import java.util.Map;
  55  import java.util.concurrent.atomic.AtomicReference;
  56  
  57  /**
  58   * Reason:
  59   * Date: 2018/11/6
  60   *
  61   * @author xuqianjin
  62   */
  63  public class MongoAllReqRow extends BaseAllReqRow {
  64  
  65      private static final long serialVersionUID = -675332795591842778L;
  66  
  67      private static final Logger LOG = LoggerFactory.getLogger(MongoAllReqRow.class);
  68  
  69      private static final int CONN_RETRY_NUM = 3;
  70  
  71      private static final int FETCH_SIZE = 1000;
  72  
  73      private MongoClient mongoClient;
  74  
  75      private MongoDatabase db;
  76  
  77      private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  78  
<abbr title="  79      public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  79      public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  80          super(new MongoAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  81      }
  82  
  83      @Override
  84      public Row fillData(Row input, Object sideInput) {
  85          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;
  86          Row row = new Row(sideInfo.getOutFieldInfoList().size());
  87          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
  88              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  89 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());">  89 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  91 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long.">  91 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL tim🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                //去除上一层OutputRowtimeProcessFunction 调用时区导致的影响</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -                obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
  98              row.setField(entry.getKey(), obj);
  99          }
 100  
 101          for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {
 102              if (cacheInfo == null) {
 103                  row.setField(entry.getKey(), null);
 104              } else {
 105                  row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));
 106              }
 107          }
 108  
 109          return row;
 110      }
 111  
 112      @Override
 113      protected void initCache() throws SQLException {
 114          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 115          cacheRef.set(newCache);
 116          loadData(newCache);
 117      }
 118  
 119      @Override
 120      protected void reloadCache() {
 121          //reload cacheRef and replace to old cacheRef
 122          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 123          try {
 124              loadData(newCache);
 125          } catch (SQLException e) {
 126              LOG.error(&quot;&quot;, e);
 127          }
 128  
 129          cacheRef.set(newCache);
 130          LOG.info(&quot;----- Mongo all cacheRef reload end:{}&quot;, Calendar.getInstance());
 131      }
 132  
 133      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -    public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    public void flatMap(Row input, Collector&lt;BaseRow&gt; out) throws Exception {</span>
 136          List&lt;Object&gt; inputParams = Lists.newArrayList();
 137          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            Object equalObj = input.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +            Object equalObj = input.getField(conValIndex);</span>
 140              if (equalObj == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -                if(sideInfo.getJoinType() == JoinType.LEFT){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                    Row data = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                    out.collect(new CRow(data, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    Row data = fillData(input, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                    RowDataComplete.collectRow(out, data);</span>
 147                  }
 148                  return;
 149              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
 151              inputParams.add(equalObj);
 152          }
 153  
 154          String key = buildKey(inputParams);
 155          List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 156          if (CollectionUtils.isEmpty(cacheList)) {
 157              if (sideInfo.getJoinType() == JoinType.LEFT) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                Row row = fillData(input.row(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                out.collect(new CRow(row, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                Row row = fillData(input, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                RowDataComplete.collectRow(out, row);</span>
 162              } else {
 163                  return;
 164              }
 165  
 166              return;
 167          }
 168  
 169          for (Map&lt;String, Object&gt; one : cacheList) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -            out.collect(new CRow(fillData(input.row(), one), input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +            Row row = fillData(input, one);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +            RowDataComplete.collectRow(out, row);</span>
 173          }
 174      }
 175  
 176      private String buildKey(List&lt;Object&gt; equalValList) {
 177          StringBuilder sb = new StringBuilder(&quot;&quot;);
 178          for (Object equalVal : equalValList) {
 179              sb.append(equalVal).append(&quot;_&quot;);
 180          }
 181  
 182          return sb.toString();
 183      }
 184  
 185      private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 186          StringBuilder sb = new StringBuilder(&quot;&quot;);
 187          for (String equalField : equalFieldList) {
 188              sb.append(val.get(equalField)).append(&quot;_&quot;);
 189          }
 190  
 191          return sb.toString();
 192      }
 193  
<abbr title=" 194      private MongoCollection getConn(String host, String userName, String password, String database, String tableName) {"> 194      private MongoCollection getConn(String host, String userName, String password, String database, String tableNa🔵</abbr>
 195  
 196          MongoCollection dbCollection;
 197          mongoClient = new MongoClient(new MongoClientURI(getConnectionUrl(host, userName, password)));
 198          db = mongoClient.getDatabase(database);
 199          dbCollection = db.getCollection(tableName, Document.class);
 200          return dbCollection;
 201  
 202      }
 203  
 204      private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 205          MongoSideTableInfo tableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 206          MongoCollection dbCollection = null;
 207  
 208          try {
 209              for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 210                  try {
<abbr title=" 211                      dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(),"> 211                      dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(🔵</abbr>
 212                              tableInfo.getDatabase(), tableInfo.getTableName());
 213                      break;
 214                  } catch (Exception e) {
 215                      if (i == CONN_RETRY_NUM - 1) {
 216                          throw new RuntimeException(&quot;&quot;, e);
 217                      }
 218  
 219                      try {
<abbr title=" 220                          String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 220                          String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName()🔵</abbr>
 221                          LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 222                          Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 223                      } catch (InterruptedException e1) {
 224                          LOG.error(&quot;&quot;, e1);
 225                      }
 226                  }
 227              }
 228  
 229              //load data from table
 230              String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
 231              BasicDBObject basicDBObject = new BasicDBObject();
 232              for (String selectField : sideFieldNames) {
 233                  basicDBObject.append(selectField, 1);
 234              }
 235              BasicDBObject filterObject = new BasicDBObject();
 236              try {
 237                  // 填充谓词
 238                  sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 239                      BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 240                      if (null != filterCondition) {
 241                          filterObject.append(info.getFieldName(), filterCondition);
 242                      }
 243                      return info;
 244                  }).count();
 245              } catch (Exception e) {
 246                  LOG.info(&quot;add predicate infoes error &quot;, e);
 247              }
 248  
 249  
<abbr title=" 250              FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(FETCH_SIZE);"> 250              FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(🔵</abbr>
 251              MongoCursor&lt;Document&gt; mongoCursor = findIterable.iterator();
 252              while (mongoCursor.hasNext()) {
 253                  Document doc = mongoCursor.next();
 254                  Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 255                  for (String fieldName : sideFieldNames) {
 256                      oneRow.put(fieldName.trim(), doc.get(fieldName.trim()));
 257                  }
 258                  String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
 259                  List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());
 260                  list.add(oneRow);
 261              }
 262          } catch (Exception e) {
 263              LOG.error(&quot;&quot;, e);
 264          } finally {
 265              if (mongoClient != null) {
 266                  mongoClient.close();
 267              }
 268          }
 269      }
 270      private String getConnectionUrl(String address, String userName, String password){
 271          if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 272              return  address;
 273          }
 274          if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 275              return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 276          }
 277          return String.format(&quot;mongodb://%s&quot;, address);
 278      }
 279  
 280  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.mongo;
  20  
  21  import com.dtstack.flink.sql.side.BaseAllReqRow;
  22  import com.dtstack.flink.sql.side.FieldInfo;
  23  import com.dtstack.flink.sql.side.JoinInfo;
  24  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  25  import com.dtstack.flink.sql.side.mongo.table.MongoSideTableInfo;
  26  import com.dtstack.flink.sql.side.mongo.utils.MongoUtil;

  27  import com.google.common.collect.Lists;
  28  import com.google.common.collect.Maps;
  29  import com.mongodb.BasicDBObject;
  30  import com.mongodb.MongoClient;
  31  import com.mongodb.MongoClientURI;
  32  import com.mongodb.client.FindIterable;
  33  import com.mongodb.client.MongoCollection;
  34  import com.mongodb.client.MongoCursor;
  35  import com.mongodb.client.MongoDatabase;
  36  import org.apache.calcite.sql.JoinType;
  37  import org.apache.commons.collections.CollectionUtils;
  38  import org.apache.commons.lang3.StringUtils;
  39  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  40  import org.apache.flink.table.runtime.types.CRow;
  41  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;

  42  import org.apache.flink.types.Row;
  43  import org.apache.flink.util.Collector;
  44  import org.bson.Document;
  45  import org.slf4j.Logger;
  46  import org.slf4j.LoggerFactory;
  47  
  48  import java.sql.SQLException;
  49  import java.sql.Timestamp;
  50  import java.util.Calendar;
  51  import java.util.List;
  52  import java.util.Map;
  53  import java.util.concurrent.atomic.AtomicReference;
  54  
  55  /**
  56   * Reason:
  57   * Date: 2018/11/6
  58   *
  59   * @author xuqianjin
  60   */
  61  public class MongoAllReqRow extends BaseAllReqRow {
  62  
  63      private static final long serialVersionUID = -675332795591842778L;
  64  
  65      private static final Logger LOG = LoggerFactory.getLogger(MongoAllReqRow.class);
  66  
  67      private static final int CONN_RETRY_NUM = 3;
  68  
  69      private static final int FETCH_SIZE = 1000;
  70  
  71      private MongoClient mongoClient;
  72  
  73      private MongoDatabase db;
  74  
  75      private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  76  
<abbr title="  77      public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  77      public MongoAllReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSi🔵</abbr>
  78          super(new MongoAllSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  79      }
  80  
  81      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -    public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -        Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -        for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -            Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  87 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());">  87 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  89 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long.">  89 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL tim🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -                //去除上一层OutputRowtimeProcessFunction 调用时区导致的影响</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -                obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -            if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -                row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        return row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -    @Override</span>
 110      protected void initCache() throws SQLException {
 111          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 112          cacheRef.set(newCache);
 113          loadData(newCache);
 114      }
 115  
 116      @Override
 117      protected void reloadCache() {
 118          //reload cacheRef and replace to old cacheRef
 119          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 120          try {
 121              loadData(newCache);
 122          } catch (SQLException e) {
 123              LOG.error(&quot;&quot;, e);
 124          }
 125  
 126          cacheRef.set(newCache);
 127          LOG.info(&quot;----- Mongo all cacheRef reload end:{}&quot;, Calendar.getInstance());
 128      }
 129  
 130      @Override
 131      public void flatMap(CRow input, Collector&lt;CRow&gt; out) throws Exception {

 132          List&lt;Object&gt; inputParams = Lists.newArrayList();
 133          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 134              Object equalObj = input.row().getField(conValIndex);

 135              if (equalObj == null) {
 136                  if(sideInfo.getJoinType() == JoinType.LEFT){
 137                      Row data = fillData(input.row(), null);
 138                      out.collect(new CRow(data, input.change()));



 139                  }
 140                  return;
 141              }
 142  
 143              inputParams.add(equalObj);
 144          }
 145  
 146          String key = buildKey(inputParams);
 147          List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 148          if (CollectionUtils.isEmpty(cacheList)) {
 149              if (sideInfo.getJoinType() == JoinType.LEFT) {
 150                  Row row = fillData(input.row(), null);
 151                  out.collect(new CRow(row, input.change()));


 152              } else {
 153                  return;
 154              }
 155  
 156              return;
 157          }
 158  
 159          for (Map&lt;String, Object&gt; one : cacheList) {
 160              out.collect(new CRow(fillData(input.row(), one), input.change()));


 161          }
 162      }
 163  
 164      private String buildKey(List&lt;Object&gt; equalValList) {
 165          StringBuilder sb = new StringBuilder(&quot;&quot;);
 166          for (Object equalVal : equalValList) {
 167              sb.append(equalVal).append(&quot;_&quot;);
 168          }
 169  
 170          return sb.toString();
 171      }
 172  
 173      private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 174          StringBuilder sb = new StringBuilder(&quot;&quot;);
 175          for (String equalField : equalFieldList) {
 176              sb.append(val.get(equalField)).append(&quot;_&quot;);
 177          }
 178  
 179          return sb.toString();
 180      }
 181  
<abbr title=" 182      private MongoCollection getConn(String host, String userName, String password, String database, String tableName) {"> 182      private MongoCollection getConn(String host, String userName, String password, String database, String tableNa🔵</abbr>
 183  
 184          MongoCollection dbCollection;
 185          mongoClient = new MongoClient(new MongoClientURI(getConnectionUrl(host, userName, password)));
 186          db = mongoClient.getDatabase(database);
 187          dbCollection = db.getCollection(tableName, Document.class);
 188          return dbCollection;
 189  
 190      }
 191  
 192      private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 193          MongoSideTableInfo tableInfo = (MongoSideTableInfo) sideInfo.getSideTableInfo();
 194          MongoCollection dbCollection = null;
 195  
 196          try {
 197              for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 198                  try {
<abbr title=" 199                      dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(),"> 199                      dbCollection = getConn(tableInfo.getAddress(), tableInfo.getUserName(), tableInfo.getPassword(🔵</abbr>
 200                              tableInfo.getDatabase(), tableInfo.getTableName());
 201                      break;
 202                  } catch (Exception e) {
 203                      if (i == CONN_RETRY_NUM - 1) {
 204                          throw new RuntimeException(&quot;&quot;, e);
 205                      }
 206  
 207                      try {
<abbr title=" 208                          String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 208                          String connInfo = &quot;url:&quot; + tableInfo.getAddress() + &quot;;userName:&quot; + tableInfo.getUserName()🔵</abbr>
 209                          LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 210                          Thread.sleep(LOAD_DATA_ERROR_SLEEP_TIME);
 211                      } catch (InterruptedException e1) {
 212                          LOG.error(&quot;&quot;, e1);
 213                      }
 214                  }
 215              }
 216  
 217              //load data from table
 218              String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
 219              BasicDBObject basicDBObject = new BasicDBObject();
 220              for (String selectField : sideFieldNames) {
 221                  basicDBObject.append(selectField, 1);
 222              }
 223              BasicDBObject filterObject = new BasicDBObject();
 224              try {
 225                  // 填充谓词
 226                  sideInfo.getSideTableInfo().getPredicateInfoes().stream().map(info -&gt; {
 227                      BasicDBObject filterCondition = MongoUtil.buildFilterObject(info);
 228                      if (null != filterCondition) {
 229                          filterObject.append(info.getFieldName(), filterCondition);
 230                      }
 231                      return info;
 232                  }).count();
 233              } catch (Exception e) {
 234                  LOG.info(&quot;add predicate infoes error &quot;, e);
 235              }
 236  
 237  
<abbr title=" 238              FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(FETCH_SIZE);"> 238              FindIterable&lt;Document&gt; findIterable = dbCollection.find(filterObject).projection(basicDBObject).limit(🔵</abbr>
 239              MongoCursor&lt;Document&gt; mongoCursor = findIterable.iterator();
 240              while (mongoCursor.hasNext()) {
 241                  Document doc = mongoCursor.next();
 242                  Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 243                  for (String fieldName : sideFieldNames) {
 244                      oneRow.put(fieldName.trim(), doc.get(fieldName.trim()));
 245                  }
 246                  String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
 247                  List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());
 248                  list.add(oneRow);
 249              }
 250          } catch (Exception e) {
 251              LOG.error(&quot;&quot;, e);
 252          } finally {
 253              if (mongoClient != null) {
 254                  mongoClient.close();
 255              }
 256          }
 257      }
 258      private String getConnectionUrl(String address, String userName, String password){
 259          if(address.startsWith(&quot;mongodb://&quot;) || address.startsWith(&quot;mongodb+srv://&quot;)){
 260              return  address;
 261          }
 262          if (StringUtils.isNotBlank(userName) &amp;&amp; StringUtils.isNotBlank(password)) {
 263              return String.format(&quot;mongodb://%s:%s@%s&quot;, userName, password, address);
 264          }
 265          return String.format(&quot;mongodb://%s&quot;, address);
 266      }
 267  
 268  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            