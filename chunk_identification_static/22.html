<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>22</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    22
                    <a href="21.html">prev</a>
                    <a href="23.html">next</a>
                    <a href="22_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_1469ca1ceaae9c691eee7790de89a3ee1f571403_Aria/src/main/java/com/arialyy/aria/core/common/RecordHandler.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403:Aria/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^1:Aria/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^2:Aria/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;39a43c836d3309cbbf82de6d51309fe71fc25292:Aria/src/main/java/com/arialyy/aria/core/common/RecordHandler.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import com.arialyy.aria.core.config.Configuration;
  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.arialyy.aria.core.download.m3u8.M3U8FileLoader;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.core.inf.ITaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.HashSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import java.util.Set;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 public class RecordHandler {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55    * 分块文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60   private TaskRecord mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75    * @return 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77   TaskRecord getRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       convertDb();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       if (mRecord == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87           initRecord(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           handleM3U8Record();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93           if (mRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             handleBlockRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95           } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             handleNoSupportBPRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             handleSingleThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103     saveRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104     return mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108    * 处理m3u8记录，</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109    * 1、如果分片文件存在，并且分片文件的记录没有完成，则需要删除该分片文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110    * 2、如果记录显示已完成，但是分片文件不存在，则重新开始该分片</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 3、如果记录显示已完成，并且文件存在，记录当前任务进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   private void handleM3U8Record() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     DTaskWrapper wrapper = (DTaskWrapper) mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     String cacheDir = wrapper.asM3U8().getCacheDir();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     long currentProgress = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117     for (ThreadRecord record : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       File temp = new File(M3U8FileLoader.getTsFilePath(cacheDir, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119       if (!record.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         if (temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121           temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         ALog.d(TAG, String.format(&quot;分片【%s】未完成，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127           record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           record.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           ALog.w(TAG, String.format(&quot;分片【%s】不存在，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131           currentProgress += temp.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     wrapper.getEntity().setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139    * 处理不支持断点的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     if (!file.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158       tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         file.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           tr.startLocation = file.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174           tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void handleBlockRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     // 默认线程分块长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191       if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196         if (!tr.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208             temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213           long realLocation =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216            * 检查记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221             tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237   private void convertDb() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240             getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       for (Object key : keys) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254         String str = String.valueOf(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         set.add(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       int threadNum = set.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       if (threadNum == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267       mRecord.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275           tRecord.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276           continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278         if (record != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286       mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     if (newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     // 处理线程区间记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301     int requestType = mTaskWrapper.getRequestType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305       ThreadRecord tr;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306       tr = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308       tr.threadId = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309       tr.startLocation = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311       if (requestType == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313         tr.threadType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314         tr.m3u8url = ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         tr.threadType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318         if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319           endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321         tr.endLocation = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322         tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329    * 创建任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331    * @param threadNum 线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336     record.filePath = getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338     record.threadNum = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       record.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347     if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       record.taskType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       record.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       record.taskType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359     return record;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363    * 保存任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   private void saveRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367     mRecord.save();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373    * 获取记录类型</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377   private int getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 382     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 383   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 384 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 385   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 386    * 获取任务路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 387    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 388    * @return 任务文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 389    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 390   private String getFilePath() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 391     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 392       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 393     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 394       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 395     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 396   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 398   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 399    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 400    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 401    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 402   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 403     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 404       if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405         return ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406       }</span>
 407 ||||||| GitAnalyzerPlus_base
 408 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 public class RecordHandler {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441    * 分块文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446   private TaskRecord mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461    * @return 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463   TaskRecord getRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466       convertDb();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469       if (mRecord == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473           initRecord(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474         } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475           handleBlockRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476         } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477           handleNoSupportBPRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479           handleSingleThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483     saveRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484     return mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488    * 处理不支持断点的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     if (!file.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507       tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508       tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         file.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522           tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523           tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533   private void handleBlockRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534     // 默认线程分块长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540       if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557             temp.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559             continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562           long realLocation =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565            * 检查记录文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570             tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586   private void convertDb() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602       for (Object key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603         String str = String.valueOf(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605         set.add(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607       int threadNum = set.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608       if (threadNum == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616       mRecord.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624           tRecord.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625           continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627         if (record != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635       mConfigFile.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645     if (newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649     // 处理线程区间记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653       ThreadRecord tr;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654       tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656       tr.threadId = i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657       tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658       //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659       if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660         endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662       tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663       tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669    * 创建任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671    * @param threadNum 线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676     record.filePath = getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678     record.threadNum = threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685       record.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693     return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697    * 保存任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699   private void saveRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701     mRecord.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707    * 获取记录类型</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711   private int getRecordType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720    * 获取任务路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722    * @return 任务文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724   private String getFilePath() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737     if (getRecordType() == TYPE_DOWNLOAD) {</span>
 738 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 739       if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {
 740         return 1;
 741       }
 742       int threadNum = Configuration.getInstance().downloadCfg.getThreadNum();
 743       return mEntity.getFileSize() &lt;= SUB_LEN
 744           || mEntity.isGroupChild()
 745           || threadNum == 1
 746           ? 1
 747           : threadNum;
 748     } else {
 749       return 1;
 750     }
 751   }
 752 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import com.arialyy.aria.core.config.Configuration;
  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.arialyy.aria.core.download.m3u8.M3U8FileLoader;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.core.inf.ITaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.HashSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import java.util.Set;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 public class RecordHandler {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55    * 分块文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60   private TaskRecord mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75    * @return 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77   TaskRecord getRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       convertDb();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       if (mRecord == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87           initRecord(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           handleM3U8Record();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93           if (mRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             handleBlockRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95           } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             handleNoSupportBPRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             handleSingleThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103     saveRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104     return mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108    * 处理m3u8记录，</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109    * 1、如果分片文件存在，并且分片文件的记录没有完成，则需要删除该分片文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110    * 2、如果记录显示已完成，但是分片文件不存在，则重新开始该分片</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 3、如果记录显示已完成，并且文件存在，记录当前任务进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   private void handleM3U8Record() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     DTaskWrapper wrapper = (DTaskWrapper) mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     String cacheDir = wrapper.asM3U8().getCacheDir();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     long currentProgress = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117     for (ThreadRecord record : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       File temp = new File(M3U8FileLoader.getTsFilePath(cacheDir, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119       if (!record.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         if (temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121           temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         ALog.d(TAG, String.format(&quot;分片【%s】未完成，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127           record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           record.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           ALog.w(TAG, String.format(&quot;分片【%s】不存在，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131           currentProgress += temp.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     wrapper.getEntity().setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139    * 处理不支持断点的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     if (!file.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158       tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         file.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           tr.startLocation = file.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174           tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void handleBlockRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     // 默认线程分块长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191       if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196         if (!tr.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208             temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213           long realLocation =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216            * 检查记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221             tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237   private void convertDb() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240             getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       for (Object key : keys) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254         String str = String.valueOf(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         set.add(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       int threadNum = set.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       if (threadNum == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267       mRecord.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275           tRecord.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276           continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278         if (record != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286       mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     if (newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     // 处理线程区间记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301     int requestType = mTaskWrapper.getRequestType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305       ThreadRecord tr;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306       tr = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308       tr.threadId = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309       tr.startLocation = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311       if (requestType == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313         tr.threadType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314         tr.m3u8url = ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         tr.threadType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318         if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319           endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321         tr.endLocation = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322         tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329    * 创建任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331    * @param threadNum 线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336     record.filePath = getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338     record.threadNum = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       record.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347     if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       record.taskType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       record.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       record.taskType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359     return record;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363    * 保存任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   private void saveRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367     mRecord.save();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373    * 获取记录类型</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377   private int getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 382     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 383   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 384 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 385   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 386    * 获取任务路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 387    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 388    * @return 任务文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 389    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 390   private String getFilePath() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 391     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 392       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 393     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 394       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 395     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 396   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 398   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 399    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 400    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 401    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 402   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 403     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 404       if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405         return ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406       }</span>
 407 ||||||| BASE
 408 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 public class RecordHandler {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441    * 分块文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446   private TaskRecord mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461    * @return 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463   TaskRecord getRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466       convertDb();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469       if (mRecord == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473           initRecord(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474         } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475           handleBlockRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476         } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477           handleNoSupportBPRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479           handleSingleThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483     saveRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484     return mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488    * 处理不支持断点的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     if (!file.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507       tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508       tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         file.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522           tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523           tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533   private void handleBlockRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534     // 默认线程分块长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540       if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557             temp.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559             continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562           long realLocation =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565            * 检查记录文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570             tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586   private void convertDb() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602       for (Object key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603         String str = String.valueOf(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605         set.add(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607       int threadNum = set.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608       if (threadNum == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616       mRecord.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624           tRecord.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625           continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627         if (record != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635       mConfigFile.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645     if (newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649     // 处理线程区间记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653       ThreadRecord tr;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654       tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656       tr.threadId = i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657       tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658       //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659       if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660         endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662       tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663       tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669    * 创建任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671    * @param threadNum 线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676     record.filePath = getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678     record.threadNum = threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685       record.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693     return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697    * 保存任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699   private void saveRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701     mRecord.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707    * 获取记录类型</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711   private int getRecordType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720    * 获取任务路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722    * @return 任务文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724   private String getFilePath() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737     if (getRecordType() == TYPE_DOWNLOAD) {</span>
 738 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 739       if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {
 740         return 1;
 741       }
 742       int threadNum = Configuration.getInstance().downloadCfg.getThreadNum();
 743       return mEntity.getFileSize() &lt;= SUB_LEN
 744           || mEntity.isGroupChild()
 745           || threadNum == 1
 746           ? 1
 747           : threadNum;
 748     } else {
 749       return 1;
 750     }
 751   }
 752 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import com.arialyy.aria.core.config.Configuration;
  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.arialyy.aria.core.download.m3u8.M3U8FileLoader;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.core.inf.ITaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.HashSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import java.util.Set;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 public class RecordHandler {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55    * 分块文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60   private TaskRecord mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75    * @return 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77   TaskRecord getRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       convertDb();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       if (mRecord == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87           initRecord(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           handleM3U8Record();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93           if (mRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             handleBlockRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95           } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             handleNoSupportBPRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             handleSingleThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103     saveRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104     return mRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108    * 处理m3u8记录，</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109    * 1、如果分片文件存在，并且分片文件的记录没有完成，则需要删除该分片文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110    * 2、如果记录显示已完成，但是分片文件不存在，则重新开始该分片</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 3、如果记录显示已完成，并且文件存在，记录当前任务进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   private void handleM3U8Record() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     DTaskWrapper wrapper = (DTaskWrapper) mTaskWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     String cacheDir = wrapper.asM3U8().getCacheDir();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     long currentProgress = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117     for (ThreadRecord record : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118       File temp = new File(M3U8FileLoader.getTsFilePath(cacheDir, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119       if (!record.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         if (temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121           temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123         record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         ALog.d(TAG, String.format(&quot;分片【%s】未完成，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127           record.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128           record.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129           ALog.w(TAG, String.format(&quot;分片【%s】不存在，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131           currentProgress += temp.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     wrapper.getEntity().setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139    * 处理不支持断点的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     if (!file.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158       tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         file.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173           tr.startLocation = file.length();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174           tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   private void handleBlockRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185     // 默认线程分块长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191       if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196         if (!tr.isComplete) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208             temp.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213           long realLocation =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215           /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216            * 检查记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217            */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221             tr.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237   private void convertDb() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240             getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       for (Object key : keys) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254         String str = String.valueOf(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         set.add(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       int threadNum = set.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       if (threadNum == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261         initRecord(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262         return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267       mRecord.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275           tRecord.isComplete = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276           continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278         if (record != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286       mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     if (newRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     // 处理线程区间记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301     int requestType = mTaskWrapper.getRequestType();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305       ThreadRecord tr;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306       tr = new ThreadRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308       tr.threadId = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309       tr.startLocation = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310       tr.isComplete = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311       if (requestType == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313         tr.threadType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314         tr.m3u8url = ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         tr.threadType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318         if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319           endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321         tr.endLocation = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322         tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329    * 创建任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331    * @param threadNum 线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336     record.filePath = getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338     record.threadNum = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       record.isBlock = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347     if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       record.taskType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       record.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       record.taskType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359     return record;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363    * 保存任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   private void saveRecord() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367     mRecord.save();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373    * 获取记录类型</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377   private int getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 382     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 383   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 384 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 385   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 386    * 获取任务路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 387    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 388    * @return 任务文件路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 389    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 390   private String getFilePath() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 391     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 392       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 393     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 394       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 395     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 396   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 398   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 399    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 400    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 401    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 402   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 403     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 404       if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405         return ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().size();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406       }</span>
 407 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 408 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 408 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 409 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import java.util.HashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427  * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 public class RecordHandler {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431   public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432   public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433   private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435   private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436   private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438    * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440   private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443    * 分块文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445   public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447   @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448   private TaskRecord mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449   private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450   private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452   RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453     mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454     mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458    * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459    * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460    * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461    * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463    * @return 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465   TaskRecord getRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468       convertDb();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471       if (mRecord == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475           initRecord(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476         } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477           handleBlockRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478         } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479           handleNoSupportBPRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481           handleSingleThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485     saveRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486     return mRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490    * 处理不支持断点的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492   private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497     tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502    * 处理单线程的任务的记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504   private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506     ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507     if (!file.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508       ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509       tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510       tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511       tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512     } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         file.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516         tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523           ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524           tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525           tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533    * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535   private void handleBlockRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     // 默认线程分块长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537     long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541       File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542       if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543         ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546       } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548           ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549               &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550               tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552           long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554            * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556           if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557             ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558                 tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559             temp.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560             tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561             continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564           long realLocation =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565               tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566           /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567            * 检查记录文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568            */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569           if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570             ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571             tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572             tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573           } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574             ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575             tr.startLocation = realLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578           ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582     mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586    * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588   private void convertDb() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589     List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590         DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592     if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593       Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594       if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595         ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600       Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601       // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602       // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603       Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604       for (Object key : keys) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605         String str = String.valueOf(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606         int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607         set.add(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609       int threadNum = set.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610       if (threadNum == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611         ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613         return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615       mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616       mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617       mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618       mRecord.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619       File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620       for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622         tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623         Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624         Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625         if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626           tRecord.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627           continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         if (record != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630           long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631           tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633           tRecord.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635         mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637       mConfigFile.delete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642    * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644    * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646   private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647     if (newRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648       mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650     mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     // 处理线程区间记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652     long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655       ThreadRecord tr;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656       tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657       tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658       tr.threadId = i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659       tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660       //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661       if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662         endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664       tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665       tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666       mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671    * 创建任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673    * @param threadNum 线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675   private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676     TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677     record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678     record.filePath = getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679     record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680     record.threadNum = threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681     // 处理分块和动态文件参数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682     if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683       record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684       // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685       record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687       record.isBlock = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689     record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690     if (record.isGroupRecord) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691       if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695     return record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699    * 保存任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701   private void saveRecord() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702     mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703     mRecord.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704     DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705     ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709    * 获取记录类型</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711    * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713   private int getRecordType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715       return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717       return TYPE_UPLOAD;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722    * 获取任务路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724    * @return 任务文件路径</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726   private String getFilePath() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727     if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728       return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730       return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735    * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736    * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738   private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739     if (getRecordType() == TYPE_DOWNLOAD) {</span>
 740 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 741       if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {
 742         return 1;
 743       }
 744       int threadNum = Configuration.getInstance().downloadCfg.getThreadNum();
 745       return mEntity.getFileSize() &lt;= SUB_LEN
 746           || mEntity.isGroupChild()
 747           || threadNum == 1
 748           ? 1
 749           : threadNum;
 750     } else {
 751       return 1;
 752     }
 753   }
 754 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +package com.arialyy.aria.core.common;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import com.arialyy.aria.core.config.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import com.arialyy.aria.core.download.DTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.arialyy.aria.core.download.m3u8.M3U8FileLoader;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.arialyy.aria.core.inf.ITaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import java.util.HashSet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 + * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +public class RecordHandler {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +  private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +  public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +  public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +  private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +  private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +   * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +  private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +   * 分块文件路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +  public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +  @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +  private TaskRecord mRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +  private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +  private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +  RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +    mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +    mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +   * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +   * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +   * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +   * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +   * @return 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +  TaskRecord getRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +    if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +      convertDb();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +      mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +      if (mRecord == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +        if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +          initRecord(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +        if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +          handleM3U8Record();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +          if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +            handleBlockRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +          } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +            handleNoSupportBPRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +          } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            handleSingleThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +    saveRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    return mRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +   * 处理m3u8记录，</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +   * 1、如果分片文件存在，并且分片文件的记录没有完成，则需要删除该分片文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +   * 2、如果记录显示已完成，但是分片文件不存在，则重新开始该分片</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +   * 3、如果记录显示已完成，并且文件存在，记录当前任务进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +  private void handleM3U8Record() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    DTaskWrapper wrapper = (DTaskWrapper) mTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    String cacheDir = wrapper.asM3U8().getCacheDir();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    long currentProgress = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    for (ThreadRecord record : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +      File temp = new File(M3U8FileLoader.getTsFilePath(cacheDir, record.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +      if (!record.isComplete) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        if (temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +          temp.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        record.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        ALog.d(TAG, String.format(&quot;分片【%s】未完成，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +          record.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +          record.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +          ALog.w(TAG, String.format(&quot;分片【%s】不存在，将重新下载该分片&quot;, record.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +          currentProgress += temp.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    wrapper.getEntity().setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +   * 处理不支持断点的记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +  private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +    ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +    tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +    tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +    tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +   * 处理单线程的任务的记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +  private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +    ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    if (!file.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +      ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +      tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +      tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +      tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +    } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +      if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        file.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +        tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +        tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +      } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +        tr.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +        if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +          ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +          tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +          tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +   * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +  private void handleBlockRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    // 默认线程分块长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +    long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +      long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +      File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +      if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +        ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +        tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +        tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +        if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +          ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +              &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +              tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +          long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +          /*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +           * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +           */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +          if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +            ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +                tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +            temp.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +            tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +            continue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +          long realLocation =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +              tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +          /*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +           * 检查记录文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +           */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +          if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +            ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +            tr.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +          } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +            tr.startLocation = realLocation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +          ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +   * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +  private void convertDb() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +    List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +            getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +    if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +      Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +      if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +        return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +      Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +      // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +      // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +      Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +      for (Object key : keys) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        String str = String.valueOf(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +        int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +        set.add(i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +      int threadNum = set.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +      if (threadNum == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +        return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +      mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +      mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +      mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +      mRecord.isBlock = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +      File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +      for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +        ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +        if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +          tRecord.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +          continue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        if (record != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +          long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +          tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +          tRecord.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +      mConfigFile.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +   * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +   * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +  private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +    if (newRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +      mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +    mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +    // 处理线程区间记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +    int requestType = mTaskWrapper.getRequestType();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +    long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +    for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +      long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +      ThreadRecord tr;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +      tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +      tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +      tr.threadId = i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +      tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +      tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +      if (requestType == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +        tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        tr.threadType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +        tr.m3u8url = ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().get(i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +        tr.threadType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +          endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +        tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +      mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +   * 创建任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +   * @param threadNum 线程总数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +  private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +    TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +    record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +    record.filePath = getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +    record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +    record.threadNum = threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +    // 处理分块和动态文件参数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +    if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +      record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +      // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +      record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +      record.isBlock = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +    if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +      record.taskType = TaskRecord.TYPE_M3U8;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +      record.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +      record.taskType = TaskRecord.TYPE_HTTP_FTP;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +    record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +    if (record.isGroupRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +      if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +    return record;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +   * 保存任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +  private void saveRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +    mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +    mRecord.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +    DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +    ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +   * 获取记录类型</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +   * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +  private int getRecordType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +    if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +      return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +      return TYPE_UPLOAD;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +   * 获取任务路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +   * @return 任务文件路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +  private String getFilePath() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +    if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +      return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +      return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +   * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +   * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +  private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +    if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +      if (mTaskWrapper.getRequestType() == ITaskWrapper.M3U8_FILE) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        return ((DTaskWrapper) mTaskWrapper).asM3U8().getUrls().size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +      if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +        return 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +      int threadNum = Configuration.getInstance().downloadCfg.getThreadNum();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +      return mEntity.getFileSize() &lt;= SUB_LEN</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +          || mEntity.isGroupChild()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +          || threadNum == 1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +          ? 1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +          : threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +      return 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +}</span></pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +package com.arialyy.aria.core.common;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import com.arialyy.aria.core.config.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import com.arialyy.aria.core.inf.AbsNormalEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.arialyy.aria.core.inf.AbsTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.orm.DbEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.arialyy.aria.util.DbDataHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import java.util.HashSet;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import java.util.Set;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 + * 处理任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +public class RecordHandler {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +  public static final int TYPE_DOWNLOAD = 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +  public static final int TYPE_UPLOAD = 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +  private final String TAG = &quot;RecordHandler&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +  private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +  private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +   * 小于1m的文件不启用多线程</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +  private static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +   * 分块文件路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +  public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +  @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +  private TaskRecord mRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +  private AbsTaskWrapper mTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +  private AbsNormalEntity mEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +  RecordHandler(AbsTaskWrapper wrapper) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    mTaskWrapper = wrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    mEntity = (AbsNormalEntity) mTaskWrapper.getEntity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +   * 获取任务记录，如果任务记录存在，检查任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +   * 检查记录 对于分块任务： 子分块不存在或被删除，子线程将重新下载</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +   * 对于普通任务： 预下载文件不存在，则任务任务呗删除</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +   * 如果任务记录不存在或线程记录不存在，初始化记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +   * @return 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +  TaskRecord getRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +    mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +      convertDb();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +      mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +      if (mRecord == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +        if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +          initRecord(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +          handleBlockRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        } else if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +          handleNoSupportBPRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +          handleSingleThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +    saveRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    return mRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +   * 处理不支持断点的记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +  private void handleNoSupportBPRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +    tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +    tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    tr.blockLen = tr.endLocation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +   * 处理单线程的任务的记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +  private void handleSingleThreadRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    if (!file.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +      ALog.w(TAG, String.format(&quot;文件【%s】不存在，任务将重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +      tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +      tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +      tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    } else if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +      if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        ALog.i(TAG, String.format(&quot;文件【%s】错误，任务重新开始&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        file.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +      } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        tr.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +          ALog.i(TAG, String.format(&quot;修正【%s】的进度记录为：%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +          tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +          tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +   * 处理分块任务的记录，分块文件（blockFileLen）长度必须需要小于等于线程区间（threadRectLen）的长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +  private void handleBlockRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +    // 默认线程分块长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +      long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +      File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +      if (!temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        ALog.i(TAG, String.format(&quot;分块文件【%s】不存在，该分块将重新开始&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        tr.isComplete = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        tr.startLocation = tr.threadId * normalRectLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +      } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +          ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +              &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +              tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +          long blockFileLen = temp.length(); // 磁盘中的分块文件长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +          /*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +           * 检查磁盘中的分块文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +           */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +          if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +            ALog.i(TAG, String.format(&quot;分块【%s】错误，分块长度【%s】 &gt; 线程区间长度【%s】，将重新开始该分块&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +            temp.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +            continue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +          long realLocation =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +              tr.threadId * normalRectLen + blockFileLen; //正常情况下，该线程的startLocation的位置</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +          /*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +           * 检查记录文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +           */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +          if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +            ALog.i(TAG, String.format(&quot;分块【%s】已完成，更新记录&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +            tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +            tr.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +          } else if (tr.startLocation != realLocation) { // 处理记录小于分块文件长度的情况</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +            ALog.i(TAG, String.format(&quot;修正分块【%s】的进度记录为：%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +            tr.startLocation = realLocation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +          ALog.i(TAG, String.format(&quot;分块【%s】已完成&quot;, temp.getPath()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +   * convertDb 是兼容性代码 从3.4.1开始，线程配置信息将存储在数据库中。 将配置文件的内容复制到数据库中，并将配置文件删除</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +  private void convertDb() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +    List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +        DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +            getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +    if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +      Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +      if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        ALog.d(TAG, &quot;老版本的线程记录为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +      Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +      // 老版本记录是5s存一次，但是5s中内，如果线程执行完成，record记录是没有的，只有state记录...</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +      // 第一步应该是record 和 state去重取正确的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +      Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +      for (Object key : keys) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        String str = String.valueOf(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +        int i = Integer.parseInt(str.substring(str.length() - 1));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        set.add(i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +      int threadNum = set.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +      if (threadNum == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +        ALog.d(TAG, &quot;线程数为空，任务为新任务&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        initRecord(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +        return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +      mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +      mRecord = createTaskRecord(threadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +      mRecord.isOpenDynamicFile = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +      mRecord.isBlock = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +      File tempFile = new File(getFilePath());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +      for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        Object state = pro.getProperty(tempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        Object record = pro.getProperty(tempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +          tRecord.isComplete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +          continue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +        if (record != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +          long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +          tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +          tRecord.startLocation = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +      mConfigFile.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +   * 初始化任务记录，分配线程区间</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +   * @param newRecord {@code true} 需要创建新{@link TaskRecord}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +  private void initRecord(boolean newRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +    if (newRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +      mRecord = createTaskRecord(getNewTaskThreadNum());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +    mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +    // 处理线程区间记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +    long blockSize = mEntity.getFileSize() / mRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +    for (int i = 0; i &lt; mRecord.threadNum; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +      long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +      ThreadRecord tr;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +      tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +      tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +      tr.threadId = i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +      tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +      //最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +      if (i == (mRecord.threadNum - 1)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        endL = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +      tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +      tr.blockLen = CommonUtil.getBlockLen(mEntity.getFileSize(), i, mRecord.threadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +      mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +   * 创建任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +   * @param threadNum 线程总数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +  private TaskRecord createTaskRecord(int threadNum) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +    TaskRecord record = new TaskRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +    record.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    record.filePath = getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +    record.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +    record.threadNum = threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +    // 处理分块和动态文件参数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +    if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +      record.isBlock = threadNum &gt; 1 &amp;&amp; Configuration.getInstance().downloadCfg.isUseBlock();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +      // 线程数为1，或者使用了分块，则认为是使用动态长度文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +      record.isOpenDynamicFile = threadNum == 1 || record.isBlock;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +      record.isBlock = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +    record.isGroupRecord = mEntity.isGroupChild();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +    if (record.isGroupRecord) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +      if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +        record.dGroupHash = ((DownloadEntity) mEntity).getGroupHash();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +    return record;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +   * 保存任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +  private void saveRecord() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +    mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +    mRecord.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +    DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +    ALog.d(TAG, String.format(&quot;保存记录，线程记录数：%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +   * 获取记录类型</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +   * @return {@link #TYPE_DOWNLOAD}、{@link #TYPE_UPLOAD}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +  private int getRecordType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +    if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +      return TYPE_DOWNLOAD;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +      return TYPE_UPLOAD;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +   * 获取任务路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +   * @return 任务文件路径</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +  private String getFilePath() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +    if (mEntity instanceof DownloadEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +      return ((DownloadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +      return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +   * 小于1m的文件或是任务组的子任务、线程数强制为1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +   * 不支持断点或chunked模式的线程数都为，线程数强制为1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +  private int getNewTaskThreadNum() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +    if (getRecordType() == TYPE_DOWNLOAD) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +      if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        return 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +      int threadNum = Configuration.getInstance().downloadCfg.getThreadNum();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +      return mEntity.getFileSize() &lt;= SUB_LEN</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +          || mEntity.isGroupChild()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +          || threadNum == 1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +          ? 1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +          : threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +      return 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            