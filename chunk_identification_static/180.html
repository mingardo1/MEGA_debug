<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>180</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    180
                    <a href="179.html">prev</a>
                    <a href="181.html">next</a>
                    <a href="180_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_310203c9852593bd4f07481ea4d693d3096b6994_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;310203c9852593bd4f07481ea4d693d3096b6994^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c2b9b7cebcb68adf6459f3932383315f3716ab81:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [b], [b], [b], [b], [s]], subset: [[bs]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  30 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33 import org.broadleafcommerce.common.service.GenericEntityService;
  34 import org.broadleafcommerce.common.util.BLCArrayUtils;
  35 import org.broadleafcommerce.common.util.BLCMessageUtils;
  36 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37 import org.broadleafcommerce.common.web.JsonResponse;
  38 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43 import org.broadleafcommerce.openadmin.dto.ClassTree;
  44 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46 import org.broadleafcommerce.openadmin.dto.Entity;
  47 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50 import org.broadleafcommerce.openadmin.dto.Property;
  51 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  65 import org.broadleafcommerce.openadmin.web.dao.MultipleCatalogExtensionManager;
  66 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  67 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  68 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  69 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  70 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  71 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  72 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  73 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  74 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  75 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  76 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  77 import org.springframework.stereotype.Controller;
  78 import org.springframework.ui.Model;
  79 import org.springframework.util.MultiValueMap;
  80 import org.springframework.validation.BindingResult;
  81 import org.springframework.web.bind.WebDataBinder;
  82 import org.springframework.web.bind.annotation.InitBinder;
  83 import org.springframework.web.bind.annotation.ModelAttribute;
  84 import org.springframework.web.bind.annotation.PathVariable;
  85 import org.springframework.web.bind.annotation.RequestMapping;
  86 import org.springframework.web.bind.annotation.RequestMethod;
  87 import org.springframework.web.bind.annotation.RequestParam;
  88 import org.springframework.web.bind.annotation.ResponseBody;
  89 import org.springframework.web.servlet.DispatcherServlet;
  90 import org.springframework.web.servlet.FlashMap;
  91 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  92 import org.springframework.web.util.UrlPathHelper;
  93 
  94 import com.fasterxml.jackson.databind.ObjectMapper;
  95 
  96 import java.io.Serializable;
  97 import java.io.UnsupportedEncodingException;
  98 import java.net.URLDecoder;
  99 import java.util.ArrayList;
 100 import java.util.Arrays;
 101 import java.util.HashMap;
 102 import java.util.List;
 103 import java.util.Map;
 104 import java.util.Map.Entry;
 105 import java.util.Set;
 106 import java.util.stream.Stream;
 107 
 108 import javax.annotation.Resource;
 109 import javax.servlet.http.HttpServletRequest;
 110 import javax.servlet.http.HttpServletResponse;
 111 
 112 /**
 113 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114  * The default implementation of the {@link AdminAbstractController}. This delegates every call to </span>
 115 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116  * @author Jeff Fischer</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117  */</span>
 118 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119  * The default implementation of the {@link AdminAbstractController}. This delegates every call to</span>
 120 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 121  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 122  * admin for every entity that is not explicitly customized by its own controller.
 123  *
 124  * @author Andre Azzolini (apazzolini)
 125  * @author Jeff Fischer
 126  */
 127 @Controller(&quot;blAdminBasicEntityController&quot;)
 128 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 129 public class AdminBasicEntityController extends AdminAbstractController {
 130 
 131     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 132 
 133     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 134     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 135     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 136     protected static final String CURRENT_FOLDER_ID = &quot;currentFolderId&quot;;
 137 
 138     @Resource(name=&quot;blSandBoxHelper&quot;)
 139     protected SandBoxHelper sandBoxHelper;
 140 
 141     @Resource(name = &quot;blAdminUserDao&quot;)
 142     protected AdminUserDao adminUserDao;
 143 
 144     @Resource(name=&quot;blDynamicEntityDao&quot;)
 145     protected DynamicEntityDao dynamicEntityDao;
 146 
 147     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 148     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 149 
 150     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 151     protected RowLevelSecurityService rowLevelSecurityService;
 152     
 153     @Resource(name = &quot;blEntityDuplicator&quot;)
 154     protected EntityDuplicator duplicator;
 155     
 156     @Resource(name = &quot;blGenericEntityService&quot;)
 157     protected GenericEntityService genericEntityService;
 158 
 159     @Resource(name = &quot;blMultipleCatalogExtensionManager&quot;)
 160     protected MultipleCatalogExtensionManager multipleCatalogExtensionManager;
 161 
 162     @Resource(name = &quot;blEntityDuplicator&quot;)
 163     protected EntityDuplicator duplicator;
 164 
 165     @Resource(name = &quot;blGenericEntityService&quot;)
 166     protected GenericEntityService genericEntityService;
 167 
 168     // ******************************************
 169     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 170     // ******************************************
 171 
 172     /**
<abbr title=" 173      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 173      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 174      * criteria.
 175      *
 176      * @param request
 177      * @param response
 178      * @param model
 179      * @param pathVars
 180      * @param requestParams a Map of property name -&gt; list critiera values
 181      * @return the return view path
 182      * @throws Exception
 183      */
 184     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 185     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 186             @PathVariable Map&lt;String, String&gt; pathVars,
 187             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 188         String sectionKey = getSectionKey(pathVars);
 189         String sectionClassName = getClassNameForSection(sectionKey);
 190         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 191         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 191         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 192         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 193         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 194 
 195         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 196         listGrid.setSelectType(ListGrid.SelectType.NONE);
 197 
 198         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 199         if (CollectionUtils.isNotEmpty(headerFields)) {
 200             Field firstField = headerFields.iterator().next();
 201             if (requestParams.containsKey(firstField.getName())) {
 202                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 203             }
 204         }
 205 
 206         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 207 
 208         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 209         model.addAttribute(&quot;listGrid&quot;, listGrid);
 210 
 211         return DEFAULT_CONTAINER_VIEW;
 212     }
 213 
<abbr title=" 214     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 214     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 215             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 216         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 217         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 218         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 219         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 220 
 221         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 222         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 223             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 224         }
 225 
 226         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 227         String requestUri = request.getRequestURI();
 228         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 229             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 229             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 230         }
 231 
 232         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 233         model.addAttribute(&quot;currentUri&quot;, requestUri);
 234         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 235         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 236         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 237         model.addAttribute(&quot;mainActions&quot;, mainActions);
 238         setModelAttributes(model, sectionKey);
 239         setTypedEntityModelAttributes(request, model);
 240     }
 241 
 242     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 243     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 244              HttpServletResponse response, Model model,
 245              @PathVariable Map&lt;String, String&gt; pathVars,
 246              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 247         String sectionKey = getSectionKey(pathVars);
 248         String sectionClassName = getClassNameForSection(sectionKey);
 249         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 250         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 250         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 251                 .withCustomCriteria(getCustomCriteria(requestParams));
 252 
 253         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 254 
 255         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 256         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 257 
 258         return formService.constructSelectizeOptionMap(drs, cmd);
 259     }
 260 
 261     /**
 262      * Obtains the requested criteria parameter
 263      *
 264      * @param requestParams
 265      * @return
 266      */
 267     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 268         if (requestParams == null || requestParams.isEmpty()) {
 269             return null;
 270         }
 271 
 272         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 273         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 274         return new String[] {response};
 275     }
 276 
 277     /**
<abbr title=" 278      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 278      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 279      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 280      *
 281      * @param sectionClassName
 282      * @param cmd
 283      * @param mainActions
 284      */
<abbr title=" 285     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 285     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 286         if (isAddActionAllowed(sectionClassName, cmd)) {
 287             mainActions.add(DefaultMainActions.ADD);
 288         }
 289     }
 290 
 291     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 292         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 293         try {
 294             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 295         } catch (ServiceException e) {
 296             if (e instanceof SecurityServiceException) {
 297                 return false;
 298             }
 299         }
 300 
 301         final boolean canAdd = rowLevelSecurityService
 302                 .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);
 303         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 304     }
 305 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306     </span>
 307 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         if (canCreate) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 310             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 310             canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313         return canCreate;</span>
 314 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
 316 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 317     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 318         //check if all the metadata is read only
 319         for (Property property : cmd.getProperties()) {
 320             if (property.getMetadata() instanceof BasicFieldMetadata) {
 321                 if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 322                         !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 323                     return true;
 324                 }
 325             }
 326         }
 327 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328         </span>
 329 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 330      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 330      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331      * they can then perform operations on sub collections.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335      * @param model</span>
 336 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 </span>
 338 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 339         return false;
 340     }
 341 
 342     /**
<abbr title=" 343      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 343      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 344      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 344      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 345      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 345      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 346      * they can then perform operations on sub collections.
 347      *
 348      * @param request
 349      * @param response
 350      * @param model
 351      * @param pathVars
 352      * @param entityType
 353      * @return the return view path
 354      * @throws Exception
 355      */
 356     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 357     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 357     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 358             @PathVariable  Map&lt;String, String&gt; pathVars,
 359             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 360         String sectionKey = getSectionKey(pathVars);
 361         String sectionClassName = getClassNameForSection(sectionKey);
 362         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 363         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 363         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 364         ppr.setAddOperationInspect(true);
 365         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 366 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367         </span>
 368 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
 375 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376 </span>
 377 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 378         entityType = determineEntityType(entityType, cmd);
 379 
 380         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 381 
<abbr title=" 382         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 382         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 383         // is set to the type we&#x27;re going to be creating.
 384         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 385         entityForm.setEntityType(entityType);
 386 
<abbr title=" 387         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 387         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 388         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 388         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 389         // fields that are not applicable for this given entity type.
 390         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 391 
 392         modifyAddEntityForm(entityForm, pathVars);
 393 
 394         model.addAttribute(&quot;entityForm&quot;, entityForm);
 395         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 396 
 397         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 398         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 399         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 400         setModelAttributes(model, sectionKey);
 401         return MODAL_CONTAINER_VIEW;
 402     }
 403 
 404 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 405     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 406     // types for this entity.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 407     protected String determineEntityType(String entityType, final ClassMetadata cmd) </span>
 408 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 412      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 412      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416      * @param model</span>
 417 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419     // types for this entity.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420     protected String determineEntityType(String entityType, final ClassMetadata cmd)</span>
 421 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 422             throws UnsupportedEncodingException {
 423         if (StringUtils.isBlank(entityType)) {
 424             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 425                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 426             } else {
 427                 entityType = getDefaultEntityType();
 428             }
 429         } else {
 430             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 431         }
 432         return entityType;
 433     }
 434 
 435     /**
<abbr title=" 436      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 436      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 437      *
 438      * @param request
 439      * @param response
 440      * @param model
 441      * @param pathVars
 442      * @param entityForm
 443      * @param result
 444      * @return the return view path
 445      * @throws Exception
 446      */
 447     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 448     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 449             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 450             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 450             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 451         String sectionKey = getSectionKey(pathVars);
 452         String sectionClassName = getClassNameForSection(sectionKey);
 453         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 454         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 454         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 455 
 456         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 457         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 457         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 458         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 459         entityFormValidator.validate(entityForm, entity, result);
 460 
 461         if (result.hasErrors()) {
 462             entityForm.clearFieldsMap();
 463             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 464 
 465             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 466 
 467             modifyAddEntityForm(entityForm, pathVars);
 468 
 469             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 470             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 471             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 472             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 473             setModelAttributes(model, sectionKey);
 474             return MODAL_CONTAINER_VIEW;
 475         }
 476 
 477         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 478         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 478         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 479     }
 480 
 481     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
 482     public String duplicateEntity(final HttpServletRequest request,
 483 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 484             final HttpServletResponse response, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 485             final Model model,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 486             @PathVariable final Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 487             @PathVariable(value = &quot;id&quot;) final String id,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 488             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 489             final BindingResult result) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 490         final String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 491         final String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 492         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 493         final long identifier = Long.parseLong(id);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 494         </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 495         if (duplicator.validate(entityClass, identifier)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 496             final Object duplicate;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 497             </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 498             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 499                 duplicate = duplicator.copy(entityClass, identifier);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 500             } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 501                 LOG.error(&quot;Could not duplicate entity&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 502                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 503             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 504 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 505             final Serializable dupId = genericEntityService.getIdentifier(duplicate);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 506             </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 507             // Note that AJAX Redirects need the context path prepended to them</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 508             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 509         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 510             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 511         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 512     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 513 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 514     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 515         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 516         String message;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 517         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 518         if (context != null &amp;&amp; context.getMessageSource() != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 519             message = context.getMessageSource()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 520                     .getMessage(code, null, code, context.getJavaLocale());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 521         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 522             LOG.warn(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 523                     &quot;Could not find the MessageSource on the current request, &quot; </span>
 524 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 527         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 527         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 532         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 532         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536         if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537             modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539             modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542         if (request.getParameter(&quot;headerFlash&quot;) != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546         // Set the sectionKey again incase this is a typed entity</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547         entityForm.setSectionKey(sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549         // Build the current url in the cast that this is a typed entity</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551         int startIndex = request.getContextPath().length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553         // Remove the context path from servlet path</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554         String currentUrl = originatingUri.substring(startIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556         model.addAttribute(&quot;entity&quot;, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557         model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558         model.addAttribute(&quot;currentUrl&quot;, currentUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560         setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562         // We want to replace author ids with their names</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563         addAuditableDisplayFields(entityForm);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565         if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566             entityForm.setReadOnly();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569             return &quot;modules/modalContainer&quot;;</span>
 570 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571             final HttpServletResponse response,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572             final Model model,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573             @PathVariable final Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574             @PathVariable(value = &quot;id&quot;) final String id,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576             final BindingResult result) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577         final String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         final String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580         final long identifier = Long.parseLong(id);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         if (duplicator.validate(entityClass, identifier)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583             final Object duplicate;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586                 duplicate = duplicator.copy(entityClass, identifier);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587             } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588                 LOG.error(&quot;Could not duplicate entity&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592             final Serializable dupId = genericEntityService.getIdentifier(duplicate);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594             // Note that AJAX Redirects need the context path prepended to them</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603         String message;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605         if (context != null &amp;&amp; context.getMessageSource() != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606             message = context.getMessageSource()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607                     .getMessage(code, null, code, context.getJavaLocale());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609             LOG.warn(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610                     &quot;Could not find the MessageSource on the current request, &quot;</span>
 611 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 612                             + &quot;not translating the message key&quot;);
 613             message = &quot;Duplication_Failure&quot;;
 614         }
 615 
 616         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 617         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 618         errorMap.put(&quot;code&quot;, code);
 619         errorMap.put(&quot;message&quot;, message);
 620         errors.add(errorMap);
 621         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 622     }
 623 
 624     /**
 625      * Renders the main entity form for the specified entity
 626      *
 627      * @param request
 628      * @param response
 629      * @param model
 630      * @param pathVars
 631      * @param id
 632      * @return the return view path
 633      * @throws Exception
 634      */
 635     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 636     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 637             @PathVariable  Map&lt;String, String&gt; pathVars,
 638             @PathVariable(&quot;id&quot;) String id) throws Exception {
 639         String sectionKey = getSectionKey(pathVars);
 640         String sectionClassName = getClassNameForSection(sectionKey);
 641         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 642         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 642         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 643 
 644         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 645         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 646 
 647         multipleCatalogExtensionManager.getProxy().setCurrentCatalog(entity, model);
 648 
<abbr title=" 649         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 649         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 650 
 651         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 652 
 653         modifyEntityForm(entity, entityForm, pathVars);
 654 
 655         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 656             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 657         }
 658 
 659         // Set the sectionKey again incase this is a typed entity
 660         entityForm.setSectionKey(sectionKey);
 661 
 662         // Build the current url in the cast that this is a typed entity
 663         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 664         int startIndex = request.getContextPath().length();
 665 
 666         // Remove the context path from servlet path
 667         String currentUrl = originatingUri.substring(startIndex);
 668 
 669         model.addAttribute(&quot;entity&quot;, entity);
 670         model.addAttribute(&quot;entityForm&quot;, entityForm);
 671         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 672         model.addAttribute(CURRENT_FOLDER_ID, getCurrentFolderId(request));
 673 
 674         setModelAttributes(model, sectionKey);
 675 
 676         // We want to replace author ids with their names
 677         addAuditableDisplayFields(entityForm);
 678 
 679         return resolveAppropriateEntityView(request, model, entityForm);
 680     }
 681 
<abbr title=" 682     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 682     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 683                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 684                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 684                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 685         String tabName = pathVars.get(&quot;tabName&quot;);
 686         if (StringUtils.isEmpty(tabName)) {
 687             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 688         }
 689         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 690     }
 691 
 692     private boolean isAddRequest(Entity entity) {
 693         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 694         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 694         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 695         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 696             return false;
 697         }
 698 
 699         return resultHolder.getResult();
 700     }
 701 
 702     /**
 703      * Attempts to get the List Grid for the selected tab.
 704      *
 705      * @param request
 706      * @param response
 707      * @param model
 708      * @param pathVars
 709      * @param id
 710      * @param tabName
 711      * @param entityForm
 712      * @param entity
 713      * @return the return view path
 714      * @throws Exception
 715      */
 716     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 717     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 718             @PathVariable Map&lt;String, String&gt; pathVars,
 719             @PathVariable(value = &quot;id&quot;) String id,
 720             @PathVariable(value = &quot;tabName&quot;) String tabName,
 721             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 722             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 723         String sectionKey = getSectionKey(pathVars);
 724         String sectionClassName = getClassNameForSection(sectionKey);
 725         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 726         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 726         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 727         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 728         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 729         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 729         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 730         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 731 
 732         modifyEntityForm(entity, entityForm, pathVars);
 733 
 734         model.addAttribute(&quot;entity&quot;, entity);
 735         model.addAttribute(&quot;entityForm&quot;, entityForm);
 736         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 737 
 738         setModelAttributes(model, sectionKey);
 739 
 740         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 741         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 742 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 743         </span>
 744 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745         String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746         String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 748         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 748         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749         ClassMetadata cmd = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750         Entity entity = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753 </span>
 754 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755 </span>
 756 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 757         return DEFAULT_CONTAINER_VIEW;
 758     }
 759 
 760     /**
 761      * Builds JSON that looks like this:
 762      *
 763      * {&quot;errors&quot;:
 764      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 765      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 766      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 767      *        &quot;errorType&quot;, &quot;field&quot;,
 768      *        &quot;tab&quot;: &quot;General&quot;
 769      *        },
 770      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 771      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 772      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 773      *        &quot;errorType&quot;, &quot;field&quot;,
 774      *        &quot;tab&quot;: &quot;General&quot;
 775      *        }]
 776      * }
 777      *
 778      */
 779     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 780     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 781             @PathVariable Map&lt;String, String&gt; pathVars,
 782             @PathVariable(value = &quot;id&quot;) String id,
 783             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 784             RedirectAttributes ra) throws Exception {
 785 
 786         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 787 
 788         JsonResponse json = new JsonResponse(response);
 789         if (result.hasErrors()) {
 790             populateJsonValidationErrors(entityForm, result, json);
 791         }
 792         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 793         if (CollectionUtils.isNotEmpty(dirtyList)) {
 794             json.with(&quot;dirty&quot;, dirtyList);
 795         }
 796 
 797         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 798         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 798         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 799         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 800             return resultHolder.getResult();
 801         }
 802 
 803         return json.done();
 804     }
 805 
<abbr title=" 806     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 806     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 807         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 808         String sectionKey = getSectionKey(pathVars);
 809         String sectionClassName = getClassNameForSection(sectionKey);
 810         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 811         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 811         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 812         ClassMetadata cmd = null;
 813         Entity entity = null;
 814         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 815         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 816 
 817         for (Property p: entity.getProperties()) {
 818             if (p.getIsDirty()) {
 819                 dirtyList.add(p.getName());
 820             }
 821         }
 822         return dirtyList;
 823     }
 824 
 825     /**
<abbr title=" 826      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 826      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 827      * error fields highlighted. On a successful save, it will refresh the entity page.
 828      *
 829      * @param request
 830      * @param response
 831      * @param model
 832      * @param pathVars
 833      * @param id
 834      * @param entityForm
 835      * @param result
 836      * @return the return view path
 837      * @throws Exception
 838      */
 839     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 840     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 841             @PathVariable  Map&lt;String, String&gt; pathVars,
 842             @PathVariable(value=&quot;id&quot;) String id,
 843             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 844             RedirectAttributes ra) throws Exception {
 845         String sectionKey = getSectionKey(pathVars);
 846         String sectionClassName = getClassNameForSection(sectionKey);
 847         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 848         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 848         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 849         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 850 
 851         extractDynamicFormFields(cmd, entityForm);
 852 
<abbr title=" 853         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 853         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 854         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 855 
 856         entityFormValidator.validate(entityForm, entity, result);
 857 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 858         </span>
 859 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 860             RedirectAttributes ra) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 861         String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 862         String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 863         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 864 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 865         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 865         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 866         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 867         // Removal does not normally return an Entity unless there is some validation error</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 868         if (entity != null) {</span>
 869 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 870 </span>
 871 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 872         if (result.hasErrors()) {
 873             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 874             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 875 
<abbr title=" 876             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 876             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 877             entityForm.clearFieldsMap();
 878             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 879 
 880             modifyEntityForm(entity, entityForm, pathVars);
 881 
 882             model.addAttribute(&quot;entity&quot;, entity);
 883             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 884 
 885             setModelAttributes(model, sectionKey);
 886 
 887             return resolveAppropriateEntityView(request, model, entityForm);
 888         }
 889 
 890         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 891 
 892         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 893     }
 894     
 895     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm, 
 896             final Map&lt;String, String&gt; pathVars) throws Exception {
 897         if (isAddRequest(entity)) {
 898             modifyAddEntityForm(entityForm, pathVars);
 899         } else {
 900             modifyEntityForm(entityForm, pathVars);
 901         }
 902     }
 903 
 904     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 905             final Model model,
 906             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 907         if (isAjaxRequest(request)) {
 908             entityForm.setReadOnly();
 909             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 910             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 911             return MODAL_CONTAINER_VIEW;
 912         } else {
 913             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 914             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 915             return DEFAULT_CONTAINER_VIEW;
 916         }
 917     }
 918 
 919     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,
 920             final Map&lt;String, String&gt; pathVars) throws Exception {
 921         if (isAddRequest(entity)) {
 922             modifyAddEntityForm(entityForm, pathVars);
 923         } else {
 924             modifyEntityForm(entityForm, pathVars);
 925         }
 926     }
 927 
 928     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 929             final Model model,
 930             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 931         if (isAjaxRequest(request)) {
 932             entityForm.setReadOnly();
 933             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 934             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 935             return MODAL_CONTAINER_VIEW;
 936         } else {
 937             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 938             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 939             return DEFAULT_CONTAINER_VIEW;
 940         }
 941     }
 942 
 943     /**
 944      * Attempts to remove the given entity.
 945      *
 946      * @param request
 947      * @param response
 948      * @param model
 949      * @param pathVars
 950      * @param id
 951      * @return the return view path
 952      * @throws Exception
 953      */
 954     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 955     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 956             @PathVariable  Map&lt;String, String&gt; pathVars,
 957             @PathVariable(value=&quot;id&quot;) String id,
 958             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 959             RedirectAttributes ra) throws Exception {
 960         String sectionKey = getSectionKey(pathVars);
 961         String sectionClassName = getClassNameForSection(sectionKey);
 962         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 963 
<abbr title=" 964         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 964         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 965         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 966         // Removal does not normally return an Entity unless there is some validation error
 967         if (entity != null) {
 968             entityFormValidator.validate(entityForm, entity, result);
 969             if (result.hasErrors()) {
 970                 // Create a flash attribute for the unsuccessful delete
 971                 FlashMap fm = new FlashMap();
 972                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 973                 fm.put(&quot;headerFlashAlert&quot;, true);
 974                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 975 
 976                 // Re-look back up the entity so that we can return something populated
<abbr title=" 977                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 977                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 978                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 978                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 979                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 980                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 980                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 981                 entityForm.clearFieldsMap();
 982                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 983                 modifyEntityForm(entityForm, pathVars);
 984 
 985                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 986                         .done();
 987             }
 988         }
 989 
 990         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 991         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 992 
 993         if (isAjaxRequest(request)) {
 994             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 995             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 995             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 996         } else {
 997             return &quot;redirect:/&quot; + sectionKey;
 998         }
 999     }
1000 
1001     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title="1002     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,">1002     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
1003             @PathVariable  Map&lt;String, String&gt; pathVars,
1004             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1005             @RequestParam String ids,
1006             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1007         String sectionKey = getSectionKey(pathVars);
1008         String sectionClassName = getClassNameForSection(sectionKey);
1009         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title="1010         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);">1010         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title="1011         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1011         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
1012         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1013         FieldMetadata md = collectionProperty.getMetadata();
1014 
1015         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1016         ppr.setStartIndex(getStartIndex(requestParams));
1017         ppr.setMaxIndex(getMaxIndex(requestParams));
1018 
1019         if (md instanceof BasicFieldMetadata) {
1020             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
1021             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
1022 
1023             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
1024             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
1025 
1026             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1027             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
1028 
1029             for (Entity e : drs.getRecords()) {
1030                 String id = e.getPMap().get(idProp).getValue();
1031                 String disp = e.getPMap().get(displayProp).getDisplayValue();
1032 
1033                 if (StringUtils.isBlank(disp)) {
1034                     disp = e.getPMap().get(displayProp).getValue();
1035                 }
1036 
1037                 returnMap.put(id,  disp);
1038             }
1039 
1040             return returnMap;
1041         }
1042 
1043         return null;
1044     }
1045 
1046     /**
<abbr title="1047      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products">1047      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
1048      * then this method is invoked when a user clicks on the name of the default category field.
1049      *
1050      * @param request
1051      * @param response
1052      * @param model
1053      * @param pathVars
1054      * @param collectionField
1055      * @param id
1056      * @return
1057      * @throws Exception
1058      */
1059     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title="1060     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,">1060     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
1061             @PathVariable  Map&lt;String, String&gt; pathVars,
1062             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1063             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
1064         String sectionKey = getSectionKey(pathVars);
1065         String mainClassName = getClassNameForSection(sectionKey);
1066         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1067         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1067         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1068         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1069         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
1070 
<abbr title="1071         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);">1071         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title="1072         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();">1072         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
1073         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
1074         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
1075         return viewEntityForm(request, response, model, varsForField, id);
1076     }
1077 
1078     @RequestMapping(
1079             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
1080             method = RequestMethod.POST
1081     )
<abbr title="1082     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,">1082     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
1083                                         @PathVariable  Map&lt;String, String&gt; pathVars,
1084                                         @PathVariable(value=&quot;id&quot;) String id,
1085                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1086                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1087                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title="1088                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {">1088                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
1089 
<abbr title="1090         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);">1090         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1091     }
1092 
1093 
1094     @RequestMapping(
1095             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
1096             method = RequestMethod.POST
1097     )
<abbr title="1098     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,">1098     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
1099                                         @PathVariable  Map&lt;String, String&gt; pathVars,
1100                                         @PathVariable(value=&quot;id&quot;) String id,
1101                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1102                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1103                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title="1104                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {">1104                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
1105 
<abbr title="1106         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);">1106         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1107     }
1108 
1109 
1110     /**
1111      * Returns the records for a given collectionField filtered by a particular criteria
1112      *
1113      * @param request
1114      * @param response
1115      * @param model
1116      * @param pathVars
1117      * @param collectionField
1118      * @param requestParams
1119      * @return the return view path
1120      * @throws Exception
1121      */
1122     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title="1123     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,">1123     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
1124             @PathVariable  Map&lt;String, String&gt; pathVars,
1125             @PathVariable(value=&quot;id&quot;) String id,
1126             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1127             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1128         String sectionKey = getSectionKey(pathVars);
1129         String mainClassName = getClassNameForSection(sectionKey);
1130         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1131         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);">1131         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title="1132         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1132         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
1133         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1134 
1135         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title="1136         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1136         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1137 
1138         // Next, we must get the new list grid that represents this collection
<abbr title="1139         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);">1139         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
1140         model.addAttribute(&quot;listGrid&quot;, listGrid);
1141 
1142         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1143 
1144         // We return the new list grid so that it can replace the currently visible one
1145         setModelAttributes(model, sectionKey);
1146         return &quot;views/standaloneListGrid&quot;;
1147     }
1148 
1149     /**
<abbr title="1150      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes">1150      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
1151      * of this call depending on the type of the specified collection field.
1152      *
1153      * &lt;ul&gt;
1154      *  &lt;li&gt;
<abbr title="1155      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may">1155      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title="1156      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute.">1156      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
1157      *  &lt;/li&gt;
1158      *  &lt;li&gt;
<abbr title="1159      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it.">1159      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
1160      *    Used by fields such as &quot;allParentCategories&quot;.
1161      *  &lt;/li&gt;
1162      *  &lt;li&gt;
<abbr title="1163      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1163      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title="1164      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation">1164      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title="1165      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order.">1165      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
1166      *  &lt;/li&gt;
1167      *  &lt;li&gt;
<abbr title="1168      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1168      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title="1169      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified">1169      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title="1170      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition">1170      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
1171      *    to linking an entity, provide extra fields, such as a promotional message.
1172      *  &lt;/li&gt;
1173      *  &lt;li&gt;
<abbr title="1174      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is">1174      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title="1175      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another">1175      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
1176      *    entity. Used by fields such as the mediaMap on a Sku.
1177      *  &lt;/li&gt;
1178      *
1179      * @param request
1180      * @param response
1181      * @param model
1182      * @param pathVars
1183      * @param id
1184      * @param collectionField
1185      * @param requestParams
1186      * @return the return view path
1187      * @throws Exception
1188      */
1189     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title="1190     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1190     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
1191             @PathVariable Map&lt;String, String&gt; pathVars,
1192             @PathVariable(value = &quot;id&quot;) String id,
1193             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1194             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1195         String sectionKey = getSectionKey(pathVars);
1196         String mainClassName = getClassNameForSection(sectionKey);
1197         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1198         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1198         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1199                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1200         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1201         FieldMetadata md = collectionProperty.getMetadata();
1202 
1203         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1204                 .withFilterAndSortCriteria(getCriteria(requestParams))
1205                 .withStartIndex(getStartIndex(requestParams))
1206                 .withMaxIndex(getMaxIndex(requestParams))
1207                 .withLastId(getLastId(requestParams))
1208                 .withFirstId(getFirstId(requestParams))
1209                 .withUpperCount(getUpperCount(requestParams))
1210                 .withLowerCount(getLowerCount(requestParams))
1211                 .withPageSize(getPageSize(requestParams))
1212                 .withPresentationFetch(true);
1213 
1214         if (md instanceof BasicCollectionMetadata) {
1215             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1216             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1217                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1217                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title="1218                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types">1218                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
1219                 // for this entity.
1220                 String entityType = null;
1221 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1222                 </span>
1223 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1224         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1225         return responseMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1226     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1228     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1229      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1230      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1231      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1232      * @param model</span>
1233 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1234 </span>
1235 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1236                 if (requestParams.containsKey(&quot;entityType&quot;)) {
1237                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
1238                 }
1239 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1240                 </span>
1241 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1242     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1243      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1244      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1245      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1246      * @param model</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1247      * @param pathVars</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1248      * @param id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1249      * @param collectionField</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1250      * @param requestParams</span>
1251 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1252 </span>
1253 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1254                 entityType = determineEntityType(entityType, cmd);
1255 
1256                 if (StringUtils.isBlank(entityType)) {
1257                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
1258 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1259                 } </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1260                 </span>
1261 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1262      * @param pathVars</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1263      * @param id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1264      * @param collectionField</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1265      * @param requestParams</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1266      * @return Json collection data</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1267      * @throws Exception</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1268      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1269     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1270     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1270     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1271             @PathVariable Map&lt;String, String&gt; pathVars,</span>
1272 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1273                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1274 </span>
1275 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1276                 ppr = ppr.withCeilingEntityClassname(entityType);
1277             }
1278         } else if (md instanceof MapMetadata) {
<abbr title="1279             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1279             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
1280             if (result.equals(ExtensionResultStatusType.HANDLED)) {
1281                 model.addAttribute(&quot;entityId&quot;, id);
1282                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1283                 model.addAttribute(&quot;collectionField&quot;, collectionField);
1284                 return MODAL_CONTAINER_VIEW;
1285             }
1286         }
1287 
1288         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1289 
<abbr title="1290         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1290         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
1291     }
1292     
1293     protected String getModalForBlankEntityType(final HttpServletRequest request, 
1294             final Model model, final String sectionKey, final ClassMetadata cmd) {
1295         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1296         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1297         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1298         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1299         
1300         String requestUri = request.getRequestURI();
1301         final String contextPath = request.getContextPath();
1302         
1303         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1304             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1305         }
1306 
1307         model.addAttribute(&quot;currentUri&quot;, requestUri);
1308         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1309         setModelAttributes(model, sectionKey);
1310         
1311         return MODAL_CONTAINER_VIEW;
1312     }
1313 
<abbr title="1314     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1314     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title="1315     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1315     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1316             @PathVariable Map&lt;String, String&gt; pathVars,
1317             @PathVariable(value=&quot;id&quot;) String id,
1318             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1319             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1320         String sectionKey = getSectionKey(pathVars);
1321         String mainClassName = getClassNameForSection(sectionKey);
1322         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1323         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1323         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1324         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1325         FieldMetadata md = collectionProperty.getMetadata();
1326         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1327         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1328             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1328             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1329                     collectionField,
1330                     collectionItemId, responseMap);
1331         }
1332         return responseMap;
1333     }
1334 
1335     protected String getModalForBlankEntityType(final HttpServletRequest request,
<abbr title="1336                                                 final Model model, final String sectionKey, final ClassMetadata cmd) {">1336                                                 final Model model, final String sectionKey, final ClassMeðŸ”µ</abbr>
1337         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1338         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1339         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1340         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1341 
1342         String requestUri = request.getRequestURI();
1343         final String contextPath = request.getContextPath();
1344 
1345         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1346             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1347         }
1348 
1349         model.addAttribute(&quot;currentUri&quot;, requestUri);
1350         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1351         setModelAttributes(model, sectionKey);
1352 
1353         return MODAL_CONTAINER_VIEW;
1354     }
1355 
1356     /**
1357      *
1358      * @param request
1359      * @param response
1360      * @param model
1361      * @param pathVars
1362      * @param id
1363      * @param collectionField
1364      * @param requestParams
1365      * @return Json collection data
1366      * @throws Exception
1367      */
1368     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1369     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1369     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1370             @PathVariable Map&lt;String, String&gt; pathVars,
1371             @PathVariable(value = &quot;id&quot;) String id,
1372             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1373             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1374         String sectionKey = getSectionKey(pathVars);
1375         String mainClassName = getClassNameForSection(sectionKey);
1376         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1377         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1377         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1378                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1379         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1380         FieldMetadata md = collectionProperty.getMetadata();
1381 
1382         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1383                 .withFilterAndSortCriteria(getCriteria(requestParams))
1384                 .withStartIndex(getStartIndex(requestParams))
1385                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1386         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1386         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1387                 .toArray(String[]::new);
1388         ppr = ppr.withCustomCriteria( both);
1389 
1390         if (md instanceof AdornedTargetCollectionMetadata) {
1391             ppr.setOperationTypesOverride(null);
1392             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1393             ppr.setSectionEntityField(collectionField);
1394         }
1395 
1396         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1397 
<abbr title="1398         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1398         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1399     }
1400 
1401     protected String[] buildSelectizeCustomCriteria() {
1402         return new String[]{ IS_SELECTIZE_REQUEST };
1403     }
1404 
1405     /**
1406      * Adds the requested collection item via Selectize
1407      *
1408      * @param request
1409      * @param response
1410      * @param model
1411      * @param pathVars
1412      * @param id
1413      * @param collectionField
1414      * @param entityForm
1415      * @return the return view path
1416      * @throws Exception
1417      */
1418     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1419     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1419     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1420             @PathVariable Map&lt;String, String&gt; pathVars,
1421             @PathVariable(value=&quot;id&quot;) String id,
1422             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1423             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1423             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1424         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1425         String sectionKey = getSectionKey(pathVars);
1426         String mainClassName = getClassNameForSection(sectionKey);
1427         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1428         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1428         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1429         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1430 
1431         if (StringUtils.isBlank(entityForm.getEntityType())) {
1432             FieldMetadata fmd = collectionProperty.getMetadata();
1433             if (fmd instanceof BasicCollectionMetadata) {
1434                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1435             }
1436         }
1437 
<abbr title="1438         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1438         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1439         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1440         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1441         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1441         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1442 
1443         // First, we must save the collection entity
<abbr title="1444         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1444         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1445         Entity savedEntity = persistenceResponse.getEntity();
1446         entityFormValidator.validate(entityForm, savedEntity, result);
1447 
1448         if (result.hasErrors()) {
1449             returnVal.put(&quot;error&quot;, result.getFieldError());
1450             return returnVal;
1451         }
1452 
1453         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1454             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1455         }
1456         return returnVal;
1457     }
1458 
1459     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1460         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1460         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1461         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1462     }
1463 
1464     /**
1465      * Adds the requested collection item
1466      *
1467      * @param request
1468      * @param response
1469      * @param model
1470      * @param pathVars
1471      * @param id
1472      * @param collectionField
1473      * @param entityForm
1474      * @return the return view path
1475      * @throws Exception
1476      */
1477     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1478     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1478     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1479             @PathVariable Map&lt;String, String&gt; pathVars,
1480             @PathVariable(value=&quot;id&quot;) String id,
1481             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1482             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1482             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1483         String sectionKey = getSectionKey(pathVars);
1484         String mainClassName = getClassNameForSection(sectionKey);
1485         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1486         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1486         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1487         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1488 
1489         if (StringUtils.isBlank(entityForm.getEntityType())) {
1490             FieldMetadata fmd = collectionProperty.getMetadata();
1491             if (fmd instanceof BasicCollectionMetadata) {
1492                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1493             }
1494         }
1495 
<abbr title="1496         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1496         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1497         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1498         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1498         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1499         service.clearEntityManager();
1500 
1501         // First, we must save the collection entity
<abbr title="1502         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1502         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1503         Entity savedEntity = persistenceResponse.getEntity();
1504         entityFormValidator.validate(entityForm, savedEntity, result);
1505 
1506         if (result.hasErrors()) {
1507             FieldMetadata md = collectionProperty.getMetadata();
1508             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1509             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1509             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1510                     md, ppr, entityForm, savedEntity);
1511         }
1512 
1513         // Next, we must get the new list grid that represents this collection
<abbr title="1514         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1514         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1515         model.addAttribute(&quot;listGrid&quot;, listGrid);
1516 
1517         // We return the new list grid so that it can replace the currently visible one
1518         model.addAttribute(&quot;actualEntityId&quot;, id);
1519         setModelAttributes(model, sectionKey);
1520         return &quot;views/standaloneListGrid&quot;;
1521     }
1522 
1523     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1524     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1524     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1525             @PathVariable Map&lt;String, String&gt; pathVars,
1526             @PathVariable(value=&quot;id&quot;) String id,
1527             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1528             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1528             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1529         String sectionKey = getSectionKey(pathVars);
1530         String mainClassName = getClassNameForSection(sectionKey);
1531         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1532         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1532         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1533         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1534 
1535         if (StringUtils.isBlank(entityForm.getEntityType())) {
1536             FieldMetadata fmd = collectionProperty.getMetadata();
1537             if (fmd instanceof BasicCollectionMetadata) {
1538                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1539             }
1540         }
1541 
<abbr title="1542         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1542         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1543         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1543         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1544         entity.setIsPreAdd(true);
1545         // First, we must save the collection entity
<abbr title="1546         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1546         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1547         Entity savedEntity = persistenceResponse.getEntity();
1548 
1549         return new JsonResponse(response)
1550                 .with(&quot;status&quot;, &quot;complete&quot;)
1551                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1552                 .done();
1553     }
1554 
1555     /**
<abbr title="1556      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1556      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1557      * as well as after a POST with validation errors
1558      *
1559      * @param request
1560      * @param model
1561      * @param id
1562      * @param collectionField
1563      * @param sectionKey
1564      * @param collectionProperty
1565      * @param md
1566      * @param ppr
1567      * @return the appropriate view to display for the modal
<abbr title="1568      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1568      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1569      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1569      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1570      * @throws ServiceException
1571      */
<abbr title="1572     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1572     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1573             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1573             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1574             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1574             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1575 
<abbr title="1576         // For requests to add a new collection item include the main class that the subsequent request comes from.">1576         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1577         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1577         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1578         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1578         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1579         // fixes all cases.
1580         String mainClassName = getClassNameForSection(sectionKey);
1581         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1582         ppr.setAddOperationInspect(true);
1583 
1584         if (entityForm != null) {
1585             entityForm.clearFieldsMap();
1586         }
1587         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1588         if (md instanceof BasicCollectionMetadata) {
1589             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1590 
<abbr title="1591             // When adding items to basic collections, we will sometimes show a form to persist a new record">1591             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1592             // and sometimes show a list grid to allow the user to associate an existing record.
1593             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1594                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1594                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1595                 if (entityForm == null) {
1596                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1597                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1598                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1599                 } else {
1600                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1601                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1602                 }
<abbr title="1603                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1603                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1604                 entityForm.getTabs().iterator().next().getIsVisible();
1605 
1606                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1607                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1608             } else {
1609                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1610                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1610                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1611                 listGrid.setPathOverride(request.getRequestURL().toString());
1612 
<abbr title="1613                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1613                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1614                     listGrid.removeAllRowActions();
1615                 }
1616 
1617                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1618                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1619             }
1620         } else if (md instanceof AdornedTargetCollectionMetadata) {
1621             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1622 
<abbr title="1623             // Even though this field represents an adorned target collection, the list we want to show in the modal">1623             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1624             // is the standard list grid for the target entity of this field
1625             ppr.setOperationTypesOverride(null);
1626             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1627             ppr.setSectionEntityField(collectionField);
1628 
<abbr title="1629             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1629             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1630 
1631             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1632             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1632             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1633             listGrid.setSubCollectionFieldName(collectionField);
1634             listGrid.setPathOverride(request.getRequestURL().toString());
1635             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1636             if (entityForm == null) {
<abbr title="1637                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1637                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1638                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1638                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1639             } else {
<abbr title="1640                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1640                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1641                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1642             }
1643 
1644             listGrid.setListGridType(ListGrid.Type.ADORNED);
1645             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1646                 if (entry.getValue().getIsVisible()) {
1647                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1648                     break;
1649                 }
1650             }
1651 
1652             // This is part of an add, so we want to be able to filter/sort the listgrid
1653             listGrid.setIsSortable(false);
1654             listGrid.setCanFilterAndSort(true);
1655             listGrid.removeAllRowActions();
1656 
1657             model.addAttribute(&quot;listGrid&quot;, listGrid);
1658             model.addAttribute(&quot;entityForm&quot;, entityForm);
1659             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1660         } else if (md instanceof MapMetadata) {
1661             MapMetadata fmd = (MapMetadata) md;
<abbr title="1662             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1662             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1663 
1664             if (entityForm == null) {
<abbr title="1665                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1665                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1666             } else {
1667                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1668                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1669             }
1670             model.addAttribute(&quot;entityForm&quot;, entityForm);
1671             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1672         }
1673 
1674         // Set the parent id on the entity form
1675         if (entityForm != null) {
1676             entityForm.setParentId(id);
1677         }
1678 
1679         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1680         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1681         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1682         setModelAttributes(model, sectionKey);
1683         return MODAL_CONTAINER_VIEW;
1684     }
1685 
1686     /**
1687      * Shows the appropriate modal dialog to edit the selected collection item
1688      *
1689      * @param request
1690      * @param response
1691      * @param model
1692      * @param pathVars
1693      * @param id
1694      * @param collectionField
1695      * @param collectionItemId
1696      * @return the return view path
1697      * @throws Exception
1698      */
<abbr title="1699     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1699     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1700     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1700     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1701             @PathVariable  Map&lt;String, String&gt; pathVars,
1702             @PathVariable(value=&quot;id&quot;) String id,
1703             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1704             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1705             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1706         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1706         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1707                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1708     }
1709 
1710     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1711     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1711     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1712             @PathVariable  Map&lt;String, String&gt; pathVars,
1713             @PathVariable(value=&quot;id&quot;) String id,
1714             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1715             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1716         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1716         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1717                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1718     }
1719 
1720     /**
<abbr title="1721      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1721      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1722      *
1723      * @param request
1724      * @param response
1725      * @param model
1726      * @param pathVars
1727      * @param id
1728      * @param collectionField
1729      * @param collectionItemId
1730      * @return the return view path
1731      * @throws Exception
1732      */
<abbr title="1733     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1733     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1734     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1734     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1735             @PathVariable  Map&lt;String, String&gt; pathVars,
1736             @PathVariable(value=&quot;id&quot;) String id,
1737             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1738             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1739             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1740         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1740         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1741                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1742 
1743         // Since this is a read-only view, actions don&#x27;t make sense in this context
1744         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1745         addAuditableDisplayFields(ef);
1746         ef.removeAllActions();
1747         ef.setReadOnly();
1748 
1749         return returnPath;
1750     }
1751 
<abbr title="1752     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1752     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1753     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1753     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1754             @PathVariable  Map&lt;String, String&gt; pathVars,
1755             @PathVariable(value=&quot;id&quot;) String id,
1756             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1757             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1758         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1758         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1759                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1760 
1761         // Since this is a read-only view, actions don&#x27;t make sense in this context
1762         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1763         ef.removeAllActions();
1764         ef.setReadOnly();
1765 
1766         return returnPath;
1767     }
1768 
<abbr title="1769     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1769     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1770             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1770             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1771         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1771         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1772     }
1773 
<abbr title="1774     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1774     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1775             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1775             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1776         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1776         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1777     }
1778 
<abbr title="1779     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1779     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1780                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1780                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1781         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1781         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1782     }
1783 
1784     /**
<abbr title="1785      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1785      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1786      * which are optional. If they are not passed in then they are automatically looked up
1787      *
1788      * @param request
1789      * @param model
1790      * @param pathVars
1791      * @param id
1792      * @param collectionField
1793      * @param collectionItemId
1794      * @param modalHeaderType
1795      * @param entityForm
1796      * @param entity
1797      * @return
1798      * @throws ServiceException
1799      */
1800 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1801     protected String showViewUpdateCollection(HttpServletRequest request, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1802             Model model, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1803             Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1804             String id, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1805             String collectionField, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1806             String collectionItemId, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1807             String alternateId, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1808             String modalHeaderType, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1809             EntityForm entityForm, </span>
1810 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1811                 entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1812                 populateTypeAndId = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1813             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1814 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1815             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1816             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1816             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1817                     collectionField,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1818                     collectionItemId, responseMap);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1819 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1820             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1820             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1821             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1821             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1822             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1823             entityForm.setTranslationId(alternateId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1824 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1825             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1826             for (String field : fmd.getMaintainedAdornedTargetFields()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1827                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1828                     continue;</span>
1829 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1830     protected String showViewUpdateCollection(HttpServletRequest request,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1831             Model model,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1832             Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1833             String id,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1834             String collectionField,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1835             String collectionItemId,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1836             String alternateId,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1837             String modalHeaderType,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1838             EntityForm entityForm,</span>
1839 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1840             Entity entity) throws ServiceException {
1841         String sectionKey = getSectionKey(pathVars);
1842         String mainClassName = getClassNameForSection(sectionKey);
1843         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1844         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1844         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1845         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1846         FieldMetadata md = collectionProperty.getMetadata();
1847         SectionCrumb nextCrumb = new SectionCrumb();
1848         if (md instanceof MapMetadata) {
1849             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1850         } else {
1851             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1852         }
1853         nextCrumb.setSectionId(collectionItemId);
1854         if (!sectionCrumbs.contains(nextCrumb)) {
1855             sectionCrumbs.add(nextCrumb);
1856         }
1857 
<abbr title="1858         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1858         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1859         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1859         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1860 
1861         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1862 
1863         if (md instanceof BasicCollectionMetadata &amp;&amp;
1864                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1865                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1865                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1866             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1867 
<abbr title="1868             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1868             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1869             if (entity == null) {
<abbr title="1870                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1870                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1871             }
1872 
1873             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1874             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1874             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1875 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1876             </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1877             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1878                     subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1879             </span>
1880 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1881 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1882                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1882                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1883                             mmd.getTargetClass(), sectionCrumbs);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1884                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1885 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1886                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1887                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1887                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1888                     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1889                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1889                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1890                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1891                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1892             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1893 </span>
1894 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1895 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1896             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1897                     subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1898 </span>
1899 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1900             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1901             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1902 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1903             </span>
1904 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1905                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1905                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1906                     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1907                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1907                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1908                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1909                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1910             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1911 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1912             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1912             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1913             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1914 </span>
1915 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1916 </span>
1917 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1918             addAuditableDisplayFields(entityForm);
1919             model.addAttribute(&quot;entityForm&quot;, entityForm);
1920             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1921         } else if (md instanceof AdornedTargetCollectionMetadata) {
1922             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1923 
1924             if (entity == null) {
<abbr title="1925                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1925                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1926                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1927             }
1928 
1929             boolean populateTypeAndId = true;
<abbr title="1930             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1930             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1931             if (entityForm == null) {
<abbr title="1932                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1932                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1933                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1934                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1935             } else {
1936                 entityForm.clearFieldsMap();
1937                 String entityType = entityForm.getEntityType();
<abbr title="1938                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1938                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1939                 entityForm.setEntityType(entityType);
1940                 populateTypeAndId = false;
1941             }
1942 
1943             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1944             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1944             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1945                     collectionField,
1946                     collectionItemId, responseMap);
1947 
<abbr title="1948             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1948             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1949             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1949             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1950             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1951             entityForm.setTranslationId(alternateId);
1952 
1953             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1954             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1955                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1956                     continue;
1957                 }
1958                 Property p = cmd.getPMap().get(field);
1959                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1960                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1960                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1961                     // directly on the first adorned target collection. Because of this, we need the actual id property">1961                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1962                     // from the entity that models the adorned target relationship, and not the id of the target object.">1962                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1963                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1963                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1964                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1964                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1965                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1966 
<abbr title="1967                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1967                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1968                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1969                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1970 
1971                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1972                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1972                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1973                     } else {
<abbr title="1974                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1974                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1975                     }
1976                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1977                     // See above comment for AdornedTargetCollectionMetadata
1978                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1979 
<abbr title="1980                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1980                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1981                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1981                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1982                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1983 
<abbr title="1984                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1984                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1985                             mmd.getTargetClass(), sectionCrumbs);
1986                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1987 
1988                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1989                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1989                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1990                     } else {
<abbr title="1991                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1991                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1992                     }
1993                 }
1994             }
1995 
<abbr title="1996             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1996             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1997             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1998 
1999             boolean atLeastOneBasicField = false;
2000             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="2001                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">2001                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
2002                     atLeastOneBasicField = true;
2003                     break;
2004                 }
2005             }
2006             if (!atLeastOneBasicField) {
2007                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
2008             }
2009             addAuditableDisplayFields(entityForm);
2010             model.addAttribute(&quot;entityForm&quot;, entityForm);
2011             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
2012         } else if (md instanceof MapMetadata) {
2013             MapMetadata fmd = (MapMetadata) md;
2014 
<abbr title="2015             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">2015             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
2016             if (entity == null) {
<abbr title="2017                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">2017                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
2018                     collectionItemId, sectionCrumbs, null).getEntity();
2019             }
2020 
2021             boolean populateTypeAndId = true;
2022             if (entityForm == null) {
<abbr title="2023                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">2023                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
2024             } else {
2025                 //save off the prior key before clearing out the fields map as it will not appear
2026                 //back on the saved entity
2027                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
2028                 entityForm.clearFieldsMap();
2029                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
2030                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
2031                 populateTypeAndId = false;
2032             }
2033             try {
2034                 if (StringUtils.isNotEmpty(fmd.getToOneTargetProperty())) {
<abbr title="2035                     entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">2035                     entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclðŸ”µ</abbr>
2036                 }
2037             } catch (Exception e) {
2038                 LOG.error(e);
2039             }
<abbr title="2040             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.id&quot;);">2040             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetPropertðŸ”µ</abbr>
2041             entityForm.setTranslationId(entity.getPMap().get(entityId).getValue());
<abbr title="2042             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">2042             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
2043             formService.populateMapEntityFormFields(entityForm, entity);
<abbr title="2044             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">2044             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
2045             formService.populateMapEntityFormFields(entityForm, entity);
2046             addAuditableDisplayFields(entityForm);
2047             model.addAttribute(&quot;entityForm&quot;, entityForm);
2048             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
2049         }
2050 
2051         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2052         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
2053         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
2054         setModelAttributes(model, sectionKey);
2055         return MODAL_CONTAINER_VIEW;
2056     }
2057 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2058     </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2059     protected EntityForm reinitializeEntityForm(final EntityForm entityForm, </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2060             final ClassMetadata collectionMetadata,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2061             final Entity entity,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2062             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2063             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2064         if (entityForm == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2065             return formService</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2066                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2067         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2068         </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2069         entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2070         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2071                 sectionCrumbs);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2072         //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2073         entityForm.removeAllActions();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">2074     </span>
2075 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2076         // We return the new list grid so that it can replace the currently visible one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="2077         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2077         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2078 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2079         model.addAttribute(&quot;listGrid&quot;, listGrid);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2080         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2081         setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2082         return &quot;views/standaloneListGrid&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2083     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2084 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="2085     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">2085     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2086     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2087             HttpServletResponse response, Model model,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2088             @PathVariable  Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2089             @PathVariable(value=&quot;id&quot;) String id,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2090             @PathVariable(value=&quot;collectionField&quot;) String collectionField,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2091             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2092             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="2093         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">2093         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2094     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2095 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2096     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="2097      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">2097      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="2098      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">2098      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2099      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2100      * @param request</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2101      * @param response</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2102      * @param model</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">2103      * @param pathVars</span>
2104 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2105 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2106     protected EntityForm reinitializeEntityForm(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2107             final ClassMetadata collectionMetadata,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2108             final Entity entity,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2109             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2110             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2111         if (entityForm == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2112             return formService</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2113                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2114         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2115 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2116         entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2117         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2118                 sectionCrumbs);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2119         //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2120         entityForm.removeAllActions();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">2121 </span>
2122 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
2123         return entityForm;
2124     }
2125 
2126     /**
2127      * Updates the specified collection item
2128      *
2129      * @param request
2130      * @param response
2131      * @param model
2132      * @param pathVars
2133      * @param id
2134      * @param collectionField
<abbr title="2135      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">2135      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
2136      * @param entityForm
2137      * @param result
2138      * @return the return view path
2139      * @throws Exception
2140      */
2141     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="2142     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">2142     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
2143             @PathVariable  Map&lt;String, String&gt; pathVars,
2144             @PathVariable(value=&quot;id&quot;) String id,
2145             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2146             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2147             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
2148             BindingResult result) throws Exception {
<abbr title="2149         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">2149         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
2150     }
2151 
2152     /**
2153      * Updates the specified collection item
2154      *
2155      * @param request
2156      * @param response
2157      * @param model
2158      * @param pathVars
2159      * @param id
2160      * @param collectionField
<abbr title="2161      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">2161      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
2162      * @param entityForm
<abbr title="2163      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">2163      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
2164      * @param result
2165      * @return the return view path
2166      * @throws Exception
2167      */
<abbr title="2168     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">2168     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="2169     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">2169     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
2170             @PathVariable  Map&lt;String, String&gt; pathVars,
2171             @PathVariable(value=&quot;id&quot;) String id,
2172             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2173             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2174             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
2175             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
2176             BindingResult result) throws Exception {
2177         String sectionKey = getSectionKey(pathVars);
2178         String mainClassName = getClassNameForSection(sectionKey);
2179         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2180         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2180         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
2181         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2182 
<abbr title="2183         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2183         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="2184         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2184         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
2185         service.clearEntityManager();
2186         // First, we must save the collection entity
<abbr title="2187         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">2187         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
2188         Entity savedEntity = persistenceResponse.getEntity();
2189         entityFormValidator.validate(entityForm, savedEntity, result);
2190 
2191         if (result.hasErrors()) {
<abbr title="2192             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">2192             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
2193                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
2194         }
2195 
2196         // Next, we must get the new list grid that represents this collection
2197         // We return the new list grid so that it can replace the currently visible one
<abbr title="2198         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2198         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
2199 
2200         model.addAttribute(&quot;listGrid&quot;, listGrid);
2201         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2202         setModelAttributes(model, sectionKey);
2203         return &quot;views/standaloneListGrid&quot;;
2204     }
2205 
<abbr title="2206     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">2206     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
2207     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
2208             HttpServletResponse response, Model model,
2209             @PathVariable  Map&lt;String, String&gt; pathVars,
2210             @PathVariable(value=&quot;id&quot;) String id,
2211             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2212             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2213             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="2214         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">2214         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
2215     }
2216 
2217     /**
<abbr title="2218      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">2218      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="2219      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">2219      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
2220      *
2221      * @param request
2222      * @param response
2223      * @param model
2224      * @param pathVars
2225      * @param id
2226      * @param collectionField
2227      * @param collectionItemId
2228      * @return an object explaining the state of the operation
2229      * @throws Exception
2230      */
<abbr title="2231     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">2231     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
2232     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
2233             HttpServletResponse response, Model model,
2234             @PathVariable  Map&lt;String, String&gt; pathVars,
2235             @PathVariable(value=&quot;id&quot;) String id,
2236             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2237             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2238             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
2239             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2240         String sectionKey = getSectionKey(pathVars);
2241         String mainClassName = getClassNameForSection(sectionKey);
2242         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2243         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2243         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
2244         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2245         FieldMetadata md = collectionProperty.getMetadata();
2246 
<abbr title="2247         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2247         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
2248         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
2249 
<abbr title="2250         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2250         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
2251 
2252         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
2253 
2254         if (md instanceof AdornedTargetCollectionMetadata) {
2255             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
2256             AdornedTargetList atl = ppr.getAdornedList();
2257 
2258             // Get an entity form for the entity
<abbr title="2259             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">2259             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="2260             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">2260             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="2261                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">2261                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
2262                     .getDynamicResultSet().getRecords()[0];
2263             formService.populateEntityFormFields(entityForm, entity);
2264             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
2265 
<abbr title="2266             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">2266             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
2267             int sequenceValue = Integer.parseInt(newSequence) + 1;
2268             Field field = entityForm.findField(atl.getSortField());
2269             field.setValue(String.valueOf(sequenceValue));
2270 
2271             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2272             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">2272             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
2273             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
2274 
2275             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2276             responseMap.put(&quot;field&quot;, collectionField);
2277             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2278             return responseMap;
2279         } else if (md instanceof BasicCollectionMetadata) {
2280             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
2281             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2282             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2282             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
2283 
<abbr title="2284             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">2284             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
2285             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="2286             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">2286             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
2287             if(listGridReadOnly){
2288                         throw new SecurityServiceException();
2289             }
2290             if (!StringUtils.isEmpty(cd.getSortProperty())) {
2291                 Field f = new Field()
2292                         .withName(cd.getSortProperty())
2293                         .withFieldType(SupportedFieldType.HIDDEN.toString());
2294                 entityForm.addHiddenField(mainMetadata, f);
2295             }
2296             formService.populateEntityFormFields(entityForm, entity);
2297 
2298             if (!StringUtils.isEmpty(cd.getSortProperty())) {
2299                 int sequenceValue = Integer.parseInt(newSequence) + 1;
2300                 Field field = entityForm.findField(cd.getSortProperty());
2301                 field.setValue(String.valueOf(sequenceValue));
2302             }
2303 
<abbr title="2304             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">2304             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
2305             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
2306 
2307             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2308             responseMap.put(&quot;field&quot;, collectionField);
2309             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2310             return responseMap;
2311         } else {
<abbr title="2312             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">2312             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
2313         }
2314     }
2315 
2316     /**
2317      * Removes the requested collection item
2318      *
<abbr title="2319      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2319      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
2320      * map collection.
2321      *
2322      * @param request
2323      * @param response
2324      * @param model
2325      * @param pathVars
2326      * @param id
2327      * @param collectionField
2328      * @param collectionItemId
2329      * @return the return view path
2330      * @throws Exception
2331      */
<abbr title="2332     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">2332     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="2333     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">2333     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
2334             @PathVariable  Map&lt;String, String&gt; pathVars,
2335             @PathVariable(value=&quot;id&quot;) String id,
2336             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2337             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="2338         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">2338         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
2339     }
2340 
2341     /**
2342      * Removes the requested collection item
2343      *
<abbr title="2344      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2344      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
2345      * map collection.
2346      *
2347      * @param request
2348      * @param response
2349      * @param model
2350      * @param pathVars
2351      * @param id
2352      * @param collectionField
2353      * @param collectionItemId
2354      * @return the return view path
2355      * @throws Exception
2356      */
<abbr title="2357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">2357     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="2358     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">2358     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
2359             @PathVariable  Map&lt;String, String&gt; pathVars,
2360             @PathVariable(value=&quot;id&quot;) String id,
2361             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2362             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2363             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2364         String sectionKey = getSectionKey(pathVars);
2365         String mainClassName = getClassNameForSection(sectionKey);
2366         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2367         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2367         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
2368         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2369 
2370         String priorKey = request.getParameter(&quot;key&quot;);
2371 
<abbr title="2372         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2372         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
2373         declareShouldIgnoreAdditionStatusFilter();
<abbr title="2374         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2374         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
2375         service.clearEntityManager();
2376         // First, we must remove the collection entity
<abbr title="2377         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">2377         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="2378         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">2378         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
2379             String error = &quot;There was an error removing the whatever&quot;;
2380             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
2381                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="2382                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">2382                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="2383             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">2383             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
2384                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2385             }
2386             return new JsonResponse(response)
2387                 .with(&quot;status&quot;, &quot;error&quot;)
2388                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2389                 .done();
2390         }
2391 
2392         // Next, we must get the new list grid that represents this collection
2393         // We return the new list grid so that it can replace the currently visible one
<abbr title="2394         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2394         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
2395 
2396         model.addAttribute(&quot;listGrid&quot;, listGrid);
2397         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2398         setModelAttributes(model, sectionKey);
2399         return &quot;views/standaloneListGrid&quot;;
2400     }
2401 
2402     public void addAuditableDisplayFields(EntityForm entityForm) {
2403         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2404         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2405             addAuditableDisplayField(entityForm, createdBy);
2406 
2407             createdBy.setIsVisible(false);
2408         }
2409         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2410         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2411             addAuditableDisplayField(entityForm, updatedBy);
2412 
2413             updatedBy.setIsVisible(false);
2414         }
2415     }
2416 
2417     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2418         Field displayField = buildAuditableDisplayField(userField);
2419 
2420         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2421         String userName = user == null ? null : user.getName();
2422         displayField.setValue(userName);
2423 
2424         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2425         if (auditGroup != null) {
2426             auditGroup.addField(displayField);
2427         }
2428     }
2429 
2430     private Field buildAuditableDisplayField(Field auditableField) {
2431         return new Field().withFieldType(SupportedFieldType.STRING.toString())
2432                 .withName(auditableField.getName() + &quot;Display&quot;)
2433                 .withFriendlyName(auditableField.getFriendlyName())
2434                 .withOrder(auditableField.getOrder())
2435                 .withOwningEntityClass(auditableField.getOwningEntityClass())
2436                 .withReadOnly(true);
2437     }
2438 
2439     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2440         String tabName = pathVars.get(&quot;tabName&quot;);
2441         if (StringUtils.isBlank(tabName)) {
2442             TabMetadata firstTab = cmd.getFirstTab();
2443             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2444         }
2445         return tabName;
2446     }
2447 
2448     protected String getCurrentFolderId(HttpServletRequest request) {
2449         if (request.getParameterMap().containsKey(CURRENT_FOLDER_ID)) {
2450             return request.getParameter(CURRENT_FOLDER_ID);
2451         }
2452         return &quot;unassigned&quot;;
2453     }
2454 
2455     // *****************************************
2456     // Typed Entity Helper Methods
2457     // *****************************************
2458 
2459     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2460         // Check if this is a typed entity
2461         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2462         if (typedEntitySection != null) {
2463             // Update the friendly name for this Entity Type
2464             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2465         }
2466     }
2467 
2468     // *********************************
2469     // ADDITIONAL SPRING-BOUND METHODS *
2470     // *********************************
2471 
2472     /**
<abbr title="2473      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2473      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2474      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2474      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2475      * or false. If the value is passed in as null, it will treat it as false.
2476      *
2477      * @param binder
2478      */
2479     @InitBinder
2480     public void initBinder(WebDataBinder binder) {
2481         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2482         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2483     }
2484 
2485 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  30 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33 import org.broadleafcommerce.common.service.GenericEntityService;
  34 import org.broadleafcommerce.common.util.BLCArrayUtils;
  35 import org.broadleafcommerce.common.util.BLCMessageUtils;
  36 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37 import org.broadleafcommerce.common.web.JsonResponse;
  38 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43 import org.broadleafcommerce.openadmin.dto.ClassTree;
  44 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46 import org.broadleafcommerce.openadmin.dto.Entity;
  47 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50 import org.broadleafcommerce.openadmin.dto.Property;
  51 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  65 import org.broadleafcommerce.openadmin.web.dao.MultipleCatalogExtensionManager;
  66 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  67 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  68 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  69 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  70 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  71 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  72 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  73 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  74 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  75 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  76 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  77 import org.springframework.stereotype.Controller;
  78 import org.springframework.ui.Model;
  79 import org.springframework.util.MultiValueMap;
  80 import org.springframework.validation.BindingResult;
  81 import org.springframework.web.bind.WebDataBinder;
  82 import org.springframework.web.bind.annotation.InitBinder;
  83 import org.springframework.web.bind.annotation.ModelAttribute;
  84 import org.springframework.web.bind.annotation.PathVariable;
  85 import org.springframework.web.bind.annotation.RequestMapping;
  86 import org.springframework.web.bind.annotation.RequestMethod;
  87 import org.springframework.web.bind.annotation.RequestParam;
  88 import org.springframework.web.bind.annotation.ResponseBody;
  89 import org.springframework.web.servlet.DispatcherServlet;
  90 import org.springframework.web.servlet.FlashMap;
  91 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  92 import org.springframework.web.util.UrlPathHelper;
  93 
  94 import com.fasterxml.jackson.databind.ObjectMapper;
  95 
  96 import java.io.Serializable;
  97 import java.io.UnsupportedEncodingException;
  98 import java.net.URLDecoder;
  99 import java.util.ArrayList;
 100 import java.util.Arrays;
 101 import java.util.HashMap;
 102 import java.util.List;
 103 import java.util.Map;
 104 import java.util.Map.Entry;
 105 import java.util.Set;
 106 import java.util.stream.Stream;
 107 
 108 import javax.annotation.Resource;
 109 import javax.servlet.http.HttpServletRequest;
 110 import javax.servlet.http.HttpServletResponse;
 111 
 112 /**
 113  * The default implementation of the {@link AdminAbstractController}. This delegates every call to
 114  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 115  * admin for every entity that is not explicitly customized by its own controller.
 116  *
 117  * @author Andre Azzolini (apazzolini)
 118  * @author Jeff Fischer
 119  */
 120 @Controller(&quot;blAdminBasicEntityController&quot;)
 121 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 122 public class AdminBasicEntityController extends AdminAbstractController {
 123 
 124     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 125 
 126     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 127     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 128     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 129     protected static final String CURRENT_FOLDER_ID = &quot;currentFolderId&quot;;
 130 
 131     @Resource(name=&quot;blSandBoxHelper&quot;)
 132     protected SandBoxHelper sandBoxHelper;
 133 
 134     @Resource(name = &quot;blAdminUserDao&quot;)
 135     protected AdminUserDao adminUserDao;
 136 
 137     @Resource(name=&quot;blDynamicEntityDao&quot;)
 138     protected DynamicEntityDao dynamicEntityDao;
 139 
 140     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 141     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 142 
 143     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 144     protected RowLevelSecurityService rowLevelSecurityService;
 145 
 146     @Resource(name = &quot;blEntityDuplicator&quot;)
 147     protected EntityDuplicator duplicator;
 148 
 149     @Resource(name = &quot;blGenericEntityService&quot;)
 150     protected GenericEntityService genericEntityService;
 151 
 152     @Resource(name = &quot;blMultipleCatalogExtensionManager&quot;)
 153     protected MultipleCatalogExtensionManager multipleCatalogExtensionManager;
 154 
 155     // ******************************************
 156     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 157     // ******************************************
 158 
 159     /**
<abbr title=" 160      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 160      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 161      * criteria.
 162      *
 163      * @param request
 164      * @param response
 165      * @param model
 166      * @param pathVars
 167      * @param requestParams a Map of property name -&gt; list critiera values
 168      * @return the return view path
 169      * @throws Exception
 170      */
 171     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 172     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 173             @PathVariable Map&lt;String, String&gt; pathVars,
 174             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 175         String sectionKey = getSectionKey(pathVars);
 176         String sectionClassName = getClassNameForSection(sectionKey);
 177         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 178         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 178         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 179         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 180         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 181 
 182         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 183         listGrid.setSelectType(ListGrid.SelectType.NONE);
 184 
 185         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 186         if (CollectionUtils.isNotEmpty(headerFields)) {
 187             Field firstField = headerFields.iterator().next();
 188             if (requestParams.containsKey(firstField.getName())) {
 189                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 190             }
 191         }
 192 
 193         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 194 
 195         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 196         model.addAttribute(&quot;listGrid&quot;, listGrid);
 197 
 198         return DEFAULT_CONTAINER_VIEW;
 199     }
 200 
<abbr title=" 201     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 201     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 202             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 203         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 204         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 205         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 206         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 207 
 208         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 209         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 210             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 211         }
 212 
 213         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 214         String requestUri = request.getRequestURI();
 215         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 216             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 216             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 217         }
 218 
 219         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 220         model.addAttribute(&quot;currentUri&quot;, requestUri);
 221         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 222         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 223         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 224         model.addAttribute(&quot;mainActions&quot;, mainActions);
 225         setModelAttributes(model, sectionKey);
 226         setTypedEntityModelAttributes(request, model);
 227     }
 228 
 229     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 230     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 231              HttpServletResponse response, Model model,
 232              @PathVariable Map&lt;String, String&gt; pathVars,
 233              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 234         String sectionKey = getSectionKey(pathVars);
 235         String sectionClassName = getClassNameForSection(sectionKey);
 236         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 237         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 237         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 238                 .withCustomCriteria(getCustomCriteria(requestParams));
 239 
 240         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 241 
 242         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 243         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 244 
 245         return formService.constructSelectizeOptionMap(drs, cmd);
 246     }
 247 
 248     /**
 249      * Obtains the requested criteria parameter
 250      *
 251      * @param requestParams
 252      * @return
 253      */
 254     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 255         if (requestParams == null || requestParams.isEmpty()) {
 256             return null;
 257         }
 258 
 259         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 260         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 261         return new String[] {response};
 262     }
 263 
 264     /**
<abbr title=" 265      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 265      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 266      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 267      *
 268      * @param sectionClassName
 269      * @param cmd
 270      * @param mainActions
 271      */
<abbr title=" 272     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 272     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 273         if (isAddActionAllowed(sectionClassName, cmd)) {
 274             mainActions.add(DefaultMainActions.ADD);
 275         }
 276     }
 277 
 278     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 279         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 280         try {
 281             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 282         } catch (ServiceException e) {
 283             if (e instanceof SecurityServiceException) {
 284                 return false;
 285             }
 286         }
 287 
 288         final boolean canAdd = rowLevelSecurityService
 289                 .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);
 290         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 291     }
 292 
 293     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 294         //check if all the metadata is read only
 295         for (Property property : cmd.getProperties()) {
 296             if (property.getMetadata() instanceof BasicFieldMetadata) {
 297                 if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 298                         !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 299                     return true;
 300                 }
 301             }
 302         }
 303 
 304         return false;
 305     }
 306 
 307     /**
<abbr title=" 308      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 308      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 309      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 309      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 310      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 310      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 311      * they can then perform operations on sub collections.
 312      *
 313      * @param request
 314      * @param response
 315      * @param model
 316      * @param pathVars
 317      * @param entityType
 318      * @return the return view path
 319      * @throws Exception
 320      */
 321     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 322     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 322     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 323             @PathVariable  Map&lt;String, String&gt; pathVars,
 324             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 325         String sectionKey = getSectionKey(pathVars);
 326         String sectionClassName = getClassNameForSection(sectionKey);
 327         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 328         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 328         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 329         ppr.setAddOperationInspect(true);
 330         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 331 
 332         entityType = determineEntityType(entityType, cmd);
 333 
 334         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 335 
<abbr title=" 336         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 336         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 337         // is set to the type we&#x27;re going to be creating.
 338         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 339         entityForm.setEntityType(entityType);
 340 
<abbr title=" 341         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 341         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 342         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 342         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 343         // fields that are not applicable for this given entity type.
 344         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 345 
 346         modifyAddEntityForm(entityForm, pathVars);
 347 
 348         model.addAttribute(&quot;entityForm&quot;, entityForm);
 349         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 350 
 351         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 352         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 353         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 354         setModelAttributes(model, sectionKey);
 355         return MODAL_CONTAINER_VIEW;
 356     }
 357 
 358     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic
 359     // types for this entity.
 360     protected String determineEntityType(String entityType, final ClassMetadata cmd)
 361             throws UnsupportedEncodingException {
 362         if (StringUtils.isBlank(entityType)) {
 363             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 364                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 365             } else {
 366                 entityType = getDefaultEntityType();
 367             }
 368         } else {
 369             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 370         }
 371         return entityType;
 372     }
 373 
 374     /**
<abbr title=" 375      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 375      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 376      *
 377      * @param request
 378      * @param response
 379      * @param model
 380      * @param pathVars
 381      * @param entityForm
 382      * @param result
 383      * @return the return view path
 384      * @throws Exception
 385      */
 386     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 387     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 388             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 389             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 389             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 390         String sectionKey = getSectionKey(pathVars);
 391         String sectionClassName = getClassNameForSection(sectionKey);
 392         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 393         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 393         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 394 
 395         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 396         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 396         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 397         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 398         entityFormValidator.validate(entityForm, entity, result);
 399 
 400         if (result.hasErrors()) {
 401             entityForm.clearFieldsMap();
 402             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 403 
 404             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 405 
 406             modifyAddEntityForm(entityForm, pathVars);
 407 
 408             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 409             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 410             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 411             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 412             setModelAttributes(model, sectionKey);
 413             return MODAL_CONTAINER_VIEW;
 414         }
 415 
 416         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 417         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 417         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 418     }
 419 
 420     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
 421     public String duplicateEntity(final HttpServletRequest request,
 422             final HttpServletResponse response,
 423             final Model model,
 424             @PathVariable final Map&lt;String, String&gt; pathVars,
 425             @PathVariable(value = &quot;id&quot;) final String id,
 426             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,
 427             final BindingResult result) throws Exception {
 428         final String sectionKey = getSectionKey(pathVars);
 429         final String sectionClassName = getClassNameForSection(sectionKey);
 430         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);
 431         final long identifier = Long.parseLong(id);
 432 
 433         if (duplicator.validate(entityClass, identifier)) {
 434             final Object duplicate;
 435 
 436             try {
 437                 duplicate = duplicator.copy(entityClass, identifier);
 438             } catch (Exception e) {
 439                 LOG.error(&quot;Could not duplicate entity&quot;, e);
 440                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);
 441             }
 442 
 443             final Serializable dupId = genericEntityService.getIdentifier(duplicate);
 444 
 445             // Note that AJAX Redirects need the context path prepended to them
 446             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;
 447         } else {
 448             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);
 449         }
 450     }
 451 
 452     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {
 453         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();
 454         String message;
 455         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 456         if (context != null &amp;&amp; context.getMessageSource() != null) {
 457             message = context.getMessageSource()
 458                     .getMessage(code, null, code, context.getJavaLocale());
 459         } else {
 460             LOG.warn(
 461                     &quot;Could not find the MessageSource on the current request, &quot;
 462                             + &quot;not translating the message key&quot;);
 463             message = &quot;Duplication_Failure&quot;;
 464         }
 465 
 466         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 467         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 468         errorMap.put(&quot;code&quot;, code);
 469         errorMap.put(&quot;message&quot;, message);
 470         errors.add(errorMap);
 471         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 472     }
 473 
 474     /**
 475      * Renders the main entity form for the specified entity
 476      *
 477      * @param request
 478      * @param response
 479      * @param model
 480      * @param pathVars
 481      * @param id
 482      * @return the return view path
 483      * @throws Exception
 484      */
 485     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 486     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 487             @PathVariable  Map&lt;String, String&gt; pathVars,
 488             @PathVariable(&quot;id&quot;) String id) throws Exception {
 489         String sectionKey = getSectionKey(pathVars);
 490         String sectionClassName = getClassNameForSection(sectionKey);
 491         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 492         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 492         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 493 
 494         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 495         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 496 
 497         multipleCatalogExtensionManager.getProxy().setCurrentCatalog(entity, model);
 498 
<abbr title=" 499         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 499         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 500 
 501         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 502 
 503         modifyEntityForm(entity, entityForm, pathVars);
 504 
 505         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 506             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 507         }
 508 
 509         // Set the sectionKey again incase this is a typed entity
 510         entityForm.setSectionKey(sectionKey);
 511 
 512         // Build the current url in the cast that this is a typed entity
 513         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 514         int startIndex = request.getContextPath().length();
 515 
 516         // Remove the context path from servlet path
 517         String currentUrl = originatingUri.substring(startIndex);
 518 
 519         model.addAttribute(&quot;entity&quot;, entity);
 520         model.addAttribute(&quot;entityForm&quot;, entityForm);
 521         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 522         model.addAttribute(CURRENT_FOLDER_ID, getCurrentFolderId(request));
 523 
 524         setModelAttributes(model, sectionKey);
 525 
 526         // We want to replace author ids with their names
 527         addAuditableDisplayFields(entityForm);
 528 
 529         return resolveAppropriateEntityView(request, model, entityForm);
 530     }
 531 
<abbr title=" 532     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 532     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 533                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 534                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 534                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 535         String tabName = pathVars.get(&quot;tabName&quot;);
 536         if (StringUtils.isEmpty(tabName)) {
 537             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 538         }
 539         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 540     }
 541 
 542     private boolean isAddRequest(Entity entity) {
 543         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 544         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 544         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 545         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 546             return false;
 547         }
 548 
 549         return resultHolder.getResult();
 550     }
 551 
 552     /**
 553      * Attempts to get the List Grid for the selected tab.
 554      *
 555      * @param request
 556      * @param response
 557      * @param model
 558      * @param pathVars
 559      * @param id
 560      * @param tabName
 561      * @param entityForm
 562      * @param entity
 563      * @return the return view path
 564      * @throws Exception
 565      */
 566     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 567     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 568             @PathVariable Map&lt;String, String&gt; pathVars,
 569             @PathVariable(value = &quot;id&quot;) String id,
 570             @PathVariable(value = &quot;tabName&quot;) String tabName,
 571             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 572             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 573         String sectionKey = getSectionKey(pathVars);
 574         String sectionClassName = getClassNameForSection(sectionKey);
 575         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 576         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 576         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 577         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 578         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 579         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 579         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 580         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 581 
 582         modifyEntityForm(entity, entityForm, pathVars);
 583 
 584         model.addAttribute(&quot;entity&quot;, entity);
 585         model.addAttribute(&quot;entityForm&quot;, entityForm);
 586         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 587 
 588         setModelAttributes(model, sectionKey);
 589 
 590         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 591         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 592 
 593         return DEFAULT_CONTAINER_VIEW;
 594     }
 595 
 596     /**
 597      * Builds JSON that looks like this:
 598      *
 599      * {&quot;errors&quot;:
 600      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 601      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 602      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 603      *        &quot;errorType&quot;, &quot;field&quot;,
 604      *        &quot;tab&quot;: &quot;General&quot;
 605      *        },
 606      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 607      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 608      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 609      *        &quot;errorType&quot;, &quot;field&quot;,
 610      *        &quot;tab&quot;: &quot;General&quot;
 611      *        }]
 612      * }
 613      *
 614      */
 615     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 616     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 617             @PathVariable Map&lt;String, String&gt; pathVars,
 618             @PathVariable(value = &quot;id&quot;) String id,
 619             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620             RedirectAttributes ra) throws Exception {
 621 
 622         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 623 
 624         JsonResponse json = new JsonResponse(response);
 625         if (result.hasErrors()) {
 626             populateJsonValidationErrors(entityForm, result, json);
 627         }
 628         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 629         if (CollectionUtils.isNotEmpty(dirtyList)) {
 630             json.with(&quot;dirty&quot;, dirtyList);
 631         }
 632 
 633         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 634         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 634         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 635         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 636             return resultHolder.getResult();
 637         }
 638 
 639         return json.done();
 640     }
 641 
<abbr title=" 642     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 642     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 643         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 644         String sectionKey = getSectionKey(pathVars);
 645         String sectionClassName = getClassNameForSection(sectionKey);
 646         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 647         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 647         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 648         ClassMetadata cmd = null;
 649         Entity entity = null;
 650         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 651         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 652 
 653         for (Property p: entity.getProperties()) {
 654             if (p.getIsDirty()) {
 655                 dirtyList.add(p.getName());
 656             }
 657         }
 658         return dirtyList;
 659     }
 660 
 661     /**
<abbr title=" 662      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 662      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 663      * error fields highlighted. On a successful save, it will refresh the entity page.
 664      *
 665      * @param request
 666      * @param response
 667      * @param model
 668      * @param pathVars
 669      * @param id
 670      * @param entityForm
 671      * @param result
 672      * @return the return view path
 673      * @throws Exception
 674      */
 675     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 676     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 677             @PathVariable  Map&lt;String, String&gt; pathVars,
 678             @PathVariable(value=&quot;id&quot;) String id,
 679             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 680             RedirectAttributes ra) throws Exception {
 681         String sectionKey = getSectionKey(pathVars);
 682         String sectionClassName = getClassNameForSection(sectionKey);
 683         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 684         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 684         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 685         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 686 
 687         extractDynamicFormFields(cmd, entityForm);
 688 
<abbr title=" 689         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 689         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 690         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 691 
 692         entityFormValidator.validate(entityForm, entity, result);
 693 
 694         if (result.hasErrors()) {
 695             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 696             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 697 
<abbr title=" 698             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 698             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 699             entityForm.clearFieldsMap();
 700             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 701 
 702             modifyEntityForm(entity, entityForm, pathVars);
 703 
 704             model.addAttribute(&quot;entity&quot;, entity);
 705             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 706 
 707             setModelAttributes(model, sectionKey);
 708 
 709             return resolveAppropriateEntityView(request, model, entityForm);
 710         }
 711 
 712         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 713 
 714         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 715     }
 716 
 717     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,
 718             final Map&lt;String, String&gt; pathVars) throws Exception {
 719         if (isAddRequest(entity)) {
 720             modifyAddEntityForm(entityForm, pathVars);
 721         } else {
 722             modifyEntityForm(entityForm, pathVars);
 723         }
 724     }
 725 
 726     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 727             final Model model,
 728             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 729         if (isAjaxRequest(request)) {
 730             entityForm.setReadOnly();
 731             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 732             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 733             return MODAL_CONTAINER_VIEW;
 734         } else {
 735             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 736             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 737             return DEFAULT_CONTAINER_VIEW;
 738         }
 739     }
 740 
 741     /**
 742      * Attempts to remove the given entity.
 743      *
 744      * @param request
 745      * @param response
 746      * @param model
 747      * @param pathVars
 748      * @param id
 749      * @return the return view path
 750      * @throws Exception
 751      */
 752     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 753     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 754             @PathVariable  Map&lt;String, String&gt; pathVars,
 755             @PathVariable(value=&quot;id&quot;) String id,
 756             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 757             RedirectAttributes ra) throws Exception {
 758         String sectionKey = getSectionKey(pathVars);
 759         String sectionClassName = getClassNameForSection(sectionKey);
 760         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 761 
<abbr title=" 762         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 762         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 763         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 764         // Removal does not normally return an Entity unless there is some validation error
 765         if (entity != null) {
 766             entityFormValidator.validate(entityForm, entity, result);
 767             if (result.hasErrors()) {
 768                 // Create a flash attribute for the unsuccessful delete
 769                 FlashMap fm = new FlashMap();
 770                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 771                 fm.put(&quot;headerFlashAlert&quot;, true);
 772                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 773 
 774                 // Re-look back up the entity so that we can return something populated
<abbr title=" 775                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 775                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 776                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 776                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 777                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 778                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 778                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 779                 entityForm.clearFieldsMap();
 780                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 781                 modifyEntityForm(entityForm, pathVars);
 782 
 783                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 784                         .done();
 785             }
 786         }
 787 
 788         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 789         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 790 
 791         if (isAjaxRequest(request)) {
 792             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 793             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 793             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 794         } else {
 795             return &quot;redirect:/&quot; + sectionKey;
 796         }
 797     }
 798 
 799     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 800     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 800     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 801             @PathVariable  Map&lt;String, String&gt; pathVars,
 802             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 803             @RequestParam String ids,
 804             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 805         String sectionKey = getSectionKey(pathVars);
 806         String sectionClassName = getClassNameForSection(sectionKey);
 807         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 808         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 808         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 809         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 809         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 810         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 811         FieldMetadata md = collectionProperty.getMetadata();
 812 
 813         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 814         ppr.setStartIndex(getStartIndex(requestParams));
 815         ppr.setMaxIndex(getMaxIndex(requestParams));
 816 
 817         if (md instanceof BasicFieldMetadata) {
 818             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 819             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 820 
 821             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 822             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 823 
 824             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 825             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 826 
 827             for (Entity e : drs.getRecords()) {
 828                 String id = e.getPMap().get(idProp).getValue();
 829                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 830 
 831                 if (StringUtils.isBlank(disp)) {
 832                     disp = e.getPMap().get(displayProp).getValue();
 833                 }
 834 
 835                 returnMap.put(id,  disp);
 836             }
 837 
 838             return returnMap;
 839         }
 840 
 841         return null;
 842     }
 843 
 844     /**
<abbr title=" 845      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 845      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 846      * then this method is invoked when a user clicks on the name of the default category field.
 847      *
 848      * @param request
 849      * @param response
 850      * @param model
 851      * @param pathVars
 852      * @param collectionField
 853      * @param id
 854      * @return
 855      * @throws Exception
 856      */
 857     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 858     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 858     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 859             @PathVariable  Map&lt;String, String&gt; pathVars,
 860             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 861             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 862         String sectionKey = getSectionKey(pathVars);
 863         String mainClassName = getClassNameForSection(sectionKey);
 864         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 865         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 865         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 866         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 867         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 868 
<abbr title=" 869         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 869         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 870         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 870         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 871         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 872         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 873         return viewEntityForm(request, response, model, varsForField, id);
 874     }
 875 
 876     @RequestMapping(
 877             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 878             method = RequestMethod.POST
 879     )
<abbr title=" 880     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 880     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 881                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 882                                         @PathVariable(value=&quot;id&quot;) String id,
 883                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 884                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 885                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 886                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 886                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 887 
<abbr title=" 888         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 888         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 889     }
 890 
 891 
 892     @RequestMapping(
 893             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 894             method = RequestMethod.POST
 895     )
<abbr title=" 896     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 896     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
 897                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 898                                         @PathVariable(value=&quot;id&quot;) String id,
 899                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 900                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 901                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 902                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 902                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 903 
<abbr title=" 904         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 904         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 905     }
 906 
 907 
 908     /**
 909      * Returns the records for a given collectionField filtered by a particular criteria
 910      *
 911      * @param request
 912      * @param response
 913      * @param model
 914      * @param pathVars
 915      * @param collectionField
 916      * @param requestParams
 917      * @return the return view path
 918      * @throws Exception
 919      */
 920     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 921     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 921     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 922             @PathVariable  Map&lt;String, String&gt; pathVars,
 923             @PathVariable(value=&quot;id&quot;) String id,
 924             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 925             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 926         String sectionKey = getSectionKey(pathVars);
 927         String mainClassName = getClassNameForSection(sectionKey);
 928         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 929         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 929         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 930         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 930         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 931         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 932 
 933         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 934         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 934         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 935 
 936         // Next, we must get the new list grid that represents this collection
<abbr title=" 937         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 937         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 938         model.addAttribute(&quot;listGrid&quot;, listGrid);
 939 
 940         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 941 
 942         // We return the new list grid so that it can replace the currently visible one
 943         setModelAttributes(model, sectionKey);
 944         return &quot;views/standaloneListGrid&quot;;
 945     }
 946 
 947     /**
<abbr title=" 948      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 948      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 949      * of this call depending on the type of the specified collection field.
 950      *
 951      * &lt;ul&gt;
 952      *  &lt;li&gt;
<abbr title=" 953      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 953      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 954      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 954      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 955      *  &lt;/li&gt;
 956      *  &lt;li&gt;
<abbr title=" 957      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 957      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 958      *    Used by fields such as &quot;allParentCategories&quot;.
 959      *  &lt;/li&gt;
 960      *  &lt;li&gt;
<abbr title=" 961      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 961      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 962      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 962      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 963      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 963      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 964      *  &lt;/li&gt;
 965      *  &lt;li&gt;
<abbr title=" 966      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 966      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 967      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 967      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 968      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 968      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 969      *    to linking an entity, provide extra fields, such as a promotional message.
 970      *  &lt;/li&gt;
 971      *  &lt;li&gt;
<abbr title=" 972      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 972      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 973      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 973      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 974      *    entity. Used by fields such as the mediaMap on a Sku.
 975      *  &lt;/li&gt;
 976      *
 977      * @param request
 978      * @param response
 979      * @param model
 980      * @param pathVars
 981      * @param id
 982      * @param collectionField
 983      * @param requestParams
 984      * @return the return view path
 985      * @throws Exception
 986      */
 987     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 988     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 988     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 989             @PathVariable Map&lt;String, String&gt; pathVars,
 990             @PathVariable(value = &quot;id&quot;) String id,
 991             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 992             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 993         String sectionKey = getSectionKey(pathVars);
 994         String mainClassName = getClassNameForSection(sectionKey);
 995         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 996         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 996         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 997                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 998         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 999         FieldMetadata md = collectionProperty.getMetadata();
1000 
1001         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1002                 .withFilterAndSortCriteria(getCriteria(requestParams))
1003                 .withStartIndex(getStartIndex(requestParams))
1004                 .withMaxIndex(getMaxIndex(requestParams))
1005                 .withLastId(getLastId(requestParams))
1006                 .withFirstId(getFirstId(requestParams))
1007                 .withUpperCount(getUpperCount(requestParams))
1008                 .withLowerCount(getLowerCount(requestParams))
1009                 .withPageSize(getPageSize(requestParams))
1010                 .withPresentationFetch(true);
1011 
1012         if (md instanceof BasicCollectionMetadata) {
1013             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1014             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1015                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1015                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title="1016                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types">1016                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
1017                 // for this entity.
1018                 String entityType = null;
1019 
1020                 if (requestParams.containsKey(&quot;entityType&quot;)) {
1021                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
1022                 }
1023 
1024                 entityType = determineEntityType(entityType, cmd);
1025 
1026                 if (StringUtils.isBlank(entityType)) {
1027                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
1028                     }
1029 
1030                     ppr = ppr.withCeilingEntityClassname(entityType);
1031                 }
1032         } else if (md instanceof MapMetadata) {
<abbr title="1033             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1033             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
1034             if (result.equals(ExtensionResultStatusType.HANDLED)) {
1035                 model.addAttribute(&quot;entityId&quot;, id);
1036                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1037                 model.addAttribute(&quot;collectionField&quot;, collectionField);
1038                 return MODAL_CONTAINER_VIEW;
1039             }
1040         }
1041 
1042         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1043 
<abbr title="1044         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1044         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
1045     }
1046 
<abbr title="1047     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1047     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title="1048     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1048     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1049             @PathVariable Map&lt;String, String&gt; pathVars,
1050             @PathVariable(value=&quot;id&quot;) String id,
1051             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1052             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1053         String sectionKey = getSectionKey(pathVars);
1054         String mainClassName = getClassNameForSection(sectionKey);
1055         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1056         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1056         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1057         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1058         FieldMetadata md = collectionProperty.getMetadata();
1059         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1060         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1061             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1061             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1062                     collectionField,
1063                     collectionItemId, responseMap);
1064         }
1065         return responseMap;
1066     }
1067 
1068     protected String getModalForBlankEntityType(final HttpServletRequest request,
1069             final Model model, final String sectionKey, final ClassMetadata cmd) {
1070         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1071         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1072         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1073         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1074 
1075         String requestUri = request.getRequestURI();
1076         final String contextPath = request.getContextPath();
1077 
1078         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1079             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1080         }
1081 
1082         model.addAttribute(&quot;currentUri&quot;, requestUri);
1083         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1084         setModelAttributes(model, sectionKey);
1085 
1086         return MODAL_CONTAINER_VIEW;
1087     }
1088 
1089     /**
1090      *
1091      * @param request
1092      * @param response
1093      * @param model
1094      * @param pathVars
1095      * @param id
1096      * @param collectionField
1097      * @param requestParams
1098      * @return Json collection data
1099      * @throws Exception
1100      */
1101     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1102     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1102     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1103             @PathVariable Map&lt;String, String&gt; pathVars,
1104             @PathVariable(value = &quot;id&quot;) String id,
1105             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1106             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1107         String sectionKey = getSectionKey(pathVars);
1108         String mainClassName = getClassNameForSection(sectionKey);
1109         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1110         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1110         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1111                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1112         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1113         FieldMetadata md = collectionProperty.getMetadata();
1114 
1115         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1116                 .withFilterAndSortCriteria(getCriteria(requestParams))
1117                 .withStartIndex(getStartIndex(requestParams))
1118                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1119         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1119         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1120                 .toArray(String[]::new);
1121         ppr = ppr.withCustomCriteria( both);
1122 
1123         if (md instanceof AdornedTargetCollectionMetadata) {
1124             ppr.setOperationTypesOverride(null);
1125             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1126             ppr.setSectionEntityField(collectionField);
1127         }
1128 
1129         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1130 
<abbr title="1131         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1131         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1132     }
1133 
1134     protected String[] buildSelectizeCustomCriteria() {
1135         return new String[]{ IS_SELECTIZE_REQUEST };
1136     }
1137 
1138     /**
1139      * Adds the requested collection item via Selectize
1140      *
1141      * @param request
1142      * @param response
1143      * @param model
1144      * @param pathVars
1145      * @param id
1146      * @param collectionField
1147      * @param entityForm
1148      * @return the return view path
1149      * @throws Exception
1150      */
1151     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1152     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1152     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1153             @PathVariable Map&lt;String, String&gt; pathVars,
1154             @PathVariable(value=&quot;id&quot;) String id,
1155             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1156             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1156             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1157         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1158         String sectionKey = getSectionKey(pathVars);
1159         String mainClassName = getClassNameForSection(sectionKey);
1160         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1161         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1161         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1162         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1163 
1164         if (StringUtils.isBlank(entityForm.getEntityType())) {
1165             FieldMetadata fmd = collectionProperty.getMetadata();
1166             if (fmd instanceof BasicCollectionMetadata) {
1167                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1168             }
1169         }
1170 
<abbr title="1171         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1171         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1172         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1173         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1174         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1174         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1175 
1176         // First, we must save the collection entity
<abbr title="1177         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1177         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1178         Entity savedEntity = persistenceResponse.getEntity();
1179         entityFormValidator.validate(entityForm, savedEntity, result);
1180 
1181         if (result.hasErrors()) {
1182             returnVal.put(&quot;error&quot;, result.getFieldError());
1183             return returnVal;
1184         }
1185 
1186         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1187             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1188         }
1189         return returnVal;
1190     }
1191 
1192     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1193         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1193         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1194         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1195     }
1196 
1197     /**
1198      * Adds the requested collection item
1199      *
1200      * @param request
1201      * @param response
1202      * @param model
1203      * @param pathVars
1204      * @param id
1205      * @param collectionField
1206      * @param entityForm
1207      * @return the return view path
1208      * @throws Exception
1209      */
1210     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1211     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1211     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1212             @PathVariable Map&lt;String, String&gt; pathVars,
1213             @PathVariable(value=&quot;id&quot;) String id,
1214             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1215             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1215             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1216         String sectionKey = getSectionKey(pathVars);
1217         String mainClassName = getClassNameForSection(sectionKey);
1218         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1219         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1219         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1220         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1221 
1222         if (StringUtils.isBlank(entityForm.getEntityType())) {
1223             FieldMetadata fmd = collectionProperty.getMetadata();
1224             if (fmd instanceof BasicCollectionMetadata) {
1225                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1226             }
1227         }
1228 
<abbr title="1229         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1229         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1230         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1231         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1231         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1232         service.clearEntityManager();
1233 
1234         // First, we must save the collection entity
<abbr title="1235         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1235         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1236         Entity savedEntity = persistenceResponse.getEntity();
1237         entityFormValidator.validate(entityForm, savedEntity, result);
1238 
1239         if (result.hasErrors()) {
1240             FieldMetadata md = collectionProperty.getMetadata();
1241             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1242             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1242             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1243                     md, ppr, entityForm, savedEntity);
1244         }
1245 
1246         // Next, we must get the new list grid that represents this collection
<abbr title="1247         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1247         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1248         model.addAttribute(&quot;listGrid&quot;, listGrid);
1249 
1250         // We return the new list grid so that it can replace the currently visible one
1251         model.addAttribute(&quot;actualEntityId&quot;, id);
1252         setModelAttributes(model, sectionKey);
1253         return &quot;views/standaloneListGrid&quot;;
1254     }
1255 
1256     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1257     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1257     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1258             @PathVariable Map&lt;String, String&gt; pathVars,
1259             @PathVariable(value=&quot;id&quot;) String id,
1260             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1261             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1261             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1262         String sectionKey = getSectionKey(pathVars);
1263         String mainClassName = getClassNameForSection(sectionKey);
1264         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1265         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1265         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1266         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1267 
1268         if (StringUtils.isBlank(entityForm.getEntityType())) {
1269             FieldMetadata fmd = collectionProperty.getMetadata();
1270             if (fmd instanceof BasicCollectionMetadata) {
1271                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1272             }
1273         }
1274 
<abbr title="1275         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1275         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1276         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1276         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1277         entity.setIsPreAdd(true);
1278         // First, we must save the collection entity
<abbr title="1279         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1279         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1280         Entity savedEntity = persistenceResponse.getEntity();
1281 
1282         return new JsonResponse(response)
1283                 .with(&quot;status&quot;, &quot;complete&quot;)
1284                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1285                 .done();
1286     }
1287 
1288     /**
<abbr title="1289      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1289      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1290      * as well as after a POST with validation errors
1291      *
1292      * @param request
1293      * @param model
1294      * @param id
1295      * @param collectionField
1296      * @param sectionKey
1297      * @param collectionProperty
1298      * @param md
1299      * @param ppr
1300      * @return the appropriate view to display for the modal
<abbr title="1301      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1301      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1302      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1302      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1303      * @throws ServiceException
1304      */
<abbr title="1305     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1305     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1306             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1306             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1307             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1307             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1308 
<abbr title="1309         // For requests to add a new collection item include the main class that the subsequent request comes from.">1309         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1310         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1310         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1311         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1311         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1312         // fixes all cases.
1313         String mainClassName = getClassNameForSection(sectionKey);
1314         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1315         ppr.setAddOperationInspect(true);
1316 
1317         if (entityForm != null) {
1318             entityForm.clearFieldsMap();
1319         }
1320         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1321         if (md instanceof BasicCollectionMetadata) {
1322             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1323 
<abbr title="1324             // When adding items to basic collections, we will sometimes show a form to persist a new record">1324             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1325             // and sometimes show a list grid to allow the user to associate an existing record.
1326             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1327                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1327                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1328                 if (entityForm == null) {
1329                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1330                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1331                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1332                 } else {
1333                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1334                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1335                 }
<abbr title="1336                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1336                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1337                 entityForm.getTabs().iterator().next().getIsVisible();
1338 
1339                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1340                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1341             } else {
1342                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1343                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1343                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1344                 listGrid.setPathOverride(request.getRequestURL().toString());
1345 
<abbr title="1346                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1346                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1347                     listGrid.removeAllRowActions();
1348                 }
1349 
1350                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1351                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1352             }
1353         } else if (md instanceof AdornedTargetCollectionMetadata) {
1354             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1355 
<abbr title="1356             // Even though this field represents an adorned target collection, the list we want to show in the modal">1356             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1357             // is the standard list grid for the target entity of this field
1358             ppr.setOperationTypesOverride(null);
1359             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1360             ppr.setSectionEntityField(collectionField);
1361 
<abbr title="1362             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1362             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1363 
1364             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1365             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1365             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1366             listGrid.setSubCollectionFieldName(collectionField);
1367             listGrid.setPathOverride(request.getRequestURL().toString());
1368             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1369             if (entityForm == null) {
<abbr title="1370                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1370                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1371                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1371                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1372             } else {
<abbr title="1373                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1373                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1374                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1375             }
1376 
1377             listGrid.setListGridType(ListGrid.Type.ADORNED);
1378             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1379                 if (entry.getValue().getIsVisible()) {
1380                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1381                     break;
1382                 }
1383             }
1384 
1385             // This is part of an add, so we want to be able to filter/sort the listgrid
1386             listGrid.setIsSortable(false);
1387             listGrid.setCanFilterAndSort(true);
1388             listGrid.removeAllRowActions();
1389 
1390             model.addAttribute(&quot;listGrid&quot;, listGrid);
1391             model.addAttribute(&quot;entityForm&quot;, entityForm);
1392             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1393         } else if (md instanceof MapMetadata) {
1394             MapMetadata fmd = (MapMetadata) md;
<abbr title="1395             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1395             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1396 
1397             if (entityForm == null) {
<abbr title="1398                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1398                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1399             } else {
1400                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1401                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1402             }
1403             model.addAttribute(&quot;entityForm&quot;, entityForm);
1404             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1405         }
1406 
1407         // Set the parent id on the entity form
1408         if (entityForm != null) {
1409             entityForm.setParentId(id);
1410         }
1411 
1412         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1413         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1414         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1415         setModelAttributes(model, sectionKey);
1416         return MODAL_CONTAINER_VIEW;
1417     }
1418 
1419     /**
1420      * Shows the appropriate modal dialog to edit the selected collection item
1421      *
1422      * @param request
1423      * @param response
1424      * @param model
1425      * @param pathVars
1426      * @param id
1427      * @param collectionField
1428      * @param collectionItemId
1429      * @return the return view path
1430      * @throws Exception
1431      */
<abbr title="1432     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1432     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1433     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1433     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1434             @PathVariable  Map&lt;String, String&gt; pathVars,
1435             @PathVariable(value=&quot;id&quot;) String id,
1436             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1437             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1438             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1439         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1440                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1441     }
1442 
1443     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1444     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1444     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1445             @PathVariable  Map&lt;String, String&gt; pathVars,
1446             @PathVariable(value=&quot;id&quot;) String id,
1447             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1448             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1449         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1449         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1450                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1451     }
1452 
1453     /**
<abbr title="1454      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1454      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1455      *
1456      * @param request
1457      * @param response
1458      * @param model
1459      * @param pathVars
1460      * @param id
1461      * @param collectionField
1462      * @param collectionItemId
1463      * @return the return view path
1464      * @throws Exception
1465      */
<abbr title="1466     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1466     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1467     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1467     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1468             @PathVariable  Map&lt;String, String&gt; pathVars,
1469             @PathVariable(value=&quot;id&quot;) String id,
1470             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1471             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1472             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1473         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1473         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1474                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1475 
1476         // Since this is a read-only view, actions don&#x27;t make sense in this context
1477         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1478         addAuditableDisplayFields(ef);
1479         ef.removeAllActions();
1480         ef.setReadOnly();
1481 
1482         return returnPath;
1483     }
1484 
<abbr title="1485     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1485     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1486     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1486     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1487             @PathVariable  Map&lt;String, String&gt; pathVars,
1488             @PathVariable(value=&quot;id&quot;) String id,
1489             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1490             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1491         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1491         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1492                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1493 
1494         // Since this is a read-only view, actions don&#x27;t make sense in this context
1495         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1496         ef.removeAllActions();
1497         ef.setReadOnly();
1498 
1499         return returnPath;
1500     }
1501 
<abbr title="1502     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1502     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1503             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1503             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1504         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1504         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1505     }
1506 
<abbr title="1507     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1507     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1508             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1508             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1509         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1509         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1510     }
1511 
<abbr title="1512     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1512     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1513                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1513                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1514         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1514         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1515     }
1516 
1517     /**
<abbr title="1518      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1518      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1519      * which are optional. If they are not passed in then they are automatically looked up
1520      *
1521      * @param request
1522      * @param model
1523      * @param pathVars
1524      * @param id
1525      * @param collectionField
1526      * @param collectionItemId
1527      * @param modalHeaderType
1528      * @param entityForm
1529      * @param entity
1530      * @return
1531      * @throws ServiceException
1532      */
1533     protected String showViewUpdateCollection(HttpServletRequest request,
1534             Model model,
1535             Map&lt;String, String&gt; pathVars,
1536             String id,
1537             String collectionField,
1538             String collectionItemId,
1539             String alternateId,
1540             String modalHeaderType,
1541             EntityForm entityForm,
1542             Entity entity) throws ServiceException {
1543         String sectionKey = getSectionKey(pathVars);
1544         String mainClassName = getClassNameForSection(sectionKey);
1545         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1546         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1546         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1547         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1548         FieldMetadata md = collectionProperty.getMetadata();
1549         SectionCrumb nextCrumb = new SectionCrumb();
1550         if (md instanceof MapMetadata) {
1551             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1552         } else {
1553             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1554         }
1555         nextCrumb.setSectionId(collectionItemId);
1556         if (!sectionCrumbs.contains(nextCrumb)) {
1557             sectionCrumbs.add(nextCrumb);
1558         }
1559 
<abbr title="1560         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1560         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1561         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1561         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1562 
1563         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1564 
1565         if (md instanceof BasicCollectionMetadata &amp;&amp;
1566                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1567                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1567                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1568             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1569 
<abbr title="1570             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1570             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1571             if (entity == null) {
<abbr title="1572                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1572                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1573             }
1574 
1575             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1576             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1576             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1577 
1578             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,
1579                     subRecordsMap, sectionCrumbs);
1580 
1581             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1582             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1583 
1584             addAuditableDisplayFields(entityForm);
1585             model.addAttribute(&quot;entityForm&quot;, entityForm);
1586             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1587         } else if (md instanceof AdornedTargetCollectionMetadata) {
1588             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1589 
1590             if (entity == null) {
<abbr title="1591                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1591                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1592                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1593             }
1594 
1595             boolean populateTypeAndId = true;
<abbr title="1596             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1596             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1597             if (entityForm == null) {
<abbr title="1598                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1598                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1599                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1600                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1601             } else {
1602                 entityForm.clearFieldsMap();
1603                 String entityType = entityForm.getEntityType();
<abbr title="1604                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1604                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1605                 entityForm.setEntityType(entityType);
1606                 populateTypeAndId = false;
1607             }
1608 
1609             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1610             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1610             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1611                     collectionField,
1612                     collectionItemId, responseMap);
1613 
<abbr title="1614             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1614             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1615             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1615             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1616             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1617             entityForm.setTranslationId(alternateId);
1618 
1619             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1620             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1621                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1622                     continue;
1623                 }
1624                 Property p = cmd.getPMap().get(field);
1625                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1626                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1626                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1627                     // directly on the first adorned target collection. Because of this, we need the actual id property">1627                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1628                     // from the entity that models the adorned target relationship, and not the id of the target object.">1628                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1629                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1629                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1630                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1630                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1631                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1632 
<abbr title="1633                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1633                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1634                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1635                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1636 
1637                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1638                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1638                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1639                     } else {
<abbr title="1640                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1640                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1641                     }
1642                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1643                     // See above comment for AdornedTargetCollectionMetadata
1644                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1645 
<abbr title="1646                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1646                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1647                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1647                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1648                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1649 
<abbr title="1650                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1650                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1651                             mmd.getTargetClass(), sectionCrumbs);
1652                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1653 
1654                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1655                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1655                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1656                     } else {
<abbr title="1657                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1657                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1658                     }
1659                 }
1660             }
1661 
<abbr title="1662             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1662             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1663             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1664 
1665             boolean atLeastOneBasicField = false;
1666             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1667                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1667                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1668                     atLeastOneBasicField = true;
1669                     break;
1670                 }
1671             }
1672             if (!atLeastOneBasicField) {
1673                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1674             }
1675             addAuditableDisplayFields(entityForm);
1676             model.addAttribute(&quot;entityForm&quot;, entityForm);
1677             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1678         } else if (md instanceof MapMetadata) {
1679             MapMetadata fmd = (MapMetadata) md;
1680 
<abbr title="1681             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1681             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1682             if (entity == null) {
<abbr title="1683                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1683                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1684                     collectionItemId, sectionCrumbs, null).getEntity();
1685             }
1686 
1687             boolean populateTypeAndId = true;
1688             if (entityForm == null) {
<abbr title="1689                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1689                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1690             } else {
1691                 //save off the prior key before clearing out the fields map as it will not appear
1692                 //back on the saved entity
1693                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1694                 entityForm.clearFieldsMap();
1695                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1696                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1697                 populateTypeAndId = false;
1698             }
1699             try {
1700                 if (StringUtils.isNotEmpty(fmd.getToOneTargetProperty())) {
<abbr title="1701                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1701                 entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredðŸ”µ</abbr>
1702                 }
1703             } catch (Exception e) {
1704                 LOG.error(e);
1705             }
<abbr title="1706             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.id&quot;);">1706             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetPropertðŸ”µ</abbr>
1707             entityForm.setTranslationId(entity.getPMap().get(entityId).getValue());
<abbr title="1708             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1708             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1709             formService.populateMapEntityFormFields(entityForm, entity);
<abbr title="1710             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1710             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1711             formService.populateMapEntityFormFields(entityForm, entity);
1712             addAuditableDisplayFields(entityForm);
1713             model.addAttribute(&quot;entityForm&quot;, entityForm);
1714             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1715         }
1716 
1717         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1718         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1719         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1720         setModelAttributes(model, sectionKey);
1721         return MODAL_CONTAINER_VIEW;
1722     }
1723 
1724     protected EntityForm reinitializeEntityForm(final EntityForm entityForm,
1725             final ClassMetadata collectionMetadata,
1726             final Entity entity,
1727             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,
1728             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
1729         if (entityForm == null) {
1730             return formService
1731                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);
1732         }
1733 
1734         entityForm.clearFieldsMap();
1735         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,
1736                 sectionCrumbs);
1737         //remove all the actions since we&#x27;re not trying to redisplay them on the form
1738         entityForm.removeAllActions();
1739 
1740         return entityForm;
1741     }
1742 
1743     /**
1744      * Updates the specified collection item
1745      *
1746      * @param request
1747      * @param response
1748      * @param model
1749      * @param pathVars
1750      * @param id
1751      * @param collectionField
<abbr title="1752      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1752      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1753      * @param entityForm
1754      * @param result
1755      * @return the return view path
1756      * @throws Exception
1757      */
1758     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1759     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1759     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1760             @PathVariable  Map&lt;String, String&gt; pathVars,
1761             @PathVariable(value=&quot;id&quot;) String id,
1762             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1763             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1764             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1765             BindingResult result) throws Exception {
<abbr title="1766         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1766         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1767     }
1768 
1769     /**
1770      * Updates the specified collection item
1771      *
1772      * @param request
1773      * @param response
1774      * @param model
1775      * @param pathVars
1776      * @param id
1777      * @param collectionField
<abbr title="1778      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1778      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1779      * @param entityForm
<abbr title="1780      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1780      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1781      * @param result
1782      * @return the return view path
1783      * @throws Exception
1784      */
<abbr title="1785     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1785     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1786     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1786     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1787             @PathVariable  Map&lt;String, String&gt; pathVars,
1788             @PathVariable(value=&quot;id&quot;) String id,
1789             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1790             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1791             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1792             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1793             BindingResult result) throws Exception {
1794         String sectionKey = getSectionKey(pathVars);
1795         String mainClassName = getClassNameForSection(sectionKey);
1796         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1797         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1797         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1798         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1799 
<abbr title="1800         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1800         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1801         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1801         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1802         service.clearEntityManager();
1803         // First, we must save the collection entity
<abbr title="1804         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1804         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1805         Entity savedEntity = persistenceResponse.getEntity();
1806         entityFormValidator.validate(entityForm, savedEntity, result);
1807 
1808         if (result.hasErrors()) {
<abbr title="1809             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1809             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1810                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1811         }
1812 
1813         // Next, we must get the new list grid that represents this collection
1814         // We return the new list grid so that it can replace the currently visible one
<abbr title="1815         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1815         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1816 
1817         model.addAttribute(&quot;listGrid&quot;, listGrid);
1818         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1819         setModelAttributes(model, sectionKey);
1820         return &quot;views/standaloneListGrid&quot;;
1821     }
1822 
<abbr title="1823     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1823     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1824     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1825             HttpServletResponse response, Model model,
1826             @PathVariable  Map&lt;String, String&gt; pathVars,
1827             @PathVariable(value=&quot;id&quot;) String id,
1828             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1829             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1830             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1831         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1831         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1832     }
1833 
1834     /**
<abbr title="1835      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1835      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1836      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1836      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1837      *
1838      * @param request
1839      * @param response
1840      * @param model
1841      * @param pathVars
1842      * @param id
1843      * @param collectionField
1844      * @param collectionItemId
1845      * @return an object explaining the state of the operation
1846      * @throws Exception
1847      */
<abbr title="1848     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1848     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1849     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1850             HttpServletResponse response, Model model,
1851             @PathVariable  Map&lt;String, String&gt; pathVars,
1852             @PathVariable(value=&quot;id&quot;) String id,
1853             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1854             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1855             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1856             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1857         String sectionKey = getSectionKey(pathVars);
1858         String mainClassName = getClassNameForSection(sectionKey);
1859         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1860         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1860         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1861         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1862         FieldMetadata md = collectionProperty.getMetadata();
1863 
<abbr title="1864         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1864         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1865         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1866 
<abbr title="1867         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1867         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1868 
1869         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1870 
1871         if (md instanceof AdornedTargetCollectionMetadata) {
1872             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1873             AdornedTargetList atl = ppr.getAdornedList();
1874 
1875             // Get an entity form for the entity
<abbr title="1876             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1876             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1877             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1877             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1878                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1878                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1879                     .getDynamicResultSet().getRecords()[0];
1880             formService.populateEntityFormFields(entityForm, entity);
1881             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1882 
<abbr title="1883             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1883             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1884             int sequenceValue = Integer.parseInt(newSequence) + 1;
1885             Field field = entityForm.findField(atl.getSortField());
1886             field.setValue(String.valueOf(sequenceValue));
1887 
1888             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1889             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1889             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1890             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1891 
1892             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1893             responseMap.put(&quot;field&quot;, collectionField);
1894             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1895             return responseMap;
1896         } else if (md instanceof BasicCollectionMetadata) {
1897             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1898             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1899             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1899             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1900 
<abbr title="1901             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1901             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1902             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="1903             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1903             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
1904             if(listGridReadOnly){
1905                         throw new SecurityServiceException();
1906             }
1907             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1908                 Field f = new Field()
1909                         .withName(cd.getSortProperty())
1910                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1911                 entityForm.addHiddenField(mainMetadata, f);
1912             }
1913             formService.populateEntityFormFields(entityForm, entity);
1914 
1915             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1916                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1917                 Field field = entityForm.findField(cd.getSortProperty());
1918                 field.setValue(String.valueOf(sequenceValue));
1919             }
1920 
<abbr title="1921             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1921             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1922             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1923 
1924             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1925             responseMap.put(&quot;field&quot;, collectionField);
1926             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1927             return responseMap;
1928         } else {
<abbr title="1929             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1929             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1930         }
1931     }
1932 
1933     /**
1934      * Removes the requested collection item
1935      *
<abbr title="1936      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1936      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1937      * map collection.
1938      *
1939      * @param request
1940      * @param response
1941      * @param model
1942      * @param pathVars
1943      * @param id
1944      * @param collectionField
1945      * @param collectionItemId
1946      * @return the return view path
1947      * @throws Exception
1948      */
<abbr title="1949     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1949     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1950     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1950     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1951             @PathVariable  Map&lt;String, String&gt; pathVars,
1952             @PathVariable(value=&quot;id&quot;) String id,
1953             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1954             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1955         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1955         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1956     }
1957 
1958     /**
1959      * Removes the requested collection item
1960      *
<abbr title="1961      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1961      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1962      * map collection.
1963      *
1964      * @param request
1965      * @param response
1966      * @param model
1967      * @param pathVars
1968      * @param id
1969      * @param collectionField
1970      * @param collectionItemId
1971      * @return the return view path
1972      * @throws Exception
1973      */
<abbr title="1974     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1974     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1975     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1975     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1976             @PathVariable  Map&lt;String, String&gt; pathVars,
1977             @PathVariable(value=&quot;id&quot;) String id,
1978             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1979             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1980             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1981         String sectionKey = getSectionKey(pathVars);
1982         String mainClassName = getClassNameForSection(sectionKey);
1983         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1984         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1984         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1985         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1986 
1987         String priorKey = request.getParameter(&quot;key&quot;);
1988 
<abbr title="1989         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1989         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1990         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1991         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1991         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1992         service.clearEntityManager();
1993         // First, we must remove the collection entity
<abbr title="1994         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1994         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1995         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1995         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1996             String error = &quot;There was an error removing the whatever&quot;;
1997             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1998                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1999                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1999                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="2000             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">2000             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
2001                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2002             }
2003             return new JsonResponse(response)
2004                 .with(&quot;status&quot;, &quot;error&quot;)
2005                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2006                 .done();
2007         }
2008 
2009         // Next, we must get the new list grid that represents this collection
2010         // We return the new list grid so that it can replace the currently visible one
<abbr title="2011         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2011         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
2012 
2013         model.addAttribute(&quot;listGrid&quot;, listGrid);
2014         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2015         setModelAttributes(model, sectionKey);
2016         return &quot;views/standaloneListGrid&quot;;
2017     }
2018 
2019     public void addAuditableDisplayFields(EntityForm entityForm) {
2020         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2021         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2022             addAuditableDisplayField(entityForm, createdBy);
2023 
2024             createdBy.setIsVisible(false);
2025         }
2026         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2027         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2028             addAuditableDisplayField(entityForm, updatedBy);
2029 
2030             updatedBy.setIsVisible(false);
2031         }
2032     }
2033 
2034     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2035         Field displayField = buildAuditableDisplayField(userField);
2036 
2037         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2038         String userName = user == null ? null : user.getName();
2039         displayField.setValue(userName);
2040 
2041         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2042         if (auditGroup != null) {
2043             auditGroup.addField(displayField);
2044         }
2045     }
2046 
2047     private Field buildAuditableDisplayField(Field auditableField) {
2048         return new Field().withFieldType(SupportedFieldType.STRING.toString())
2049                 .withName(auditableField.getName() + &quot;Display&quot;)
2050                 .withFriendlyName(auditableField.getFriendlyName())
2051                 .withOrder(auditableField.getOrder())
2052                 .withOwningEntityClass(auditableField.getOwningEntityClass())
2053                 .withReadOnly(true);
2054     }
2055 
2056     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2057         String tabName = pathVars.get(&quot;tabName&quot;);
2058         if (StringUtils.isBlank(tabName)) {
2059             TabMetadata firstTab = cmd.getFirstTab();
2060             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2061         }
2062         return tabName;
2063     }
2064 
2065     protected String getCurrentFolderId(HttpServletRequest request) {
2066         if (request.getParameterMap().containsKey(CURRENT_FOLDER_ID)) {
2067             return request.getParameter(CURRENT_FOLDER_ID);
2068         }
2069         return &quot;unassigned&quot;;
2070     }
2071 
2072     // *****************************************
2073     // Typed Entity Helper Methods
2074     // *****************************************
2075 
2076     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2077         // Check if this is a typed entity
2078         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2079         if (typedEntitySection != null) {
2080             // Update the friendly name for this Entity Type
2081             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2082         }
2083     }
2084 
2085     // *********************************
2086     // ADDITIONAL SPRING-BOUND METHODS *
2087     // *********************************
2088 
2089     /**
<abbr title="2090      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2090      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2091      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2091      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2092      * or false. If the value is passed in as null, it will treat it as false.
2093      *
2094      * @param binder
2095      */
2096     @InitBinder
2097     public void initBinder(WebDataBinder binder) {
2098         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2099         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2100     }
2101 
2102 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import com.fasterxml.jackson.databind.ObjectMapper;
  21 import java.io.Serializable;
  22 import java.io.UnsupportedEncodingException;
  23 import java.net.URLDecoder;
  24 import java.util.ArrayList;
  25 import java.util.Arrays;
  26 import java.util.HashMap;
  27 import java.util.List;
  28 import java.util.Map.Entry;
  29 import java.util.Map;
  30 import java.util.Set;
  31 import java.util.stream.Stream;
  32 import javax.annotation.Resource;
  33 import javax.servlet.http.HttpServletRequest;
  34 import javax.servlet.http.HttpServletResponse;
  35 import org.apache.commons.collections.CollectionUtils;
  36 import org.apache.commons.collections.MapUtils;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.apache.commons.logging.Log;
  39 import org.apache.commons.logging.LogFactory;
  40 import org.broadleafcommerce.common.exception.SecurityServiceException;
  41 import org.broadleafcommerce.common.exception.ServiceException;
  42 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  43 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  44 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  45 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  46 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  47 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  48 import org.broadleafcommerce.common.service.GenericEntityService;
  49 import org.broadleafcommerce.common.util.BLCArrayUtils;
  50 import org.broadleafcommerce.common.util.BLCMessageUtils;
  51 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  52 import org.broadleafcommerce.common.web.JsonResponse;
  53 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  54 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  55 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  56 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  57 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  58 import org.broadleafcommerce.openadmin.dto.ClassTree;
  59 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  60 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  61 import org.broadleafcommerce.openadmin.dto.Entity;
  62 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  63 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  64 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  65 import org.broadleafcommerce.openadmin.dto.Property;
  66 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  67 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  68 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  69 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  70 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  71 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  72 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  73 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  74 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  75 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  76 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  76 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  77 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  78 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  79 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  80 import org.broadleafcommerce.openadmin.web.dao.MultipleCatalogExtensionManager;
  81 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  82 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  83 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  84 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  85 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  86 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  87 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  88 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  89 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  90 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  91 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  92 import org.springframework.stereotype.Controller;
  93 import org.springframework.ui.Model;
  94 import org.springframework.util.MultiValueMap;
  95 import org.springframework.validation.BindingResult;
  96 import org.springframework.web.bind.WebDataBinder;
  97 import org.springframework.web.bind.annotation.InitBinder;
  98 import org.springframework.web.bind.annotation.ModelAttribute;
  99 import org.springframework.web.bind.annotation.PathVariable;
 100 import org.springframework.web.bind.annotation.RequestMapping;
 101 import org.springframework.web.bind.annotation.RequestMethod;
 102 import org.springframework.web.bind.annotation.RequestParam;
 103 import org.springframework.web.bind.annotation.ResponseBody;
 104 import org.springframework.web.servlet.DispatcherServlet;
 105 import org.springframework.web.servlet.FlashMap;
 106 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
 107 import org.springframework.web.util.UrlPathHelper;
 108 
 109 
 110 /**
 111  * The default implementation of the {@link AdminAbstractController}. This delegates every call to
 112  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 113  * admin for every entity that is not explicitly customized by its own controller.
 114  *
 115  * @author Andre Azzolini (apazzolini)
 116  * @author Jeff Fischer
 117  */
 118 @Controller(&quot;blAdminBasicEntityController&quot;)
 119 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 120 public class AdminBasicEntityController extends AdminAbstractController {
 121 
 122     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 123 
 124     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 125     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 126     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 127     protected static final String CURRENT_FOLDER_ID = &quot;currentFolderId&quot;;
 128 
 129     @Resource(name=&quot;blSandBoxHelper&quot;)
 130     protected SandBoxHelper sandBoxHelper;
 131 
 132     @Resource(name = &quot;blAdminUserDao&quot;)
 133     protected AdminUserDao adminUserDao;
 134 
 135     @Resource(name=&quot;blDynamicEntityDao&quot;)
 136     protected DynamicEntityDao dynamicEntityDao;
 137 
 138     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 139     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 140 
 141     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 142     protected RowLevelSecurityService rowLevelSecurityService;
 143 
 144     @Resource(name = &quot;blEntityDuplicator&quot;)
 145     protected EntityDuplicator duplicator;
 146 
 147     @Resource(name = &quot;blGenericEntityService&quot;)
 148     protected GenericEntityService genericEntityService;
 149 
 150 
 151 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     @Resource(name = &quot;blMultipleCatalogExtensionManager&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153     protected MultipleCatalogExtensionManager multipleCatalogExtensionManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155 </span>
 156 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 157 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 157 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 158 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160 </span>
 161 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 162     // ******************************************
 163     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 164     // ******************************************
 165 
 166     /**
<abbr title=" 167      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 167      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 168      * criteria.
 169      *
 170      * @param request
 171      * @param response
 172      * @param model
 173      * @param pathVars
 174      * @param requestParams a Map of property name -&gt; list critiera values
 175      * @return the return view path
 176      * @throws Exception
 177      */
 178     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 179     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 180             @PathVariable Map&lt;String, String&gt; pathVars,
 181             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 182         String sectionKey = getSectionKey(pathVars);
 183         String sectionClassName = getClassNameForSection(sectionKey);
 184         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 185         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 185         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 186         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 187         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 188 
 189         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 190         listGrid.setSelectType(ListGrid.SelectType.NONE);
 191 
 192         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 193         if (CollectionUtils.isNotEmpty(headerFields)) {
 194             Field firstField = headerFields.iterator().next();
 195             if (requestParams.containsKey(firstField.getName())) {
 196                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 197             }
 198         }
 199 
 200         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 201 
 202         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 203         model.addAttribute(&quot;listGrid&quot;, listGrid);
 204 
 205         return DEFAULT_CONTAINER_VIEW;
 206     }
 207 
<abbr title=" 208     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 208     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 209             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 210         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 211         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 212         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 213         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 214 
 215         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 216         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 217             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 218         }
 219 
 220         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 221         String requestUri = request.getRequestURI();
 222         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 223             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 223             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 224         }
 225 
 226         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 227         model.addAttribute(&quot;currentUri&quot;, requestUri);
 228         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 229         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 230         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 231         model.addAttribute(&quot;mainActions&quot;, mainActions);
 232         setModelAttributes(model, sectionKey);
 233         setTypedEntityModelAttributes(request, model);
 234     }
 235 
 236     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 237     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 238              HttpServletResponse response, Model model,
 239              @PathVariable Map&lt;String, String&gt; pathVars,
 240              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 241         String sectionKey = getSectionKey(pathVars);
 242         String sectionClassName = getClassNameForSection(sectionKey);
 243         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 244         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 244         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 245                 .withCustomCriteria(getCustomCriteria(requestParams));
 246 
 247         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 248 
 249         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 250         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 251 
 252         return formService.constructSelectizeOptionMap(drs, cmd);
 253     }
 254 
 255     /**
 256      * Obtains the requested criteria parameter
 257      *
 258      * @param requestParams
 259      * @return
 260      */
 261     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 262         if (requestParams == null || requestParams.isEmpty()) {
 263             return null;
 264         }
 265 
 266         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 267         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 268         return new String[] {response};
 269     }
 270 
 271     /**
<abbr title=" 272      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 272      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 273      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 274      *
 275      * @param sectionClassName
 276      * @param cmd
 277      * @param mainActions
 278      */
<abbr title=" 279     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 279     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 280         if (isAddActionAllowed(sectionClassName, cmd)) {
 281             mainActions.add(DefaultMainActions.ADD);
 282         }
 283     }
 284 
 285     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 286         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 287         try {
 288             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 289         } catch (ServiceException e) {
 290             if (e instanceof SecurityServiceException) {
 291                 return false;
 292             }
 293         }
 294 
 295         final boolean canAdd = rowLevelSecurityService
 296                 .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);
 297         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 298     }
 299 
 300     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 301         //check if all the metadata is read only
 302         for (Property property : cmd.getProperties()) {
 303             if (property.getMetadata() instanceof BasicFieldMetadata) {
 304                 if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 305                         !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 306                     return true;
 307                 }
 308             }
 309         }
 310 
 311         return false;
 312     }
 313 
 314     /**
<abbr title=" 315      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 315      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 316      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 316      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 317      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 317      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 318      * they can then perform operations on sub collections.
 319      *
 320      * @param request
 321      * @param response
 322      * @param model
 323      * @param pathVars
 324      * @param entityType
 325      * @return the return view path
 326      * @throws Exception
 327      */
 328     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 329     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 329     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 330             @PathVariable  Map&lt;String, String&gt; pathVars,
 331             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 332         String sectionKey = getSectionKey(pathVars);
 333         String sectionClassName = getClassNameForSection(sectionKey);
 334         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 335         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 335         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 336         ppr.setAddOperationInspect(true);
 337         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 338 
 339         entityType = determineEntityType(entityType, cmd);
 340 
 341         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 342 
<abbr title=" 343         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 343         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 344         // is set to the type we&#x27;re going to be creating.
 345         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 346         entityForm.setEntityType(entityType);
 347 
<abbr title=" 348         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 348         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 349         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 349         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 350         // fields that are not applicable for this given entity type.
 351         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 352 
 353         modifyAddEntityForm(entityForm, pathVars);
 354 
 355         model.addAttribute(&quot;entityForm&quot;, entityForm);
 356         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 357 
 358         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 359         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 360         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 361         setModelAttributes(model, sectionKey);
 362         return MODAL_CONTAINER_VIEW;
 363     }
 364 
 365     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic
 366     // types for this entity.
 367     protected String determineEntityType(String entityType, final ClassMetadata cmd)
 368             throws UnsupportedEncodingException {
 369         if (StringUtils.isBlank(entityType)) {
 370             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 371                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 372             } else {
 373                 entityType = getDefaultEntityType();
 374             }
 375         } else {
 376             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 377         }
 378         return entityType;
 379     }
 380 
 381     /**
<abbr title=" 382      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 382      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 383      *
 384      * @param request
 385      * @param response
 386      * @param model
 387      * @param pathVars
 388      * @param entityForm
 389      * @param result
 390      * @return the return view path
 391      * @throws Exception
 392      */
 393     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 394     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 395             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 396             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 396             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 397         String sectionKey = getSectionKey(pathVars);
 398         String sectionClassName = getClassNameForSection(sectionKey);
 399         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 400         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 400         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 401 
 402         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 403         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 403         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 404         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 405         entityFormValidator.validate(entityForm, entity, result);
 406 
 407         if (result.hasErrors()) {
 408             entityForm.clearFieldsMap();
 409             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 410 
 411             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 412 
 413             modifyAddEntityForm(entityForm, pathVars);
 414 
 415             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 416             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 417             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 418             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 419             setModelAttributes(model, sectionKey);
 420             return MODAL_CONTAINER_VIEW;
 421         }
 422 
 423         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 424         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 424         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 425     }
 426 
 427     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
 428     public String duplicateEntity(final HttpServletRequest request,
 429             final HttpServletResponse response,
 430             final Model model,
 431             @PathVariable final Map&lt;String, String&gt; pathVars,
 432             @PathVariable(value = &quot;id&quot;) final String id,
 433             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,
 434             final BindingResult result) throws Exception {
 435         final String sectionKey = getSectionKey(pathVars);
 436         final String sectionClassName = getClassNameForSection(sectionKey);
 437         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);
 438         final long identifier = Long.parseLong(id);
 439 
 440         if (duplicator.validate(entityClass, identifier)) {
 441             final Object duplicate;
 442 
 443             try {
 444                 duplicate = duplicator.copy(entityClass, identifier);
 445             } catch (Exception e) {
 446                 LOG.error(&quot;Could not duplicate entity&quot;, e);
 447                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);
 448             }
 449 
 450             final Serializable dupId = genericEntityService.getIdentifier(duplicate);
 451 
 452             // Note that AJAX Redirects need the context path prepended to them
 453             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;
 454         } else {
 455             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);
 456         }
 457     }
 458 
 459     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {
 460         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();
 461         String message;
 462         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 463         if (context != null &amp;&amp; context.getMessageSource() != null) {
 464             message = context.getMessageSource()
 465                     .getMessage(code, null, code, context.getJavaLocale());
 466         } else {
 467             LOG.warn(
 468                     &quot;Could not find the MessageSource on the current request, &quot;
 469                             + &quot;not translating the message key&quot;);
 470             message = &quot;Duplication_Failure&quot;;
 471         }
 472 
 473         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 474         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 475         errorMap.put(&quot;code&quot;, code);
 476         errorMap.put(&quot;message&quot;, message);
 477         errors.add(errorMap);
 478         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 479     }
 480 
 481     /**
 482      * Renders the main entity form for the specified entity
 483      *
 484      * @param request
 485      * @param response
 486      * @param model
 487      * @param pathVars
 488      * @param id
 489      * @return the return view path
 490      * @throws Exception
 491      */
 492     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 493     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 494             @PathVariable  Map&lt;String, String&gt; pathVars,
 495             @PathVariable(&quot;id&quot;) String id) throws Exception {
 496         String sectionKey = getSectionKey(pathVars);
 497         String sectionClassName = getClassNameForSection(sectionKey);
 498         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 499         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 499         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 500 
 501         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 502         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 503 
 504         multipleCatalogExtensionManager.getProxy().setCurrentCatalog(entity, model);
 505 
<abbr title=" 506         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 506         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 507 
 508         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 509 
 510         modifyEntityForm(entity, entityForm, pathVars);
 511 
 512         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 513             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 514         }
 515 
 516         // Set the sectionKey again incase this is a typed entity
 517         entityForm.setSectionKey(sectionKey);
 518 
 519         // Build the current url in the cast that this is a typed entity
 520         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 521         int startIndex = request.getContextPath().length();
 522 
 523         // Remove the context path from servlet path
 524         String currentUrl = originatingUri.substring(startIndex);
 525 
 526         model.addAttribute(&quot;entity&quot;, entity);
 527         model.addAttribute(&quot;entityForm&quot;, entityForm);
 528         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 529         model.addAttribute(CURRENT_FOLDER_ID, getCurrentFolderId(request));
 530 
 531         setModelAttributes(model, sectionKey);
 532 
 533         // We want to replace author ids with their names
 534         addAuditableDisplayFields(entityForm);
 535 
 536         return resolveAppropriateEntityView(request, model, entityForm);
 537     }
 538 
<abbr title=" 539     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 539     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 540                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 541                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 541                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 542         String tabName = pathVars.get(&quot;tabName&quot;);
 543         if (StringUtils.isEmpty(tabName)) {
 544             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 545         }
 546         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 547     }
 548 
 549     private boolean isAddRequest(Entity entity) {
 550         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 551         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 551         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 552         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 553             return false;
 554         }
 555 
 556         return resultHolder.getResult();
 557     }
 558 
 559     /**
 560      * Attempts to get the List Grid for the selected tab.
 561      *
 562      * @param request
 563      * @param response
 564      * @param model
 565      * @param pathVars
 566      * @param id
 567      * @param tabName
 568      * @param entityForm
 569      * @param entity
 570      * @return the return view path
 571      * @throws Exception
 572      */
 573     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 574     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 575             @PathVariable Map&lt;String, String&gt; pathVars,
 576             @PathVariable(value = &quot;id&quot;) String id,
 577             @PathVariable(value = &quot;tabName&quot;) String tabName,
 578             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 579             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 580         String sectionKey = getSectionKey(pathVars);
 581         String sectionClassName = getClassNameForSection(sectionKey);
 582         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 583         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 583         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 584         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 585         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 586         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 586         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 587         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 588 
 589         modifyEntityForm(entity, entityForm, pathVars);
 590 
 591         model.addAttribute(&quot;entity&quot;, entity);
 592         model.addAttribute(&quot;entityForm&quot;, entityForm);
 593         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 594 
 595         setModelAttributes(model, sectionKey);
 596 
 597         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 598         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 599 
 600         return DEFAULT_CONTAINER_VIEW;
 601     }
 602 
 603     /**
 604      * Builds JSON that looks like this:
 605      *
 606      * {&quot;errors&quot;:
 607      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 608      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 609      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 610      *        &quot;errorType&quot;, &quot;field&quot;,
 611      *        &quot;tab&quot;: &quot;General&quot;
 612      *        },
 613      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 614      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 615      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 616      *        &quot;errorType&quot;, &quot;field&quot;,
 617      *        &quot;tab&quot;: &quot;General&quot;
 618      *        }]
 619      * }
 620      *
 621      */
 622     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 623     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 624             @PathVariable Map&lt;String, String&gt; pathVars,
 625             @PathVariable(value = &quot;id&quot;) String id,
 626             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 627             RedirectAttributes ra) throws Exception {
 628 
 629         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 630 
 631         JsonResponse json = new JsonResponse(response);
 632         if (result.hasErrors()) {
 633             populateJsonValidationErrors(entityForm, result, json);
 634         }
 635         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 636         if (CollectionUtils.isNotEmpty(dirtyList)) {
 637             json.with(&quot;dirty&quot;, dirtyList);
 638         }
 639 
 640         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 641         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 641         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 642         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 643             return resultHolder.getResult();
 644         }
 645 
 646         return json.done();
 647     }
 648 
<abbr title=" 649     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 649     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 650         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 651         String sectionKey = getSectionKey(pathVars);
 652         String sectionClassName = getClassNameForSection(sectionKey);
 653         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 654         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 654         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 655         ClassMetadata cmd = null;
 656         Entity entity = null;
 657         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 658         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 659 
 660         for (Property p: entity.getProperties()) {
 661             if (p.getIsDirty()) {
 662                 dirtyList.add(p.getName());
 663             }
 664         }
 665         return dirtyList;
 666     }
 667 
 668     /**
<abbr title=" 669      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 669      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 670      * error fields highlighted. On a successful save, it will refresh the entity page.
 671      *
 672      * @param request
 673      * @param response
 674      * @param model
 675      * @param pathVars
 676      * @param id
 677      * @param entityForm
 678      * @param result
 679      * @return the return view path
 680      * @throws Exception
 681      */
 682     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 683     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 684             @PathVariable  Map&lt;String, String&gt; pathVars,
 685             @PathVariable(value=&quot;id&quot;) String id,
 686             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 687             RedirectAttributes ra) throws Exception {
 688         String sectionKey = getSectionKey(pathVars);
 689         String sectionClassName = getClassNameForSection(sectionKey);
 690         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 691         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 691         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 692         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 693 
 694         extractDynamicFormFields(cmd, entityForm);
 695 
<abbr title=" 696         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 696         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 697         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 698 
 699         entityFormValidator.validate(entityForm, entity, result);
 700 
 701         if (result.hasErrors()) {
 702             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 703             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 704 
<abbr title=" 705             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 705             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 706             entityForm.clearFieldsMap();
 707             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 708 
 709             modifyEntityForm(entity, entityForm, pathVars);
 710 
 711             model.addAttribute(&quot;entity&quot;, entity);
 712             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 713 
 714             setModelAttributes(model, sectionKey);
 715 
 716             return resolveAppropriateEntityView(request, model, entityForm);
 717         }
 718 
 719         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 720 
 721         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 722     }
 723 
 724     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,
 725             final Map&lt;String, String&gt; pathVars) throws Exception {
 726         if (isAddRequest(entity)) {
 727             modifyAddEntityForm(entityForm, pathVars);
 728         } else {
 729             modifyEntityForm(entityForm, pathVars);
 730         }
 731     }
 732 
 733     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 734             final Model model,
 735             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 736         if (isAjaxRequest(request)) {
 737             entityForm.setReadOnly();
 738             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 739             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 740             return MODAL_CONTAINER_VIEW;
 741         } else {
 742             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 743             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 744             return DEFAULT_CONTAINER_VIEW;
 745         }
 746     }
 747 
 748     /**
 749      * Attempts to remove the given entity.
 750      *
 751      * @param request
 752      * @param response
 753      * @param model
 754      * @param pathVars
 755      * @param id
 756      * @return the return view path
 757      * @throws Exception
 758      */
 759     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 760     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 761             @PathVariable  Map&lt;String, String&gt; pathVars,
 762             @PathVariable(value=&quot;id&quot;) String id,
 763             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 764             RedirectAttributes ra) throws Exception {
 765         String sectionKey = getSectionKey(pathVars);
 766         String sectionClassName = getClassNameForSection(sectionKey);
 767         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 768 
<abbr title=" 769         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 769         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 770         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 771         // Removal does not normally return an Entity unless there is some validation error
 772         if (entity != null) {
 773             entityFormValidator.validate(entityForm, entity, result);
 774             if (result.hasErrors()) {
 775                 // Create a flash attribute for the unsuccessful delete
 776                 FlashMap fm = new FlashMap();
 777                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 778                 fm.put(&quot;headerFlashAlert&quot;, true);
 779                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 780 
 781                 // Re-look back up the entity so that we can return something populated
<abbr title=" 782                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 782                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 783                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 783                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 784                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 785                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 785                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 786                 entityForm.clearFieldsMap();
 787                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 788                 modifyEntityForm(entityForm, pathVars);
 789 
 790                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 791                         .done();
 792             }
 793         }
 794 
 795         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 796         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 797 
 798         if (isAjaxRequest(request)) {
 799             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 800             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 800             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 801         } else {
 802             return &quot;redirect:/&quot; + sectionKey;
 803         }
 804     }
 805 
 806     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 807     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 807     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 808             @PathVariable  Map&lt;String, String&gt; pathVars,
 809             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 810             @RequestParam String ids,
 811             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 812         String sectionKey = getSectionKey(pathVars);
 813         String sectionClassName = getClassNameForSection(sectionKey);
 814         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 815         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 815         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 816         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 816         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 817         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 818         FieldMetadata md = collectionProperty.getMetadata();
 819 
 820         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 821         ppr.setStartIndex(getStartIndex(requestParams));
 822         ppr.setMaxIndex(getMaxIndex(requestParams));
 823 
 824         if (md instanceof BasicFieldMetadata) {
 825             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 826             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 827 
 828             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 829             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 830 
 831             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 832             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 833 
 834             for (Entity e : drs.getRecords()) {
 835                 String id = e.getPMap().get(idProp).getValue();
 836                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 837 
 838                 if (StringUtils.isBlank(disp)) {
 839                     disp = e.getPMap().get(displayProp).getValue();
 840                 }
 841 
 842                 returnMap.put(id,  disp);
 843             }
 844 
 845             return returnMap;
 846         }
 847 
 848         return null;
 849     }
 850 
 851     /**
<abbr title=" 852      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 852      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 853      * then this method is invoked when a user clicks on the name of the default category field.
 854      *
 855      * @param request
 856      * @param response
 857      * @param model
 858      * @param pathVars
 859      * @param collectionField
 860      * @param id
 861      * @return
 862      * @throws Exception
 863      */
 864     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 865     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 865     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 866             @PathVariable  Map&lt;String, String&gt; pathVars,
 867             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 868             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 869         String sectionKey = getSectionKey(pathVars);
 870         String mainClassName = getClassNameForSection(sectionKey);
 871         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 872         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 872         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 873         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 874         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 875 
<abbr title=" 876         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 876         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 877         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 877         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 878         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 879         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 880         return viewEntityForm(request, response, model, varsForField, id);
 881     }
 882 
 883     @RequestMapping(
 884             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 885             method = RequestMethod.POST
 886     )
<abbr title=" 887     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 887     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 888                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 889                                         @PathVariable(value=&quot;id&quot;) String id,
 890                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 891                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 892                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 893                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 893                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 894 
<abbr title=" 895         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 895         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 896     }
 897 
 898 
 899     @RequestMapping(
 900             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 901             method = RequestMethod.POST
 902     )
<abbr title=" 903     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 903     public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response,ðŸ”µ</abbr>
 904                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 905                                         @PathVariable(value=&quot;id&quot;) String id,
 906                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 907                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 908                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 909                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 909                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 910 
<abbr title=" 911         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 911         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 912     }
 913 
 914 
 915     /**
 916      * Returns the records for a given collectionField filtered by a particular criteria
 917      *
 918      * @param request
 919      * @param response
 920      * @param model
 921      * @param pathVars
 922      * @param collectionField
 923      * @param requestParams
 924      * @return the return view path
 925      * @throws Exception
 926      */
 927     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 928     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 928     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 929             @PathVariable  Map&lt;String, String&gt; pathVars,
 930             @PathVariable(value=&quot;id&quot;) String id,
 931             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 932             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 933         String sectionKey = getSectionKey(pathVars);
 934         String mainClassName = getClassNameForSection(sectionKey);
 935         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 936         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 936         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 937         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 937         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 938         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 939 
 940         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 941         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 941         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 942 
 943         // Next, we must get the new list grid that represents this collection
<abbr title=" 944         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 944         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 945         model.addAttribute(&quot;listGrid&quot;, listGrid);
 946 
 947         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 948 
 949         // We return the new list grid so that it can replace the currently visible one
 950         setModelAttributes(model, sectionKey);
 951         return &quot;views/standaloneListGrid&quot;;
 952     }
 953 
 954     /**
<abbr title=" 955      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 955      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 956      * of this call depending on the type of the specified collection field.
 957      *
 958      * &lt;ul&gt;
 959      *  &lt;li&gt;
<abbr title=" 960      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 960      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 961      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 961      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 962      *  &lt;/li&gt;
 963      *  &lt;li&gt;
<abbr title=" 964      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 964      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 965      *    Used by fields such as &quot;allParentCategories&quot;.
 966      *  &lt;/li&gt;
 967      *  &lt;li&gt;
<abbr title=" 968      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 968      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 969      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 969      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 970      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 970      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 971      *  &lt;/li&gt;
 972      *  &lt;li&gt;
<abbr title=" 973      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 973      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 974      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 974      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 975      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 975      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 976      *    to linking an entity, provide extra fields, such as a promotional message.
 977      *  &lt;/li&gt;
 978      *  &lt;li&gt;
<abbr title=" 979      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 979      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 980      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 980      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 981      *    entity. Used by fields such as the mediaMap on a Sku.
 982      *  &lt;/li&gt;
 983      *
 984      * @param request
 985      * @param response
 986      * @param model
 987      * @param pathVars
 988      * @param id
 989      * @param collectionField
 990      * @param requestParams
 991      * @return the return view path
 992      * @throws Exception
 993      */
 994     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 995     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 995     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 996             @PathVariable Map&lt;String, String&gt; pathVars,
 997             @PathVariable(value = &quot;id&quot;) String id,
 998             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 999             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1000         String sectionKey = getSectionKey(pathVars);
1001         String mainClassName = getClassNameForSection(sectionKey);
1002         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1003         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1004                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1005         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1006         FieldMetadata md = collectionProperty.getMetadata();
1007 
1008         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1009                 .withFilterAndSortCriteria(getCriteria(requestParams))
1010                 .withStartIndex(getStartIndex(requestParams))
1011                 .withMaxIndex(getMaxIndex(requestParams))
1012                 .withLastId(getLastId(requestParams))
1013                 .withFirstId(getFirstId(requestParams))
1014                 .withUpperCount(getUpperCount(requestParams))
1015                 .withLowerCount(getLowerCount(requestParams))
1016                 .withPageSize(getPageSize(requestParams))
1017                 .withPresentationFetch(true);
1018 
1019         if (md instanceof BasicCollectionMetadata) {
1020             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1021             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1022                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1022                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title="1023                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types">1023                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
1024                 // for this entity.
1025                 String entityType = null;
1026 
1027                 if (requestParams.containsKey(&quot;entityType&quot;)) {
1028                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
1029                 }
1030 
1031                 entityType = determineEntityType(entityType, cmd);
1032 
1033                 if (StringUtils.isBlank(entityType)) {
1034                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
1035                 }
1036 
1037                 ppr = ppr.withCeilingEntityClassname(entityType);
1038             }
1039         } else if (md instanceof MapMetadata) {
<abbr title="1040             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1040             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
1041             if (result.equals(ExtensionResultStatusType.HANDLED)) {
1042                 model.addAttribute(&quot;entityId&quot;, id);
1043                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1044                 model.addAttribute(&quot;collectionField&quot;, collectionField);
1045                 return MODAL_CONTAINER_VIEW;
1046             }
1047         }
1048 
1049         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1050 
<abbr title="1051         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1051         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
1052     }
1053 
1054     protected String getModalForBlankEntityType(final HttpServletRequest request,
1055             final Model model, final String sectionKey, final ClassMetadata cmd) {
1056         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1057         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1058         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1059         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1060 
1061         String requestUri = request.getRequestURI();
1062         final String contextPath = request.getContextPath();
1063 
1064         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1065             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1066         }
1067 
1068         model.addAttribute(&quot;currentUri&quot;, requestUri);
1069         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1070         setModelAttributes(model, sectionKey);
1071 
1072         return MODAL_CONTAINER_VIEW;
1073     }
1074 
<abbr title="1075     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1075     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title="1076     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1076     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1077             @PathVariable Map&lt;String, String&gt; pathVars,
1078             @PathVariable(value=&quot;id&quot;) String id,
1079             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1080             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1081         String sectionKey = getSectionKey(pathVars);
1082         String mainClassName = getClassNameForSection(sectionKey);
1083         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1084         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1084         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1085         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1086         FieldMetadata md = collectionProperty.getMetadata();
1087         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1088         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1089             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1089             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1090                     collectionField,
1091                     collectionItemId, responseMap);
1092         }
1093         return responseMap;
1094     }
1095 
1096     protected String getModalForBlankEntityType(final HttpServletRequest request,
<abbr title="1097                                                 final Model model, final String sectionKey, final ClassMetadata cmd) {">1097                                                 final Model model, final String sectionKey, final ClassMeðŸ”µ</abbr>
1098         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1099         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1100         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1101         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1102 
1103         String requestUri = request.getRequestURI();
1104         final String contextPath = request.getContextPath();
1105 
1106         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1107             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1108         }
1109 
1110         model.addAttribute(&quot;currentUri&quot;, requestUri);
1111         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1112         setModelAttributes(model, sectionKey);
1113 
1114         return MODAL_CONTAINER_VIEW;
1115     }
1116 
1117     /**
1118      *
1119      * @param request
1120      * @param response
1121      * @param model
1122      * @param pathVars
1123      * @param id
1124      * @param collectionField
1125      * @param requestParams
1126      * @return Json collection data
1127      * @throws Exception
1128      */
1129     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1130     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1130     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1131             @PathVariable Map&lt;String, String&gt; pathVars,
1132             @PathVariable(value = &quot;id&quot;) String id,
1133             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1134             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1135         String sectionKey = getSectionKey(pathVars);
1136         String mainClassName = getClassNameForSection(sectionKey);
1137         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1138         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1138         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1139                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1140         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1141         FieldMetadata md = collectionProperty.getMetadata();
1142 
1143         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1144                 .withFilterAndSortCriteria(getCriteria(requestParams))
1145                 .withStartIndex(getStartIndex(requestParams))
1146                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1147         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1147         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1148                 .toArray(String[]::new);
1149         ppr = ppr.withCustomCriteria( both);
1150 
1151         if (md instanceof AdornedTargetCollectionMetadata) {
1152             ppr.setOperationTypesOverride(null);
1153             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1154             ppr.setSectionEntityField(collectionField);
1155         }
1156 
1157         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1158 
<abbr title="1159         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1159         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1160     }
1161 
1162     protected String[] buildSelectizeCustomCriteria() {
1163         return new String[]{ IS_SELECTIZE_REQUEST };
1164     }
1165 
1166     /**
1167      * Adds the requested collection item via Selectize
1168      *
1169      * @param request
1170      * @param response
1171      * @param model
1172      * @param pathVars
1173      * @param id
1174      * @param collectionField
1175      * @param entityForm
1176      * @return the return view path
1177      * @throws Exception
1178      */
1179     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1180     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1180     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1181             @PathVariable Map&lt;String, String&gt; pathVars,
1182             @PathVariable(value=&quot;id&quot;) String id,
1183             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1184             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1184             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1185         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1186         String sectionKey = getSectionKey(pathVars);
1187         String mainClassName = getClassNameForSection(sectionKey);
1188         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1189         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1189         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1190         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1191 
1192         if (StringUtils.isBlank(entityForm.getEntityType())) {
1193             FieldMetadata fmd = collectionProperty.getMetadata();
1194             if (fmd instanceof BasicCollectionMetadata) {
1195                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1196             }
1197         }
1198 
<abbr title="1199         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1199         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1200         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1201         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1202         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1202         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1203 
1204         // First, we must save the collection entity
<abbr title="1205         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1205         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1206         Entity savedEntity = persistenceResponse.getEntity();
1207         entityFormValidator.validate(entityForm, savedEntity, result);
1208 
1209         if (result.hasErrors()) {
1210             returnVal.put(&quot;error&quot;, result.getFieldError());
1211             return returnVal;
1212         }
1213 
1214         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1215             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1216         }
1217         return returnVal;
1218     }
1219 
1220     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1221         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1221         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1222         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1223     }
1224 
1225     /**
1226      * Adds the requested collection item
1227      *
1228      * @param request
1229      * @param response
1230      * @param model
1231      * @param pathVars
1232      * @param id
1233      * @param collectionField
1234      * @param entityForm
1235      * @return the return view path
1236      * @throws Exception
1237      */
1238     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1239     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1239     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1240             @PathVariable Map&lt;String, String&gt; pathVars,
1241             @PathVariable(value=&quot;id&quot;) String id,
1242             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1243             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1243             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1244         String sectionKey = getSectionKey(pathVars);
1245         String mainClassName = getClassNameForSection(sectionKey);
1246         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1247         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1247         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1248         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1249 
1250         if (StringUtils.isBlank(entityForm.getEntityType())) {
1251             FieldMetadata fmd = collectionProperty.getMetadata();
1252             if (fmd instanceof BasicCollectionMetadata) {
1253                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1254             }
1255         }
1256 
<abbr title="1257         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1257         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1258         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1259         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1259         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1260         service.clearEntityManager();
1261 
1262         // First, we must save the collection entity
<abbr title="1263         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1263         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1264         Entity savedEntity = persistenceResponse.getEntity();
1265         entityFormValidator.validate(entityForm, savedEntity, result);
1266 
1267         if (result.hasErrors()) {
1268             FieldMetadata md = collectionProperty.getMetadata();
1269             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1270             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1270             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1271                     md, ppr, entityForm, savedEntity);
1272         }
1273 
1274         // Next, we must get the new list grid that represents this collection
<abbr title="1275         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1275         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1276         model.addAttribute(&quot;listGrid&quot;, listGrid);
1277 
1278         // We return the new list grid so that it can replace the currently visible one
1279         model.addAttribute(&quot;actualEntityId&quot;, id);
1280         setModelAttributes(model, sectionKey);
1281         return &quot;views/standaloneListGrid&quot;;
1282     }
1283 
1284     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1285     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1285     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1286             @PathVariable Map&lt;String, String&gt; pathVars,
1287             @PathVariable(value=&quot;id&quot;) String id,
1288             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1289             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1289             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1290         String sectionKey = getSectionKey(pathVars);
1291         String mainClassName = getClassNameForSection(sectionKey);
1292         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1293         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1293         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1294         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1295 
1296         if (StringUtils.isBlank(entityForm.getEntityType())) {
1297             FieldMetadata fmd = collectionProperty.getMetadata();
1298             if (fmd instanceof BasicCollectionMetadata) {
1299                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1300             }
1301         }
1302 
<abbr title="1303         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1303         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1304         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1304         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1305         entity.setIsPreAdd(true);
1306         // First, we must save the collection entity
<abbr title="1307         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1307         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1308         Entity savedEntity = persistenceResponse.getEntity();
1309 
1310         return new JsonResponse(response)
1311                 .with(&quot;status&quot;, &quot;complete&quot;)
1312                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1313                 .done();
1314     }
1315 
1316     /**
<abbr title="1317      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1317      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1318      * as well as after a POST with validation errors
1319      *
1320      * @param request
1321      * @param model
1322      * @param id
1323      * @param collectionField
1324      * @param sectionKey
1325      * @param collectionProperty
1326      * @param md
1327      * @param ppr
1328      * @return the appropriate view to display for the modal
<abbr title="1329      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1329      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1330      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1330      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1331      * @throws ServiceException
1332      */
<abbr title="1333     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1333     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1334             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1334             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1335             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1335             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1336 
<abbr title="1337         // For requests to add a new collection item include the main class that the subsequent request comes from.">1337         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1338         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1338         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1339         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1339         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1340         // fixes all cases.
1341         String mainClassName = getClassNameForSection(sectionKey);
1342         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1343         ppr.setAddOperationInspect(true);
1344 
1345         if (entityForm != null) {
1346             entityForm.clearFieldsMap();
1347         }
1348         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1349         if (md instanceof BasicCollectionMetadata) {
1350             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1351 
<abbr title="1352             // When adding items to basic collections, we will sometimes show a form to persist a new record">1352             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1353             // and sometimes show a list grid to allow the user to associate an existing record.
1354             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1355                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1355                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1356                 if (entityForm == null) {
1357                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1358                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1359                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1360                 } else {
1361                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1362                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1363                 }
<abbr title="1364                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1364                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1365                 entityForm.getTabs().iterator().next().getIsVisible();
1366 
1367                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1368                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1369             } else {
1370                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1371                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1371                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1372                 listGrid.setPathOverride(request.getRequestURL().toString());
1373 
<abbr title="1374                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1374                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1375                     listGrid.removeAllRowActions();
1376                 }
1377 
1378                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1379                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1380             }
1381         } else if (md instanceof AdornedTargetCollectionMetadata) {
1382             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1383 
<abbr title="1384             // Even though this field represents an adorned target collection, the list we want to show in the modal">1384             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1385             // is the standard list grid for the target entity of this field
1386             ppr.setOperationTypesOverride(null);
1387             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1388             ppr.setSectionEntityField(collectionField);
1389 
<abbr title="1390             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1390             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1391 
1392             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1393             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1393             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1394             listGrid.setSubCollectionFieldName(collectionField);
1395             listGrid.setPathOverride(request.getRequestURL().toString());
1396             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1397             if (entityForm == null) {
<abbr title="1398                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1398                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1399                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1399                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1400             } else {
<abbr title="1401                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1401                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1402                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1403             }
1404 
1405             listGrid.setListGridType(ListGrid.Type.ADORNED);
1406             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1407                 if (entry.getValue().getIsVisible()) {
1408                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1409                     break;
1410                 }
1411             }
1412 
1413             // This is part of an add, so we want to be able to filter/sort the listgrid
1414             listGrid.setIsSortable(false);
1415             listGrid.setCanFilterAndSort(true);
1416             listGrid.removeAllRowActions();
1417 
1418             model.addAttribute(&quot;listGrid&quot;, listGrid);
1419             model.addAttribute(&quot;entityForm&quot;, entityForm);
1420             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1421         } else if (md instanceof MapMetadata) {
1422             MapMetadata fmd = (MapMetadata) md;
<abbr title="1423             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1423             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1424 
1425             if (entityForm == null) {
<abbr title="1426                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1426                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1427             } else {
1428                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1429                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1430             }
1431             model.addAttribute(&quot;entityForm&quot;, entityForm);
1432             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1433         }
1434 
1435         // Set the parent id on the entity form
1436         if (entityForm != null) {
1437             entityForm.setParentId(id);
1438         }
1439 
1440         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1441         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1442         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1443         setModelAttributes(model, sectionKey);
1444         return MODAL_CONTAINER_VIEW;
1445     }
1446 
1447     /**
1448      * Shows the appropriate modal dialog to edit the selected collection item
1449      *
1450      * @param request
1451      * @param response
1452      * @param model
1453      * @param pathVars
1454      * @param id
1455      * @param collectionField
1456      * @param collectionItemId
1457      * @return the return view path
1458      * @throws Exception
1459      */
<abbr title="1460     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1460     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1461     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1461     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1462             @PathVariable  Map&lt;String, String&gt; pathVars,
1463             @PathVariable(value=&quot;id&quot;) String id,
1464             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1465             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1466             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1467         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1467         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1468                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1469     }
1470 
1471     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1472     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1472     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1473             @PathVariable  Map&lt;String, String&gt; pathVars,
1474             @PathVariable(value=&quot;id&quot;) String id,
1475             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1476             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1477         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1477         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1478                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1479     }
1480 
1481     /**
<abbr title="1482      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1482      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1483      *
1484      * @param request
1485      * @param response
1486      * @param model
1487      * @param pathVars
1488      * @param id
1489      * @param collectionField
1490      * @param collectionItemId
1491      * @return the return view path
1492      * @throws Exception
1493      */
<abbr title="1494     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1494     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1495     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1495     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1496             @PathVariable  Map&lt;String, String&gt; pathVars,
1497             @PathVariable(value=&quot;id&quot;) String id,
1498             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1499             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1500             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1501         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1501         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1502                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1503 
1504         // Since this is a read-only view, actions don&#x27;t make sense in this context
1505         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1506         addAuditableDisplayFields(ef);
1507         ef.removeAllActions();
1508         ef.setReadOnly();
1509 
1510         return returnPath;
1511     }
1512 
<abbr title="1513     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1513     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1514     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1514     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1515             @PathVariable  Map&lt;String, String&gt; pathVars,
1516             @PathVariable(value=&quot;id&quot;) String id,
1517             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1518             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1519         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1519         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1520                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1521 
1522         // Since this is a read-only view, actions don&#x27;t make sense in this context
1523         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1524         ef.removeAllActions();
1525         ef.setReadOnly();
1526 
1527         return returnPath;
1528     }
1529 
<abbr title="1530     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1530     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1531             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1531             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1532         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1532         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1533     }
1534 
<abbr title="1535     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1535     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1536             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1536             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1537         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1537         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1538     }
1539 
<abbr title="1540     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1540     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1541                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1541                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1542         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1542         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1543     }
1544 
1545     /**
<abbr title="1546      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1546      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1547      * which are optional. If they are not passed in then they are automatically looked up
1548      *
1549      * @param request
1550      * @param model
1551      * @param pathVars
1552      * @param id
1553      * @param collectionField
1554      * @param collectionItemId
1555      * @param modalHeaderType
1556      * @param entityForm
1557      * @param entity
1558      * @return
1559      * @throws ServiceException
1560      */
1561     protected String showViewUpdateCollection(HttpServletRequest request,
1562             Model model,
1563             Map&lt;String, String&gt; pathVars,
1564             String id,
1565             String collectionField,
1566             String collectionItemId,
1567             String alternateId,
1568             String modalHeaderType,
1569             EntityForm entityForm,
1570             Entity entity) throws ServiceException {
1571         String sectionKey = getSectionKey(pathVars);
1572         String mainClassName = getClassNameForSection(sectionKey);
1573         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1574         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1574         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1575         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1576         FieldMetadata md = collectionProperty.getMetadata();
1577         SectionCrumb nextCrumb = new SectionCrumb();
1578         if (md instanceof MapMetadata) {
1579             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1580         } else {
1581             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1582         }
1583         nextCrumb.setSectionId(collectionItemId);
1584         if (!sectionCrumbs.contains(nextCrumb)) {
1585             sectionCrumbs.add(nextCrumb);
1586         }
1587 
<abbr title="1588         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1588         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1589         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1589         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1590 
1591         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1592 
1593         if (md instanceof BasicCollectionMetadata &amp;&amp;
1594                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1595                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1595                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1596             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1597 
<abbr title="1598             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1598             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1599             if (entity == null) {
<abbr title="1600                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1600                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1601             }
1602 
1603             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1604             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1604             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1605 
1606             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,
1607                     subRecordsMap, sectionCrumbs);
1608 
1609             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1610             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1611 
1612             addAuditableDisplayFields(entityForm);
1613             model.addAttribute(&quot;entityForm&quot;, entityForm);
1614             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1615         } else if (md instanceof AdornedTargetCollectionMetadata) {
1616             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1617 
1618             if (entity == null) {
<abbr title="1619                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1619                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1620                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1621             }
1622 
1623             boolean populateTypeAndId = true;
<abbr title="1624             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1624             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1625             if (entityForm == null) {
<abbr title="1626                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1626                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1627                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1628                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1629             } else {
1630                 entityForm.clearFieldsMap();
1631                 String entityType = entityForm.getEntityType();
<abbr title="1632                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1632                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1633                 entityForm.setEntityType(entityType);
1634                 populateTypeAndId = false;
1635             }
1636 
1637             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1638             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1638             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1639                     collectionField,
1640                     collectionItemId, responseMap);
1641 
<abbr title="1642             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1642             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1643             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1643             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1644             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1645             entityForm.setTranslationId(alternateId);
1646 
1647             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1648             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1649                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1650                     continue;
1651                 }
1652                 Property p = cmd.getPMap().get(field);
1653                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1654                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1654                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1655                     // directly on the first adorned target collection. Because of this, we need the actual id property">1655                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1656                     // from the entity that models the adorned target relationship, and not the id of the target object.">1656                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1657                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1657                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1658                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1658                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1659                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1660 
<abbr title="1661                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1661                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1662                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1663                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1664 
1665                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1666                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1666                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1667                     } else {
<abbr title="1668                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1668                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1669                     }
1670                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1671                     // See above comment for AdornedTargetCollectionMetadata
1672                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1673 
<abbr title="1674                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1674                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1675                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1675                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1676                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1677 
<abbr title="1678                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1678                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1679                             mmd.getTargetClass(), sectionCrumbs);
1680                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1681 
1682                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1683                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1683                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1684                     } else {
<abbr title="1685                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1685                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1686                     }
1687                 }
1688             }
1689 
<abbr title="1690             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1690             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1691             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1692 
1693             boolean atLeastOneBasicField = false;
1694             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1695                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1695                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1696                     atLeastOneBasicField = true;
1697                     break;
1698                 }
1699             }
1700             if (!atLeastOneBasicField) {
1701                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1702             }
1703             addAuditableDisplayFields(entityForm);
1704             model.addAttribute(&quot;entityForm&quot;, entityForm);
1705             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1706         } else if (md instanceof MapMetadata) {
1707             MapMetadata fmd = (MapMetadata) md;
1708 
<abbr title="1709             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1709             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1710             if (entity == null) {
<abbr title="1711                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1711                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1712                     collectionItemId, sectionCrumbs, null).getEntity();
1713             }
1714 
1715             boolean populateTypeAndId = true;
1716             if (entityForm == null) {
<abbr title="1717                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1717                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1718             } else {
1719                 //save off the prior key before clearing out the fields map as it will not appear
1720                 //back on the saved entity
1721                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1722                 entityForm.clearFieldsMap();
1723                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1724                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1725                 populateTypeAndId = false;
1726             }
1727             try {
1728                 if (StringUtils.isNotEmpty(fmd.getToOneTargetProperty())) {
<abbr title="1729                     entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1729                     entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclðŸ”µ</abbr>
1730                 }
1731             } catch (Exception e) {
1732                 LOG.error(e);
1733             }
<abbr title="1734             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.id&quot;);">1734             String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetPropertðŸ”µ</abbr>
1735             entityForm.setTranslationId(entity.getPMap().get(entityId).getValue());
<abbr title="1736             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1736             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1737             formService.populateMapEntityFormFields(entityForm, entity);
<abbr title="1738             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1738             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1739             formService.populateMapEntityFormFields(entityForm, entity);
1740             addAuditableDisplayFields(entityForm);
1741             model.addAttribute(&quot;entityForm&quot;, entityForm);
1742             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1743         }
1744 
1745         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1746         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1747         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1748         setModelAttributes(model, sectionKey);
1749         return MODAL_CONTAINER_VIEW;
1750     }
1751 
1752     protected EntityForm reinitializeEntityForm(final EntityForm entityForm,
1753             final ClassMetadata collectionMetadata,
1754             final Entity entity,
1755             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,
1756             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
1757         if (entityForm == null) {
1758             return formService
1759                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);
1760         }
1761 
1762         entityForm.clearFieldsMap();
1763         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,
1764                 sectionCrumbs);
1765         //remove all the actions since we&#x27;re not trying to redisplay them on the form
1766         entityForm.removeAllActions();
1767 
1768         return entityForm;
1769     }
1770 
1771     /**
1772      * Updates the specified collection item
1773      *
1774      * @param request
1775      * @param response
1776      * @param model
1777      * @param pathVars
1778      * @param id
1779      * @param collectionField
<abbr title="1780      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1780      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1781      * @param entityForm
1782      * @param result
1783      * @return the return view path
1784      * @throws Exception
1785      */
1786     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1787     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1787     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1788             @PathVariable  Map&lt;String, String&gt; pathVars,
1789             @PathVariable(value=&quot;id&quot;) String id,
1790             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1791             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1792             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1793             BindingResult result) throws Exception {
<abbr title="1794         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1794         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1795     }
1796 
1797     /**
1798      * Updates the specified collection item
1799      *
1800      * @param request
1801      * @param response
1802      * @param model
1803      * @param pathVars
1804      * @param id
1805      * @param collectionField
<abbr title="1806      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1806      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1807      * @param entityForm
<abbr title="1808      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1808      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1809      * @param result
1810      * @return the return view path
1811      * @throws Exception
1812      */
<abbr title="1813     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1813     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1814     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1814     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1815             @PathVariable  Map&lt;String, String&gt; pathVars,
1816             @PathVariable(value=&quot;id&quot;) String id,
1817             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1818             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1819             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1820             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1821             BindingResult result) throws Exception {
1822         String sectionKey = getSectionKey(pathVars);
1823         String mainClassName = getClassNameForSection(sectionKey);
1824         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1825         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1825         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1826         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1827 
<abbr title="1828         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1828         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1829         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1829         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1830         service.clearEntityManager();
1831         // First, we must save the collection entity
<abbr title="1832         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1832         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1833         Entity savedEntity = persistenceResponse.getEntity();
1834         entityFormValidator.validate(entityForm, savedEntity, result);
1835 
1836         if (result.hasErrors()) {
<abbr title="1837             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1837             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1838                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1839         }
1840 
1841         // Next, we must get the new list grid that represents this collection
1842         // We return the new list grid so that it can replace the currently visible one
<abbr title="1843         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1843         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1844 
1845         model.addAttribute(&quot;listGrid&quot;, listGrid);
1846         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1847         setModelAttributes(model, sectionKey);
1848         return &quot;views/standaloneListGrid&quot;;
1849     }
1850 
<abbr title="1851     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1851     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1852     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1853             HttpServletResponse response, Model model,
1854             @PathVariable  Map&lt;String, String&gt; pathVars,
1855             @PathVariable(value=&quot;id&quot;) String id,
1856             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1857             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1858             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1859         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1859         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1860     }
1861 
1862     /**
<abbr title="1863      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1863      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1864      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1864      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1865      *
1866      * @param request
1867      * @param response
1868      * @param model
1869      * @param pathVars
1870      * @param id
1871      * @param collectionField
1872      * @param collectionItemId
1873      * @return an object explaining the state of the operation
1874      * @throws Exception
1875      */
<abbr title="1876     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1876     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1877     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1878             HttpServletResponse response, Model model,
1879             @PathVariable  Map&lt;String, String&gt; pathVars,
1880             @PathVariable(value=&quot;id&quot;) String id,
1881             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1882             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1883             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1884             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1885         String sectionKey = getSectionKey(pathVars);
1886         String mainClassName = getClassNameForSection(sectionKey);
1887         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1888         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1888         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1889         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1890         FieldMetadata md = collectionProperty.getMetadata();
1891 
<abbr title="1892         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1892         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1893         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1894 
<abbr title="1895         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1895         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1896 
1897         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1898 
1899         if (md instanceof AdornedTargetCollectionMetadata) {
1900             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1901             AdornedTargetList atl = ppr.getAdornedList();
1902 
1903             // Get an entity form for the entity
<abbr title="1904             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1904             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1905             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1905             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1906                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1906                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1907                     .getDynamicResultSet().getRecords()[0];
1908             formService.populateEntityFormFields(entityForm, entity);
1909             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1910 
<abbr title="1911             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1911             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1912             int sequenceValue = Integer.parseInt(newSequence) + 1;
1913             Field field = entityForm.findField(atl.getSortField());
1914             field.setValue(String.valueOf(sequenceValue));
1915 
1916             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1917             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1917             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1918             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1919 
1920             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1921             responseMap.put(&quot;field&quot;, collectionField);
1922             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1923             return responseMap;
1924         } else if (md instanceof BasicCollectionMetadata) {
1925             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1926             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1927             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1927             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1928 
<abbr title="1929             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1929             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1930             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="1931             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1931             boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPðŸ”µ</abbr>
1932             if(listGridReadOnly){
1933                         throw new SecurityServiceException();
1934             }
1935             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1936                 Field f = new Field()
1937                         .withName(cd.getSortProperty())
1938                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1939                 entityForm.addHiddenField(mainMetadata, f);
1940             }
1941             formService.populateEntityFormFields(entityForm, entity);
1942 
1943             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1944                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1945                 Field field = entityForm.findField(cd.getSortProperty());
1946                 field.setValue(String.valueOf(sequenceValue));
1947             }
1948 
<abbr title="1949             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1949             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1950             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1951 
1952             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1953             responseMap.put(&quot;field&quot;, collectionField);
1954             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1955             return responseMap;
1956         } else {
<abbr title="1957             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1957             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1958         }
1959     }
1960 
1961     /**
1962      * Removes the requested collection item
1963      *
<abbr title="1964      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1964      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1965      * map collection.
1966      *
1967      * @param request
1968      * @param response
1969      * @param model
1970      * @param pathVars
1971      * @param id
1972      * @param collectionField
1973      * @param collectionItemId
1974      * @return the return view path
1975      * @throws Exception
1976      */
<abbr title="1977     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1977     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1978     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1978     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1979             @PathVariable  Map&lt;String, String&gt; pathVars,
1980             @PathVariable(value=&quot;id&quot;) String id,
1981             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1982             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1983         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1983         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1984     }
1985 
1986     /**
1987      * Removes the requested collection item
1988      *
<abbr title="1989      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1989      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1990      * map collection.
1991      *
1992      * @param request
1993      * @param response
1994      * @param model
1995      * @param pathVars
1996      * @param id
1997      * @param collectionField
1998      * @param collectionItemId
1999      * @return the return view path
2000      * @throws Exception
2001      */
<abbr title="2002     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">2002     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="2003     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">2003     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
2004             @PathVariable  Map&lt;String, String&gt; pathVars,
2005             @PathVariable(value=&quot;id&quot;) String id,
2006             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2007             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2008             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2009         String sectionKey = getSectionKey(pathVars);
2010         String mainClassName = getClassNameForSection(sectionKey);
2011         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2012         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2012         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
2013         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2014 
2015         String priorKey = request.getParameter(&quot;key&quot;);
2016 
<abbr title="2017         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2017         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
2018         declareShouldIgnoreAdditionStatusFilter();
<abbr title="2019         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2019         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
2020         service.clearEntityManager();
2021         // First, we must remove the collection entity
<abbr title="2022         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">2022         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="2023         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">2023         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
2024             String error = &quot;There was an error removing the whatever&quot;;
2025             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
2026                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="2027                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">2027                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="2028             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">2028             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
2029                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2030             }
2031             return new JsonResponse(response)
2032                 .with(&quot;status&quot;, &quot;error&quot;)
2033                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2034                 .done();
2035         }
2036 
2037         // Next, we must get the new list grid that represents this collection
2038         // We return the new list grid so that it can replace the currently visible one
<abbr title="2039         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2039         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
2040 
2041         model.addAttribute(&quot;listGrid&quot;, listGrid);
2042         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2043         setModelAttributes(model, sectionKey);
2044         return &quot;views/standaloneListGrid&quot;;
2045     }
2046 
2047     public void addAuditableDisplayFields(EntityForm entityForm) {
2048         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2049         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2050             addAuditableDisplayField(entityForm, createdBy);
2051 
2052             createdBy.setIsVisible(false);
2053         }
2054         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2055         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2056             addAuditableDisplayField(entityForm, updatedBy);
2057 
2058             updatedBy.setIsVisible(false);
2059         }
2060     }
2061 
2062     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2063         Field displayField = buildAuditableDisplayField(userField);
2064 
2065         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2066         String userName = user == null ? null : user.getName();
2067         displayField.setValue(userName);
2068 
2069         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2070         if (auditGroup != null) {
2071             auditGroup.addField(displayField);
2072         }
2073     }
2074 
2075     private Field buildAuditableDisplayField(Field auditableField) {
2076         return new Field().withFieldType(SupportedFieldType.STRING.toString())
2077                 .withName(auditableField.getName() + &quot;Display&quot;)
2078                 .withFriendlyName(auditableField.getFriendlyName())
2079                 .withOrder(auditableField.getOrder())
2080                 .withOwningEntityClass(auditableField.getOwningEntityClass())
2081                 .withReadOnly(true);
2082     }
2083 
2084     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2085         String tabName = pathVars.get(&quot;tabName&quot;);
2086         if (StringUtils.isBlank(tabName)) {
2087             TabMetadata firstTab = cmd.getFirstTab();
2088             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2089         }
2090         return tabName;
2091     }
2092 
2093     protected String getCurrentFolderId(HttpServletRequest request) {
2094         if (request.getParameterMap().containsKey(CURRENT_FOLDER_ID)) {
2095             return request.getParameter(CURRENT_FOLDER_ID);
2096         }
2097         return &quot;unassigned&quot;;
2098     }
2099 
2100     // *****************************************
2101     // Typed Entity Helper Methods
2102     // *****************************************
2103 
2104     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2105         // Check if this is a typed entity
2106         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2107         if (typedEntitySection != null) {
2108             // Update the friendly name for this Entity Type
2109             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2110         }
2111     }
2112 
2113     // *********************************
2114     // ADDITIONAL SPRING-BOUND METHODS *
2115     // *********************************
2116 
2117     /**
<abbr title="2118      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2118      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2119      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2119      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2120      * or false. If the value is passed in as null, it will treat it as false.
2121      *
2122      * @param binder
2123      */
2124     @InitBinder
2125     public void initBinder(WebDataBinder binder) {
2126         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2127         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2128     }
2129 
2130 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.broadleafcommerce.common.persistence.EntityDuplicator;</span>
  30  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  34  import org.broadleafcommerce.common.util.BLCArrayUtils;
  35  import org.broadleafcommerce.common.util.BLCMessageUtils;
  36  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37  import org.broadleafcommerce.common.web.JsonResponse;
  38  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43  import org.broadleafcommerce.openadmin.dto.ClassTree;
  44  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46  import org.broadleafcommerce.openadmin.dto.Entity;
  47  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50  import org.broadleafcommerce.openadmin.dto.Property;
  51  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  62  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import org.broadleafcommerce.openadmin.web.dao.MultipleCatalogExtensionManager;</span>
  66  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  67  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  68  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  69  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  70  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  71  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  72  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  73  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  74  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  75  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  76  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  77  import org.springframework.stereotype.Controller;
  78  import org.springframework.ui.Model;
  79  import org.springframework.util.MultiValueMap;
  80  import org.springframework.validation.BindingResult;
  81  import org.springframework.web.bind.WebDataBinder;
  82  import org.springframework.web.bind.annotation.InitBinder;
  83  import org.springframework.web.bind.annotation.ModelAttribute;
  84  import org.springframework.web.bind.annotation.PathVariable;
  85  import org.springframework.web.bind.annotation.RequestMapping;
  86  import org.springframework.web.bind.annotation.RequestMethod;
  87  import org.springframework.web.bind.annotation.RequestParam;
  88  import org.springframework.web.bind.annotation.ResponseBody;
  89  import org.springframework.web.servlet.DispatcherServlet;
  90  import org.springframework.web.servlet.FlashMap;
  91  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  92  import org.springframework.web.util.UrlPathHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +</span>
  94  import com.fasterxml.jackson.databind.ObjectMapper;
  95  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +import java.io.Serializable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +import java.io.UnsupportedEncodingException;</span>
  98  import java.net.URLDecoder;
  99  import java.util.ArrayList;
 100  import java.util.Arrays;
 101  import java.util.HashMap;
 102  import java.util.List;
 103  import java.util.Map;
 104  import java.util.Map.Entry;
 105  import java.util.Set;
 106  import java.util.stream.Stream;
 107  
 108  import javax.annotation.Resource;
 109  import javax.servlet.http.HttpServletRequest;
 110  import javax.servlet.http.HttpServletResponse;
 111  
 112  /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 113 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 113 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 114 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 114 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 - * that is not explicitly customized by its own controller.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 + * The default implementation of the {@link AdminAbstractController}. This delegates every call to</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 + * super and does not provide any custom-tailored functionality. It is responsible for rendering the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 + * admin for every entity that is not explicitly customized by its own controller.</span>
 119   *
 120   * @author Andre Azzolini (apazzolini)
 121   * @author Jeff Fischer
 122   */
 123  @Controller(&quot;blAdminBasicEntityController&quot;)
 124  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 125  public class AdminBasicEntityController extends AdminAbstractController {
 126  
 127      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 128  
 129      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 130      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 131      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    protected static final String CURRENT_FOLDER_ID = &quot;currentFolderId&quot;;</span>
 133  
 134      @Resource(name=&quot;blSandBoxHelper&quot;)
 135      protected SandBoxHelper sandBoxHelper;
 136  
 137      @Resource(name = &quot;blAdminUserDao&quot;)
 138      protected AdminUserDao adminUserDao;
 139  
 140      @Resource(name=&quot;blDynamicEntityDao&quot;)
 141      protected DynamicEntityDao dynamicEntityDao;
 142  
 143      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 144      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 145  
 146      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 147      protected RowLevelSecurityService rowLevelSecurityService;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +    protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +    @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    protected GenericEntityService genericEntityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    @Resource(name = &quot;blMultipleCatalogExtensionManager&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +    protected MultipleCatalogExtensionManager multipleCatalogExtensionManager;</span>
 157  






 158      // ******************************************
 159      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 160      // ******************************************
 161  
 162      /**
<abbr title=" 163       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 163       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 164       * criteria.
 165       *
 166       * @param request
 167       * @param response
 168       * @param model
 169       * @param pathVars
 170       * @param requestParams a Map of property name -&gt; list critiera values
 171       * @return the return view path
 172       * @throws Exception
 173       */
 174      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 175      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 176              @PathVariable Map&lt;String, String&gt; pathVars,
 177              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 178          String sectionKey = getSectionKey(pathVars);
 179          String sectionClassName = getClassNameForSection(sectionKey);
 180          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 181          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 181          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 182          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 183          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 184  
 185          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 186          listGrid.setSelectType(ListGrid.SelectType.NONE);
 187  
 188          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 189          if (CollectionUtils.isNotEmpty(headerFields)) {
 190              Field firstField = headerFields.iterator().next();
 191              if (requestParams.containsKey(firstField.getName())) {
 192                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 193              }
 194          }
 195  
 196          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 197  
 198          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 199          model.addAttribute(&quot;listGrid&quot;, listGrid);
 200  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +        return DEFAULT_CONTAINER_VIEW;</span>
 203      }
 204  
 205      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 206              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 207          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 208          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 209          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 210          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 211  
 212          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 213          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 214              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 215          }
 216  
 217          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 218          String requestUri = request.getRequestURI();
 219          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 220              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 221          }
 222  
 223          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 224          model.addAttribute(&quot;currentUri&quot;, requestUri);
 225          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 226          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 227          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 228          model.addAttribute(&quot;mainActions&quot;, mainActions);
 229          setModelAttributes(model, sectionKey);
 230          setTypedEntityModelAttributes(request, model);
 231      }
 232  
 233      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 234      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 235               HttpServletResponse response, Model model,
 236               @PathVariable Map&lt;String, String&gt; pathVars,
 237               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 238          String sectionKey = getSectionKey(pathVars);
 239          String sectionClassName = getClassNameForSection(sectionKey);
 240          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 241          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 241          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 242                  .withCustomCriteria(getCustomCriteria(requestParams));
 243  
 244          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 245  
 246          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 247          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 248  
 249          return formService.constructSelectizeOptionMap(drs, cmd);
 250      }
 251  
 252      /**
 253       * Obtains the requested criteria parameter
 254       *
 255       * @param requestParams
 256       * @return
 257       */
 258      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 259          if (requestParams == null || requestParams.isEmpty()) {
 260              return null;
 261          }
 262  
 263          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 264          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 265          return new String[] {response};
 266      }
 267  
 268      /**
 269       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 270       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 271       *
 272       * @param sectionClassName
 273       * @param cmd
 274       * @param mainActions
 275       */
<abbr title=" 276      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 276      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 277          if (isAddActionAllowed(sectionClassName, cmd)) {
 278              mainActions.add(DefaultMainActions.ADD);
 279          }
 280      }
 281  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -    protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +    protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {</span>
 284          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        boolean canCreate = true;</span>
 286          try {
 287              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 288          } catch (ServiceException e) {
 289              if (e instanceof SecurityServiceException) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -            checkReadOnly: {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -                //check if all the metadata is read only</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -                for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -                    if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -                        if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -                                !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -                            break checkReadOnly;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +        final boolean canAdd = rowLevelSecurityService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        return isNotReadOnly(cmd) &amp;&amp; canAdd;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +    protected boolean isNotReadOnly(final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +        //check if all the metadata is read only</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +        for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +            if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +                if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +                        !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +                    return true;</span>
 320                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 326 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 326 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -        return canCreate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +        return false;</span>
 334      }
 335  
 336      /**
 337       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 338       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 338       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 339       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 339       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 340       * they can then perform operations on sub collections.
 341       *
 342       * @param request
 343       * @param response
 344       * @param model
 345       * @param pathVars
 346       * @param entityType
 347       * @return the return view path
 348       * @throws Exception
 349       */
 350      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 351      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 352              @PathVariable  Map&lt;String, String&gt; pathVars,
 353              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 354          String sectionKey = getSectionKey(pathVars);
 355          String sectionClassName = getClassNameForSection(sectionKey);
 356          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 357          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 357          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 358          ppr.setAddOperationInspect(true);
 359          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 360  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 361 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 361 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +    // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +    // types for this entity.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +    protected String determineEntityType(String entityType, final ClassMetadata cmd)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            throws UnsupportedEncodingException {</span>
 392          if (StringUtils.isBlank(entityType)) {
 393              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 394                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 395              } else {
 396                  entityType = getDefaultEntityType();
 397              }
 398          } else {
 399              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 400          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +        return entityType;</span>
 425      }
 426  
 427      /**
 428       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 429       *
 430       * @param request
 431       * @param response
 432       * @param model
 433       * @param pathVars
 434       * @param entityForm
 435       * @param result
 436       * @return the return view path
 437       * @throws Exception
 438       */
 439      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 440      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 441              @PathVariable  Map&lt;String, String&gt; pathVars,
 442              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 443          String sectionKey = getSectionKey(pathVars);
 444          String sectionClassName = getClassNameForSection(sectionKey);
 445          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 446          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 446          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 447  
 448          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 449          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 449          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 450          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 451          entityFormValidator.validate(entityForm, entity, result);
 452  
 453          if (result.hasErrors()) {
 454              entityForm.clearFieldsMap();
 455              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 456  
 457              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 458  
 459              modifyAddEntityForm(entityForm, pathVars);
 460  
 461              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 462              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 463              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 464              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 465              setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +            return MODAL_CONTAINER_VIEW;</span>
 468          }
 469  
 470          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 471          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 471          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 472 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +    @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 475 +    public String duplicateEntity(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +            final HttpServletResponse response,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +            @PathVariable final Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +            @PathVariable(value = &quot;id&quot;) final String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +            @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +            final BindingResult result) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +        final String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +        final String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +        final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +        final long identifier = Long.parseLong(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +        if (duplicator.validate(entityClass, identifier)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +            final Object duplicate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +                duplicate = duplicator.copy(entityClass, identifier);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +                LOG.error(&quot;Could not duplicate entity&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +                return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            final Serializable dupId = genericEntityService.getIdentifier(duplicate);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 498 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +            // Note that AJAX Redirects need the context path prepended to them</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 500 +            return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +            return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 503 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +    protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +        List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +        String message;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +        BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +        if (context != null &amp;&amp; context.getMessageSource() != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +            message = context.getMessageSource()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +                    .getMessage(code, null, code, context.getJavaLocale());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +            LOG.warn(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +                    &quot;Could not find the MessageSource on the current request, &quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +                            + &quot;not translating the message key&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +            message = &quot;Duplication_Failure&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 520 +        Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 521 +        errorMap.put(&quot;errorType&quot;, &quot;global&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 522 +        errorMap.put(&quot;code&quot;, code);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 523 +        errorMap.put(&quot;message&quot;, message);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +        errors.add(errorMap);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 525 +        return new JsonResponse(response).with(&quot;errors&quot;, errors).done();</span>
 526      }
 527  
 528      /**
 529       * Renders the main entity form for the specified entity
 530       *
 531       * @param request
 532       * @param response
 533       * @param model
 534       * @param pathVars
 535       * @param id
 536       * @return the return view path
 537       * @throws Exception
 538       */
 539      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 540      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 541              @PathVariable  Map&lt;String, String&gt; pathVars,
 542              @PathVariable(&quot;id&quot;) String id) throws Exception {
 543          String sectionKey = getSectionKey(pathVars);
 544          String sectionClassName = getClassNameForSection(sectionKey);
 545          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 546          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 547  
 548          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 549          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 550  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +        multipleCatalogExtensionManager.getProxy().setCurrentCatalog(entity, model);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 552 +</span>
 553          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 554  
 555          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 556  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 563  
 564          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 565              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 566          }
 567  
 568          // Set the sectionKey again incase this is a typed entity
 569          entityForm.setSectionKey(sectionKey);
 570  
 571          // Build the current url in the cast that this is a typed entity
 572          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 573          int startIndex = request.getContextPath().length();
 574  
 575          // Remove the context path from servlet path
 576          String currentUrl = originatingUri.substring(startIndex);
 577  
 578          model.addAttribute(&quot;entity&quot;, entity);
 579          model.addAttribute(&quot;entityForm&quot;, entityForm);
 580          model.addAttribute(&quot;currentUrl&quot;, currentUrl);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +        model.addAttribute(CURRENT_FOLDER_ID, getCurrentFolderId(request));</span>
 582  
 583          setModelAttributes(model, sectionKey);
 584  
 585          // We want to replace author ids with their names
 586          addAuditableDisplayFields(entityForm);
 587  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -            entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 596 -            return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 597 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +        return resolveAppropriateEntityView(request, model, entityForm);</span>
 599      }
 600  
<abbr title=" 601      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 601      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 602                                                                ClassMetadata cmd, Entity entity,
 603                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 604          String tabName = pathVars.get(&quot;tabName&quot;);
 605          if (StringUtils.isEmpty(tabName)) {
 606              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 607          }
 608          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 609      }
 610  
 611      private boolean isAddRequest(Entity entity) {
 612          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 613          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 614          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 615              return false;
 616          }
 617  
 618          return resultHolder.getResult();
 619      }
 620  
 621      /**
 622       * Attempts to get the List Grid for the selected tab.
 623       *
 624       * @param request
 625       * @param response
 626       * @param model
 627       * @param pathVars
 628       * @param id
 629       * @param tabName
 630       * @param entityForm
 631       * @param entity
 632       * @return the return view path
 633       * @throws Exception
 634       */
 635      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 636      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 637              @PathVariable Map&lt;String, String&gt; pathVars,
 638              @PathVariable(value = &quot;id&quot;) String id,
 639              @PathVariable(value = &quot;tabName&quot;) String tabName,
 640              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 641              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 642          String sectionKey = getSectionKey(pathVars);
 643          String sectionClassName = getClassNameForSection(sectionKey);
 644          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 645          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 646          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 647          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 648          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 649          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 650  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 657  
 658          model.addAttribute(&quot;entity&quot;, entity);
 659          model.addAttribute(&quot;entityForm&quot;, entityForm);
 660          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 661  
 662          setModelAttributes(model, sectionKey);
 663  
 664          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 665          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +        return DEFAULT_CONTAINER_VIEW;</span>
 669      }
 670  
 671      /**
 672       * Builds JSON that looks like this:
 673       *
 674       * {&quot;errors&quot;:
 675       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 676       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 677       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 678       *        &quot;errorType&quot;, &quot;field&quot;,
 679       *        &quot;tab&quot;: &quot;General&quot;
 680       *        },
 681       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 682       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 683       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 684       *        &quot;errorType&quot;, &quot;field&quot;,
 685       *        &quot;tab&quot;: &quot;General&quot;
 686       *        }]
 687       * }
 688       *
 689       */
 690      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 691      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 692              @PathVariable Map&lt;String, String&gt; pathVars,
 693              @PathVariable(value = &quot;id&quot;) String id,
 694              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 695              RedirectAttributes ra) throws Exception {
 696  
 697          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 698  
 699          JsonResponse json = new JsonResponse(response);
 700          if (result.hasErrors()) {
 701              populateJsonValidationErrors(entityForm, result, json);
 702          }
 703          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 704          if (CollectionUtils.isNotEmpty(dirtyList)) {
 705              json.with(&quot;dirty&quot;, dirtyList);
 706          }
 707  
 708          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 709          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 709          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 710          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 711              return resultHolder.getResult();
 712          }
 713  
 714          return json.done();
 715      }
 716  
<abbr title=" 717      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 717      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 718          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 719          String sectionKey = getSectionKey(pathVars);
 720          String sectionClassName = getClassNameForSection(sectionKey);
 721          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 722          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 722          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 723          ClassMetadata cmd = null;
 724          Entity entity = null;
 725          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 726          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 727  
 728          for (Property p: entity.getProperties()) {
 729              if (p.getIsDirty()) {
 730                  dirtyList.add(p.getName());
 731              }
 732          }
 733          return dirtyList;
 734      }
 735  
 736      /**
 737       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 738       * error fields highlighted. On a successful save, it will refresh the entity page.
 739       *
 740       * @param request
 741       * @param response
 742       * @param model
 743       * @param pathVars
 744       * @param id
 745       * @param entityForm
 746       * @param result
 747       * @return the return view path
 748       * @throws Exception
 749       */
 750      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 751      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 752              @PathVariable  Map&lt;String, String&gt; pathVars,
 753              @PathVariable(value=&quot;id&quot;) String id,
 754              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 755              RedirectAttributes ra) throws Exception {
 756          String sectionKey = getSectionKey(pathVars);
 757          String sectionClassName = getClassNameForSection(sectionKey);
 758          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 759          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 759          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 760          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 761  
 762          extractDynamicFormFields(cmd, entityForm);
 763  
<abbr title=" 764          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 764          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 765          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 766  
 767          entityFormValidator.validate(entityForm, entity, result);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 768 +</span>
 769          if (result.hasErrors()) {
 770              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 771              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 772  
<abbr title=" 773              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 773              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 774              entityForm.clearFieldsMap();
 775              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 776  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -            if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -                modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -                modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 782 +            modifyEntityForm(entity, entityForm, pathVars);</span>
 783  
 784              model.addAttribute(&quot;entity&quot;, entity);
 785              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 786  
 787              setModelAttributes(model, sectionKey);
 788  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 789 -            if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 790 -                entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 791 -                model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 792 -                model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 793 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 794 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 795 -                model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 796 -                model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 797 -                return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 798 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 799 +            return resolveAppropriateEntityView(request, model, entityForm);</span>
 800          }
 801  
 802          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 803  
 804          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 805 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 806 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 807 +    protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 808 +            final Map&lt;String, String&gt; pathVars) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 809 +        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 810 +            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 811 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 813 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +    protected String resolveAppropriateEntityView(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +            final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 820 +            entityForm.setReadOnly();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 821 +            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 822 +            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 823 +            return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 824 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 825 +            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 826 +            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 827 +            return DEFAULT_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +        }</span>
 829      }
 830  
 831      /**
 832       * Attempts to remove the given entity.
 833       *
 834       * @param request
 835       * @param response
 836       * @param model
 837       * @param pathVars
 838       * @param id
 839       * @return the return view path
 840       * @throws Exception
 841       */
 842      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 843      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 844              @PathVariable  Map&lt;String, String&gt; pathVars,
 845              @PathVariable(value=&quot;id&quot;) String id,
 846              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 847              RedirectAttributes ra) throws Exception {
 848          String sectionKey = getSectionKey(pathVars);
 849          String sectionClassName = getClassNameForSection(sectionKey);
 850          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 851  
<abbr title=" 852          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 852          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 853          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 854          // Removal does not normally return an Entity unless there is some validation error
 855          if (entity != null) {
 856              entityFormValidator.validate(entityForm, entity, result);
 857              if (result.hasErrors()) {
 858                  // Create a flash attribute for the unsuccessful delete
 859                  FlashMap fm = new FlashMap();
 860                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 861                  fm.put(&quot;headerFlashAlert&quot;, true);
 862                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 863  
 864                  // Re-look back up the entity so that we can return something populated
<abbr title=" 865                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 865                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 866                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 867                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 868                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 868                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 869                  entityForm.clearFieldsMap();
 870                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 871                  modifyEntityForm(entityForm, pathVars);
 872  
 873                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 874                          .done();
 875              }
 876          }
 877  
 878          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 879          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 880  
 881          if (isAjaxRequest(request)) {
 882              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 883              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 884          } else {
 885              return &quot;redirect:/&quot; + sectionKey;
 886          }
 887      }
 888  
 889      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 890      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 890      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 891              @PathVariable  Map&lt;String, String&gt; pathVars,
 892              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 893              @RequestParam String ids,
 894              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 895          String sectionKey = getSectionKey(pathVars);
 896          String sectionClassName = getClassNameForSection(sectionKey);
 897          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 898          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 898          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 899          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 900          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 901          FieldMetadata md = collectionProperty.getMetadata();
 902  
 903          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 904          ppr.setStartIndex(getStartIndex(requestParams));
 905          ppr.setMaxIndex(getMaxIndex(requestParams));
 906  
 907          if (md instanceof BasicFieldMetadata) {
 908              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 909              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 910  
 911              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 912              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 913  
 914              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 915              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 916  
 917              for (Entity e : drs.getRecords()) {
 918                  String id = e.getPMap().get(idProp).getValue();
 919                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 920  
 921                  if (StringUtils.isBlank(disp)) {
 922                      disp = e.getPMap().get(displayProp).getValue();
 923                  }
 924  
 925                  returnMap.put(id,  disp);
 926              }
 927  
 928              return returnMap;
 929          }
 930  
 931          return null;
 932      }
 933  
 934      /**
<abbr title=" 935       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 935       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 936       * then this method is invoked when a user clicks on the name of the default category field.
 937       *
 938       * @param request
 939       * @param response
 940       * @param model
 941       * @param pathVars
 942       * @param collectionField
 943       * @param id
 944       * @return
 945       * @throws Exception
 946       */
 947      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 948      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 949              @PathVariable  Map&lt;String, String&gt; pathVars,
 950              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 951              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 952          String sectionKey = getSectionKey(pathVars);
 953          String mainClassName = getClassNameForSection(sectionKey);
 954          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 955          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 955          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 956          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 957          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 958  
<abbr title=" 959          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 959          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 960          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 960          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 961          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 962          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 963          return viewEntityForm(request, response, model, varsForField, id);
 964      }
 965  
 966      @RequestMapping(
 967              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 968              method = RequestMethod.POST
 969      )
 970      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 971                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 972                                          @PathVariable(value=&quot;id&quot;) String id,
 973                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 974                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 975                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 976                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 976                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 977  
<abbr title=" 978          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 978          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 979      }
 980  
 981  
 982      @RequestMapping(
 983              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 984              method = RequestMethod.POST
 985      )
<abbr title=" 986      public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 986      public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
 987                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 988                                          @PathVariable(value=&quot;id&quot;) String id,
 989                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 990                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 991                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 992                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 992                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 993  
<abbr title=" 994          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 994          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 995      }
 996  
 997  
 998      /**
 999       * Returns the records for a given collectionField filtered by a particular criteria
1000       *
1001       * @param request
1002       * @param response
1003       * @param model
1004       * @param pathVars
1005       * @param collectionField
1006       * @param requestParams
1007       * @return the return view path
1008       * @throws Exception
1009       */
1010      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
1011      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
1012              @PathVariable  Map&lt;String, String&gt; pathVars,
1013              @PathVariable(value=&quot;id&quot;) String id,
1014              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1015              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1016          String sectionKey = getSectionKey(pathVars);
1017          String mainClassName = getClassNameForSection(sectionKey);
1018          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1019          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);">1019          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
1020          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1021          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1022  
1023          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
1024          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1025  
1026          // Next, we must get the new list grid that represents this collection
<abbr title="1027          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);">1027          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
1028          model.addAttribute(&quot;listGrid&quot;, listGrid);
1029  
1030          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1031  
1032          // We return the new list grid so that it can replace the currently visible one
1033          setModelAttributes(model, sectionKey);
1034          return &quot;views/standaloneListGrid&quot;;
1035      }
1036  
1037      /**
<abbr title="1038       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes">1038       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
1039       * of this call depending on the type of the specified collection field.
1040       *
1041       * &lt;ul&gt;
1042       *  &lt;li&gt;
<abbr title="1043       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may">1043       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title="1044       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute.">1044       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
1045       *  &lt;/li&gt;
1046       *  &lt;li&gt;
<abbr title="1047       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it.">1047       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
1048       *    Used by fields such as &quot;allParentCategories&quot;.
1049       *  &lt;/li&gt;
1050       *  &lt;li&gt;
<abbr title="1051       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1051       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title="1052       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation">1052       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title="1053       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order.">1053       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
1054       *  &lt;/li&gt;
1055       *  &lt;li&gt;
<abbr title="1056       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1056       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title="1057       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified">1057       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title="1058       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition">1058       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
1059       *    to linking an entity, provide extra fields, such as a promotional message.
1060       *  &lt;/li&gt;
1061       *  &lt;li&gt;
<abbr title="1062       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is">1062       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title="1063       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another">1063       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
1064       *    entity. Used by fields such as the mediaMap on a Sku.
1065       *  &lt;/li&gt;
1066       *
1067       * @param request
1068       * @param response
1069       * @param model
1070       * @param pathVars
1071       * @param id
1072       * @param collectionField
1073       * @param requestParams
1074       * @return the return view path
1075       * @throws Exception
1076       */
1077      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
1078      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1079              @PathVariable Map&lt;String, String&gt; pathVars,
1080              @PathVariable(value = &quot;id&quot;) String id,
1081              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1082              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1083          String sectionKey = getSectionKey(pathVars);
1084          String mainClassName = getClassNameForSection(sectionKey);
1085          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1086          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1087                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1088          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1089          FieldMetadata md = collectionProperty.getMetadata();
1090  
1091          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1092                  .withFilterAndSortCriteria(getCriteria(requestParams))
1093                  .withStartIndex(getStartIndex(requestParams))
1094                  .withMaxIndex(getMaxIndex(requestParams))
1095                  .withLastId(getLastId(requestParams))
1096                  .withFirstId(getFirstId(requestParams))
1097                  .withUpperCount(getUpperCount(requestParams))
1098                  .withLowerCount(getLowerCount(requestParams))
1099                  .withPageSize(getPageSize(requestParams))
1100                  .withPresentationFetch(true);
1101  
1102          if (md instanceof BasicCollectionMetadata) {
1103              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1104              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
1105                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1106                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
1107                  // for this entity.
1108                  String entityType = null;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1109 +</span>
1110                  if (requestParams.containsKey(&quot;entityType&quot;)) {
1111                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
1112                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1113 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1114 +                entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1115 +</span>
1116                  if (StringUtils.isBlank(entityType)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1117 -                    if (cmd.getPolymorphicEntities().getChildren().length == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1118 -                        entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1119 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1120 -                        entityType = getDefaultEntityType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1121 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1122 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1123 -                    entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1124 +                    return getModalForBlankEntityType(request, model, sectionKey, cmd);</span>
1125                  }
1126  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1127 -                if (StringUtils.isBlank(entityType)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1128 -                    List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1129 -                    model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1130 -                    model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1131 -                    model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1132 -                    String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1133 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {">1133 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1134 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());">1134 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1135 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1136 -                    model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1137 -                    model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1138 -                    setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1139 -                    return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1140 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1141 -                    ppr = ppr.withCeilingEntityClassname(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1142 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1143 +                ppr = ppr.withCeilingEntityClassname(entityType);</span>
1144              }
1145          } else if (md instanceof MapMetadata) {
<abbr title="1146              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1146              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
1147              if (result.equals(ExtensionResultStatusType.HANDLED)) {
1148                  model.addAttribute(&quot;entityId&quot;, id);
1149                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1150                  model.addAttribute(&quot;collectionField&quot;, collectionField);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1151 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1152 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1153 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1154 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1155 -        //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1156 +                return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1157 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1158 +        }</span>
1159  
1160          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1161  
<abbr title="1162          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1162          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1163 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1164 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1165 +    protected String getModalForBlankEntityType(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1166 +            final Model model, final String sectionKey, final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1167 +        final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1168 +        model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1169 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1170 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1171 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1172 +        String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1173 +        final String contextPath = request.getContextPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1174 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1175 +        if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1176 +            requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1177 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1178 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1179 +        model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1180 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1181 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1182 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1183 +        return MODAL_CONTAINER_VIEW;</span>
1184      }
1185  
<abbr title="1186      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1186      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title="1187      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1187      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
1188              @PathVariable Map&lt;String, String&gt; pathVars,
1189              @PathVariable(value=&quot;id&quot;) String id,
1190              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1191              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1192          String sectionKey = getSectionKey(pathVars);
1193          String mainClassName = getClassNameForSection(sectionKey);
1194          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1195          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1195          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1196          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1197          FieldMetadata md = collectionProperty.getMetadata();
1198          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1199          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1200              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1200              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1201                      collectionField,
1202                      collectionItemId, responseMap);
1203          }
1204          return responseMap;





















1205      }
1206  
1207      /**
1208       *
1209       * @param request
1210       * @param response
1211       * @param model
1212       * @param pathVars
1213       * @param id
1214       * @param collectionField
1215       * @param requestParams
1216       * @return Json collection data
1217       * @throws Exception
1218       */
1219      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1220      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1220      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1221              @PathVariable Map&lt;String, String&gt; pathVars,
1222              @PathVariable(value = &quot;id&quot;) String id,
1223              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1224              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1225          String sectionKey = getSectionKey(pathVars);
1226          String mainClassName = getClassNameForSection(sectionKey);
1227          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1228          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1229                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1230          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1231          FieldMetadata md = collectionProperty.getMetadata();
1232  
1233          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1234                  .withFilterAndSortCriteria(getCriteria(requestParams))
1235                  .withStartIndex(getStartIndex(requestParams))
1236                  .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1237          String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1237          String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCrðŸ”µ</abbr>
1238                  .toArray(String[]::new);
1239          ppr = ppr.withCustomCriteria( both);
1240  
1241          if (md instanceof AdornedTargetCollectionMetadata) {
1242              ppr.setOperationTypesOverride(null);
1243              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1244              ppr.setSectionEntityField(collectionField);
1245          }
1246  
1247          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1248  
1249          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1250      }
1251  
1252      protected String[] buildSelectizeCustomCriteria() {
1253          return new String[]{ IS_SELECTIZE_REQUEST };
1254      }
1255  
1256      /**
1257       * Adds the requested collection item via Selectize
1258       *
1259       * @param request
1260       * @param response
1261       * @param model
1262       * @param pathVars
1263       * @param id
1264       * @param collectionField
1265       * @param entityForm
1266       * @return the return view path
1267       * @throws Exception
1268       */
1269      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1270      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1270      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1271              @PathVariable Map&lt;String, String&gt; pathVars,
1272              @PathVariable(value=&quot;id&quot;) String id,
1273              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1274              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1275          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1276          String sectionKey = getSectionKey(pathVars);
1277          String mainClassName = getClassNameForSection(sectionKey);
1278          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1279          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1279          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1280          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1281  
1282          if (StringUtils.isBlank(entityForm.getEntityType())) {
1283              FieldMetadata fmd = collectionProperty.getMetadata();
1284              if (fmd instanceof BasicCollectionMetadata) {
1285                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1286              }
1287          }
1288  
<abbr title="1289          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1289          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1290          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1291          declareShouldIgnoreAdditionStatusFilter();
1292          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1293  
1294          // First, we must save the collection entity
<abbr title="1295          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1295          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1296          Entity savedEntity = persistenceResponse.getEntity();
1297          entityFormValidator.validate(entityForm, savedEntity, result);
1298  
1299          if (result.hasErrors()) {
1300              returnVal.put(&quot;error&quot;, result.getFieldError());
1301              return returnVal;
1302          }
1303  
1304          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1305              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1306          }
1307          return returnVal;
1308      }
1309  
1310      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1311          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1311          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1312          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1313      }
1314  
1315      /**
1316       * Adds the requested collection item
1317       *
1318       * @param request
1319       * @param response
1320       * @param model
1321       * @param pathVars
1322       * @param id
1323       * @param collectionField
1324       * @param entityForm
1325       * @return the return view path
1326       * @throws Exception
1327       */
1328      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1329      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1330              @PathVariable Map&lt;String, String&gt; pathVars,
1331              @PathVariable(value=&quot;id&quot;) String id,
1332              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1333              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1334          String sectionKey = getSectionKey(pathVars);
1335          String mainClassName = getClassNameForSection(sectionKey);
1336          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1337          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1337          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1338          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1339  
1340          if (StringUtils.isBlank(entityForm.getEntityType())) {
1341              FieldMetadata fmd = collectionProperty.getMetadata();
1342              if (fmd instanceof BasicCollectionMetadata) {
1343                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1344              }
1345          }
1346  
<abbr title="1347          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1347          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1348          declareShouldIgnoreAdditionStatusFilter();
1349          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1350          service.clearEntityManager();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1351 +</span>
1352          // First, we must save the collection entity
<abbr title="1353          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1353          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1354          Entity savedEntity = persistenceResponse.getEntity();
1355          entityFormValidator.validate(entityForm, savedEntity, result);
1356  
1357          if (result.hasErrors()) {
1358              FieldMetadata md = collectionProperty.getMetadata();
1359              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1360              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1360              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1361                      md, ppr, entityForm, savedEntity);
1362          }
1363  
1364          // Next, we must get the new list grid that represents this collection
<abbr title="1365          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1365          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1366          model.addAttribute(&quot;listGrid&quot;, listGrid);
1367  
1368          // We return the new list grid so that it can replace the currently visible one
1369          model.addAttribute(&quot;actualEntityId&quot;, id);
1370          setModelAttributes(model, sectionKey);
1371          return &quot;views/standaloneListGrid&quot;;
1372      }
1373  
1374      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1375      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1375      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1376              @PathVariable Map&lt;String, String&gt; pathVars,
1377              @PathVariable(value=&quot;id&quot;) String id,
1378              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1379              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1380          String sectionKey = getSectionKey(pathVars);
1381          String mainClassName = getClassNameForSection(sectionKey);
1382          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1383          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1383          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1384          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1385  
1386          if (StringUtils.isBlank(entityForm.getEntityType())) {
1387              FieldMetadata fmd = collectionProperty.getMetadata();
1388              if (fmd instanceof BasicCollectionMetadata) {
1389                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1390              }
1391          }
1392  
<abbr title="1393          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1393          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1394          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1395          entity.setIsPreAdd(true);
1396          // First, we must save the collection entity
<abbr title="1397          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1397          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1398          Entity savedEntity = persistenceResponse.getEntity();
1399  
1400          return new JsonResponse(response)
1401                  .with(&quot;status&quot;, &quot;complete&quot;)
1402                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1403                  .done();
1404      }
1405  
1406      /**
<abbr title="1407       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1407       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1408       * as well as after a POST with validation errors
1409       *
1410       * @param request
1411       * @param model
1412       * @param id
1413       * @param collectionField
1414       * @param sectionKey
1415       * @param collectionProperty
1416       * @param md
1417       * @param ppr
1418       * @return the appropriate view to display for the modal
<abbr title="1419       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1419       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1420       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1420       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1421       * @throws ServiceException
1422       */
1423      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1424              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1425              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1425              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1426  
<abbr title="1427          // For requests to add a new collection item include the main class that the subsequent request comes from.">1427          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1428          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1428          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1429          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1430          // fixes all cases.
1431          String mainClassName = getClassNameForSection(sectionKey);
1432          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1433          ppr.setAddOperationInspect(true);
1434  
1435          if (entityForm != null) {
1436              entityForm.clearFieldsMap();
1437          }
1438          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1439          if (md instanceof BasicCollectionMetadata) {
1440              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1441  
1442              // When adding items to basic collections, we will sometimes show a form to persist a new record
1443              // and sometimes show a list grid to allow the user to associate an existing record.
1444              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1445                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1445                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1446                  if (entityForm == null) {
1447                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1448                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1449                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1450                  } else {
1451                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1452                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1453                  }
<abbr title="1454                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1454                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1455                  entityForm.getTabs().iterator().next().getIsVisible();
1456  
1457                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1458                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1459              } else {
1460                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1461                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1461                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1462                  listGrid.setPathOverride(request.getRequestURL().toString());
1463  
<abbr title="1464                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1464                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1465                      listGrid.removeAllRowActions();
1466                  }
1467  
1468                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1469                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1470              }
1471          } else if (md instanceof AdornedTargetCollectionMetadata) {
1472              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1473  
<abbr title="1474              // Even though this field represents an adorned target collection, the list we want to show in the modal">1474              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1475              // is the standard list grid for the target entity of this field
1476              ppr.setOperationTypesOverride(null);
1477              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1478              ppr.setSectionEntityField(collectionField);
1479  
<abbr title="1480              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1480              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1481  
1482              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1483              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1483              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1484              listGrid.setSubCollectionFieldName(collectionField);
1485              listGrid.setPathOverride(request.getRequestURL().toString());
1486              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1487              if (entityForm == null) {
<abbr title="1488                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1488                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1489                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1490              } else {
<abbr title="1491                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1491                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1492                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1493              }
1494  
1495              listGrid.setListGridType(ListGrid.Type.ADORNED);
1496              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1497                  if (entry.getValue().getIsVisible()) {
1498                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1499                      break;
1500                  }
1501              }
1502  
1503              // This is part of an add, so we want to be able to filter/sort the listgrid
1504              listGrid.setIsSortable(false);
1505              listGrid.setCanFilterAndSort(true);
1506              listGrid.removeAllRowActions();
1507  
1508              model.addAttribute(&quot;listGrid&quot;, listGrid);
1509              model.addAttribute(&quot;entityForm&quot;, entityForm);
1510              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1511          } else if (md instanceof MapMetadata) {
1512              MapMetadata fmd = (MapMetadata) md;
<abbr title="1513              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1513              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1514  
1515              if (entityForm == null) {
1516                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1517              } else {
1518                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1519                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1520              }
1521              model.addAttribute(&quot;entityForm&quot;, entityForm);
1522              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1523          }
1524  
1525          // Set the parent id on the entity form
1526          if (entityForm != null) {
1527              entityForm.setParentId(id);
1528          }
1529  
1530          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1531          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1532          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1533          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1534 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1535 +        return MODAL_CONTAINER_VIEW;</span>
1536      }
1537  
1538      /**
1539       * Shows the appropriate modal dialog to edit the selected collection item
1540       *
1541       * @param request
1542       * @param response
1543       * @param model
1544       * @param pathVars
1545       * @param id
1546       * @param collectionField
1547       * @param collectionItemId
1548       * @return the return view path
1549       * @throws Exception
1550       */
<abbr title="1551      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1551      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1552      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1553              @PathVariable  Map&lt;String, String&gt; pathVars,
1554              @PathVariable(value=&quot;id&quot;) String id,
1555              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1556              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1557              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1558          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1558          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1559                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1560      }
1561  
1562      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1563      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1564              @PathVariable  Map&lt;String, String&gt; pathVars,
1565              @PathVariable(value=&quot;id&quot;) String id,
1566              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1567              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1568          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1569                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1570      }
1571  
1572      /**
<abbr title="1573       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1573       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1574       *
1575       * @param request
1576       * @param response
1577       * @param model
1578       * @param pathVars
1579       * @param id
1580       * @param collectionField
1581       * @param collectionItemId
1582       * @return the return view path
1583       * @throws Exception
1584       */
<abbr title="1585      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1585      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1586      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1587              @PathVariable  Map&lt;String, String&gt; pathVars,
1588              @PathVariable(value=&quot;id&quot;) String id,
1589              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1590              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1591              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1592          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1592          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1593                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1594  
1595          // Since this is a read-only view, actions don&#x27;t make sense in this context
1596          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1597          addAuditableDisplayFields(ef);
1598          ef.removeAllActions();
1599          ef.setReadOnly();
1600  
1601          return returnPath;
1602      }
1603  
1604      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1605      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1606              @PathVariable  Map&lt;String, String&gt; pathVars,
1607              @PathVariable(value=&quot;id&quot;) String id,
1608              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1609              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1610          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1610          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1611                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1612  
1613          // Since this is a read-only view, actions don&#x27;t make sense in this context
1614          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1615          ef.removeAllActions();
1616          ef.setReadOnly();
1617  
1618          return returnPath;
1619      }
1620  
<abbr title="1621      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1621      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1622              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1622              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1623          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1623          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1624      }
1625  
<abbr title="1626      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1626      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1627              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1627              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1628          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1628          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1629      }
1630  
<abbr title="1631      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1631      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1632                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1632                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1633          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1633          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1634      }
1635  
1636      /**
<abbr title="1637       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1637       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1638       * which are optional. If they are not passed in then they are automatically looked up
1639       *
1640       * @param request
1641       * @param model
1642       * @param pathVars
1643       * @param id
1644       * @param collectionField
1645       * @param collectionItemId
1646       * @param modalHeaderType
1647       * @param entityForm
1648       * @param entity
1649       * @return
1650       * @throws ServiceException
1651       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1652 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1652 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1653 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1653 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1654 +    protected String showViewUpdateCollection(HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1655 +            Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1656 +            Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1657 +            String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1658 +            String collectionField,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1659 +            String collectionItemId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1660 +            String alternateId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1661 +            String modalHeaderType,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1662 +            EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1663 +            Entity entity) throws ServiceException {</span>
1664          String sectionKey = getSectionKey(pathVars);
1665          String mainClassName = getClassNameForSection(sectionKey);
1666          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1667          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1667          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1668          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1669          FieldMetadata md = collectionProperty.getMetadata();
1670          SectionCrumb nextCrumb = new SectionCrumb();
1671          if (md instanceof MapMetadata) {
1672              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1673          } else {
1674              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1675          }
1676          nextCrumb.setSectionId(collectionItemId);
1677          if (!sectionCrumbs.contains(nextCrumb)) {
1678              sectionCrumbs.add(nextCrumb);
1679          }
1680  
<abbr title="1681          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1681          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1682          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1682          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1683  
1684          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1685  
1686          if (md instanceof BasicCollectionMetadata &amp;&amp;
1687                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1688                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1689              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1690  
<abbr title="1691              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1691              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1692              if (entity == null) {
<abbr title="1693                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1693                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1694              }
1695  
1696              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1697              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1697              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1698 -            if (entityForm == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1699 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1699 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1700 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1701 -                entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1702 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1702 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1703 -                //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1704 -                entityForm.removeAllActions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1705 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1706 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1707 +            entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1708 +                    subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1709 +</span>
1710              entityForm.removeAction(DefaultEntityFormActions.DELETE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1711 +            entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1712 +</span>
1713              addAuditableDisplayFields(entityForm);
1714              model.addAttribute(&quot;entityForm&quot;, entityForm);
1715              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1716          } else if (md instanceof AdornedTargetCollectionMetadata) {
1717              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1718  
1719              if (entity == null) {
1720                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1721                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1722              }
1723  
1724              boolean populateTypeAndId = true;
1725              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1726              if (entityForm == null) {
<abbr title="1727                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1727                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1728                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1729                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1730              } else {
1731                  entityForm.clearFieldsMap();
1732                  String entityType = entityForm.getEntityType();
<abbr title="1733                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1733                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1734                  entityForm.setEntityType(entityType);
1735                  populateTypeAndId = false;
1736              }
1737  
1738              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1739              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1739              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1740                      collectionField,
1741                      collectionItemId, responseMap);
1742  
<abbr title="1743              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1743              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1744              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1745              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1746              entityForm.setTranslationId(alternateId);
1747  
1748              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1749              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1750                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1751                      continue;
1752                  }
1753                  Property p = cmd.getPMap().get(field);
1754                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1755                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1755                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1756                      // directly on the first adorned target collection. Because of this, we need the actual id property">1756                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1757                      // from the entity that models the adorned target relationship, and not the id of the target object.">1757                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1758                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1758                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1759                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1760                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1761  
<abbr title="1762                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1762                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1763                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1764                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1765  
1766                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1767                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1767                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1768                      } else {
<abbr title="1769                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1769                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1770                      }
1771                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1772                      // See above comment for AdornedTargetCollectionMetadata
1773                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1774  
<abbr title="1775                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1775                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1776                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1777                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1778  
<abbr title="1779                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1779                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1780                              mmd.getTargetClass(), sectionCrumbs);
1781                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1782  
1783                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1784                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1784                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1785                      } else {
<abbr title="1786                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1786                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1787                      }
1788                  }
1789              }
1790  
1791              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1792              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1793  
1794              boolean atLeastOneBasicField = false;
1795              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1796                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1796                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1797                      atLeastOneBasicField = true;
1798                      break;
1799                  }
1800              }
1801              if (!atLeastOneBasicField) {
1802                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1803              }
1804              addAuditableDisplayFields(entityForm);
1805              model.addAttribute(&quot;entityForm&quot;, entityForm);
1806              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1807          } else if (md instanceof MapMetadata) {
1808              MapMetadata fmd = (MapMetadata) md;
1809  
<abbr title="1810              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1810              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1811              if (entity == null) {
1812                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1813                      collectionItemId, sectionCrumbs, null).getEntity();
1814              }
1815  
1816              boolean populateTypeAndId = true;
1817              if (entityForm == null) {
1818                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1819              } else {
1820                  //save off the prior key before clearing out the fields map as it will not appear
1821                  //back on the saved entity
1822                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1823                  entityForm.clearFieldsMap();
1824                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1825                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1826                  populateTypeAndId = false;
1827              }
1828              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1829 -                entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1829 -                entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1830 +                if (StringUtils.isNotEmpty(fmd.getToOneTargetProperty())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1831 +                    entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1831 +                    entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredFieldðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1832 +                }</span>
1833              } catch (Exception e) {
1834                  LOG.error(e);
1835              }
<abbr title="1836              String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.id&quot;);">1836              String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.iðŸ”µ</abbr>
1837              entityForm.setTranslationId(entity.getPMap().get(entityId).getValue());
1838              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1839              formService.populateMapEntityFormFields(entityForm, entity);
1840              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1841              formService.populateMapEntityFormFields(entityForm, entity);
1842              addAuditableDisplayFields(entityForm);
1843              model.addAttribute(&quot;entityForm&quot;, entityForm);
1844              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1845          }
1846  
1847          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1848          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1849          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1850          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1851 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1852 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1853 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1854 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1855 +    protected EntityForm reinitializeEntityForm(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1856 +            final ClassMetadata collectionMetadata,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1857 +            final Entity entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1858 +            final Map&lt;String, DynamicResultSet&gt; subRecordsMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1859 +            final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1860 +        if (entityForm == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1861 +            return formService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1862 +                    .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1863 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1864 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1865 +        entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1866 +        formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1867 +                sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1868 +        //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1869 +        entityForm.removeAllActions();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1870 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1871 +        return entityForm;</span>
1872      }
1873  
1874      /**
1875       * Updates the specified collection item
1876       *
1877       * @param request
1878       * @param response
1879       * @param model
1880       * @param pathVars
1881       * @param id
1882       * @param collectionField
<abbr title="1883       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1883       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1884       * @param entityForm
1885       * @param result
1886       * @return the return view path
1887       * @throws Exception
1888       */
1889      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1890      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1891              @PathVariable  Map&lt;String, String&gt; pathVars,
1892              @PathVariable(value=&quot;id&quot;) String id,
1893              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1894              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1895              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1896              BindingResult result) throws Exception {
<abbr title="1897          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1897          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1898      }
1899  
1900      /**
1901       * Updates the specified collection item
1902       *
1903       * @param request
1904       * @param response
1905       * @param model
1906       * @param pathVars
1907       * @param id
1908       * @param collectionField
<abbr title="1909       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1909       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1910       * @param entityForm
<abbr title="1911       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1911       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1912       * @param result
1913       * @return the return view path
1914       * @throws Exception
1915       */
<abbr title="1916      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1916      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1917      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1918              @PathVariable  Map&lt;String, String&gt; pathVars,
1919              @PathVariable(value=&quot;id&quot;) String id,
1920              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1921              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1922              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1923              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1924              BindingResult result) throws Exception {
1925          String sectionKey = getSectionKey(pathVars);
1926          String mainClassName = getClassNameForSection(sectionKey);
1927          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1928          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1928          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1929          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1930  
<abbr title="1931          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1931          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1932          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1933          service.clearEntityManager();
1934          // First, we must save the collection entity
<abbr title="1935          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1935          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1936          Entity savedEntity = persistenceResponse.getEntity();
1937          entityFormValidator.validate(entityForm, savedEntity, result);
1938  
1939          if (result.hasErrors()) {
<abbr title="1940              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1940              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1941                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1942          }
1943  
1944          // Next, we must get the new list grid that represents this collection
1945          // We return the new list grid so that it can replace the currently visible one
<abbr title="1946          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1946          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1947  
1948          model.addAttribute(&quot;listGrid&quot;, listGrid);
1949          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1950          setModelAttributes(model, sectionKey);
1951          return &quot;views/standaloneListGrid&quot;;
1952      }
1953  
1954      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1955      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1956              HttpServletResponse response, Model model,
1957              @PathVariable  Map&lt;String, String&gt; pathVars,
1958              @PathVariable(value=&quot;id&quot;) String id,
1959              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1960              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1961              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1962          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1962          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1963      }
1964  
1965      /**
1966       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1967       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1968       *
1969       * @param request
1970       * @param response
1971       * @param model
1972       * @param pathVars
1973       * @param id
1974       * @param collectionField
1975       * @param collectionItemId
1976       * @return an object explaining the state of the operation
1977       * @throws Exception
1978       */
<abbr title="1979      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1979      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1980      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1981              HttpServletResponse response, Model model,
1982              @PathVariable  Map&lt;String, String&gt; pathVars,
1983              @PathVariable(value=&quot;id&quot;) String id,
1984              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1985              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1986              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1987              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1988          String sectionKey = getSectionKey(pathVars);
1989          String mainClassName = getClassNameForSection(sectionKey);
1990          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1991          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1991          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1992          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1993          FieldMetadata md = collectionProperty.getMetadata();
1994  
<abbr title="1995          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1995          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1996          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1997  
<abbr title="1998          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1998          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1999  
2000          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
2001  
2002          if (md instanceof AdornedTargetCollectionMetadata) {
2003              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
2004              AdornedTargetList atl = ppr.getAdornedList();
2005  
2006              // Get an entity form for the entity
<abbr title="2007              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">2007              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
2008              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
2009                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
2010                      .getDynamicResultSet().getRecords()[0];
2011              formService.populateEntityFormFields(entityForm, entity);
2012              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
2013  
<abbr title="2014              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">2014              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
2015              int sequenceValue = Integer.parseInt(newSequence) + 1;
2016              Field field = entityForm.findField(atl.getSortField());
2017              field.setValue(String.valueOf(sequenceValue));
2018  
2019              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2020              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">2020              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
2021              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
2022  
2023              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2024              responseMap.put(&quot;field&quot;, collectionField);
2025              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2026              return responseMap;
2027          } else if (md instanceof BasicCollectionMetadata) {
2028              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
2029              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2030              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2030              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
2031  
<abbr title="2032              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">2032              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
2033              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="2034              boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">2034              boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentðŸ”µ</abbr>
2035              if(listGridReadOnly){
2036                          throw new SecurityServiceException();
2037              }
2038              if (!StringUtils.isEmpty(cd.getSortProperty())) {
2039                  Field f = new Field()
2040                          .withName(cd.getSortProperty())
2041                          .withFieldType(SupportedFieldType.HIDDEN.toString());
2042                  entityForm.addHiddenField(mainMetadata, f);
2043              }
2044              formService.populateEntityFormFields(entityForm, entity);
2045  
2046              if (!StringUtils.isEmpty(cd.getSortProperty())) {
2047                  int sequenceValue = Integer.parseInt(newSequence) + 1;
2048                  Field field = entityForm.findField(cd.getSortProperty());
2049                  field.setValue(String.valueOf(sequenceValue));
2050              }
2051  
<abbr title="2052              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">2052              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
2053              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
2054  
2055              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2056              responseMap.put(&quot;field&quot;, collectionField);
2057              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2058              return responseMap;
2059          } else {
<abbr title="2060              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">2060              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
2061          }
2062      }
2063  
2064      /**
2065       * Removes the requested collection item
2066       *
<abbr title="2067       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2067       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2068       * map collection.
2069       *
2070       * @param request
2071       * @param response
2072       * @param model
2073       * @param pathVars
2074       * @param id
2075       * @param collectionField
2076       * @param collectionItemId
2077       * @return the return view path
2078       * @throws Exception
2079       */
2080      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
2081      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2082              @PathVariable  Map&lt;String, String&gt; pathVars,
2083              @PathVariable(value=&quot;id&quot;) String id,
2084              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2085              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="2086          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">2086          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
2087      }
2088  
2089      /**
2090       * Removes the requested collection item
2091       *
<abbr title="2092       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2092       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2093       * map collection.
2094       *
2095       * @param request
2096       * @param response
2097       * @param model
2098       * @param pathVars
2099       * @param id
2100       * @param collectionField
2101       * @param collectionItemId
2102       * @return the return view path
2103       * @throws Exception
2104       */
<abbr title="2105      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">2105      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
2106      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2107              @PathVariable  Map&lt;String, String&gt; pathVars,
2108              @PathVariable(value=&quot;id&quot;) String id,
2109              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2110              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2111              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2112          String sectionKey = getSectionKey(pathVars);
2113          String mainClassName = getClassNameForSection(sectionKey);
2114          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2115          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2115          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
2116          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2117  
2118          String priorKey = request.getParameter(&quot;key&quot;);
2119  
<abbr title="2120          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2120          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
2121          declareShouldIgnoreAdditionStatusFilter();
2122          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
2123          service.clearEntityManager();
2124          // First, we must remove the collection entity
<abbr title="2125          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">2125          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
2126          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
2127              String error = &quot;There was an error removing the whatever&quot;;
2128              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
2129                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="2130                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">2130                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
2131              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
2132                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2133              }
2134              return new JsonResponse(response)
2135                  .with(&quot;status&quot;, &quot;error&quot;)
2136                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2137                  .done();
2138          }
2139  
2140          // Next, we must get the new list grid that represents this collection
2141          // We return the new list grid so that it can replace the currently visible one
<abbr title="2142          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2142          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
2143  
2144          model.addAttribute(&quot;listGrid&quot;, listGrid);
2145          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2146          setModelAttributes(model, sectionKey);
2147          return &quot;views/standaloneListGrid&quot;;
2148      }
2149  
2150      public void addAuditableDisplayFields(EntityForm entityForm) {
2151          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2152          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2153              addAuditableDisplayField(entityForm, createdBy);
2154  
2155              createdBy.setIsVisible(false);
2156          }
2157          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2158          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2159              addAuditableDisplayField(entityForm, updatedBy);
2160  
2161              updatedBy.setIsVisible(false);
2162          }
2163      }
2164  
2165      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2166          Field displayField = buildAuditableDisplayField(userField);
2167  
2168          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2169          String userName = user == null ? null : user.getName();
2170          displayField.setValue(userName);
2171  
2172          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2173          if (auditGroup != null) {
2174              auditGroup.addField(displayField);
2175          }
2176      }
2177  
2178      private Field buildAuditableDisplayField(Field auditableField) {
2179          return new Field().withFieldType(SupportedFieldType.STRING.toString())
2180                  .withName(auditableField.getName() + &quot;Display&quot;)
2181                  .withFriendlyName(auditableField.getFriendlyName())
2182                  .withOrder(auditableField.getOrder())
2183                  .withOwningEntityClass(auditableField.getOwningEntityClass())
2184                  .withReadOnly(true);
2185      }
2186  
2187      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2188          String tabName = pathVars.get(&quot;tabName&quot;);
2189          if (StringUtils.isBlank(tabName)) {
2190              TabMetadata firstTab = cmd.getFirstTab();
2191              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2192          }
2193          return tabName;
2194      }
2195  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2196 +    protected String getCurrentFolderId(HttpServletRequest request) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2197 +        if (request.getParameterMap().containsKey(CURRENT_FOLDER_ID)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2198 +            return request.getParameter(CURRENT_FOLDER_ID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2199 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2200 +        return &quot;unassigned&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2201 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">2202 +</span>
2203      // *****************************************
2204      // Typed Entity Helper Methods
2205      // *****************************************
2206  
2207      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2208          // Check if this is a typed entity
2209          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2210          if (typedEntitySection != null) {
2211              // Update the friendly name for this Entity Type
2212              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2213          }
2214      }
2215  
2216      // *********************************
2217      // ADDITIONAL SPRING-BOUND METHODS *
2218      // *********************************
2219  
2220      /**
2221       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="2222       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2222       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
2223       * or false. If the value is passed in as null, it will treat it as false.
2224       *
2225       * @param binder
2226       */
2227      @InitBinder
2228      public void initBinder(WebDataBinder binder) {
2229          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2230          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2231      }
2232  
2233  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.broadleafcommerce.common.persistence.EntityDuplicator;</span>
  30  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  34  import org.broadleafcommerce.common.util.BLCArrayUtils;
  35  import org.broadleafcommerce.common.util.BLCMessageUtils;
  36  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37  import org.broadleafcommerce.common.web.JsonResponse;
  38  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43  import org.broadleafcommerce.openadmin.dto.ClassTree;
  44  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46  import org.broadleafcommerce.openadmin.dto.Entity;
  47  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50  import org.broadleafcommerce.openadmin.dto.Property;
  51  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  62  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;

  65  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  66  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  67  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  68  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  69  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  70  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  71  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  72  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  73  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  74  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  75  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  76  import org.springframework.stereotype.Controller;
  77  import org.springframework.ui.Model;
  78  import org.springframework.util.MultiValueMap;
  79  import org.springframework.validation.BindingResult;
  80  import org.springframework.web.bind.WebDataBinder;
  81  import org.springframework.web.bind.annotation.InitBinder;
  82  import org.springframework.web.bind.annotation.ModelAttribute;
  83  import org.springframework.web.bind.annotation.PathVariable;
  84  import org.springframework.web.bind.annotation.RequestMapping;
  85  import org.springframework.web.bind.annotation.RequestMethod;
  86  import org.springframework.web.bind.annotation.RequestParam;
  87  import org.springframework.web.bind.annotation.ResponseBody;
  88  import org.springframework.web.servlet.DispatcherServlet;
  89  import org.springframework.web.servlet.FlashMap;
  90  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  91  import org.springframework.web.util.UrlPathHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +</span>
  93  import com.fasterxml.jackson.databind.ObjectMapper;
  94  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +import java.io.Serializable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +import java.io.UnsupportedEncodingException;</span>
  97  import java.net.URLDecoder;
  98  import java.util.ArrayList;
  99  import java.util.Arrays;
 100  import java.util.HashMap;
 101  import java.util.List;
 102  import java.util.Map;
 103  import java.util.Map.Entry;
 104  import java.util.Set;
 105  import java.util.stream.Stream;
 106  
 107  import javax.annotation.Resource;
 108  import javax.servlet.http.HttpServletRequest;
 109  import javax.servlet.http.HttpServletResponse;
 110  
 111  /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 112 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 112 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 113 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 113 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 - * that is not explicitly customized by its own controller.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 + * The default implementation of the {@link AdminAbstractController}. This delegates every call to</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 + * super and does not provide any custom-tailored functionality. It is responsible for rendering the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 + * admin for every entity that is not explicitly customized by its own controller.</span>
 118   *
 119   * @author Andre Azzolini (apazzolini)
 120   * @author Jeff Fischer
 121   */
 122  @Controller(&quot;blAdminBasicEntityController&quot;)
 123  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 124  public class AdminBasicEntityController extends AdminAbstractController {
 125  
 126      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 127  
 128      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 129      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 130      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;

 131  
 132      @Resource(name=&quot;blSandBoxHelper&quot;)
 133      protected SandBoxHelper sandBoxHelper;
 134  
 135      @Resource(name = &quot;blAdminUserDao&quot;)
 136      protected AdminUserDao adminUserDao;
 137  
 138      @Resource(name=&quot;blDynamicEntityDao&quot;)
 139      protected DynamicEntityDao dynamicEntityDao;
 140  
 141      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 142      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 143  
 144      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 145      protected RowLevelSecurityService rowLevelSecurityService;









 146  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +    @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +    protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +    @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    protected GenericEntityService genericEntityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +</span>
 153      // ******************************************
 154      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 155      // ******************************************
 156  
 157      /**
<abbr title=" 158       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 158       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 159       * criteria.
 160       *
 161       * @param request
 162       * @param response
 163       * @param model
 164       * @param pathVars
 165       * @param requestParams a Map of property name -&gt; list critiera values
 166       * @return the return view path
 167       * @throws Exception
 168       */
 169      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 170      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 171              @PathVariable Map&lt;String, String&gt; pathVars,
 172              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 173          String sectionKey = getSectionKey(pathVars);
 174          String sectionClassName = getClassNameForSection(sectionKey);
 175          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 176          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 176          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 177          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 178          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 179  
 180          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 181          listGrid.setSelectType(ListGrid.SelectType.NONE);
 182  
 183          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 184          if (CollectionUtils.isNotEmpty(headerFields)) {
 185              Field firstField = headerFields.iterator().next();
 186              if (requestParams.containsKey(firstField.getName())) {
 187                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 188              }
 189          }
 190  
 191          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 192  
 193          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 194          model.addAttribute(&quot;listGrid&quot;, listGrid);
 195  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +        return DEFAULT_CONTAINER_VIEW;</span>
 198      }
 199  
 200      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 201              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 202          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 203          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 204          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 205          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 206  
 207          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 208          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 209              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 210          }
 211  
 212          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 213          String requestUri = request.getRequestURI();
 214          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 215              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 216          }
 217  
 218          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 219          model.addAttribute(&quot;currentUri&quot;, requestUri);
 220          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 221          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 222          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 223          model.addAttribute(&quot;mainActions&quot;, mainActions);
 224          setModelAttributes(model, sectionKey);
 225          setTypedEntityModelAttributes(request, model);
 226      }
 227  
 228      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 229      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 230               HttpServletResponse response, Model model,
 231               @PathVariable Map&lt;String, String&gt; pathVars,
 232               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 233          String sectionKey = getSectionKey(pathVars);
 234          String sectionClassName = getClassNameForSection(sectionKey);
 235          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 236          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 236          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 237                  .withCustomCriteria(getCustomCriteria(requestParams));
 238  
 239          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 240  
 241          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 242          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 243  
 244          return formService.constructSelectizeOptionMap(drs, cmd);
 245      }
 246  
 247      /**
 248       * Obtains the requested criteria parameter
 249       *
 250       * @param requestParams
 251       * @return
 252       */
 253      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 254          if (requestParams == null || requestParams.isEmpty()) {
 255              return null;
 256          }
 257  
 258          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 259          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 260          return new String[] {response};
 261      }
 262  
 263      /**
 264       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 265       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 266       *
 267       * @param sectionClassName
 268       * @param cmd
 269       * @param mainActions
 270       */
<abbr title=" 271      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 271      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 272          if (isAddActionAllowed(sectionClassName, cmd)) {
 273              mainActions.add(DefaultMainActions.ADD);
 274          }
 275      }
 276  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -    protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +    protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {</span>
 279          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        boolean canCreate = true;</span>
 281          try {
 282              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 283          } catch (ServiceException e) {
 284              if (e instanceof SecurityServiceException) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -            checkReadOnly: {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -                //check if all the metadata is read only</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -                for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -                    if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -                        if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -                                !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -                            break checkReadOnly;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        final boolean canAdd = rowLevelSecurityService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +        return isNotReadOnly(cmd) &amp;&amp; canAdd;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +    protected boolean isNotReadOnly(final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +        //check if all the metadata is read only</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +            if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +                if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +                        !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +                    return true;</span>
 315                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 321 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 321 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -        return canCreate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        return false;</span>
 329      }
 330  
 331      /**
 332       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 333       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 333       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 334       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 334       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 335       * they can then perform operations on sub collections.
 336       *
 337       * @param request
 338       * @param response
 339       * @param model
 340       * @param pathVars
 341       * @param entityType
 342       * @return the return view path
 343       * @throws Exception
 344       */
 345      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 346      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 347              @PathVariable  Map&lt;String, String&gt; pathVars,
 348              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 349          String sectionKey = getSectionKey(pathVars);
 350          String sectionClassName = getClassNameForSection(sectionKey);
 351          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 352          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 352          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 353          ppr.setAddOperationInspect(true);
 354          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 355  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 356 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 356 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +    // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +    // types for this entity.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +    protected String determineEntityType(String entityType, final ClassMetadata cmd)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +            throws UnsupportedEncodingException {</span>
 387          if (StringUtils.isBlank(entityType)) {
 388              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 389                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 390              } else {
 391                  entityType = getDefaultEntityType();
 392              }
 393          } else {
 394              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 395          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +        return entityType;</span>
 420      }
 421  
 422      /**
 423       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 424       *
 425       * @param request
 426       * @param response
 427       * @param model
 428       * @param pathVars
 429       * @param entityForm
 430       * @param result
 431       * @return the return view path
 432       * @throws Exception
 433       */
 434      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 435      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 436              @PathVariable  Map&lt;String, String&gt; pathVars,
 437              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 438          String sectionKey = getSectionKey(pathVars);
 439          String sectionClassName = getClassNameForSection(sectionKey);
 440          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 441          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 441          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 442  
 443          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 444          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 444          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 445          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 446          entityFormValidator.validate(entityForm, entity, result);
 447  
 448          if (result.hasErrors()) {
 449              entityForm.clearFieldsMap();
 450              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 451  
 452              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 453  
 454              modifyAddEntityForm(entityForm, pathVars);
 455  
 456              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 457              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 458              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 459              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 460              setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +            return MODAL_CONTAINER_VIEW;</span>
 463          }
 464  
 465          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 466          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 466          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 468 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 469 +    @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 470 +    public String duplicateEntity(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +            final HttpServletResponse response,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 472 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +            @PathVariable final Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +            @PathVariable(value = &quot;id&quot;) final String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 475 +            @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +            final BindingResult result) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +        final String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +        final String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +        final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +        final long identifier = Long.parseLong(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +        if (duplicator.validate(entityClass, identifier)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +            final Object duplicate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +                duplicate = duplicator.copy(entityClass, identifier);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +                LOG.error(&quot;Could not duplicate entity&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +                return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +            final Serializable dupId = genericEntityService.getIdentifier(duplicate);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +            // Note that AJAX Redirects need the context path prepended to them</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +            return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 498 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 500 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +    protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +        List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 503 +        String message;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +        BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +        if (context != null &amp;&amp; context.getMessageSource() != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +            message = context.getMessageSource()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +                    .getMessage(code, null, code, context.getJavaLocale());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +            LOG.warn(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +                    &quot;Could not find the MessageSource on the current request, &quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +                            + &quot;not translating the message key&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +            message = &quot;Duplication_Failure&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +        Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +        errorMap.put(&quot;errorType&quot;, &quot;global&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +        errorMap.put(&quot;code&quot;, code);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        errorMap.put(&quot;message&quot;, message);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +        errors.add(errorMap);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 520 +        return new JsonResponse(response).with(&quot;errors&quot;, errors).done();</span>
 521      }
 522  
 523      /**
 524       * Renders the main entity form for the specified entity
 525       *
 526       * @param request
 527       * @param response
 528       * @param model
 529       * @param pathVars
 530       * @param id
 531       * @return the return view path
 532       * @throws Exception
 533       */
 534      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 535      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 536              @PathVariable  Map&lt;String, String&gt; pathVars,
 537              @PathVariable(&quot;id&quot;) String id) throws Exception {
 538          String sectionKey = getSectionKey(pathVars);
 539          String sectionClassName = getClassNameForSection(sectionKey);
 540          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 541          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 542  
 543          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 544          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 545  


 546          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 547  
 548          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 549  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 556  
 557          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 558              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 559          }
 560  
 561          // Set the sectionKey again incase this is a typed entity
 562          entityForm.setSectionKey(sectionKey);
 563  
 564          // Build the current url in the cast that this is a typed entity
 565          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 566          int startIndex = request.getContextPath().length();
 567  
 568          // Remove the context path from servlet path
 569          String currentUrl = originatingUri.substring(startIndex);
 570  
 571          model.addAttribute(&quot;entity&quot;, entity);
 572          model.addAttribute(&quot;entityForm&quot;, entityForm);
 573          model.addAttribute(&quot;currentUrl&quot;, currentUrl);

 574  
 575          setModelAttributes(model, sectionKey);
 576  
 577          // We want to replace author ids with their names
 578          addAuditableDisplayFields(entityForm);
 579  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -            entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -            return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 590 +        return resolveAppropriateEntityView(request, model, entityForm);</span>
 591      }
 592  
<abbr title=" 593      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 593      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 594                                                                ClassMetadata cmd, Entity entity,
 595                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 596          String tabName = pathVars.get(&quot;tabName&quot;);
 597          if (StringUtils.isEmpty(tabName)) {
 598              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 599          }
 600          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 601      }
 602  
 603      private boolean isAddRequest(Entity entity) {
 604          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 605          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 606          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 607              return false;
 608          }
 609  
 610          return resultHolder.getResult();
 611      }
 612  
 613      /**
 614       * Attempts to get the List Grid for the selected tab.
 615       *
 616       * @param request
 617       * @param response
 618       * @param model
 619       * @param pathVars
 620       * @param id
 621       * @param tabName
 622       * @param entityForm
 623       * @param entity
 624       * @return the return view path
 625       * @throws Exception
 626       */
 627      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 628      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 629              @PathVariable Map&lt;String, String&gt; pathVars,
 630              @PathVariable(value = &quot;id&quot;) String id,
 631              @PathVariable(value = &quot;tabName&quot;) String tabName,
 632              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 633              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 634          String sectionKey = getSectionKey(pathVars);
 635          String sectionClassName = getClassNameForSection(sectionKey);
 636          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 637          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 638          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 639          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 640          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 641          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 642  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 648 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 649  
 650          model.addAttribute(&quot;entity&quot;, entity);
 651          model.addAttribute(&quot;entityForm&quot;, entityForm);
 652          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 653  
 654          setModelAttributes(model, sectionKey);
 655  
 656          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 657          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +        return DEFAULT_CONTAINER_VIEW;</span>
 661      }
 662  
 663      /**
 664       * Builds JSON that looks like this:
 665       *
 666       * {&quot;errors&quot;:
 667       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 668       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 669       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 670       *        &quot;errorType&quot;, &quot;field&quot;,
 671       *        &quot;tab&quot;: &quot;General&quot;
 672       *        },
 673       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 674       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 675       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 676       *        &quot;errorType&quot;, &quot;field&quot;,
 677       *        &quot;tab&quot;: &quot;General&quot;
 678       *        }]
 679       * }
 680       *
 681       */
 682      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 683      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 684              @PathVariable Map&lt;String, String&gt; pathVars,
 685              @PathVariable(value = &quot;id&quot;) String id,
 686              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 687              RedirectAttributes ra) throws Exception {
 688  
 689          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 690  
 691          JsonResponse json = new JsonResponse(response);
 692          if (result.hasErrors()) {
 693              populateJsonValidationErrors(entityForm, result, json);
 694          }
 695          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 696          if (CollectionUtils.isNotEmpty(dirtyList)) {
 697              json.with(&quot;dirty&quot;, dirtyList);
 698          }
 699  
 700          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 701          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 701          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 702          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 703              return resultHolder.getResult();
 704          }
 705  
 706          return json.done();
 707      }
 708  
<abbr title=" 709      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 709      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 710          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 711          String sectionKey = getSectionKey(pathVars);
 712          String sectionClassName = getClassNameForSection(sectionKey);
 713          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 714          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 714          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 715          ClassMetadata cmd = null;
 716          Entity entity = null;
 717          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 718          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 719  
 720          for (Property p: entity.getProperties()) {
 721              if (p.getIsDirty()) {
 722                  dirtyList.add(p.getName());
 723              }
 724          }
 725          return dirtyList;
 726      }
 727  
 728      /**
 729       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 730       * error fields highlighted. On a successful save, it will refresh the entity page.
 731       *
 732       * @param request
 733       * @param response
 734       * @param model
 735       * @param pathVars
 736       * @param id
 737       * @param entityForm
 738       * @param result
 739       * @return the return view path
 740       * @throws Exception
 741       */
 742      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 743      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 744              @PathVariable  Map&lt;String, String&gt; pathVars,
 745              @PathVariable(value=&quot;id&quot;) String id,
 746              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 747              RedirectAttributes ra) throws Exception {
 748          String sectionKey = getSectionKey(pathVars);
 749          String sectionClassName = getClassNameForSection(sectionKey);
 750          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 751          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 751          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 752          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 753  
 754          extractDynamicFormFields(cmd, entityForm);
 755  
<abbr title=" 756          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 756          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 757          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 758  
 759          entityFormValidator.validate(entityForm, entity, result);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 760 +</span>
 761          if (result.hasErrors()) {
 762              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 763              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 764  
<abbr title=" 765              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 765              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 766              entityForm.clearFieldsMap();
 767              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 768  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 769 -            if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -                modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -                modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 774 +            modifyEntityForm(entity, entityForm, pathVars);</span>
 775  
 776              model.addAttribute(&quot;entity&quot;, entity);
 777              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 778  
 779              setModelAttributes(model, sectionKey);
 780  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -            if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -                entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 783 -                model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 784 -                model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 785 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 786 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 787 -                model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 788 -                model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 789 -                return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 790 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 791 +            return resolveAppropriateEntityView(request, model, entityForm);</span>
 792          }
 793  
 794          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 795  
 796          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 797 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 798 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 799 +    protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 800 +            final Map&lt;String, String&gt; pathVars) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 801 +        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 802 +            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 803 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 804 +            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 805 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 806 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 807 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 808 +    protected String resolveAppropriateEntityView(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 809 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 810 +            final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 811 +        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +            entityForm.setReadOnly();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 813 +            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +            return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 819 +            return DEFAULT_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 820 +        }</span>
 821      }
 822  
 823      /**
 824       * Attempts to remove the given entity.
 825       *
 826       * @param request
 827       * @param response
 828       * @param model
 829       * @param pathVars
 830       * @param id
 831       * @return the return view path
 832       * @throws Exception
 833       */
 834      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 835      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 836              @PathVariable  Map&lt;String, String&gt; pathVars,
 837              @PathVariable(value=&quot;id&quot;) String id,
 838              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 839              RedirectAttributes ra) throws Exception {
 840          String sectionKey = getSectionKey(pathVars);
 841          String sectionClassName = getClassNameForSection(sectionKey);
 842          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 843  
<abbr title=" 844          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 844          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 845          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 846          // Removal does not normally return an Entity unless there is some validation error
 847          if (entity != null) {
 848              entityFormValidator.validate(entityForm, entity, result);
 849              if (result.hasErrors()) {
 850                  // Create a flash attribute for the unsuccessful delete
 851                  FlashMap fm = new FlashMap();
 852                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 853                  fm.put(&quot;headerFlashAlert&quot;, true);
 854                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 855  
 856                  // Re-look back up the entity so that we can return something populated
<abbr title=" 857                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 857                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 858                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 859                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 860                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 860                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 861                  entityForm.clearFieldsMap();
 862                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 863                  modifyEntityForm(entityForm, pathVars);
 864  
 865                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 866                          .done();
 867              }
 868          }
 869  
 870          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 871          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 872  
 873          if (isAjaxRequest(request)) {
 874              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 875              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 876          } else {
 877              return &quot;redirect:/&quot; + sectionKey;
 878          }
 879      }
 880  
 881      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 882      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 882      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 883              @PathVariable  Map&lt;String, String&gt; pathVars,
 884              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 885              @RequestParam String ids,
 886              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 887          String sectionKey = getSectionKey(pathVars);
 888          String sectionClassName = getClassNameForSection(sectionKey);
 889          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 890          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 890          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 891          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 892          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 893          FieldMetadata md = collectionProperty.getMetadata();
 894  
 895          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 896          ppr.setStartIndex(getStartIndex(requestParams));
 897          ppr.setMaxIndex(getMaxIndex(requestParams));
 898  
 899          if (md instanceof BasicFieldMetadata) {
 900              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 901              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 902  
 903              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 904              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 905  
 906              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 907              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 908  
 909              for (Entity e : drs.getRecords()) {
 910                  String id = e.getPMap().get(idProp).getValue();
 911                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 912  
 913                  if (StringUtils.isBlank(disp)) {
 914                      disp = e.getPMap().get(displayProp).getValue();
 915                  }
 916  
 917                  returnMap.put(id,  disp);
 918              }
 919  
 920              return returnMap;
 921          }
 922  
 923          return null;
 924      }
 925  
 926      /**
<abbr title=" 927       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 927       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 928       * then this method is invoked when a user clicks on the name of the default category field.
 929       *
 930       * @param request
 931       * @param response
 932       * @param model
 933       * @param pathVars
 934       * @param collectionField
 935       * @param id
 936       * @return
 937       * @throws Exception
 938       */
 939      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 940      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 941              @PathVariable  Map&lt;String, String&gt; pathVars,
 942              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 943              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 944          String sectionKey = getSectionKey(pathVars);
 945          String mainClassName = getClassNameForSection(sectionKey);
 946          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 947          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 947          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 948          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 949          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 950  
<abbr title=" 951          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 951          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 952          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 952          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 953          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 954          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 955          return viewEntityForm(request, response, model, varsForField, id);
 956      }
 957  
 958      @RequestMapping(
 959              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 960              method = RequestMethod.POST
 961      )
 962      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 963                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 964                                          @PathVariable(value=&quot;id&quot;) String id,
 965                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 966                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 967                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 968                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 968                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 969  
<abbr title=" 970          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 970          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 971      }
 972  
 973  
 974      @RequestMapping(
 975              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view/{tab:[0-9]+}/{tabName}&quot;,
 976              method = RequestMethod.POST
 977      )
<abbr title=" 978      public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 978      public String viewReadOnlyCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
 979                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 980                                          @PathVariable(value=&quot;id&quot;) String id,
 981                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 982                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 983                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 984                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 984                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 985  
<abbr title=" 986          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 986          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 987      }
 988  
 989  
 990      /**
 991       * Returns the records for a given collectionField filtered by a particular criteria
 992       *
 993       * @param request
 994       * @param response
 995       * @param model
 996       * @param pathVars
 997       * @param collectionField
 998       * @param requestParams
 999       * @return the return view path
1000       * @throws Exception
1001       */
1002      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
1003      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
1004              @PathVariable  Map&lt;String, String&gt; pathVars,
1005              @PathVariable(value=&quot;id&quot;) String id,
1006              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1007              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1008          String sectionKey = getSectionKey(pathVars);
1009          String mainClassName = getClassNameForSection(sectionKey);
1010          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1011          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);">1011          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
1012          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1013          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1014  
1015          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
1016          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1017  
1018          // Next, we must get the new list grid that represents this collection
<abbr title="1019          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);">1019          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
1020          model.addAttribute(&quot;listGrid&quot;, listGrid);
1021  
1022          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1023  
1024          // We return the new list grid so that it can replace the currently visible one
1025          setModelAttributes(model, sectionKey);
1026          return &quot;views/standaloneListGrid&quot;;
1027      }
1028  
1029      /**
<abbr title="1030       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes">1030       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
1031       * of this call depending on the type of the specified collection field.
1032       *
1033       * &lt;ul&gt;
1034       *  &lt;li&gt;
<abbr title="1035       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may">1035       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title="1036       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute.">1036       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
1037       *  &lt;/li&gt;
1038       *  &lt;li&gt;
<abbr title="1039       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it.">1039       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
1040       *    Used by fields such as &quot;allParentCategories&quot;.
1041       *  &lt;/li&gt;
1042       *  &lt;li&gt;
<abbr title="1043       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1043       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title="1044       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation">1044       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title="1045       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order.">1045       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
1046       *  &lt;/li&gt;
1047       *  &lt;li&gt;
<abbr title="1048       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1048       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title="1049       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified">1049       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title="1050       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition">1050       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
1051       *    to linking an entity, provide extra fields, such as a promotional message.
1052       *  &lt;/li&gt;
1053       *  &lt;li&gt;
<abbr title="1054       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is">1054       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title="1055       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another">1055       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
1056       *    entity. Used by fields such as the mediaMap on a Sku.
1057       *  &lt;/li&gt;
1058       *
1059       * @param request
1060       * @param response
1061       * @param model
1062       * @param pathVars
1063       * @param id
1064       * @param collectionField
1065       * @param requestParams
1066       * @return the return view path
1067       * @throws Exception
1068       */
1069      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
1070      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1071              @PathVariable Map&lt;String, String&gt; pathVars,
1072              @PathVariable(value = &quot;id&quot;) String id,
1073              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1074              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1075          String sectionKey = getSectionKey(pathVars);
1076          String mainClassName = getClassNameForSection(sectionKey);
1077          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1078          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1079                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1080          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1081          FieldMetadata md = collectionProperty.getMetadata();
1082  
1083          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1084                  .withFilterAndSortCriteria(getCriteria(requestParams))
1085                  .withStartIndex(getStartIndex(requestParams))
1086                  .withMaxIndex(getMaxIndex(requestParams))
1087                  .withLastId(getLastId(requestParams))
1088                  .withFirstId(getFirstId(requestParams))
1089                  .withUpperCount(getUpperCount(requestParams))
1090                  .withLowerCount(getLowerCount(requestParams))
1091                  .withPageSize(getPageSize(requestParams))
1092                  .withPresentationFetch(true);
1093  
1094          if (md instanceof BasicCollectionMetadata) {
1095              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1096              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
1097                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1098                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
1099                  // for this entity.
1100                  String entityType = null;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1101 +</span>
1102                  if (requestParams.containsKey(&quot;entityType&quot;)) {
1103                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
1104                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1106 +                entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1107 +</span>
1108                  if (StringUtils.isBlank(entityType)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1109 -                    if (cmd.getPolymorphicEntities().getChildren().length == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1110 -                        entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1111 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1112 -                        entityType = getDefaultEntityType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1113 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1114 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1115 -                    entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1116 +                    return getModalForBlankEntityType(request, model, sectionKey, cmd);</span>
1117                  }
1118  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1119 -                if (StringUtils.isBlank(entityType)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1120 -                    List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1121 -                    model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1122 -                    model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1123 -                    model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1124 -                    String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1125 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {">1125 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1126 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());">1126 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1127 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1128 -                    model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1129 -                    model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1130 -                    setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1131 -                    return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1132 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1133 -                    ppr = ppr.withCeilingEntityClassname(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1134 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1135 +                ppr = ppr.withCeilingEntityClassname(entityType);</span>
1136              }
1137          } else if (md instanceof MapMetadata) {
<abbr title="1138              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1138              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
1139              if (result.equals(ExtensionResultStatusType.HANDLED)) {
1140                  model.addAttribute(&quot;entityId&quot;, id);
1141                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1142                  model.addAttribute(&quot;collectionField&quot;, collectionField);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1143 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1144 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1145 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1147 -        //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1148 +                return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1149 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1150 +        }</span>
1151  
1152          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1153  
<abbr title="1154          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1154          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>





















1155      }
1156  
<abbr title="1157      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1157      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title="1158      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1158      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
1159              @PathVariable Map&lt;String, String&gt; pathVars,
1160              @PathVariable(value=&quot;id&quot;) String id,
1161              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1162              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1163          String sectionKey = getSectionKey(pathVars);
1164          String mainClassName = getClassNameForSection(sectionKey);
1165          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1166          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1166          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1167          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1168          FieldMetadata md = collectionProperty.getMetadata();
1169          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1170          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1171              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1171              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1172                      collectionField,
1173                      collectionItemId, responseMap);
1174          }
1175          return responseMap;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1176 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1177 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1178 +    protected String getModalForBlankEntityType(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1179 +                                                final Model model, final String sectionKey, final ClassMetadata cmd) {">1179 +                                                final Model model, final String sectionKey, final ClassMetadata cmðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1180 +        final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1181 +        model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1182 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1183 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1184 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1185 +        String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1186 +        final String contextPath = request.getContextPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1187 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1188 +        if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1189 +            requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1190 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1191 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1192 +        model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1193 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1194 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1195 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1196 +        return MODAL_CONTAINER_VIEW;</span>
1197      }
1198  
1199      /**
1200       *
1201       * @param request
1202       * @param response
1203       * @param model
1204       * @param pathVars
1205       * @param id
1206       * @param collectionField
1207       * @param requestParams
1208       * @return Json collection data
1209       * @throws Exception
1210       */
1211      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1212      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1212      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1213              @PathVariable Map&lt;String, String&gt; pathVars,
1214              @PathVariable(value = &quot;id&quot;) String id,
1215              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1216              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1217          String sectionKey = getSectionKey(pathVars);
1218          String mainClassName = getClassNameForSection(sectionKey);
1219          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1220          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1221                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1222          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1223          FieldMetadata md = collectionProperty.getMetadata();
1224  
1225          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1226                  .withFilterAndSortCriteria(getCriteria(requestParams))
1227                  .withStartIndex(getStartIndex(requestParams))
1228                  .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1229          String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1229          String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCrðŸ”µ</abbr>
1230                  .toArray(String[]::new);
1231          ppr = ppr.withCustomCriteria( both);
1232  
1233          if (md instanceof AdornedTargetCollectionMetadata) {
1234              ppr.setOperationTypesOverride(null);
1235              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1236              ppr.setSectionEntityField(collectionField);
1237          }
1238  
1239          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1240  
1241          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1242      }
1243  
1244      protected String[] buildSelectizeCustomCriteria() {
1245          return new String[]{ IS_SELECTIZE_REQUEST };
1246      }
1247  
1248      /**
1249       * Adds the requested collection item via Selectize
1250       *
1251       * @param request
1252       * @param response
1253       * @param model
1254       * @param pathVars
1255       * @param id
1256       * @param collectionField
1257       * @param entityForm
1258       * @return the return view path
1259       * @throws Exception
1260       */
1261      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1262      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1262      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1263              @PathVariable Map&lt;String, String&gt; pathVars,
1264              @PathVariable(value=&quot;id&quot;) String id,
1265              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1266              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1267          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1268          String sectionKey = getSectionKey(pathVars);
1269          String mainClassName = getClassNameForSection(sectionKey);
1270          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1271          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1271          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1272          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1273  
1274          if (StringUtils.isBlank(entityForm.getEntityType())) {
1275              FieldMetadata fmd = collectionProperty.getMetadata();
1276              if (fmd instanceof BasicCollectionMetadata) {
1277                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1278              }
1279          }
1280  
<abbr title="1281          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1281          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1282          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1283          declareShouldIgnoreAdditionStatusFilter();
1284          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1285  
1286          // First, we must save the collection entity
<abbr title="1287          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1287          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1288          Entity savedEntity = persistenceResponse.getEntity();
1289          entityFormValidator.validate(entityForm, savedEntity, result);
1290  
1291          if (result.hasErrors()) {
1292              returnVal.put(&quot;error&quot;, result.getFieldError());
1293              return returnVal;
1294          }
1295  
1296          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1297              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1298          }
1299          return returnVal;
1300      }
1301  
1302      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1303          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1303          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1304          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1305      }
1306  
1307      /**
1308       * Adds the requested collection item
1309       *
1310       * @param request
1311       * @param response
1312       * @param model
1313       * @param pathVars
1314       * @param id
1315       * @param collectionField
1316       * @param entityForm
1317       * @return the return view path
1318       * @throws Exception
1319       */
1320      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1321      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1322              @PathVariable Map&lt;String, String&gt; pathVars,
1323              @PathVariable(value=&quot;id&quot;) String id,
1324              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1325              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1326          String sectionKey = getSectionKey(pathVars);
1327          String mainClassName = getClassNameForSection(sectionKey);
1328          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1329          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1329          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1330          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1331  
1332          if (StringUtils.isBlank(entityForm.getEntityType())) {
1333              FieldMetadata fmd = collectionProperty.getMetadata();
1334              if (fmd instanceof BasicCollectionMetadata) {
1335                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1336              }
1337          }
1338  
<abbr title="1339          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1339          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1340          declareShouldIgnoreAdditionStatusFilter();
1341          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1342          service.clearEntityManager();

1343          // First, we must save the collection entity
<abbr title="1344          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1344          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1345          Entity savedEntity = persistenceResponse.getEntity();
1346          entityFormValidator.validate(entityForm, savedEntity, result);
1347  
1348          if (result.hasErrors()) {
1349              FieldMetadata md = collectionProperty.getMetadata();
1350              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1351              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1351              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1352                      md, ppr, entityForm, savedEntity);
1353          }
1354  
1355          // Next, we must get the new list grid that represents this collection
<abbr title="1356          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1356          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1357          model.addAttribute(&quot;listGrid&quot;, listGrid);
1358  
1359          // We return the new list grid so that it can replace the currently visible one
1360          model.addAttribute(&quot;actualEntityId&quot;, id);
1361          setModelAttributes(model, sectionKey);
1362          return &quot;views/standaloneListGrid&quot;;
1363      }
1364  
1365      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1366      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1366      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1367              @PathVariable Map&lt;String, String&gt; pathVars,
1368              @PathVariable(value=&quot;id&quot;) String id,
1369              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1370              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1371          String sectionKey = getSectionKey(pathVars);
1372          String mainClassName = getClassNameForSection(sectionKey);
1373          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1374          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1374          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1375          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1376  
1377          if (StringUtils.isBlank(entityForm.getEntityType())) {
1378              FieldMetadata fmd = collectionProperty.getMetadata();
1379              if (fmd instanceof BasicCollectionMetadata) {
1380                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1381              }
1382          }
1383  
<abbr title="1384          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1384          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1385          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1386          entity.setIsPreAdd(true);
1387          // First, we must save the collection entity
<abbr title="1388          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1388          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1389          Entity savedEntity = persistenceResponse.getEntity();
1390  
1391          return new JsonResponse(response)
1392                  .with(&quot;status&quot;, &quot;complete&quot;)
1393                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1394                  .done();
1395      }
1396  
1397      /**
<abbr title="1398       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1398       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1399       * as well as after a POST with validation errors
1400       *
1401       * @param request
1402       * @param model
1403       * @param id
1404       * @param collectionField
1405       * @param sectionKey
1406       * @param collectionProperty
1407       * @param md
1408       * @param ppr
1409       * @return the appropriate view to display for the modal
<abbr title="1410       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1410       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1411       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1411       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1412       * @throws ServiceException
1413       */
1414      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1415              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1416              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1416              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1417  
<abbr title="1418          // For requests to add a new collection item include the main class that the subsequent request comes from.">1418          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1419          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1419          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1420          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1421          // fixes all cases.
1422          String mainClassName = getClassNameForSection(sectionKey);
1423          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1424          ppr.setAddOperationInspect(true);
1425  
1426          if (entityForm != null) {
1427              entityForm.clearFieldsMap();
1428          }
1429          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1430          if (md instanceof BasicCollectionMetadata) {
1431              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1432  
1433              // When adding items to basic collections, we will sometimes show a form to persist a new record
1434              // and sometimes show a list grid to allow the user to associate an existing record.
1435              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1436                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1436                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1437                  if (entityForm == null) {
1438                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1439                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1440                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1441                  } else {
1442                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1443                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1444                  }
<abbr title="1445                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1445                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1446                  entityForm.getTabs().iterator().next().getIsVisible();
1447  
1448                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1449                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1450              } else {
1451                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1452                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1452                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1453                  listGrid.setPathOverride(request.getRequestURL().toString());
1454  
<abbr title="1455                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1455                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1456                      listGrid.removeAllRowActions();
1457                  }
1458  
1459                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1460                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1461              }
1462          } else if (md instanceof AdornedTargetCollectionMetadata) {
1463              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1464  
<abbr title="1465              // Even though this field represents an adorned target collection, the list we want to show in the modal">1465              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1466              // is the standard list grid for the target entity of this field
1467              ppr.setOperationTypesOverride(null);
1468              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1469              ppr.setSectionEntityField(collectionField);
1470  
<abbr title="1471              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1471              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1472  
1473              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1474              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1474              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1475              listGrid.setSubCollectionFieldName(collectionField);
1476              listGrid.setPathOverride(request.getRequestURL().toString());
1477              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1478              if (entityForm == null) {
<abbr title="1479                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1479                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1480                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1481              } else {
<abbr title="1482                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1482                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1483                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1484              }
1485  
1486              listGrid.setListGridType(ListGrid.Type.ADORNED);
1487              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1488                  if (entry.getValue().getIsVisible()) {
1489                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1490                      break;
1491                  }
1492              }
1493  
1494              // This is part of an add, so we want to be able to filter/sort the listgrid
1495              listGrid.setIsSortable(false);
1496              listGrid.setCanFilterAndSort(true);
1497              listGrid.removeAllRowActions();
1498  
1499              model.addAttribute(&quot;listGrid&quot;, listGrid);
1500              model.addAttribute(&quot;entityForm&quot;, entityForm);
1501              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1502          } else if (md instanceof MapMetadata) {
1503              MapMetadata fmd = (MapMetadata) md;
<abbr title="1504              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1504              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1505  
1506              if (entityForm == null) {
1507                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1508              } else {
1509                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1510                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1511              }
1512              model.addAttribute(&quot;entityForm&quot;, entityForm);
1513              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1514          }
1515  
1516          // Set the parent id on the entity form
1517          if (entityForm != null) {
1518              entityForm.setParentId(id);
1519          }
1520  
1521          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1522          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1523          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1524          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1525 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1526 +        return MODAL_CONTAINER_VIEW;</span>
1527      }
1528  
1529      /**
1530       * Shows the appropriate modal dialog to edit the selected collection item
1531       *
1532       * @param request
1533       * @param response
1534       * @param model
1535       * @param pathVars
1536       * @param id
1537       * @param collectionField
1538       * @param collectionItemId
1539       * @return the return view path
1540       * @throws Exception
1541       */
<abbr title="1542      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1542      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1543      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1544              @PathVariable  Map&lt;String, String&gt; pathVars,
1545              @PathVariable(value=&quot;id&quot;) String id,
1546              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1547              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1548              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1549          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1549          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1550                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1551      }
1552  
1553      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1554      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1555              @PathVariable  Map&lt;String, String&gt; pathVars,
1556              @PathVariable(value=&quot;id&quot;) String id,
1557              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1558              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1559          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1560                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1561      }
1562  
1563      /**
<abbr title="1564       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1564       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1565       *
1566       * @param request
1567       * @param response
1568       * @param model
1569       * @param pathVars
1570       * @param id
1571       * @param collectionField
1572       * @param collectionItemId
1573       * @return the return view path
1574       * @throws Exception
1575       */
<abbr title="1576      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1576      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1577      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1578              @PathVariable  Map&lt;String, String&gt; pathVars,
1579              @PathVariable(value=&quot;id&quot;) String id,
1580              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1581              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1582              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1583          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1583          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1584                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1585  
1586          // Since this is a read-only view, actions don&#x27;t make sense in this context
1587          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1588          addAuditableDisplayFields(ef);
1589          ef.removeAllActions();
1590          ef.setReadOnly();
1591  
1592          return returnPath;
1593      }
1594  
1595      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1596      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1597              @PathVariable  Map&lt;String, String&gt; pathVars,
1598              @PathVariable(value=&quot;id&quot;) String id,
1599              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1600              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1601          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1601          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1602                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1603  
1604          // Since this is a read-only view, actions don&#x27;t make sense in this context
1605          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1606          ef.removeAllActions();
1607          ef.setReadOnly();
1608  
1609          return returnPath;
1610      }
1611  
<abbr title="1612      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1612      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1613              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1613              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1614          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1614          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1615      }
1616  
<abbr title="1617      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1617      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1618              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1618              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1619          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1619          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1620      }
1621  
<abbr title="1622      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1622      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1623                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1623                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1624          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1624          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1625      }
1626  
1627      /**
<abbr title="1628       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1628       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1629       * which are optional. If they are not passed in then they are automatically looked up
1630       *
1631       * @param request
1632       * @param model
1633       * @param pathVars
1634       * @param id
1635       * @param collectionField
1636       * @param collectionItemId
1637       * @param modalHeaderType
1638       * @param entityForm
1639       * @param entity
1640       * @return
1641       * @throws ServiceException
1642       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1643 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1643 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1644 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1644 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1645 +    protected String showViewUpdateCollection(HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1646 +            Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1647 +            Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1648 +            String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1649 +            String collectionField,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1650 +            String collectionItemId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1651 +            String alternateId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1652 +            String modalHeaderType,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1653 +            EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1654 +            Entity entity) throws ServiceException {</span>
1655          String sectionKey = getSectionKey(pathVars);
1656          String mainClassName = getClassNameForSection(sectionKey);
1657          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1658          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1658          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1659          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1660          FieldMetadata md = collectionProperty.getMetadata();
1661          SectionCrumb nextCrumb = new SectionCrumb();
1662          if (md instanceof MapMetadata) {
1663              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1664          } else {
1665              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1666          }
1667          nextCrumb.setSectionId(collectionItemId);
1668          if (!sectionCrumbs.contains(nextCrumb)) {
1669              sectionCrumbs.add(nextCrumb);
1670          }
1671  
<abbr title="1672          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1672          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1673          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1673          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1674  
1675          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1676  
1677          if (md instanceof BasicCollectionMetadata &amp;&amp;
1678                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1679                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1680              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1681  
<abbr title="1682              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1682              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1683              if (entity == null) {
<abbr title="1684                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1684                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1685              }
1686  
1687              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1688              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1688              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1689 -            if (entityForm == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1690 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1690 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1691 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1692 -                entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1693 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1693 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1694 -                //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1695 -                entityForm.removeAllActions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1696 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1697 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1698 +            entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1699 +                    subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1700 +</span>
1701              entityForm.removeAction(DefaultEntityFormActions.DELETE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1702 +            entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1703 +</span>
1704              addAuditableDisplayFields(entityForm);
1705              model.addAttribute(&quot;entityForm&quot;, entityForm);
1706              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1707          } else if (md instanceof AdornedTargetCollectionMetadata) {
1708              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1709  
1710              if (entity == null) {
1711                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1712                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1713              }
1714  
1715              boolean populateTypeAndId = true;
1716              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1717              if (entityForm == null) {
<abbr title="1718                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1718                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1719                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1720                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1721              } else {
1722                  entityForm.clearFieldsMap();
1723                  String entityType = entityForm.getEntityType();
<abbr title="1724                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1724                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1725                  entityForm.setEntityType(entityType);
1726                  populateTypeAndId = false;
1727              }
1728  
1729              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1730              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1730              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1731                      collectionField,
1732                      collectionItemId, responseMap);
1733  
<abbr title="1734              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1734              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1735              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1736              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1737              entityForm.setTranslationId(alternateId);
1738  
1739              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1740              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1741                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1742                      continue;
1743                  }
1744                  Property p = cmd.getPMap().get(field);
1745                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1746                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1746                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1747                      // directly on the first adorned target collection. Because of this, we need the actual id property">1747                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1748                      // from the entity that models the adorned target relationship, and not the id of the target object.">1748                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1749                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1749                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1750                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1751                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1752  
<abbr title="1753                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1753                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1754                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1755                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1756  
1757                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1758                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1758                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1759                      } else {
<abbr title="1760                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1760                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1761                      }
1762                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1763                      // See above comment for AdornedTargetCollectionMetadata
1764                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1765  
<abbr title="1766                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1766                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1767                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1768                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1769  
<abbr title="1770                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1770                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1771                              mmd.getTargetClass(), sectionCrumbs);
1772                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1773  
1774                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1775                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1775                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1776                      } else {
<abbr title="1777                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1777                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1778                      }
1779                  }
1780              }
1781  
1782              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1783              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1784  
1785              boolean atLeastOneBasicField = false;
1786              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1787                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1787                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1788                      atLeastOneBasicField = true;
1789                      break;
1790                  }
1791              }
1792              if (!atLeastOneBasicField) {
1793                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1794              }
1795              addAuditableDisplayFields(entityForm);
1796              model.addAttribute(&quot;entityForm&quot;, entityForm);
1797              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1798          } else if (md instanceof MapMetadata) {
1799              MapMetadata fmd = (MapMetadata) md;
1800  
<abbr title="1801              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1801              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1802              if (entity == null) {
1803                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1804                      collectionItemId, sectionCrumbs, null).getEntity();
1805              }
1806  
1807              boolean populateTypeAndId = true;
1808              if (entityForm == null) {
1809                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1810              } else {
1811                  //save off the prior key before clearing out the fields map as it will not appear
1812                  //back on the saved entity
1813                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1814                  entityForm.clearFieldsMap();
1815                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1816                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1817                  populateTypeAndId = false;
1818              }
1819              try {
<abbr title="1820                  entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmd.getToOneTargetProperty()).getType().getName());">1820                  entityForm.setTranslationCeilingEntity(Class.forName(fmd.getValueClassName()).getDeclaredField(fmdðŸ”µ</abbr>



1821              } catch (Exception e) {
1822                  LOG.error(e);
1823              }
<abbr title="1824              String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.id&quot;);">1824              String entityId = (fmd.getToOneTargetProperty().equals(&quot;&quot;) ? &quot;id&quot; : fmd.getToOneTargetProperty() + &quot;.iðŸ”µ</abbr>
1825              entityForm.setTranslationId(entity.getPMap().get(entityId).getValue());
1826              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1827              formService.populateMapEntityFormFields(entityForm, entity);
1828              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1829              formService.populateMapEntityFormFields(entityForm, entity);
1830              addAuditableDisplayFields(entityForm);
1831              model.addAttribute(&quot;entityForm&quot;, entityForm);
1832              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1833          }
1834  
1835          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1836          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1837          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1838          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1839 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1840 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1841 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1842 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1843 +    protected EntityForm reinitializeEntityForm(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1844 +            final ClassMetadata collectionMetadata,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1845 +            final Entity entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1846 +            final Map&lt;String, DynamicResultSet&gt; subRecordsMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1847 +            final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1848 +        if (entityForm == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1849 +            return formService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1850 +                    .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1851 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1852 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1853 +        entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1854 +        formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1855 +                sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1856 +        //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1857 +        entityForm.removeAllActions();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1858 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1859 +        return entityForm;</span>
1860      }
1861  
1862      /**
1863       * Updates the specified collection item
1864       *
1865       * @param request
1866       * @param response
1867       * @param model
1868       * @param pathVars
1869       * @param id
1870       * @param collectionField
<abbr title="1871       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1871       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1872       * @param entityForm
1873       * @param result
1874       * @return the return view path
1875       * @throws Exception
1876       */
1877      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1878      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1879              @PathVariable  Map&lt;String, String&gt; pathVars,
1880              @PathVariable(value=&quot;id&quot;) String id,
1881              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1882              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1883              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1884              BindingResult result) throws Exception {
<abbr title="1885          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1885          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1886      }
1887  
1888      /**
1889       * Updates the specified collection item
1890       *
1891       * @param request
1892       * @param response
1893       * @param model
1894       * @param pathVars
1895       * @param id
1896       * @param collectionField
<abbr title="1897       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1897       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1898       * @param entityForm
<abbr title="1899       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1899       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1900       * @param result
1901       * @return the return view path
1902       * @throws Exception
1903       */
<abbr title="1904      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1904      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1905      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1906              @PathVariable  Map&lt;String, String&gt; pathVars,
1907              @PathVariable(value=&quot;id&quot;) String id,
1908              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1909              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1910              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1911              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1912              BindingResult result) throws Exception {
1913          String sectionKey = getSectionKey(pathVars);
1914          String mainClassName = getClassNameForSection(sectionKey);
1915          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1916          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1916          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1917          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1918  
<abbr title="1919          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1919          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1920          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1921          service.clearEntityManager();
1922          // First, we must save the collection entity
<abbr title="1923          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1923          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1924          Entity savedEntity = persistenceResponse.getEntity();
1925          entityFormValidator.validate(entityForm, savedEntity, result);
1926  
1927          if (result.hasErrors()) {
<abbr title="1928              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1928              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1929                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1930          }
1931  
1932          // Next, we must get the new list grid that represents this collection
1933          // We return the new list grid so that it can replace the currently visible one
<abbr title="1934          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1934          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1935  
1936          model.addAttribute(&quot;listGrid&quot;, listGrid);
1937          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1938          setModelAttributes(model, sectionKey);
1939          return &quot;views/standaloneListGrid&quot;;
1940      }
1941  
1942      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1943      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1944              HttpServletResponse response, Model model,
1945              @PathVariable  Map&lt;String, String&gt; pathVars,
1946              @PathVariable(value=&quot;id&quot;) String id,
1947              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1948              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1949              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1950          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1950          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1951      }
1952  
1953      /**
1954       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1955       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1956       *
1957       * @param request
1958       * @param response
1959       * @param model
1960       * @param pathVars
1961       * @param id
1962       * @param collectionField
1963       * @param collectionItemId
1964       * @return an object explaining the state of the operation
1965       * @throws Exception
1966       */
<abbr title="1967      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1967      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1968      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1969              HttpServletResponse response, Model model,
1970              @PathVariable  Map&lt;String, String&gt; pathVars,
1971              @PathVariable(value=&quot;id&quot;) String id,
1972              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1973              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1974              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1975              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1976          String sectionKey = getSectionKey(pathVars);
1977          String mainClassName = getClassNameForSection(sectionKey);
1978          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1979          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1979          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1980          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1981          FieldMetadata md = collectionProperty.getMetadata();
1982  
<abbr title="1983          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1983          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1984          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1985  
<abbr title="1986          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1986          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1987  
1988          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1989  
1990          if (md instanceof AdornedTargetCollectionMetadata) {
1991              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1992              AdornedTargetList atl = ppr.getAdornedList();
1993  
1994              // Get an entity form for the entity
<abbr title="1995              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1995              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
1996              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1997                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
1998                      .getDynamicResultSet().getRecords()[0];
1999              formService.populateEntityFormFields(entityForm, entity);
2000              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
2001  
<abbr title="2002              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">2002              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
2003              int sequenceValue = Integer.parseInt(newSequence) + 1;
2004              Field field = entityForm.findField(atl.getSortField());
2005              field.setValue(String.valueOf(sequenceValue));
2006  
2007              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2008              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">2008              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
2009              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
2010  
2011              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2012              responseMap.put(&quot;field&quot;, collectionField);
2013              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2014              return responseMap;
2015          } else if (md instanceof BasicCollectionMetadata) {
2016              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
2017              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="2018              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">2018              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
2019  
<abbr title="2020              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">2020              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
2021              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
<abbr title="2022              boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">2022              boolean listGridReadOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentðŸ”µ</abbr>
2023              if(listGridReadOnly){
2024                          throw new SecurityServiceException();
2025              }
2026              if (!StringUtils.isEmpty(cd.getSortProperty())) {
2027                  Field f = new Field()
2028                          .withName(cd.getSortProperty())
2029                          .withFieldType(SupportedFieldType.HIDDEN.toString());
2030                  entityForm.addHiddenField(mainMetadata, f);
2031              }
2032              formService.populateEntityFormFields(entityForm, entity);
2033  
2034              if (!StringUtils.isEmpty(cd.getSortProperty())) {
2035                  int sequenceValue = Integer.parseInt(newSequence) + 1;
2036                  Field field = entityForm.findField(cd.getSortProperty());
2037                  field.setValue(String.valueOf(sequenceValue));
2038              }
2039  
<abbr title="2040              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">2040              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
2041              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
2042  
2043              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2044              responseMap.put(&quot;field&quot;, collectionField);
2045              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2046              return responseMap;
2047          } else {
<abbr title="2048              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">2048              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
2049          }
2050      }
2051  
2052      /**
2053       * Removes the requested collection item
2054       *
<abbr title="2055       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2055       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2056       * map collection.
2057       *
2058       * @param request
2059       * @param response
2060       * @param model
2061       * @param pathVars
2062       * @param id
2063       * @param collectionField
2064       * @param collectionItemId
2065       * @return the return view path
2066       * @throws Exception
2067       */
2068      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
2069      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2070              @PathVariable  Map&lt;String, String&gt; pathVars,
2071              @PathVariable(value=&quot;id&quot;) String id,
2072              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2073              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="2074          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">2074          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
2075      }
2076  
2077      /**
2078       * Removes the requested collection item
2079       *
<abbr title="2080       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2080       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2081       * map collection.
2082       *
2083       * @param request
2084       * @param response
2085       * @param model
2086       * @param pathVars
2087       * @param id
2088       * @param collectionField
2089       * @param collectionItemId
2090       * @return the return view path
2091       * @throws Exception
2092       */
<abbr title="2093      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">2093      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
2094      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2095              @PathVariable  Map&lt;String, String&gt; pathVars,
2096              @PathVariable(value=&quot;id&quot;) String id,
2097              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2098              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2099              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2100          String sectionKey = getSectionKey(pathVars);
2101          String mainClassName = getClassNameForSection(sectionKey);
2102          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2103          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2103          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
2104          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2105  
2106          String priorKey = request.getParameter(&quot;key&quot;);
2107  
<abbr title="2108          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2108          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
2109          declareShouldIgnoreAdditionStatusFilter();
2110          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
2111          service.clearEntityManager();
2112          // First, we must remove the collection entity
<abbr title="2113          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">2113          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
2114          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
2115              String error = &quot;There was an error removing the whatever&quot;;
2116              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
2117                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="2118                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">2118                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
2119              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
2120                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2121              }
2122              return new JsonResponse(response)
2123                  .with(&quot;status&quot;, &quot;error&quot;)
2124                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2125                  .done();
2126          }
2127  
2128          // Next, we must get the new list grid that represents this collection
2129          // We return the new list grid so that it can replace the currently visible one
<abbr title="2130          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2130          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
2131  
2132          model.addAttribute(&quot;listGrid&quot;, listGrid);
2133          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2134          setModelAttributes(model, sectionKey);
2135          return &quot;views/standaloneListGrid&quot;;
2136      }
2137  
2138      public void addAuditableDisplayFields(EntityForm entityForm) {
2139          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2140          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2141              addAuditableDisplayField(entityForm, createdBy);
2142  
2143              createdBy.setIsVisible(false);
2144          }
2145          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2146          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2147              addAuditableDisplayField(entityForm, updatedBy);
2148  
2149              updatedBy.setIsVisible(false);
2150          }
2151      }
2152  
2153      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2154          Field displayField = buildAuditableDisplayField(userField);
2155  
2156          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2157          String userName = user == null ? null : user.getName();
2158          displayField.setValue(userName);
2159  
2160          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2161          if (auditGroup != null) {
2162              auditGroup.addField(displayField);
2163          }
2164      }
2165  
2166      private Field buildAuditableDisplayField(Field auditableField) {
2167          return new Field().withFieldType(SupportedFieldType.STRING.toString())
2168                  .withName(auditableField.getName() + &quot;Display&quot;)
2169                  .withFriendlyName(auditableField.getFriendlyName())
2170                  .withOrder(auditableField.getOrder())
2171                  .withOwningEntityClass(auditableField.getOwningEntityClass())
2172                  .withReadOnly(true);
2173      }
2174  
2175      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2176          String tabName = pathVars.get(&quot;tabName&quot;);
2177          if (StringUtils.isBlank(tabName)) {
2178              TabMetadata firstTab = cmd.getFirstTab();
2179              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2180          }
2181          return tabName;
2182      }
2183  







2184      // *****************************************
2185      // Typed Entity Helper Methods
2186      // *****************************************
2187  
2188      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2189          // Check if this is a typed entity
2190          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2191          if (typedEntitySection != null) {
2192              // Update the friendly name for this Entity Type
2193              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2194          }
2195      }
2196  
2197      // *********************************
2198      // ADDITIONAL SPRING-BOUND METHODS *
2199      // *********************************
2200  
2201      /**
2202       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="2203       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2203       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
2204       * or false. If the value is passed in as null, it will treat it as false.
2205       *
2206       * @param binder
2207       */
2208      @InitBinder
2209      public void initBinder(WebDataBinder binder) {
2210          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2211          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2212      }
2213  
2214  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            