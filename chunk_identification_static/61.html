<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>61</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    61
                    <a href="60.html">prev</a>
                    <a href="62.html">next</a>
                    <a href="61_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_ce886921a652b2ea1ded6e36a0748360e01c007f_aria/src/main/java/com/arialyy/aria/core/upload/UploadTask.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;ce886921a652b2ea1ded6e36a0748360e01c007f:aria/src/main/java/com/arialyy/aria/core/upload/UploadTask.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;ce886921a652b2ea1ded6e36a0748360e01c007f^1:aria/src/main/java/com/arialyy/aria/core/upload/UploadTask.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;ce886921a652b2ea1ded6e36a0748360e01c007f^2:aria/src/main/java/com/arialyy/aria/core/upload/UploadTask.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;84ce7e06974326b39f68f3f23fd64570bcdb9bdc:aria/src/main/java/com/arialyy/aria/core/upload/UploadTask.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj]], subset: [[b], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.upload;
  17 
  18 import android.content.Context;
  19 import android.os.Handler;
  20 import android.util.Log;
  21 import com.arialyy.aria.core.AriaManager;
  22 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.inf.AbsTask;</span>
  24 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.arialyy.aria.core.Aria;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.arialyy.aria.core.AriaManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.arialyy.aria.core.download.DownloadEntity;</span>
  28 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import com.arialyy.aria.core.inf.AbsNormalTask;</span>
  30 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  31 import com.arialyy.aria.core.inf.IEntity;
  32 import com.arialyy.aria.core.scheduler.ISchedulers;
  33 import com.arialyy.aria.util.CommonUtil;
  34 import java.lang.ref.WeakReference;
  35 
  36 /**
  37  * Created by lyy on 2017/2/23.
  38  * 上传任务
  39  */
  40 public class UploadTask extends AbsNormalTask&lt;UploadEntity&gt; {
  41   private static final String TAG = &quot;UploadTask&quot;;
  42 
  43   private UploadUtil mUtil;
  44   private UListener mListener;
  45 
  46   private UploadTask(UploadTaskEntity taskEntity, Handler outHandler) {
  47     mOutHandler = outHandler;
  48     mEntity = taskEntity.getEntity();
  49     mListener = new UListener(mOutHandler, this);
  50     mUtil = new UploadUtil(taskEntity, mListener);
  51   }
  52 
  53   @Override public String getKey() {
  54     return mEntity.getFilePath();
  55   }
  56 
  57   @Override public boolean isRunning() {
  58     return mUtil.isRunning();
  59   }
  60 
  61   @Override public void start() {
  62     if (mUtil.isRunning()) {
  63       Log.d(TAG, &quot;任务正在下载&quot;);
  64     } else {
  65       if (mListener == null) {
  66         mListener = new UploadTask.UListener(mOutHandler, this);
  67       }
  68       mUtil.start();
  69     }
  70   }
  71 
  72   @Override public void stop() {
  73 
  74   }
  75 
  76   @Override public void cancel() {
  77 
  78     if (!mEntity.isComplete()) {
  79       // 如果任务不是下载状态
  80       mUtil.cancel();
  81       mEntity.deleteData();
  82       if (mOutHandler != null) {
  83         mOutHandler.obtainMessage(ISchedulers.CANCEL, this).sendToTarget();
  84       }
  85     }
  86   }
  87 
  88   private static class
  89   UListener extends UploadListener {
  90     WeakReference&lt;Handler&gt; outHandler;
  91     WeakReference&lt;UploadTask&gt; task;
  92     long lastLen = 0;   //上一次发送长度
  93     long lastTime = 0;
  94     long INTERVAL_TIME = 1000;   //1m更新周期
  95     boolean isFirst = true;
  96     UploadEntity entity;
  97     boolean isConvertSpeed = false;
  98     Context context;
  99 
 100     UListener(Handler outHandle, UploadTask task) {
 101       this.outHandler = new WeakReference&lt;&gt;(outHandle);
 102       this.task = new WeakReference&lt;&gt;(task);
 103       entity = this.task.get().getEntity();
 104       context = AriaManager.APP;
 105       final AriaManager manager = AriaManager.getInstance(context);
 106       isConvertSpeed = manager.getUploadConfig().isConvertSpeed();
 107     }
 108 
 109     @Override public void onPre() {
 110       sendInState2Target(ISchedulers.PRE);
 111       saveData(IEntity.STATE_PRE, -1);
 112     }
 113 
 114     @Override public void onPostPre(long fileSize) {
 115       super.onPostPre(fileSize);
 116       entity.setFileSize(fileSize);
 117       sendInState2Target(ISchedulers.POST_PRE);
 118       saveData(IEntity.STATE_POST_PRE, 0);
 119     }
 120 
 121     @Override public void onStart() {
 122       sendInState2Target(ISchedulers.START);
 123       saveData(IEntity.STATE_RUNNING, 0);
 124     }
 125 
 126     @Override public void onResume(long resumeLocation) {
 127 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128       uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129       sendInState2Target(ISchedulers.RESUME);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130       sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
 131 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     @Override public void onPostPre(long fileSize) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133       super.onPostPre(fileSize);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134       uploadEntity.setFileSize(fileSize);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135       uploadEntity.setState(IEntity.STATE_POST_PRE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136       sendIntent(Aria.ACTION_POST_PRE, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137       sendInState2Target(ISchedulers.POST_PRE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     @Override public void onStart() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141       uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142       sendIntent(Aria.ACTION_START, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143       sendInState2Target(ISchedulers.START);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     @Override public void onResume(long resumeLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147       uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149       sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150       saveData(IEntity.STATE_RUNNING, resumeLocation);</span>
 151 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 152     }
 153 
 154     @Override public void onStop(long stopLocation) {
 155 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156       uploadEntity.setState(IEntity.STATE_STOP);</span>
 157 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158       sendInState2Target(ISchedulers.POST_PRE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     @Override public void onStart() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162       uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163       sendIntent(Aria.ACTION_START, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164       sendInState2Target(ISchedulers.START);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167     @Override public void onResume(long resumeLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168       uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169       sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170       sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
 173 =======
 174 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 175       handleSpeed(0);
 176 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177       sendInState2Target(ISchedulers.STOP);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178       sendIntent(Aria.ACTION_STOP, stopLocation);</span>
 179 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     @Override public void onStart() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183       uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184       sendIntent(Aria.ACTION_START, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185       sendInState2Target(ISchedulers.START);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     @Override public void onResume(long resumeLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189       uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190       sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191       sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194     @Override public void onStop(long stopLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195       uploadEntity.setState(DownloadEntity.STATE_STOP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196       handleSpeed(0);</span>
 197 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198       sendInState2Target(DownloadSchedulers.STOP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199       saveData(IEntity.STATE_STOP, stopLocation);</span>
 200 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 201     }
 202 
 203     @Override public void onProgress(long currentLocation) {
 204       if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {
 205         long speed = currentLocation - lastLen;
 206         lastTime = System.currentTimeMillis();
 207         if (isFirst) {
 208           speed = 0;
 209           isFirst = false;
 210         }
 211         handleSpeed(speed);
 212         entity.setCurrentProgress(currentLocation);
 213         lastLen = currentLocation;
 214 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         sendInState2Target(ISchedulers.RUNNING);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         AriaManager.APP.sendBroadcast(sendIntent);</span>
 217 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218       uploadEntity.setState(DownloadEntity.STATE_STOP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220       sendInState2Target(DownloadSchedulers.STOP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221       sendIntent(Aria.ACTION_STOP, stopLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224     @Override public void onProgress(long currentLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225       if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226         long speed = currentLocation - lastLen;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227         sendIntent.putExtra(Aria.CURRENT_LOCATION, currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228         sendIntent.putExtra(Aria.CURRENT_SPEED, speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         lastTime = System.currentTimeMillis();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         if (isFirst) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231           speed = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232           isFirst = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234         handleSpeed(speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236         lastLen = currentLocation;</span>
 237 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         sendInState2Target(DownloadSchedulers.RUNNING);</span>
 239 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 240       }
 241     }
 242 
 243     @Override public void onCancel() {
 244 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245       uploadEntity.setState(IEntity.STATE_CANCEL);</span>
 246 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248     @Override public void onProgress(long currentLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249       if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         long speed = currentLocation - lastLen;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         sendIntent.putExtra(Aria.CURRENT_LOCATION, currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252         sendIntent.putExtra(Aria.CURRENT_SPEED, speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         lastTime = System.currentTimeMillis();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254         if (isFirst) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255           speed = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256           isFirst = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         handleSpeed(speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260         lastLen = currentLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262         AriaManager.APP.sendBroadcast(sendIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 </span>
 266 =======
 267 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 268       handleSpeed(0);
 269 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270       sendInState2Target(ISchedulers.CANCEL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272       uploadEntity.deleteData();</span>
 273 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274     @Override public void onProgress(long currentLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275       if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276         long speed = currentLocation - lastLen;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277         sendIntent.putExtra(Aria.CURRENT_LOCATION, currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278         sendIntent.putExtra(Aria.CURRENT_SPEED, speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279         lastTime = System.currentTimeMillis();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280         if (isFirst) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281           speed = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282           isFirst = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284         handleSpeed(speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286         lastLen = currentLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         AriaManager.APP.sendBroadcast(sendIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292     @Override public void onCancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295       sendInState2Target(DownloadSchedulers.CANCEL);</span>
 296 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298       saveData(IEntity.STATE_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299       entity.deleteData();</span>
 300 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 301     }
 302 
 303     @Override public void onComplete() {
 304 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305       uploadEntity.setState(IEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306       uploadEntity.setComplete(true);</span>
 307 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         if (isFirst) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309           speed = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310           isFirst = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312         handleSpeed(speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         lastLen = currentLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316         AriaManager.APP.sendBroadcast(sendIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320     @Override public void onCancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325       uploadEntity.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328     @Override public void onComplete() {</span>
 329 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330       entity.setComplete(true);</span>
 331 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 332       handleSpeed(0);
 333 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334       sendInState2Target(ISchedulers.COMPLETE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335       sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
 336 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337           isFirst = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         handleSpeed(speed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341         lastLen = currentLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         AriaManager.APP.sendBroadcast(sendIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347     @Override public void onCancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352       uploadEntity.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355     @Override public void onComplete() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356       uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       uploadEntity.setComplete(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358       handleSpeed(0);</span>
 359 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360       sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361       saveData(IEntity.STATE_COMPLETE, entity.getFileSize());</span>
 362 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 363     }
 364 
 365     @Override public void onFail() {
 366 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367       uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368       uploadEntity.setState(IEntity.STATE_FAIL);</span>
 369 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         AriaManager.APP.sendBroadcast(sendIntent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375     @Override public void onCancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380       uploadEntity.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383     @Override public void onComplete() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384       uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385       uploadEntity.setComplete(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387       sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388       sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391     @Override public void onFail() {</span>
 392 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393       entity.setFailNum(entity.getFailNum() + 1);</span>
 394 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 395       handleSpeed(0);
 396 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 397       sendInState2Target(ISchedulers.FAIL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 398       sendIntent(Aria.ACTION_FAIL, -1);</span>
 399 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403     @Override public void onCancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408       uploadEntity.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411     @Override public void onComplete() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412       uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413       uploadEntity.setComplete(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415       sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416       sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419     @Override public void onFail() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420       uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421       uploadEntity.setState(DownloadEntity.STATE_FAIL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422       handleSpeed(0);</span>
 423 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424       sendInState2Target(DownloadSchedulers.FAIL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425       saveData(IEntity.STATE_FAIL, -1);</span>
 426 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 427     }
 428 
 429     private void handleSpeed(long speed) {
 430       if (isConvertSpeed) {
 431         entity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);
 432       } else {
 433         entity.setSpeed(speed);
 434       }
 435     }
 436 
 437     /**
 438      * 将任务状态发送给下载器
 439      *
 440      * @param state {@link ISchedulers#START}
 441      */
 442     private void sendInState2Target(int state) {
 443       if (outHandler.get() != null) {
 444         outHandler.get().obtainMessage(state, task.get()).sendToTarget();
 445       }
 446     }
 447 
 448     private void saveData(int state, long location) {
 449       entity.setState(state);
 450       entity.setComplete(state == IEntity.STATE_COMPLETE);
 451       entity.setCurrentProgress(location);
 452       entity.update();
 453     }
 454   }
 455 
 456   public static class Builder {
 457     private Handler mOutHandler;
 458     private UploadTaskEntity mTaskEntity;
 459     private String mTargetName;
 460 
 461     public void setOutHandler(ISchedulers outHandler) {
 462       mOutHandler = new Handler(outHandler);
 463     }
 464 
 465     public void setUploadTaskEntity(UploadTaskEntity taskEntity) {
 466       mTaskEntity = taskEntity;
 467     }
 468 
 469     public void setTargetName(String targetName) {
 470       mTargetName = targetName;
 471     }
 472 
 473     public Builder() {
 474 
 475     }
 476 
 477     public UploadTask build() {
 478       UploadTask task = new UploadTask(mTaskEntity, mOutHandler);
 479       task.setTargetName(mTargetName);
 480       return task;
 481     }
 482   }
 483 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.upload;
  17 
  18 import android.content.Context;
  19 import android.os.Handler;
  20 import android.util.Log;
  21 import com.arialyy.aria.core.AriaManager;
  22 import com.arialyy.aria.core.inf.AbsNormalTask;
  23 import com.arialyy.aria.core.inf.IEntity;
  24 import com.arialyy.aria.core.scheduler.ISchedulers;
  25 import com.arialyy.aria.util.CommonUtil;
  26 import java.lang.ref.WeakReference;
  27 
  28 /**
  29  * Created by lyy on 2017/2/23.
  30  * 上传任务
  31  */
  32 public class UploadTask extends AbsNormalTask&lt;UploadEntity&gt; {
  33   private static final String TAG = &quot;UploadTask&quot;;
  34 
  35   private UploadUtil mUtil;
  36   private UListener mListener;
  37 
  38   private UploadTask(UploadTaskEntity taskEntity, Handler outHandler) {
  39     mOutHandler = outHandler;
  40     mEntity = taskEntity.getEntity();
  41     mListener = new UListener(mOutHandler, this);
  42     mUtil = new UploadUtil(taskEntity, mListener);
  43   }
  44 
  45   @Override public String getKey() {
  46     return mEntity.getFilePath();
  47   }
  48 
  49   @Override public boolean isRunning() {
  50     return mUtil.isRunning();
  51   }
  52 
  53   @Override public void start() {
  54     if (mUtil.isRunning()) {
  55       Log.d(TAG, &quot;任务正在下载&quot;);
  56     } else {
  57       if (mListener == null) {
  58         mListener = new UploadTask.UListener(mOutHandler, this);
  59       }
  60       mUtil.start();
  61     }
  62   }
  63 
  64   @Override public void stop() {
  65 
  66   }
  67 
  68   @Override public void cancel() {
  69 
  70     if (!mEntity.isComplete()) {
  71       // 如果任务不是下载状态
  72       mUtil.cancel();
  73       mEntity.deleteData();
  74       if (mOutHandler != null) {
  75         mOutHandler.obtainMessage(ISchedulers.CANCEL, this).sendToTarget();
  76       }
  77     }
  78   }
  79 
  80   private static class UListener extends UploadListener {
  81     WeakReference&lt;Handler&gt; outHandler;
  82     WeakReference&lt;UploadTask&gt; task;
  83     long lastLen = 0;   //上一次发送长度
  84     long lastTime = 0;
  85     long INTERVAL_TIME = 1000;   //1m更新周期
  86     boolean isFirst = true;
  87     UploadEntity entity;
  88     boolean isConvertSpeed = false;
  89     Context context;
  90 
  91     UListener(Handler outHandle, UploadTask task) {
  92       this.outHandler = new WeakReference&lt;&gt;(outHandle);
  93       this.task = new WeakReference&lt;&gt;(task);
  94       entity = this.task.get().getEntity();
  95       context = AriaManager.APP;
  96       final AriaManager manager = AriaManager.getInstance(context);
  97       isConvertSpeed = manager.getUploadConfig().isConvertSpeed();
  98     }
  99 
 100     @Override public void onPre() {
 101       sendInState2Target(ISchedulers.PRE);
 102       saveData(IEntity.STATE_PRE, -1);
 103     }
 104 
 105     @Override public void onPostPre(long fileSize) {
 106       super.onPostPre(fileSize);
 107       entity.setFileSize(fileSize);
 108       sendInState2Target(ISchedulers.POST_PRE);
 109       saveData(IEntity.STATE_POST_PRE, 0);
 110     }
 111 
 112     @Override public void onStart() {
 113       sendInState2Target(ISchedulers.START);
 114       saveData(IEntity.STATE_RUNNING, 0);
 115     }
 116 
 117     @Override public void onResume(long resumeLocation) {
 118 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119       uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120       sendInState2Target(ISchedulers.RESUME);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121       sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
 122 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123       uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124       sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125       sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
 126 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127       sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128       saveData(IEntity.STATE_RUNNING, resumeLocation);</span>
 129 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 130     }
 131 
 132     @Override public void onStop(long stopLocation) {
 133 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134       uploadEntity.setState(IEntity.STATE_STOP);</span>
 135 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136       uploadEntity.setState(DownloadEntity.STATE_STOP);</span>
 137 =======
 138 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 139       handleSpeed(0);
 140 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141       sendInState2Target(ISchedulers.STOP);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142       sendIntent(Aria.ACTION_STOP, stopLocation);</span>
 143 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145       sendInState2Target(DownloadSchedulers.STOP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146       sendIntent(Aria.ACTION_STOP, stopLocation);</span>
 147 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148       sendInState2Target(DownloadSchedulers.STOP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149       saveData(IEntity.STATE_STOP, stopLocation);</span>
 150 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 151     }
 152 
 153     @Override public void onProgress(long currentLocation) {
 154       if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {
 155         long speed = currentLocation - lastLen;
 156         lastTime = System.currentTimeMillis();
 157         if (isFirst) {
 158           speed = 0;
 159           isFirst = false;
 160         }
 161         handleSpeed(speed);
 162         entity.setCurrentProgress(currentLocation);
 163         lastLen = currentLocation;
 164 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         sendInState2Target(ISchedulers.RUNNING);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         AriaManager.APP.sendBroadcast(sendIntent);</span>
 167 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         lastLen = currentLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         AriaManager.APP.sendBroadcast(sendIntent);</span>
 172 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173         sendInState2Target(DownloadSchedulers.RUNNING);</span>
 174 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 175       }
 176     }
 177 
 178     @Override public void onCancel() {
 179 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180       uploadEntity.setState(IEntity.STATE_CANCEL);</span>
 181 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182       uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
 183 =======
 184 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 185       handleSpeed(0);
 186 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187       sendInState2Target(ISchedulers.CANCEL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189       uploadEntity.deleteData();</span>
 190 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193       sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194       uploadEntity.deleteData();</span>
 195 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196       sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197       saveData(IEntity.STATE_CANCEL, -1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198       entity.deleteData();</span>
 199 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 200     }
 201 
 202     @Override public void onComplete() {
 203 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204       uploadEntity.setState(IEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205       uploadEntity.setComplete(true);</span>
 206 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207       uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208       uploadEntity.setComplete(true);</span>
 209 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210       entity.setComplete(true);</span>
 211 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 212       handleSpeed(0);
 213 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214       sendInState2Target(ISchedulers.COMPLETE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215       sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
 216 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218       sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219       sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
 220 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221       sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222       saveData(IEntity.STATE_COMPLETE, entity.getFileSize());</span>
 223 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 224     }
 225 
 226     @Override public void onFail() {
 227 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228       uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229       uploadEntity.setState(IEntity.STATE_FAIL);</span>
 230 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231       uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232       uploadEntity.setState(DownloadEntity.STATE_FAIL);</span>
 233 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234       entity.setFailNum(entity.getFailNum() + 1);</span>
 235 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 236       handleSpeed(0);
 237 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238       sendInState2Target(ISchedulers.FAIL);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239       sendIntent(Aria.ACTION_FAIL, -1);</span>
 240 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241       handleSpeed(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242       sendInState2Target(DownloadSchedulers.FAIL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243       sendIntent(Aria.ACTION_FAIL, -1);</span>
 244 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245       sendInState2Target(DownloadSchedulers.FAIL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246       saveData(IEntity.STATE_FAIL, -1);</span>
 247 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 248     }
 249 
 250     private void handleSpeed(long speed) {
 251       if (isConvertSpeed) {
 252         entity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);
 253       } else {
 254         entity.setSpeed(speed);
 255       }
 256     }
 257 
 258     /**
 259      * 将任务状态发送给下载器
 260      *
 261      * @param state {@link ISchedulers#START}
 262      */
 263     private void sendInState2Target(int state) {
 264       if (outHandler.get() != null) {
 265         outHandler.get().obtainMessage(state, task.get()).sendToTarget();
 266       }
 267     }
 268 
 269     private void saveData(int state, long location) {
 270       entity.setState(state);
 271       entity.setComplete(state == IEntity.STATE_COMPLETE);
 272       entity.setCurrentProgress(location);
 273       entity.update();
 274     }
 275   }
 276 
 277   public static class Builder {
 278     private Handler mOutHandler;
 279     private UploadTaskEntity mTaskEntity;
 280     private String mTargetName;
 281 
 282     public void setOutHandler(ISchedulers outHandler) {
 283       mOutHandler = new Handler(outHandler);
 284     }
 285 
 286     public void setUploadTaskEntity(UploadTaskEntity taskEntity) {
 287       mTaskEntity = taskEntity;
 288     }
 289 
 290     public void setTargetName(String targetName) {
 291       mTargetName = targetName;
 292     }
 293 
 294     public Builder() {
 295 
 296     }
 297 
 298     public UploadTask build() {
 299       UploadTask task = new UploadTask(mTaskEntity, mOutHandler);
 300       task.setTargetName(mTargetName);
 301       return task;
 302     }
 303   }
 304 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.upload;
  17 
  18 import android.content.Context;
  19 import android.os.Handler;
  20 import android.util.Log;
  21 import com.arialyy.aria.core.AriaManager;
  22 import com.arialyy.aria.core.inf.AbsNormalTask;
  23 import com.arialyy.aria.core.inf.IEntity;
  24 import com.arialyy.aria.core.scheduler.ISchedulers;
  25 import com.arialyy.aria.util.CommonUtil;
  26 import java.lang.ref.WeakReference;
  27 
  28 
  29 /**
  30  * Created by lyy on 2017/2/23.
  31  * 上传任务
  32  */
  33 public class UploadTask extends AbsNormalTask&lt;UploadEntity&gt; {
  34   private static final String TAG = &quot;UploadTask&quot;;
  35 
  36   private UploadUtil mUtil;
  37 
  38   private UListener mListener;
  39 
  40   private UploadTask(UploadTaskEntity taskEntity, Handler outHandler) {
  41     mOutHandler = outHandler;
  42     mEntity = taskEntity.getEntity();
  43     mListener = new UListener(mOutHandler, this);
  44     mUtil = new UploadUtil(taskEntity, mListener);
  45   }
  46 
  47   @Override public String getKey() {
  48     return mEntity.getFilePath();
  49   }
  50 
  51   @Override public boolean isRunning() {
  52     return mUtil.isRunning();
  53   }
  54 
  55   @Override
  56   public void start() {
  57     if (mUtil.isRunning()) {
  58       Log.d(TAG, &quot;任务正在下载&quot;);
  59     } else {
  60       if (mListener == null) {
  61         mListener = new UploadTask.UListener(mOutHandler, this);
  62       }
  63       mUtil.start();
  64     }
  65   }
  66 
  67   @Override public void stop() {
  68 
  69   }
  70 
  71   @Override
  72   public void cancel() {
  73     if (!mEntity.isComplete()) {
  74       // 如果任务不是下载状态
  75       mUtil.cancel();
  76       mEntity.deleteData();
  77       if (mOutHandler != null) {
  78         mOutHandler.obtainMessage(ISchedulers.CANCEL, this).sendToTarget();
  79       }
  80     }
  81   }
  82 
  83   private static class UListener extends UploadListener {
  84     WeakReference&lt;Handler&gt; outHandler;
  85 
  86     WeakReference&lt;UploadTask&gt; task;
  87 
  88     //上一次发送长度
  89     long lastLen = 0;   //上一次发送长度
  90 
  91     long lastTime = 0;
  92 
  93     //1m更新周期
  94     long INTERVAL_TIME = 1000;   //1m更新周期
  95 
  96     boolean isFirst = true;
  97 
  98     UploadEntity entity;
  99 
 100     boolean isConvertSpeed = false;
 101 
 102     Context context;
 103 
 104     UListener(Handler outHandle, UploadTask task) {
 105       this.outHandler = new WeakReference&lt;&gt;(outHandle);
 106       this.task = new WeakReference&lt;&gt;(task);
 107       entity = this.task.get().getEntity();
 108       context = AriaManager.APP;
 109       final AriaManager manager = AriaManager.getInstance(context);
 110       isConvertSpeed = manager.getUploadConfig().isConvertSpeed();
 111     }
 112 
 113     @Override
 114     public void onPre() {
 115       sendInState2Target(ISchedulers.PRE);
 116       saveData(IEntity.STATE_PRE, -1);
 117     }
 118 
 119     @Override
 120     public void onPostPre(long fileSize) {
 121       super.onPostPre(fileSize);
 122       entity.setFileSize(fileSize);
 123       sendInState2Target(ISchedulers.POST_PRE);
 124       saveData(IEntity.STATE_POST_PRE, 0);
 125     }
 126 
 127     @Override
 128     public void onStart() {
 129       sendInState2Target(ISchedulers.START);
 130       saveData(IEntity.STATE_RUNNING, 0);
 131     }
 132 
 133     @Override
 134     public void onResume(long resumeLocation) {
 135       sendInState2Target(ISchedulers.RESUME);
 136       saveData(IEntity.STATE_RUNNING, resumeLocation);
 137     }
 138 
 139     @Override
 140     public void onStop(long stopLocation) {
 141       handleSpeed(0);
 142       sendInState2Target(ISchedulers.STOP);
 143       saveData(IEntity.STATE_STOP, stopLocation);
 144     }
 145 
 146     @Override
 147     public void onProgress(long currentLocation) {
 148       if ((System.currentTimeMillis() - lastTime) &gt; INTERVAL_TIME) {
 149         long speed = currentLocation - lastLen;
 150         lastTime = System.currentTimeMillis();
 151         if (isFirst) {
 152           speed = 0;
 153           isFirst = false;
 154         }
 155         handleSpeed(speed);
 156         entity.setCurrentProgress(currentLocation);
 157         lastLen = currentLocation;
 158         sendInState2Target(ISchedulers.RUNNING);
 159       }
 160     }
 161 
 162     @Override
 163     public void onCancel() {
 164       handleSpeed(0);
 165       sendInState2Target(ISchedulers.CANCEL);
 166       saveData(IEntity.STATE_CANCEL, -1);
 167       entity.deleteData();
 168     }
 169 
 170     @Override
 171     public void onComplete() {
 172       entity.setComplete(true);
 173       handleSpeed(0);
 174       sendInState2Target(ISchedulers.COMPLETE);
 175       saveData(IEntity.STATE_COMPLETE, entity.getFileSize());
 176     }
 177 
 178     @Override
 179     public void onFail() {
 180       entity.setFailNum(entity.getFailNum() + 1);
 181       handleSpeed(0);
 182       sendInState2Target(ISchedulers.FAIL);
 183       saveData(IEntity.STATE_FAIL, -1);
 184     }
 185 
 186     private void handleSpeed(long speed) {
 187       if (isConvertSpeed) {
 188         entity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);
 189       } else {
 190         entity.setSpeed(speed);
 191       }
 192     }
 193 
 194     /**
 195      * 将任务状态发送给下载器
 196      *
 197      * @param state {@link DownloadSchedulers#START}
 198      */
 199     private void sendInState2Target(int state) {
 200       if (outHandler.get() != null) {
 201         outHandler.get().obtainMessage(state, task.get()).sendToTarget();
 202       }
 203     }
 204 
 205     private void saveData(int state, long location) {
 206       entity.setState(state);
 207       entity.setComplete(state == IEntity.STATE_COMPLETE);
 208       entity.setCurrentProgress(location);
 209       entity.update();
 210     }
 211   }
 212 
 213   public static class Builder {
 214     private Handler mOutHandler;
 215 
 216     private UploadTaskEntity mTaskEntity;
 217 
 218     private String mTargetName;
 219 
 220     public void setOutHandler(ISchedulers outHandler) {
 221       mOutHandler = new Handler(outHandler);
 222     }
 223 
 224     public void setUploadTaskEntity(UploadTaskEntity taskEntity) {
 225       mTaskEntity = taskEntity;
 226     }
 227 
 228     public void setTargetName(String targetName) {
 229       mTargetName = targetName;
 230     }
 231 
 232     public Builder() {
 233     }
 234 
 235     public UploadTask build() {
 236       UploadTask task = new UploadTask(mTaskEntity, mOutHandler);
 237       task.setTargetName(mTargetName);
 238       return task;
 239     }
 240   }
 241 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core.upload;
  17  
  18  import android.content.Context;
  19  import android.content.Intent;
  20  import android.os.Handler;
  21  import android.util.Log;
  22  import com.arialyy.aria.core.Aria;
  23  import com.arialyy.aria.core.AriaManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.download.DownloadEntity;</span>
  25  import com.arialyy.aria.core.inf.AbsTask;

  26  import com.arialyy.aria.core.inf.IEntity;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.arialyy.aria.core.scheduler.DownloadSchedulers;</span>
  28  import com.arialyy.aria.core.scheduler.ISchedulers;
  29  import com.arialyy.aria.util.CommonUtil;
  30  import java.lang.ref.WeakReference;
  31  
  32  /**
  33   * Created by lyy on 2017/2/23.
  34   * 上传任务
  35   */
  36  public class UploadTask extends AbsTask&lt;UploadTaskEntity, UploadEntity&gt; {

  37    private static final String TAG = &quot;UploadTask&quot;;
  38    private Handler mOutHandler;
  39  
  40    private UploadUtil mUtil;
  41    private UListener mListener;
  42  
  43    private UploadTask(UploadTaskEntity taskEntity, Handler outHandler) {
  44      mOutHandler = outHandler;
  45      mEntity = taskEntity.uploadEntity;

  46      mListener = new UListener(mOutHandler, this);
  47      mUtil = new UploadUtil(taskEntity, mListener);
  48    }
  49  
  50    @Override public String getKey() {
  51      return mEntity.getFilePath();
  52    }
  53  
  54    @Override public boolean isRunning() {
  55      return mUtil.isRunning();
  56    }
  57  
  58    @Override public void start() {
  59      if (mUtil.isRunning()) {
  60        Log.d(TAG, &quot;任务正在下载&quot;);
  61      } else {
  62        if (mListener == null) {
  63          mListener = new UploadTask.UListener(mOutHandler, this);
  64        }
  65        mUtil.start();
  66      }
  67    }
  68  
  69    @Override public void stop() {
  70  
  71    }
  72  
  73    @Override public void cancel() {
  74  
  75      if (!mEntity.isComplete()) {
  76        // 如果任务不是下载状态
  77        mUtil.cancel();
  78        mEntity.deleteData();
  79        if (mOutHandler != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        mOutHandler.obtainMessage(DownloadSchedulers.CANCEL, this).sendToTarget();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +        mOutHandler.obtainMessage(ISchedulers.CANCEL, this).sendToTarget();</span>
  82        }
  83        //发送取消下载的广播
  84        Intent intent = CommonUtil.createIntent(AriaManager.APP.getPackageName(), Aria.ACTION_CANCEL);
  85        intent.putExtra(Aria.UPLOAD_ENTITY, mEntity);
  86        AriaManager.APP.sendBroadcast(intent);
  87      }
  88    }
  89  
  90    private static class UListener extends UploadListener {





  91      WeakReference&lt;Handler&gt; outHandler;
  92      WeakReference&lt;UploadTask&gt; task;
  93      long lastLen = 0;   //上一次发送长度
  94      long lastTime = 0;
  95      long INTERVAL_TIME = 1000;   //1m更新周期
  96      boolean isFirst = true;
  97      UploadEntity uploadEntity;
  98      Intent sendIntent;
  99      boolean isOpenBroadCast = false;

 100      boolean isConvertSpeed = false;
 101      Context context;
 102  
 103      UListener(Handler outHandle, UploadTask task) {
 104        this.outHandler = new WeakReference&lt;&gt;(outHandle);
 105        this.task = new WeakReference&lt;&gt;(task);
 106        uploadEntity = this.task.get().getEntity();
 107        sendIntent = CommonUtil.createIntent(AriaManager.APP.getPackageName(), Aria.ACTION_RUNNING);
 108        sendIntent.putExtra(Aria.UPLOAD_ENTITY, uploadEntity);

 109        context = AriaManager.APP;
 110        final AriaManager manager = AriaManager.getInstance(context);
 111        isOpenBroadCast = manager.getUploadConfig().isOpenBreadCast();
 112        isConvertSpeed = manager.getUploadConfig().isConvertSpeed();
 113      }
 114  
 115      @Override public void onPre() {
 116        uploadEntity.setState(IEntity.STATE_PRE);
 117        sendIntent(Aria.ACTION_PRE, -1);
 118        sendInState2Target(ISchedulers.PRE);

 119      }
 120  
 121      @Override public void onPostPre(long fileSize) {
 122        super.onPostPre(fileSize);
 123        uploadEntity.setFileSize(fileSize);
 124        uploadEntity.setState(IEntity.STATE_POST_PRE);
 125        sendIntent(Aria.ACTION_POST_PRE, 0);

 126        sendInState2Target(ISchedulers.POST_PRE);

 127      }
 128  
 129      @Override public void onStart() {
 130        uploadEntity.setState(IEntity.STATE_RUNNING);
 131        sendIntent(Aria.ACTION_START, 0);
 132        sendInState2Target(ISchedulers.START);

 133      }
 134  
 135      @Override public void onResume(long resumeLocation) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -      uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -      sendInState2Target(DownloadSchedulers.RESUME);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +      uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +      sendInState2Target(ISchedulers.RESUME);</span>
 140        sendIntent(Aria.ACTION_RESUME, resumeLocation);

 141      }
 142  
 143      @Override public void onStop(long stopLocation) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -      uploadEntity.setState(DownloadEntity.STATE_STOP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -      handleSpeed(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -      sendInState2Target(DownloadSchedulers.STOP);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +      uploadEntity.setState(IEntity.STATE_STOP);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +      handleSpeed(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +      sendInState2Target(ISchedulers.STOP);</span>
 150        sendIntent(Aria.ACTION_STOP, stopLocation);

 151      }
 152  
 153      @Override public void onProgress(long currentLocation) {
 154        if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {
 155          long speed = currentLocation - lastLen;
 156          sendIntent.putExtra(Aria.CURRENT_LOCATION, currentLocation);
 157          sendIntent.putExtra(Aria.CURRENT_SPEED, speed);
 158          lastTime = System.currentTimeMillis();
 159          if (isFirst) {
 160            speed = 0;
 161            isFirst = false;
 162          }
 163          handleSpeed(speed);
 164          uploadEntity.setCurrentProgress(currentLocation);

 165          lastLen = currentLocation;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        sendInState2Target(DownloadSchedulers.RUNNING);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +        sendInState2Target(ISchedulers.RUNNING);</span>
 168          AriaManager.APP.sendBroadcast(sendIntent);
 169        }
 170      }
 171  
 172      @Override public void onCancel() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -      uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -      handleSpeed(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -      sendInState2Target(DownloadSchedulers.CANCEL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +      uploadEntity.setState(IEntity.STATE_CANCEL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +      handleSpeed(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +      sendInState2Target(ISchedulers.CANCEL);</span>
 179        sendIntent(Aria.ACTION_CANCEL, -1);
 180        uploadEntity.deleteData();


 181      }
 182  
 183      @Override public void onComplete() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -      uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +      uploadEntity.setState(IEntity.STATE_COMPLETE);</span>
 186        uploadEntity.setComplete(true);

 187        handleSpeed(0);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -      sendInState2Target(DownloadSchedulers.COMPLETE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +      sendInState2Target(ISchedulers.COMPLETE);</span>
 190        sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());

 191      }
 192  
 193      @Override public void onFail() {
 194        uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -      uploadEntity.setState(DownloadEntity.STATE_FAIL);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -      handleSpeed(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -      sendInState2Target(DownloadSchedulers.FAIL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +      uploadEntity.setState(IEntity.STATE_FAIL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +      handleSpeed(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +      sendInState2Target(ISchedulers.FAIL);</span>
 201        sendIntent(Aria.ACTION_FAIL, -1);

 202      }
 203  
 204      private void handleSpeed(long speed) {
 205        if (isConvertSpeed) {
 206          uploadEntity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);

 207        } else {
 208          uploadEntity.setSpeed(speed);

 209        }
 210      }
 211  
 212      /**
 213       * 将任务状态发送给下载器
 214       *
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -     * @param state {@link DownloadSchedulers#START}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +     * @param state {@link ISchedulers#START}</span>
 217       */
 218      private void sendInState2Target(int state) {
 219        if (outHandler.get() != null) {
 220          outHandler.get().obtainMessage(state, task.get()).sendToTarget();
 221        }
 222      }
 223  
 224      private void sendIntent(String action, long location) {
 225        uploadEntity.setComplete(action.equals(Aria.ACTION_COMPLETE));
 226        uploadEntity.setCurrentProgress(location);
 227        uploadEntity.update();
 228        if (!isOpenBroadCast) return;
 229        Intent intent = CommonUtil.createIntent(context.getPackageName(), action);
 230        intent.putExtra(Aria.UPLOAD_ENTITY, uploadEntity);
 231        if (location != -1) {
 232          intent.putExtra(Aria.CURRENT_LOCATION, location);
 233        }
 234        context.sendBroadcast(intent);





 235      }
 236    }
 237  
 238    public static class Builder {
 239      private Handler mOutHandler;
 240      private UploadTaskEntity mTaskEntity;
 241      private String mTargetName;
 242  
 243      public void setOutHandler(ISchedulers outHandler) {
 244        mOutHandler = new Handler(outHandler);
 245      }
 246  
 247      public void setUploadTaskEntity(UploadTaskEntity taskEntity) {
 248        mTaskEntity = taskEntity;
 249      }
 250  
 251      public void setTargetName(String targetName) {
 252        mTargetName = targetName;
 253      }
 254  
 255      public Builder() {
 256  
 257      }
 258  
 259      public UploadTask build() {
 260        UploadTask task = new UploadTask(mTaskEntity, mOutHandler);
 261        task.setTargetName(mTargetName);
 262        return task;
 263      }
 264    }
 265  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core.upload;
  17  
  18  import android.content.Context;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.content.Intent;</span>
  20  import android.os.Handler;
  21  import android.util.Log;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.arialyy.aria.core.Aria;</span>
  23  import com.arialyy.aria.core.AriaManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.arialyy.aria.core.inf.AbsTask;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.arialyy.aria.core.inf.AbsNormalTask;</span>
  27  import com.arialyy.aria.core.inf.IEntity;
  28  import com.arialyy.aria.core.scheduler.DownloadSchedulers;
  29  import com.arialyy.aria.core.scheduler.ISchedulers;
  30  import com.arialyy.aria.util.CommonUtil;
  31  import java.lang.ref.WeakReference;
  32  
  33  /**
  34   * Created by lyy on 2017/2/23.
  35   * 上传任务
  36   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -public class UploadTask extends AbsTask&lt;UploadTaskEntity, UploadEntity&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +public class UploadTask extends AbsNormalTask&lt;UploadEntity&gt; {</span>
  39    private static final String TAG = &quot;UploadTask&quot;;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -  private Handler mOutHandler;</span>
  41  
  42    private UploadUtil mUtil;
  43    private UListener mListener;
  44  
  45    private UploadTask(UploadTaskEntity taskEntity, Handler outHandler) {
  46      mOutHandler = outHandler;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -    mEntity = taskEntity.uploadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +    mEntity = taskEntity.getEntity();</span>
  49      mListener = new UListener(mOutHandler, this);
  50      mUtil = new UploadUtil(taskEntity, mListener);
  51    }
  52  
  53    @Override public String getKey() {
  54      return mEntity.getFilePath();
  55    }
  56  
  57    @Override public boolean isRunning() {
  58      return mUtil.isRunning();
  59    }
  60  
  61    @Override public void start() {
  62      if (mUtil.isRunning()) {
  63        Log.d(TAG, &quot;任务正在下载&quot;);
  64      } else {
  65        if (mListener == null) {
  66          mListener = new UploadTask.UListener(mOutHandler, this);
  67        }
  68        mUtil.start();
  69      }
  70    }
  71  
  72    @Override public void stop() {
  73  
  74    }
  75  
  76    @Override public void cancel() {
  77  
  78      if (!mEntity.isComplete()) {
  79        // 如果任务不是下载状态
  80        mUtil.cancel();
  81        mEntity.deleteData();
  82        if (mOutHandler != null) {
  83          mOutHandler.obtainMessage(DownloadSchedulers.CANCEL, this).sendToTarget();

  84        }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -      //发送取消下载的广播</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -      Intent intent = CommonUtil.createIntent(AriaManager.APP.getPackageName(), Aria.ACTION_CANCEL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -      intent.putExtra(Aria.UPLOAD_ENTITY, mEntity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -      AriaManager.APP.sendBroadcast(intent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -  private static class UListener extends UploadListener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +  private static class</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +  UListener extends UploadListener {</span>
  98      WeakReference&lt;Handler&gt; outHandler;
  99      WeakReference&lt;UploadTask&gt; task;
 100      long lastLen = 0;   //上一次发送长度
 101      long lastTime = 0;
 102      long INTERVAL_TIME = 1000;   //1m更新周期
 103      boolean isFirst = true;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -    UploadEntity uploadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    Intent sendIntent;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -    boolean isOpenBroadCast = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +    UploadEntity entity;</span>
 108      boolean isConvertSpeed = false;
 109      Context context;
 110  
 111      UListener(Handler outHandle, UploadTask task) {
 112        this.outHandler = new WeakReference&lt;&gt;(outHandle);
 113        this.task = new WeakReference&lt;&gt;(task);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -      uploadEntity = this.task.get().getEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -      sendIntent = CommonUtil.createIntent(AriaManager.APP.getPackageName(), Aria.ACTION_RUNNING);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -      sendIntent.putExtra(Aria.UPLOAD_ENTITY, uploadEntity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +      entity = this.task.get().getEntity();</span>
 118        context = AriaManager.APP;
 119        final AriaManager manager = AriaManager.getInstance(context);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -      isOpenBroadCast = manager.getUploadConfig().isOpenBreadCast();</span>
 121        isConvertSpeed = manager.getUploadConfig().isConvertSpeed();
 122      }
 123  
 124      @Override public void onPre() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -      uploadEntity.setState(IEntity.STATE_PRE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -      sendIntent(Aria.ACTION_PRE, -1);</span>
 127        sendInState2Target(ISchedulers.PRE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +      saveData(IEntity.STATE_PRE, -1);</span>
 129      }
 130  
 131      @Override public void onPostPre(long fileSize) {
 132        super.onPostPre(fileSize);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -      uploadEntity.setFileSize(fileSize);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -      uploadEntity.setState(IEntity.STATE_POST_PRE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -      sendIntent(Aria.ACTION_POST_PRE, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +      entity.setFileSize(fileSize);</span>
 137        sendInState2Target(ISchedulers.POST_PRE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +      saveData(IEntity.STATE_POST_PRE, 0);</span>
 139      }
 140  
 141      @Override public void onStart() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -      uploadEntity.setState(IEntity.STATE_RUNNING);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -      sendIntent(Aria.ACTION_START, 0);</span>
 144        sendInState2Target(ISchedulers.START);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +      saveData(IEntity.STATE_RUNNING, 0);</span>
 146      }
 147  
 148      @Override public void onResume(long resumeLocation) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -      uploadEntity.setState(DownloadEntity.STATE_RUNNING);</span>
 150        sendInState2Target(DownloadSchedulers.RESUME);


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -      sendIntent(Aria.ACTION_RESUME, resumeLocation);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +      saveData(IEntity.STATE_RUNNING, resumeLocation);</span>
 153      }
 154  
 155      @Override public void onStop(long stopLocation) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -      uploadEntity.setState(DownloadEntity.STATE_STOP);</span>
 157        handleSpeed(0);
 158        sendInState2Target(DownloadSchedulers.STOP);



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -      sendIntent(Aria.ACTION_STOP, stopLocation);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +      saveData(IEntity.STATE_STOP, stopLocation);</span>
 161      }
 162  
 163      @Override public void onProgress(long currentLocation) {
 164        if (System.currentTimeMillis() - lastTime &gt; INTERVAL_TIME) {
 165          long speed = currentLocation - lastLen;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        sendIntent.putExtra(Aria.CURRENT_LOCATION, currentLocation);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        sendIntent.putExtra(Aria.CURRENT_SPEED, speed);</span>
 168          lastTime = System.currentTimeMillis();
 169          if (isFirst) {
 170            speed = 0;
 171            isFirst = false;
 172          }
 173          handleSpeed(speed);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -        uploadEntity.setCurrentProgress(currentLocation);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        entity.setCurrentProgress(currentLocation);</span>
 176          lastLen = currentLocation;
 177          sendInState2Target(DownloadSchedulers.RUNNING);

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -        AriaManager.APP.sendBroadcast(sendIntent);</span>
 179        }
 180      }
 181  
 182      @Override public void onCancel() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -      uploadEntity.setState(DownloadEntity.STATE_CANCEL);</span>
 184        handleSpeed(0);
 185        sendInState2Target(DownloadSchedulers.CANCEL);



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -      sendIntent(Aria.ACTION_CANCEL, -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -      uploadEntity.deleteData();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +      saveData(IEntity.STATE_CANCEL, -1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +      entity.deleteData();</span>
 190      }
 191  
 192      @Override public void onComplete() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -      uploadEntity.setState(DownloadEntity.STATE_COMPLETE);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -      uploadEntity.setComplete(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +      entity.setComplete(true);</span>
 196        handleSpeed(0);
 197        sendInState2Target(DownloadSchedulers.COMPLETE);

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -      sendIntent(Aria.ACTION_COMPLETE, uploadEntity.getFileSize());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +      saveData(IEntity.STATE_COMPLETE, entity.getFileSize());</span>
 200      }
 201  
 202      @Override public void onFail() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -      uploadEntity.setFailNum(uploadEntity.getFailNum() + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -      uploadEntity.setState(DownloadEntity.STATE_FAIL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +      entity.setFailNum(entity.getFailNum() + 1);</span>
 206        handleSpeed(0);
 207        sendInState2Target(DownloadSchedulers.FAIL);



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -      sendIntent(Aria.ACTION_FAIL, -1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +      saveData(IEntity.STATE_FAIL, -1);</span>
 210      }
 211  
 212      private void handleSpeed(long speed) {
 213        if (isConvertSpeed) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        uploadEntity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        entity.setConvertSpeed(CommonUtil.formatFileSize(speed) + &quot;/s&quot;);</span>
 216        } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        uploadEntity.setSpeed(speed);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        entity.setSpeed(speed);</span>
 219        }
 220      }
 221  
 222      /**
 223       * 将任务状态发送给下载器
 224       *
 225       * @param state {@link DownloadSchedulers#START}

 226       */
 227      private void sendInState2Target(int state) {
 228        if (outHandler.get() != null) {
 229          outHandler.get().obtainMessage(state, task.get()).sendToTarget();
 230        }
 231      }
 232  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -    private void sendIntent(String action, long location) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -      uploadEntity.setComplete(action.equals(Aria.ACTION_COMPLETE));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -      uploadEntity.setCurrentProgress(location);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -      uploadEntity.update();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -      if (!isOpenBroadCast) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -      Intent intent = CommonUtil.createIntent(context.getPackageName(), action);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -      intent.putExtra(Aria.UPLOAD_ENTITY, uploadEntity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -      if (location != -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -        intent.putExtra(Aria.CURRENT_LOCATION, location);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -      context.sendBroadcast(intent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +    private void saveData(int state, long location) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +      entity.setState(state);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +      entity.setComplete(state == IEntity.STATE_COMPLETE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +      entity.setCurrentProgress(location);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +      entity.update();</span>
 249      }
 250    }
 251  
 252    public static class Builder {
 253      private Handler mOutHandler;
 254      private UploadTaskEntity mTaskEntity;
 255      private String mTargetName;
 256  
 257      public void setOutHandler(ISchedulers outHandler) {
 258        mOutHandler = new Handler(outHandler);
 259      }
 260  
 261      public void setUploadTaskEntity(UploadTaskEntity taskEntity) {
 262        mTaskEntity = taskEntity;
 263      }
 264  
 265      public void setTargetName(String targetName) {
 266        mTargetName = targetName;
 267      }
 268  
 269      public Builder() {
 270  
 271      }
 272  
 273      public UploadTask build() {
 274        UploadTask task = new UploadTask(mTaskEntity, mOutHandler);
 275        task.setTargetName(mTargetName);
 276        return task;
 277      }
 278    }
 279  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            