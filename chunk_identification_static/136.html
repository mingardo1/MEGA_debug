<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>136</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    136
                    <a href="135.html">prev</a>
                    <a href="137.html">next</a>
                    <a href="136_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_1685c2392fc2c007a04290557d5e1e0d163c5563_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;1685c2392fc2c007a04290557d5e1e0d163c5563:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;1685c2392fc2c007a04290557d5e1e0d163c5563^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;1685c2392fc2c007a04290557d5e1e0d163c5563^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;04d77bda04eb0af8ff637d58bcb982b21e1869ba:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.ActionBar;
  22 import androidx.appcompat.app.ActionBarDrawerToggle;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.app.AppCompatActivity;
  25 import androidx.appcompat.widget.SearchView;
  26 import androidx.appcompat.widget.Toolbar;
  27 import androidx.core.view.GravityCompat;
  28 import androidx.drawerlayout.widget.DrawerLayout;
  29 import androidx.fragment.app.FragmentManager;
  30 import androidx.fragment.app.FragmentTransaction;
  31 import androidx.preference.PreferenceManager;
  32 
  33 import com.automattic.simplenote.analytics.AnalyticsTracker;
  34 import com.automattic.simplenote.models.Note;
  35 import com.automattic.simplenote.models.Tag;
  36 import com.automattic.simplenote.utils.CrashUtils;
  37 import com.automattic.simplenote.utils.DisplayUtils;
  38 import com.automattic.simplenote.utils.DrawableUtils;
  39 import com.automattic.simplenote.utils.HtmlCompat;
  40 import com.automattic.simplenote.utils.PrefUtils;
  41 import com.automattic.simplenote.utils.StrUtils;
  42 import com.automattic.simplenote.utils.TagsAdapter;
  43 import com.automattic.simplenote.utils.ThemeUtils;
  44 import com.automattic.simplenote.utils.UndoBarController;
  45 import com.google.android.material.navigation.NavigationView;
  46 import com.simperium.Simperium;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.Query;
  51 import com.simperium.client.User;
  52 
  53 import org.wordpress.passcodelock.AppLockManager;
  54 
  55 import java.util.ArrayList;
  56 import java.util.Calendar;
  57 import java.util.HashMap;
  58 import java.util.List;
  59 import java.util.Map;
  60 
  61 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  62 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  64 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  65 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  66 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  67 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  68 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  70 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  71 
  72 public class NotesActivity extends AppCompatActivity implements
<abbr title="  73         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  73         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  74         Bucket.Listener&lt;Note&gt; {
  75 
  76     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  77     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  78     protected Bucket&lt;Note&gt; mNotesBucket;
  79     protected Bucket&lt;Tag&gt; mTagsBucket;
  80     private boolean mIsShowingMarkdown;
  81     private boolean mShouldSelectNewNote;
  82     private boolean mIsSettingsClicked;
  83     private boolean mIsTabetFullscreen;
  84 
  85     private String mTabletSearchQuery;
  86     private UndoBarController mUndoBarController;
  87     private View mFragmentsContainer;
  88     private SearchView mSearchView;
  89     private MenuItem mSearchMenuItem;
  90     private NoteListFragment mNoteListFragment;
  91     private NoteEditorFragment mNoteEditorFragment;
  92     private Note mCurrentNote;
  93     private MenuItem mEmptyTrashMenuItem;
  94 
  95     // Menu drawer
  96     private static final int GROUP_PRIMARY = 100;
  97     private static final int GROUP_SECONDARY = 101;
  98     private static final int GROUP_TERTIARY = 102;
  99     private DrawerLayout mDrawerLayout;
 100     private Menu mNavigationMenu;
 101     private ActionBarDrawerToggle mDrawerToggle;
 102     private TagsAdapter mTagsAdapter;
 103     private TagsAdapter.TagMenuItem mSelectedTag;
 104     // Tags bucket listener
 105     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 106         void updateNavigationDrawer() {
 107             runOnUiThread(new Runnable() {
 108                 public void run() {
 109                     updateNavigationDrawerItems();
 110                 }
 111             });
 112         }
 113 
 114         @Override
 115         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 116             updateNavigationDrawer();
 117         }
 118 
 119         @Override
 120         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 121             updateNavigationDrawer();
 122         }
 123 
 124         @Override
 125         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 126             updateNavigationDrawer();
 127         }
 128 
 129         @Override
 130         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 131             // noop
 132         }
 133     };
 134 
 135     @Override
 136     protected void onCreate(Bundle savedInstanceState) {
 137         ThemeUtils.setTheme(this);
 138         super.onCreate(savedInstanceState);
 139 
 140         setContentView(R.layout.activity_notes);
 141 
 142         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 143 
 144         Simplenote currentApp = (Simplenote) getApplication();
 145         if (mNotesBucket == null) {
 146             mNotesBucket = currentApp.getNotesBucket();
 147         }
 148 
 149         if (mTagsBucket == null) {
 150             mTagsBucket = currentApp.getTagsBucket();
 151         }
 152 
 153         Toolbar toolbar = findViewById(R.id.toolbar);
 154         setSupportActionBar(toolbar);
 155         configureNavigationDrawer(toolbar);
 156 
 157         if (savedInstanceState == null) {
 158             mNoteListFragment = new NoteListFragment();
 159             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 160             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 161             fragmentTransaction.commit();
 162         } else {
<abbr title=" 163             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 163             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 164         }
 165         mIsTabetFullscreen = mNoteListFragment.isHidden();
 166 
 167         if (DisplayUtils.isLargeScreen(this)) {
 168             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 169                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 169                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 170             } else if (DisplayUtils.isLandscape(this)) {
 171                 addEditorFragment();
 172             }
 173         }
 174 
 175         // enable ActionBar app icon to behave as action to toggle nav drawer
 176         ActionBar actionBar = getSupportActionBar();
 177         if (actionBar != null) {
 178             actionBar.setDisplayHomeAsUpEnabled(true);
 179             actionBar.setHomeButtonEnabled(true);
 180 
 181             // Add loading indicator to show when indexing
<abbr title=" 182             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 182             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 183             actionBar.setDisplayShowCustomEnabled(true);
 184             actionBar.setCustomView(progressBar);
 185             setToolbarProgressVisibility(false);
 186         }
 187 
 188         mUndoBarController = new UndoBarController(this);
 189 
 190         // Creates &#x27;Welcome&#x27; note
 191         checkForFirstLaunch();
 192 
 193         checkForSharedContent();
 194 
 195         currentApp.getSimperium().setOnUserCreatedListener(this);
 196         currentApp.getSimperium().setUserStatusChangeListener(this);
 197     }
 198 
 199     @Override
 200     protected void onResume() {
 201         super.onResume();
 202 
 203         // Ensure user has valid authorization
 204         if (userAuthenticationIsInvalid()) {
 205             startLoginActivity(true);
 206             Intent intent = getIntent();
 207 
 208             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 209                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 210                 AnalyticsTracker.track(
 211                         NOTE_WIDGET_SIGN_IN_TAPPED,
 212                         CATEGORY_WIDGET,
 213                         &quot;note_widget_sign_in_tapped&quot;
 214                 );
 215             }
 216         }
 217 
 218         disableScreenshotsIfLocked(this);
 219 
 220         mNotesBucket.start();
 221         mTagsBucket.start();
 222 
 223         mNotesBucket.addOnNetworkChangeListener(this);
 224         mNotesBucket.addOnSaveObjectListener(this);
 225         mNotesBucket.addOnDeleteObjectListener(this);
 226         mTagsBucket.addListener(mTagsMenuUpdater);
 227 
 228         updateNavigationDrawerItems();
 229 
 230         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 231         if (userIsUnauthorized()) {
 232             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 233                 mSelectedTag = null;
 234                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 235             }
 236         }
 237 
 238         filterListBySelectedTag();
 239 
 240         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 241             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 241             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 242             mShouldSelectNewNote = false;
 243         }
 244 
 245         if (mIsShowingMarkdown) {
 246             setMarkdownShowing(false);
 247         }
 248 
 249         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 250         if(DisplayUtils.isLargeScreenLandscape(this)) {
 251             if (mIsTabetFullscreen) {
 252                 ft.hide(mNoteListFragment);
 253             } else {
 254                 ft.show(mNoteListFragment);
 255             }
 256         } else {
 257             ft.show(mNoteListFragment);
 258         }
 259         ft.commitNow();
 260     }
 261 
 262     @Override
 263     protected void onPause() {
 264         super.onPause();  // Always call the superclass method first
 265         mTagsBucket.removeListener(mTagsMenuUpdater);
 266         mTagsBucket.stop();
 267 
 268         mNotesBucket.removeOnNetworkChangeListener(this);
 269         mNotesBucket.removeOnSaveObjectListener(this);
 270         mNotesBucket.removeOnDeleteObjectListener(this);
 271         mNotesBucket.stop();
 272     }
 273 
 274     @Override
 275     public void setTitle(CharSequence title) {
 276         if (getSupportActionBar() != null) {
 277             getSupportActionBar().setTitle(title);
 278         }
 279     }
 280 
 281     @Override
 282     public void onBackPressed() {
 283         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 284             mDrawerLayout.closeDrawer(GravityCompat.START);
 285         } else {
 286             super.onBackPressed();
 287         }
 288     }
 289 
 290     @Override
 291     public void onActionModeCreated() {
 292         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 293     }
 294 
 295     @Override
 296     public void onActionModeDestroyed() {
 297         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 298     }
 299 
 300 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301     private void setTitleWithCustomFont(CharSequence title) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302         if (getSupportActionBar() == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         SpannableString s = new SpannableString(title);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308         getSupportActionBar().setTitle(s);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311     private ColorStateList getIconSelector() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         int[][] states = new int[][] {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313                 new int[] { android.R.attr.state_checked}, // checked</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314                 new int[] {-android.R.attr.state_checked}  // unchecked</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         int[] colors = new int[] {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320         };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322         return new ColorStateList(states, colors);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325     private ColorStateList getTextSelector() {</span>
 326 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328     public void onActionModeDestroyed() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332     private void setTitleWithCustomFont(CharSequence title) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333         if (getSupportActionBar() == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         SpannableString s = new SpannableString(title);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         getSupportActionBar().setTitle(s);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342     private ColorStateList getItemSelector() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         int[][] states = new int[][] {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344             new int[] {-android.R.attr.state_enabled}, // disabled</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345             new int[] { android.R.attr.state_checked}, // checked</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             new int[] {-android.R.attr.state_checked}  // unchecked</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349         int[] colors = new int[] {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350             getResources().getColor(R.color.text_title_disabled, getTheme()),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         return new ColorStateList(states, colors);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356     }</span>
 357 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358     private ColorStateList getItemSelector() {</span>
 359 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 360         int[][] states = new int[][] {
 361             new int[] {-android.R.attr.state_enabled}, // disabled
 362             new int[] { android.R.attr.state_checked}, // checked
 363             new int[] {-android.R.attr.state_checked}  // unchecked
 364         };
 365 
 366         int[] colors = new int[] {
 367             getResources().getColor(R.color.text_title_disabled, getTheme()),
 368             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 369             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 370         };
 371 
 372         return new ColorStateList(states, colors);
 373     }
 374 
 375     private void configureNavigationDrawer(Toolbar toolbar) {
 376         ColorStateList iconSelector = getIconSelector();
 377         ColorStateList textSelector = getTextSelector();
 378         mDrawerLayout = findViewById(R.id.drawer_layout);
 379         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 380         NavigationView navigationView = findViewById(R.id.navigation_view);
 381         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 382         navigationView.setItemIconTintList(iconSelector);
 383         navigationView.setItemTextColor(textSelector);
 384         navigationView.setNavigationItemSelectedListener(
 385             new NavigationView.OnNavigationItemSelectedListener() {
 386                 @Override
 387                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 388                     mDrawerLayout.closeDrawer(GravityCompat.START);
 389 
 390                     if (item.getItemId() == SETTINGS_ID) {
 391                         AnalyticsTracker.track(
 392                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 393                                 AnalyticsTracker.CATEGORY_TAG,
 394                                 &quot;selected_tag_in_navigation_drawer&quot;,
 395                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 396                         );
 397                         mIsSettingsClicked = true;
 398                         return false;
 399                     } else {
 400                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 401                         filterListBySelectedTag();
 402                         return true;
 403                     }
 404                 }
 405             }
 406         );
 407 
 408         mNavigationMenu = navigationView.getMenu();
<abbr title=" 409         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 409         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 410         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 410         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 411         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 411         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 412         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 413 
 414         if (mSelectedTag == null)
 415             mSelectedTag = mTagsAdapter.getDefaultItem();
 416 
 417         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 418                 R.string.close_drawer) {
 419             public void onDrawerClosed(View view) {
 420                 supportInvalidateOptionsMenu();
 421 
 422                 if (mIsSettingsClicked) {
 423                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 424                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 425                     mIsSettingsClicked = false;
 426                 }
 427             }
 428 
 429             public void onDrawerOpened(View drawerView) {
 430                 // noop
 431             }
 432 
 433             @Override
 434             public void onDrawerSlide(View drawerView, float slideOffset) {
 435                 super.onDrawerSlide(drawerView, 0f);
 436             }
 437         };
 438 
 439         mDrawerLayout.addDrawerListener(mDrawerToggle);
 440     }
 441 
 442     private void filterListBySelectedTag() {
 443         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 444 
 445         if (selectedMenuItem != null) {
 446             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 447         } else {
 448             mSelectedTag = mTagsAdapter.getDefaultItem();
 449         }
 450 
 451         checkEmptyListText(false);
 452 
 453         if (mNoteListFragment.isHidden()) {
 454             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 455             fragmentTransaction.show(mNoteListFragment);
 456             fragmentTransaction.commitNowAllowingStateLoss();
 457         }
 458 
 459         // Disable long press on notes when viewing Trash.
 460         if (mSelectedTag.id == TRASH_ID) {
 461             getNoteListFragment().getListView().setLongClickable(false);
 462         } else {
 463             getNoteListFragment().getListView().setLongClickable(true);
 464         }
 465 
 466         getNoteListFragment().refreshListFromNavSelect();
 467 
 468         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 469 
 470         switch ((int) mSelectedTag.id) {
 471             case ALL_NOTES_ID:
 472                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 473                 break;
 474             case TRASH_ID:
 475                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 476                 break;
 477             case UNTAGGED_NOTES_ID:
 478                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 479                 break;
 480             default:
 481                 properties = null;
 482                 break;
 483         }
 484 
 485         AnalyticsTracker.track(
 486                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 487                 AnalyticsTracker.CATEGORY_TAG,
 488                 &quot;selected_tag_in_navigation_drawer&quot;,
 489                 properties
 490         );
 491 
 492         setSelectedTagActive();
 493     }
 494 
 495     private void checkForFirstLaunch() {
 496         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 497             // Create the welcome note
 498             try {
 499                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 500                 welcomeNote.setCreationDate(Calendar.getInstance());
 501                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 502                 welcomeNote.setContent(getString(R.string.welcome_note));
 503                 welcomeNote.getTitle();
 504                 welcomeNote.save();
 505             } catch (BucketObjectNameInvalid e) {
 506                 // this won&#x27;t happen because welcome-android is a valid name
 507             }
 508 
 509             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 510             SharedPreferences.Editor editor = preferences.edit();
 511             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 512             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 513             editor.apply();
 514         }
 515     }
 516 
 517     private void checkForSharedContent() {
 518         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 519             // Check share action
 520             Intent intent = getIntent();
 521             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 522             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 523 
<abbr title=" 524             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 524             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 525             String intentAction = StrUtils.notNullStr(intent.getAction());
 526             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 527             if (!TextUtils.isEmpty(text)) {
 528                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 529                     text = subject + &quot;\n\n&quot; + text;
 530                 }
 531                 Note note = mNotesBucket.newObject();
 532                 note.setCreationDate(Calendar.getInstance());
 533                 note.setModificationDate(note.getCreationDate());
 534                 note.setContent(text);
 535                 note.save();
 536                 setCurrentNote(note);
 537                 mShouldSelectNewNote = true;
 538 
 539                 AnalyticsTracker.track(
 540                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 541                         AnalyticsTracker.CATEGORY_NOTE,
 542                         &quot;external_share&quot;
 543                 );
 544 
 545                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 546                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 547                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 548                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 549                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 550                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 551                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 552                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 553                     }
 554                 }
 555             }
 556         }
 557     }
 558 
 559     private void updateNavigationDrawerItems() {
 560         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 561         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 562         if (isAlphaSort) {
 563             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 564         } else {
 565             tagCursor = Tag.allWithName(mTagsBucket).execute();
 566         }
 567 
 568         mTagsAdapter.changeCursor(tagCursor);
 569         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 570         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 571 
 572         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 573             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 573             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 574 
 575             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 576                 String name = mTagsAdapter.getItem(i).name;
 577                 int id = (int) mTagsAdapter.getItem(i).id;
 578 
 579                 if (id &gt;= 0) { // Custom tags have a positive ID.
 580                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 581                 }
 582             }
 583 
<abbr title=" 584             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 584             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 585             setSelectedTagActive();
 586         }
 587     }
 588 
 589     public void launchEditTags(View view) {
 590         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 591     }
 592 
 593     private void setSelectedTagActive() {
 594         if (mSelectedTag == null) {
 595             mSelectedTag = mTagsAdapter.getDefaultItem();
 596         }
 597 
 598         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 599 
 600         if (selectedMenuItem != null) {
 601             selectedMenuItem.setChecked(true);
 602         } else {
 603             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 604         }
 605 
 606         setTitle(mSelectedTag.name);
 607     }
 608 
 609     public TagsAdapter.TagMenuItem getSelectedTag() {
 610         if (mSelectedTag == null) {
 611             mSelectedTag = mTagsAdapter.getDefaultItem();
 612         }
 613 
 614         return mSelectedTag;
 615     }
 616 
 617     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 618     public void updateTrashMenuItem() {
 619         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 620             return;
 621 
 622         // Disable the trash icon if there are no notes trashed.
 623         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 624         if (query.count() == 0) {
 625             mEmptyTrashMenuItem.setEnabled(false);
 626         } else {
 627             mEmptyTrashMenuItem.setEnabled(true);
 628         }
 629     }
 630 
 631     private void addEditorFragment() {
 632         FragmentManager fm = getSupportFragmentManager();
 633         FragmentTransaction ft = fm.beginTransaction();
 634         mNoteEditorFragment = new NoteEditorFragment();
 635         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 636         ft.commitAllowingStateLoss();
 637         fm.executePendingTransactions();
 638     }
 639 
 640     private boolean userAccountRequired() {
 641         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 642     }
 643 
 644     /**
 645      * Checks for a previously valid user that is now not authenticated
 646      * Also checks if user account is required (added in version 1.5.6)
 647      *
 648      * @return true if user has invalid authorization
 649      */
 650     private boolean userAuthenticationIsInvalid() {
 651         Simplenote currentApp = (Simplenote) getApplication();
 652         Simperium simperium = currentApp.getSimperium();
 653         User user = simperium.getUser();
 654         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 655         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 656                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 657     }
 658 
 659     public boolean userIsUnauthorized() {
 660         Simplenote currentApp = (Simplenote) getApplication();
 661         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 662     }
 663 
 664     public void setCurrentNote(Note note) {
 665         mCurrentNote = note;
 666     }
 667 
 668     public NoteListFragment getNoteListFragment() {
 669         return mNoteListFragment;
 670     }
 671 
 672     @SuppressWarnings(&quot;ResourceType&quot;)
 673     @Override
 674     public boolean onCreateOptionsMenu(Menu menu) {
 675         super.onCreateOptionsMenu(menu);
 676         MenuInflater inflater = getMenuInflater();
 677         inflater.inflate(R.menu.notes_list, menu);
 678 
 679         // restore the search query if on a landscape tablet
 680         String searchQuery = null;
 681         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 682             searchQuery = mSearchView.getQuery().toString();
 683 
 684         mSearchMenuItem = menu.findItem(R.id.menu_search);
 685         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 686 
 687         if (!TextUtils.isEmpty(searchQuery)) {
 688             mSearchView.setQuery(searchQuery, false);
 689             mSearchMenuItem.expandActionView();
 690         } else {
 691             // Workaround for setting the search placeholder text color
 692             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 693             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 694                     hintHexColor,
 695                     getString(R.string.search))));
 696         }
 697 
 698         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 699             @Override
 700             public boolean onQueryTextChange(String newText) {
 701                 if (mSearchMenuItem.isActionViewExpanded()) {
 702                     getNoteListFragment().searchNotes(newText);
 703                 }
 704                 return true;
 705             }
 706 
 707             @Override
 708             public boolean onQueryTextSubmit(String queryText) {
 709                 getNoteListFragment().searchNotes(queryText);
 710                 return true;
 711             }
 712 
 713         });
 714 
 715         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 716             @Override
 717             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 718                 checkEmptyListText(true);
 719                 if (mNoteListFragment != null) {
 720                     mNoteListFragment.setFloatingActionButtonVisible(false);
 721                 }
 722                 AnalyticsTracker.track(
 723                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 724                         AnalyticsTracker.CATEGORY_NOTE,
 725                         &quot;action_bar_search_tap&quot;
 726                 );
 727                 return true;
 728             }
 729 
 730             @Override
 731             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 732                 // Show all notes again
 733                 if (mNoteListFragment != null) {
 734                     mNoteListFragment.setFloatingActionButtonVisible(true);
 735                 }
 736                 mTabletSearchQuery = &quot;&quot;;
 737                 mSearchView.setQuery(&quot;&quot;, false);
 738                 checkEmptyListText(false);
 739                 getNoteListFragment().clearSearch();
 740                 return true;
 741             }
 742         });
 743 
 744         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 745             @Override
 746             public boolean onMenuItemClick(MenuItem item) {
 747                 if (!mSearchMenuItem.isActionViewExpanded())
 748                     showDetailPlaceholder();
 749                 return false;
 750             }
 751         });
 752 
 753         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 754         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 755             trashItem.setTitle(R.string.undelete);
 756             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 757         } else {
 758             trashItem.setTitle(R.string.delete);
 759             trashItem.setIcon(R.drawable.ic_trash_24dp);
 760         }
 761 
 762         if (DisplayUtils.isLargeScreenLandscape(this)) {
 763             // Restore the search query on landscape tablets
 764             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 765                 mSearchMenuItem.expandActionView();
 766                 mSearchView.setQuery(mTabletSearchQuery, false);
 767                 mSearchView.clearFocus();
 768             }
 769 
 770             if (mCurrentNote != null) {
 771                 menu.findItem(R.id.menu_share).setVisible(true);
 772                 menu.findItem(R.id.menu_view_info).setVisible(true);
 773                 menu.findItem(R.id.menu_checklist).setVisible(true);
 774                 menu.findItem(R.id.menu_history).setVisible(true);
 775                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 776                 menu.findItem(R.id.menu_sidebar).setVisible(true);
 777                 trashItem.setVisible(true);
 778             } else {
 779                 menu.findItem(R.id.menu_share).setVisible(false);
 780                 menu.findItem(R.id.menu_view_info).setVisible(false);
 781                 menu.findItem(R.id.menu_checklist).setVisible(false);
 782                 menu.findItem(R.id.menu_history).setVisible(false);
 783                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 784                 menu.findItem(R.id.menu_sidebar).setVisible(false);
 785                 trashItem.setVisible(false);
 786             }
 787             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 788         } else {
 789             menu.findItem(R.id.menu_search).setVisible(true);
 790             menu.findItem(R.id.menu_share).setVisible(false);
 791             menu.findItem(R.id.menu_view_info).setVisible(false);
 792             menu.findItem(R.id.menu_checklist).setVisible(false);
 793             menu.findItem(R.id.menu_history).setVisible(false);
 794             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 795             menu.findItem(R.id.menu_sidebar).setVisible(false);
 796             trashItem.setVisible(false);
 797             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 798         }
 799 
 800         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 801             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 802             mEmptyTrashMenuItem.setVisible(true);
 803 
 804             updateTrashMenuItem();
 805 
 806             menu.findItem(R.id.menu_search).setVisible(false);
 807             menu.findItem(R.id.menu_share).setVisible(false);
 808             menu.findItem(R.id.menu_history).setVisible(false);
 809             menu.findItem(R.id.menu_checklist).setVisible(false);
 810         }
 811 
 812         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 813 
 814         return true;
 815     }
 816 
 817     @Override
 818     public boolean onOptionsItemSelected(MenuItem item) {
 819         if (mDrawerToggle.onOptionsItemSelected(item)) {
 820             return true;
 821         }
 822         switch (item.getItemId()) {
 823             case R.id.menu_sidebar:
 824                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 825                 if (mNoteListFragment.isHidden()) {
 826                     ft.show(mNoteListFragment);
 827                 } else {
 828                     ft.hide(mNoteListFragment);
 829                 }
 830                 ft.commitNowAllowingStateLoss();
 831                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 832                 return true;
 833             case R.id.menu_markdown_preview:
 834                 if (mIsShowingMarkdown) {
 835                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 836                     item.setTitle(getString(R.string.markdown_show));
 837                     setMarkdownShowing(false);
 838                     mCurrentNote.setPreviewEnabled(false);
 839                 } else {
 840                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 841                     item.setTitle(getString(R.string.markdown_hide));
 842                     setMarkdownShowing(true);
 843                     mCurrentNote.setPreviewEnabled(true);
 844                 }
 845 
 846                 mCurrentNote.save();
 847                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 848 
 849                 return true;
 850             case R.id.menu_delete:
 851                 if (mNoteEditorFragment != null) {
 852                     if (mCurrentNote != null) {
 853                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 854                         mCurrentNote.setModificationDate(Calendar.getInstance());
 855                         mCurrentNote.save();
 856 
 857                         updateViewsAfterTrashAction(mCurrentNote);
 858                     }
 859                 }
 860                 return true;
 861             case R.id.menu_empty_trash:
 862                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 863 
 864                 alert.setTitle(R.string.empty_trash);
 865                 alert.setMessage(R.string.confirm_empty_trash);
 866                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 867                     public void onClick(DialogInterface dialog, int whichButton) {
 868                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 869                         AnalyticsTracker.track(
 870                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 871                                 AnalyticsTracker.CATEGORY_NOTE,
 872                                 &quot;overflow_menu&quot;
 873                         );
 874                     }
 875                 });
 876                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 877                     public void onClick(DialogInterface dialog, int whichButton) {
 878                         // Do nothing, just closing the dialog
 879                     }
 880                 });
 881                 alert.show();
 882                 return true;
 883             case android.R.id.home:
 884                 invalidateOptionsMenu();
 885                 return true;
 886             default:
 887                 return super.onOptionsItemSelected(item);
 888         }
 889     }
 890 
 891     @Override
 892     public boolean onPrepareOptionsMenu(Menu menu) {
 893         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 894 
 895         if (mIsShowingMarkdown) {
 896             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 897             markdownItem.setTitle(getString(R.string.markdown_hide));
 898         } else {
 899             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 900             markdownItem.setTitle(getString(R.string.markdown_show));
 901         }
 902 
 903         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 904 
 905         return super.onPrepareOptionsMenu(menu);
 906     }
 907 
 908     public void updateViewsAfterTrashAction(Note note) {
 909         if (note == null || isFinishing()) {
 910             return;
 911         }
 912 
 913         if (note.isDeleted()) {
 914             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 915             deletedNoteIds.add(note.getSimperiumKey());
 916             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 917             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 918             AnalyticsTracker.track(
 919                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 920                     AnalyticsTracker.CATEGORY_NOTE,
 921                     &quot;overflow_menu&quot;
 922             );
 923         } else {
 924             AnalyticsTracker.track(
 925                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 926                     AnalyticsTracker.CATEGORY_NOTE,
 927                     &quot;overflow_menu&quot;
 928             );
 929         }
 930 
 931         // If we just deleted/restored the active note, show the placeholder
 932         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 933             showDetailPlaceholder();
 934         }
 935 
 936         NoteListFragment fragment = getNoteListFragment();
 937         if (fragment != null) {
 938             fragment.getPrefs();
 939             fragment.refreshList();
 940         }
 941 
 942         invalidateOptionsMenu();
 943     }
 944 
 945     public void setMarkdownShowing(boolean isMarkdownShowing) {
 946         mIsShowingMarkdown = isMarkdownShowing;
 947         if (mNoteEditorFragment != null) {
 948             if (isMarkdownShowing) {
 949                 mNoteEditorFragment.showMarkdown();
 950             } else {
 951                 mNoteEditorFragment.hideMarkdown();
 952             }
 953         }
 954         invalidateOptionsMenu();
 955     }
 956 
 957     /**
 958      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 959      * the item with the given ID was selected. Used for tablets only.
 960      */
 961     @Override
<abbr title=" 962     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 962     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 963         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 964             // Launch the editor activity
 965             Bundle arguments = new Bundle();
 966             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 967             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 968             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 969 
 970             if (matchOffsets != null) {
 971                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 972             }
 973 
 974             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 975             editNoteIntent.putExtras(arguments);
 976             if (mNoteListFragment.isHidden()) {
 977                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 978             }
 979             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 980         } else {
 981             mNoteEditorFragment.setNote(noteID, matchOffsets);
 982             getNoteListFragment().setNoteSelected(noteID);
 983             setMarkdownShowing(isPreviewEnabled);
 984 
 985             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 986                 mTabletSearchQuery = mSearchView.getQuery().toString();
 987             }
 988 
 989             mNoteEditorFragment.clearMarkdown();
 990 
 991             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 992                 setMarkdownShowing(false);
 993             }
 994 
 995             invalidateOptionsMenu();
 996         }
 997 
 998         AnalyticsTracker.track(
 999                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
1000                 AnalyticsTracker.CATEGORY_NOTE,
1001                 &quot;note_list_row_tap&quot;
1002         );
1003     }
1004 
1005     @Override
1006     public void onUserCreated(User user) {
1007         // New account created
1008         AnalyticsTracker.track(
1009                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
1010                 AnalyticsTracker.CATEGORY_USER,
1011                 &quot;account_created_from_login_activity&quot;
1012         );
1013     }
1014 
1015     public void onUserStatusChange(User.Status status) {
1016         switch (status) {
1017             // successfully used access token to connect to simperium bucket
1018             case AUTHORIZED:
1019                 runOnUiThread(new Runnable() {
1020                     @Override
1021                     public void run() {
1022                         if (!mNotesBucket.hasChangeVersion()) {
1023                             setToolbarProgressVisibility(true);
1024                         }
1025                     }
1026                 });
1027                 break;
1028 
1029             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1030             case NOT_AUTHORIZED:
1031                 runOnUiThread(new Runnable() {
1032                     @Override
1033                     public void run() {
1034                         startLoginActivity(true);
1035                     }
1036                 });
1037                 break;
1038 
<abbr title="1039             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1039             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1040             case UNKNOWN:
1041                 break;
1042         }
1043     }
1044 
1045     private void setToolbarProgressVisibility(boolean isVisible) {
1046         if (getSupportActionBar() != null) {
1047             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1048         }
1049     }
1050 
1051     public void startLoginActivity(boolean signInFirst) {
1052         // Clear some account-specific prefs
1053         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1054         editor.remove(PrefUtils.PREF_WP_TOKEN);
1055         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1056         editor.apply();
1057 
1058         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1059         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1060     }
1061 
1062     @Override
1063     public void recreate() {
1064         Handler handler = new Handler();
1065         handler.post(new Runnable() {
1066             @Override
1067             public void run() {
1068                 NotesActivity.super.recreate();
1069             }
1070         });
1071     }
1072 
1073     @Override
1074     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1075         super.onActivityResult(requestCode, resultCode, data);
1076         switch (requestCode) {
1077             case Simplenote.INTENT_PREFERENCES:
<abbr title="1078                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1078                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1079                 invalidateOptionsMenu();
1080                 NoteListFragment fragment = getNoteListFragment();
1081                 if (fragment != null) {
1082                     fragment.getPrefs();
1083                     fragment.refreshList();
1084                 }
1085 
1086                 break;
1087             case Simplenote.INTENT_EDIT_NOTE:
1088                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1089                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1090                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1091                         if (noteId != null) {
1092                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1093                             deletedNoteIds.add(noteId);
1094                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1095                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1095                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1096                         }
<abbr title="1097                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1097                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1098                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1099                         mNoteListFragment.setNoteSelected(selectedNoteId);
1100                         if (mNoteEditorFragment != null) {
1101                             mNoteEditorFragment.setNote(selectedNoteId);
1102                         }
1103                     }
1104                 }
1105                 break;
1106             case Simperium.SIGNUP_SIGNIN_REQUEST:
1107                 invalidateOptionsMenu();
1108 
1109                 Simplenote app = (Simplenote) getApplication();
1110                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1111                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1112 
1113                 AnalyticsTracker.track(
1114                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1115                         AnalyticsTracker.CATEGORY_USER,
1116                         &quot;signed_in_from_login_activity&quot;
1117                 );
1118 
1119                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1120                     finish();
1121                 }
1122 
1123                 break;
1124         }
1125     }
1126 
1127     @Override
1128     public void onUndo() {
1129         if (mUndoBarController == null) return;
1130 
1131         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1132         if (deletedNoteIds != null) {
1133             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1134                 Note deletedNote;
1135                 try {
1136                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1137                 } catch (BucketObjectMissingException e) {
1138                     return;
1139                 }
1140                 if (deletedNote != null) {
1141                     deletedNote.setDeleted(false);
1142                     deletedNote.setModificationDate(Calendar.getInstance());
1143                     deletedNote.save();
1144                     NoteListFragment fragment = getNoteListFragment();
1145                     if (fragment != null) {
1146                         fragment.getPrefs();
1147                         fragment.refreshList();
1148                     }
1149                 }
1150             }
1151         }
1152     }
1153 
1154     @Override
1155     protected void onPostCreate(Bundle savedInstanceState) {
1156         super.onPostCreate(savedInstanceState);
1157         // Sync the toggle state after onRestoreInstanceState has occurred.
1158         mDrawerToggle.syncState();
1159     }
1160 
1161     @Override
1162     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1163         super.onConfigurationChanged(newConfig);
1164 
1165         mDrawerToggle.onConfigurationChanged(newConfig);
1166 
1167         if (DisplayUtils.isLargeScreen(this)) {
1168             mIsShowingMarkdown = false;
1169 
1170             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1171                 // Add the editor fragment
1172                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1173                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1173                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1174                 } else if (DisplayUtils.isLandscape(this)) {
1175                     addEditorFragment();
1176                 }
1177 
1178                 if (mNoteListFragment != null) {
1179                     mNoteListFragment.setActivateOnItemClick(true);
1180                     mNoteListFragment.setDividerVisible(true);
1181                 }
1182 
1183                 // Select the current note on a tablet
1184                 if (mCurrentNote != null) {
<abbr title="1185                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1185                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1186                 } else {
1187                     mNoteEditorFragment.setPlaceholderVisible(true);
1188                     mNoteListFragment.getListView().clearChoices();
1189                 }
1190 
1191                 invalidateOptionsMenu();
<abbr title="1192             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1192             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1193             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1194                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1194                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1195             }
1196         }
1197 
1198         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1199             // Remove the editor fragment when rotating back to portrait
1200             mCurrentNote = null;
1201             if (mNoteListFragment != null) {
1202                 mNoteListFragment.setActivateOnItemClick(false);
1203                 mNoteListFragment.setDividerVisible(false);
1204                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1205                 mNoteListFragment.refreshList();
1206             }
1207             FragmentManager fm = getSupportFragmentManager();
1208             FragmentTransaction ft = fm.beginTransaction();
1209             ft.remove(mNoteEditorFragment);
1210             mNoteEditorFragment = null;
1211             ft.commitAllowingStateLoss();
1212             fm.executePendingTransactions();
1213             invalidateOptionsMenu();
1214         }
1215     }
1216 
1217     public void checkEmptyListText(boolean isSearch) {
1218         if (isSearch) {
<abbr title="1219             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1219             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1220             getNoteListFragment().setEmptyListViewClickable(false);
1221         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1222             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1222             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1223             AnalyticsTracker.track(
1224                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1225                     AnalyticsTracker.CATEGORY_NOTE,
1226                     &quot;trash_filter_selected&quot;
1227             );
1228             getNoteListFragment().setEmptyListViewClickable(false);
1229         } else {
<abbr title="1230             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1230             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1231             getNoteListFragment().setEmptyListViewClickable(true);
1232         }
1233     }
1234 
1235     public void showDetailPlaceholder() {
1236         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1237             mCurrentNote = null;
1238             mNoteEditorFragment.setPlaceholderVisible(true);
1239             mNoteEditorFragment.clearMarkdown();
1240             mNoteEditorFragment.hideMarkdown();
1241             mIsShowingMarkdown = false;
1242         }
1243     }
1244 
1245     public void stopListeningToNotesBucket() {
1246         mNotesBucket.removeOnNetworkChangeListener(this);
1247         mNotesBucket.removeOnSaveObjectListener(this);
1248         mNotesBucket.removeOnDeleteObjectListener(this);
1249     }
1250 
1251     // Returns the appropriate view to show the undo bar within
1252     private View getUndoView() {
1253         View undoView = mFragmentsContainer;
1254         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1255                 getNoteListFragment() != null &amp;&amp;
1256                 getNoteListFragment().getRootView() != null) {
1257             undoView = getNoteListFragment().getRootView();
1258         }
1259 
1260         return undoView;
1261     }
1262 
1263     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1264         if (mUndoBarController != null) {
1265             mUndoBarController.setDeletedNoteIds(noteIds);
1266             mUndoBarController.showUndoBar(
1267                     getUndoView(),
<abbr title="1268                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1268                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1269             );
1270         }
1271     }
1272 
1273     /* Simperium Bucket Listeners */
1274     // received a change from the network, refresh the list
1275     @Override
1276     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1277         runOnUiThread(new Runnable() {
1278             @Override
1279             public void run() {
1280                 if (type == Bucket.ChangeType.INDEX) {
1281                     setToolbarProgressVisibility(false);
1282                 }
1283                 mNoteListFragment.refreshList();
1284             }
1285         });
1286     }
1287 
1288     @Override
1289     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1290         runOnUiThread(new Runnable() {
1291             @Override
1292             public void run() {
1293                 mNoteListFragment.refreshList();
1294             }
1295         });
1296     }
1297 
1298     @Override
1299     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1300         runOnUiThread(new Runnable() {
1301             @Override
1302             public void run() {
1303                 mNoteListFragment.refreshList();
1304             }
1305         });
1306     }
1307 
1308     @Override
1309     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1310         // noop, NoteEditorFragment will handle this
1311     }
1312 
1313     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1314 
1315         @Override
1316         protected Void doInBackground(Void... voids) {
1317             if (mNotesBucket == null) return null;
1318 
1319             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1320             Bucket.ObjectCursor c = query.execute();
1321             while (c.moveToNext()) {
1322                 c.getObject().delete();
1323             }
1324 
1325             return null;
1326         }
1327 
1328         @Override
1329         protected void onPostExecute(Void nada) {
1330             showDetailPlaceholder();
1331         }
1332     }
1333 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.ActionBar;
  22 import androidx.appcompat.app.ActionBarDrawerToggle;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.app.AppCompatActivity;
  25 import androidx.appcompat.widget.SearchView;
  26 import androidx.appcompat.widget.Toolbar;
  27 import androidx.core.view.GravityCompat;
  28 import androidx.drawerlayout.widget.DrawerLayout;
  29 import androidx.fragment.app.FragmentManager;
  30 import androidx.fragment.app.FragmentTransaction;
  31 import androidx.preference.PreferenceManager;
  32 
  33 import com.automattic.simplenote.analytics.AnalyticsTracker;
  34 import com.automattic.simplenote.models.Note;
  35 import com.automattic.simplenote.models.Tag;
  36 import com.automattic.simplenote.utils.CrashUtils;
  37 import com.automattic.simplenote.utils.DisplayUtils;
  38 import com.automattic.simplenote.utils.DrawableUtils;
  39 import com.automattic.simplenote.utils.HtmlCompat;
  40 import com.automattic.simplenote.utils.PrefUtils;
  41 import com.automattic.simplenote.utils.StrUtils;
  42 import com.automattic.simplenote.utils.TagsAdapter;
  43 import com.automattic.simplenote.utils.ThemeUtils;
  44 import com.automattic.simplenote.utils.UndoBarController;
  45 import com.google.android.material.navigation.NavigationView;
  46 import com.simperium.Simperium;
  47 import com.simperium.client.Bucket;
  48 import com.simperium.client.BucketObjectMissingException;
  49 import com.simperium.client.BucketObjectNameInvalid;
  50 import com.simperium.client.Query;
  51 import com.simperium.client.User;
  52 
  53 import org.wordpress.passcodelock.AppLockManager;
  54 
  55 import java.util.ArrayList;
  56 import java.util.Calendar;
  57 import java.util.HashMap;
  58 import java.util.List;
  59 import java.util.Map;
  60 
  61 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  62 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  64 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  65 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  66 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  67 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  68 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  70 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  71 
  72 public class NotesActivity extends AppCompatActivity implements
<abbr title="  73         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  73         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  74         Bucket.Listener&lt;Note&gt; {
  75 
  76     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  77     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  78     protected Bucket&lt;Note&gt; mNotesBucket;
  79     protected Bucket&lt;Tag&gt; mTagsBucket;
  80     private boolean mIsShowingMarkdown;
  81     private boolean mShouldSelectNewNote;
  82     private boolean mIsSettingsClicked;
  83     private boolean mIsTabetFullscreen;
  84 
  85     private String mTabletSearchQuery;
  86     private UndoBarController mUndoBarController;
  87     private View mFragmentsContainer;
  88     private SearchView mSearchView;
  89     private MenuItem mSearchMenuItem;
  90     private NoteListFragment mNoteListFragment;
  91     private NoteEditorFragment mNoteEditorFragment;
  92     private Note mCurrentNote;
  93     private MenuItem mEmptyTrashMenuItem;
  94 
  95     // Menu drawer
  96     private static final int GROUP_PRIMARY = 100;
  97     private static final int GROUP_SECONDARY = 101;
  98     private static final int GROUP_TERTIARY = 102;
  99     private DrawerLayout mDrawerLayout;
 100     private Menu mNavigationMenu;
 101     private ActionBarDrawerToggle mDrawerToggle;
 102     private TagsAdapter mTagsAdapter;
 103     private TagsAdapter.TagMenuItem mSelectedTag;
 104     // Tags bucket listener
 105     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 106         void updateNavigationDrawer() {
 107             runOnUiThread(new Runnable() {
 108                 public void run() {
 109                     updateNavigationDrawerItems();
 110                 }
 111             });
 112         }
 113 
 114         @Override
 115         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 116             updateNavigationDrawer();
 117         }
 118 
 119         @Override
 120         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 121             updateNavigationDrawer();
 122         }
 123 
 124         @Override
 125         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 126             updateNavigationDrawer();
 127         }
 128 
 129         @Override
 130         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 131             // noop
 132         }
 133     };
 134 
 135     @Override
 136     protected void onCreate(Bundle savedInstanceState) {
 137         ThemeUtils.setTheme(this);
 138         super.onCreate(savedInstanceState);
 139 
 140         setContentView(R.layout.activity_notes);
 141 
 142         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 143 
 144         Simplenote currentApp = (Simplenote) getApplication();
 145         if (mNotesBucket == null) {
 146             mNotesBucket = currentApp.getNotesBucket();
 147         }
 148 
 149         if (mTagsBucket == null) {
 150             mTagsBucket = currentApp.getTagsBucket();
 151         }
 152 
 153         Toolbar toolbar = findViewById(R.id.toolbar);
 154         setSupportActionBar(toolbar);
 155         configureNavigationDrawer(toolbar);
 156 
 157         if (savedInstanceState == null) {
 158             mNoteListFragment = new NoteListFragment();
 159             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 160             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 161             fragmentTransaction.commit();
 162         } else {
<abbr title=" 163             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 163             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 164         }
 165         mIsTabetFullscreen = mNoteListFragment.isHidden();
 166 
 167         if (DisplayUtils.isLargeScreen(this)) {
 168             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 169                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 169                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 170             } else if (DisplayUtils.isLandscape(this)) {
 171                 addEditorFragment();
 172             }
 173         }
 174 
 175         // enable ActionBar app icon to behave as action to toggle nav drawer
 176         ActionBar actionBar = getSupportActionBar();
 177         if (actionBar != null) {
 178             actionBar.setDisplayHomeAsUpEnabled(true);
 179             actionBar.setHomeButtonEnabled(true);
 180 
 181             // Add loading indicator to show when indexing
<abbr title=" 182             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 182             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 183             actionBar.setDisplayShowCustomEnabled(true);
 184             actionBar.setCustomView(progressBar);
 185             setToolbarProgressVisibility(false);
 186         }
 187 
 188         mUndoBarController = new UndoBarController(this);
 189 
 190         // Creates &#x27;Welcome&#x27; note
 191         checkForFirstLaunch();
 192 
 193         checkForSharedContent();
 194 
 195         currentApp.getSimperium().setOnUserCreatedListener(this);
 196         currentApp.getSimperium().setUserStatusChangeListener(this);
 197     }
 198 
 199     @Override
 200     protected void onResume() {
 201         super.onResume();
 202 
 203         // Ensure user has valid authorization
 204         if (userAuthenticationIsInvalid()) {
 205             startLoginActivity(true);
 206             Intent intent = getIntent();
 207 
 208             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 209                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 210                 AnalyticsTracker.track(
 211                         NOTE_WIDGET_SIGN_IN_TAPPED,
 212                         CATEGORY_WIDGET,
 213                         &quot;note_widget_sign_in_tapped&quot;
 214                 );
 215             }
 216         }
 217 
 218         disableScreenshotsIfLocked(this);
 219 
 220         mNotesBucket.start();
 221         mTagsBucket.start();
 222 
 223         mNotesBucket.addOnNetworkChangeListener(this);
 224         mNotesBucket.addOnSaveObjectListener(this);
 225         mNotesBucket.addOnDeleteObjectListener(this);
 226         mTagsBucket.addListener(mTagsMenuUpdater);
 227 
 228         updateNavigationDrawerItems();
 229 
 230         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 231         if (userIsUnauthorized()) {
 232             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 233                 mSelectedTag = null;
 234                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 235             }
 236         }
 237 
 238         filterListBySelectedTag();
 239 
 240         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 241             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 241             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 242             mShouldSelectNewNote = false;
 243         }
 244 
 245         if (mIsShowingMarkdown) {
 246             setMarkdownShowing(false);
 247         }
 248 
 249         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 250         if(DisplayUtils.isLargeScreenLandscape(this)) {
 251             if (mIsTabetFullscreen) {
 252                 ft.hide(mNoteListFragment);
 253             } else {
 254                 ft.show(mNoteListFragment);
 255             }
 256         } else {
 257             ft.show(mNoteListFragment);
 258         }
 259         ft.commitNow();
 260     }
 261 
 262     @Override
 263     protected void onPause() {
 264         super.onPause();  // Always call the superclass method first
 265         mTagsBucket.removeListener(mTagsMenuUpdater);
 266         mTagsBucket.stop();
 267 
 268         mNotesBucket.removeOnNetworkChangeListener(this);
 269         mNotesBucket.removeOnSaveObjectListener(this);
 270         mNotesBucket.removeOnDeleteObjectListener(this);
 271         mNotesBucket.stop();
 272     }
 273 
 274     @Override
 275     public void setTitle(CharSequence title) {
 276         if (getSupportActionBar() != null) {
 277             getSupportActionBar().setTitle(title);
 278         }
 279     }
 280 
 281     @Override
 282     public void onBackPressed() {
 283         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 284             mDrawerLayout.closeDrawer(GravityCompat.START);
 285         } else {
 286             super.onBackPressed();
 287         }
 288     }
 289 
 290     @Override
 291     public void onActionModeCreated() {
 292         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 293     }
 294 
 295     @Override
 296     public void onActionModeDestroyed() {
 297         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 298     }
 299 
 300     private ColorStateList getIconSelector() {
 301         int[][] states = new int[][] {
 302                 new int[] { android.R.attr.state_checked}, // checked
 303                 new int[] {-android.R.attr.state_checked}  // unchecked
 304         };
 305 
 306         int[] colors = new int[] {
 307                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 308                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 309         };
 310 
 311         return new ColorStateList(states, colors);
 312     }
 313 
 314     private ColorStateList getTextSelector() {
 315         int[][] states = new int[][] {
 316             new int[] {-android.R.attr.state_enabled}, // disabled
 317             new int[] { android.R.attr.state_checked}, // checked
 318             new int[] {-android.R.attr.state_checked}  // unchecked
 319         };
 320 
 321         int[] colors = new int[] {
 322             getResources().getColor(R.color.text_title_disabled, getTheme()),
 323             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 324             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 325         };
 326 
 327         return new ColorStateList(states, colors);
 328     }
 329 
 330     private void configureNavigationDrawer(Toolbar toolbar) {
 331         ColorStateList iconSelector = getIconSelector();
 332         ColorStateList textSelector = getTextSelector();
 333         mDrawerLayout = findViewById(R.id.drawer_layout);
 334         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 335         NavigationView navigationView = findViewById(R.id.navigation_view);
 336         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 337         navigationView.setItemIconTintList(iconSelector);
 338         navigationView.setItemTextColor(textSelector);
 339         navigationView.setNavigationItemSelectedListener(
 340             new NavigationView.OnNavigationItemSelectedListener() {
 341                 @Override
 342                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 343                     mDrawerLayout.closeDrawer(GravityCompat.START);
 344 
 345                     if (item.getItemId() == SETTINGS_ID) {
 346                         AnalyticsTracker.track(
 347                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 348                                 AnalyticsTracker.CATEGORY_TAG,
 349                                 &quot;selected_tag_in_navigation_drawer&quot;,
 350                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 351                         );
 352                         mIsSettingsClicked = true;
 353                         return false;
 354                     } else {
 355                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 356                         filterListBySelectedTag();
 357                         return true;
 358                     }
 359                 }
 360             }
 361         );
 362 
 363         mNavigationMenu = navigationView.getMenu();
<abbr title=" 364         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 364         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 365         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 365         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 366         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 366         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 367         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 368 
 369         if (mSelectedTag == null)
 370             mSelectedTag = mTagsAdapter.getDefaultItem();
 371 
 372         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 373                 R.string.close_drawer) {
 374             public void onDrawerClosed(View view) {
 375                 supportInvalidateOptionsMenu();
 376 
 377                 if (mIsSettingsClicked) {
 378                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 379                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 380                     mIsSettingsClicked = false;
 381                 }
 382             }
 383 
 384             public void onDrawerOpened(View drawerView) {
 385                 // noop
 386             }
 387 
 388             @Override
 389             public void onDrawerSlide(View drawerView, float slideOffset) {
 390                 super.onDrawerSlide(drawerView, 0f);
 391             }
 392         };
 393 
 394         mDrawerLayout.addDrawerListener(mDrawerToggle);
 395     }
 396 
 397     private void filterListBySelectedTag() {
 398         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 399 
 400         if (selectedMenuItem != null) {
 401             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 402         } else {
 403             mSelectedTag = mTagsAdapter.getDefaultItem();
 404         }
 405 
 406         checkEmptyListText(false);
 407 
 408         if (mNoteListFragment.isHidden()) {
 409             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 410             fragmentTransaction.show(mNoteListFragment);
 411             fragmentTransaction.commitNowAllowingStateLoss();
 412         }
 413 
 414         // Disable long press on notes when viewing Trash.
 415         if (mSelectedTag.id == TRASH_ID) {
 416             getNoteListFragment().getListView().setLongClickable(false);
 417         } else {
 418             getNoteListFragment().getListView().setLongClickable(true);
 419         }
 420 
 421         getNoteListFragment().refreshListFromNavSelect();
 422 
 423         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 424 
 425         switch ((int) mSelectedTag.id) {
 426             case ALL_NOTES_ID:
 427                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 428                 break;
 429             case TRASH_ID:
 430                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 431                 break;
 432             case UNTAGGED_NOTES_ID:
 433                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 434                 break;
 435             default:
 436                 properties = null;
 437                 break;
 438         }
 439 
 440         AnalyticsTracker.track(
 441                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 442                 AnalyticsTracker.CATEGORY_TAG,
 443                 &quot;selected_tag_in_navigation_drawer&quot;,
 444                 properties
 445         );
 446 
 447         setSelectedTagActive();
 448     }
 449 
 450     private void checkForFirstLaunch() {
 451         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 452             // Create the welcome note
 453             try {
 454                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 455                 welcomeNote.setCreationDate(Calendar.getInstance());
 456                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 457                 welcomeNote.setContent(getString(R.string.welcome_note));
 458                 welcomeNote.getTitle();
 459                 welcomeNote.save();
 460             } catch (BucketObjectNameInvalid e) {
 461                 // this won&#x27;t happen because welcome-android is a valid name
 462             }
 463 
 464             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 465             SharedPreferences.Editor editor = preferences.edit();
 466             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 467             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 468             editor.apply();
 469         }
 470     }
 471 
 472     private void checkForSharedContent() {
 473         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 474             // Check share action
 475             Intent intent = getIntent();
 476             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 477             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 478 
<abbr title=" 479             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 479             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 480             String intentAction = StrUtils.notNullStr(intent.getAction());
 481             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 482             if (!TextUtils.isEmpty(text)) {
 483                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 484                     text = subject + &quot;\n\n&quot; + text;
 485                 }
 486                 Note note = mNotesBucket.newObject();
 487                 note.setCreationDate(Calendar.getInstance());
 488                 note.setModificationDate(note.getCreationDate());
 489                 note.setContent(text);
 490                 note.save();
 491                 setCurrentNote(note);
 492                 mShouldSelectNewNote = true;
 493 
 494                 AnalyticsTracker.track(
 495                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 496                         AnalyticsTracker.CATEGORY_NOTE,
 497                         &quot;external_share&quot;
 498                 );
 499 
 500                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 501                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 502                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 503                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 504                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 505                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 506                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 507                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 508                     }
 509                 }
 510             }
 511         }
 512     }
 513 
 514     private void updateNavigationDrawerItems() {
 515         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 516         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 517         if (isAlphaSort) {
 518             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 519         } else {
 520             tagCursor = Tag.allWithName(mTagsBucket).execute();
 521         }
 522 
 523         mTagsAdapter.changeCursor(tagCursor);
 524         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 525         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 526 
 527         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 528             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 528             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 529 
 530             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 531                 String name = mTagsAdapter.getItem(i).name;
 532                 int id = (int) mTagsAdapter.getItem(i).id;
 533 
 534                 if (id &gt;= 0) { // Custom tags have a positive ID.
 535                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 536                 }
 537             }
 538 
<abbr title=" 539             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 539             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 540             setSelectedTagActive();
 541         }
 542     }
 543 
 544     public void launchEditTags(View view) {
 545         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 546     }
 547 
 548     private void setSelectedTagActive() {
 549         if (mSelectedTag == null) {
 550             mSelectedTag = mTagsAdapter.getDefaultItem();
 551         }
 552 
 553         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 554 
 555         if (selectedMenuItem != null) {
 556             selectedMenuItem.setChecked(true);
 557         } else {
 558             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 559         }
 560 
 561         setTitle(mSelectedTag.name);
 562     }
 563 
 564     public TagsAdapter.TagMenuItem getSelectedTag() {
 565         if (mSelectedTag == null) {
 566             mSelectedTag = mTagsAdapter.getDefaultItem();
 567         }
 568 
 569         return mSelectedTag;
 570     }
 571 
 572     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 573     public void updateTrashMenuItem() {
 574         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 575             return;
 576 
 577         // Disable the trash icon if there are no notes trashed.
 578         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 579         if (query.count() == 0) {
 580             mEmptyTrashMenuItem.setEnabled(false);
 581         } else {
 582             mEmptyTrashMenuItem.setEnabled(true);
 583         }
 584     }
 585 
 586     private void addEditorFragment() {
 587         FragmentManager fm = getSupportFragmentManager();
 588         FragmentTransaction ft = fm.beginTransaction();
 589         mNoteEditorFragment = new NoteEditorFragment();
 590         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 591         ft.commitAllowingStateLoss();
 592         fm.executePendingTransactions();
 593     }
 594 
 595     private boolean userAccountRequired() {
 596         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 597     }
 598 
 599     /**
 600      * Checks for a previously valid user that is now not authenticated
 601      * Also checks if user account is required (added in version 1.5.6)
 602      *
 603      * @return true if user has invalid authorization
 604      */
 605     private boolean userAuthenticationIsInvalid() {
 606         Simplenote currentApp = (Simplenote) getApplication();
 607         Simperium simperium = currentApp.getSimperium();
 608         User user = simperium.getUser();
 609         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 610         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 611                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 612     }
 613 
 614     public boolean userIsUnauthorized() {
 615         Simplenote currentApp = (Simplenote) getApplication();
 616         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 617     }
 618 
 619     public void setCurrentNote(Note note) {
 620         mCurrentNote = note;
 621     }
 622 
 623     public NoteListFragment getNoteListFragment() {
 624         return mNoteListFragment;
 625     }
 626 
 627     @SuppressWarnings(&quot;ResourceType&quot;)
 628     @Override
 629     public boolean onCreateOptionsMenu(Menu menu) {
 630         super.onCreateOptionsMenu(menu);
 631         MenuInflater inflater = getMenuInflater();
 632         inflater.inflate(R.menu.notes_list, menu);
 633 
 634         // restore the search query if on a landscape tablet
 635         String searchQuery = null;
 636         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 637             searchQuery = mSearchView.getQuery().toString();
 638 
 639         mSearchMenuItem = menu.findItem(R.id.menu_search);
 640         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 641 
 642         if (!TextUtils.isEmpty(searchQuery)) {
 643             mSearchView.setQuery(searchQuery, false);
 644             mSearchMenuItem.expandActionView();
 645         } else {
 646             // Workaround for setting the search placeholder text color
 647             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 648             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 649                     hintHexColor,
 650                     getString(R.string.search))));
 651         }
 652 
 653         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 654             @Override
 655             public boolean onQueryTextChange(String newText) {
 656                 if (mSearchMenuItem.isActionViewExpanded()) {
 657                     getNoteListFragment().searchNotes(newText);
 658                 }
 659                 return true;
 660             }
 661 
 662             @Override
 663             public boolean onQueryTextSubmit(String queryText) {
 664                 getNoteListFragment().searchNotes(queryText);
 665                 return true;
 666             }
 667 
 668         });
 669 
 670         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 671             @Override
 672             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 673                 checkEmptyListText(true);
 674                 if (mNoteListFragment != null) {
 675                     mNoteListFragment.setFloatingActionButtonVisible(false);
 676                 }
 677                 AnalyticsTracker.track(
 678                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 679                         AnalyticsTracker.CATEGORY_NOTE,
 680                         &quot;action_bar_search_tap&quot;
 681                 );
 682                 return true;
 683             }
 684 
 685             @Override
 686             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 687                 // Show all notes again
 688                 if (mNoteListFragment != null) {
 689                     mNoteListFragment.setFloatingActionButtonVisible(true);
 690                 }
 691                 mTabletSearchQuery = &quot;&quot;;
 692                 mSearchView.setQuery(&quot;&quot;, false);
 693                 checkEmptyListText(false);
 694                 getNoteListFragment().clearSearch();
 695                 return true;
 696             }
 697         });
 698 
 699         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 700             @Override
 701             public boolean onMenuItemClick(MenuItem item) {
 702                 if (!mSearchMenuItem.isActionViewExpanded())
 703                     showDetailPlaceholder();
 704                 return false;
 705             }
 706         });
 707 
 708         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 709         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 710             trashItem.setTitle(R.string.undelete);
 711             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 712         } else {
 713             trashItem.setTitle(R.string.delete);
 714             trashItem.setIcon(R.drawable.ic_trash_24dp);
 715         }
 716 
 717         if (DisplayUtils.isLargeScreenLandscape(this)) {
 718             // Restore the search query on landscape tablets
 719             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 720                 mSearchMenuItem.expandActionView();
 721                 mSearchView.setQuery(mTabletSearchQuery, false);
 722                 mSearchView.clearFocus();
 723             }
 724 
 725             if (mCurrentNote != null) {
 726                 menu.findItem(R.id.menu_share).setVisible(true);
 727                 menu.findItem(R.id.menu_view_info).setVisible(true);
 728                 menu.findItem(R.id.menu_checklist).setVisible(true);
 729                 menu.findItem(R.id.menu_history).setVisible(true);
 730                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 731                 menu.findItem(R.id.menu_sidebar).setVisible(true);
 732                 trashItem.setVisible(true);
 733             } else {
 734                 menu.findItem(R.id.menu_share).setVisible(false);
 735                 menu.findItem(R.id.menu_view_info).setVisible(false);
 736                 menu.findItem(R.id.menu_checklist).setVisible(false);
 737                 menu.findItem(R.id.menu_history).setVisible(false);
 738                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 739                 menu.findItem(R.id.menu_sidebar).setVisible(false);
 740                 trashItem.setVisible(false);
 741             }
 742             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 743         } else {
 744             menu.findItem(R.id.menu_search).setVisible(true);
 745             menu.findItem(R.id.menu_share).setVisible(false);
 746             menu.findItem(R.id.menu_view_info).setVisible(false);
 747             menu.findItem(R.id.menu_checklist).setVisible(false);
 748             menu.findItem(R.id.menu_history).setVisible(false);
 749             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 750             menu.findItem(R.id.menu_sidebar).setVisible(false);
 751             trashItem.setVisible(false);
 752             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 753         }
 754 
 755         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 756             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 757             mEmptyTrashMenuItem.setVisible(true);
 758 
 759             updateTrashMenuItem();
 760 
 761             menu.findItem(R.id.menu_search).setVisible(false);
 762             menu.findItem(R.id.menu_share).setVisible(false);
 763             menu.findItem(R.id.menu_history).setVisible(false);
 764             menu.findItem(R.id.menu_checklist).setVisible(false);
 765         }
 766 
 767         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 768 
 769         return true;
 770     }
 771 
 772     @Override
 773     public boolean onOptionsItemSelected(MenuItem item) {
 774         if (mDrawerToggle.onOptionsItemSelected(item)) {
 775             return true;
 776         }
 777         switch (item.getItemId()) {
 778             case R.id.menu_sidebar:
 779                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 780                 if (mNoteListFragment.isHidden()) {
 781                     ft.show(mNoteListFragment);
 782                 } else {
 783                     ft.hide(mNoteListFragment);
 784                 }
 785                 ft.commitNowAllowingStateLoss();
 786                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 787                 return true;
 788             case R.id.menu_markdown_preview:
 789                 if (mIsShowingMarkdown) {
 790                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 791                     item.setTitle(getString(R.string.markdown_show));
 792                     setMarkdownShowing(false);
 793                     mCurrentNote.setPreviewEnabled(false);
 794                 } else {
 795                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 796                     item.setTitle(getString(R.string.markdown_hide));
 797                     setMarkdownShowing(true);
 798                     mCurrentNote.setPreviewEnabled(true);
 799                 }
 800 
 801                 mCurrentNote.save();
 802                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 803 
 804                 return true;
 805             case R.id.menu_delete:
 806                 if (mNoteEditorFragment != null) {
 807                     if (mCurrentNote != null) {
 808                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 809                         mCurrentNote.setModificationDate(Calendar.getInstance());
 810                         mCurrentNote.save();
 811 
 812                         updateViewsAfterTrashAction(mCurrentNote);
 813                     }
 814                 }
 815                 return true;
 816             case R.id.menu_empty_trash:
 817                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 818 
 819                 alert.setTitle(R.string.empty_trash);
 820                 alert.setMessage(R.string.confirm_empty_trash);
 821                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 822                     public void onClick(DialogInterface dialog, int whichButton) {
 823                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 824                         AnalyticsTracker.track(
 825                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 826                                 AnalyticsTracker.CATEGORY_NOTE,
 827                                 &quot;overflow_menu&quot;
 828                         );
 829                     }
 830                 });
 831                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 832                     public void onClick(DialogInterface dialog, int whichButton) {
 833                         // Do nothing, just closing the dialog
 834                     }
 835                 });
 836                 alert.show();
 837                 return true;
 838             case android.R.id.home:
 839                 invalidateOptionsMenu();
 840                 return true;
 841             default:
 842                 return super.onOptionsItemSelected(item);
 843         }
 844     }
 845 
 846     @Override
 847     public boolean onPrepareOptionsMenu(Menu menu) {
 848         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 849 
 850         if (mIsShowingMarkdown) {
 851             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 852             markdownItem.setTitle(getString(R.string.markdown_hide));
 853         } else {
 854             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 855             markdownItem.setTitle(getString(R.string.markdown_show));
 856         }
 857 
 858         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 859 
 860         return super.onPrepareOptionsMenu(menu);
 861     }
 862 
 863     public void updateViewsAfterTrashAction(Note note) {
 864         if (note == null || isFinishing()) {
 865             return;
 866         }
 867 
 868         if (note.isDeleted()) {
 869             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 870             deletedNoteIds.add(note.getSimperiumKey());
 871             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 872             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 873             AnalyticsTracker.track(
 874                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 875                     AnalyticsTracker.CATEGORY_NOTE,
 876                     &quot;overflow_menu&quot;
 877             );
 878         } else {
 879             AnalyticsTracker.track(
 880                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 881                     AnalyticsTracker.CATEGORY_NOTE,
 882                     &quot;overflow_menu&quot;
 883             );
 884         }
 885 
 886         // If we just deleted/restored the active note, show the placeholder
 887         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 888             showDetailPlaceholder();
 889         }
 890 
 891         NoteListFragment fragment = getNoteListFragment();
 892         if (fragment != null) {
 893             fragment.getPrefs();
 894             fragment.refreshList();
 895         }
 896 
 897         invalidateOptionsMenu();
 898     }
 899 
 900     public void setMarkdownShowing(boolean isMarkdownShowing) {
 901         mIsShowingMarkdown = isMarkdownShowing;
 902         if (mNoteEditorFragment != null) {
 903             if (isMarkdownShowing) {
 904                 mNoteEditorFragment.showMarkdown();
 905             } else {
 906                 mNoteEditorFragment.hideMarkdown();
 907             }
 908         }
 909         invalidateOptionsMenu();
 910     }
 911 
 912     /**
 913      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 914      * the item with the given ID was selected. Used for tablets only.
 915      */
 916     @Override
<abbr title=" 917     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 917     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 918         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 919             // Launch the editor activity
 920             Bundle arguments = new Bundle();
 921             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 922             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 923             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 924 
 925             if (matchOffsets != null) {
 926                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 927             }
 928 
 929             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 930             editNoteIntent.putExtras(arguments);
 931             if (mNoteListFragment.isHidden()) {
 932                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 933             }
 934             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 935         } else {
 936             mNoteEditorFragment.setNote(noteID, matchOffsets);
 937             getNoteListFragment().setNoteSelected(noteID);
 938             setMarkdownShowing(isPreviewEnabled);
 939 
 940             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 941                 mTabletSearchQuery = mSearchView.getQuery().toString();
 942             }
 943 
 944             mNoteEditorFragment.clearMarkdown();
 945 
 946             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 947                 setMarkdownShowing(false);
 948             }
 949 
 950             invalidateOptionsMenu();
 951         }
 952 
 953         AnalyticsTracker.track(
 954                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 955                 AnalyticsTracker.CATEGORY_NOTE,
 956                 &quot;note_list_row_tap&quot;
 957         );
 958     }
 959 
 960     @Override
 961     public void onUserCreated(User user) {
 962         // New account created
 963         AnalyticsTracker.track(
 964                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 965                 AnalyticsTracker.CATEGORY_USER,
 966                 &quot;account_created_from_login_activity&quot;
 967         );
 968     }
 969 
 970     public void onUserStatusChange(User.Status status) {
 971         switch (status) {
 972             // successfully used access token to connect to simperium bucket
 973             case AUTHORIZED:
 974                 runOnUiThread(new Runnable() {
 975                     @Override
 976                     public void run() {
 977                         if (!mNotesBucket.hasChangeVersion()) {
 978                             setToolbarProgressVisibility(true);
 979                         }
 980                     }
 981                 });
 982                 break;
 983 
 984             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 985             case NOT_AUTHORIZED:
 986                 runOnUiThread(new Runnable() {
 987                     @Override
 988                     public void run() {
 989                         startLoginActivity(true);
 990                     }
 991                 });
 992                 break;
 993 
<abbr title=" 994             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 994             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 995             case UNKNOWN:
 996                 break;
 997         }
 998     }
 999 
1000     private void setToolbarProgressVisibility(boolean isVisible) {
1001         if (getSupportActionBar() != null) {
1002             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1003         }
1004     }
1005 
1006     public void startLoginActivity(boolean signInFirst) {
1007         // Clear some account-specific prefs
1008         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1009         editor.remove(PrefUtils.PREF_WP_TOKEN);
1010         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1011         editor.apply();
1012 
1013         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1014         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1015     }
1016 
1017     @Override
1018     public void recreate() {
1019         Handler handler = new Handler();
1020         handler.post(new Runnable() {
1021             @Override
1022             public void run() {
1023                 NotesActivity.super.recreate();
1024             }
1025         });
1026     }
1027 
1028     @Override
1029     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1030         super.onActivityResult(requestCode, resultCode, data);
1031         switch (requestCode) {
1032             case Simplenote.INTENT_PREFERENCES:
<abbr title="1033                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1033                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1034                 invalidateOptionsMenu();
1035                 NoteListFragment fragment = getNoteListFragment();
1036                 if (fragment != null) {
1037                     fragment.getPrefs();
1038                     fragment.refreshList();
1039                 }
1040 
1041                 break;
1042             case Simplenote.INTENT_EDIT_NOTE:
1043                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1044                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1045                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1046                         if (noteId != null) {
1047                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1048                             deletedNoteIds.add(noteId);
1049                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1050                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1050                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1051                         }
<abbr title="1052                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1052                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1053                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1054                         mNoteListFragment.setNoteSelected(selectedNoteId);
1055                         if (mNoteEditorFragment != null) {
1056                             mNoteEditorFragment.setNote(selectedNoteId);
1057                         }
1058                     }
1059                 }
1060                 break;
1061             case Simperium.SIGNUP_SIGNIN_REQUEST:
1062                 invalidateOptionsMenu();
1063 
1064                 Simplenote app = (Simplenote) getApplication();
1065                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1066                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1067 
1068                 AnalyticsTracker.track(
1069                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1070                         AnalyticsTracker.CATEGORY_USER,
1071                         &quot;signed_in_from_login_activity&quot;
1072                 );
1073 
1074                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1075                     finish();
1076                 }
1077 
1078                 break;
1079         }
1080     }
1081 
1082     @Override
1083     public void onUndo() {
1084         if (mUndoBarController == null) return;
1085 
1086         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1087         if (deletedNoteIds != null) {
1088             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1089                 Note deletedNote;
1090                 try {
1091                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1092                 } catch (BucketObjectMissingException e) {
1093                     return;
1094                 }
1095                 if (deletedNote != null) {
1096                     deletedNote.setDeleted(false);
1097                     deletedNote.setModificationDate(Calendar.getInstance());
1098                     deletedNote.save();
1099                     NoteListFragment fragment = getNoteListFragment();
1100                     if (fragment != null) {
1101                         fragment.getPrefs();
1102                         fragment.refreshList();
1103                     }
1104                 }
1105             }
1106         }
1107     }
1108 
1109     @Override
1110     protected void onPostCreate(Bundle savedInstanceState) {
1111         super.onPostCreate(savedInstanceState);
1112         // Sync the toggle state after onRestoreInstanceState has occurred.
1113         mDrawerToggle.syncState();
1114     }
1115 
1116     @Override
1117     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1118         super.onConfigurationChanged(newConfig);
1119 
1120         mDrawerToggle.onConfigurationChanged(newConfig);
1121 
1122         if (DisplayUtils.isLargeScreen(this)) {
1123             mIsShowingMarkdown = false;
1124 
1125             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1126                 // Add the editor fragment
1127                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1128                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1128                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1129                 } else if (DisplayUtils.isLandscape(this)) {
1130                     addEditorFragment();
1131                 }
1132 
1133                 if (mNoteListFragment != null) {
1134                     mNoteListFragment.setActivateOnItemClick(true);
1135                     mNoteListFragment.setDividerVisible(true);
1136                 }
1137 
1138                 // Select the current note on a tablet
1139                 if (mCurrentNote != null) {
<abbr title="1140                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1140                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1141                 } else {
1142                     mNoteEditorFragment.setPlaceholderVisible(true);
1143                     mNoteListFragment.getListView().clearChoices();
1144                 }
1145 
1146                 invalidateOptionsMenu();
<abbr title="1147             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1147             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1148             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1149                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1149                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1150             }
1151         }
1152 
1153         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1154             // Remove the editor fragment when rotating back to portrait
1155             mCurrentNote = null;
1156             if (mNoteListFragment != null) {
1157                 mNoteListFragment.setActivateOnItemClick(false);
1158                 mNoteListFragment.setDividerVisible(false);
1159                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1160                 mNoteListFragment.refreshList();
1161             }
1162             FragmentManager fm = getSupportFragmentManager();
1163             FragmentTransaction ft = fm.beginTransaction();
1164             ft.remove(mNoteEditorFragment);
1165             mNoteEditorFragment = null;
1166             ft.commitAllowingStateLoss();
1167             fm.executePendingTransactions();
1168             invalidateOptionsMenu();
1169         }
1170     }
1171 
1172     public void checkEmptyListText(boolean isSearch) {
1173         if (isSearch) {
<abbr title="1174             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1174             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1175             getNoteListFragment().setEmptyListViewClickable(false);
1176         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1177             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1177             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1178             AnalyticsTracker.track(
1179                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1180                     AnalyticsTracker.CATEGORY_NOTE,
1181                     &quot;trash_filter_selected&quot;
1182             );
1183             getNoteListFragment().setEmptyListViewClickable(false);
1184         } else {
<abbr title="1185             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1185             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1186             getNoteListFragment().setEmptyListViewClickable(true);
1187         }
1188     }
1189 
1190     public void showDetailPlaceholder() {
1191         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1192             mCurrentNote = null;
1193             mNoteEditorFragment.setPlaceholderVisible(true);
1194             mNoteEditorFragment.clearMarkdown();
1195             mNoteEditorFragment.hideMarkdown();
1196             mIsShowingMarkdown = false;
1197         }
1198     }
1199 
1200     public void stopListeningToNotesBucket() {
1201         mNotesBucket.removeOnNetworkChangeListener(this);
1202         mNotesBucket.removeOnSaveObjectListener(this);
1203         mNotesBucket.removeOnDeleteObjectListener(this);
1204     }
1205 
1206     // Returns the appropriate view to show the undo bar within
1207     private View getUndoView() {
1208         View undoView = mFragmentsContainer;
1209         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1210                 getNoteListFragment() != null &amp;&amp;
1211                 getNoteListFragment().getRootView() != null) {
1212             undoView = getNoteListFragment().getRootView();
1213         }
1214 
1215         return undoView;
1216     }
1217 
1218     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1219         if (mUndoBarController != null) {
1220             mUndoBarController.setDeletedNoteIds(noteIds);
1221             mUndoBarController.showUndoBar(
1222                     getUndoView(),
<abbr title="1223                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1223                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1224             );
1225         }
1226     }
1227 
1228     /* Simperium Bucket Listeners */
1229     // received a change from the network, refresh the list
1230     @Override
1231     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1232         runOnUiThread(new Runnable() {
1233             @Override
1234             public void run() {
1235                 if (type == Bucket.ChangeType.INDEX) {
1236                     setToolbarProgressVisibility(false);
1237                 }
1238                 mNoteListFragment.refreshList();
1239             }
1240         });
1241     }
1242 
1243     @Override
1244     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1245         runOnUiThread(new Runnable() {
1246             @Override
1247             public void run() {
1248                 mNoteListFragment.refreshList();
1249             }
1250         });
1251     }
1252 
1253     @Override
1254     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1255         runOnUiThread(new Runnable() {
1256             @Override
1257             public void run() {
1258                 mNoteListFragment.refreshList();
1259             }
1260         });
1261     }
1262 
1263     @Override
1264     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1265         // noop, NoteEditorFragment will handle this
1266     }
1267 
1268     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1269 
1270         @Override
1271         protected Void doInBackground(Void... voids) {
1272             if (mNotesBucket == null) return null;
1273 
1274             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1275             Bucket.ObjectCursor c = query.execute();
1276             while (c.moveToNext()) {
1277                 c.getObject().delete();
1278             }
1279 
1280             return null;
1281         }
1282 
1283         @Override
1284         protected void onPostExecute(Void nada) {
1285             showDetailPlaceholder();
1286         }
1287     }
1288 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 import androidx.annotation.NonNull;
  20 import androidx.appcompat.app.ActionBar;
  21 import androidx.appcompat.app.ActionBarDrawerToggle;
  22 import androidx.appcompat.app.AlertDialog;
  23 import androidx.appcompat.app.AppCompatActivity;
  24 import androidx.appcompat.widget.SearchView;
  25 import androidx.appcompat.widget.Toolbar;
  26 import androidx.core.view.GravityCompat;
  27 import androidx.drawerlayout.widget.DrawerLayout;
  28 import androidx.fragment.app.FragmentManager;
  29 import androidx.fragment.app.FragmentTransaction;
  30 import androidx.preference.PreferenceManager;
  31 import com.automattic.simplenote.analytics.AnalyticsTracker;
  32 import com.automattic.simplenote.models.Note;
  33 import com.automattic.simplenote.models.Tag;
  34 import com.automattic.simplenote.utils.CrashUtils;
  35 import com.automattic.simplenote.utils.DisplayUtils;
  36 import com.automattic.simplenote.utils.DrawableUtils;
  37 import com.automattic.simplenote.utils.HtmlCompat;
  38 import com.automattic.simplenote.utils.PrefUtils;
  39 import com.automattic.simplenote.utils.StrUtils;
  40 import com.automattic.simplenote.utils.TagsAdapter;
  41 import com.automattic.simplenote.utils.ThemeUtils;
  42 import com.automattic.simplenote.utils.UndoBarController;
  43 import com.google.android.material.navigation.NavigationView;
  44 import com.simperium.Simperium;
  45 import com.simperium.client.Bucket;
  46 import com.simperium.client.BucketObjectMissingException;
  47 import com.simperium.client.BucketObjectNameInvalid;
  48 import com.simperium.client.Query;
  49 import com.simperium.client.User;
  50 import java.util.ArrayList;
  51 import java.util.Calendar;
  52 import java.util.HashMap;
  53 import java.util.List;
  54 import java.util.Map;
  55 import org.wordpress.passcodelock.AppLockManager;
  56 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  57 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  58 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  59 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  60 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  61 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  62 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  63 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  64 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  65 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  66 
  67 
<abbr title="  68 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  68 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  69     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  70 
  71     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  72 
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74 
  75     protected Bucket&lt;Tag&gt; mTagsBucket;
  76 
  77     private boolean mIsShowingMarkdown;
  78 
  79     private boolean mShouldSelectNewNote;
  80 
  81     private boolean mIsSettingsClicked;
  82 
  83     private boolean mIsTabetFullscreen;
  84 
  85     private String mTabletSearchQuery;
  86 
  87     private UndoBarController mUndoBarController;
  88 
  89     private View mFragmentsContainer;
  90 
  91     private SearchView mSearchView;
  92 
  93     private MenuItem mSearchMenuItem;
  94 
  95     private NoteListFragment mNoteListFragment;
  96 
  97     private NoteEditorFragment mNoteEditorFragment;
  98 
  99     private Note mCurrentNote;
 100 
 101     private MenuItem mEmptyTrashMenuItem;
 102 
 103     // Menu drawer
 104     // Menu drawer
 105     private static final int GROUP_PRIMARY = 100;
 106 
 107     private static final int GROUP_SECONDARY = 101;
 108 
 109     private static final int GROUP_TERTIARY = 102;
 110 
 111     private DrawerLayout mDrawerLayout;
 112 
 113     private Menu mNavigationMenu;
 114 
 115     private ActionBarDrawerToggle mDrawerToggle;
 116 
 117     private TagsAdapter mTagsAdapter;
 118 
 119     private TagsAdapter.TagMenuItem mSelectedTag;
 120 
 121     // Tags bucket listener
 122     // Tags bucket listener
 123     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 124         void updateNavigationDrawer() {
 125             runOnUiThread(new Runnable() {
 126                 public void run() {
 127                     updateNavigationDrawerItems();
 128                 }
 129             });
 130         }
 131 
 132         @Override
 133         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 134             updateNavigationDrawer();
 135         }
 136 
 137         @Override
 138         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 139             updateNavigationDrawer();
 140         }
 141 
 142         @Override
 143         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 144             updateNavigationDrawer();
 145         }
 146 
 147         @Override
 148         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 149             // noop
 150         }
 151     };
 152 
 153     @Override
 154     protected void onCreate(Bundle savedInstanceState) {
 155         ThemeUtils.setTheme(this);
 156         super.onCreate(savedInstanceState);
 157 
 158         setContentView(R.layout.activity_notes);
 159 
 160         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 161 
 162         Simplenote currentApp = (Simplenote) getApplication();
 163         if (mNotesBucket == null) {
 164             mNotesBucket = currentApp.getNotesBucket();
 165         }
 166 
 167         if (mTagsBucket == null) {
 168             mTagsBucket = currentApp.getTagsBucket();
 169         }
 170 
 171         Toolbar toolbar = findViewById(R.id.toolbar);
 172         setSupportActionBar(toolbar);
 173         configureNavigationDrawer(toolbar);
 174 
 175         if (savedInstanceState == null) {
 176             mNoteListFragment = new NoteListFragment();
 177             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 178             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 179             fragmentTransaction.commit();
 180         } else {
<abbr title=" 181             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 181             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 182         }
 183         mIsTabetFullscreen = mNoteListFragment.isHidden();
 184 
 185         if (DisplayUtils.isLargeScreen(this)) {
 186             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 187                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 187                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 188             } else if (DisplayUtils.isLandscape(this)) {
 189                 addEditorFragment();
 190             }
 191         }
 192 
 193         // enable ActionBar app icon to behave as action to toggle nav drawer
 194         ActionBar actionBar = getSupportActionBar();
 195         if (actionBar != null) {
 196             actionBar.setDisplayHomeAsUpEnabled(true);
 197             actionBar.setHomeButtonEnabled(true);
 198 
 199             // Add loading indicator to show when indexing
<abbr title=" 200             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 200             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 201             actionBar.setDisplayShowCustomEnabled(true);
 202             actionBar.setCustomView(progressBar);
 203             setToolbarProgressVisibility(false);
 204         }
 205 
 206         mUndoBarController = new UndoBarController(this);
 207 
 208         // Creates &#x27;Welcome&#x27; note
 209         checkForFirstLaunch();
 210 
 211         checkForSharedContent();
 212 
 213         currentApp.getSimperium().setOnUserCreatedListener(this);
 214         currentApp.getSimperium().setUserStatusChangeListener(this);
 215     }
 216 
 217     @Override
 218     protected void onResume() {
 219         super.onResume();
 220 
 221         // Ensure user has valid authorization
 222         if (userAuthenticationIsInvalid()) {
 223             startLoginActivity(true);
 224             Intent intent = getIntent();
 225 
 226             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 227                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 228                 AnalyticsTracker.track(
 229                         NOTE_WIDGET_SIGN_IN_TAPPED,
 230                         CATEGORY_WIDGET,
 231                         &quot;note_widget_sign_in_tapped&quot;
 232                 );
 233             }
 234         }
 235 
 236         disableScreenshotsIfLocked(this);
 237 
 238         mNotesBucket.start();
 239         mTagsBucket.start();
 240 
 241         mNotesBucket.addOnNetworkChangeListener(this);
 242         mNotesBucket.addOnSaveObjectListener(this);
 243         mNotesBucket.addOnDeleteObjectListener(this);
 244         mTagsBucket.addListener(mTagsMenuUpdater);
 245 
 246         updateNavigationDrawerItems();
 247 
 248         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 249         if (userIsUnauthorized()) {
 250             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 251                 mSelectedTag = null;
 252                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 253             }
 254         }
 255 
 256         filterListBySelectedTag();
 257 
 258         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 259             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 259             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 260             mShouldSelectNewNote = false;
 261         }
 262 
 263         if (mIsShowingMarkdown) {
 264             setMarkdownShowing(false);
 265         }
 266 
 267         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 268         if(DisplayUtils.isLargeScreenLandscape(this)) {
 269             if (mIsTabetFullscreen) {
 270                 ft.hide(mNoteListFragment);
 271             } else {
 272                 ft.show(mNoteListFragment);
 273             }
 274         } else {
 275             ft.show(mNoteListFragment);
 276         }
 277         ft.commitNow();
 278     }
 279 
 280     @Override
 281     protected void onPause() {
 282         super.onPause();  // Always call the superclass method first
 283         mTagsBucket.removeListener(mTagsMenuUpdater);
 284         mTagsBucket.stop();
 285 
 286         mNotesBucket.removeOnNetworkChangeListener(this);
 287         mNotesBucket.removeOnSaveObjectListener(this);
 288         mNotesBucket.removeOnDeleteObjectListener(this);
 289         mNotesBucket.stop();
 290     }
 291 
 292     @Override
 293     public void setTitle(CharSequence title) {
 294         if (getSupportActionBar() != null) {
 295             getSupportActionBar().setTitle(title);
 296         }
 297     }
 298 
 299     @Override
 300     public void onBackPressed() {
 301         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 302             mDrawerLayout.closeDrawer(GravityCompat.START);
 303         } else {
 304             super.onBackPressed();
 305         }
 306     }
 307 
 308     @Override
 309     public void onActionModeCreated() {
 310         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 311     }
 312 
 313     @Override
 314     public void onActionModeDestroyed() {
 315         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 316     }
 317 
 318     private ColorStateList getTextSelector() {
 319         int[][] states = new int[][]{ new int[]{ -android.R.attr.state_enabled }// disabled
 320         // disabled
 321         // disabled
 322         , new int[]{ android.R.attr.state_checked }// checked
 323         // checked
 324         // checked
 325         , new int[]{ -android.R.attr.state_checked }// unchecked
 326         // unchecked
 327         // unchecked
 328          };
<abbr title=" 329         int[] colors = new int[]{ getResources().getColor(R.color.text_title_disabled, getTheme()), ThemeUtils.getColorFromAttribute(this, R.attr.colorAccent), ThemeUtils.getColorFromAttribute(this, R.attr.noteTitleColor) };"> 329         int[] colors = new int[]{ getResources().getColor(R.color.text_title_disabled, getTheme()), ThemeðŸ”µ</abbr>
 330         return new ColorStateList(states, colors);
 331     }
 332 
 333     private void configureNavigationDrawer(Toolbar toolbar) {
 334         ColorStateList iconSelector = getIconSelector();
 335         ColorStateList textSelector = getTextSelector();
 336         mDrawerLayout = findViewById(R.id.drawer_layout);
 337         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 338         NavigationView navigationView = findViewById(R.id.navigation_view);
 339         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 340         navigationView.setItemIconTintList(iconSelector);
 341         navigationView.setItemTextColor(textSelector);
<abbr title=" 342         navigationView.setNavigationItemSelectedListener(new NavigationView.OnNavigationItemSelectedListener() {"> 342         navigationView.setNavigationItemSelectedListener(new NavigationView.OnNavigationItemSelectedListeðŸ”µ</abbr>
 343             @Override
 344             public boolean onNavigationItemSelected(@NonNull
 345             MenuItem item) {
 346                 mDrawerLayout.closeDrawer(GravityCompat.START);
 347                 if (item.getItemId() == SETTINGS_ID) {
<abbr title=" 348                     AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;, new HashMap&lt;String, String&gt;(1) {"> 348                     AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGOðŸ”µ</abbr>
 349                         {
 350                             put(&quot;tag&quot;, &quot;settings&quot;);
 351                         }
 352                     });
 353                     mIsSettingsClicked = true;
 354                     return false;
 355                 } else {
 356                     mSelectedTag = mTagsAdapter.getTagFromItem(item);
 357                     filterListBySelectedTag();
 358                     return true;
 359                 }
 360             }
 361         });
 362         mNavigationMenu = navigationView.getMenu();
<abbr title=" 363         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 363         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 364         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 364         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 365         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 365         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 366         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 367         if (mSelectedTag == null) {
 368             mSelectedTag = mTagsAdapter.getDefaultItem();
 369         }
<abbr title=" 370         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.string.close_drawer) {"> 370         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.sðŸ”µ</abbr>
 371             public void onDrawerClosed(View view) {
 372                 supportInvalidateOptionsMenu();
 373                 if (mIsSettingsClicked) {
 374                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 375                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 376                     mIsSettingsClicked = false;
 377                 }
 378             }
 379 
 380             public void onDrawerOpened(View drawerView) {
 381                 // noop
 382             }
 383 
 384             @Override
 385             public void onDrawerSlide(View drawerView, float slideOffset) {
 386                 super.onDrawerSlide(drawerView, 0.0F);
 387             }
 388         };
 389         mDrawerLayout.addDrawerListener(mDrawerToggle);
 390     }
 391 
 392     private void filterListBySelectedTag() {
 393         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 394 
 395         if (selectedMenuItem != null) {
 396             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 397         } else {
 398             mSelectedTag = mTagsAdapter.getDefaultItem();
 399         }
 400 
 401         checkEmptyListText(false);
 402 
 403         if (mNoteListFragment.isHidden()) {
 404             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 405             fragmentTransaction.show(mNoteListFragment);
 406             fragmentTransaction.commitNowAllowingStateLoss();
 407         }
 408 
 409         // Disable long press on notes when viewing Trash.
 410         if (mSelectedTag.id == TRASH_ID) {
 411             getNoteListFragment().getListView().setLongClickable(false);
 412         } else {
 413             getNoteListFragment().getListView().setLongClickable(true);
 414         }
 415 
 416         getNoteListFragment().refreshListFromNavSelect();
 417 
 418         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 419 
 420         switch ((int) mSelectedTag.id) {
 421             case ALL_NOTES_ID:
 422                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 423                 break;
 424             case TRASH_ID:
 425                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 426                 break;
 427             case UNTAGGED_NOTES_ID:
 428                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 429                 break;
 430             default:
 431                 properties = null;
 432                 break;
 433         }
 434 
 435         AnalyticsTracker.track(
 436                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 437                 AnalyticsTracker.CATEGORY_TAG,
 438                 &quot;selected_tag_in_navigation_drawer&quot;,
 439                 properties
 440         );
 441 
 442         setSelectedTagActive();
 443     }
 444 
 445     private void checkForFirstLaunch() {
 446         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 447             // Create the welcome note
 448             try {
 449                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 450                 welcomeNote.setCreationDate(Calendar.getInstance());
 451                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 452                 welcomeNote.setContent(getString(R.string.welcome_note));
 453                 welcomeNote.getTitle();
 454                 welcomeNote.save();
 455             } catch (BucketObjectNameInvalid e) {
 456                 // this won&#x27;t happen because welcome-android is a valid name
 457             }
 458 
 459             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 460             SharedPreferences.Editor editor = preferences.edit();
 461             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 462             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 463             editor.apply();
 464         }
 465     }
 466 
 467     private void checkForSharedContent() {
 468         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 469             // Check share action
 470             Intent intent = getIntent();
 471             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 472             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 473 
<abbr title=" 474             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 474             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 475             String intentAction = StrUtils.notNullStr(intent.getAction());
 476             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 477             if (!TextUtils.isEmpty(text)) {
 478                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 479                     text = subject + &quot;\n\n&quot; + text;
 480                 }
 481                 Note note = mNotesBucket.newObject();
 482                 note.setCreationDate(Calendar.getInstance());
 483                 note.setModificationDate(note.getCreationDate());
 484                 note.setContent(text);
 485                 note.save();
 486                 setCurrentNote(note);
 487                 mShouldSelectNewNote = true;
 488 
 489                 AnalyticsTracker.track(
 490                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 491                         AnalyticsTracker.CATEGORY_NOTE,
 492                         &quot;external_share&quot;
 493                 );
 494 
 495                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 496                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 497                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 498                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 499                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 500                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 501                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 502                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 503                     }
 504                 }
 505             }
 506         }
 507     }
 508 
 509     private void updateNavigationDrawerItems() {
 510         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 511         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 512         if (isAlphaSort) {
 513             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 514         } else {
 515             tagCursor = Tag.allWithName(mTagsBucket).execute();
 516         }
 517         mTagsAdapter.changeCursor(tagCursor);
 518         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 519         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 520         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 521             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 521             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 522             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 523                 String name = mTagsAdapter.getItem(i).name;
 524                 int id = ((int) (mTagsAdapter.getItem(i).id));
 525                 if (id &gt;= 0) {
 526                     // Custom tags have a positive ID.
 527                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 528                 }
 529             }
<abbr title=" 530             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 530             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 531             setSelectedTagActive();
 532         }
 533     }
 534 
 535     public void launchEditTags(View view) {
 536         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 537     }
 538 
 539     private void setSelectedTagActive() {
 540         if (mSelectedTag == null) {
 541             mSelectedTag = mTagsAdapter.getDefaultItem();
 542         }
 543 
 544         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 545 
 546         if (selectedMenuItem != null) {
 547             selectedMenuItem.setChecked(true);
 548         } else {
 549             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 550         }
 551 
 552         setTitle(mSelectedTag.name);
 553     }
 554 
 555     public TagsAdapter.TagMenuItem getSelectedTag() {
 556         if (mSelectedTag == null) {
 557             mSelectedTag = mTagsAdapter.getDefaultItem();
 558         }
 559 
 560         return mSelectedTag;
 561     }
 562 
 563     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 564     public void updateTrashMenuItem() {
 565         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 566             return;
 567 
 568         // Disable the trash icon if there are no notes trashed.
 569         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 570         if (query.count() == 0) {
 571             mEmptyTrashMenuItem.setEnabled(false);
 572         } else {
 573             mEmptyTrashMenuItem.setEnabled(true);
 574         }
 575     }
 576 
 577     private void addEditorFragment() {
 578         FragmentManager fm = getSupportFragmentManager();
 579         FragmentTransaction ft = fm.beginTransaction();
 580         mNoteEditorFragment = new NoteEditorFragment();
 581         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 582         ft.commitAllowingStateLoss();
 583         fm.executePendingTransactions();
 584     }
 585 
 586     private boolean userAccountRequired() {
 587         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 588     }
 589 
 590     /**
 591      * Checks for a previously valid user that is now not authenticated
 592      * Also checks if user account is required (added in version 1.5.6)
 593      *
 594      * @return true if user has invalid authorization
 595      */
 596     private boolean userAuthenticationIsInvalid() {
 597         Simplenote currentApp = (Simplenote) getApplication();
 598         Simperium simperium = currentApp.getSimperium();
 599         User user = simperium.getUser();
 600         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 601         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 602                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 603     }
 604 
 605     public boolean userIsUnauthorized() {
 606         Simplenote currentApp = (Simplenote) getApplication();
 607         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 608     }
 609 
 610     public void setCurrentNote(Note note) {
 611         mCurrentNote = note;
 612     }
 613 
 614     public NoteListFragment getNoteListFragment() {
 615         return mNoteListFragment;
 616     }
 617 
 618     @SuppressWarnings(&quot;ResourceType&quot;)
 619     @Override
 620     public boolean onCreateOptionsMenu(Menu menu) {
 621         super.onCreateOptionsMenu(menu);
 622         MenuInflater inflater = getMenuInflater();
 623         inflater.inflate(R.menu.notes_list, menu);
 624         // restore the search query if on a landscape tablet
 625         String searchQuery = null;
 626         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 627             searchQuery = mSearchView.getQuery().toString();
 628         }
 629         mSearchMenuItem = menu.findItem(R.id.menu_search);
 630         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 631         if (!TextUtils.isEmpty(searchQuery)) {
 632             mSearchView.setQuery(searchQuery, false);
 633             mSearchMenuItem.expandActionView();
 634         } else {
 635             // Workaround for setting the search placeholder text color
 636             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
<abbr title=" 637             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 637             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 638         }
 639         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 640             @Override
 641             public boolean onQueryTextChange(String newText) {
 642                 if (mSearchMenuItem.isActionViewExpanded()) {
 643                     getNoteListFragment().searchNotes(newText);
 644                 }
 645                 return true;
 646             }
 647 
 648             @Override
 649             public boolean onQueryTextSubmit(String queryText) {
 650                 getNoteListFragment().searchNotes(queryText);
 651                 return true;
 652             }
 653         });
 654         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 655             @Override
 656             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 657                 checkEmptyListText(true);
 658                 if (mNoteListFragment != null) {
 659                     mNoteListFragment.setFloatingActionButtonVisible(false);
 660                 }
<abbr title=" 661                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGORY_NOTE, &quot;action_bar_search_tap&quot;);"> 661                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGOðŸ”µ</abbr>
 662                 return true;
 663             }
 664 
 665             @Override
 666             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 667                 // Show all notes again
 668                 if (mNoteListFragment != null) {
 669                     mNoteListFragment.setFloatingActionButtonVisible(true);
 670                 }
 671                 mTabletSearchQuery = &quot;&quot;;
 672                 mSearchView.setQuery(&quot;&quot;, false);
 673                 checkEmptyListText(false);
 674                 getNoteListFragment().clearSearch();
 675                 return true;
 676             }
 677         });
 678         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 679             @Override
 680             public boolean onMenuItemClick(MenuItem item) {
 681                 if (!mSearchMenuItem.isActionViewExpanded()) {
 682                     showDetailPlaceholder();
 683                 }
 684                 return false;
 685             }
 686         });
 687         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 688         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 689             trashItem.setTitle(R.string.undelete);
 690             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 691         } else {
 692             trashItem.setTitle(R.string.delete);
 693             trashItem.setIcon(R.drawable.ic_trash_24dp);
 694         }
 695         if (DisplayUtils.isLargeScreenLandscape(this)) {
 696             // Restore the search query on landscape tablets
 697             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 698                 mSearchMenuItem.expandActionView();
 699                 mSearchView.setQuery(mTabletSearchQuery, false);
 700                 mSearchView.clearFocus();
 701             }
 702             if (mCurrentNote != null) {
 703                 menu.findItem(R.id.menu_share).setVisible(true);
 704                 menu.findItem(R.id.menu_view_info).setVisible(true);
 705                 menu.findItem(R.id.menu_checklist).setVisible(true);
 706                 menu.findItem(R.id.menu_history).setVisible(true);
 707                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 708                 menu.findItem(R.id.menu_sidebar).setVisible(true);
 709                 trashItem.setVisible(true);
 710             } else {
 711                 menu.findItem(R.id.menu_share).setVisible(false);
 712                 menu.findItem(R.id.menu_view_info).setVisible(false);
 713                 menu.findItem(R.id.menu_checklist).setVisible(false);
 714                 menu.findItem(R.id.menu_history).setVisible(false);
 715                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 716                 menu.findItem(R.id.menu_sidebar).setVisible(false);
 717                 trashItem.setVisible(false);
 718             }
 719             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 720         } else {
 721             menu.findItem(R.id.menu_search).setVisible(true);
 722             menu.findItem(R.id.menu_share).setVisible(false);
 723             menu.findItem(R.id.menu_view_info).setVisible(false);
 724             menu.findItem(R.id.menu_checklist).setVisible(false);
 725             menu.findItem(R.id.menu_history).setVisible(false);
 726             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 727             menu.findItem(R.id.menu_sidebar).setVisible(false);
 728             trashItem.setVisible(false);
 729             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 730         }
 731         if ((mSelectedTag != null) &amp;&amp; (mSelectedTag.id == TRASH_ID)) {
 732             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 733             mEmptyTrashMenuItem.setVisible(true);
 734             updateTrashMenuItem();
 735             menu.findItem(R.id.menu_search).setVisible(false);
 736             menu.findItem(R.id.menu_share).setVisible(false);
 737             menu.findItem(R.id.menu_history).setVisible(false);
 738             menu.findItem(R.id.menu_checklist).setVisible(false);
 739         }
 740         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 741         return true;
 742     }
 743 
 744     @Override
 745     public boolean onOptionsItemSelected(MenuItem item) {
 746         if (mDrawerToggle.onOptionsItemSelected(item)) {
 747             return true;
 748         }
 749         switch (item.getItemId()) {
 750             case R.id.menu_sidebar :
 751                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 752                 if (mNoteListFragment.isHidden()) {
 753                     ft.show(mNoteListFragment);
 754                 } else {
 755                     ft.hide(mNoteListFragment);
 756                 }
 757                 ft.commitNowAllowingStateLoss();
 758                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 759                 return true;
 760             case R.id.menu_markdown_preview :
 761                 if (mIsShowingMarkdown) {
 762                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 763                     item.setTitle(getString(R.string.markdown_show));
 764                     setMarkdownShowing(false);
 765                     mCurrentNote.setPreviewEnabled(false);
 766                 } else {
 767                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 768                     item.setTitle(getString(R.string.markdown_hide));
 769                     setMarkdownShowing(true);
 770                     mCurrentNote.setPreviewEnabled(true);
 771                 }
 772                 mCurrentNote.save();
 773                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 774                 return true;
 775             case R.id.menu_delete :
 776                 if (mNoteEditorFragment != null) {
 777                     if (mCurrentNote != null) {
 778                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 779                         mCurrentNote.setModificationDate(Calendar.getInstance());
 780                         mCurrentNote.save();
 781                         updateViewsAfterTrashAction(mCurrentNote);
 782                     }
 783                 }
 784                 return true;
 785             case R.id.menu_empty_trash :
 786                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 787                 alert.setTitle(R.string.empty_trash);
 788                 alert.setMessage(R.string.confirm_empty_trash);
 789                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 790                     public void onClick(DialogInterface dialog, int whichButton) {
 791                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
<abbr title=" 792                         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TRASH_EMPTIED, AnalyticsTracker.CATEGORY_NOTE, &quot;overflow_menu&quot;);"> 792                         AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TRASH_EMPTIED, AnalyticsTrackerðŸ”µ</abbr>
 793                     }
 794                 });
 795                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 796                     public void onClick(DialogInterface dialog, int whichButton) {
 797                         // Do nothing, just closing the dialog
 798                     }
 799                 });
 800                 alert.show();
 801                 return true;
 802             case android.R.id.home :
 803                 invalidateOptionsMenu();
 804                 return true;
 805             default :
 806                 return super.onOptionsItemSelected(item);
 807         }
 808     }
 809 
 810     @Override
 811     public boolean onPrepareOptionsMenu(Menu menu) {
 812         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 813         if (mIsShowingMarkdown) {
 814             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 815             markdownItem.setTitle(getString(R.string.markdown_hide));
 816         } else {
 817             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 818             markdownItem.setTitle(getString(R.string.markdown_show));
 819         }
 820         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 821         return super.onPrepareOptionsMenu(menu);
 822     }
 823 
 824     public void updateViewsAfterTrashAction(Note note) {
 825         if (note == null || isFinishing()) {
 826             return;
 827         }
 828 
 829         if (note.isDeleted()) {
 830             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 831             deletedNoteIds.add(note.getSimperiumKey());
 832             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 833             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 834             AnalyticsTracker.track(
 835                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 836                     AnalyticsTracker.CATEGORY_NOTE,
 837                     &quot;overflow_menu&quot;
 838             );
 839         } else {
 840             AnalyticsTracker.track(
 841                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 842                     AnalyticsTracker.CATEGORY_NOTE,
 843                     &quot;overflow_menu&quot;
 844             );
 845         }
 846 
 847         // If we just deleted/restored the active note, show the placeholder
 848         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 849             showDetailPlaceholder();
 850         }
 851 
 852         NoteListFragment fragment = getNoteListFragment();
 853         if (fragment != null) {
 854             fragment.getPrefs();
 855             fragment.refreshList();
 856         }
 857 
 858         invalidateOptionsMenu();
 859     }
 860 
 861     public void setMarkdownShowing(boolean isMarkdownShowing) {
 862         mIsShowingMarkdown = isMarkdownShowing;
 863         if (mNoteEditorFragment != null) {
 864             if (isMarkdownShowing) {
 865                 mNoteEditorFragment.showMarkdown();
 866             } else {
 867                 mNoteEditorFragment.hideMarkdown();
 868             }
 869         }
 870         invalidateOptionsMenu();
 871     }
 872 
 873     /**
 874      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 875      * the item with the given ID was selected. Used for tablets only.
 876      */
 877     @Override
<abbr title=" 878     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 878     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 879         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 880             // Launch the editor activity
 881             Bundle arguments = new Bundle();
 882             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 883             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 884             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 885 
 886             if (matchOffsets != null) {
 887                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 888             }
 889 
 890             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 891             editNoteIntent.putExtras(arguments);
 892             if (mNoteListFragment.isHidden()) {
 893                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 894             }
 895             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 896         } else {
 897             mNoteEditorFragment.setNote(noteID, matchOffsets);
 898             getNoteListFragment().setNoteSelected(noteID);
 899             setMarkdownShowing(isPreviewEnabled);
 900 
 901             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 902                 mTabletSearchQuery = mSearchView.getQuery().toString();
 903             }
 904 
 905             mNoteEditorFragment.clearMarkdown();
 906 
 907             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 908                 setMarkdownShowing(false);
 909             }
 910 
 911             invalidateOptionsMenu();
 912         }
 913 
 914         AnalyticsTracker.track(
 915                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 916                 AnalyticsTracker.CATEGORY_NOTE,
 917                 &quot;note_list_row_tap&quot;
 918         );
 919     }
 920 
 921     @Override
 922     public void onUserCreated(User user) {
 923         // New account created
 924         AnalyticsTracker.track(
 925                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 926                 AnalyticsTracker.CATEGORY_USER,
 927                 &quot;account_created_from_login_activity&quot;
 928         );
 929     }
 930 
 931     public void onUserStatusChange(User.Status status) {
 932         switch (status) {
 933             // successfully used access token to connect to simperium bucket
 934             case AUTHORIZED:
 935                 runOnUiThread(new Runnable() {
 936                     @Override
 937                     public void run() {
 938                         if (!mNotesBucket.hasChangeVersion()) {
 939                             setToolbarProgressVisibility(true);
 940                         }
 941                     }
 942                 });
 943                 break;
 944 
 945             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 946             case NOT_AUTHORIZED:
 947                 runOnUiThread(new Runnable() {
 948                     @Override
 949                     public void run() {
 950                         startLoginActivity(true);
 951                     }
 952                 });
 953                 break;
 954 
<abbr title=" 955             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 955             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 956             case UNKNOWN:
 957                 break;
 958         }
 959     }
 960 
 961     private void setToolbarProgressVisibility(boolean isVisible) {
 962         if (getSupportActionBar() != null) {
 963             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 964         }
 965     }
 966 
 967     public void startLoginActivity(boolean signInFirst) {
 968         // Clear some account-specific prefs
 969         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 970         editor.remove(PrefUtils.PREF_WP_TOKEN);
 971         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 972         editor.apply();
 973 
 974         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
 975         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
 976     }
 977 
 978     @Override
 979     public void recreate() {
 980         Handler handler = new Handler();
 981         handler.post(new Runnable() {
 982             @Override
 983             public void run() {
 984                 NotesActivity.super.recreate();
 985             }
 986         });
 987     }
 988 
 989     @Override
 990     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 991         super.onActivityResult(requestCode, resultCode, data);
 992         switch (requestCode) {
 993             case Simplenote.INTENT_PREFERENCES:
<abbr title=" 994                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 994                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 995                 invalidateOptionsMenu();
 996                 NoteListFragment fragment = getNoteListFragment();
 997                 if (fragment != null) {
 998                     fragment.getPrefs();
 999                     fragment.refreshList();
1000                 }
1001 
1002                 break;
1003             case Simplenote.INTENT_EDIT_NOTE:
1004                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1005                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1006                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1007                         if (noteId != null) {
1008                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1009                             deletedNoteIds.add(noteId);
1010                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1011                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1011                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1012                         }
<abbr title="1013                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1013                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1014                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1015                         mNoteListFragment.setNoteSelected(selectedNoteId);
1016                         if (mNoteEditorFragment != null) {
1017                             mNoteEditorFragment.setNote(selectedNoteId);
1018                         }
1019                     }
1020                 }
1021                 break;
1022             case Simperium.SIGNUP_SIGNIN_REQUEST:
1023                 invalidateOptionsMenu();
1024 
1025                 Simplenote app = (Simplenote) getApplication();
1026                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1027                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1028 
1029                 AnalyticsTracker.track(
1030                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1031                         AnalyticsTracker.CATEGORY_USER,
1032                         &quot;signed_in_from_login_activity&quot;
1033                 );
1034 
1035                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1036                     finish();
1037                 }
1038 
1039                 break;
1040         }
1041     }
1042 
1043     @Override
1044     public void onUndo() {
1045         if (mUndoBarController == null) return;
1046 
1047         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1048         if (deletedNoteIds != null) {
1049             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1050                 Note deletedNote;
1051                 try {
1052                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1053                 } catch (BucketObjectMissingException e) {
1054                     return;
1055                 }
1056                 if (deletedNote != null) {
1057                     deletedNote.setDeleted(false);
1058                     deletedNote.setModificationDate(Calendar.getInstance());
1059                     deletedNote.save();
1060                     NoteListFragment fragment = getNoteListFragment();
1061                     if (fragment != null) {
1062                         fragment.getPrefs();
1063                         fragment.refreshList();
1064                     }
1065                 }
1066             }
1067         }
1068     }
1069 
1070     @Override
1071     protected void onPostCreate(Bundle savedInstanceState) {
1072         super.onPostCreate(savedInstanceState);
1073         // Sync the toggle state after onRestoreInstanceState has occurred.
1074         mDrawerToggle.syncState();
1075     }
1076 
1077     @Override
1078     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1079         super.onConfigurationChanged(newConfig);
1080 
1081         mDrawerToggle.onConfigurationChanged(newConfig);
1082 
1083         if (DisplayUtils.isLargeScreen(this)) {
1084             mIsShowingMarkdown = false;
1085 
1086             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1087                 // Add the editor fragment
1088                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1089                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1089                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1090                 } else if (DisplayUtils.isLandscape(this)) {
1091                     addEditorFragment();
1092                 }
1093 
1094                 if (mNoteListFragment != null) {
1095                     mNoteListFragment.setActivateOnItemClick(true);
1096                     mNoteListFragment.setDividerVisible(true);
1097                 }
1098 
1099                 // Select the current note on a tablet
1100                 if (mCurrentNote != null) {
<abbr title="1101                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1101                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1102                 } else {
1103                     mNoteEditorFragment.setPlaceholderVisible(true);
1104                     mNoteListFragment.getListView().clearChoices();
1105                 }
1106 
1107                 invalidateOptionsMenu();
<abbr title="1108             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1108             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1109             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1110                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1110                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1111             }
1112         }
1113 
1114         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1115             // Remove the editor fragment when rotating back to portrait
1116             mCurrentNote = null;
1117             if (mNoteListFragment != null) {
1118                 mNoteListFragment.setActivateOnItemClick(false);
1119                 mNoteListFragment.setDividerVisible(false);
1120                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1121                 mNoteListFragment.refreshList();
1122             }
1123             FragmentManager fm = getSupportFragmentManager();
1124             FragmentTransaction ft = fm.beginTransaction();
1125             ft.remove(mNoteEditorFragment);
1126             mNoteEditorFragment = null;
1127             ft.commitAllowingStateLoss();
1128             fm.executePendingTransactions();
1129             invalidateOptionsMenu();
1130         }
1131     }
1132 
1133     public void checkEmptyListText(boolean isSearch) {
1134         if (isSearch) {
<abbr title="1135             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1135             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1136             getNoteListFragment().setEmptyListViewClickable(false);
1137         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1138             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1138             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1139             AnalyticsTracker.track(
1140                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1141                     AnalyticsTracker.CATEGORY_NOTE,
1142                     &quot;trash_filter_selected&quot;
1143             );
1144             getNoteListFragment().setEmptyListViewClickable(false);
1145         } else {
<abbr title="1146             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1146             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1147             getNoteListFragment().setEmptyListViewClickable(true);
1148         }
1149     }
1150 
1151     public void showDetailPlaceholder() {
1152         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1153             mCurrentNote = null;
1154             mNoteEditorFragment.setPlaceholderVisible(true);
1155             mNoteEditorFragment.clearMarkdown();
1156             mNoteEditorFragment.hideMarkdown();
1157             mIsShowingMarkdown = false;
1158         }
1159     }
1160 
1161     public void stopListeningToNotesBucket() {
1162         mNotesBucket.removeOnNetworkChangeListener(this);
1163         mNotesBucket.removeOnSaveObjectListener(this);
1164         mNotesBucket.removeOnDeleteObjectListener(this);
1165     }
1166 
1167     // Returns the appropriate view to show the undo bar within
1168     private View getUndoView() {
1169         View undoView = mFragmentsContainer;
1170         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1171                 getNoteListFragment() != null &amp;&amp;
1172                 getNoteListFragment().getRootView() != null) {
1173             undoView = getNoteListFragment().getRootView();
1174         }
1175 
1176         return undoView;
1177     }
1178 
1179     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1180         if (mUndoBarController != null) {
1181             mUndoBarController.setDeletedNoteIds(noteIds);
1182             mUndoBarController.showUndoBar(
1183                     getUndoView(),
<abbr title="1184                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1184                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1185             );
1186         }
1187     }
1188 
1189     /* Simperium Bucket Listeners */
1190     // received a change from the network, refresh the list
1191     @Override
1192     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1193         runOnUiThread(new Runnable() {
1194             @Override
1195             public void run() {
1196                 if (type == Bucket.ChangeType.INDEX) {
1197                     setToolbarProgressVisibility(false);
1198                 }
1199                 mNoteListFragment.refreshList();
1200             }
1201         });
1202     }
1203 
1204     @Override
1205     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1206         runOnUiThread(new Runnable() {
1207             @Override
1208             public void run() {
1209                 mNoteListFragment.refreshList();
1210             }
1211         });
1212     }
1213 
1214     @Override
1215     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1216         runOnUiThread(new Runnable() {
1217             @Override
1218             public void run() {
1219                 mNoteListFragment.refreshList();
1220             }
1221         });
1222     }
1223 
1224     @Override
1225     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1226         // noop, NoteEditorFragment will handle this
1227     }
1228 
1229     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1230         @Override
1231         protected Void doInBackground(Void... voids) {
1232             if (mNotesBucket == null) {
1233                 return null;
1234             }
1235             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1236             Bucket.ObjectCursor c = query.execute();
1237             while (c.moveToNext()) {
1238                 c.getObject().delete();
1239             }
1240             return null;
1241         }
1242 
1243         @Override
1244         protected void onPostExecute(Void nada) {
1245             showDetailPlaceholder();
1246         }
1247     }
1248 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.Spannable;
  13  import android.text.SpannableString;
  14  import android.text.TextUtils;
  15  import android.view.Menu;
  16  import android.view.MenuInflater;
  17  import android.view.MenuItem;
  18  import android.view.View;
  19  import android.widget.ListView;
  20  import android.widget.ProgressBar;
  21  
  22  import androidx.annotation.NonNull;
  23  import androidx.appcompat.app.ActionBar;
  24  import androidx.appcompat.app.ActionBarDrawerToggle;
  25  import androidx.appcompat.app.AlertDialog;
  26  import androidx.appcompat.app.AppCompatActivity;
  27  import androidx.appcompat.widget.SearchView;
  28  import androidx.appcompat.widget.Toolbar;
  29  import androidx.core.view.GravityCompat;
  30  import androidx.drawerlayout.widget.DrawerLayout;
  31  import androidx.fragment.app.FragmentManager;
  32  import androidx.fragment.app.FragmentTransaction;
  33  import androidx.preference.PreferenceManager;
  34  
  35  import com.automattic.simplenote.analytics.AnalyticsTracker;
  36  import com.automattic.simplenote.models.Note;
  37  import com.automattic.simplenote.models.Tag;
  38  import com.automattic.simplenote.utils.CrashUtils;
  39  import com.automattic.simplenote.utils.DisplayUtils;
  40  import com.automattic.simplenote.utils.DrawableUtils;
  41  import com.automattic.simplenote.utils.HtmlCompat;
  42  import com.automattic.simplenote.utils.PrefUtils;
  43  import com.automattic.simplenote.utils.StrUtils;
  44  import com.automattic.simplenote.utils.TagsAdapter;
  45  import com.automattic.simplenote.utils.ThemeUtils;
  46  import com.automattic.simplenote.utils.UndoBarController;
  47  import com.automattic.simplenote.widgets.TypefaceSpan;
  48  import com.google.android.material.navigation.NavigationView;
  49  import com.simperium.Simperium;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Calendar;
  60  import java.util.HashMap;
  61  import java.util.List;
  62  import java.util.Map;
  63  
  64  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74  
  75  public class NotesActivity extends AppCompatActivity implements
<abbr title="  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  77          Bucket.Listener&lt;Note&gt; {
  78  
  79      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81      protected Bucket&lt;Note&gt; mNotesBucket;
  82      protected Bucket&lt;Tag&gt; mTagsBucket;
  83      private boolean mIsShowingMarkdown;
  84      private boolean mShouldSelectNewNote;
  85      private boolean mIsSettingsClicked;
  86      private boolean mIsTabetFullscreen;
  87  
  88      private String mTabletSearchQuery;
  89      private UndoBarController mUndoBarController;
  90      private View mFragmentsContainer;
  91      private SearchView mSearchView;
  92      private MenuItem mSearchMenuItem;
  93      private NoteListFragment mNoteListFragment;
  94      private NoteEditorFragment mNoteEditorFragment;
  95      private Note mCurrentNote;
  96      private MenuItem mEmptyTrashMenuItem;
  97  
  98      // Menu drawer
  99      private static final int GROUP_PRIMARY = 100;
 100      private static final int GROUP_SECONDARY = 101;
 101      private static final int GROUP_TERTIARY = 102;
 102      private DrawerLayout mDrawerLayout;
 103      private Menu mNavigationMenu;
 104      private ActionBarDrawerToggle mDrawerToggle;
 105      private TagsAdapter mTagsAdapter;
 106      private TagsAdapter.TagMenuItem mSelectedTag;
 107      // Tags bucket listener
 108      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109          void updateNavigationDrawer() {
 110              runOnUiThread(new Runnable() {
 111                  public void run() {
 112                      updateNavigationDrawerItems();
 113                  }
 114              });
 115          }
 116  
 117          @Override
 118          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119              updateNavigationDrawer();
 120          }
 121  
 122          @Override
 123          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124              updateNavigationDrawer();
 125          }
 126  
 127          @Override
 128          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129              updateNavigationDrawer();
 130          }
 131  
 132          @Override
 133          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134              // noop
 135          }
 136      };
 137  
 138      @Override
 139      protected void onCreate(Bundle savedInstanceState) {
 140          ThemeUtils.setTheme(this);
 141          super.onCreate(savedInstanceState);
 142  
 143          setContentView(R.layout.activity_notes);
 144  
 145          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146  
 147          Simplenote currentApp = (Simplenote) getApplication();
 148          if (mNotesBucket == null) {
 149              mNotesBucket = currentApp.getNotesBucket();
 150          }
 151  
 152          if (mTagsBucket == null) {
 153              mTagsBucket = currentApp.getTagsBucket();
 154          }
 155  
 156          Toolbar toolbar = findViewById(R.id.toolbar);
 157          setSupportActionBar(toolbar);
 158          configureNavigationDrawer(toolbar);
 159  
 160          if (savedInstanceState == null) {
 161              mNoteListFragment = new NoteListFragment();
 162              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164              fragmentTransaction.commit();
 165          } else {
 166              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 167          }
 168          mIsTabetFullscreen = mNoteListFragment.isHidden();
 169  
 170          if (DisplayUtils.isLargeScreen(this)) {
 171              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 173              } else if (DisplayUtils.isLandscape(this)) {
 174                  addEditorFragment();
 175              }
 176          }
 177  
 178          // enable ActionBar app icon to behave as action to toggle nav drawer
 179          ActionBar actionBar = getSupportActionBar();
 180          if (actionBar != null) {
 181              actionBar.setDisplayHomeAsUpEnabled(true);
 182              actionBar.setHomeButtonEnabled(true);
 183  
 184              // Add loading indicator to show when indexing
<abbr title=" 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 186              actionBar.setDisplayShowCustomEnabled(true);
 187              actionBar.setCustomView(progressBar);
 188              setToolbarProgressVisibility(false);
 189          }
 190  
 191          mUndoBarController = new UndoBarController(this);
 192  
 193          // Creates &#x27;Welcome&#x27; note
 194          checkForFirstLaunch();
 195  
 196          checkForSharedContent();
 197  
 198          currentApp.getSimperium().setOnUserCreatedListener(this);
 199          currentApp.getSimperium().setUserStatusChangeListener(this);
 200      }
 201  
 202      @Override
 203      protected void onResume() {
 204          super.onResume();
 205  
 206          // Ensure user has valid authorization
 207          if (userAuthenticationIsInvalid()) {
 208              startLoginActivity(true);
 209              Intent intent = getIntent();
 210  
 211              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                  AnalyticsTracker.track(
 214                          NOTE_WIDGET_SIGN_IN_TAPPED,
 215                          CATEGORY_WIDGET,
 216                          &quot;note_widget_sign_in_tapped&quot;
 217                  );
 218              }
 219          }
 220  
 221          disableScreenshotsIfLocked(this);
 222  
 223          mNotesBucket.start();
 224          mTagsBucket.start();
 225  
 226          mNotesBucket.addOnNetworkChangeListener(this);
 227          mNotesBucket.addOnSaveObjectListener(this);
 228          mNotesBucket.addOnDeleteObjectListener(this);
 229          mTagsBucket.addListener(mTagsMenuUpdater);
 230  
 231          updateNavigationDrawerItems();
 232  
 233          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234          if (userIsUnauthorized()) {
 235              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                  mSelectedTag = null;
 237                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238              }
 239          }
 240  
 241          filterListBySelectedTag();
 242  
 243          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 245              mShouldSelectNewNote = false;
 246          }
 247  
 248          if (mIsShowingMarkdown) {
 249              setMarkdownShowing(false);
 250          }
 251  
 252          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253          if(DisplayUtils.isLargeScreenLandscape(this)) {
 254              if (mIsTabetFullscreen) {
 255                  ft.hide(mNoteListFragment);
 256              } else {
 257                  ft.show(mNoteListFragment);
 258              }
 259          } else {
 260              ft.show(mNoteListFragment);
 261          }
 262          ft.commitNow();
 263      }
 264  
 265      @Override
 266      protected void onPause() {
 267          super.onPause();  // Always call the superclass method first
 268          mTagsBucket.removeListener(mTagsMenuUpdater);
 269          mTagsBucket.stop();
 270  
 271          mNotesBucket.removeOnNetworkChangeListener(this);
 272          mNotesBucket.removeOnSaveObjectListener(this);
 273          mNotesBucket.removeOnDeleteObjectListener(this);
 274          mNotesBucket.stop();
 275      }
 276  
 277      @Override
 278      public void setTitle(CharSequence title) {
 279          if (title == null) {
 280              title = &quot;&quot;;
 281          }
 282  
 283          setTitleWithCustomFont(title);



 284      }
 285  
 286      @Override
 287      public void onBackPressed() {
 288          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 289              mDrawerLayout.closeDrawer(GravityCompat.START);
 290          } else {
 291              super.onBackPressed();
 292          }
 293      }
 294  
 295      @Override
 296      public void onActionModeCreated() {
 297          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 298      }
 299  
 300      @Override
 301      public void onActionModeDestroyed() {
 302          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 303      }
 304  
 305      private void setTitleWithCustomFont(CharSequence title) {
 306          if (getSupportActionBar() == null) {
 307              return;
 308          }
 309  
 310          SpannableString s = new SpannableString(title);
 311          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 312          getSupportActionBar().setTitle(s);
 313      }
 314  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -    private ColorStateList getItemSelector() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +    private ColorStateList getIconSelector() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        int[][] states = new int[][] {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +                new int[] { android.R.attr.state_checked}, // checked</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +                new int[] {-android.R.attr.state_checked}  // unchecked</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +        };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +        int[] colors = new int[] {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +                ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +        };</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        return new ColorStateList(states, colors);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +    private ColorStateList getTextSelector() {</span>
 331          int[][] states = new int[][] {
 332              new int[] {-android.R.attr.state_enabled}, // disabled
 333              new int[] { android.R.attr.state_checked}, // checked
 334              new int[] {-android.R.attr.state_checked}  // unchecked
 335          };
 336  
 337          int[] colors = new int[] {
 338              getResources().getColor(R.color.text_title_disabled, getTheme()),
 339              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 340              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 341          };
 342  
 343          return new ColorStateList(states, colors);
 344      }
 345  
 346      private void configureNavigationDrawer(Toolbar toolbar) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -        ColorStateList drawerSelector = getItemSelector();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        ColorStateList iconSelector = getIconSelector();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        ColorStateList textSelector = getTextSelector();</span>
 350          mDrawerLayout = findViewById(R.id.drawer_layout);
 351          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 352          NavigationView navigationView = findViewById(R.id.navigation_view);
 353          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -        navigationView.setItemIconTintList(drawerSelector);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -        navigationView.setItemTextColor(drawerSelector);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        navigationView.setItemIconTintList(iconSelector);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        navigationView.setItemTextColor(textSelector);</span>
 358          navigationView.setNavigationItemSelectedListener(
 359              new NavigationView.OnNavigationItemSelectedListener() {
 360                  @Override
 361                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 362                      mDrawerLayout.closeDrawer(GravityCompat.START);
 363  
 364                      if (item.getItemId() == SETTINGS_ID) {
 365                          AnalyticsTracker.track(
 366                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 367                                  AnalyticsTracker.CATEGORY_TAG,
 368                                  &quot;selected_tag_in_navigation_drawer&quot;,
 369                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 370                          );
 371                          mIsSettingsClicked = true;
 372                          return false;
 373                      } else {
 374                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 375                          filterListBySelectedTag();
 376                          return true;
 377                      }
 378                  }
 379              }
 380          );
 381  
 382          mNavigationMenu = navigationView.getMenu();
<abbr title=" 383          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 383          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 384          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 384          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 385          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 385          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 386          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 387  
 388          if (mSelectedTag == null)
 389              mSelectedTag = mTagsAdapter.getDefaultItem();
 390  
 391          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 392                  R.string.close_drawer) {
 393              public void onDrawerClosed(View view) {
 394                  supportInvalidateOptionsMenu();
 395  
 396                  if (mIsSettingsClicked) {
 397                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 398                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 399                      mIsSettingsClicked = false;
 400                  }
 401              }
 402  
 403              public void onDrawerOpened(View drawerView) {
 404                  // noop
 405              }
 406  
 407              @Override
 408              public void onDrawerSlide(View drawerView, float slideOffset) {
 409                  super.onDrawerSlide(drawerView, 0f);
 410              }
 411          };
 412  
 413          mDrawerLayout.addDrawerListener(mDrawerToggle);
 414      }
 415  
 416      private void filterListBySelectedTag() {
 417          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 418  
 419          if (selectedMenuItem != null) {
 420              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 421          } else {
 422              mSelectedTag = mTagsAdapter.getDefaultItem();
 423          }
 424  
 425          checkEmptyListText(false);
 426  
 427          if (mNoteListFragment.isHidden()) {
 428              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 429              fragmentTransaction.show(mNoteListFragment);
 430              fragmentTransaction.commitNowAllowingStateLoss();
 431          }
 432  
 433          // Disable long press on notes when viewing Trash.
 434          if (mSelectedTag.id == TRASH_ID) {
 435              getNoteListFragment().getListView().setLongClickable(false);
 436          } else {
 437              getNoteListFragment().getListView().setLongClickable(true);
 438          }
 439  
 440          getNoteListFragment().refreshListFromNavSelect();
 441  
 442          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 443  
 444          switch ((int) mSelectedTag.id) {
 445              case ALL_NOTES_ID:
 446                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 447                  break;
 448              case TRASH_ID:
 449                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 450                  break;
 451              case UNTAGGED_NOTES_ID:
 452                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 453                  break;
 454              default:
 455                  properties = null;
 456                  break;
 457          }
 458  
 459          AnalyticsTracker.track(
 460                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 461                  AnalyticsTracker.CATEGORY_TAG,
 462                  &quot;selected_tag_in_navigation_drawer&quot;,
 463                  properties
 464          );
 465  
 466          setSelectedTagActive();
 467      }
 468  
 469      private void checkForFirstLaunch() {
 470          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 471              // Create the welcome note
 472              try {
 473                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 474                  welcomeNote.setCreationDate(Calendar.getInstance());
 475                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 476                  welcomeNote.setContent(getString(R.string.welcome_note));
 477                  welcomeNote.getTitle();
 478                  welcomeNote.save();
 479              } catch (BucketObjectNameInvalid e) {
 480                  // this won&#x27;t happen because welcome-android is a valid name
 481              }
 482  
 483              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 484              SharedPreferences.Editor editor = preferences.edit();
 485              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 486              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 487              editor.apply();
 488          }
 489      }
 490  
 491      private void checkForSharedContent() {
 492          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 493              // Check share action
 494              Intent intent = getIntent();
 495              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 496              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 497  
 498              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 499              String intentAction = StrUtils.notNullStr(intent.getAction());
 500              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 501              if (!TextUtils.isEmpty(text)) {
 502                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 503                      text = subject + &quot;\n\n&quot; + text;
 504                  }
 505                  Note note = mNotesBucket.newObject();
 506                  note.setCreationDate(Calendar.getInstance());
 507                  note.setModificationDate(note.getCreationDate());
 508                  note.setContent(text);
 509                  note.save();
 510                  setCurrentNote(note);
 511                  mShouldSelectNewNote = true;
 512  
 513                  AnalyticsTracker.track(
 514                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 515                          AnalyticsTracker.CATEGORY_NOTE,
 516                          &quot;external_share&quot;
 517                  );
 518  
 519                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 520                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 521                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 522                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 523                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 524                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 525                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 526                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 527                      }
 528                  }
 529              }
 530          }
 531      }
 532  
 533      private void updateNavigationDrawerItems() {
 534          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 535          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 536          if (isAlphaSort) {
 537              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 538          } else {
 539              tagCursor = Tag.allWithName(mTagsBucket).execute();
 540          }
 541  
 542          mTagsAdapter.changeCursor(tagCursor);
 543          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 544          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 545  
 546          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 547              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 547              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 548  
 549              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 550                  String name = mTagsAdapter.getItem(i).name;
 551                  int id = (int) mTagsAdapter.getItem(i).id;
 552  
 553                  if (id &gt;= 0) { // Custom tags have a positive ID.
 554                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 555                  }
 556              }
 557  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 558 -            mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_tag_off_24dp).setCheckable(true);"> 558 -            mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 559 +            mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 559 +            mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr></span>
 560              setSelectedTagActive();
 561          }
 562      }
 563  
 564      public void launchEditTags(View view) {
 565          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 566      }
 567  
 568      private void setSelectedTagActive() {
 569          if (mSelectedTag == null) {
 570              mSelectedTag = mTagsAdapter.getDefaultItem();
 571          }
 572  
 573          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 574  
 575          if (selectedMenuItem != null) {
 576              selectedMenuItem.setChecked(true);
 577          } else {
 578              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 579          }
 580  
 581          setTitle(mSelectedTag.name);
 582      }
 583  
 584      public TagsAdapter.TagMenuItem getSelectedTag() {
 585          if (mSelectedTag == null) {
 586              mSelectedTag = mTagsAdapter.getDefaultItem();
 587          }
 588  
 589          return mSelectedTag;
 590      }
 591  
 592      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 593      public void updateTrashMenuItem() {
 594          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 595              return;
 596  
 597          // Disable the trash icon if there are no notes trashed.
 598          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 599          if (query.count() == 0) {
 600              mEmptyTrashMenuItem.setEnabled(false);
 601          } else {
 602              mEmptyTrashMenuItem.setEnabled(true);
 603          }
 604      }
 605  
 606      private void addEditorFragment() {
 607          FragmentManager fm = getSupportFragmentManager();
 608          FragmentTransaction ft = fm.beginTransaction();
 609          mNoteEditorFragment = new NoteEditorFragment();
 610          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 611          ft.commitAllowingStateLoss();
 612          fm.executePendingTransactions();
 613      }
 614  
 615      private boolean userAccountRequired() {
 616          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 617      }
 618  
 619      /**
 620       * Checks for a previously valid user that is now not authenticated
 621       * Also checks if user account is required (added in version 1.5.6)
 622       *
 623       * @return true if user has invalid authorization
 624       */
 625      private boolean userAuthenticationIsInvalid() {
 626          Simplenote currentApp = (Simplenote) getApplication();
 627          Simperium simperium = currentApp.getSimperium();
 628          User user = simperium.getUser();
 629          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 630          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 631                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 632      }
 633  
 634      public boolean userIsUnauthorized() {
 635          Simplenote currentApp = (Simplenote) getApplication();
 636          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 637      }
 638  
 639      public void setCurrentNote(Note note) {
 640          mCurrentNote = note;
 641      }
 642  
 643      public NoteListFragment getNoteListFragment() {
 644          return mNoteListFragment;
 645      }
 646  
 647      @SuppressWarnings(&quot;ResourceType&quot;)
 648      @Override
 649      public boolean onCreateOptionsMenu(Menu menu) {
 650          super.onCreateOptionsMenu(menu);
 651          MenuInflater inflater = getMenuInflater();
 652          inflater.inflate(R.menu.notes_list, menu);
 653  
 654          // restore the search query if on a landscape tablet
 655          String searchQuery = null;
 656          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 657              searchQuery = mSearchView.getQuery().toString();
 658  
 659          mSearchMenuItem = menu.findItem(R.id.menu_search);
 660          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 661  
 662          if (!TextUtils.isEmpty(searchQuery)) {
 663              mSearchView.setQuery(searchQuery, false);
 664              mSearchMenuItem.expandActionView();
 665          } else {
 666              // Workaround for setting the search placeholder text color
 667              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 668              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 669                      hintHexColor,
 670                      getString(R.string.search))));
 671          }
 672  
 673          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 674              @Override
 675              public boolean onQueryTextChange(String newText) {
 676                  if (mSearchMenuItem.isActionViewExpanded()) {
 677                      getNoteListFragment().searchNotes(newText);
 678                  }
 679                  return true;
 680              }
 681  
 682              @Override
 683              public boolean onQueryTextSubmit(String queryText) {
 684                  getNoteListFragment().searchNotes(queryText);
 685                  return true;
 686              }
 687  
 688          });
 689  
 690          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 691              @Override
 692              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 693                  checkEmptyListText(true);
 694                  if (mNoteListFragment != null) {
 695                      mNoteListFragment.setFloatingActionButtonVisible(false);
 696                  }
 697                  AnalyticsTracker.track(
 698                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 699                          AnalyticsTracker.CATEGORY_NOTE,
 700                          &quot;action_bar_search_tap&quot;
 701                  );
 702                  return true;
 703              }
 704  
 705              @Override
 706              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 707                  // Show all notes again
 708                  if (mNoteListFragment != null) {
 709                      mNoteListFragment.setFloatingActionButtonVisible(true);
 710                  }
 711                  mTabletSearchQuery = &quot;&quot;;
 712                  mSearchView.setQuery(&quot;&quot;, false);
 713                  checkEmptyListText(false);
 714                  getNoteListFragment().clearSearch();
 715                  return true;
 716              }
 717          });
 718  
 719          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 720              @Override
 721              public boolean onMenuItemClick(MenuItem item) {
 722                  if (!mSearchMenuItem.isActionViewExpanded())
 723                      showDetailPlaceholder();
 724                  return false;
 725              }
 726          });
 727  
 728          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 729          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 730              trashItem.setTitle(R.string.undelete);
 731              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 732          } else {
 733              trashItem.setTitle(R.string.delete);
 734              trashItem.setIcon(R.drawable.ic_trash_24dp);
 735          }
 736  
 737          if (DisplayUtils.isLargeScreenLandscape(this)) {
 738              // Restore the search query on landscape tablets
 739              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 740                  mSearchMenuItem.expandActionView();
 741                  mSearchView.setQuery(mTabletSearchQuery, false);
 742                  mSearchView.clearFocus();
 743              }
 744  
 745              if (mCurrentNote != null) {
 746                  menu.findItem(R.id.menu_share).setVisible(true);
 747                  menu.findItem(R.id.menu_view_info).setVisible(true);
 748                  menu.findItem(R.id.menu_checklist).setVisible(true);
 749                  menu.findItem(R.id.menu_history).setVisible(true);
 750                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 751                  menu.findItem(R.id.menu_sidebar).setVisible(true);
 752                  trashItem.setVisible(true);
 753              } else {
 754                  menu.findItem(R.id.menu_share).setVisible(false);
 755                  menu.findItem(R.id.menu_view_info).setVisible(false);
 756                  menu.findItem(R.id.menu_checklist).setVisible(false);
 757                  menu.findItem(R.id.menu_history).setVisible(false);
 758                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 759                  menu.findItem(R.id.menu_sidebar).setVisible(false);
 760                  trashItem.setVisible(false);
 761              }
 762              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 763          } else {
 764              menu.findItem(R.id.menu_search).setVisible(true);
 765              menu.findItem(R.id.menu_share).setVisible(false);
 766              menu.findItem(R.id.menu_view_info).setVisible(false);
 767              menu.findItem(R.id.menu_checklist).setVisible(false);
 768              menu.findItem(R.id.menu_history).setVisible(false);
 769              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 770              menu.findItem(R.id.menu_sidebar).setVisible(false);
 771              trashItem.setVisible(false);
 772              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 773          }
 774  
 775          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 776              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 777              mEmptyTrashMenuItem.setVisible(true);
 778  
 779              updateTrashMenuItem();
 780  
 781              menu.findItem(R.id.menu_search).setVisible(false);
 782              menu.findItem(R.id.menu_share).setVisible(false);
 783              menu.findItem(R.id.menu_history).setVisible(false);
 784              menu.findItem(R.id.menu_checklist).setVisible(false);
 785          }
 786  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 787 -        DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +        DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);</span>
 789  
 790          return true;
 791      }
 792  
 793      @Override
 794      public boolean onOptionsItemSelected(MenuItem item) {
 795          if (mDrawerToggle.onOptionsItemSelected(item)) {
 796              return true;
 797          }
 798          switch (item.getItemId()) {
 799              case R.id.menu_sidebar:
 800                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 801                  if (mNoteListFragment.isHidden()) {
 802                      ft.show(mNoteListFragment);
 803                  } else {
 804                      ft.hide(mNoteListFragment);
 805                  }
 806                  ft.commitNowAllowingStateLoss();
 807                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 808                  return true;
 809              case R.id.menu_markdown_preview:
 810                  if (mIsShowingMarkdown) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 811 -                    item.setIcon(R.drawable.ic_preview_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +                    item.setIcon(R.drawable.ic_visibility_on_24dp);</span>
 813                      item.setTitle(getString(R.string.markdown_show));
 814                      setMarkdownShowing(false);
 815                      mCurrentNote.setPreviewEnabled(false);
 816                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 817 -                    item.setIcon(R.drawable.ic_preview_stop_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +                    item.setIcon(R.drawable.ic_visibility_off_24dp);</span>
 819                      item.setTitle(getString(R.string.markdown_hide));
 820                      setMarkdownShowing(true);
 821                      mCurrentNote.setPreviewEnabled(true);
 822                  }
 823  
 824                  mCurrentNote.save();
 825                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 826  
 827                  return true;
 828              case R.id.menu_delete:
 829                  if (mNoteEditorFragment != null) {
 830                      if (mCurrentNote != null) {
 831                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 832                          mCurrentNote.setModificationDate(Calendar.getInstance());
 833                          mCurrentNote.save();
 834  
 835                          updateViewsAfterTrashAction(mCurrentNote);
 836                      }
 837                  }
 838                  return true;
 839              case R.id.menu_empty_trash:
 840                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 841  
 842                  alert.setTitle(R.string.empty_trash);
 843                  alert.setMessage(R.string.confirm_empty_trash);
 844                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 845                      public void onClick(DialogInterface dialog, int whichButton) {
 846                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 847                          AnalyticsTracker.track(
 848                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 849                                  AnalyticsTracker.CATEGORY_NOTE,
 850                                  &quot;overflow_menu&quot;
 851                          );
 852                      }
 853                  });
 854                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 855                      public void onClick(DialogInterface dialog, int whichButton) {
 856                          // Do nothing, just closing the dialog
 857                      }
 858                  });
 859                  alert.show();
 860                  return true;
 861              case android.R.id.home:
 862                  invalidateOptionsMenu();
 863                  return true;
 864              default:
 865                  return super.onOptionsItemSelected(item);
 866          }
 867      }
 868  
 869      @Override
 870      public boolean onPrepareOptionsMenu(Menu menu) {
 871          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 872  
 873          if (mIsShowingMarkdown) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 874 -            markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 875 +            markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);</span>
 876              markdownItem.setTitle(getString(R.string.markdown_hide));
 877          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 878 -            markdownItem.setIcon(R.drawable.ic_preview_24dp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 879 +            markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);</span>
 880              markdownItem.setTitle(getString(R.string.markdown_show));
 881          }
 882  
 883          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 884  
 885          return super.onPrepareOptionsMenu(menu);
 886      }
 887  
 888      public void updateViewsAfterTrashAction(Note note) {
 889          if (note == null || isFinishing()) {
 890              return;
 891          }
 892  
 893          if (note.isDeleted()) {
 894              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 895              deletedNoteIds.add(note.getSimperiumKey());
 896              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 897              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 898              AnalyticsTracker.track(
 899                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 900                      AnalyticsTracker.CATEGORY_NOTE,
 901                      &quot;overflow_menu&quot;
 902              );
 903          } else {
 904              AnalyticsTracker.track(
 905                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 906                      AnalyticsTracker.CATEGORY_NOTE,
 907                      &quot;overflow_menu&quot;
 908              );
 909          }
 910  
 911          // If we just deleted/restored the active note, show the placeholder
 912          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 913              showDetailPlaceholder();
 914          }
 915  
 916          NoteListFragment fragment = getNoteListFragment();
 917          if (fragment != null) {
 918              fragment.getPrefs();
 919              fragment.refreshList();
 920          }
 921  
 922          invalidateOptionsMenu();
 923      }
 924  
 925      public void setMarkdownShowing(boolean isMarkdownShowing) {
 926          mIsShowingMarkdown = isMarkdownShowing;
 927          if (mNoteEditorFragment != null) {
 928              if (isMarkdownShowing) {
 929                  mNoteEditorFragment.showMarkdown();
 930              } else {
 931                  mNoteEditorFragment.hideMarkdown();
 932              }
 933          }
 934          invalidateOptionsMenu();
 935      }
 936  
 937      /**
 938       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 939       * the item with the given ID was selected. Used for tablets only.
 940       */
 941      @Override
<abbr title=" 942      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 942      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 943          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 944              // Launch the editor activity
 945              Bundle arguments = new Bundle();
 946              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 947              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 948              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 949  
 950              if (matchOffsets != null) {
 951                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 952              }
 953  
 954              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 955              editNoteIntent.putExtras(arguments);
 956              if (mNoteListFragment.isHidden()) {
 957                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 958              }
 959              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 960          } else {
 961              mNoteEditorFragment.setNote(noteID, matchOffsets);
 962              getNoteListFragment().setNoteSelected(noteID);
 963              setMarkdownShowing(isPreviewEnabled);
 964  
 965              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 966                  mTabletSearchQuery = mSearchView.getQuery().toString();
 967              }
 968  
 969              mNoteEditorFragment.clearMarkdown();
 970  
 971              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 972                  setMarkdownShowing(false);
 973              }
 974  
 975              invalidateOptionsMenu();
 976          }
 977  
 978          AnalyticsTracker.track(
 979                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 980                  AnalyticsTracker.CATEGORY_NOTE,
 981                  &quot;note_list_row_tap&quot;
 982          );
 983      }
 984  
 985      @Override
 986      public void onUserCreated(User user) {
 987          // New account created
 988          AnalyticsTracker.track(
 989                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 990                  AnalyticsTracker.CATEGORY_USER,
 991                  &quot;account_created_from_login_activity&quot;
 992          );
 993      }
 994  
 995      public void onUserStatusChange(User.Status status) {
 996          switch (status) {
 997              // successfully used access token to connect to simperium bucket
 998              case AUTHORIZED:
 999                  runOnUiThread(new Runnable() {
1000                      @Override
1001                      public void run() {
1002                          if (!mNotesBucket.hasChangeVersion()) {
1003                              setToolbarProgressVisibility(true);
1004                          }
1005                      }
1006                  });
1007                  break;
1008  
1009              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1010              case NOT_AUTHORIZED:
1011                  runOnUiThread(new Runnable() {
1012                      @Override
1013                      public void run() {
1014                          startLoginActivity(true);
1015                      }
1016                  });
1017                  break;
1018  
<abbr title="1019              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1019              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
1020              case UNKNOWN:
1021                  break;
1022          }
1023      }
1024  
1025      private void setToolbarProgressVisibility(boolean isVisible) {
1026          if (getSupportActionBar() != null) {
1027              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1028          }
1029      }
1030  
1031      public void startLoginActivity(boolean signInFirst) {
1032          // Clear some account-specific prefs
1033          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1034          editor.remove(PrefUtils.PREF_WP_TOKEN);
1035          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1036          editor.apply();
1037  
1038          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1039          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1040      }
1041  
1042      @Override
1043      public void recreate() {
1044          Handler handler = new Handler();
1045          handler.post(new Runnable() {
1046              @Override
1047              public void run() {
1048                  NotesActivity.super.recreate();
1049              }
1050          });
1051      }
1052  
1053      @Override
1054      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1055          super.onActivityResult(requestCode, resultCode, data);
1056          switch (requestCode) {
1057              case Simplenote.INTENT_PREFERENCES:
<abbr title="1058                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1058                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1059                  invalidateOptionsMenu();
1060                  NoteListFragment fragment = getNoteListFragment();
1061                  if (fragment != null) {
1062                      fragment.getPrefs();
1063                      fragment.refreshList();
1064                  }
1065  
1066                  break;
1067              case Simplenote.INTENT_EDIT_NOTE:
1068                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1069                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1070                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1071                          if (noteId != null) {
1072                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1073                              deletedNoteIds.add(noteId);
1074                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1075                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1076                          }
<abbr title="1077                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1077                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1078                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1079                          mNoteListFragment.setNoteSelected(selectedNoteId);
1080                          if (mNoteEditorFragment != null) {
1081                              mNoteEditorFragment.setNote(selectedNoteId);
1082                          }
1083                      }
1084                  }
1085                  break;
1086              case Simperium.SIGNUP_SIGNIN_REQUEST:
1087                  invalidateOptionsMenu();
1088  
1089                  Simplenote app = (Simplenote) getApplication();
1090                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1091                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1092  
1093                  AnalyticsTracker.track(
1094                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1095                          AnalyticsTracker.CATEGORY_USER,
1096                          &quot;signed_in_from_login_activity&quot;
1097                  );
1098  
1099                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1100                      finish();
1101                  }
1102  
1103                  break;
1104          }
1105      }
1106  
1107      @Override
1108      public void onUndo() {
1109          if (mUndoBarController == null) return;
1110  
1111          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1112          if (deletedNoteIds != null) {
1113              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1114                  Note deletedNote;
1115                  try {
1116                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1117                  } catch (BucketObjectMissingException e) {
1118                      return;
1119                  }
1120                  if (deletedNote != null) {
1121                      deletedNote.setDeleted(false);
1122                      deletedNote.setModificationDate(Calendar.getInstance());
1123                      deletedNote.save();
1124                      NoteListFragment fragment = getNoteListFragment();
1125                      if (fragment != null) {
1126                          fragment.getPrefs();
1127                          fragment.refreshList();
1128                      }
1129                  }
1130              }
1131          }
1132      }
1133  
1134      @Override
1135      protected void onPostCreate(Bundle savedInstanceState) {
1136          super.onPostCreate(savedInstanceState);
1137          // Sync the toggle state after onRestoreInstanceState has occurred.
1138          mDrawerToggle.syncState();
1139      }
1140  
1141      @Override
1142      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1143          super.onConfigurationChanged(newConfig);
1144  
1145          mDrawerToggle.onConfigurationChanged(newConfig);
1146  
1147          if (DisplayUtils.isLargeScreen(this)) {
1148              mIsShowingMarkdown = false;
1149  
1150              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1151                  // Add the editor fragment
1152                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1153                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1153                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1154                  } else if (DisplayUtils.isLandscape(this)) {
1155                      addEditorFragment();
1156                  }
1157  
1158                  if (mNoteListFragment != null) {
1159                      mNoteListFragment.setActivateOnItemClick(true);
1160                      mNoteListFragment.setDividerVisible(true);
1161                  }
1162  
1163                  // Select the current note on a tablet
1164                  if (mCurrentNote != null) {
<abbr title="1165                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1165                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1166                  } else {
1167                      mNoteEditorFragment.setPlaceholderVisible(true);
1168                      mNoteListFragment.getListView().clearChoices();
1169                  }
1170  
1171                  invalidateOptionsMenu();
1172              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1173              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1174                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1174                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1175              }
1176          }
1177  
1178          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1179              // Remove the editor fragment when rotating back to portrait
1180              mCurrentNote = null;
1181              if (mNoteListFragment != null) {
1182                  mNoteListFragment.setActivateOnItemClick(false);
1183                  mNoteListFragment.setDividerVisible(false);
1184                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1185                  mNoteListFragment.refreshList();
1186              }
1187              FragmentManager fm = getSupportFragmentManager();
1188              FragmentTransaction ft = fm.beginTransaction();
1189              ft.remove(mNoteEditorFragment);
1190              mNoteEditorFragment = null;
1191              ft.commitAllowingStateLoss();
1192              fm.executePendingTransactions();
1193              invalidateOptionsMenu();
1194          }
1195      }
1196  
1197      public void checkEmptyListText(boolean isSearch) {
1198          if (isSearch) {
<abbr title="1199              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1199              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1200              getNoteListFragment().setEmptyListViewClickable(false);
1201          } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1202              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1202              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1203              AnalyticsTracker.track(
1204                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1205                      AnalyticsTracker.CATEGORY_NOTE,
1206                      &quot;trash_filter_selected&quot;
1207              );
1208              getNoteListFragment().setEmptyListViewClickable(false);
1209          } else {
<abbr title="1210              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1210              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1211              getNoteListFragment().setEmptyListViewClickable(true);
1212          }
1213      }
1214  
1215      public void showDetailPlaceholder() {
1216          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1217              mCurrentNote = null;
1218              mNoteEditorFragment.setPlaceholderVisible(true);
1219              mNoteEditorFragment.clearMarkdown();
1220              mNoteEditorFragment.hideMarkdown();
1221              mIsShowingMarkdown = false;
1222          }
1223      }
1224  
1225      public void stopListeningToNotesBucket() {
1226          mNotesBucket.removeOnNetworkChangeListener(this);
1227          mNotesBucket.removeOnSaveObjectListener(this);
1228          mNotesBucket.removeOnDeleteObjectListener(this);
1229      }
1230  
1231      // Returns the appropriate view to show the undo bar within
1232      private View getUndoView() {
1233          View undoView = mFragmentsContainer;
1234          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1235                  getNoteListFragment() != null &amp;&amp;
1236                  getNoteListFragment().getRootView() != null) {
1237              undoView = getNoteListFragment().getRootView();
1238          }
1239  
1240          return undoView;
1241      }
1242  
1243      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1244          if (mUndoBarController != null) {
1245              mUndoBarController.setDeletedNoteIds(noteIds);
1246              mUndoBarController.showUndoBar(
1247                      getUndoView(),
1248                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1249              );
1250          }
1251      }
1252  
1253      /* Simperium Bucket Listeners */
1254      // received a change from the network, refresh the list
1255      @Override
1256      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1257          runOnUiThread(new Runnable() {
1258              @Override
1259              public void run() {
1260                  if (type == Bucket.ChangeType.INDEX) {
1261                      setToolbarProgressVisibility(false);
1262                  }
1263                  mNoteListFragment.refreshList();
1264              }
1265          });
1266      }
1267  
1268      @Override
1269      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1270          runOnUiThread(new Runnable() {
1271              @Override
1272              public void run() {
1273                  mNoteListFragment.refreshList();
1274              }
1275          });
1276      }
1277  
1278      @Override
1279      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1280          runOnUiThread(new Runnable() {
1281              @Override
1282              public void run() {
1283                  mNoteListFragment.refreshList();
1284              }
1285          });
1286      }
1287  
1288      @Override
1289      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1290          // noop, NoteEditorFragment will handle this
1291      }
1292  
1293      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1294  
1295          @Override
1296          protected Void doInBackground(Void... voids) {
1297              if (mNotesBucket == null) return null;
1298  
1299              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1300              Bucket.ObjectCursor c = query.execute();
1301              while (c.moveToNext()) {
1302                  c.getObject().delete();
1303              }
1304  
1305              return null;
1306          }
1307  
1308          @Override
1309          protected void onPostExecute(Void nada) {
1310              showDetailPlaceholder();
1311          }
1312      }
1313  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 -import android.text.Spannable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 -import android.text.SpannableString;</span>
  14  import android.text.TextUtils;
  15  import android.view.Menu;
  16  import android.view.MenuInflater;
  17  import android.view.MenuItem;
  18  import android.view.View;
  19  import android.widget.ListView;
  20  import android.widget.ProgressBar;
  21  
  22  import androidx.annotation.NonNull;
  23  import androidx.appcompat.app.ActionBar;
  24  import androidx.appcompat.app.ActionBarDrawerToggle;
  25  import androidx.appcompat.app.AlertDialog;
  26  import androidx.appcompat.app.AppCompatActivity;
  27  import androidx.appcompat.widget.SearchView;
  28  import androidx.appcompat.widget.Toolbar;
  29  import androidx.core.view.GravityCompat;
  30  import androidx.drawerlayout.widget.DrawerLayout;
  31  import androidx.fragment.app.FragmentManager;
  32  import androidx.fragment.app.FragmentTransaction;
  33  import androidx.preference.PreferenceManager;
  34  
  35  import com.automattic.simplenote.analytics.AnalyticsTracker;
  36  import com.automattic.simplenote.models.Note;
  37  import com.automattic.simplenote.models.Tag;
  38  import com.automattic.simplenote.utils.CrashUtils;
  39  import com.automattic.simplenote.utils.DisplayUtils;
  40  import com.automattic.simplenote.utils.DrawableUtils;
  41  import com.automattic.simplenote.utils.HtmlCompat;
  42  import com.automattic.simplenote.utils.PrefUtils;
  43  import com.automattic.simplenote.utils.StrUtils;
  44  import com.automattic.simplenote.utils.TagsAdapter;
  45  import com.automattic.simplenote.utils.ThemeUtils;
  46  import com.automattic.simplenote.utils.UndoBarController;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import com.automattic.simplenote.widgets.TypefaceSpan;</span>
  48  import com.google.android.material.navigation.NavigationView;
  49  import com.simperium.Simperium;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Calendar;
  60  import java.util.HashMap;
  61  import java.util.List;
  62  import java.util.Map;
  63  
  64  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  65  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  66  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  67  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  68  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  70  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  72  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  73  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  74  
  75  public class NotesActivity extends AppCompatActivity implements
<abbr title="  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  76          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  77          Bucket.Listener&lt;Note&gt; {
  78  
  79      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  80      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  81      protected Bucket&lt;Note&gt; mNotesBucket;
  82      protected Bucket&lt;Tag&gt; mTagsBucket;
  83      private boolean mIsShowingMarkdown;
  84      private boolean mShouldSelectNewNote;
  85      private boolean mIsSettingsClicked;
  86      private boolean mIsTabetFullscreen;
  87  
  88      private String mTabletSearchQuery;
  89      private UndoBarController mUndoBarController;
  90      private View mFragmentsContainer;
  91      private SearchView mSearchView;
  92      private MenuItem mSearchMenuItem;
  93      private NoteListFragment mNoteListFragment;
  94      private NoteEditorFragment mNoteEditorFragment;
  95      private Note mCurrentNote;
  96      private MenuItem mEmptyTrashMenuItem;
  97  
  98      // Menu drawer
  99      private static final int GROUP_PRIMARY = 100;
 100      private static final int GROUP_SECONDARY = 101;
 101      private static final int GROUP_TERTIARY = 102;
 102      private DrawerLayout mDrawerLayout;
 103      private Menu mNavigationMenu;
 104      private ActionBarDrawerToggle mDrawerToggle;
 105      private TagsAdapter mTagsAdapter;
 106      private TagsAdapter.TagMenuItem mSelectedTag;
 107      // Tags bucket listener
 108      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 109          void updateNavigationDrawer() {
 110              runOnUiThread(new Runnable() {
 111                  public void run() {
 112                      updateNavigationDrawerItems();
 113                  }
 114              });
 115          }
 116  
 117          @Override
 118          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 119              updateNavigationDrawer();
 120          }
 121  
 122          @Override
 123          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124              updateNavigationDrawer();
 125          }
 126  
 127          @Override
 128          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 129              updateNavigationDrawer();
 130          }
 131  
 132          @Override
 133          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 134              // noop
 135          }
 136      };
 137  
 138      @Override
 139      protected void onCreate(Bundle savedInstanceState) {
 140          ThemeUtils.setTheme(this);
 141          super.onCreate(savedInstanceState);
 142  
 143          setContentView(R.layout.activity_notes);
 144  
 145          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 146  
 147          Simplenote currentApp = (Simplenote) getApplication();
 148          if (mNotesBucket == null) {
 149              mNotesBucket = currentApp.getNotesBucket();
 150          }
 151  
 152          if (mTagsBucket == null) {
 153              mTagsBucket = currentApp.getTagsBucket();
 154          }
 155  
 156          Toolbar toolbar = findViewById(R.id.toolbar);
 157          setSupportActionBar(toolbar);
 158          configureNavigationDrawer(toolbar);
 159  
 160          if (savedInstanceState == null) {
 161              mNoteListFragment = new NoteListFragment();
 162              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 163              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 164              fragmentTransaction.commit();
 165          } else {
 166              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 167          }
 168          mIsTabetFullscreen = mNoteListFragment.isHidden();
 169  
 170          if (DisplayUtils.isLargeScreen(this)) {
 171              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 173              } else if (DisplayUtils.isLandscape(this)) {
 174                  addEditorFragment();
 175              }
 176          }
 177  
 178          // enable ActionBar app icon to behave as action to toggle nav drawer
 179          ActionBar actionBar = getSupportActionBar();
 180          if (actionBar != null) {
 181              actionBar.setDisplayHomeAsUpEnabled(true);
 182              actionBar.setHomeButtonEnabled(true);
 183  
 184              // Add loading indicator to show when indexing
<abbr title=" 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 186              actionBar.setDisplayShowCustomEnabled(true);
 187              actionBar.setCustomView(progressBar);
 188              setToolbarProgressVisibility(false);
 189          }
 190  
 191          mUndoBarController = new UndoBarController(this);
 192  
 193          // Creates &#x27;Welcome&#x27; note
 194          checkForFirstLaunch();
 195  
 196          checkForSharedContent();
 197  
 198          currentApp.getSimperium().setOnUserCreatedListener(this);
 199          currentApp.getSimperium().setUserStatusChangeListener(this);
 200      }
 201  
 202      @Override
 203      protected void onResume() {
 204          super.onResume();
 205  
 206          // Ensure user has valid authorization
 207          if (userAuthenticationIsInvalid()) {
 208              startLoginActivity(true);
 209              Intent intent = getIntent();
 210  
 211              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                  AnalyticsTracker.track(
 214                          NOTE_WIDGET_SIGN_IN_TAPPED,
 215                          CATEGORY_WIDGET,
 216                          &quot;note_widget_sign_in_tapped&quot;
 217                  );
 218              }
 219          }
 220  
 221          disableScreenshotsIfLocked(this);
 222  
 223          mNotesBucket.start();
 224          mTagsBucket.start();
 225  
 226          mNotesBucket.addOnNetworkChangeListener(this);
 227          mNotesBucket.addOnSaveObjectListener(this);
 228          mNotesBucket.addOnDeleteObjectListener(this);
 229          mTagsBucket.addListener(mTagsMenuUpdater);
 230  
 231          updateNavigationDrawerItems();
 232  
 233          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234          if (userIsUnauthorized()) {
 235              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 236                  mSelectedTag = null;
 237                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 238              }
 239          }
 240  
 241          filterListBySelectedTag();
 242  
 243          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 244              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 245              mShouldSelectNewNote = false;
 246          }
 247  
 248          if (mIsShowingMarkdown) {
 249              setMarkdownShowing(false);
 250          }
 251  
 252          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 253          if(DisplayUtils.isLargeScreenLandscape(this)) {
 254              if (mIsTabetFullscreen) {
 255                  ft.hide(mNoteListFragment);
 256              } else {
 257                  ft.show(mNoteListFragment);
 258              }
 259          } else {
 260              ft.show(mNoteListFragment);
 261          }
 262          ft.commitNow();
 263      }
 264  
 265      @Override
 266      protected void onPause() {
 267          super.onPause();  // Always call the superclass method first
 268          mTagsBucket.removeListener(mTagsMenuUpdater);
 269          mTagsBucket.stop();
 270  
 271          mNotesBucket.removeOnNetworkChangeListener(this);
 272          mNotesBucket.removeOnSaveObjectListener(this);
 273          mNotesBucket.removeOnDeleteObjectListener(this);
 274          mNotesBucket.stop();
 275      }
 276  
 277      @Override
 278      public void setTitle(CharSequence title) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -        if (title == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -            title = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -        setTitleWithCustomFont(title);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +        if (getSupportActionBar() != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +            getSupportActionBar().setTitle(title);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        }</span>
 287      }
 288  
 289      @Override
 290      public void onBackPressed() {
 291          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 292              mDrawerLayout.closeDrawer(GravityCompat.START);
 293          } else {
 294              super.onBackPressed();
 295          }
 296      }
 297  
 298      @Override
 299      public void onActionModeCreated() {
 300          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 301      }
 302  
 303      @Override
 304      public void onActionModeDestroyed() {
 305          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -    private void setTitleWithCustomFont(CharSequence title) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        if (getSupportActionBar() == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -        SpannableString s = new SpannableString(title);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -        getSupportActionBar().setTitle(s);</span>
 316      }
 317  
 318      private ColorStateList getItemSelector() {















 319          int[][] states = new int[][] {
 320              new int[] {-android.R.attr.state_enabled}, // disabled
 321              new int[] { android.R.attr.state_checked}, // checked
 322              new int[] {-android.R.attr.state_checked}  // unchecked
 323          };
 324  
 325          int[] colors = new int[] {
 326              getResources().getColor(R.color.text_title_disabled, getTheme()),
 327              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 328              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 329          };
 330  
 331          return new ColorStateList(states, colors);
 332      }
 333  
 334      private void configureNavigationDrawer(Toolbar toolbar) {
 335          ColorStateList drawerSelector = getItemSelector();


 336          mDrawerLayout = findViewById(R.id.drawer_layout);
 337          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 338          NavigationView navigationView = findViewById(R.id.navigation_view);
 339          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 340          navigationView.setItemIconTintList(drawerSelector);
 341          navigationView.setItemTextColor(drawerSelector);


 342          navigationView.setNavigationItemSelectedListener(
 343              new NavigationView.OnNavigationItemSelectedListener() {
 344                  @Override
 345                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 346                      mDrawerLayout.closeDrawer(GravityCompat.START);
 347  
 348                      if (item.getItemId() == SETTINGS_ID) {
 349                          AnalyticsTracker.track(
 350                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 351                                  AnalyticsTracker.CATEGORY_TAG,
 352                                  &quot;selected_tag_in_navigation_drawer&quot;,
 353                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 354                          );
 355                          mIsSettingsClicked = true;
 356                          return false;
 357                      } else {
 358                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 359                          filterListBySelectedTag();
 360                          return true;
 361                      }
 362                  }
 363              }
 364          );
 365  
 366          mNavigationMenu = navigationView.getMenu();
<abbr title=" 367          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 367          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 368          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 368          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 369          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 369          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 370          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 371  
 372          if (mSelectedTag == null)
 373              mSelectedTag = mTagsAdapter.getDefaultItem();
 374  
 375          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 376                  R.string.close_drawer) {
 377              public void onDrawerClosed(View view) {
 378                  supportInvalidateOptionsMenu();
 379  
 380                  if (mIsSettingsClicked) {
 381                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 382                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 383                      mIsSettingsClicked = false;
 384                  }
 385              }
 386  
 387              public void onDrawerOpened(View drawerView) {
 388                  // noop
 389              }
 390  
 391              @Override
 392              public void onDrawerSlide(View drawerView, float slideOffset) {
 393                  super.onDrawerSlide(drawerView, 0f);
 394              }
 395          };
 396  
 397          mDrawerLayout.addDrawerListener(mDrawerToggle);
 398      }
 399  
 400      private void filterListBySelectedTag() {
 401          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 402  
 403          if (selectedMenuItem != null) {
 404              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 405          } else {
 406              mSelectedTag = mTagsAdapter.getDefaultItem();
 407          }
 408  
 409          checkEmptyListText(false);
 410  
 411          if (mNoteListFragment.isHidden()) {
 412              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 413              fragmentTransaction.show(mNoteListFragment);
 414              fragmentTransaction.commitNowAllowingStateLoss();
 415          }
 416  
 417          // Disable long press on notes when viewing Trash.
 418          if (mSelectedTag.id == TRASH_ID) {
 419              getNoteListFragment().getListView().setLongClickable(false);
 420          } else {
 421              getNoteListFragment().getListView().setLongClickable(true);
 422          }
 423  
 424          getNoteListFragment().refreshListFromNavSelect();
 425  
 426          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 427  
 428          switch ((int) mSelectedTag.id) {
 429              case ALL_NOTES_ID:
 430                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 431                  break;
 432              case TRASH_ID:
 433                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 434                  break;
 435              case UNTAGGED_NOTES_ID:
 436                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 437                  break;
 438              default:
 439                  properties = null;
 440                  break;
 441          }
 442  
 443          AnalyticsTracker.track(
 444                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 445                  AnalyticsTracker.CATEGORY_TAG,
 446                  &quot;selected_tag_in_navigation_drawer&quot;,
 447                  properties
 448          );
 449  
 450          setSelectedTagActive();
 451      }
 452  
 453      private void checkForFirstLaunch() {
 454          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 455              // Create the welcome note
 456              try {
 457                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 458                  welcomeNote.setCreationDate(Calendar.getInstance());
 459                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 460                  welcomeNote.setContent(getString(R.string.welcome_note));
 461                  welcomeNote.getTitle();
 462                  welcomeNote.save();
 463              } catch (BucketObjectNameInvalid e) {
 464                  // this won&#x27;t happen because welcome-android is a valid name
 465              }
 466  
 467              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 468              SharedPreferences.Editor editor = preferences.edit();
 469              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 470              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 471              editor.apply();
 472          }
 473      }
 474  
 475      private void checkForSharedContent() {
 476          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 477              // Check share action
 478              Intent intent = getIntent();
 479              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 480              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 481  
 482              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 483              String intentAction = StrUtils.notNullStr(intent.getAction());
 484              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 485              if (!TextUtils.isEmpty(text)) {
 486                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 487                      text = subject + &quot;\n\n&quot; + text;
 488                  }
 489                  Note note = mNotesBucket.newObject();
 490                  note.setCreationDate(Calendar.getInstance());
 491                  note.setModificationDate(note.getCreationDate());
 492                  note.setContent(text);
 493                  note.save();
 494                  setCurrentNote(note);
 495                  mShouldSelectNewNote = true;
 496  
 497                  AnalyticsTracker.track(
 498                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 499                          AnalyticsTracker.CATEGORY_NOTE,
 500                          &quot;external_share&quot;
 501                  );
 502  
 503                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 504                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 505                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 506                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 507                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 508                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 509                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 510                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 511                      }
 512                  }
 513              }
 514          }
 515      }
 516  
 517      private void updateNavigationDrawerItems() {
 518          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 519          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 520          if (isAlphaSort) {
 521              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 522          } else {
 523              tagCursor = Tag.allWithName(mTagsBucket).execute();
 524          }
 525  
 526          mTagsAdapter.changeCursor(tagCursor);
 527          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 528          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 529  
 530          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 531              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 531              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 532  
 533              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 534                  String name = mTagsAdapter.getItem(i).name;
 535                  int id = (int) mTagsAdapter.getItem(i).id;
 536  
 537                  if (id &gt;= 0) { // Custom tags have a positive ID.
 538                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 539                  }
 540              }
 541  
<abbr title=" 542              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_tag_off_24dp).setCheckable(true);"> 542              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr>

 543              setSelectedTagActive();
 544          }
 545      }
 546  
 547      public void launchEditTags(View view) {
 548          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 549      }
 550  
 551      private void setSelectedTagActive() {
 552          if (mSelectedTag == null) {
 553              mSelectedTag = mTagsAdapter.getDefaultItem();
 554          }
 555  
 556          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 557  
 558          if (selectedMenuItem != null) {
 559              selectedMenuItem.setChecked(true);
 560          } else {
 561              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 562          }
 563  
 564          setTitle(mSelectedTag.name);
 565      }
 566  
 567      public TagsAdapter.TagMenuItem getSelectedTag() {
 568          if (mSelectedTag == null) {
 569              mSelectedTag = mTagsAdapter.getDefaultItem();
 570          }
 571  
 572          return mSelectedTag;
 573      }
 574  
 575      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 576      public void updateTrashMenuItem() {
 577          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 578              return;
 579  
 580          // Disable the trash icon if there are no notes trashed.
 581          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 582          if (query.count() == 0) {
 583              mEmptyTrashMenuItem.setEnabled(false);
 584          } else {
 585              mEmptyTrashMenuItem.setEnabled(true);
 586          }
 587      }
 588  
 589      private void addEditorFragment() {
 590          FragmentManager fm = getSupportFragmentManager();
 591          FragmentTransaction ft = fm.beginTransaction();
 592          mNoteEditorFragment = new NoteEditorFragment();
 593          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 594          ft.commitAllowingStateLoss();
 595          fm.executePendingTransactions();
 596      }
 597  
 598      private boolean userAccountRequired() {
 599          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 600      }
 601  
 602      /**
 603       * Checks for a previously valid user that is now not authenticated
 604       * Also checks if user account is required (added in version 1.5.6)
 605       *
 606       * @return true if user has invalid authorization
 607       */
 608      private boolean userAuthenticationIsInvalid() {
 609          Simplenote currentApp = (Simplenote) getApplication();
 610          Simperium simperium = currentApp.getSimperium();
 611          User user = simperium.getUser();
 612          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 613          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 614                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 615      }
 616  
 617      public boolean userIsUnauthorized() {
 618          Simplenote currentApp = (Simplenote) getApplication();
 619          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 620      }
 621  
 622      public void setCurrentNote(Note note) {
 623          mCurrentNote = note;
 624      }
 625  
 626      public NoteListFragment getNoteListFragment() {
 627          return mNoteListFragment;
 628      }
 629  
 630      @SuppressWarnings(&quot;ResourceType&quot;)
 631      @Override
 632      public boolean onCreateOptionsMenu(Menu menu) {
 633          super.onCreateOptionsMenu(menu);
 634          MenuInflater inflater = getMenuInflater();
 635          inflater.inflate(R.menu.notes_list, menu);
 636  
 637          // restore the search query if on a landscape tablet
 638          String searchQuery = null;
 639          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 640              searchQuery = mSearchView.getQuery().toString();
 641  
 642          mSearchMenuItem = menu.findItem(R.id.menu_search);
 643          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 644  
 645          if (!TextUtils.isEmpty(searchQuery)) {
 646              mSearchView.setQuery(searchQuery, false);
 647              mSearchMenuItem.expandActionView();
 648          } else {
 649              // Workaround for setting the search placeholder text color
 650              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 651              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 652                      hintHexColor,
 653                      getString(R.string.search))));
 654          }
 655  
 656          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 657              @Override
 658              public boolean onQueryTextChange(String newText) {
 659                  if (mSearchMenuItem.isActionViewExpanded()) {
 660                      getNoteListFragment().searchNotes(newText);
 661                  }
 662                  return true;
 663              }
 664  
 665              @Override
 666              public boolean onQueryTextSubmit(String queryText) {
 667                  getNoteListFragment().searchNotes(queryText);
 668                  return true;
 669              }
 670  
 671          });
 672  
 673          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 674              @Override
 675              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 676                  checkEmptyListText(true);
 677                  if (mNoteListFragment != null) {
 678                      mNoteListFragment.setFloatingActionButtonVisible(false);
 679                  }
 680                  AnalyticsTracker.track(
 681                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 682                          AnalyticsTracker.CATEGORY_NOTE,
 683                          &quot;action_bar_search_tap&quot;
 684                  );
 685                  return true;
 686              }
 687  
 688              @Override
 689              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 690                  // Show all notes again
 691                  if (mNoteListFragment != null) {
 692                      mNoteListFragment.setFloatingActionButtonVisible(true);
 693                  }
 694                  mTabletSearchQuery = &quot;&quot;;
 695                  mSearchView.setQuery(&quot;&quot;, false);
 696                  checkEmptyListText(false);
 697                  getNoteListFragment().clearSearch();
 698                  return true;
 699              }
 700          });
 701  
 702          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 703              @Override
 704              public boolean onMenuItemClick(MenuItem item) {
 705                  if (!mSearchMenuItem.isActionViewExpanded())
 706                      showDetailPlaceholder();
 707                  return false;
 708              }
 709          });
 710  
 711          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 712          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 713              trashItem.setTitle(R.string.undelete);
 714              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 715          } else {
 716              trashItem.setTitle(R.string.delete);
 717              trashItem.setIcon(R.drawable.ic_trash_24dp);
 718          }
 719  
 720          if (DisplayUtils.isLargeScreenLandscape(this)) {
 721              // Restore the search query on landscape tablets
 722              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 723                  mSearchMenuItem.expandActionView();
 724                  mSearchView.setQuery(mTabletSearchQuery, false);
 725                  mSearchView.clearFocus();
 726              }
 727  
 728              if (mCurrentNote != null) {
 729                  menu.findItem(R.id.menu_share).setVisible(true);
 730                  menu.findItem(R.id.menu_view_info).setVisible(true);
 731                  menu.findItem(R.id.menu_checklist).setVisible(true);
 732                  menu.findItem(R.id.menu_history).setVisible(true);
 733                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 734                  menu.findItem(R.id.menu_sidebar).setVisible(true);
 735                  trashItem.setVisible(true);
 736              } else {
 737                  menu.findItem(R.id.menu_share).setVisible(false);
 738                  menu.findItem(R.id.menu_view_info).setVisible(false);
 739                  menu.findItem(R.id.menu_checklist).setVisible(false);
 740                  menu.findItem(R.id.menu_history).setVisible(false);
 741                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 742                  menu.findItem(R.id.menu_sidebar).setVisible(false);
 743                  trashItem.setVisible(false);
 744              }
 745              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 746          } else {
 747              menu.findItem(R.id.menu_search).setVisible(true);
 748              menu.findItem(R.id.menu_share).setVisible(false);
 749              menu.findItem(R.id.menu_view_info).setVisible(false);
 750              menu.findItem(R.id.menu_checklist).setVisible(false);
 751              menu.findItem(R.id.menu_history).setVisible(false);
 752              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 753              menu.findItem(R.id.menu_sidebar).setVisible(false);
 754              trashItem.setVisible(false);
 755              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 756          }
 757  
 758          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 759              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 760              mEmptyTrashMenuItem.setVisible(true);
 761  
 762              updateTrashMenuItem();
 763  
 764              menu.findItem(R.id.menu_search).setVisible(false);
 765              menu.findItem(R.id.menu_share).setVisible(false);
 766              menu.findItem(R.id.menu_history).setVisible(false);
 767              menu.findItem(R.id.menu_checklist).setVisible(false);
 768          }
 769  
 770          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);

 771  
 772          return true;
 773      }
 774  
 775      @Override
 776      public boolean onOptionsItemSelected(MenuItem item) {
 777          if (mDrawerToggle.onOptionsItemSelected(item)) {
 778              return true;
 779          }
 780          switch (item.getItemId()) {
 781              case R.id.menu_sidebar:
 782                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 783                  if (mNoteListFragment.isHidden()) {
 784                      ft.show(mNoteListFragment);
 785                  } else {
 786                      ft.hide(mNoteListFragment);
 787                  }
 788                  ft.commitNowAllowingStateLoss();
 789                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 790                  return true;
 791              case R.id.menu_markdown_preview:
 792                  if (mIsShowingMarkdown) {
 793                      item.setIcon(R.drawable.ic_preview_24dp);

 794                      item.setTitle(getString(R.string.markdown_show));
 795                      setMarkdownShowing(false);
 796                      mCurrentNote.setPreviewEnabled(false);
 797                  } else {
 798                      item.setIcon(R.drawable.ic_preview_stop_24dp);

 799                      item.setTitle(getString(R.string.markdown_hide));
 800                      setMarkdownShowing(true);
 801                      mCurrentNote.setPreviewEnabled(true);
 802                  }
 803  
 804                  mCurrentNote.save();
 805                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 806  
 807                  return true;
 808              case R.id.menu_delete:
 809                  if (mNoteEditorFragment != null) {
 810                      if (mCurrentNote != null) {
 811                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 812                          mCurrentNote.setModificationDate(Calendar.getInstance());
 813                          mCurrentNote.save();
 814  
 815                          updateViewsAfterTrashAction(mCurrentNote);
 816                      }
 817                  }
 818                  return true;
 819              case R.id.menu_empty_trash:
 820                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 821  
 822                  alert.setTitle(R.string.empty_trash);
 823                  alert.setMessage(R.string.confirm_empty_trash);
 824                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 825                      public void onClick(DialogInterface dialog, int whichButton) {
 826                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 827                          AnalyticsTracker.track(
 828                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 829                                  AnalyticsTracker.CATEGORY_NOTE,
 830                                  &quot;overflow_menu&quot;
 831                          );
 832                      }
 833                  });
 834                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 835                      public void onClick(DialogInterface dialog, int whichButton) {
 836                          // Do nothing, just closing the dialog
 837                      }
 838                  });
 839                  alert.show();
 840                  return true;
 841              case android.R.id.home:
 842                  invalidateOptionsMenu();
 843                  return true;
 844              default:
 845                  return super.onOptionsItemSelected(item);
 846          }
 847      }
 848  
 849      @Override
 850      public boolean onPrepareOptionsMenu(Menu menu) {
 851          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 852  
 853          if (mIsShowingMarkdown) {
 854              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);

 855              markdownItem.setTitle(getString(R.string.markdown_hide));
 856          } else {
 857              markdownItem.setIcon(R.drawable.ic_preview_24dp);

 858              markdownItem.setTitle(getString(R.string.markdown_show));
 859          }
 860  
 861          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 862  
 863          return super.onPrepareOptionsMenu(menu);
 864      }
 865  
 866      public void updateViewsAfterTrashAction(Note note) {
 867          if (note == null || isFinishing()) {
 868              return;
 869          }
 870  
 871          if (note.isDeleted()) {
 872              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 873              deletedNoteIds.add(note.getSimperiumKey());
 874              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 875              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 876              AnalyticsTracker.track(
 877                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 878                      AnalyticsTracker.CATEGORY_NOTE,
 879                      &quot;overflow_menu&quot;
 880              );
 881          } else {
 882              AnalyticsTracker.track(
 883                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 884                      AnalyticsTracker.CATEGORY_NOTE,
 885                      &quot;overflow_menu&quot;
 886              );
 887          }
 888  
 889          // If we just deleted/restored the active note, show the placeholder
 890          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 891              showDetailPlaceholder();
 892          }
 893  
 894          NoteListFragment fragment = getNoteListFragment();
 895          if (fragment != null) {
 896              fragment.getPrefs();
 897              fragment.refreshList();
 898          }
 899  
 900          invalidateOptionsMenu();
 901      }
 902  
 903      public void setMarkdownShowing(boolean isMarkdownShowing) {
 904          mIsShowingMarkdown = isMarkdownShowing;
 905          if (mNoteEditorFragment != null) {
 906              if (isMarkdownShowing) {
 907                  mNoteEditorFragment.showMarkdown();
 908              } else {
 909                  mNoteEditorFragment.hideMarkdown();
 910              }
 911          }
 912          invalidateOptionsMenu();
 913      }
 914  
 915      /**
 916       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 917       * the item with the given ID was selected. Used for tablets only.
 918       */
 919      @Override
<abbr title=" 920      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 920      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 921          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 922              // Launch the editor activity
 923              Bundle arguments = new Bundle();
 924              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 925              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 926              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 927  
 928              if (matchOffsets != null) {
 929                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 930              }
 931  
 932              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 933              editNoteIntent.putExtras(arguments);
 934              if (mNoteListFragment.isHidden()) {
 935                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 936              }
 937              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 938          } else {
 939              mNoteEditorFragment.setNote(noteID, matchOffsets);
 940              getNoteListFragment().setNoteSelected(noteID);
 941              setMarkdownShowing(isPreviewEnabled);
 942  
 943              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 944                  mTabletSearchQuery = mSearchView.getQuery().toString();
 945              }
 946  
 947              mNoteEditorFragment.clearMarkdown();
 948  
 949              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 950                  setMarkdownShowing(false);
 951              }
 952  
 953              invalidateOptionsMenu();
 954          }
 955  
 956          AnalyticsTracker.track(
 957                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 958                  AnalyticsTracker.CATEGORY_NOTE,
 959                  &quot;note_list_row_tap&quot;
 960          );
 961      }
 962  
 963      @Override
 964      public void onUserCreated(User user) {
 965          // New account created
 966          AnalyticsTracker.track(
 967                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 968                  AnalyticsTracker.CATEGORY_USER,
 969                  &quot;account_created_from_login_activity&quot;
 970          );
 971      }
 972  
 973      public void onUserStatusChange(User.Status status) {
 974          switch (status) {
 975              // successfully used access token to connect to simperium bucket
 976              case AUTHORIZED:
 977                  runOnUiThread(new Runnable() {
 978                      @Override
 979                      public void run() {
 980                          if (!mNotesBucket.hasChangeVersion()) {
 981                              setToolbarProgressVisibility(true);
 982                          }
 983                      }
 984                  });
 985                  break;
 986  
 987              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 988              case NOT_AUTHORIZED:
 989                  runOnUiThread(new Runnable() {
 990                      @Override
 991                      public void run() {
 992                          startLoginActivity(true);
 993                      }
 994                  });
 995                  break;
 996  
<abbr title=" 997              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 997              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 998              case UNKNOWN:
 999                  break;
1000          }
1001      }
1002  
1003      private void setToolbarProgressVisibility(boolean isVisible) {
1004          if (getSupportActionBar() != null) {
1005              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1006          }
1007      }
1008  
1009      public void startLoginActivity(boolean signInFirst) {
1010          // Clear some account-specific prefs
1011          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1012          editor.remove(PrefUtils.PREF_WP_TOKEN);
1013          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1014          editor.apply();
1015  
1016          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1017          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1018      }
1019  
1020      @Override
1021      public void recreate() {
1022          Handler handler = new Handler();
1023          handler.post(new Runnable() {
1024              @Override
1025              public void run() {
1026                  NotesActivity.super.recreate();
1027              }
1028          });
1029      }
1030  
1031      @Override
1032      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1033          super.onActivityResult(requestCode, resultCode, data);
1034          switch (requestCode) {
1035              case Simplenote.INTENT_PREFERENCES:
<abbr title="1036                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1036                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1037                  invalidateOptionsMenu();
1038                  NoteListFragment fragment = getNoteListFragment();
1039                  if (fragment != null) {
1040                      fragment.getPrefs();
1041                      fragment.refreshList();
1042                  }
1043  
1044                  break;
1045              case Simplenote.INTENT_EDIT_NOTE:
1046                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1047                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1048                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1049                          if (noteId != null) {
1050                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1051                              deletedNoteIds.add(noteId);
1052                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1053                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1054                          }
<abbr title="1055                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1055                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1056                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1057                          mNoteListFragment.setNoteSelected(selectedNoteId);
1058                          if (mNoteEditorFragment != null) {
1059                              mNoteEditorFragment.setNote(selectedNoteId);
1060                          }
1061                      }
1062                  }
1063                  break;
1064              case Simperium.SIGNUP_SIGNIN_REQUEST:
1065                  invalidateOptionsMenu();
1066  
1067                  Simplenote app = (Simplenote) getApplication();
1068                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1069                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1070  
1071                  AnalyticsTracker.track(
1072                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1073                          AnalyticsTracker.CATEGORY_USER,
1074                          &quot;signed_in_from_login_activity&quot;
1075                  );
1076  
1077                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1078                      finish();
1079                  }
1080  
1081                  break;
1082          }
1083      }
1084  
1085      @Override
1086      public void onUndo() {
1087          if (mUndoBarController == null) return;
1088  
1089          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1090          if (deletedNoteIds != null) {
1091              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1092                  Note deletedNote;
1093                  try {
1094                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1095                  } catch (BucketObjectMissingException e) {
1096                      return;
1097                  }
1098                  if (deletedNote != null) {
1099                      deletedNote.setDeleted(false);
1100                      deletedNote.setModificationDate(Calendar.getInstance());
1101                      deletedNote.save();
1102                      NoteListFragment fragment = getNoteListFragment();
1103                      if (fragment != null) {
1104                          fragment.getPrefs();
1105                          fragment.refreshList();
1106                      }
1107                  }
1108              }
1109          }
1110      }
1111  
1112      @Override
1113      protected void onPostCreate(Bundle savedInstanceState) {
1114          super.onPostCreate(savedInstanceState);
1115          // Sync the toggle state after onRestoreInstanceState has occurred.
1116          mDrawerToggle.syncState();
1117      }
1118  
1119      @Override
1120      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1121          super.onConfigurationChanged(newConfig);
1122  
1123          mDrawerToggle.onConfigurationChanged(newConfig);
1124  
1125          if (DisplayUtils.isLargeScreen(this)) {
1126              mIsShowingMarkdown = false;
1127  
1128              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1129                  // Add the editor fragment
1130                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1131                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1131                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1132                  } else if (DisplayUtils.isLandscape(this)) {
1133                      addEditorFragment();
1134                  }
1135  
1136                  if (mNoteListFragment != null) {
1137                      mNoteListFragment.setActivateOnItemClick(true);
1138                      mNoteListFragment.setDividerVisible(true);
1139                  }
1140  
1141                  // Select the current note on a tablet
1142                  if (mCurrentNote != null) {
<abbr title="1143                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1143                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1144                  } else {
1145                      mNoteEditorFragment.setPlaceholderVisible(true);
1146                      mNoteListFragment.getListView().clearChoices();
1147                  }
1148  
1149                  invalidateOptionsMenu();
1150              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1151              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1152                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1152                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1153              }
1154          }
1155  
1156          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1157              // Remove the editor fragment when rotating back to portrait
1158              mCurrentNote = null;
1159              if (mNoteListFragment != null) {
1160                  mNoteListFragment.setActivateOnItemClick(false);
1161                  mNoteListFragment.setDividerVisible(false);
1162                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1163                  mNoteListFragment.refreshList();
1164              }
1165              FragmentManager fm = getSupportFragmentManager();
1166              FragmentTransaction ft = fm.beginTransaction();
1167              ft.remove(mNoteEditorFragment);
1168              mNoteEditorFragment = null;
1169              ft.commitAllowingStateLoss();
1170              fm.executePendingTransactions();
1171              invalidateOptionsMenu();
1172          }
1173      }
1174  
1175      public void checkEmptyListText(boolean isSearch) {
1176          if (isSearch) {
<abbr title="1177              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1177              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1178              getNoteListFragment().setEmptyListViewClickable(false);
1179          } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1180              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1180              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1181              AnalyticsTracker.track(
1182                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1183                      AnalyticsTracker.CATEGORY_NOTE,
1184                      &quot;trash_filter_selected&quot;
1185              );
1186              getNoteListFragment().setEmptyListViewClickable(false);
1187          } else {
<abbr title="1188              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1188              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1189              getNoteListFragment().setEmptyListViewClickable(true);
1190          }
1191      }
1192  
1193      public void showDetailPlaceholder() {
1194          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1195              mCurrentNote = null;
1196              mNoteEditorFragment.setPlaceholderVisible(true);
1197              mNoteEditorFragment.clearMarkdown();
1198              mNoteEditorFragment.hideMarkdown();
1199              mIsShowingMarkdown = false;
1200          }
1201      }
1202  
1203      public void stopListeningToNotesBucket() {
1204          mNotesBucket.removeOnNetworkChangeListener(this);
1205          mNotesBucket.removeOnSaveObjectListener(this);
1206          mNotesBucket.removeOnDeleteObjectListener(this);
1207      }
1208  
1209      // Returns the appropriate view to show the undo bar within
1210      private View getUndoView() {
1211          View undoView = mFragmentsContainer;
1212          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1213                  getNoteListFragment() != null &amp;&amp;
1214                  getNoteListFragment().getRootView() != null) {
1215              undoView = getNoteListFragment().getRootView();
1216          }
1217  
1218          return undoView;
1219      }
1220  
1221      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1222          if (mUndoBarController != null) {
1223              mUndoBarController.setDeletedNoteIds(noteIds);
1224              mUndoBarController.showUndoBar(
1225                      getUndoView(),
1226                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1227              );
1228          }
1229      }
1230  
1231      /* Simperium Bucket Listeners */
1232      // received a change from the network, refresh the list
1233      @Override
1234      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1235          runOnUiThread(new Runnable() {
1236              @Override
1237              public void run() {
1238                  if (type == Bucket.ChangeType.INDEX) {
1239                      setToolbarProgressVisibility(false);
1240                  }
1241                  mNoteListFragment.refreshList();
1242              }
1243          });
1244      }
1245  
1246      @Override
1247      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1248          runOnUiThread(new Runnable() {
1249              @Override
1250              public void run() {
1251                  mNoteListFragment.refreshList();
1252              }
1253          });
1254      }
1255  
1256      @Override
1257      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1258          runOnUiThread(new Runnable() {
1259              @Override
1260              public void run() {
1261                  mNoteListFragment.refreshList();
1262              }
1263          });
1264      }
1265  
1266      @Override
1267      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1268          // noop, NoteEditorFragment will handle this
1269      }
1270  
1271      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1272  
1273          @Override
1274          protected Void doInBackground(Void... voids) {
1275              if (mNotesBucket == null) return null;
1276  
1277              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1278              Bucket.ObjectCursor c = query.execute();
1279              while (c.moveToNext()) {
1280                  c.getObject().delete();
1281              }
1282  
1283              return null;
1284          }
1285  
1286          @Override
1287          protected void onPostExecute(Void nada) {
1288              showDetailPlaceholder();
1289          }
1290      }
1291  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            