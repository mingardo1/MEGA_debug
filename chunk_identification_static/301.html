<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>301</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    301
                    <a href="300.html">prev</a>
                    <a href="302.html">next</a>
                    <a href="301_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_ee17739ea99d0b228fbeb1893c3bf5d3244097db_hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;ee17739ea99d0b228fbeb1893c3bf5d3244097db:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;ee17739ea99d0b228fbeb1893c3bf5d3244097db^1:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;ee17739ea99d0b228fbeb1893c3bf5d3244097db^2:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;d8af8485026c1bfba5fda654f05f6301a0fe3b5c:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bs], [bs], [j]], subset: [[b], [b], [bs], [bs], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.sink.hbase;
  21 
  22 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.dtstack.flink.sql.dirtyManager.manager.DirtyDataManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
  25 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;</span>
  29 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import com.dtstack.flink.sql.factory.DTThreadFactory;</span>
  31 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  32 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  33 import com.google.common.collect.Maps;
  34 import org.apache.commons.lang3.StringUtils;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.configuration.Configuration;
  37 import org.apache.flink.types.Row;
  38 import org.apache.flink.util.Preconditions;
  39 import org.apache.hadoop.hbase.AuthUtil;
  40 import org.apache.hadoop.hbase.ChoreService;
  41 import org.apache.hadoop.hbase.HBaseConfiguration;
  42 import org.apache.hadoop.hbase.ScheduledChore;
  43 import org.apache.hadoop.hbase.TableName;
  44 import org.apache.hadoop.hbase.client.Connection;
  45 import org.apache.hadoop.hbase.client.ConnectionFactory;
  46 import org.apache.hadoop.hbase.client.Put;
  47 import org.apache.hadoop.hbase.client.Table;
  48 import org.apache.hadoop.security.UserGroupInformation;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 
  52 import java.io.File;
  53 import java.io.IOException;
  54 import java.security.PrivilegedAction;
  55 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  56 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import java.security.PrivilegedAction;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import java.util.LinkedHashMap;</span>
  61 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 import java.util.ArrayList;</span>
  63 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  64 import java.util.LinkedList;
  65 import java.util.List;
  66 import java.util.Map;
  67 import java.util.concurrent.ScheduledExecutorService;
  68 import java.util.concurrent.ScheduledFuture;
  69 import java.util.concurrent.ScheduledThreadPoolExecutor;
  70 import java.util.concurrent.TimeUnit;
  71 
  72 /**
  73  * @author: jingzhen@dtstack.com
  74  * date: 2017-6-29
  75  */
  76 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
  77 
  78     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  79     private String host;
  80     private String zkParent;
  81     private String rowkey;
  82     private String tableName;
  83     private String[] columnNames;
  84     private Map&lt;String, String&gt; columnNameFamily;
  85     private boolean kerberosAuthEnable;
  86     private String regionserverKeytabFile;
  87     private String regionserverPrincipal;
  88     private String securityKrb5Conf;
  89     private String zookeeperSaslClient;
  90     private String clientPrincipal;
  91     private String clientKeytabFile;
  92     private String[] families;
  93     private String[] qualifiers;
  94     private transient org.apache.hadoop.conf.Configuration conf;
  95     private transient Connection conn;
  96     private transient Table table;
  97     private transient ChoreService choreService;
  98     private transient List&lt;Row&gt; records;
  99     private transient volatile boolean closed = false;
 100     /**
 101      * 批量写入的参数
 102      */
 103     private Integer batchSize;
 104     private Long batchWaitInterval;
 105     /**
 106      * 定时任务
 107      */
 108     private transient ScheduledExecutorService scheduler;
 109     private transient ScheduledFuture&lt;?&gt; scheduledFuture;
 110 
 111     private HbaseOutputFormat() {
 112     }
 113 
 114     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 115         return new HbaseOutputFormatBuilder();
 116     }
 117 
 118     private DirtyDataManager dirtyDataManager;
 119 
 120     @Override
 121     public void configure(Configuration parameters) {
 122         // 这里不要做耗时较长的操作，否则会导致AKKA通信超时
 123         // DO NOTHING
 124     }
 125 
 126     @Override
 127     public void open(int taskNumber, int numTasks) throws IOException {
 128         LOG.warn(&quot;---open---&quot;);
 129         records = new ArrayList&lt;&gt;();
 130         conf = HBaseConfiguration.create();
 131         openConn();
 132         table = conn.getTable(TableName.valueOf(tableName));
 133         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 134         initMetric();
 135     }
 136 
 137     private void openConn() {
 138         try {
 139             if (kerberosAuthEnable) {
 140                 LOG.info(&quot;open kerberos conn&quot;);
 141                 openKerberosConn();
 142             } else {
 143                 LOG.info(&quot;open conn&quot;);
 144                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 145                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 146                 conn = ConnectionFactory.createConnection(conf);
 147             }
 148         } catch (Exception e) {
 149             throw new RuntimeException(e);
 150         }
 151         initScheduledTask(batchWaitInterval);
 152     }
 153 
 154     /**
 155      * 初始化定时写入任务
 156      *
 157      * @param batchWaitInterval 定时任务时间
 158      */
 159     private void initScheduledTask(Long batchWaitInterval) {
 160         try {
 161             if (batchWaitInterval &gt; 0) {
 162                 this.scheduler = new ScheduledThreadPoolExecutor(
 163                         1,
 164                         new DTThreadFactory(&quot;hbase-batch-flusher&quot;)
 165                 );
 166 
 167                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(
 168                         () -&gt; {
 169                             synchronized (HbaseOutputFormat.this) {
 170                                 if (!records.isEmpty()) {
 171                                     dealBatchOperation(records);
 172                                 }
 173                             }
 174                         }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS
 175                 );
 176             }
 177         } catch (Exception e) {
 178             LOG.error(&quot;init schedule task failed !&quot;);
 179             throw new RuntimeException(e);
 180         }
 181     }
 182 
 183     private void openKerberosConn() throws Exception {
 184         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 185         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 186 
 187         LOG.info(&quot;kerberos config:{}&quot;, this.conf.toString());
 188         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 189         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 189         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;🔵</abbr>
 190 
 191         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 192 
 193         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 194         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 194         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal🔵</abbr>
 195 
 196         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 197         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 198 
<abbr title=" 199         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 199         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinci🔵</abbr>
 200         org.apache.hadoop.conf.Configuration finalConf = conf;
 201         conn = userGroupInformation.doAs((PrivilegedAction&lt;Connection&gt;) () -&gt; {
 202             try {
 203                 ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 204                 if (authChore != null) {
 205                     choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 206                     choreService.scheduleChore(authChore);
 207                 }
 208 
 209                 return ConnectionFactory.createConnection(finalConf);
 210             } catch (IOException e) {
 211                 LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 212                 throw new RuntimeException(e);
 213             }
 214         });
 215     }
 216 
 217     @Override
 218     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) {
 219         if (record.f0) {
 220             if (this.batchSize != 0) {
 221                 writeBatchRecord(record.f1);
 222             } else {
 223                 dealInsert(record.f1);
 224             }
 225         }
 226     }
 227 
 228     public void writeBatchRecord(Row row) {
 229         records.add(row);
 230         // 数据累计到batchSize之后开始处理
 231         if (records.size() == this.batchSize) {
 232             dealBatchOperation(records);
 233         }
 234     }
 235 
 236     protected synchronized void dealBatchOperation(List&lt;Row&gt; records) {
 237         // A null in the result array means that the call for that action failed, even after retries.
 238         Object[] results = new Object[records.size()];
 239         try {
 240             List&lt;Put&gt; puts = new ArrayList&lt;&gt;();
 241             for (Row record : records) {
 242                 puts.add(getPutByRow(record));
 243             }
 244             table.batch(puts, results);
 245 
 246             // 判断数据是否插入成功
 247             for (int i = 0; i &lt; results.length; i++) {
 248                 if (results[i] == null) {
<abbr title=" 249                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 249                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) 🔵</abbr>
 250                         LOG.error(&quot;record insert failed ..{}&quot;, records.get(i).toString());
 251                     }
 252                     // 脏数据记录
 253                     outDirtyRecords.inc();
 254                 } else {
 255                     // 输出结果条数记录
 256                     outRecords.inc();
 257                 }
 258             }
 259             // 打印结果
 260             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 261                 // 只打印最后一条数据
 262                 LOG.info(records.get(records.size() - 1).toString());
 263             }
 264         } catch (IOException | InterruptedException e) {
 265             LOG.error(&quot;&quot;, e);
 266         } finally {
 267             // 添加完数据之后数据清空records
 268             records.clear();
 269         }
 270     }
 271 
 272     protected void dealInsert(Row record) {
 273         Put put = getPutByRow(record);
 274         if (put == null || put.isEmpty()) {
 275             // 记录脏数据
 276             outDirtyRecords.inc();
 277             return;
 278         }
 279 
 280         try {
 281             table.put(put);
 282         } catch (Exception e) {
 283             dirtyDataManager.collectDirtyData(
 284                     record.toString()
 285                     , e.getMessage());
 286             outDirtyRecords.inc();
 287         }
 288 
 289         if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 290             LOG.info(record.toString());
 291         }
 292         outRecords.inc();
 293     }
 294 
 295 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     protected void dealDelete(Row record) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297         String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298         if (!StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299             Delete delete = new Delete(Bytes.toBytes(rowKey));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301                 table.delete(delete);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302             } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303                 dirtyDataManager.collectDirtyData(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304                         record.toString()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305                         , e.getMessage());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306                 outDirtyRecords.inc();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309                 LOG.info(record.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311             outRecords.inc();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314 </span>
 315 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316         String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317         if (!StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318             Delete delete = new Delete(Bytes.toBytes(rowKey));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320                 table.delete(delete);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321             } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322                 if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323                     LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324                     LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329                 LOG.info(record.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335     private Put getPutByRow(Row record) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336         String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         if (StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338             return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         Put put = new Put(rowKey.getBytes());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341         for (int i = 0; i &lt; record.getArity(); ++i) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342             Object fieldVal = record.getField(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343             if (fieldVal != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344                 byte[] val = fieldVal.toString().getBytes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345                 byte[] cf = families[i].getBytes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346                 byte[] qualifier = qualifiers[i].getBytes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348                 put.addColumn(cf, qualifier, val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         return put;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354     private String buildRowKey(Row record) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         String rowKeyValues = getRowKeyValues(record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356         // all rowkey not null</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357         if (StringUtils.isBlank(rowKeyValues)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360             return &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362         return rowKeyValues;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365     private String getRowKeyValues(Row record) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366         Map&lt;String, Object&gt; row = rowConvertMap(record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         rowKeyBuilder.init(rowkey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369         return rowKeyBuilder.getRowKey(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372     private Map&lt;String, Object&gt; rowConvertMap(Row record){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         for(int i = 0; i &lt; columnNames.length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375             rowValue.put(columnNames[i], record.getField(i));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377         return rowValue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         if (conn != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383             conn.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384             conn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     private HbaseOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         return new HbaseOutputFormatBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394     public static class HbaseOutputFormatBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         private HbaseOutputFormat format;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398         private HbaseOutputFormatBuilder() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399             format = new HbaseOutputFormat();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 </span>
 402 =======
 403 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 404     private Put getPutByRow(Row record) {
 405         String rowKey = buildRowKey(record);
 406         if (StringUtils.isEmpty(rowKey)) {
 407             return null;
 408         }
 409         Put put = new Put(rowKey.getBytes());
 410         for (int i = 0; i &lt; record.getArity(); ++i) {
 411             Object fieldVal = record.getField(i);
 412             if (fieldVal != null) {
 413                 byte[] val = fieldVal.toString().getBytes();
 414                 byte[] cf = families[i].getBytes();
 415                 byte[] qualifier = qualifiers[i].getBytes();
 416 
 417                 put.addColumn(cf, qualifier, val);
 418             }
 419         }
 420         return put;
 421     }
 422 
 423     private String buildRowKey(Row record) {
 424         String rowKeyValues = getRowKeyValues(record);
 425         // all rowkey not null
 426         if (StringUtils.isBlank(rowKeyValues)) {
 427             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 428             outDirtyRecords.inc();
 429             return &quot;&quot;;
 430         }
 431         return rowKeyValues;
 432     }
 433 
 434     private String getRowKeyValues(Row record) {
 435         Map&lt;String, Object&gt; row = rowConvertMap(record);
 436         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 437         rowKeyBuilder.init(rowkey);
 438         return rowKeyBuilder.getRowKey(row);
 439     }
 440 
 441     private Map&lt;String, Object&gt; rowConvertMap(Row record) {
 442         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 443         for (int i = 0; i &lt; columnNames.length; i++) {
 444             rowValue.put(columnNames[i], record.getField(i));
 445         }
 446         return rowValue;
 447     }
 448 
 449     @Override
 450     public synchronized void close() throws IOException {
 451         if (closed) {
 452             return;
 453         }
 454 
 455         closed = true;
 456         if (!records.isEmpty()) {
 457             dealBatchOperation(records);
 458         }
 459 
 460         if (scheduledFuture != null) {
 461             scheduledFuture.cancel(false);
 462             if (scheduler != null) {
 463                 scheduler.shutdownNow();
 464             }
 465         }
 466 
 467         if (conn != null) {
 468             conn.close();
 469             conn = null;
 470         }
 471     }
 472 
 473     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config,
 474                                         String regionserverPrincipal,
 475                                         String zookeeperSaslClient,
 476                                         String securityKrb5Conf) {
 477         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 478             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 478             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is🔵</abbr>
 479         }
 480         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 481         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 482         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 483         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 484 
 485 
 486         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 487             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 488         }
 489 
 490         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 491             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 492             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 493             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 494         }
 495     }
 496 
 497     @Override
 498     public String toString() {
 499         return &quot;HbaseOutputFormat kerberos{&quot; +
 500                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 501                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 502                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 503                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 504                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 505                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 506                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 507                 &quot;, batchSize=&#x27;&quot; + batchSize + &#x27;\&#x27;&#x27; +
 508                 &quot;, batchWaitInterval=&#x27;&quot; + batchWaitInterval + &#x27;\&#x27;&#x27; +
 509                 &#x27;}&#x27;;
 510     }
 511 
 512     public static class HbaseOutputFormatBuilder {
 513 
 514         private final HbaseOutputFormat format;
 515 
 516         private HbaseOutputFormatBuilder() {
 517             format = new HbaseOutputFormat();
 518         }
 519 
 520         public HbaseOutputFormatBuilder setHost(String host) {
 521             format.host = host;
 522             return this;
 523         }
 524 
 525         public HbaseOutputFormatBuilder setZkParent(String parent) {
 526             format.zkParent = parent;
 527             return this;
 528         }
 529 
 530 
 531         public HbaseOutputFormatBuilder setTable(String tableName) {
 532             format.tableName = tableName;
 533             return this;
 534         }
 535 
 536         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 537             format.rowkey = rowkey;
 538             return this;
 539         }
 540 
 541         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 542             format.columnNames = columnNames;
 543             return this;
 544         }
 545 
 546         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 547             format.columnNameFamily = columnNameFamily;
 548             return this;
 549         }
 550 
 551         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 552             format.kerberosAuthEnable = kerberosAuthEnable;
 553             return this;
 554         }
 555 
 556         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 557             format.regionserverKeytabFile = regionserverKeytabFile;
 558             return this;
 559         }
 560 
 561         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 562             format.regionserverPrincipal = regionserverPrincipal;
 563             return this;
 564         }
 565 
 566         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 567             format.securityKrb5Conf = securityKrb5Conf;
 568             return this;
 569         }
 570 
 571         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 572             format.zookeeperSaslClient = zookeeperSaslClient;
 573             return this;
 574         }
 575 
 576         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 577             format.clientPrincipal = clientPrincipal;
 578             return this;
 579         }
 580 
 581         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 582             format.clientKeytabFile = clientKeytabFile;
 583             return this;
 584         }
 585 
 586 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 587         public HbaseOutputFormatBuilder setDirtyManager(DirtyDataManager dirtyDataManager) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 588             format.dirtyDataManager = dirtyDataManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 589             return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 590         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 591 </span>
 592 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594         public HbaseOutputFormat finish() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 598             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 598             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600             String[] families = new String[format.columnNames.length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601             String[] qualifiers = new String[format.columnNames.length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603             if (format.columnNameFamily != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604                 List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605                 String[] columns = keyList.toArray(new String[0]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606                 for (int i = 0; i &lt; columns.length; ++i) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607                     String col = columns[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608                     String[] part = col.split(&quot;:&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609                     families[i] = part[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610                     qualifiers[i] = part[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613             format.families = families;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614             format.qualifiers = qualifiers;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616             return format;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 621     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,"> 621     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 622                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOException {"> 622                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOExc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623         if (StringUtils.isEmpty(regionserverPrincipal)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 624             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 624             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632         if (!StringUtils.isEmpty(zookeeperSaslClient)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636         if (!StringUtils.isEmpty(securityKrb5Conf)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644     public String toString() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645         return &quot;HbaseOutputFormat kerberos{&quot; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653                 &#x27;}&#x27;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656 }</span>
 657 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658         public HbaseOutputFormatBuilder setBatchSize(Integer batchSize) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659             format.batchSize = batchSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660             return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663         public HbaseOutputFormatBuilder setBatchWaitInterval(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664             format.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665             return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666         }</span>
 667 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 668 
 669         public HbaseOutputFormat finish() {
 670             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 671             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 672             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 673             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 673             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be🔵</abbr>
 674 
 675             String[] families = new String[format.columnNames.length];
 676             String[] qualifiers = new String[format.columnNames.length];
 677 
 678             if (format.columnNameFamily != null) {
 679                 List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());
 680                 String[] columns = keyList.toArray(new String[0]);
 681                 for (int i = 0; i &lt; columns.length; ++i) {
 682                     String col = columns[i];
 683                     String[] part = col.split(&quot;:&quot;);
 684                     families[i] = part[0];
 685                     qualifiers[i] = part[1];
 686                 }
 687             }
 688             format.families = families;
 689             format.qualifiers = qualifiers;
 690 
 691             return format;
 692         }
 693     }
 694 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.sink.hbase;
  22 
  23 import com.dtstack.flink.sql.dirtyManager.manager.DirtyDataManager;
  24 
  25 import com.dtstack.flink.sql.factory.DTThreadFactory;
  26 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  27 import com.google.common.collect.Maps;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.flink.api.java.tuple.Tuple2;
  30 import org.apache.flink.configuration.Configuration;
  31 import org.apache.flink.types.Row;
  32 import org.apache.flink.util.Preconditions;
  33 import org.apache.hadoop.hbase.AuthUtil;
  34 import org.apache.hadoop.hbase.ChoreService;
  35 import org.apache.hadoop.hbase.HBaseConfiguration;
  36 import org.apache.hadoop.hbase.ScheduledChore;
  37 import org.apache.hadoop.hbase.TableName;
  38 import org.apache.hadoop.hbase.client.Connection;
  39 import org.apache.hadoop.hbase.client.ConnectionFactory;
  40 import org.apache.hadoop.hbase.client.Put;
  41 import org.apache.hadoop.hbase.client.Table;
  42 import org.apache.hadoop.security.UserGroupInformation;
  43 import org.slf4j.Logger;
  44 import org.slf4j.LoggerFactory;
  45 
  46 import java.io.File;
  47 import java.io.IOException;
  48 import java.security.PrivilegedAction;
  49 import java.util.ArrayList;
  50 import java.util.LinkedList;
  51 import java.util.List;
  52 import java.util.Map;
  53 import java.util.concurrent.ScheduledExecutorService;
  54 import java.util.concurrent.ScheduledFuture;
  55 import java.util.concurrent.ScheduledThreadPoolExecutor;
  56 import java.util.concurrent.TimeUnit;
  57 
  58 /**
  59  * @author: jingzhen@dtstack.com
  60  * date: 2017-6-29
  61  */
  62 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
  63 
  64     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  65     private String host;
  66     private String zkParent;
  67     private String rowkey;
  68     private String tableName;
  69     private String[] columnNames;
  70     private Map&lt;String, String&gt; columnNameFamily;
  71     private boolean kerberosAuthEnable;
  72     private String regionserverKeytabFile;
  73     private String regionserverPrincipal;
  74     private String securityKrb5Conf;
  75     private String zookeeperSaslClient;
  76     private String clientPrincipal;
  77     private String clientKeytabFile;
  78     private String[] families;
  79     private String[] qualifiers;
  80     private transient org.apache.hadoop.conf.Configuration conf;
  81     private transient Connection conn;
  82     private transient Table table;
  83     private transient ChoreService choreService;
  84 
  85     private DirtyDataManager dirtyDataManager;
  86     private transient List&lt;Row&gt; records;
  87     private transient volatile boolean closed = false;
  88     /**
  89      * 批量写入的参数
  90      */
  91     private Integer batchSize;
  92     private Long batchWaitInterval;
  93     /**
  94      * 定时任务
  95      */
  96     private transient ScheduledExecutorService scheduler;
  97     private transient ScheduledFuture&lt;?&gt; scheduledFuture;
  98 
  99     private HbaseOutputFormat() {
 100     }
 101 
 102     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 103         return new HbaseOutputFormatBuilder();
 104     }
 105 
 106     @Override
 107     public void configure(Configuration parameters) {
 108         // 这里不要做耗时较长的操作，否则会导致AKKA通信超时
 109         // DO NOTHING
 110     }
 111 
 112     @Override
 113     public void open(int taskNumber, int numTasks) throws IOException {
 114         LOG.warn(&quot;---open---&quot;);
 115         records = new ArrayList&lt;&gt;();
 116         conf = HBaseConfiguration.create();
 117         openConn();
 118         table = conn.getTable(TableName.valueOf(tableName));
 119         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 120         initMetric();
 121     }
 122 
 123     private void openConn(){
 124         try{
 125             if (kerberosAuthEnable) {
 126                 LOG.info(&quot;open kerberos conn&quot;);
 127                 openKerberosConn();
 128             } else {
 129                 LOG.info(&quot;open conn&quot;);
 130                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 131                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 132                 conn = ConnectionFactory.createConnection(conf);
 133             }
 134         }catch (Exception e){
 135             throw new RuntimeException(e);
 136         }
 137         initScheduledTask(batchWaitInterval);
 138     }
 139 
 140     /**
 141      * 初始化定时写入任务
 142      *
 143      * @param batchWaitInterval 定时任务时间
 144      */
 145     private void initScheduledTask(Long batchWaitInterval) {
 146         try {
 147             if (batchWaitInterval &gt; 0) {
 148                 this.scheduler = new ScheduledThreadPoolExecutor(
 149                         1,
 150                         new DTThreadFactory(&quot;hbase-batch-flusher&quot;)
 151                 );
 152 
 153                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(
 154                         () -&gt; {
 155                             synchronized (HbaseOutputFormat.this) {
 156                                 if (!records.isEmpty()) {
 157                                     dealBatchOperation(records);
 158                                 }
 159                             }
 160                         }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS
 161                 );
 162             }
 163         } catch (Exception e) {
 164             LOG.error(&quot;init schedule task failed !&quot;);
 165             throw new RuntimeException(e);
 166         }
 167     }
 168 
 169     private void openKerberosConn() throws Exception {
 170         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 171         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 172 
 173         LOG.info(&quot;kerberos config:{}&quot;, this.conf.toString());
 174         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 175         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 175         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;🔵</abbr>
 176 
 177         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 178 
 179         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 180         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 180         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal🔵</abbr>
 181 
 182         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 183         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 184 
<abbr title=" 185         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 185         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinci🔵</abbr>
 186         org.apache.hadoop.conf.Configuration finalConf = conf;
 187         conn = userGroupInformation.doAs((PrivilegedAction&lt;Connection&gt;) () -&gt; {
 188             try {
 189                 ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 190                 if (authChore != null) {
 191                     choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 192                     choreService.scheduleChore(authChore);
 193                 }
 194 
 195                 return ConnectionFactory.createConnection(finalConf);
 196             } catch (IOException e) {
 197                 LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 198                 throw new RuntimeException(e);
 199             }
 200         });
 201     }
 202 
 203     @Override
 204     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) {
 205         if (record.f0) {
 206             if (this.batchSize != 0) {
 207                 writeBatchRecord(record.f1);
 208             } else {
 209                 dealInsert(record.f1);
 210             }
 211         }
 212     }
 213 
 214     public void writeBatchRecord(Row row) {
 215         records.add(row);
 216         // 数据累计到batchSize之后开始处理
 217         if (records.size() == this.batchSize) {
 218             dealBatchOperation(records);
 219         }
 220     }
 221 
 222     protected synchronized void dealBatchOperation(List&lt;Row&gt; records) {
 223         // A null in the result array means that the call for that action failed, even after retries.
 224         Object[] results = new Object[records.size()];
 225         try {
 226             List&lt;Put&gt; puts = new ArrayList&lt;&gt;();
 227             for (Row record : records) {
 228                 puts.add(getPutByRow(record));
 229             }
 230             table.batch(puts, results);
 231 
 232             // 判断数据是否插入成功
 233             for (int i = 0; i &lt; results.length; i++) {
 234                 if (results[i] == null) {
<abbr title=" 235                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 235                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) 🔵</abbr>
 236                         LOG.error(&quot;record insert failed ..{}&quot;, records.get(i).toString());
 237                     }
 238                     // 脏数据记录
 239                     outDirtyRecords.inc();
 240                 } else {
 241                     // 输出结果条数记录
 242                     outRecords.inc();
 243                 }
 244             }
 245             // 打印结果
 246             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 247                 // 只打印最后一条数据
 248                 LOG.info(records.get(records.size() - 1).toString());
 249             }
 250         } catch (IOException | InterruptedException e) {
 251             LOG.error(&quot;&quot;, e);
 252         } finally {
 253             // 添加完数据之后数据清空records
 254             records.clear();
 255         }
 256     }
 257 
 258     protected void dealInsert(Row record) {
 259         Put put = getPutByRow(record);
 260         if (put == null || put.isEmpty()) {
 261             // 记录脏数据
 262             outDirtyRecords.inc();
 263             return;
 264         }
 265 
 266             try {
 267 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268                 table.delete(delete);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269             } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270                 dirtyDataManager.collectDirtyData(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271                         record.toString()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272                         , e.getMessage());</span>
 273 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274                 table.delete(delete);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275             } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276                 if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                     LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                     LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                 outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                 LOG.info(record.toString());</span>
 284 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285             table.put(put);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288                 LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290             }</span>
 291 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 292                 outDirtyRecords.inc();
 293             }
 294 
 295             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 296                 LOG.info(record.toString());
 297             }
 298             outRecords.inc();
 299         }
 300 
 301     private Put getPutByRow(Row record) {
 302         String rowKey = buildRowKey(record);
 303         if (StringUtils.isEmpty(rowKey)) {
 304             return null;
 305         }
 306         Put put = new Put(rowKey.getBytes());
 307         for (int i = 0; i &lt; record.getArity(); ++i) {
 308             Object fieldVal = record.getField(i);
 309             if (fieldVal != null) {
 310                 byte[] val = fieldVal.toString().getBytes();
 311                 byte[] cf = families[i].getBytes();
 312                 byte[] qualifier = qualifiers[i].getBytes();
 313 
 314                 put.addColumn(cf, qualifier, val);
 315             }
 316         }
 317         return put;
 318     }
 319 
 320     private String buildRowKey(Row record) {
 321         String rowKeyValues = getRowKeyValues(record);
 322         // all rowkey not null
 323         if (StringUtils.isBlank(rowKeyValues)) {
 324             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 325             outDirtyRecords.inc();
 326             return &quot;&quot;;
 327         }
 328         return rowKeyValues;
 329     }
 330 
 331     private String getRowKeyValues(Row record) {
 332         Map&lt;String, Object&gt; row = rowConvertMap(record);
 333         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 334         rowKeyBuilder.init(rowkey);
 335         return rowKeyBuilder.getRowKey(row);
 336     }
 337 
 338     private Map&lt;String, Object&gt; rowConvertMap(Row record){
 339         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 340         for(int i = 0; i &lt; columnNames.length; i++){
 341             rowValue.put(columnNames[i], record.getField(i));
 342         }
 343         return rowValue;
 344     }
 345 
 346     @Override
 347     public synchronized void close() throws IOException {
 348         if (closed) {
 349             return;
 350         }
 351 
 352         closed = true;
 353         if (!records.isEmpty()) {
 354             dealBatchOperation(records);
 355         }
 356 
 357         if (scheduledFuture != null) {
 358             scheduledFuture.cancel(false);
 359             if (scheduler != null) {
 360                 scheduler.shutdownNow();
 361             }
 362         }
 363 
 364         if (conn != null) {
 365             conn.close();
 366             conn = null;
 367         }
 368     }
 369 
 370     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config,
 371                                         String regionserverPrincipal,
 372                                         String zookeeperSaslClient,
 373                                         String securityKrb5Conf) {
 374         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 375             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 375             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is🔵</abbr>
 376         }
 377         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 378         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 379         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 380         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 381 
 382 
 383         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 384             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 385         }
 386 
 387         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 388             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 389             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 390             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 391         }
 392     }
 393 
 394     @Override
 395     public String toString() {
 396         return &quot;HbaseOutputFormat kerberos{&quot; +
 397                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 398                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 399                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 400                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 401                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 402                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 403                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 404                 &quot;, batchSize=&#x27;&quot; + batchSize + &#x27;\&#x27;&#x27; +
 405                 &quot;, batchWaitInterval=&#x27;&quot; + batchWaitInterval + &#x27;\&#x27;&#x27; +
 406                 &#x27;}&#x27;;
 407     }
 408 
 409     public static class HbaseOutputFormatBuilder {
 410 
 411         private final HbaseOutputFormat format;
 412 
 413         private HbaseOutputFormatBuilder() {
 414             format = new HbaseOutputFormat();
 415         }
 416 
 417         public HbaseOutputFormatBuilder setHost(String host) {
 418             format.host = host;
 419             return this;
 420         }
 421 
 422         public HbaseOutputFormatBuilder setZkParent(String parent) {
 423             format.zkParent = parent;
 424             return this;
 425         }
 426 
 427 
 428         public HbaseOutputFormatBuilder setTable(String tableName) {
 429             format.tableName = tableName;
 430             return this;
 431         }
 432 
 433         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 434             format.rowkey = rowkey;
 435             return this;
 436         }
 437 
 438         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 439             format.columnNames = columnNames;
 440             return this;
 441         }
 442 
 443         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 444             format.columnNameFamily = columnNameFamily;
 445             return this;
 446         }
 447 
 448         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 449             format.kerberosAuthEnable = kerberosAuthEnable;
 450             return this;
 451         }
 452 
 453         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 454             format.regionserverKeytabFile = regionserverKeytabFile;
 455             return this;
 456         }
 457 
 458         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 459             format.regionserverPrincipal = regionserverPrincipal;
 460             return this;
 461         }
 462 
 463         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 464             format.securityKrb5Conf = securityKrb5Conf;
 465             return this;
 466         }
 467 
 468         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 469             format.zookeeperSaslClient = zookeeperSaslClient;
 470             return this;
 471         }
 472 
 473         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 474             format.clientPrincipal = clientPrincipal;
 475             return this;
 476         }
 477 
 478         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 479             format.clientKeytabFile = clientKeytabFile;
 480             return this;
 481         }
 482 
 483         public HbaseOutputFormatBuilder setDirtyManager(DirtyDataManager dirtyDataManager) {
 484             format.dirtyDataManager = dirtyDataManager;
 485             return this;
 486         }
 487 
 488         public HbaseOutputFormatBuilder setBatchSize(Integer batchSize) {
 489             format.batchSize = batchSize;
 490             return this;
 491         }
 492 
 493         public HbaseOutputFormatBuilder setBatchWaitInterval(Long batchWaitInterval) {
 494             format.batchWaitInterval = batchWaitInterval;
 495             return this;
 496         }
 497 
 498         public HbaseOutputFormat finish() {
 499             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 500             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 501             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 502             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 502             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be🔵</abbr>
 503 
 504             String[] families = new String[format.columnNames.length];
 505             String[] qualifiers = new String[format.columnNames.length];
 506 
 507             if (format.columnNameFamily != null) {
 508                 List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());
 509                 String[] columns = keyList.toArray(new String[0]);
 510                 for (int i = 0; i &lt; columns.length; ++i) {
 511                     String col = columns[i];
 512                     String[] part = col.split(&quot;:&quot;);
 513                     families[i] = part[0];
 514                     qualifiers[i] = part[1];
 515                 }
 516             }
 517             format.families = families;
 518             format.qualifiers = qualifiers;
 519 
 520             return format;
 521         }
 522     }
 523 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.hbase;
  19 
  20 import com.dtstack.flink.sql.dirtyManager.manager.DirtyDataManager;
  21 import com.dtstack.flink.sql.factory.DTThreadFactory;
  22 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  23 import com.google.common.collect.Maps;
  24 import java.io.File;
  25 import java.io.IOException;
  26 import java.security.PrivilegedAction;
  27 import java.util.ArrayList;
  28 import java.util.LinkedList;
  29 import java.util.List;
  30 import java.util.Map;
  31 import java.util.concurrent.ScheduledExecutorService;
  32 import java.util.concurrent.ScheduledFuture;
  33 import java.util.concurrent.ScheduledThreadPoolExecutor;
  34 import java.util.concurrent.TimeUnit;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.apache.flink.api.java.tuple.Tuple2;
  37 import org.apache.flink.configuration.Configuration;
  38 import org.apache.flink.types.Row;
  39 import org.apache.flink.util.Preconditions;
  40 import org.apache.hadoop.hbase.AuthUtil;
  41 import org.apache.hadoop.hbase.ChoreService;
  42 import org.apache.hadoop.hbase.HBaseConfiguration;
  43 import org.apache.hadoop.hbase.ScheduledChore;
  44 import org.apache.hadoop.hbase.TableName;
  45 import org.apache.hadoop.hbase.client.Connection;
  46 import org.apache.hadoop.hbase.client.ConnectionFactory;
  47 import org.apache.hadoop.hbase.client.Put;
  48 import org.apache.hadoop.hbase.client.Table;
  49 import org.apache.hadoop.security.UserGroupInformation;
  50 import org.slf4j.Logger;
  51 import org.slf4j.LoggerFactory;
  52 
  53 
  54 /**
  55  * @author: jingzhen@dtstack.com
  56  * date: 2017-6-29
  57  */
  58 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {
  59 
  60     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  61     private String host;
  62     private String zkParent;
  63     private String rowkey;
  64     private String tableName;
  65     private String[] columnNames;
  66     private Map&lt;String, String&gt; columnNameFamily;
  67     private boolean kerberosAuthEnable;
  68     private String regionserverKeytabFile;
  69     private String regionserverPrincipal;
  70     private String securityKrb5Conf;
  71     private String zookeeperSaslClient;
  72     private String clientPrincipal;
  73     private String clientKeytabFile;
  74     private String[] families;
  75     private String[] qualifiers;
  76     private transient org.apache.hadoop.conf.Configuration conf;
  77     private transient Connection conn;
  78     private transient Table table;
  79     private transient ChoreService choreService;
  80     private transient List&lt;Row&gt; records;
  81     private transient volatile boolean closed = false;
  82     /**
  83      * 批量写入的参数
  84      */
  85     private Integer batchSize;
  86     private Long batchWaitInterval;
  87     /**
  88      * 定时任务
  89      */
  90     private transient ScheduledExecutorService scheduler;
  91     private transient ScheduledFuture&lt;?&gt; scheduledFuture;
  92 
  93     private HbaseOutputFormat() {
  94     }
  95 
  96     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
  97         return new HbaseOutputFormatBuilder();
  98     }
  99 
 100     private DirtyDataManager dirtyDataManager;
 101 
 102     @Override
 103     public void configure(Configuration parameters) {
 104         // 这里不要做耗时较长的操作，否则会导致AKKA通信超时
 105         // DO NOTHING
 106     }
 107 
 108     @Override
 109     public void open(int taskNumber, int numTasks) throws IOException {
 110         LOG.warn(&quot;---open---&quot;);
 111         records = new ArrayList&lt;&gt;();
 112         conf = HBaseConfiguration.create();
 113         openConn();
 114         table = conn.getTable(TableName.valueOf(tableName));
 115         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 116         initMetric();
 117     }
 118 
 119     private void openConn() {
 120         try {
 121             if (kerberosAuthEnable) {
 122                 LOG.info(&quot;open kerberos conn&quot;);
 123                 openKerberosConn();
 124             } else {
 125                 LOG.info(&quot;open conn&quot;);
 126                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 127                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 128                 conn = ConnectionFactory.createConnection(conf);
 129             }
 130         } catch (Exception e) {
 131             throw new RuntimeException(e);
 132         }
 133         initScheduledTask(batchWaitInterval);
 134     }
 135 
 136     /**
 137      * 初始化定时写入任务
 138      *
 139      * @param batchWaitInterval 定时任务时间
 140      */
 141     private void initScheduledTask(Long batchWaitInterval) {
 142         try {
 143             if (batchWaitInterval &gt; 0) {
 144                 this.scheduler = new ScheduledThreadPoolExecutor(
 145                         1,
 146                         new DTThreadFactory(&quot;hbase-batch-flusher&quot;)
 147                 );
 148 
 149                 this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(
 150                         () -&gt; {
 151                             synchronized (HbaseOutputFormat.this) {
 152                                 if (!records.isEmpty()) {
 153                                     dealBatchOperation(records);
 154                                 }
 155                             }
 156                         }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS
 157                 );
 158             }
 159         } catch (Exception e) {
 160             LOG.error(&quot;init schedule task failed !&quot;);
 161             throw new RuntimeException(e);
 162         }
 163     }
 164 
 165     private void openKerberosConn() throws Exception {
 166         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 167         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 168 
 169         LOG.info(&quot;kerberos config:{}&quot;, this.conf.toString());
 170         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 171         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 171         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;🔵</abbr>
 172 
 173         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 174 
 175         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 176         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 176         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal🔵</abbr>
 177 
 178         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 179         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 180 
<abbr title=" 181         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 181         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinci🔵</abbr>
 182         org.apache.hadoop.conf.Configuration finalConf = conf;
 183         conn = userGroupInformation.doAs((PrivilegedAction&lt;Connection&gt;) () -&gt; {
 184             try {
 185                 ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 186                 if (authChore != null) {
 187                     choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 188                     choreService.scheduleChore(authChore);
 189                 }
 190 
 191                 return ConnectionFactory.createConnection(finalConf);
 192             } catch (IOException e) {
 193                 LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 194                 throw new RuntimeException(e);
 195             }
 196         });
 197     }
 198 
 199     @Override
 200     public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) {
 201         if (record.f0) {
 202             if (this.batchSize != 0) {
 203                 writeBatchRecord(record.f1);
 204             } else {
 205                 dealInsert(record.f1);
 206             }
 207         }
 208     }
 209 
 210     public void writeBatchRecord(Row row) {
 211         records.add(row);
 212         // 数据累计到batchSize之后开始处理
 213         if (records.size() == this.batchSize) {
 214             dealBatchOperation(records);
 215         }
 216     }
 217 
 218     protected synchronized void dealBatchOperation(List&lt;Row&gt; records) {
 219         // A null in the result array means that the call for that action failed, even after retries.
 220         Object[] results = new Object[records.size()];
 221         try {
 222             List&lt;Put&gt; puts = new ArrayList&lt;&gt;();
 223             for (Row record : records) {
 224                 puts.add(getPutByRow(record));
 225             }
 226             table.batch(puts, results);
 227 
 228             // 判断数据是否插入成功
 229             for (int i = 0; i &lt; results.length; i++) {
 230                 if (results[i] == null) {
<abbr title=" 231                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {"> 231                     if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) 🔵</abbr>
 232                         LOG.error(&quot;record insert failed ..{}&quot;, records.get(i).toString());
 233                     }
 234                     // 脏数据记录
 235                     outDirtyRecords.inc();
 236                 } else {
 237                     // 输出结果条数记录
 238                     outRecords.inc();
 239                 }
 240             }
 241             // 打印结果
 242             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 243                 // 只打印最后一条数据
 244                 LOG.info(records.get(records.size() - 1).toString());
 245             }
 246         } catch (IOException | InterruptedException e) {
 247             LOG.error(&quot;&quot;, e);
 248         } finally {
 249             // 添加完数据之后数据清空records
 250             records.clear();
 251         }
 252     }
 253 
 254     protected void dealInsert(Row record) {
 255         Put put = getPutByRow(record);
 256         if (put == null || put.isEmpty()) {
 257             // 记录脏数据
 258             outDirtyRecords.inc();
 259             return;
 260         }
 261 
 262         try {
 263             table.put(put);
 264         } catch (Exception e) {
 265             dirtyDataManager.collectDirtyData(
 266                     record.toString()
 267                     , e.getMessage());
 268             outDirtyRecords.inc();
 269         }
 270 
 271         if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 272             LOG.info(record.toString());
 273         }
 274         outRecords.inc();
 275     }
 276 
 277 
 278 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     protected void dealDelete(Row record) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280         String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281         if (!StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282             Delete delete = new Delete(Bytes.toBytes(rowKey));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284                 table.delete(delete);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285             } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286                 dirtyDataManager.collectDirtyData(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287                         record.toString()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288                         , e.getMessage());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289                 outDirtyRecords.inc();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292                 LOG.info(record.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294             outRecords.inc();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298 </span>
 299 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 300 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 300 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 301 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 </span>
 304 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 305     private Put getPutByRow(Row record) {
 306         String rowKey = buildRowKey(record);
 307         if (StringUtils.isEmpty(rowKey)) {
 308             return null;
 309         }
 310         Put put = new Put(rowKey.getBytes());
 311         for (int i = 0; i &lt; record.getArity(); ++i) {
 312             Object fieldVal = record.getField(i);
 313             if (fieldVal != null) {
 314                 byte[] val = fieldVal.toString().getBytes();
 315                 byte[] cf = families[i].getBytes();
 316                 byte[] qualifier = qualifiers[i].getBytes();
 317 
 318                 put.addColumn(cf, qualifier, val);
 319             }
 320         }
 321         return put;
 322     }
 323 
 324     private String buildRowKey(Row record) {
 325         String rowKeyValues = getRowKeyValues(record);
 326         // all rowkey not null
 327         if (StringUtils.isBlank(rowKeyValues)) {
 328             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 329             outDirtyRecords.inc();
 330             return &quot;&quot;;
 331         }
 332         return rowKeyValues;
 333     }
 334 
 335     private String getRowKeyValues(Row record) {
 336         Map&lt;String, Object&gt; row = rowConvertMap(record);
 337         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 338         rowKeyBuilder.init(rowkey);
 339         return rowKeyBuilder.getRowKey(row);
 340     }
 341 
 342     private Map&lt;String, Object&gt; rowConvertMap(Row record) {
 343         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 344         for (int i = 0; i &lt; columnNames.length; i++) {
 345             rowValue.put(columnNames[i], record.getField(i));
 346         }
 347         return rowValue;
 348     }
 349 
 350     @Override
 351     public synchronized void close() throws IOException {
 352         if (closed) {
 353             return;
 354         }
 355 
 356         closed = true;
 357         if (!records.isEmpty()) {
 358             dealBatchOperation(records);
 359         }
 360 
 361         if (scheduledFuture != null) {
 362             scheduledFuture.cancel(false);
 363             if (scheduler != null) {
 364                 scheduler.shutdownNow();
 365             }
 366         }
 367 
 368         if (conn != null) {
 369             conn.close();
 370             conn = null;
 371         }
 372     }
 373 
 374     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config,
 375                                         String regionserverPrincipal,
 376                                         String zookeeperSaslClient,
 377                                         String securityKrb5Conf) {
 378         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 379             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 379             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is🔵</abbr>
 380         }
 381         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 382         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 383         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 384         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 385 
 386 
 387         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 388             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 389         }
 390 
 391         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 392             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 393             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 394             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 395         }
 396     }
 397 
 398     @Override
 399     public String toString() {
 400         return &quot;HbaseOutputFormat kerberos{&quot; +
 401                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 402                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 403                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 404                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 405                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 406                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 407                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 408                 &quot;, batchSize=&#x27;&quot; + batchSize + &#x27;\&#x27;&#x27; +
 409                 &quot;, batchWaitInterval=&#x27;&quot; + batchWaitInterval + &#x27;\&#x27;&#x27; +
 410                 &#x27;}&#x27;;
 411     }
 412 
 413     public static class HbaseOutputFormatBuilder {
 414 
 415         private final HbaseOutputFormat format;
 416 
 417         private HbaseOutputFormatBuilder() {
 418             format = new HbaseOutputFormat();
 419         }
 420 
 421         public HbaseOutputFormatBuilder setHost(String host) {
 422             format.host = host;
 423             return this;
 424         }
 425 
 426         public HbaseOutputFormatBuilder setZkParent(String parent) {
 427             format.zkParent = parent;
 428             return this;
 429         }
 430 
 431 
 432         public HbaseOutputFormatBuilder setTable(String tableName) {
 433             format.tableName = tableName;
 434             return this;
 435         }
 436 
 437         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 438             format.rowkey = rowkey;
 439             return this;
 440         }
 441 
 442         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 443             format.columnNames = columnNames;
 444             return this;
 445         }
 446 
 447         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 448             format.columnNameFamily = columnNameFamily;
 449             return this;
 450         }
 451 
 452         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 453             format.kerberosAuthEnable = kerberosAuthEnable;
 454             return this;
 455         }
 456 
 457         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 458             format.regionserverKeytabFile = regionserverKeytabFile;
 459             return this;
 460         }
 461 
 462         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 463             format.regionserverPrincipal = regionserverPrincipal;
 464             return this;
 465         }
 466 
 467         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 468             format.securityKrb5Conf = securityKrb5Conf;
 469             return this;
 470         }
 471 
 472         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 473             format.zookeeperSaslClient = zookeeperSaslClient;
 474             return this;
 475         }
 476 
 477         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 478             format.clientPrincipal = clientPrincipal;
 479             return this;
 480         }
 481 
 482         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 483             format.clientKeytabFile = clientKeytabFile;
 484             return this;
 485         }
 486 
 487 
 488 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 489         public HbaseOutputFormatBuilder setDirtyManager(DirtyDataManager dirtyDataManager) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 490             format.dirtyDataManager = dirtyDataManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 491             return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 492         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 493 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 494 </span>
 495 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 496 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 496 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 497 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499         public HbaseOutputFormatBuilder setBatchSize(Integer batchSize) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500             format.batchSize = batchSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501             return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         public HbaseOutputFormatBuilder setBatchWaitInterval(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505             format.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506             return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508 </span>
 509 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 510 
 511         public HbaseOutputFormat finish() {
 512             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 513             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 514             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 515             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 515             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be🔵</abbr>
 516 
 517             String[] families = new String[format.columnNames.length];
 518             String[] qualifiers = new String[format.columnNames.length];
 519 
 520             if (format.columnNameFamily != null) {
 521                 List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());
 522                 String[] columns = keyList.toArray(new String[0]);
 523                 for (int i = 0; i &lt; columns.length; ++i) {
 524                     String col = columns[i];
 525                     String[] part = col.split(&quot;:&quot;);
 526                     families[i] = part[0];
 527                     qualifiers[i] = part[1];
 528                 }
 529             }
 530             format.families = families;
 531             format.qualifiers = qualifiers;
 532 
 533             return format;
 534         }
 535     }
 536 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.sink.hbase;
  22  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.dirtyManager.manager.DirtyDataManager;</span>
  24  import com.dtstack.flink.sql.enums.EUpdateMode;

  25  import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  26  import com.google.common.collect.Maps;
  27  import org.apache.commons.lang3.StringUtils;
  28  import org.apache.flink.api.java.tuple.Tuple2;
  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.types.Row;
  31  import org.apache.flink.util.Preconditions;
  32  import org.apache.hadoop.hbase.AuthUtil;
  33  import org.apache.hadoop.hbase.ChoreService;
  34  import org.apache.hadoop.hbase.HBaseConfiguration;
  35  import org.apache.hadoop.hbase.ScheduledChore;
  36  import org.apache.hadoop.hbase.TableName;
  37  import org.apache.hadoop.hbase.client.Connection;
  38  import org.apache.hadoop.hbase.client.ConnectionFactory;
  39  import org.apache.hadoop.hbase.client.Delete;
  40  import org.apache.hadoop.hbase.client.Put;
  41  import org.apache.hadoop.hbase.client.Table;
  42  import org.apache.hadoop.hbase.util.Bytes;
  43  import org.apache.hadoop.security.UserGroupInformation;
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  
  47  import java.io.File;
  48  import java.io.IOException;
  49  import java.security.PrivilegedAction;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.LinkedHashMap;</span>

  51  import java.util.LinkedList;
  52  import java.util.List;
  53  import java.util.Map;




  54  
  55  /**
  56   * @author: jingzhen@dtstack.com
  57   * date: 2017-6-29
  58   */
  59  public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {

  60  
  61      private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  62  
  63      private String host;
  64      private String zkParent;
  65      private String rowkey;
  66      private String tableName;
  67      private String[] columnNames;
  68      private String updateMode;
  69      private String[] columnTypes;
  70      private Map&lt;String, String&gt; columnNameFamily;
  71  
  72      private boolean kerberosAuthEnable;
  73      private String regionserverKeytabFile;
  74      private String regionserverPrincipal;
  75      private String securityKrb5Conf;
  76      private String zookeeperSaslClient;
  77      private String clientPrincipal;
  78      private String clientKeytabFile;
  79  
  80      private String[] families;
  81      private String[] qualifiers;
  82  
  83      private transient org.apache.hadoop.conf.Configuration conf;
  84      private transient Connection conn;
  85      private transient Table table;
  86  
  87      private transient ChoreService choreService;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +    private DirtyDataManager dirtyDataManager;</span>

















  90  
  91      @Override
  92      public void configure(Configuration parameters) {
  93          LOG.warn(&quot;---configure---&quot;);
  94          conf = HBaseConfiguration.create();


  95      }
  96  
  97      @Override
  98      public void open(int taskNumber, int numTasks) throws IOException {
  99          LOG.warn(&quot;---open---&quot;);


 100          openConn();
 101          table = conn.getTable(TableName.valueOf(tableName));
 102          LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 103          initMetric();
 104      }
 105  
 106      private void openConn(){
 107          try{


 108              if (kerberosAuthEnable) {
 109                  LOG.info(&quot;open kerberos conn&quot;);
 110                  openKerberosConn();
 111              } else {
 112                  LOG.info(&quot;open conn&quot;);
 113                  conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 114                  conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 115                  conn = ConnectionFactory.createConnection(conf);
 116              }
 117          }catch (Exception e){

 118              throw new RuntimeException(e);
 119          }
 120  
 121      }
































 122      private void openKerberosConn() throws Exception {
 123          conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 124          conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 125  
 126          LOG.info(&quot;kerberos config:{}&quot;, this.toString());

 127          Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
 128          Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);
 129  
 130          fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 131  
 132          clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
 133          clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;
 134  
 135          conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 136          conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 137  
<abbr title=" 138          UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 138          UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clie🔵</abbr>
 139          org.apache.hadoop.conf.Configuration finalConf = conf;
 140          conn = userGroupInformation.doAs((PrivilegedAction&lt;Connection&gt;) () -&gt; {
 141              try {
 142                  ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 143                  if (authChore != null) {
 144                      choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 145                      choreService.scheduleChore(authChore);
 146                  }
 147  
 148                  return ConnectionFactory.createConnection(finalConf);
 149              } catch (IOException e) {
 150                  LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 151                  throw new RuntimeException(e);
 152              }
 153          });
 154      }
 155  
 156  
 157  
 158      @Override
 159      public void writeRecord(Tuple2 tuple2) {
 160          Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 161          Boolean retract = tupleTrans.f0;
 162          Row row = tupleTrans.f1;
 163          if (retract) {
 164              dealInsert(row);
 165          } else if (!retract &amp;&amp; StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {
 166              dealDelete(row);



















































 167          }
 168      }
 169  
 170      protected void dealInsert(Row record) {
 171          Put put = getPutByRow(record);
 172          if (put == null || put.isEmpty()) {

 173              outDirtyRecords.inc();
 174              return;
 175          }
 176  
 177          try {
 178              table.put(put);
 179          } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -            if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +            dirtyDataManager.collectDirtyData(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                    record.toString()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                    , e.getMessage());</span>
 187              outDirtyRecords.inc();
 188          }
 189  
 190          if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 191              LOG.info(record.toString());
 192          }
 193          outRecords.inc();
 194      }
 195  
 196      protected void dealDelete(Row record) {
 197          String rowKey = buildRowKey(record);
 198          if (!StringUtils.isEmpty(rowKey)) {
 199              Delete delete = new Delete(Bytes.toBytes(rowKey));
 200              try {
 201                  table.delete(delete);
 202              } catch (IOException e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                    LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                    LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +                dirtyDataManager.collectDirtyData(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +                        record.toString()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                        , e.getMessage());</span>
 210                  outDirtyRecords.inc();
 211              }
 212              if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 213                  LOG.info(record.toString());
 214              }
 215              outRecords.inc();
 216          }
 217      }
 218  
 219      private Put getPutByRow(Row record) {
 220          String rowKey = buildRowKey(record);
 221          if (StringUtils.isEmpty(rowKey)) {
 222              return null;
 223          }
 224          Put put = new Put(rowKey.getBytes());
 225          for (int i = 0; i &lt; record.getArity(); ++i) {
 226              Object fieldVal = record.getField(i);
 227              if (fieldVal != null) {
 228                  byte[] val = fieldVal.toString().getBytes();
 229                  byte[] cf = families[i].getBytes();
 230                  byte[] qualifier = qualifiers[i].getBytes();
 231  
 232                  put.addColumn(cf, qualifier, val);
 233              }
 234          }
 235          return put;
 236      }
 237  
 238      private String buildRowKey(Row record) {
 239          String rowKeyValues = getRowKeyValues(record);
 240          // all rowkey not null
 241          if (StringUtils.isBlank(rowKeyValues)) {
 242              LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 243              outDirtyRecords.inc();
 244              return &quot;&quot;;
 245          }
 246          return rowKeyValues;
 247      }
 248  
 249      private String getRowKeyValues(Row record) {
 250          Map&lt;String, Object&gt; row = rowConvertMap(record);
 251          RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 252          rowKeyBuilder.init(rowkey);
 253          return rowKeyBuilder.getRowKey(row);
 254      }
 255  
 256      private Map&lt;String, Object&gt; rowConvertMap(Row record){

 257          Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 258          for(int i = 0; i &lt; columnNames.length; i++){

 259              rowValue.put(columnNames[i], record.getField(i));
 260          }
 261          return rowValue;
 262      }
 263  
 264      @Override
 265      public void close() throws IOException {

















 266          if (conn != null) {
 267              conn.close();
 268              conn = null;
 269          }
 270      }
 271      private HbaseOutputFormat() {
 272      }
 273  
 274      public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 275          return new HbaseOutputFormatBuilder();
 276      }
 277  
 278      public static class HbaseOutputFormatBuilder {
 279  
 280          private HbaseOutputFormat format;
 281  
 282          private HbaseOutputFormatBuilder() {
 283              format = new HbaseOutputFormat();
 284          }
 285  
 286          public HbaseOutputFormatBuilder setHost(String host) {
 287              format.host = host;
 288              return this;
 289          }
 290  
 291          public HbaseOutputFormatBuilder setZkParent(String parent) {
 292              format.zkParent = parent;
 293              return this;
 294          }
 295  
 296  
 297          public HbaseOutputFormatBuilder setTable(String tableName) {
 298              format.tableName = tableName;
 299              return this;
 300          }
 301  
 302          public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 303              format.rowkey = rowkey;
 304              return this;
 305          }
 306  
 307          public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 308              format.columnNames = columnNames;
 309              return this;
 310          }
 311  
 312          public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 313              format.columnTypes = columnTypes;
 314              return this;
 315          }
 316  
 317          public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 318              format.columnNameFamily = columnNameFamily;
 319              return this;
 320          }
 321  
 322          public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 323              format.kerberosAuthEnable = kerberosAuthEnable;
 324              return this;
 325          }
 326  
 327          public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 328              format.regionserverKeytabFile = regionserverKeytabFile;
 329              return this;
 330          }
 331  
 332          public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 333              format.regionserverPrincipal = regionserverPrincipal;
 334              return this;
 335          }
 336  
 337          public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 338              format.securityKrb5Conf = securityKrb5Conf;
 339              return this;
 340          }
 341  
 342          public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 343              format.zookeeperSaslClient = zookeeperSaslClient;
 344              return this;
 345          }
 346  
 347          public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 348              format.clientPrincipal = clientPrincipal;
 349              return this;
 350          }
 351  
 352          public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 353              format.clientKeytabFile = clientKeytabFile;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        public HbaseOutputFormatBuilder setDirtyManager(DirtyDataManager dirtyDataManager) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            format.dirtyDataManager = dirtyDataManager;</span>
 359              return this;
 360          }
 361  
 362  
 363          public HbaseOutputFormat finish() {
 364              Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 365              Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 366              Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
 367              Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);
 368  
 369              String[] families = new String[format.columnNames.length];
 370              String[] qualifiers = new String[format.columnNames.length];
 371  
 372              if (format.columnNameFamily != null) {
 373                  List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());
 374                  String[] columns = keyList.toArray(new String[0]);
 375                  for (int i = 0; i &lt; columns.length; ++i) {
 376                      String col = columns[i];
 377                      String[] part = col.split(&quot;:&quot;);
 378                      families[i] = part[0];
 379                      qualifiers[i] = part[1];
 380                  }
 381              }
 382              format.families = families;
 383              format.qualifiers = qualifiers;
 384  
 385              return format;
 386          }
 387  
 388      }
 389  
 390      private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,
 391                                          String zookeeperSaslClient, String securityKrb5Conf) throws IOException {





 392          if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 393              throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 393              throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos🔵</abbr>
 394          }
 395          config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 396          config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 397          config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 398          config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 399  
 400  
 401          if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 402              System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 403          }
 404  
 405          if (!StringUtils.isEmpty(securityKrb5Conf)) {
 406              String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 407              LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 408              System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 409          }
 410      }
 411  
 412      @Override
 413      public String toString() {
 414          return &quot;HbaseOutputFormat kerberos{&quot; +
 415                  &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 416                  &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 417                  &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 418                  &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 419                  &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 420                  &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 421                  &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +


 422                  &#x27;}&#x27;;
 423      }
 424  













































































































 425  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
  21  package com.dtstack.flink.sql.sink.hbase;
  22  

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.factory.DTThreadFactory;</span>
  25  import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  26  import com.google.common.collect.Maps;
  27  import org.apache.commons.lang3.StringUtils;
  28  import org.apache.flink.api.java.tuple.Tuple2;
  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.types.Row;
  31  import org.apache.flink.util.Preconditions;
  32  import org.apache.hadoop.hbase.AuthUtil;
  33  import org.apache.hadoop.hbase.ChoreService;
  34  import org.apache.hadoop.hbase.HBaseConfiguration;
  35  import org.apache.hadoop.hbase.ScheduledChore;
  36  import org.apache.hadoop.hbase.TableName;
  37  import org.apache.hadoop.hbase.client.Connection;
  38  import org.apache.hadoop.hbase.client.ConnectionFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.hadoop.hbase.client.Delete;</span>
  40  import org.apache.hadoop.hbase.client.Put;
  41  import org.apache.hadoop.hbase.client.Table;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.apache.hadoop.hbase.util.Bytes;</span>
  43  import org.apache.hadoop.security.UserGroupInformation;
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  
  47  import java.io.File;
  48  import java.io.IOException;
  49  import java.security.PrivilegedAction;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.LinkedHashMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import java.util.ArrayList;</span>
  52  import java.util.LinkedList;
  53  import java.util.List;
  54  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import java.util.concurrent.ScheduledExecutorService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import java.util.concurrent.ScheduledFuture;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +import java.util.concurrent.TimeUnit;</span>
  59  
  60  /**
  61   * @author: jingzhen@dtstack.com
  62   * date: 2017-6-29
  63   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&lt;Boolean, Row&gt;&gt; {</span>
  66  
  67      private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
  69      private String host;
  70      private String zkParent;
  71      private String rowkey;
  72      private String tableName;
  73      private String[] columnNames;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    private String updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    private String[] columnTypes;</span>
  76      private Map&lt;String, String&gt; columnNameFamily;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
  78      private boolean kerberosAuthEnable;
  79      private String regionserverKeytabFile;
  80      private String regionserverPrincipal;
  81      private String securityKrb5Conf;
  82      private String zookeeperSaslClient;
  83      private String clientPrincipal;
  84      private String clientKeytabFile;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
  86      private String[] families;
  87      private String[] qualifiers;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -</span>
  89      private transient org.apache.hadoop.conf.Configuration conf;
  90      private transient Connection conn;
  91      private transient Table table;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -</span>
  93      private transient ChoreService choreService;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    private transient List&lt;Row&gt; records;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +    private transient volatile boolean closed = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +     * 批量写入的参数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    private Integer batchSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    private Long batchWaitInterval;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +     * 定时任务</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +    private transient ScheduledExecutorService scheduler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    private transient ScheduledFuture&lt;?&gt; scheduledFuture;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +    private HbaseOutputFormat() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +    public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        return new HbaseOutputFormatBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    }</span>
 113  
 114      @Override
 115      public void configure(Configuration parameters) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        LOG.warn(&quot;---configure---&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        conf = HBaseConfiguration.create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        // 这里不要做耗时较长的操作，否则会导致AKKA通信超时</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        // DO NOTHING</span>
 120      }
 121  
 122      @Override
 123      public void open(int taskNumber, int numTasks) throws IOException {
 124          LOG.warn(&quot;---open---&quot;);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        records = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        conf = HBaseConfiguration.create();</span>
 127          openConn();
 128          table = conn.getTable(TableName.valueOf(tableName));
 129          LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 130          initMetric();
 131      }
 132  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    private void openConn(){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        try{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    private void openConn() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        try {</span>
 137              if (kerberosAuthEnable) {
 138                  LOG.info(&quot;open kerberos conn&quot;);
 139                  openKerberosConn();
 140              } else {
 141                  LOG.info(&quot;open conn&quot;);
 142                  conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 143                  conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 144                  conn = ConnectionFactory.createConnection(conf);
 145              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }catch (Exception e){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        } catch (Exception e) {</span>
 148              throw new RuntimeException(e);
 149          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        initScheduledTask(batchWaitInterval);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +     * 初始化定时写入任务</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +     * @param batchWaitInterval 定时任务时间</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +    private void initScheduledTask(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +            if (batchWaitInterval &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                this.scheduler = new ScheduledThreadPoolExecutor(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                        1,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                        new DTThreadFactory(&quot;hbase-batch-flusher&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                        () -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                            synchronized (HbaseOutputFormat.this) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                                if (!records.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                                    dealBatchOperation(records);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                        }, batchWaitInterval, batchWaitInterval, TimeUnit.MILLISECONDS</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +            LOG.error(&quot;init schedule task failed !&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +            throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +</span>
 184      private void openKerberosConn() throws Exception {
 185          conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 186          conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 187  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -        LOG.info(&quot;kerberos config:{}&quot;, this.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        LOG.info(&quot;kerberos config:{}&quot;, this.conf.toString());</span>
 190          Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
 191          Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);
 192  
 193          fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 194  
 195          clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
 196          clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;
 197  
 198          conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 199          conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 200  
<abbr title=" 201          UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 201          UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clie🔵</abbr>
 202          org.apache.hadoop.conf.Configuration finalConf = conf;
 203          conn = userGroupInformation.doAs((PrivilegedAction&lt;Connection&gt;) () -&gt; {
 204              try {
 205                  ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 206                  if (authChore != null) {
 207                      choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 208                      choreService.scheduleChore(authChore);
 209                  }
 210  
 211                  return ConnectionFactory.createConnection(finalConf);
 212              } catch (IOException e) {
 213                  LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 214                  throw new RuntimeException(e);
 215              }
 216          });
 217      }
 218  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
 221      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -    public void writeRecord(Tuple2 tuple2) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        Boolean retract = tupleTrans.f0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -        Row row = tupleTrans.f1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -        if (retract) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -            dealInsert(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        } else if (!retract &amp;&amp; StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -            dealDelete(row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +    public void writeRecord(Tuple2&lt;Boolean, Row&gt; record) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        if (record.f0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +            if (this.batchSize != 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                writeBatchRecord(record.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                dealInsert(record.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +    public void writeBatchRecord(Row row) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        records.add(row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        // 数据累计到batchSize之后开始处理</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        if (records.size() == this.batchSize) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +            dealBatchOperation(records);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +    protected synchronized void dealBatchOperation(List&lt;Row&gt; records) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +        // A null in the result array means that the call for that action failed, even after retries.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        Object[] results = new Object[records.size()];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            List&lt;Put&gt; puts = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +            for (Row record : records) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                puts.add(getPutByRow(record));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +            table.batch(puts, results);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +            // 判断数据是否插入成功</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +            for (int i = 0; i &lt; results.length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +                if (results[i] == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                    if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                        LOG.error(&quot;record insert failed ..{}&quot;, records.get(i).toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +                    // 脏数据记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +                    outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +                    // 输出结果条数记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +                    outRecords.inc();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +            // 打印结果</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +            if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                // 只打印最后一条数据</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                LOG.info(records.get(records.size() - 1).toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        } catch (IOException | InterruptedException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +            LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +        } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +            // 添加完数据之后数据清空records</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +            records.clear();</span>
 281          }
 282      }
 283  
 284      protected void dealInsert(Row record) {
 285          Put put = getPutByRow(record);
 286          if (put == null || put.isEmpty()) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +            // 记录脏数据</span>
 288              outDirtyRecords.inc();
 289              return;
 290          }
 291  
 292          try {
 293              table.put(put);
 294          } catch (Exception e) {
 295              if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 296                  LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 297                  LOG.error(&quot;&quot;, e);
 298              }



 299              outDirtyRecords.inc();
 300          }
 301  
 302          if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 303              LOG.info(record.toString());
 304          }
 305          outRecords.inc();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -    protected void dealDelete(Row record) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -        if (!StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -            Delete delete = new Delete(Bytes.toBytes(rowKey));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -                table.delete(delete);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -            } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -                if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -                    LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -                    LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -                }</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -                outDirtyRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -            if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -                LOG.info(record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -            outRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -        }</span>
 326      }
 327  
 328      private Put getPutByRow(Row record) {
 329          String rowKey = buildRowKey(record);
 330          if (StringUtils.isEmpty(rowKey)) {
 331              return null;
 332          }
 333          Put put = new Put(rowKey.getBytes());
 334          for (int i = 0; i &lt; record.getArity(); ++i) {
 335              Object fieldVal = record.getField(i);
 336              if (fieldVal != null) {
 337                  byte[] val = fieldVal.toString().getBytes();
 338                  byte[] cf = families[i].getBytes();
 339                  byte[] qualifier = qualifiers[i].getBytes();
 340  
 341                  put.addColumn(cf, qualifier, val);
 342              }
 343          }
 344          return put;
 345      }
 346  
 347      private String buildRowKey(Row record) {
 348          String rowKeyValues = getRowKeyValues(record);
 349          // all rowkey not null
 350          if (StringUtils.isBlank(rowKeyValues)) {
 351              LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 352              outDirtyRecords.inc();
 353              return &quot;&quot;;
 354          }
 355          return rowKeyValues;
 356      }
 357  
 358      private String getRowKeyValues(Row record) {
 359          Map&lt;String, Object&gt; row = rowConvertMap(record);
 360          RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 361          rowKeyBuilder.init(rowkey);
 362          return rowKeyBuilder.getRowKey(row);
 363      }
 364  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -    private Map&lt;String, Object&gt; rowConvertMap(Row record){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +    private Map&lt;String, Object&gt; rowConvertMap(Row record) {</span>
 367          Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -        for(int i = 0; i &lt; columnNames.length; i++){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        for (int i = 0; i &lt; columnNames.length; i++) {</span>
 370              rowValue.put(columnNames[i], record.getField(i));
 371          }
 372          return rowValue;
 373      }
 374  
 375      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -    public void close() throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +    public synchronized void close() throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        if (closed) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +        closed = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +        if (!records.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +            dealBatchOperation(records);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +        if (scheduledFuture != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +            scheduledFuture.cancel(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +            if (scheduler != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                scheduler.shutdownNow();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +</span>
 394          if (conn != null) {
 395              conn.close();
 396              conn = null;
 397          }
 398      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -    private HbaseOutputFormat() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -    public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -        return new HbaseOutputFormatBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -    public static class HbaseOutputFormatBuilder {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -        private HbaseOutputFormat format;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        private HbaseOutputFormatBuilder() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -            format = new HbaseOutputFormat();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -        public HbaseOutputFormatBuilder setHost(String host) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -            format.host = host;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -        public HbaseOutputFormatBuilder setZkParent(String parent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -            format.zkParent = parent;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -        public HbaseOutputFormatBuilder setTable(String tableName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -            format.tableName = tableName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -        public HbaseOutputFormatBuilder setRowkey(String rowkey) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -            format.rowkey = rowkey;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -        public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -            format.columnNames = columnNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -        public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -            format.columnTypes = columnTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -        public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -            format.columnNameFamily = columnNameFamily;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -        public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -            format.kerberosAuthEnable = kerberosAuthEnable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -        public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -            format.regionserverKeytabFile = regionserverKeytabFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -        public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -            format.regionserverPrincipal = regionserverPrincipal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -        public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -            format.securityKrb5Conf = securityKrb5Conf;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -        public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -            format.zookeeperSaslClient = zookeeperSaslClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -            format.clientPrincipal = clientPrincipal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -        public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -            format.clientKeytabFile = clientKeytabFile;</span>





<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -        public HbaseOutputFormat finish() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -            Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -            Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -            Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -            Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -            String[] families = new String[format.columnNames.length];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -            String[] qualifiers = new String[format.columnNames.length];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -            if (format.columnNameFamily != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -                List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -                String[] columns = keyList.toArray(new String[0]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -                for (int i = 0; i &lt; columns.length; ++i) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -                    String col = columns[i];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -                    String[] part = col.split(&quot;:&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -                    families[i] = part[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -                    qualifiers[i] = part[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -            format.families = families;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -            format.qualifiers = qualifiers;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -            return format;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -    private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -                                        String zookeeperSaslClient, String securityKrb5Conf) throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +    private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +                                        String regionserverPrincipal,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +                                        String zookeeperSaslClient,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +                                        String securityKrb5Conf) {</span>
 520          if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 521              throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 521              throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos🔵</abbr>
 522          }
 523          config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 524          config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 525          config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 526          config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 527  
 528  
 529          if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 530              System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 531          }
 532  
 533          if (!StringUtils.isEmpty(securityKrb5Conf)) {
 534              String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 535              LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 536              System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 537          }
 538      }
 539  
 540      @Override
 541      public String toString() {
 542          return &quot;HbaseOutputFormat kerberos{&quot; +
 543                  &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 544                  &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 545                  &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 546                  &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 547                  &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 548                  &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 549                  &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 550 +                &quot;, batchSize=&#x27;&quot; + batchSize + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +                &quot;, batchWaitInterval=&#x27;&quot; + batchWaitInterval + &#x27;\&#x27;&#x27; +</span>
 552                  &#x27;}&#x27;;
 553      }
 554  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +    public static class HbaseOutputFormatBuilder {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 556 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +        private final HbaseOutputFormat format;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 558 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 559 +        private HbaseOutputFormatBuilder() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +            format = new HbaseOutputFormat();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 563 +        public HbaseOutputFormatBuilder setHost(String host) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 564 +            format.host = host;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 565 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 566 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 567 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 568 +        public HbaseOutputFormatBuilder setZkParent(String parent) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 569 +            format.zkParent = parent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 570 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 571 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 572 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 573 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 574 +        public HbaseOutputFormatBuilder setTable(String tableName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 575 +            format.tableName = tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 576 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 577 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 578 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 579 +        public HbaseOutputFormatBuilder setRowkey(String rowkey) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 580 +            format.rowkey = rowkey;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 582 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 583 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 584 +        public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 585 +            format.columnNames = columnNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 586 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 587 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 588 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 589 +        public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 590 +            format.columnNameFamily = columnNameFamily;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 591 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 592 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 593 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 594 +        public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 595 +            format.kerberosAuthEnable = kerberosAuthEnable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 597 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +        public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +            format.regionserverKeytabFile = regionserverKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 603 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 604 +        public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +            format.regionserverPrincipal = regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 606 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 607 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 608 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 609 +        public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 610 +            format.securityKrb5Conf = securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 611 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 612 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 613 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 614 +        public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 615 +            format.zookeeperSaslClient = zookeeperSaslClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 616 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 617 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +        public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +            format.clientPrincipal = clientPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +        public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +            format.clientKeytabFile = clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 626 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +        public HbaseOutputFormatBuilder setBatchSize(Integer batchSize) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 630 +            format.batchSize = batchSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 631 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 632 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 633 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +        public HbaseOutputFormatBuilder setBatchWaitInterval(Long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +            format.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 637 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 639 +        public HbaseOutputFormat finish() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 640 +            Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 641 +            Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 642 +            Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 643 +            Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 644 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 645 +            String[] families = new String[format.columnNames.length];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 646 +            String[] qualifiers = new String[format.columnNames.length];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 647 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 648 +            if (format.columnNameFamily != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 649 +                List&lt;String&gt; keyList = new LinkedList&lt;&gt;(format.columnNameFamily.keySet());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 650 +                String[] columns = keyList.toArray(new String[0]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 651 +                for (int i = 0; i &lt; columns.length; ++i) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 652 +                    String col = columns[i];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 653 +                    String[] part = col.split(&quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 654 +                    families[i] = part[0];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 655 +                    qualifiers[i] = part[1];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +            format.families = families;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +            format.qualifiers = qualifiers;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 661 +            return format;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 662 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 663 +    }</span>
 664  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            