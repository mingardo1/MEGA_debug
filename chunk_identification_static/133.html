<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>133</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    133
                    <a href="132.html">prev</a>
                    <a href="134.html">next</a>
                    <a href="133_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CarGuo/GSYVideoPlayer_5f2ec5bba1e993bd2142fb8506716e29792caaeb_app/src/main/java/com/example/gsyvideoplayer/DetailFilterActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;5f2ec5bba1e993bd2142fb8506716e29792caaeb:app/src/main/java/com/example/gsyvideoplayer/DetailFilterActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;5f2ec5bba1e993bd2142fb8506716e29792caaeb^1:app/src/main/java/com/example/gsyvideoplayer/DetailFilterActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;5f2ec5bba1e993bd2142fb8506716e29792caaeb^2:app/src/main/java/com/example/gsyvideoplayer/DetailFilterActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CarGuo\GSYVideoPlayer show &quot;3b95c518ed76af696e22a4380a88d67304e0e5a6:app/src/main/java/com/example/gsyvideoplayer/DetailFilterActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.example.gsyvideoplayer;
   2 
   3 import android.Manifest;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.graphics.Bitmap;
   7 import android.graphics.BitmapFactory;
   8 import android.graphics.Color;
   9 import android.opengl.Matrix;
  10 import android.os.Bundle;
  11 import android.support.annotation.NonNull;
  12 import android.support.v4.widget.NestedScrollView;
  13 import android.util.TypedValue;
  14 import android.view.View;
  15 import android.widget.Button;
  16 import android.widget.ImageView;
  17 import android.widget.RelativeLayout;
  18 import android.widget.Toast;
  19 
  20 import com.bumptech.glide.Glide;
  21 import com.bumptech.glide.request.RequestOptions;
  22 import com.example.gsyvideoplayer.effect.BitmapIconEffect;
  23 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender;
  24 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender2;
  25 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender4;
  26 import com.example.gsyvideoplayer.effect.PixelationEffect;
  27 import com.example.gsyvideoplayer.utils.CommonUtil;
  28 import com.example.gsyvideoplayer.video.SampleControlVideo;
  29 import com.shuyu.gsyvideoplayer.GSYBaseActivityDetail;
  30 import com.shuyu.gsyvideoplayer.listener.GSYVideoGifSaveListener;
  31 import com.shuyu.gsyvideoplayer.render.view.GSYVideoGLView;
  32 import com.shuyu.gsyvideoplayer.builder.GSYVideoOptionBuilder;
  33 import com.shuyu.gsyvideoplayer.render.effect.AutoFixEffect;
  34 import com.shuyu.gsyvideoplayer.render.effect.BarrelBlurEffect;
  35 import com.shuyu.gsyvideoplayer.render.effect.BlackAndWhiteEffect;
  36 import com.shuyu.gsyvideoplayer.render.effect.BrightnessEffect;
  37 import com.shuyu.gsyvideoplayer.render.effect.ContrastEffect;
  38 import com.shuyu.gsyvideoplayer.render.effect.CrossProcessEffect;
  39 import com.shuyu.gsyvideoplayer.render.effect.DocumentaryEffect;
  40 import com.shuyu.gsyvideoplayer.render.effect.DuotoneEffect;
  41 import com.shuyu.gsyvideoplayer.render.effect.FillLightEffect;
  42 import com.shuyu.gsyvideoplayer.render.effect.GammaEffect;
  43 import com.shuyu.gsyvideoplayer.render.effect.GaussianBlurEffect;
  44 import com.shuyu.gsyvideoplayer.render.effect.GrainEffect;
  45 import com.shuyu.gsyvideoplayer.render.effect.HueEffect;
  46 import com.shuyu.gsyvideoplayer.render.effect.InvertColorsEffect;
  47 import com.shuyu.gsyvideoplayer.render.effect.LamoishEffect;
  48 import com.shuyu.gsyvideoplayer.render.effect.NoEffect;
  49 import com.shuyu.gsyvideoplayer.render.effect.OverlayEffect;
  50 import com.shuyu.gsyvideoplayer.render.effect.PosterizeEffect;
  51 import com.shuyu.gsyvideoplayer.render.effect.SampleBlurEffect;
  52 import com.shuyu.gsyvideoplayer.render.effect.SaturationEffect;
  53 import com.shuyu.gsyvideoplayer.render.effect.SepiaEffect;
  54 import com.shuyu.gsyvideoplayer.render.effect.SharpnessEffect;
  55 import com.shuyu.gsyvideoplayer.render.effect.TemperatureEffect;
  56 import com.shuyu.gsyvideoplayer.render.effect.TintEffect;
  57 import com.shuyu.gsyvideoplayer.render.effect.VignetteEffect;
  58 import com.shuyu.gsyvideoplayer.listener.GSYVideoShotListener;
  59 import com.shuyu.gsyvideoplayer.listener.LockClickListener;
  60 import com.shuyu.gsyvideoplayer.utils.Debuger;
  61 import com.shuyu.gsyvideoplayer.utils.FileUtils;
  62 import com.shuyu.gsyvideoplayer.utils.GSYVideoType;
  63 import com.shuyu.gsyvideoplayer.utils.GifCreateHelper;
  64 import com.shuyu.gsyvideoplayer.video.StandardGSYVideoPlayer;
  65 import com.shuyu.gsyvideoplayer.video.base.GSYBaseVideoPlayer;
  66 
  67 import java.io.File;
  68 import java.io.FileNotFoundException;
  69 import java.util.Timer;
  70 import java.util.TimerTask;
  71 
  72 import butterknife.BindView;
  73 import butterknife.ButterKnife;
  74 import permissions.dispatcher.NeedsPermission;
  75 import permissions.dispatcher.OnNeverAskAgain;
  76 import permissions.dispatcher.OnPermissionDenied;
  77 import permissions.dispatcher.OnShowRationale;
  78 import permissions.dispatcher.PermissionRequest;
  79 import permissions.dispatcher.RuntimePermissions;
  80 
  81 /**
  82  * 滤镜
  83  * Activity可以继承GSYBaseActivityDetail实现详情模式的页面
  84  * 或者参考DetailPlayer、DetailListPlayer实现
  85  * Created by guoshuyu on 2017/6/18.
  86  */
  87 @RuntimePermissions
  88 public class DetailFilterActivity extends GSYBaseActivityDetail&lt;StandardGSYVideoPlayer&gt; {
  89 
  90     @BindView(R.id.post_detail_nested_scroll)
  91     NestedScrollView postDetailNestedScroll;
  92 
  93     @BindView(R.id.detail_player)
  94     SampleControlVideo detailPlayer;
  95 
  96     @BindView(R.id.activity_detail_player)
  97     RelativeLayout activityDetailPlayer;
  98 
  99     @BindView(R.id.change_filter)
 100     Button changeFilter;
 101 
 102 
 103     @BindView(R.id.jump)
 104     Button jump;
 105 
 106     @BindView(R.id.change_anima)
 107     Button anima;
 108 
 109     @BindView(R.id.start_gif)
 110     Button startGif;
 111 
 112     @BindView(R.id.stop_gif)
 113     Button stopGif;
 114 
 115     @BindView(R.id.loadingView)
 116     View loadingView;
 117 
 118     private int type = 0;
 119 
 120     private int backupRendType;
 121 
 122     private float deep = 0.8f;
 123 
 124     private String url = &quot;https://res.exexm.com/cw_145225549855002&quot;;
 125     //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 126 
 127     private Timer timer = new Timer();
 128 
 129     private TaskLocal mTimerTask;
 130 
 131     private TaskLocal2 mTimerTask2;
 132 
 133     private GSYVideoGLViewCustomRender mGSYVideoGLViewCustomRender;
 134 
 135     private BitmapIconEffect mCustomBitmapIconEffect;
 136 
 137     private int percentage = 1;
 138 
 139     private int percentageType = 1;
 140 
 141     private boolean moveBitmap = false;
 142 
 143     private GifCreateHelper mGifCreateHelper;
 144 
 145     @Override
 146     protected void onCreate(Bundle savedInstanceState) {
 147         super.onCreate(savedInstanceState);
 148         setContentView(R.layout.activity_detail_filter);
 149         ButterKnife.bind(this);
 150 
 151         backupRendType = GSYVideoType.getRenderType();
 152 
 153         //设置为GL播放模式，才能支持滤镜，注意此设置是全局的
 154         GSYVideoType.setRenderType(GSYVideoType.GLSURFACE);
 155 
 156         resolveNormalVideoUI();
 157 
 158         initVideoBuilderMode();
 159 
 160         initGifHelper();
 161 
 162         detailPlayer.setLockClickListener(new LockClickListener() {
 163             @Override
 164             public void onClick(View view, boolean lock) {
 165                 if (orientationUtils != null) {
 166                     //配合下方的onConfigurationChanged
 167                     orientationUtils.setEnable(!lock);
 168                 }
 169             }
 170         });
 171 
 172 
 173         //自定义render需要在播放器开始播放之前，播放过程中不允许切换render
 174 
 175         //水印图效果
 176         /*Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher);
 177         mGSYVideoGLViewCustomRender = new GSYVideoGLViewCustomRender();
 178         mCustomBitmapIconEffect = new BitmapIconEffect(bitmap, dp2px(50), dp2px(50), 0.6f);
 179         mGSYVideoGLViewCustomRender.setBitmapEffect(mCustomBitmapIconEffect);
 180         detailPlayer.setCustomGLRenderer(mGSYVideoGLViewCustomRender);
 181         detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);*/
 182 
 183         //多窗口播放效果
 184         //detailPlayer.setEffectFilter(new GammaEffect(0.8f));
 185         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender2());
 186 
 187         //图片穿孔透视播放
 188         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender3());
 189 
 190         //高斯拉伸视频铺满背景，替换黑色，前台正常比例播放
 191         //detailPlayer.setEffectFilter(new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY));
 192         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender4());
 193         //detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 194 
 195         changeFilter.setOnClickListener(new View.OnClickListener() {
 196             @Override
 197             public void onClick(View v) {
 198                 resolveTypeUI();
 199             }
 200         });
 201 
 202         //使用GL播放的话，用这种方式可以解决退出全屏黑屏的问题
 203         detailPlayer.setBackFromFullScreenListener(new View.OnClickListener() {
 204             @Override
 205             public void onClick(View v) {
 206                 DetailFilterActivity.this.onBackPressed();
 207             }
 208         });
 209 
 210 
 211         jump.setOnClickListener(new View.OnClickListener() {
 212             @Override
 213             public void onClick(View v) {
 214                 //shotImage(v);
 215                 //JumpUtils.gotoControl(DetailFilterActivity.this);
 216                 //startActivity(new Intent(DetailControlActivity.this, MainActivity.class));
 217 
<abbr title=" 218                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivity.this, v);"> 218                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivi🔵</abbr>
 219             }
 220         });
 221 
 222         anima.setOnClickListener(new View.OnClickListener() {
 223             @Override
 224             public void onClick(View v) {
 225                 //画面旋转
 226                 cancelTask();
 227                 mTimerTask = new TaskLocal();
 228                 timer.schedule(mTimerTask, 0, 50);
 229                 percentageType++;
 230                 if (percentageType &gt; 4) {
 231                     percentageType = 1;
 232                 }
 233                 //水印图动起来
 234                 //cancelTask2();
 235                 //mTimerTask2 = new TaskLocal2();
 236                 //timer.schedule(mTimerTask2, 0, 400);
 237 
 238                 //moveBitmap = !moveBitmap;
 239             }
 240         });
 241 
 242 
 243         startGif.setOnClickListener(new View.OnClickListener() {
 244             @Override
 245             public void onClick(View v) {
<abbr title=" 246                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivity.this);"> 246                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivit🔵</abbr>
 247             }
 248         });
 249 
 250         stopGif.setOnClickListener(new View.OnClickListener() {
 251             @Override
 252             public void onClick(View v) {
 253                 stopGif();
 254             }
 255         });
 256 
 257         loadingView.setOnClickListener(new View.OnClickListener() {
 258             @Override
 259             public void onClick(View v) {
 260                 //do nothing
 261             }
 262         });
 263     }
 264 
 265     @Override
 266     public StandardGSYVideoPlayer getGSYVideoPlayer() {
 267         return detailPlayer;
 268     }
 269 
 270     @Override
 271     public GSYVideoOptionBuilder getGSYVideoOptionBuilder() {
 272         //内置封面可参考SampleCoverVideo
 273         ImageView imageView = new ImageView(this);
 274         loadCover(imageView, url);
 275         return new GSYVideoOptionBuilder()
 276                 .setThumbImageView(imageView)
 277                 .setUrl(url)
 278                 .setCacheWithPlay(true)
 279                 .setVideoTitle(&quot; &quot;)
 280                 .setIsTouchWiget(true)
 281                 .setRotateViewAuto(false)
 282                 .setLockLand(false)
 283                 .setShowFullAnimation(false)
 284                 .setNeedLockFull(true)
 285                 .setSeekRatio(1);
 286     }
 287 
 288     @Override
 289     public void clickForFullScreen() {
 290 
 291     }
 292 
 293     /**
 294      * 是否启动旋转横屏，true表示启动
 295      * @return true
 296      */
 297     @Override
 298     public boolean getDetailOrientationRotateAuto() {
 299         return true;
 300     }
 301 
 302     @Override
 303     protected void onDestroy() {
 304         super.onDestroy();
 305         //恢复到原本的绘制模式
 306         GSYVideoType.setRenderType(backupRendType);
 307         cancelTask();
 308     }
 309 
 310     /**
 311      * 视频截图
 312      */
 313     @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 314     void shotImage(final View v) {
 315         //获取截图
 316         detailPlayer.taskShotPic(new GSYVideoShotListener() {
 317             @Override
 318             public void getBitmap(Bitmap bitmap) {
 319                 if (bitmap != null) {
 320                     try {
 321                         CommonUtil.saveBitmap(bitmap);
 322                     } catch (FileNotFoundException e) {
 323                         showToast(&quot;save fail &quot;);
 324                         e.printStackTrace();
 325                         return;
 326                     }
 327                     showToast(&quot;save success &quot;);
 328                 } else {
 329                     showToast(&quot;get bitmap fail &quot;);
 330                 }
 331             }
 332         });
 333 
 334     }
 335 
 336 
 337 
 338     private void initGifHelper() {
 339         mGifCreateHelper = new GifCreateHelper(detailPlayer, new GSYVideoGifSaveListener() {
 340             @Override
 341             public void result(boolean success, File file) {
 342                 detailPlayer.post(new Runnable() {
 343                     @Override
 344                     public void run() {
 345                         loadingView.setVisibility(View.GONE);
 346                         Toast.makeText(detailPlayer.getContext(), &quot;创建成功&quot;, Toast.LENGTH_LONG).show();
 347                     }
 348                 });
 349             }
 350 
 351             @Override
 352             public void process(int curPosition, int total) {
 353                 Debuger.printfError(&quot; current &quot; + curPosition + &quot; total &quot; + total);
 354             }
 355         });
 356     }
 357 
 358 
 359     /**
 360      * 开始gif截图
 361      */
 362 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363     @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364     void startGif() {</span>
 365 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366     private void startGif() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367         //开始缓存各个帧</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         mGifCreateHelper.startGif(new File(FileUtils.getPath()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373      * 生成gif</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375     private void stopGif() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376         loadingView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 377         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.gif&quot;));"> 377         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380     /**</span>
 381 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382     private void startGif() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();</span>
 384 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 385         //开始缓存各个帧
 386         mGifCreateHelper.startGif(new File(FileUtils.getPath()));
 387 
 388     }
 389 
 390     /**
 391      * 生成gif
 392      */
 393     private void stopGif() {
 394         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();
 395         loadingView.setVisibility(View.VISIBLE);
<abbr title=" 396         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.gif&quot;));"> 396         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.🔵</abbr>
 397     }
 398 
 399     /**
 400      * 加载第三秒的帧数作为封面
 401      */
 402     private void loadCover(ImageView imageView, String url) {
 403 
 404         imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
 405         imageView.setImageResource(R.mipmap.xxx1);
 406 
 407         Glide.with(this.getApplicationContext())
 408                 .setDefaultRequestOptions(
 409                         new RequestOptions()
 410                                 .frame(3000000)
 411                                 .centerCrop()
 412                                 .error(R.mipmap.xxx2)
 413                                 .placeholder(R.mipmap.xxx1))
 414                 .load(url)
 415                 .into(imageView);
 416     }
 417 
 418     private void resolveNormalVideoUI() {
 419         //增加title
 420         detailPlayer.getTitleTextView().setVisibility(View.GONE);
 421         detailPlayer.getBackButton().setVisibility(View.GONE);
 422     }
 423 
 424     /**
 425      * 切换滤镜
 426      */
 427     private void resolveTypeUI() {
 428         GSYVideoGLView.ShaderInterface effect = new NoEffect();
 429         switch (type) {
 430             case 0:
 431                 effect = new AutoFixEffect(deep);
 432                 break;
 433             case 1:
 434                 effect = new PixelationEffect();
 435                 break;
 436             case 2:
 437                 effect = new BlackAndWhiteEffect();
 438                 break;
 439             case 3:
 440                 effect = new ContrastEffect(deep);
 441                 break;
 442             case 4:
 443                 effect = new CrossProcessEffect();
 444                 break;
 445             case 5:
 446                 effect = new DocumentaryEffect();
 447                 break;
 448             case 6:
 449                 effect = new DuotoneEffect(Color.BLUE, Color.YELLOW);
 450                 break;
 451             case 7:
 452                 effect = new FillLightEffect(deep);
 453                 break;
 454             case 8:
 455                 effect = new GammaEffect(deep);
 456                 break;
 457             case 9:
 458                 effect = new GrainEffect(deep);
 459                 break;
 460             case 10:
 461                 effect = new GrainEffect(deep);
 462                 break;
 463             case 11:
 464                 effect = new HueEffect(deep);
 465                 break;
 466             case 12:
 467                 effect = new InvertColorsEffect();
 468                 break;
 469             case 13:
 470                 effect = new LamoishEffect();
 471                 break;
 472             case 14:
 473                 effect = new PosterizeEffect();
 474                 break;
 475             case 15:
 476                 effect = new BarrelBlurEffect();
 477                 break;
 478             case 16:
 479                 effect = new SaturationEffect(deep);
 480                 break;
 481             case 17:
 482                 effect = new SepiaEffect();
 483                 break;
 484             case 18:
 485                 effect = new SharpnessEffect(deep);
 486                 break;
 487             case 19:
 488                 effect = new TemperatureEffect(deep);
 489                 break;
 490             case 20:
 491                 effect = new TintEffect(Color.GREEN);
 492                 break;
 493             case 21:
 494                 effect = new VignetteEffect(deep);
 495                 break;
 496             case 22:
 497                 effect = new NoEffect();
 498                 break;
 499             case 23:
 500                 effect = new OverlayEffect();
 501                 break;
 502             case 24:
 503                 effect = new SampleBlurEffect(4.0f);
 504                 break;
 505             case 25:
 506                 effect = new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY);
 507                 break;
 508             case 26:
 509                 effect = new BrightnessEffect(deep);
 510                 break;
 511         }
 512         detailPlayer.setEffectFilter(effect);
 513         type++;
 514         if (type &gt; 25) {
 515             type = 0;
 516         }
 517     }
 518 
 519 
 520     private void cancelTask2() {
 521         if (mTimerTask2 != null) {
 522             mTimerTask2.cancel();
 523             mTimerTask2 = null;
 524         }
 525     }
 526 
 527     private void cancelTask() {
 528         if (mTimerTask != null) {
 529             mTimerTask.cancel();
 530             mTimerTask = null;
 531         }
 532     }
 533 
 534 
 535     /**
 536      * 水印图动起来,播放前开始会崩溃哟
 537      */
 538     private class TaskLocal2 extends TimerTask {
 539         @Override
 540         public void run() {
 541             float[] transform = new float[16];
 542             //旋转到正常角度
 543             Matrix.setRotateM(transform, 0, 180f, 0.0f, 0, 1.0f);
 544             //调整大小比例
<abbr title=" 545             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 1);"> 545             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getS🔵</abbr>
 546             if (moveBitmap) {
 547                 //调整位置
<abbr title=" 548                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.getPositionY(), 0f);"> 548                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIcon🔵</abbr>
 549             } else {
 550                 float maxX = mCustomBitmapIconEffect.getMaxPositionX();
 551                 float minX = mCustomBitmapIconEffect.getMinPositionX();
 552                 float maxY = mCustomBitmapIconEffect.getMaxPositionY();
 553                 float minY = mCustomBitmapIconEffect.getMinPositionY();
 554                 float x = (float) Math.random() * (maxX - minX) + minX;
 555                 float y = (float) Math.random() * (maxY - minY) + minY;
 556                 //调整位置
 557                 Matrix.translateM(transform, 0, x, y, 0f);
 558                 mGSYVideoGLViewCustomRender.setCurrentMVPMatrix(transform);
 559             }
 560         }
 561     }
 562 
 563 
 564     /**
 565      * 设置GLRender的VertexShader的transformMatrix
 566      * 注意，这是android.opengl.Matrix
 567      */
 568     private class TaskLocal extends TimerTask {
 569         @Override
 570         public void run() {
 571             float[] transform = new float[16];
 572             switch (percentageType) {
 573                 case 1:
 574                     //给予x变化
 575                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 1.0f, 0, 0.0f);
 576                     break;
 577                 case 2:
 578                     //给予y变化
 579                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 1.0f, 0.0f);
 580                     break;
 581                 case 3:
 582                     //给予z变化
 583                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 0, 1.0f);
 584                     break;
 585                 case 4:
 586                     Matrix.setRotateM(transform, 0, 360, 0.0f, 0, 1.0f);
 587                     break;
 588             }
 589             //设置渲染transform
 590             detailPlayer.setMatrixGL(transform);
 591             percentage++;
 592             if (percentage &gt; 100) {
 593                 percentage = 1;
 594             }
 595         }
 596     }
 597 
 598     private int dp2px(int dp) {
 599         return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
 600                 getResources().getDisplayMetrics());
 601     }
 602 
 603     private void showToast(final String tip) {
 604         detailPlayer.post(new Runnable() {
 605             @Override
 606             public void run() {
 607                 Toast.makeText(DetailFilterActivity.this, tip, Toast.LENGTH_LONG).show();
 608             }
 609         });
 610     }
 611 
 612 
 613     @OnShowRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 614     void showRationaleForCamera(final PermissionRequest request) {
 615         new AlertDialog.Builder(this)
 616                 .setMessage(&quot;快给我权限&quot;)
 617                 .setPositiveButton(&quot;允许&quot;, new DialogInterface.OnClickListener() {
 618                     @Override
 619                     public void onClick(DialogInterface dialog, int which) {
 620                         request.proceed();
 621                     }
 622                 })
 623                 .setNegativeButton(&quot;拒绝&quot;, new DialogInterface.OnClickListener() {
 624                     @Override
 625                     public void onClick(DialogInterface dialog, int which) {
 626                         request.cancel();
 627                     }
 628                 })
 629                 .show();
 630     }
 631 
 632     @OnPermissionDenied(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 633     void showDeniedForCamera() {
 634         Toast.makeText(this, &quot;没有权限啊&quot;, Toast.LENGTH_SHORT).show();
 635     }
 636 
 637     @OnNeverAskAgain(Manifest.permission.CAMERA)
 638     void showNeverAskForCamera() {
 639         Toast.makeText(this, &quot;再次授权&quot;, Toast.LENGTH_SHORT).show();
 640     }
 641 
 642     @Override
<abbr title=" 643     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {"> 643     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[]🔵</abbr>
 644         super.onRequestPermissionsResult(requestCode, permissions, grantResults);
 645         // NOTE: delegate the permission handling to generated method
<abbr title=" 646         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);"> 646         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResu🔵</abbr>
 647     }
 648 }</pre></td>
                            <td><pre>   1 package com.example.gsyvideoplayer;
   2 
   3 import android.Manifest;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.graphics.Bitmap;
   7 import android.graphics.BitmapFactory;
   8 import android.graphics.Color;
   9 import android.opengl.Matrix;
  10 import android.os.Bundle;
  11 import android.support.annotation.NonNull;
  12 import android.support.v4.widget.NestedScrollView;
  13 import android.util.TypedValue;
  14 import android.view.View;
  15 import android.widget.Button;
  16 import android.widget.ImageView;
  17 import android.widget.RelativeLayout;
  18 import android.widget.Toast;
  19 
  20 import com.bumptech.glide.Glide;
  21 import com.bumptech.glide.request.RequestOptions;
  22 import com.example.gsyvideoplayer.effect.BitmapIconEffect;
  23 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender;
  24 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender2;
  25 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender4;
  26 import com.example.gsyvideoplayer.effect.PixelationEffect;
  27 import com.example.gsyvideoplayer.utils.CommonUtil;
  28 import com.example.gsyvideoplayer.video.SampleControlVideo;
  29 import com.shuyu.gsyvideoplayer.GSYBaseActivityDetail;
  30 import com.shuyu.gsyvideoplayer.listener.GSYVideoGifSaveListener;
  31 import com.shuyu.gsyvideoplayer.render.view.GSYVideoGLView;
  32 import com.shuyu.gsyvideoplayer.builder.GSYVideoOptionBuilder;
  33 import com.shuyu.gsyvideoplayer.render.effect.AutoFixEffect;
  34 import com.shuyu.gsyvideoplayer.render.effect.BarrelBlurEffect;
  35 import com.shuyu.gsyvideoplayer.render.effect.BlackAndWhiteEffect;
  36 import com.shuyu.gsyvideoplayer.render.effect.BrightnessEffect;
  37 import com.shuyu.gsyvideoplayer.render.effect.ContrastEffect;
  38 import com.shuyu.gsyvideoplayer.render.effect.CrossProcessEffect;
  39 import com.shuyu.gsyvideoplayer.render.effect.DocumentaryEffect;
  40 import com.shuyu.gsyvideoplayer.render.effect.DuotoneEffect;
  41 import com.shuyu.gsyvideoplayer.render.effect.FillLightEffect;
  42 import com.shuyu.gsyvideoplayer.render.effect.GammaEffect;
  43 import com.shuyu.gsyvideoplayer.render.effect.GaussianBlurEffect;
  44 import com.shuyu.gsyvideoplayer.render.effect.GrainEffect;
  45 import com.shuyu.gsyvideoplayer.render.effect.HueEffect;
  46 import com.shuyu.gsyvideoplayer.render.effect.InvertColorsEffect;
  47 import com.shuyu.gsyvideoplayer.render.effect.LamoishEffect;
  48 import com.shuyu.gsyvideoplayer.render.effect.NoEffect;
  49 import com.shuyu.gsyvideoplayer.render.effect.OverlayEffect;
  50 import com.shuyu.gsyvideoplayer.render.effect.PosterizeEffect;
  51 import com.shuyu.gsyvideoplayer.render.effect.SampleBlurEffect;
  52 import com.shuyu.gsyvideoplayer.render.effect.SaturationEffect;
  53 import com.shuyu.gsyvideoplayer.render.effect.SepiaEffect;
  54 import com.shuyu.gsyvideoplayer.render.effect.SharpnessEffect;
  55 import com.shuyu.gsyvideoplayer.render.effect.TemperatureEffect;
  56 import com.shuyu.gsyvideoplayer.render.effect.TintEffect;
  57 import com.shuyu.gsyvideoplayer.render.effect.VignetteEffect;
  58 import com.shuyu.gsyvideoplayer.listener.GSYVideoShotListener;
  59 import com.shuyu.gsyvideoplayer.listener.LockClickListener;
  60 import com.shuyu.gsyvideoplayer.utils.Debuger;
  61 import com.shuyu.gsyvideoplayer.utils.FileUtils;
  62 import com.shuyu.gsyvideoplayer.utils.GSYVideoType;
  63 import com.shuyu.gsyvideoplayer.utils.GifCreateHelper;
  64 import com.shuyu.gsyvideoplayer.video.StandardGSYVideoPlayer;
  65 import com.shuyu.gsyvideoplayer.video.base.GSYBaseVideoPlayer;
  66 
  67 import java.io.File;
  68 import java.io.FileNotFoundException;
  69 import java.util.Timer;
  70 import java.util.TimerTask;
  71 
  72 import butterknife.BindView;
  73 import butterknife.ButterKnife;
  74 import permissions.dispatcher.NeedsPermission;
  75 import permissions.dispatcher.OnNeverAskAgain;
  76 import permissions.dispatcher.OnPermissionDenied;
  77 import permissions.dispatcher.OnShowRationale;
  78 import permissions.dispatcher.PermissionRequest;
  79 import permissions.dispatcher.RuntimePermissions;
  80 
  81 /**
  82  * 滤镜
  83  * Activity可以继承GSYBaseActivityDetail实现详情模式的页面
  84  * 或者参考DetailPlayer、DetailListPlayer实现
  85  * Created by guoshuyu on 2017/6/18.
  86  */
  87 @RuntimePermissions
  88 public class DetailFilterActivity extends GSYBaseActivityDetail&lt;StandardGSYVideoPlayer&gt; {
  89 
  90     @BindView(R.id.post_detail_nested_scroll)
  91     NestedScrollView postDetailNestedScroll;
  92 
  93     @BindView(R.id.detail_player)
  94     SampleControlVideo detailPlayer;
  95 
  96     @BindView(R.id.activity_detail_player)
  97     RelativeLayout activityDetailPlayer;
  98 
  99     @BindView(R.id.change_filter)
 100     Button changeFilter;
 101 
 102 
 103     @BindView(R.id.jump)
 104     Button jump;
 105 
 106     @BindView(R.id.change_anima)
 107     Button anima;
 108 
 109     @BindView(R.id.start_gif)
 110     Button startGif;
 111 
 112     @BindView(R.id.stop_gif)
 113     Button stopGif;
 114 
 115     @BindView(R.id.loadingView)
 116     View loadingView;
 117 
 118     private int type = 0;
 119 
 120     private int backupRendType;
 121 
 122     private float deep = 0.8f;
 123 
 124     private String url = &quot;https://res.exexm.com/cw_145225549855002&quot;;
 125     //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 126 
 127     private Timer timer = new Timer();
 128 
 129     private TaskLocal mTimerTask;
 130 
 131     private TaskLocal2 mTimerTask2;
 132 
 133     private GSYVideoGLViewCustomRender mGSYVideoGLViewCustomRender;
 134 
 135     private BitmapIconEffect mCustomBitmapIconEffect;
 136 
 137     private int percentage = 1;
 138 
 139     private int percentageType = 1;
 140 
 141     private boolean moveBitmap = false;
 142 
 143     private GifCreateHelper mGifCreateHelper;
 144 
 145     @Override
 146     protected void onCreate(Bundle savedInstanceState) {
 147         super.onCreate(savedInstanceState);
 148         setContentView(R.layout.activity_detail_filter);
 149         ButterKnife.bind(this);
 150 
 151         backupRendType = GSYVideoType.getRenderType();
 152 
 153         //设置为GL播放模式，才能支持滤镜，注意此设置是全局的
 154         GSYVideoType.setRenderType(GSYVideoType.GLSURFACE);
 155 
 156         resolveNormalVideoUI();
 157 
 158         initVideoBuilderMode();
 159 
 160         initGifHelper();
 161 
 162         detailPlayer.setLockClickListener(new LockClickListener() {
 163             @Override
 164             public void onClick(View view, boolean lock) {
 165                 if (orientationUtils != null) {
 166                     //配合下方的onConfigurationChanged
 167                     orientationUtils.setEnable(!lock);
 168                 }
 169             }
 170         });
 171 
 172 
 173         //自定义render需要在播放器开始播放之前，播放过程中不允许切换render
 174 
 175         //水印图效果
 176         /*Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher);
 177         mGSYVideoGLViewCustomRender = new GSYVideoGLViewCustomRender();
 178         mCustomBitmapIconEffect = new BitmapIconEffect(bitmap, dp2px(50), dp2px(50), 0.6f);
 179         mGSYVideoGLViewCustomRender.setBitmapEffect(mCustomBitmapIconEffect);
 180         detailPlayer.setCustomGLRenderer(mGSYVideoGLViewCustomRender);
 181         detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);*/
 182 
 183         //多窗口播放效果
 184         //detailPlayer.setEffectFilter(new GammaEffect(0.8f));
 185         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender2());
 186 
 187         //图片穿孔透视播放
 188         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender3());
 189 
 190         //高斯拉伸视频铺满背景，替换黑色，前台正常比例播放
 191         //detailPlayer.setEffectFilter(new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY));
 192         //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender4());
 193         //detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 194 
 195         changeFilter.setOnClickListener(new View.OnClickListener() {
 196             @Override
 197             public void onClick(View v) {
 198                 resolveTypeUI();
 199             }
 200         });
 201 
 202         //使用GL播放的话，用这种方式可以解决退出全屏黑屏的问题
 203         detailPlayer.setBackFromFullScreenListener(new View.OnClickListener() {
 204             @Override
 205             public void onClick(View v) {
 206                 DetailFilterActivity.this.onBackPressed();
 207             }
 208         });
 209 
 210 
 211         jump.setOnClickListener(new View.OnClickListener() {
 212             @Override
 213             public void onClick(View v) {
 214                 //shotImage(v);
 215                 //JumpUtils.gotoControl(DetailFilterActivity.this);
 216                 //startActivity(new Intent(DetailControlActivity.this, MainActivity.class));
 217 
<abbr title=" 218                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivity.this, v);"> 218                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivi🔵</abbr>
 219             }
 220         });
 221 
 222         anima.setOnClickListener(new View.OnClickListener() {
 223             @Override
 224             public void onClick(View v) {
 225                 //画面旋转
 226                 cancelTask();
 227                 mTimerTask = new TaskLocal();
 228                 timer.schedule(mTimerTask, 0, 50);
 229                 percentageType++;
 230                 if (percentageType &gt; 4) {
 231                     percentageType = 1;
 232                 }
 233                 //水印图动起来
 234                 //cancelTask2();
 235                 //mTimerTask2 = new TaskLocal2();
 236                 //timer.schedule(mTimerTask2, 0, 400);
 237 
 238                 //moveBitmap = !moveBitmap;
 239             }
 240         });
 241 
 242 
 243         startGif.setOnClickListener(new View.OnClickListener() {
 244             @Override
 245             public void onClick(View v) {
<abbr title=" 246                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivity.this);"> 246                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivit🔵</abbr>
 247             }
 248         });
 249 
 250         stopGif.setOnClickListener(new View.OnClickListener() {
 251             @Override
 252             public void onClick(View v) {
 253                 stopGif();
 254             }
 255         });
 256 
 257         loadingView.setOnClickListener(new View.OnClickListener() {
 258             @Override
 259             public void onClick(View v) {
 260                 //do nothing
 261             }
 262         });
 263     }
 264 
 265     @Override
 266     public StandardGSYVideoPlayer getGSYVideoPlayer() {
 267         return detailPlayer;
 268     }
 269 
 270     @Override
 271     public GSYVideoOptionBuilder getGSYVideoOptionBuilder() {
 272         //内置封面可参考SampleCoverVideo
 273         ImageView imageView = new ImageView(this);
 274         loadCover(imageView, url);
 275         return new GSYVideoOptionBuilder()
 276                 .setThumbImageView(imageView)
 277                 .setUrl(url)
 278                 .setCacheWithPlay(true)
 279                 .setVideoTitle(&quot; &quot;)
 280                 .setIsTouchWiget(true)
 281                 .setRotateViewAuto(false)
 282                 .setLockLand(false)
 283                 .setShowFullAnimation(false)
 284                 .setNeedLockFull(true)
 285                 .setSeekRatio(1);
 286     }
 287 
 288     @Override
 289     public void clickForFullScreen() {
 290 
 291     }
 292 
 293     /**
 294      * 是否启动旋转横屏，true表示启动
 295      * @return true
 296      */
 297     @Override
 298     public boolean getDetailOrientationRotateAuto() {
 299         return true;
 300     }
 301 
 302     @Override
 303     protected void onDestroy() {
 304         super.onDestroy();
 305         //恢复到原本的绘制模式
 306         GSYVideoType.setRenderType(backupRendType);
 307         cancelTask();
 308     }
 309 
 310     /**
 311      * 视频截图
 312      */
 313     @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 314     void shotImage(final View v) {
 315         //获取截图
 316         detailPlayer.taskShotPic(new GSYVideoShotListener() {
 317             @Override
 318             public void getBitmap(Bitmap bitmap) {
 319                 if (bitmap != null) {
 320                     try {
 321                         CommonUtil.saveBitmap(bitmap);
 322                     } catch (FileNotFoundException e) {
 323                         showToast(&quot;save fail &quot;);
 324                         e.printStackTrace();
 325                         return;
 326                     }
 327                     showToast(&quot;save success &quot;);
 328                 } else {
 329                     showToast(&quot;get bitmap fail &quot;);
 330                 }
 331             }
 332         });
 333 
 334     }
 335 
 336 
 337 
 338     private void initGifHelper() {
 339         mGifCreateHelper = new GifCreateHelper(detailPlayer, new GSYVideoGifSaveListener() {
 340             @Override
 341             public void result(boolean success, File file) {
 342                 detailPlayer.post(new Runnable() {
 343                     @Override
 344                     public void run() {
 345                         loadingView.setVisibility(View.GONE);
 346                         Toast.makeText(detailPlayer.getContext(), &quot;创建成功&quot;, Toast.LENGTH_LONG).show();
 347                     }
 348                 });
 349             }
 350 
 351             @Override
 352             public void process(int curPosition, int total) {
 353                 Debuger.printfError(&quot; current &quot; + curPosition + &quot; total &quot; + total);
 354             }
 355         });
 356     }
 357 
 358 
 359     /**
 360      * 开始gif截图
 361      */
 362 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363 @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364     void startGif() {</span>
 365 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 private void startGif() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367         //开始缓存各个帧</span>
 368 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 private void startGif() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();</span>
 371 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 372         //开始缓存各个帧
 373         mGifCreateHelper.startGif(new File(FileUtils.getPath()));
 374 
 375     }
 376 
 377     /**
 378      * 生成gif
 379      */
 380     private void stopGif() {
 381         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();
 382         loadingView.setVisibility(View.VISIBLE);
<abbr title=" 383         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.gif&quot;));"> 383         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.🔵</abbr>
 384     }
 385 
 386     /**
 387      * 加载第三秒的帧数作为封面
 388      */
 389     private void loadCover(ImageView imageView, String url) {
 390 
 391         imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
 392         imageView.setImageResource(R.mipmap.xxx1);
 393 
 394         Glide.with(this.getApplicationContext())
 395                 .setDefaultRequestOptions(
 396                         new RequestOptions()
 397                                 .frame(3000000)
 398                                 .centerCrop()
 399                                 .error(R.mipmap.xxx2)
 400                                 .placeholder(R.mipmap.xxx1))
 401                 .load(url)
 402                 .into(imageView);
 403     }
 404 
 405     private void resolveNormalVideoUI() {
 406         //增加title
 407         detailPlayer.getTitleTextView().setVisibility(View.GONE);
 408         detailPlayer.getBackButton().setVisibility(View.GONE);
 409     }
 410 
 411     /**
 412      * 切换滤镜
 413      */
 414     private void resolveTypeUI() {
 415         GSYVideoGLView.ShaderInterface effect = new NoEffect();
 416         switch (type) {
 417             case 0:
 418                 effect = new AutoFixEffect(deep);
 419                 break;
 420             case 1:
 421                 effect = new PixelationEffect();
 422                 break;
 423             case 2:
 424                 effect = new BlackAndWhiteEffect();
 425                 break;
 426             case 3:
 427                 effect = new ContrastEffect(deep);
 428                 break;
 429             case 4:
 430                 effect = new CrossProcessEffect();
 431                 break;
 432             case 5:
 433                 effect = new DocumentaryEffect();
 434                 break;
 435             case 6:
 436                 effect = new DuotoneEffect(Color.BLUE, Color.YELLOW);
 437                 break;
 438             case 7:
 439                 effect = new FillLightEffect(deep);
 440                 break;
 441             case 8:
 442                 effect = new GammaEffect(deep);
 443                 break;
 444             case 9:
 445                 effect = new GrainEffect(deep);
 446                 break;
 447             case 10:
 448                 effect = new GrainEffect(deep);
 449                 break;
 450             case 11:
 451                 effect = new HueEffect(deep);
 452                 break;
 453             case 12:
 454                 effect = new InvertColorsEffect();
 455                 break;
 456             case 13:
 457                 effect = new LamoishEffect();
 458                 break;
 459             case 14:
 460                 effect = new PosterizeEffect();
 461                 break;
 462             case 15:
 463                 effect = new BarrelBlurEffect();
 464                 break;
 465             case 16:
 466                 effect = new SaturationEffect(deep);
 467                 break;
 468             case 17:
 469                 effect = new SepiaEffect();
 470                 break;
 471             case 18:
 472                 effect = new SharpnessEffect(deep);
 473                 break;
 474             case 19:
 475                 effect = new TemperatureEffect(deep);
 476                 break;
 477             case 20:
 478                 effect = new TintEffect(Color.GREEN);
 479                 break;
 480             case 21:
 481                 effect = new VignetteEffect(deep);
 482                 break;
 483             case 22:
 484                 effect = new NoEffect();
 485                 break;
 486             case 23:
 487                 effect = new OverlayEffect();
 488                 break;
 489             case 24:
 490                 effect = new SampleBlurEffect(4.0f);
 491                 break;
 492             case 25:
 493                 effect = new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY);
 494                 break;
 495             case 26:
 496                 effect = new BrightnessEffect(deep);
 497                 break;
 498         }
 499         detailPlayer.setEffectFilter(effect);
 500         type++;
 501         if (type &gt; 25) {
 502             type = 0;
 503         }
 504     }
 505 
 506 
 507     private void cancelTask2() {
 508         if (mTimerTask2 != null) {
 509             mTimerTask2.cancel();
 510             mTimerTask2 = null;
 511         }
 512     }
 513 
 514     private void cancelTask() {
 515         if (mTimerTask != null) {
 516             mTimerTask.cancel();
 517             mTimerTask = null;
 518         }
 519     }
 520 
 521 
 522     /**
 523      * 水印图动起来,播放前开始会崩溃哟
 524      */
 525     private class TaskLocal2 extends TimerTask {
 526         @Override
 527         public void run() {
 528             float[] transform = new float[16];
 529             //旋转到正常角度
 530             Matrix.setRotateM(transform, 0, 180f, 0.0f, 0, 1.0f);
 531             //调整大小比例
<abbr title=" 532             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 1);"> 532             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getS🔵</abbr>
 533             if (moveBitmap) {
 534                 //调整位置
<abbr title=" 535                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.getPositionY(), 0f);"> 535                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIcon🔵</abbr>
 536             } else {
 537                 float maxX = mCustomBitmapIconEffect.getMaxPositionX();
 538                 float minX = mCustomBitmapIconEffect.getMinPositionX();
 539                 float maxY = mCustomBitmapIconEffect.getMaxPositionY();
 540                 float minY = mCustomBitmapIconEffect.getMinPositionY();
 541                 float x = (float) Math.random() * (maxX - minX) + minX;
 542                 float y = (float) Math.random() * (maxY - minY) + minY;
 543                 //调整位置
 544                 Matrix.translateM(transform, 0, x, y, 0f);
 545                 mGSYVideoGLViewCustomRender.setCurrentMVPMatrix(transform);
 546             }
 547         }
 548     }
 549 
 550 
 551     /**
 552      * 设置GLRender的VertexShader的transformMatrix
 553      * 注意，这是android.opengl.Matrix
 554      */
 555     private class TaskLocal extends TimerTask {
 556         @Override
 557         public void run() {
 558             float[] transform = new float[16];
 559             switch (percentageType) {
 560                 case 1:
 561                     //给予x变化
 562                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 1.0f, 0, 0.0f);
 563                     break;
 564                 case 2:
 565                     //给予y变化
 566                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 1.0f, 0.0f);
 567                     break;
 568                 case 3:
 569                     //给予z变化
 570                     Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 0, 1.0f);
 571                     break;
 572                 case 4:
 573                     Matrix.setRotateM(transform, 0, 360, 0.0f, 0, 1.0f);
 574                     break;
 575             }
 576             //设置渲染transform
 577             detailPlayer.setMatrixGL(transform);
 578             percentage++;
 579             if (percentage &gt; 100) {
 580                 percentage = 1;
 581             }
 582         }
 583     }
 584 
 585     private int dp2px(int dp) {
 586         return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
 587                 getResources().getDisplayMetrics());
 588     }
 589 
 590     private void showToast(final String tip) {
 591         detailPlayer.post(new Runnable() {
 592             @Override
 593             public void run() {
 594                 Toast.makeText(DetailFilterActivity.this, tip, Toast.LENGTH_LONG).show();
 595             }
 596         });
 597     }
 598 
 599 
 600     @OnShowRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 601     void showRationaleForCamera(final PermissionRequest request) {
 602         new AlertDialog.Builder(this)
 603                 .setMessage(&quot;快给我权限&quot;)
 604                 .setPositiveButton(&quot;允许&quot;, new DialogInterface.OnClickListener() {
 605                     @Override
 606                     public void onClick(DialogInterface dialog, int which) {
 607                         request.proceed();
 608                     }
 609                 })
 610                 .setNegativeButton(&quot;拒绝&quot;, new DialogInterface.OnClickListener() {
 611                     @Override
 612                     public void onClick(DialogInterface dialog, int which) {
 613                         request.cancel();
 614                     }
 615                 })
 616                 .show();
 617     }
 618 
 619     @OnPermissionDenied(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 620     void showDeniedForCamera() {
 621         Toast.makeText(this, &quot;没有权限啊&quot;, Toast.LENGTH_SHORT).show();
 622     }
 623 
 624     @OnNeverAskAgain(Manifest.permission.CAMERA)
 625     void showNeverAskForCamera() {
 626         Toast.makeText(this, &quot;再次授权&quot;, Toast.LENGTH_SHORT).show();
 627     }
 628 
 629     @Override
<abbr title=" 630     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {"> 630     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[]🔵</abbr>
 631         super.onRequestPermissionsResult(requestCode, permissions, grantResults);
 632         // NOTE: delegate the permission handling to generated method
<abbr title=" 633         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);"> 633         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResu🔵</abbr>
 634     }
 635 }
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.example.gsyvideoplayer;
   2 
   3 import android.Manifest;
   4 import android.app.AlertDialog;
   5 import android.content.DialogInterface;
   6 import android.graphics.Bitmap;
   7 import android.graphics.BitmapFactory;
   8 import android.graphics.Color;
   9 import android.opengl.Matrix;
  10 import android.os.Bundle;
  11 import android.support.annotation.NonNull;
  12 import android.support.v4.widget.NestedScrollView;
  13 import android.util.TypedValue;
  14 import android.view.View;
  15 import android.widget.Button;
  16 import android.widget.ImageView;
  17 import android.widget.RelativeLayout;
  18 import android.widget.Toast;
  19 import butterknife.BindView;
  20 import butterknife.ButterKnife;
  21 import com.bumptech.glide.Glide;
  22 import com.bumptech.glide.request.RequestOptions;
  23 import com.example.gsyvideoplayer.effect.BitmapIconEffect;
  24 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender2;
  25 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender4;
  26 import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender;
  27 import com.example.gsyvideoplayer.effect.PixelationEffect;
  28 import com.example.gsyvideoplayer.utils.CommonUtil;
  29 import com.example.gsyvideoplayer.video.SampleControlVideo;
  30 import com.shuyu.gsyvideoplayer.GSYBaseActivityDetail;
  31 import com.shuyu.gsyvideoplayer.builder.GSYVideoOptionBuilder;
  32 import com.shuyu.gsyvideoplayer.listener.GSYVideoGifSaveListener;
  33 import com.shuyu.gsyvideoplayer.listener.GSYVideoShotListener;
  34 import com.shuyu.gsyvideoplayer.listener.LockClickListener;
  35 import com.shuyu.gsyvideoplayer.render.effect.AutoFixEffect;
  36 import com.shuyu.gsyvideoplayer.render.effect.BarrelBlurEffect;
  37 import com.shuyu.gsyvideoplayer.render.effect.BlackAndWhiteEffect;
  38 import com.shuyu.gsyvideoplayer.render.effect.BrightnessEffect;
  39 import com.shuyu.gsyvideoplayer.render.effect.ContrastEffect;
  40 import com.shuyu.gsyvideoplayer.render.effect.CrossProcessEffect;
  41 import com.shuyu.gsyvideoplayer.render.effect.DocumentaryEffect;
  42 import com.shuyu.gsyvideoplayer.render.effect.DuotoneEffect;
  43 import com.shuyu.gsyvideoplayer.render.effect.FillLightEffect;
  44 import com.shuyu.gsyvideoplayer.render.effect.GammaEffect;
  45 import com.shuyu.gsyvideoplayer.render.effect.GaussianBlurEffect;
  46 import com.shuyu.gsyvideoplayer.render.effect.GrainEffect;
  47 import com.shuyu.gsyvideoplayer.render.effect.HueEffect;
  48 import com.shuyu.gsyvideoplayer.render.effect.InvertColorsEffect;
  49 import com.shuyu.gsyvideoplayer.render.effect.LamoishEffect;
  50 import com.shuyu.gsyvideoplayer.render.effect.NoEffect;
  51 import com.shuyu.gsyvideoplayer.render.effect.OverlayEffect;
  52 import com.shuyu.gsyvideoplayer.render.effect.PosterizeEffect;
  53 import com.shuyu.gsyvideoplayer.render.effect.SampleBlurEffect;
  54 import com.shuyu.gsyvideoplayer.render.effect.SaturationEffect;
  55 import com.shuyu.gsyvideoplayer.render.effect.SepiaEffect;
  56 import com.shuyu.gsyvideoplayer.render.effect.SharpnessEffect;
  57 import com.shuyu.gsyvideoplayer.render.effect.TemperatureEffect;
  58 import com.shuyu.gsyvideoplayer.render.effect.TintEffect;
  59 import com.shuyu.gsyvideoplayer.render.effect.VignetteEffect;
  60 import com.shuyu.gsyvideoplayer.render.view.GSYVideoGLView;
  61 import com.shuyu.gsyvideoplayer.utils.Debuger;
  62 import com.shuyu.gsyvideoplayer.utils.FileUtils;
  63 import com.shuyu.gsyvideoplayer.utils.GSYVideoType;
  64 import com.shuyu.gsyvideoplayer.utils.GifCreateHelper;
  65 import com.shuyu.gsyvideoplayer.video.StandardGSYVideoPlayer;
  66 import com.shuyu.gsyvideoplayer.video.base.GSYBaseVideoPlayer;
  67 import java.io.File;
  68 import java.io.FileNotFoundException;
  69 import java.util.Timer;
  70 import java.util.TimerTask;
  71 import permissions.dispatcher.NeedsPermission;
  72 import permissions.dispatcher.OnNeverAskAgain;
  73 import permissions.dispatcher.OnPermissionDenied;
  74 import permissions.dispatcher.OnShowRationale;
  75 import permissions.dispatcher.PermissionRequest;
  76 import permissions.dispatcher.RuntimePermissions;
  77 
  78 
  79 /**
  80  * 滤镜
  81  * Activity可以继承GSYBaseActivityDetail实现详情模式的页面
  82  * 或者参考DetailPlayer、DetailListPlayer实现
  83  * Created by guoshuyu on 2017/6/18.
  84  */
  85 @RuntimePermissions
  86 public class DetailFilterActivity extends GSYBaseActivityDetail&lt;StandardGSYVideoPlayer&gt; {
  87     @BindView(R.id.post_detail_nested_scroll)
  88     NestedScrollView postDetailNestedScroll;
  89 
  90     @BindView(R.id.detail_player)
  91     SampleControlVideo detailPlayer;
  92 
  93     @BindView(R.id.activity_detail_player)
  94     RelativeLayout activityDetailPlayer;
  95 
  96     @BindView(R.id.change_filter)
  97     Button changeFilter;
  98 
  99     @BindView(R.id.jump)
 100     Button jump;
 101 
 102     @BindView(R.id.change_anima)
 103     Button anima;
 104 
 105     @BindView(R.id.start_gif)
 106     Button startGif;
 107 
 108     @BindView(R.id.stop_gif)
 109     Button stopGif;
 110 
 111     @BindView(R.id.loadingView)
 112     View loadingView;
 113 
 114     private int type = 0;
 115 
 116     private int backupRendType;
 117 
 118     private float deep = 0.8f;
 119 
 120     private String url = &quot;https://res.exexm.com/cw_145225549855002&quot;;
 121 
 122     //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 123     //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 124 
 125     private Timer timer = new Timer();
 126 
 127     private TaskLocal mTimerTask;
 128 
 129     private TaskLocal2 mTimerTask2;
 130 
 131     private GSYVideoGLViewCustomRender mGSYVideoGLViewCustomRender;
 132 
 133     private BitmapIconEffect mCustomBitmapIconEffect;
 134 
 135     private int percentage = 1;
 136 
 137     private int percentageType = 1;
 138 
 139     private boolean moveBitmap = false;
 140 
 141     private GifCreateHelper mGifCreateHelper;
 142 
 143     @Override
 144     protected void onCreate(Bundle savedInstanceState) {
 145         super.onCreate(savedInstanceState);
 146         setContentView(R.layout.activity_detail_filter);
 147         ButterKnife.bind(this);
 148         backupRendType = GSYVideoType.getRenderType();
 149         // 设置为GL播放模式，才能支持滤镜，注意此设置是全局的
 150         GSYVideoType.setRenderType(GSYVideoType.GLSURFACE);
 151         resolveNormalVideoUI();
 152         initVideoBuilderMode();
 153         initGifHelper();
 154         detailPlayer.setLockClickListener(new LockClickListener() {
 155             @Override
 156             public void onClick(View view, boolean lock) {
 157                 if (orientationUtils != null) {
 158                     // 配合下方的onConfigurationChanged
 159                     orientationUtils.setEnable(!lock);
 160                 }
 161             }
 162         });
 163         // 自定义render需要在播放器开始播放之前，播放过程中不允许切换render
 164         // 水印图效果
 165         /* Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher);
 166         mGSYVideoGLViewCustomRender = new GSYVideoGLViewCustomRender();
 167         mCustomBitmapIconEffect = new BitmapIconEffect(bitmap, dp2px(50), dp2px(50), 0.6f);
 168         mGSYVideoGLViewCustomRender.setBitmapEffect(mCustomBitmapIconEffect);
 169         detailPlayer.setCustomGLRenderer(mGSYVideoGLViewCustomRender);
 170         detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 171          */
 172         // 多窗口播放效果
 173         // detailPlayer.setEffectFilter(new GammaEffect(0.8f));
 174         // detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender2());
 175         // 图片穿孔透视播放
 176         // detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender3());
 177         // 高斯拉伸视频铺满背景，替换黑色，前台正常比例播放
 178         // detailPlayer.setEffectFilter(new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY));
 179         // detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender4());
 180         // detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 181         changeFilter.setOnClickListener(new View.OnClickListener() {
 182             @Override
 183             public void onClick(View v) {
 184                 resolveTypeUI();
 185             }
 186         });
 187         // 使用GL播放的话，用这种方式可以解决退出全屏黑屏的问题
 188         detailPlayer.setBackFromFullScreenListener(new View.OnClickListener() {
 189             @Override
 190             public void onClick(View v) {
 191                 DetailFilterActivity.this.onBackPressed();
 192             }
 193         });
 194         jump.setOnClickListener(new View.OnClickListener() {
 195             @Override
 196             public void onClick(View v) {
 197                 //shotImage(v);
 198                 //JumpUtils.gotoControl(DetailFilterActivity.this);
 199                 //startActivity(new Intent(DetailControlActivity.this, MainActivity.class));
<abbr title=" 200                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivity.this, v);"> 200                 DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivi🔵</abbr>
 201             }
 202         });
 203         anima.setOnClickListener(new View.OnClickListener() {
 204             @Override
 205             public void onClick(View v) {
 206                 // 画面旋转
 207                 cancelTask();
 208                 mTimerTask = new TaskLocal();
 209                 timer.schedule(mTimerTask, 0, 50);
 210                 percentageType++;
 211                 if (percentageType &gt; 4) {
 212                     percentageType = 1;
 213                 }
 214                 // 水印图动起来
 215                 // cancelTask2();
 216                 // mTimerTask2 = new TaskLocal2();
 217                 // timer.schedule(mTimerTask2, 0, 400);
 218                 // moveBitmap = !moveBitmap;
 219             }
 220         });
 221         startGif.setOnClickListener(new View.OnClickListener() {
 222             @Override
 223             public void onClick(View v) {
<abbr title=" 224                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivity.this);"> 224                 DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivit🔵</abbr>
 225             }
 226         });
 227         stopGif.setOnClickListener(new View.OnClickListener() {
 228             @Override
 229             public void onClick(View v) {
 230                 stopGif();
 231             }
 232         });
 233         loadingView.setOnClickListener(new View.OnClickListener() {
 234             @Override
 235             public void onClick(View v) {
 236                 // do nothing
 237             }
 238         });
 239     }
 240 
 241     @Override
 242     public StandardGSYVideoPlayer getGSYVideoPlayer() {
 243         return detailPlayer;
 244     }
 245 
 246     @Override
 247     public GSYVideoOptionBuilder getGSYVideoOptionBuilder() {
 248         //内置封面可参考SampleCoverVideo
 249         ImageView imageView = new ImageView(this);
 250         loadCover(imageView, url);
 251         return new GSYVideoOptionBuilder()
 252                 .setThumbImageView(imageView)
 253                 .setUrl(url)
 254                 .setCacheWithPlay(true)
 255                 .setVideoTitle(&quot; &quot;)
 256                 .setIsTouchWiget(true)
 257                 .setRotateViewAuto(false)
 258                 .setLockLand(false)
 259                 .setShowFullAnimation(false)
 260                 .setNeedLockFull(true)
 261                 .setSeekRatio(1);
 262     }
 263 
 264     @Override
 265     public void clickForFullScreen() {
 266 
 267     }
 268 
 269     /**
 270      * 是否启动旋转横屏，true表示启动
 271      * @return true
 272      */
 273     @Override
 274     public boolean getDetailOrientationRotateAuto() {
 275         return true;
 276     }
 277 
 278     @Override
 279     protected void onDestroy() {
 280         super.onDestroy();
 281         //恢复到原本的绘制模式
 282         GSYVideoType.setRenderType(backupRendType);
 283         cancelTask();
 284     }
 285 
 286     /**
 287      * 视频截图
 288      */
 289     @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 290     void shotImage(final View v) {
 291         // 获取截图
 292         detailPlayer.taskShotPic(new GSYVideoShotListener() {
 293             @Override
 294             public void getBitmap(Bitmap bitmap) {
 295                 if (bitmap != null) {
 296                     try {
 297                         CommonUtil.saveBitmap(bitmap);
 298                     } catch (FileNotFoundException e) {
 299                         showToast(&quot;save fail &quot;);
 300                         e.printStackTrace();
 301                         return;
 302                     }
 303                     showToast(&quot;save success &quot;);
 304                 } else {
 305                     showToast(&quot;get bitmap fail &quot;);
 306                 }
 307             }
 308         });
 309     }
 310 
 311     private void initGifHelper() {
 312         mGifCreateHelper = new GifCreateHelper(detailPlayer, new GSYVideoGifSaveListener() {
 313             @Override
 314             public void result(boolean success, File file) {
 315                 detailPlayer.post(new Runnable() {
 316                     @Override
 317                     public void run() {
 318                         loadingView.setVisibility(View.GONE);
 319                         Toast.makeText(detailPlayer.getContext(), &quot;创建成功&quot;, Toast.LENGTH_LONG).show();
 320                     }
 321                 });
 322             }
 323 
 324             @Override
 325             public void process(int curPosition, int total) {
 326                 Debuger.printfError(&quot; current &quot; + curPosition + &quot; total &quot; + total);
 327             }
 328         });
 329     }
 330 
 331     /**
 332      * 开始gif截图
 333      */
 334     @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 335     void startGif() {
 336         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();
 337         // 开始缓存各个帧
 338         mGifCreateHelper.startGif(new File(FileUtils.getPath()));
 339     }
 340 
 341     /**
 342      * 生成gif
 343      */
 344     private void stopGif() {
 345         Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();
 346         loadingView.setVisibility(View.VISIBLE);
<abbr title=" 347         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), (&quot;GSY-Z-&quot; + System.currentTimeMillis()) + &quot;.gif&quot;));"> 347         mGifCreateHelper.stopGif(new File(FileUtils.getPath(), (&quot;GSY-Z-&quot; + System.currentTimeMillis()) + 🔵</abbr>
 348     }
 349 
 350     /**
 351      * 加载第三秒的帧数作为封面
 352      */
 353     private void loadCover(ImageView imageView, String url) {
 354 
 355         imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
 356         imageView.setImageResource(R.mipmap.xxx1);
 357 
 358         Glide.with(this.getApplicationContext())
 359                 .setDefaultRequestOptions(
 360                         new RequestOptions()
 361                                 .frame(3000000)
 362                                 .centerCrop()
 363                                 .error(R.mipmap.xxx2)
 364                                 .placeholder(R.mipmap.xxx1))
 365                 .load(url)
 366                 .into(imageView);
 367     }
 368 
 369     private void resolveNormalVideoUI() {
 370         //增加title
 371         detailPlayer.getTitleTextView().setVisibility(View.GONE);
 372         detailPlayer.getBackButton().setVisibility(View.GONE);
 373     }
 374 
 375     /**
 376      * 切换滤镜
 377      */
 378     private void resolveTypeUI() {
 379         GSYVideoGLView.ShaderInterface effect = new NoEffect();
 380         switch (type) {
 381             case 0:
 382                 effect = new AutoFixEffect(deep);
 383                 break;
 384             case 1:
 385                 effect = new PixelationEffect();
 386                 break;
 387             case 2:
 388                 effect = new BlackAndWhiteEffect();
 389                 break;
 390             case 3:
 391                 effect = new ContrastEffect(deep);
 392                 break;
 393             case 4:
 394                 effect = new CrossProcessEffect();
 395                 break;
 396             case 5:
 397                 effect = new DocumentaryEffect();
 398                 break;
 399             case 6:
 400                 effect = new DuotoneEffect(Color.BLUE, Color.YELLOW);
 401                 break;
 402             case 7:
 403                 effect = new FillLightEffect(deep);
 404                 break;
 405             case 8:
 406                 effect = new GammaEffect(deep);
 407                 break;
 408             case 9:
 409                 effect = new GrainEffect(deep);
 410                 break;
 411             case 10:
 412                 effect = new GrainEffect(deep);
 413                 break;
 414             case 11:
 415                 effect = new HueEffect(deep);
 416                 break;
 417             case 12:
 418                 effect = new InvertColorsEffect();
 419                 break;
 420             case 13:
 421                 effect = new LamoishEffect();
 422                 break;
 423             case 14:
 424                 effect = new PosterizeEffect();
 425                 break;
 426             case 15:
 427                 effect = new BarrelBlurEffect();
 428                 break;
 429             case 16:
 430                 effect = new SaturationEffect(deep);
 431                 break;
 432             case 17:
 433                 effect = new SepiaEffect();
 434                 break;
 435             case 18:
 436                 effect = new SharpnessEffect(deep);
 437                 break;
 438             case 19:
 439                 effect = new TemperatureEffect(deep);
 440                 break;
 441             case 20:
 442                 effect = new TintEffect(Color.GREEN);
 443                 break;
 444             case 21:
 445                 effect = new VignetteEffect(deep);
 446                 break;
 447             case 22:
 448                 effect = new NoEffect();
 449                 break;
 450             case 23:
 451                 effect = new OverlayEffect();
 452                 break;
 453             case 24:
 454                 effect = new SampleBlurEffect(4.0f);
 455                 break;
 456             case 25:
 457                 effect = new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY);
 458                 break;
 459             case 26:
 460                 effect = new BrightnessEffect(deep);
 461                 break;
 462         }
 463         detailPlayer.setEffectFilter(effect);
 464         type++;
 465         if (type &gt; 25) {
 466             type = 0;
 467         }
 468     }
 469 
 470     private void cancelTask2() {
 471         if (mTimerTask2 != null) {
 472             mTimerTask2.cancel();
 473             mTimerTask2 = null;
 474         }
 475     }
 476 
 477     private void cancelTask() {
 478         if (mTimerTask != null) {
 479             mTimerTask.cancel();
 480             mTimerTask = null;
 481         }
 482     }
 483 
 484     /**
 485      * 水印图动起来,播放前开始会崩溃哟
 486      */
 487     private class TaskLocal2 extends TimerTask {
 488         @Override
 489         public void run() {
 490             float[] transform = new float[16];
 491             // 旋转到正常角度
 492             Matrix.setRotateM(transform, 0, 180.0F, 0.0F, 0, 1.0F);
 493             // 调整大小比例
<abbr title=" 494             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 1);"> 494             Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getS🔵</abbr>
 495             if (moveBitmap) {
 496                 // 调整位置
<abbr title=" 497                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.getPositionY(), 0.0F);"> 497                 Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIcon🔵</abbr>
 498             } else {
 499                 float maxX = mCustomBitmapIconEffect.getMaxPositionX();
 500                 float minX = mCustomBitmapIconEffect.getMinPositionX();
 501                 float maxY = mCustomBitmapIconEffect.getMaxPositionY();
 502                 float minY = mCustomBitmapIconEffect.getMinPositionY();
 503                 float x = (((float) (Math.random())) * (maxX - minX)) + minX;
 504                 float y = (((float) (Math.random())) * (maxY - minY)) + minY;
 505                 // 调整位置
 506                 Matrix.translateM(transform, 0, x, y, 0.0F);
 507                 mGSYVideoGLViewCustomRender.setCurrentMVPMatrix(transform);
 508             }
 509         }
 510     }
 511 
 512     /**
 513      * 设置GLRender的VertexShader的transformMatrix
 514      * 注意，这是android.opengl.Matrix
 515      */
 516     private class TaskLocal extends TimerTask {
 517         @Override
 518         public void run() {
 519             float[] transform = new float[16];
 520             switch (percentageType) {
 521                 case 1 :
 522                     // 给予x变化
 523                     Matrix.setRotateM(transform, 0, (360 * percentage) / 100, 1.0F, 0, 0.0F);
 524                     break;
 525                 case 2 :
 526                     // 给予y变化
 527                     Matrix.setRotateM(transform, 0, (360 * percentage) / 100, 0.0F, 1.0F, 0.0F);
 528                     break;
 529                 case 3 :
 530                     // 给予z变化
 531                     Matrix.setRotateM(transform, 0, (360 * percentage) / 100, 0.0F, 0, 1.0F);
 532                     break;
 533                 case 4 :
 534                     Matrix.setRotateM(transform, 0, 360, 0.0F, 0, 1.0F);
 535                     break;
 536             }
 537             // 设置渲染transform
 538             detailPlayer.setMatrixGL(transform);
 539             percentage++;
 540             if (percentage &gt; 100) {
 541                 percentage = 1;
 542             }
 543         }
 544     }
 545 
 546     private int dp2px(int dp) {
 547         return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
 548                 getResources().getDisplayMetrics());
 549     }
 550 
 551     private void showToast(final String tip) {
 552         detailPlayer.post(new Runnable() {
 553             @Override
 554             public void run() {
 555                 Toast.makeText(DetailFilterActivity.this, tip, Toast.LENGTH_LONG).show();
 556             }
 557         });
 558     }
 559 
 560     @OnShowRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 561     void showRationaleForCamera(final PermissionRequest request) {
 562         new AlertDialog.Builder(this)
 563                 .setMessage(&quot;快给我权限&quot;)
 564                 .setPositiveButton(&quot;允许&quot;, new DialogInterface.OnClickListener() {
 565                     @Override
 566                     public void onClick(DialogInterface dialog, int which) {
 567                         request.proceed();
 568                     }
 569                 })
 570                 .setNegativeButton(&quot;拒绝&quot;, new DialogInterface.OnClickListener() {
 571                     @Override
 572                     public void onClick(DialogInterface dialog, int which) {
 573                         request.cancel();
 574                     }
 575                 })
 576                 .show();
 577     }
 578 
 579     @OnPermissionDenied(Manifest.permission.WRITE_EXTERNAL_STORAGE)
 580     void showDeniedForCamera() {
 581         Toast.makeText(this, &quot;没有权限啊&quot;, Toast.LENGTH_SHORT).show();
 582     }
 583 
 584     @OnNeverAskAgain(Manifest.permission.CAMERA)
 585     void showNeverAskForCamera() {
 586         Toast.makeText(this, &quot;再次授权&quot;, Toast.LENGTH_SHORT).show();
 587     }
 588 
 589     @Override
<abbr title=" 590     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {"> 590     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[]🔵</abbr>
 591         super.onRequestPermissionsResult(requestCode, permissions, grantResults);
 592         // NOTE: delegate the permission handling to generated method
<abbr title=" 593         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);"> 593         DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResu🔵</abbr>
 594     }
 595 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.example.gsyvideoplayer;
   2  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import android.Manifest;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import android.app.AlertDialog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import android.content.DialogInterface;</span>
   6  import android.graphics.Bitmap;
   7  import android.graphics.BitmapFactory;
   8  import android.graphics.Color;
   9  import android.opengl.Matrix;
  10  import android.os.Bundle;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import android.support.annotation.NonNull;</span>
  12  import android.support.v4.widget.NestedScrollView;
  13  import android.util.TypedValue;
  14  import android.view.View;
  15  import android.widget.Button;
  16  import android.widget.ImageView;
  17  import android.widget.RelativeLayout;
  18  import android.widget.Toast;
  19  
  20  import com.bumptech.glide.Glide;
  21  import com.bumptech.glide.request.RequestOptions;
  22  import com.example.gsyvideoplayer.effect.BitmapIconEffect;
  23  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender;
  24  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender2;
  25  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender4;
  26  import com.example.gsyvideoplayer.effect.PixelationEffect;
  27  import com.example.gsyvideoplayer.utils.CommonUtil;
  28  import com.example.gsyvideoplayer.video.SampleControlVideo;
  29  import com.shuyu.gsyvideoplayer.GSYBaseActivityDetail;
  30  import com.shuyu.gsyvideoplayer.listener.GSYVideoGifSaveListener;
  31  import com.shuyu.gsyvideoplayer.render.view.GSYVideoGLView;
  32  import com.shuyu.gsyvideoplayer.builder.GSYVideoOptionBuilder;
  33  import com.shuyu.gsyvideoplayer.render.effect.AutoFixEffect;
  34  import com.shuyu.gsyvideoplayer.render.effect.BarrelBlurEffect;
  35  import com.shuyu.gsyvideoplayer.render.effect.BlackAndWhiteEffect;
  36  import com.shuyu.gsyvideoplayer.render.effect.BrightnessEffect;
  37  import com.shuyu.gsyvideoplayer.render.effect.ContrastEffect;
  38  import com.shuyu.gsyvideoplayer.render.effect.CrossProcessEffect;
  39  import com.shuyu.gsyvideoplayer.render.effect.DocumentaryEffect;
  40  import com.shuyu.gsyvideoplayer.render.effect.DuotoneEffect;
  41  import com.shuyu.gsyvideoplayer.render.effect.FillLightEffect;
  42  import com.shuyu.gsyvideoplayer.render.effect.GammaEffect;
  43  import com.shuyu.gsyvideoplayer.render.effect.GaussianBlurEffect;
  44  import com.shuyu.gsyvideoplayer.render.effect.GrainEffect;
  45  import com.shuyu.gsyvideoplayer.render.effect.HueEffect;
  46  import com.shuyu.gsyvideoplayer.render.effect.InvertColorsEffect;
  47  import com.shuyu.gsyvideoplayer.render.effect.LamoishEffect;
  48  import com.shuyu.gsyvideoplayer.render.effect.NoEffect;
  49  import com.shuyu.gsyvideoplayer.render.effect.OverlayEffect;
  50  import com.shuyu.gsyvideoplayer.render.effect.PosterizeEffect;
  51  import com.shuyu.gsyvideoplayer.render.effect.SampleBlurEffect;
  52  import com.shuyu.gsyvideoplayer.render.effect.SaturationEffect;
  53  import com.shuyu.gsyvideoplayer.render.effect.SepiaEffect;
  54  import com.shuyu.gsyvideoplayer.render.effect.SharpnessEffect;
  55  import com.shuyu.gsyvideoplayer.render.effect.TemperatureEffect;
  56  import com.shuyu.gsyvideoplayer.render.effect.TintEffect;
  57  import com.shuyu.gsyvideoplayer.render.effect.VignetteEffect;
  58  import com.shuyu.gsyvideoplayer.listener.GSYVideoShotListener;
  59  import com.shuyu.gsyvideoplayer.listener.LockClickListener;
  60  import com.shuyu.gsyvideoplayer.utils.Debuger;
  61  import com.shuyu.gsyvideoplayer.utils.FileUtils;
  62  import com.shuyu.gsyvideoplayer.utils.GSYVideoType;
  63  import com.shuyu.gsyvideoplayer.utils.GifCreateHelper;
  64  import com.shuyu.gsyvideoplayer.video.StandardGSYVideoPlayer;
  65  import com.shuyu.gsyvideoplayer.video.base.GSYBaseVideoPlayer;
  66  
  67  import java.io.File;
  68  import java.io.FileNotFoundException;
  69  import java.util.Timer;
  70  import java.util.TimerTask;
  71  
  72  import butterknife.BindView;
  73  import butterknife.ButterKnife;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +import permissions.dispatcher.NeedsPermission;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +import permissions.dispatcher.OnNeverAskAgain;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +import permissions.dispatcher.OnPermissionDenied;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +import permissions.dispatcher.OnShowRationale;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +import permissions.dispatcher.PermissionRequest;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +import permissions.dispatcher.RuntimePermissions;</span>
  80  
  81  /**
  82   * 滤镜
  83   * Activity可以继承GSYBaseActivityDetail实现详情模式的页面
  84   * 或者参考DetailPlayer、DetailListPlayer实现
  85   * Created by guoshuyu on 2017/6/18.
  86   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +@RuntimePermissions</span>
  89  public class DetailFilterActivity extends GSYBaseActivityDetail&lt;StandardGSYVideoPlayer&gt; {
  90  
  91      @BindView(R.id.post_detail_nested_scroll)
  92      NestedScrollView postDetailNestedScroll;
  93  
  94      @BindView(R.id.detail_player)
  95      SampleControlVideo detailPlayer;
  96  
  97      @BindView(R.id.activity_detail_player)
  98      RelativeLayout activityDetailPlayer;
  99  
 100      @BindView(R.id.change_filter)
 101      Button changeFilter;
 102  
 103  
 104      @BindView(R.id.jump)
 105      Button jump;
 106  
 107      @BindView(R.id.change_anima)
 108      Button anima;
 109  
 110      @BindView(R.id.start_gif)
 111      Button startGif;
 112  
 113      @BindView(R.id.stop_gif)
 114      Button stopGif;
 115  
 116      @BindView(R.id.loadingView)
 117      View loadingView;
 118  
 119      private int type = 0;
 120  
 121      private int backupRendType;
 122  
 123      private float deep = 0.8f;
 124  
 125      private String url = &quot;https://res.exexm.com/cw_145225549855002&quot;;
 126      //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 127  
 128      private Timer timer = new Timer();
 129  
 130      private TaskLocal mTimerTask;
 131  
 132      private TaskLocal2 mTimerTask2;
 133  
 134      private GSYVideoGLViewCustomRender mGSYVideoGLViewCustomRender;
 135  
 136      private BitmapIconEffect mCustomBitmapIconEffect;
 137  
 138      private int percentage = 1;
 139  
 140      private int percentageType = 1;
 141  
 142      private boolean moveBitmap = false;
 143  
 144      private GifCreateHelper mGifCreateHelper;
 145  
 146      @Override
 147      protected void onCreate(Bundle savedInstanceState) {
 148          super.onCreate(savedInstanceState);
 149          setContentView(R.layout.activity_detail_filter);
 150          ButterKnife.bind(this);
 151  
 152          backupRendType = GSYVideoType.getRenderType();
 153  
 154          //设置为GL播放模式，才能支持滤镜，注意此设置是全局的
 155          GSYVideoType.setRenderType(GSYVideoType.GLSURFACE);
 156  
 157          resolveNormalVideoUI();
 158  
 159          initVideoBuilderMode();
 160  
 161          initGifHelper();
 162  
 163          detailPlayer.setLockClickListener(new LockClickListener() {
 164              @Override
 165              public void onClick(View view, boolean lock) {
 166                  if (orientationUtils != null) {
 167                      //配合下方的onConfigurationChanged
 168                      orientationUtils.setEnable(!lock);
 169                  }
 170              }
 171          });
 172  
 173  
 174          //自定义render需要在播放器开始播放之前，播放过程中不允许切换render
 175  
 176          //水印图效果
 177          /*Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher);
 178          mGSYVideoGLViewCustomRender = new GSYVideoGLViewCustomRender();
 179          mCustomBitmapIconEffect = new BitmapIconEffect(bitmap, dp2px(50), dp2px(50), 0.6f);
 180          mGSYVideoGLViewCustomRender.setBitmapEffect(mCustomBitmapIconEffect);
 181          detailPlayer.setCustomGLRenderer(mGSYVideoGLViewCustomRender);
 182          detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);*/
 183  
 184          //多窗口播放效果
 185          //detailPlayer.setEffectFilter(new GammaEffect(0.8f));
 186          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender2());
 187  
 188          //图片穿孔透视播放
 189          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender3());
 190  
 191          //高斯拉伸视频铺满背景，替换黑色，前台正常比例播放
 192          //detailPlayer.setEffectFilter(new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY));
 193          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender4());
 194          //detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 195  
 196          changeFilter.setOnClickListener(new View.OnClickListener() {
 197              @Override
 198              public void onClick(View v) {
 199                  resolveTypeUI();
 200              }
 201          });
 202  
 203          //使用GL播放的话，用这种方式可以解决退出全屏黑屏的问题
 204          detailPlayer.setBackFromFullScreenListener(new View.OnClickListener() {
 205              @Override
 206              public void onClick(View v) {
 207                  DetailFilterActivity.this.onBackPressed();
 208              }
 209          });
 210  
 211  
 212          jump.setOnClickListener(new View.OnClickListener() {
 213              @Override
 214              public void onClick(View v) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                shotImage(v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                //shotImage(v);</span>
 217                  //JumpUtils.gotoControl(DetailFilterActivity.this);
 218                  //startActivity(new Intent(DetailControlActivity.this, MainActivity.class));
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 220 +                DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivity.this, v);"> 220 +                DetailFilterActivityPermissionsDispatcher.shotImageWithPermissionCheck(DetailFilterActivity.this, 🔵</abbr></span>
 221              }
 222          });
 223  
 224          anima.setOnClickListener(new View.OnClickListener() {
 225              @Override
 226              public void onClick(View v) {
 227                  //画面旋转
 228                  cancelTask();
 229                  mTimerTask = new TaskLocal();
 230                  timer.schedule(mTimerTask, 0, 50);
 231                  percentageType++;
 232                  if (percentageType &gt; 4) {
 233                      percentageType = 1;
 234                  }
 235                  //水印图动起来
 236                  //cancelTask2();
 237                  //mTimerTask2 = new TaskLocal2();
 238                  //timer.schedule(mTimerTask2, 0, 400);
 239  
 240                  //moveBitmap = !moveBitmap;
 241              }
 242          });
 243  
 244  
 245          startGif.setOnClickListener(new View.OnClickListener() {
 246              @Override
 247              public void onClick(View v) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                startGif();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                DetailFilterActivityPermissionsDispatcher.startGifWithPermissionCheck(DetailFilterActivity.this);</span>
 250              }
 251          });
 252  
 253          stopGif.setOnClickListener(new View.OnClickListener() {
 254              @Override
 255              public void onClick(View v) {
 256                  stopGif();
 257              }
 258          });
 259  
 260          loadingView.setOnClickListener(new View.OnClickListener() {
 261              @Override
 262              public void onClick(View v) {
 263                  //do nothing
 264              }
 265          });
 266      }
 267  
 268      @Override
 269      public StandardGSYVideoPlayer getGSYVideoPlayer() {
 270          return detailPlayer;
 271      }
 272  
 273      @Override
 274      public GSYVideoOptionBuilder getGSYVideoOptionBuilder() {
 275          //内置封面可参考SampleCoverVideo
 276          ImageView imageView = new ImageView(this);
 277          loadCover(imageView, url);
 278          return new GSYVideoOptionBuilder()
 279                  .setThumbImageView(imageView)
 280                  .setUrl(url)
 281                  .setCacheWithPlay(true)
 282                  .setVideoTitle(&quot; &quot;)
 283                  .setIsTouchWiget(true)
 284                  .setRotateViewAuto(false)
 285                  .setLockLand(false)
 286                  .setShowFullAnimation(false)
 287                  .setNeedLockFull(true)
 288                  .setSeekRatio(1);
 289      }
 290  
 291      @Override
 292      public void clickForFullScreen() {
 293  
 294      }
 295  
 296      /**
 297       * 是否启动旋转横屏，true表示启动
 298       * @return true
 299       */
 300      @Override
 301      public boolean getDetailOrientationRotateAuto() {
 302          return true;
 303      }
 304  
 305      @Override
 306      protected void onDestroy() {
 307          super.onDestroy();
 308          //恢复到原本的绘制模式
 309          GSYVideoType.setRenderType(backupRendType);
 310          cancelTask();
 311      }
 312  
 313      /**
 314       * 视频截图
 315       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -    private void shotImage(final View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +    @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +    void shotImage(final View v) {</span>
 319          //获取截图
 320          detailPlayer.taskShotPic(new GSYVideoShotListener() {
 321              @Override
 322              public void getBitmap(Bitmap bitmap) {
 323                  if (bitmap != null) {
 324                      try {
 325                          CommonUtil.saveBitmap(bitmap);
 326                      } catch (FileNotFoundException e) {
 327                          showToast(&quot;save fail &quot;);
 328                          e.printStackTrace();
 329                          return;
 330                      }
 331                      showToast(&quot;save success &quot;);
 332                  } else {
 333                      showToast(&quot;get bitmap fail &quot;);
 334                  }
 335              }
 336          });
 337  
 338      }
 339  
 340  
 341  
 342      private void initGifHelper() {
 343          mGifCreateHelper = new GifCreateHelper(detailPlayer, new GSYVideoGifSaveListener() {
 344              @Override
 345              public void result(boolean success, File file) {
 346                  detailPlayer.post(new Runnable() {
 347                      @Override
 348                      public void run() {
 349                          loadingView.setVisibility(View.GONE);
 350                          Toast.makeText(detailPlayer.getContext(), &quot;创建成功&quot;, Toast.LENGTH_LONG).show();
 351                      }
 352                  });
 353              }
 354  
 355              @Override
 356              public void process(int curPosition, int total) {
 357                  Debuger.printfError(&quot; current &quot; + curPosition + &quot; total &quot; + total);
 358              }
 359          });
 360      }
 361  
 362  
 363      /**
 364       * 开始gif截图
 365       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -    private void startGif() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +    @NeedsPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +    void startGif() {</span>
 369          //开始缓存各个帧
 370          mGifCreateHelper.startGif(new File(FileUtils.getPath()));
 371  
 372      }
 373  
 374      /**
 375       * 生成gif
 376       */
 377      private void stopGif() {

 378          loadingView.setVisibility(View.VISIBLE);
 379          mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.gif&quot;));
 380      }
 381  
 382      /**
 383       * 加载第三秒的帧数作为封面
 384       */
 385      private void loadCover(ImageView imageView, String url) {
 386  
 387          imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
 388          imageView.setImageResource(R.mipmap.xxx1);
 389  
 390          Glide.with(this.getApplicationContext())
 391                  .setDefaultRequestOptions(
 392                          new RequestOptions()
 393                                  .frame(3000000)
 394                                  .centerCrop()
 395                                  .error(R.mipmap.xxx2)
 396                                  .placeholder(R.mipmap.xxx1))
 397                  .load(url)
 398                  .into(imageView);
 399      }
 400  
 401      private void resolveNormalVideoUI() {
 402          //增加title
 403          detailPlayer.getTitleTextView().setVisibility(View.GONE);
 404          detailPlayer.getBackButton().setVisibility(View.GONE);
 405      }
 406  
 407      /**
 408       * 切换滤镜
 409       */
 410      private void resolveTypeUI() {
 411          GSYVideoGLView.ShaderInterface effect = new NoEffect();
 412          switch (type) {
 413              case 0:
 414                  effect = new AutoFixEffect(deep);
 415                  break;
 416              case 1:
 417                  effect = new PixelationEffect();
 418                  break;
 419              case 2:
 420                  effect = new BlackAndWhiteEffect();
 421                  break;
 422              case 3:
 423                  effect = new ContrastEffect(deep);
 424                  break;
 425              case 4:
 426                  effect = new CrossProcessEffect();
 427                  break;
 428              case 5:
 429                  effect = new DocumentaryEffect();
 430                  break;
 431              case 6:
 432                  effect = new DuotoneEffect(Color.BLUE, Color.YELLOW);
 433                  break;
 434              case 7:
 435                  effect = new FillLightEffect(deep);
 436                  break;
 437              case 8:
 438                  effect = new GammaEffect(deep);
 439                  break;
 440              case 9:
 441                  effect = new GrainEffect(deep);
 442                  break;
 443              case 10:
 444                  effect = new GrainEffect(deep);
 445                  break;
 446              case 11:
 447                  effect = new HueEffect(deep);
 448                  break;
 449              case 12:
 450                  effect = new InvertColorsEffect();
 451                  break;
 452              case 13:
 453                  effect = new LamoishEffect();
 454                  break;
 455              case 14:
 456                  effect = new PosterizeEffect();
 457                  break;
 458              case 15:
 459                  effect = new BarrelBlurEffect();
 460                  break;
 461              case 16:
 462                  effect = new SaturationEffect(deep);
 463                  break;
 464              case 17:
 465                  effect = new SepiaEffect();
 466                  break;
 467              case 18:
 468                  effect = new SharpnessEffect(deep);
 469                  break;
 470              case 19:
 471                  effect = new TemperatureEffect(deep);
 472                  break;
 473              case 20:
 474                  effect = new TintEffect(Color.GREEN);
 475                  break;
 476              case 21:
 477                  effect = new VignetteEffect(deep);
 478                  break;
 479              case 22:
 480                  effect = new NoEffect();
 481                  break;
 482              case 23:
 483                  effect = new OverlayEffect();
 484                  break;
 485              case 24:
 486                  effect = new SampleBlurEffect(4.0f);
 487                  break;
 488              case 25:
 489                  effect = new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY);
 490                  break;
 491              case 26:
 492                  effect = new BrightnessEffect(deep);
 493                  break;
 494          }
 495          detailPlayer.setEffectFilter(effect);
 496          type++;
 497          if (type &gt; 25) {
 498              type = 0;
 499          }
 500      }
 501  
 502  
 503      private void cancelTask2() {
 504          if (mTimerTask2 != null) {
 505              mTimerTask2.cancel();
 506              mTimerTask2 = null;
 507          }
 508      }
 509  
 510      private void cancelTask() {
 511          if (mTimerTask != null) {
 512              mTimerTask.cancel();
 513              mTimerTask = null;
 514          }
 515      }
 516  
 517  
 518      /**
 519       * 水印图动起来,播放前开始会崩溃哟
 520       */
 521      private class TaskLocal2 extends TimerTask {
 522          @Override
 523          public void run() {
 524              float[] transform = new float[16];
 525              //旋转到正常角度
 526              Matrix.setRotateM(transform, 0, 180f, 0.0f, 0, 1.0f);
 527              //调整大小比例
<abbr title=" 528              Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 1);"> 528              Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 🔵</abbr>
 529              if (moveBitmap) {
 530                  //调整位置
<abbr title=" 531                  Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.getPositionY(), 0f);"> 531                  Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.ge🔵</abbr>
 532              } else {
 533                  float maxX = mCustomBitmapIconEffect.getMaxPositionX();
 534                  float minX = mCustomBitmapIconEffect.getMinPositionX();
 535                  float maxY = mCustomBitmapIconEffect.getMaxPositionY();
 536                  float minY = mCustomBitmapIconEffect.getMinPositionY();
 537                  float x = (float) Math.random() * (maxX - minX) + minX;
 538                  float y = (float) Math.random() * (maxY - minY) + minY;
 539                  //调整位置
 540                  Matrix.translateM(transform, 0, x, y, 0f);
 541                  mGSYVideoGLViewCustomRender.setCurrentMVPMatrix(transform);
 542              }
 543          }
 544      }
 545  
 546  
 547      /**
 548       * 设置GLRender的VertexShader的transformMatrix
 549       * 注意，这是android.opengl.Matrix
 550       */
 551      private class TaskLocal extends TimerTask {
 552          @Override
 553          public void run() {
 554              float[] transform = new float[16];
 555              switch (percentageType) {
 556                  case 1:
 557                      //给予x变化
 558                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 1.0f, 0, 0.0f);
 559                      break;
 560                  case 2:
 561                      //给予y变化
 562                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 1.0f, 0.0f);
 563                      break;
 564                  case 3:
 565                      //给予z变化
 566                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 0, 1.0f);
 567                      break;
 568                  case 4:
 569                      Matrix.setRotateM(transform, 0, 360, 0.0f, 0, 1.0f);
 570                      break;
 571              }
 572              //设置渲染transform
 573              detailPlayer.setMatrixGL(transform);
 574              percentage++;
 575              if (percentage &gt; 100) {
 576                  percentage = 1;
 577              }
 578          }
 579      }
 580  
 581      private int dp2px(int dp) {
 582          return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
 583                  getResources().getDisplayMetrics());
 584      }
 585  
 586      private void showToast(final String tip) {
 587          detailPlayer.post(new Runnable() {
 588              @Override
 589              public void run() {
 590                  Toast.makeText(DetailFilterActivity.this, tip, Toast.LENGTH_LONG).show();
 591              }
 592          });
 593      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 594 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 595 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +    @OnShowRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 597 +    void showRationaleForCamera(final PermissionRequest request) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +        new AlertDialog.Builder(this)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +                .setMessage(&quot;快给我权限&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +                .setPositiveButton(&quot;允许&quot;, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +                    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +                    public void onClick(DialogInterface dialog, int which) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 603 +                        request.proceed();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 604 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +                })</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 606 +                .setNegativeButton(&quot;拒绝&quot;, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 607 +                    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 608 +                    public void onClick(DialogInterface dialog, int which) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 609 +                        request.cancel();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 610 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 611 +                })</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 612 +                .show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 613 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 614 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 615 +    @OnPermissionDenied(Manifest.permission.WRITE_EXTERNAL_STORAGE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 616 +    void showDeniedForCamera() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 617 +        Toast.makeText(this, &quot;没有权限啊&quot;, Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +    @OnNeverAskAgain(Manifest.permission.CAMERA)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +    void showNeverAskForCamera() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +        Toast.makeText(this, &quot;再次授权&quot;, Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 626 +    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {"> 626 +    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantRes🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +        super.onRequestPermissionsResult(requestCode, permissions, grantResults);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +        // NOTE: delegate the permission handling to generated method</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +        DetailFilterActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 630 +    }</span>
 631  }</pre></td>
                            <td><pre>   1  package com.example.gsyvideoplayer;
   2  



   3  import android.graphics.Bitmap;
   4  import android.graphics.BitmapFactory;
   5  import android.graphics.Color;
   6  import android.opengl.Matrix;
   7  import android.os.Bundle;

   8  import android.support.v4.widget.NestedScrollView;
   9  import android.util.TypedValue;
  10  import android.view.View;
  11  import android.widget.Button;
  12  import android.widget.ImageView;
  13  import android.widget.RelativeLayout;
  14  import android.widget.Toast;
  15  
  16  import com.bumptech.glide.Glide;
  17  import com.bumptech.glide.request.RequestOptions;
  18  import com.example.gsyvideoplayer.effect.BitmapIconEffect;
  19  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender;
  20  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender2;
  21  import com.example.gsyvideoplayer.effect.GSYVideoGLViewCustomRender4;
  22  import com.example.gsyvideoplayer.effect.PixelationEffect;
  23  import com.example.gsyvideoplayer.utils.CommonUtil;
  24  import com.example.gsyvideoplayer.video.SampleControlVideo;
  25  import com.shuyu.gsyvideoplayer.GSYBaseActivityDetail;
  26  import com.shuyu.gsyvideoplayer.listener.GSYVideoGifSaveListener;
  27  import com.shuyu.gsyvideoplayer.render.view.GSYVideoGLView;
  28  import com.shuyu.gsyvideoplayer.builder.GSYVideoOptionBuilder;
  29  import com.shuyu.gsyvideoplayer.render.effect.AutoFixEffect;
  30  import com.shuyu.gsyvideoplayer.render.effect.BarrelBlurEffect;
  31  import com.shuyu.gsyvideoplayer.render.effect.BlackAndWhiteEffect;
  32  import com.shuyu.gsyvideoplayer.render.effect.BrightnessEffect;
  33  import com.shuyu.gsyvideoplayer.render.effect.ContrastEffect;
  34  import com.shuyu.gsyvideoplayer.render.effect.CrossProcessEffect;
  35  import com.shuyu.gsyvideoplayer.render.effect.DocumentaryEffect;
  36  import com.shuyu.gsyvideoplayer.render.effect.DuotoneEffect;
  37  import com.shuyu.gsyvideoplayer.render.effect.FillLightEffect;
  38  import com.shuyu.gsyvideoplayer.render.effect.GammaEffect;
  39  import com.shuyu.gsyvideoplayer.render.effect.GaussianBlurEffect;
  40  import com.shuyu.gsyvideoplayer.render.effect.GrainEffect;
  41  import com.shuyu.gsyvideoplayer.render.effect.HueEffect;
  42  import com.shuyu.gsyvideoplayer.render.effect.InvertColorsEffect;
  43  import com.shuyu.gsyvideoplayer.render.effect.LamoishEffect;
  44  import com.shuyu.gsyvideoplayer.render.effect.NoEffect;
  45  import com.shuyu.gsyvideoplayer.render.effect.OverlayEffect;
  46  import com.shuyu.gsyvideoplayer.render.effect.PosterizeEffect;
  47  import com.shuyu.gsyvideoplayer.render.effect.SampleBlurEffect;
  48  import com.shuyu.gsyvideoplayer.render.effect.SaturationEffect;
  49  import com.shuyu.gsyvideoplayer.render.effect.SepiaEffect;
  50  import com.shuyu.gsyvideoplayer.render.effect.SharpnessEffect;
  51  import com.shuyu.gsyvideoplayer.render.effect.TemperatureEffect;
  52  import com.shuyu.gsyvideoplayer.render.effect.TintEffect;
  53  import com.shuyu.gsyvideoplayer.render.effect.VignetteEffect;
  54  import com.shuyu.gsyvideoplayer.listener.GSYVideoShotListener;
  55  import com.shuyu.gsyvideoplayer.listener.LockClickListener;
  56  import com.shuyu.gsyvideoplayer.utils.Debuger;
  57  import com.shuyu.gsyvideoplayer.utils.FileUtils;
  58  import com.shuyu.gsyvideoplayer.utils.GSYVideoType;
  59  import com.shuyu.gsyvideoplayer.utils.GifCreateHelper;
  60  import com.shuyu.gsyvideoplayer.video.StandardGSYVideoPlayer;
  61  import com.shuyu.gsyvideoplayer.video.base.GSYBaseVideoPlayer;
  62  
  63  import java.io.File;
  64  import java.io.FileNotFoundException;
  65  import java.util.Timer;
  66  import java.util.TimerTask;
  67  
  68  import butterknife.BindView;
  69  import butterknife.ButterKnife;






  70  
  71  /**
  72   * 滤镜
  73   * Activity可以继承GSYBaseActivityDetail实现详情模式的页面
  74   * 或者参考DetailPlayer、DetailListPlayer实现
  75   * Created by guoshuyu on 2017/6/18.
  76   */
  77  

  78  public class DetailFilterActivity extends GSYBaseActivityDetail&lt;StandardGSYVideoPlayer&gt; {
  79  
  80      @BindView(R.id.post_detail_nested_scroll)
  81      NestedScrollView postDetailNestedScroll;
  82  
  83      @BindView(R.id.detail_player)
  84      SampleControlVideo detailPlayer;
  85  
  86      @BindView(R.id.activity_detail_player)
  87      RelativeLayout activityDetailPlayer;
  88  
  89      @BindView(R.id.change_filter)
  90      Button changeFilter;
  91  
  92  
  93      @BindView(R.id.jump)
  94      Button jump;
  95  
  96      @BindView(R.id.change_anima)
  97      Button anima;
  98  
  99      @BindView(R.id.start_gif)
 100      Button startGif;
 101  
 102      @BindView(R.id.stop_gif)
 103      Button stopGif;
 104  
 105      @BindView(R.id.loadingView)
 106      View loadingView;
 107  
 108      private int type = 0;
 109  
 110      private int backupRendType;
 111  
 112      private float deep = 0.8f;
 113  
 114      private String url = &quot;https://res.exexm.com/cw_145225549855002&quot;;
 115      //private String url = &quot;http://9890.vod.myqcloud.com/9890_4e292f9a3dd011e6b4078980237cc3d3.f20.mp4&quot;;
 116  
 117      private Timer timer = new Timer();
 118  
 119      private TaskLocal mTimerTask;
 120  
 121      private TaskLocal2 mTimerTask2;
 122  
 123      private GSYVideoGLViewCustomRender mGSYVideoGLViewCustomRender;
 124  
 125      private BitmapIconEffect mCustomBitmapIconEffect;
 126  
 127      private int percentage = 1;
 128  
 129      private int percentageType = 1;
 130  
 131      private boolean moveBitmap = false;
 132  
 133      private GifCreateHelper mGifCreateHelper;
 134  
 135      @Override
 136      protected void onCreate(Bundle savedInstanceState) {
 137          super.onCreate(savedInstanceState);
 138          setContentView(R.layout.activity_detail_filter);
 139          ButterKnife.bind(this);
 140  
 141          backupRendType = GSYVideoType.getRenderType();
 142  
 143          //设置为GL播放模式，才能支持滤镜，注意此设置是全局的
 144          GSYVideoType.setRenderType(GSYVideoType.GLSURFACE);
 145  
 146          resolveNormalVideoUI();
 147  
 148          initVideoBuilderMode();
 149  
 150          initGifHelper();
 151  
 152          detailPlayer.setLockClickListener(new LockClickListener() {
 153              @Override
 154              public void onClick(View view, boolean lock) {
 155                  if (orientationUtils != null) {
 156                      //配合下方的onConfigurationChanged
 157                      orientationUtils.setEnable(!lock);
 158                  }
 159              }
 160          });
 161  
 162  
 163          //自定义render需要在播放器开始播放之前，播放过程中不允许切换render
 164  
 165          //水印图效果
 166          /*Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher);
 167          mGSYVideoGLViewCustomRender = new GSYVideoGLViewCustomRender();
 168          mCustomBitmapIconEffect = new BitmapIconEffect(bitmap, dp2px(50), dp2px(50), 0.6f);
 169          mGSYVideoGLViewCustomRender.setBitmapEffect(mCustomBitmapIconEffect);
 170          detailPlayer.setCustomGLRenderer(mGSYVideoGLViewCustomRender);
 171          detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);*/
 172  
 173          //多窗口播放效果
 174          //detailPlayer.setEffectFilter(new GammaEffect(0.8f));
 175          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender2());
 176  
 177          //图片穿孔透视播放
 178          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender3());
 179  
 180          //高斯拉伸视频铺满背景，替换黑色，前台正常比例播放
 181          //detailPlayer.setEffectFilter(new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY));
 182          //detailPlayer.setCustomGLRenderer(new GSYVideoGLViewCustomRender4());
 183          //detailPlayer.setGLRenderMode(GSYVideoGLView.MODE_RENDER_SIZE);
 184  
 185          changeFilter.setOnClickListener(new View.OnClickListener() {
 186              @Override
 187              public void onClick(View v) {
 188                  resolveTypeUI();
 189              }
 190          });
 191  
 192          //使用GL播放的话，用这种方式可以解决退出全屏黑屏的问题
 193          detailPlayer.setBackFromFullScreenListener(new View.OnClickListener() {
 194              @Override
 195              public void onClick(View v) {
 196                  DetailFilterActivity.this.onBackPressed();
 197              }
 198          });
 199  
 200  
 201          jump.setOnClickListener(new View.OnClickListener() {
 202              @Override
 203              public void onClick(View v) {
 204                  shotImage(v);

 205                  //JumpUtils.gotoControl(DetailFilterActivity.this);
 206                  //startActivity(new Intent(DetailControlActivity.this, MainActivity.class));


 207              }
 208          });
 209  
 210          anima.setOnClickListener(new View.OnClickListener() {
 211              @Override
 212              public void onClick(View v) {
 213                  //画面旋转
 214                  cancelTask();
 215                  mTimerTask = new TaskLocal();
 216                  timer.schedule(mTimerTask, 0, 50);
 217                  percentageType++;
 218                  if (percentageType &gt; 4) {
 219                      percentageType = 1;
 220                  }
 221                  //水印图动起来
 222                  //cancelTask2();
 223                  //mTimerTask2 = new TaskLocal2();
 224                  //timer.schedule(mTimerTask2, 0, 400);
 225  
 226                  //moveBitmap = !moveBitmap;
 227              }
 228          });
 229  
 230  
 231          startGif.setOnClickListener(new View.OnClickListener() {
 232              @Override
 233              public void onClick(View v) {
 234                  startGif();

 235              }
 236          });
 237  
 238          stopGif.setOnClickListener(new View.OnClickListener() {
 239              @Override
 240              public void onClick(View v) {
 241                  stopGif();
 242              }
 243          });
 244  
 245          loadingView.setOnClickListener(new View.OnClickListener() {
 246              @Override
 247              public void onClick(View v) {
 248                  //do nothing
 249              }
 250          });
 251      }
 252  
 253      @Override
 254      public StandardGSYVideoPlayer getGSYVideoPlayer() {
 255          return detailPlayer;
 256      }
 257  
 258      @Override
 259      public GSYVideoOptionBuilder getGSYVideoOptionBuilder() {
 260          //内置封面可参考SampleCoverVideo
 261          ImageView imageView = new ImageView(this);
 262          loadCover(imageView, url);
 263          return new GSYVideoOptionBuilder()
 264                  .setThumbImageView(imageView)
 265                  .setUrl(url)
 266                  .setCacheWithPlay(true)
 267                  .setVideoTitle(&quot; &quot;)
 268                  .setIsTouchWiget(true)
 269                  .setRotateViewAuto(false)
 270                  .setLockLand(false)
 271                  .setShowFullAnimation(false)
 272                  .setNeedLockFull(true)
 273                  .setSeekRatio(1);
 274      }
 275  
 276      @Override
 277      public void clickForFullScreen() {
 278  
 279      }
 280  
 281      /**
 282       * 是否启动旋转横屏，true表示启动
 283       * @return true
 284       */
 285      @Override
 286      public boolean getDetailOrientationRotateAuto() {
 287          return true;
 288      }
 289  
 290      @Override
 291      protected void onDestroy() {
 292          super.onDestroy();
 293          //恢复到原本的绘制模式
 294          GSYVideoType.setRenderType(backupRendType);
 295          cancelTask();
 296      }
 297  
 298      /**
 299       * 视频截图
 300       */
 301      private void shotImage(final View v) {


 302          //获取截图
 303          detailPlayer.taskShotPic(new GSYVideoShotListener() {
 304              @Override
 305              public void getBitmap(Bitmap bitmap) {
 306                  if (bitmap != null) {
 307                      try {
 308                          CommonUtil.saveBitmap(bitmap);
 309                      } catch (FileNotFoundException e) {
 310                          showToast(&quot;save fail &quot;);
 311                          e.printStackTrace();
 312                          return;
 313                      }
 314                      showToast(&quot;save success &quot;);
 315                  } else {
 316                      showToast(&quot;get bitmap fail &quot;);
 317                  }
 318              }
 319          });
 320  
 321      }
 322  
 323  
 324  
 325      private void initGifHelper() {
 326          mGifCreateHelper = new GifCreateHelper(detailPlayer, new GSYVideoGifSaveListener() {
 327              @Override
 328              public void result(boolean success, File file) {
 329                  detailPlayer.post(new Runnable() {
 330                      @Override
 331                      public void run() {
 332                          loadingView.setVisibility(View.GONE);
 333                          Toast.makeText(detailPlayer.getContext(), &quot;创建成功&quot;, Toast.LENGTH_LONG).show();
 334                      }
 335                  });
 336              }
 337  
 338              @Override
 339              public void process(int curPosition, int total) {
 340                  Debuger.printfError(&quot; current &quot; + curPosition + &quot; total &quot; + total);
 341              }
 342          });
 343      }
 344  
 345  
 346      /**
 347       * 开始gif截图
 348       */
 349      private void startGif() {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();</span>

 351          //开始缓存各个帧
 352          mGifCreateHelper.startGif(new File(FileUtils.getPath()));
 353  
 354      }
 355  
 356      /**
 357       * 生成gif
 358       */
 359      private void stopGif() {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        Toast.makeText(this, &quot;项目里目前没做动态授权，需要你去做设置里授权文件读取哦&quot;, Toast.LENGTH_LONG).show();</span>
 361          loadingView.setVisibility(View.VISIBLE);
 362          mGifCreateHelper.stopGif(new File(FileUtils.getPath(), &quot;GSY-Z-&quot; + System.currentTimeMillis() + &quot;.gif&quot;));
 363      }
 364  
 365      /**
 366       * 加载第三秒的帧数作为封面
 367       */
 368      private void loadCover(ImageView imageView, String url) {
 369  
 370          imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
 371          imageView.setImageResource(R.mipmap.xxx1);
 372  
 373          Glide.with(this.getApplicationContext())
 374                  .setDefaultRequestOptions(
 375                          new RequestOptions()
 376                                  .frame(3000000)
 377                                  .centerCrop()
 378                                  .error(R.mipmap.xxx2)
 379                                  .placeholder(R.mipmap.xxx1))
 380                  .load(url)
 381                  .into(imageView);
 382      }
 383  
 384      private void resolveNormalVideoUI() {
 385          //增加title
 386          detailPlayer.getTitleTextView().setVisibility(View.GONE);
 387          detailPlayer.getBackButton().setVisibility(View.GONE);
 388      }
 389  
 390      /**
 391       * 切换滤镜
 392       */
 393      private void resolveTypeUI() {
 394          GSYVideoGLView.ShaderInterface effect = new NoEffect();
 395          switch (type) {
 396              case 0:
 397                  effect = new AutoFixEffect(deep);
 398                  break;
 399              case 1:
 400                  effect = new PixelationEffect();
 401                  break;
 402              case 2:
 403                  effect = new BlackAndWhiteEffect();
 404                  break;
 405              case 3:
 406                  effect = new ContrastEffect(deep);
 407                  break;
 408              case 4:
 409                  effect = new CrossProcessEffect();
 410                  break;
 411              case 5:
 412                  effect = new DocumentaryEffect();
 413                  break;
 414              case 6:
 415                  effect = new DuotoneEffect(Color.BLUE, Color.YELLOW);
 416                  break;
 417              case 7:
 418                  effect = new FillLightEffect(deep);
 419                  break;
 420              case 8:
 421                  effect = new GammaEffect(deep);
 422                  break;
 423              case 9:
 424                  effect = new GrainEffect(deep);
 425                  break;
 426              case 10:
 427                  effect = new GrainEffect(deep);
 428                  break;
 429              case 11:
 430                  effect = new HueEffect(deep);
 431                  break;
 432              case 12:
 433                  effect = new InvertColorsEffect();
 434                  break;
 435              case 13:
 436                  effect = new LamoishEffect();
 437                  break;
 438              case 14:
 439                  effect = new PosterizeEffect();
 440                  break;
 441              case 15:
 442                  effect = new BarrelBlurEffect();
 443                  break;
 444              case 16:
 445                  effect = new SaturationEffect(deep);
 446                  break;
 447              case 17:
 448                  effect = new SepiaEffect();
 449                  break;
 450              case 18:
 451                  effect = new SharpnessEffect(deep);
 452                  break;
 453              case 19:
 454                  effect = new TemperatureEffect(deep);
 455                  break;
 456              case 20:
 457                  effect = new TintEffect(Color.GREEN);
 458                  break;
 459              case 21:
 460                  effect = new VignetteEffect(deep);
 461                  break;
 462              case 22:
 463                  effect = new NoEffect();
 464                  break;
 465              case 23:
 466                  effect = new OverlayEffect();
 467                  break;
 468              case 24:
 469                  effect = new SampleBlurEffect(4.0f);
 470                  break;
 471              case 25:
 472                  effect = new GaussianBlurEffect(6.0f, GaussianBlurEffect.TYPEXY);
 473                  break;
 474              case 26:
 475                  effect = new BrightnessEffect(deep);
 476                  break;
 477          }
 478          detailPlayer.setEffectFilter(effect);
 479          type++;
 480          if (type &gt; 25) {
 481              type = 0;
 482          }
 483      }
 484  
 485  
 486      private void cancelTask2() {
 487          if (mTimerTask2 != null) {
 488              mTimerTask2.cancel();
 489              mTimerTask2 = null;
 490          }
 491      }
 492  
 493      private void cancelTask() {
 494          if (mTimerTask != null) {
 495              mTimerTask.cancel();
 496              mTimerTask = null;
 497          }
 498      }
 499  
 500  
 501      /**
 502       * 水印图动起来,播放前开始会崩溃哟
 503       */
 504      private class TaskLocal2 extends TimerTask {
 505          @Override
 506          public void run() {
 507              float[] transform = new float[16];
 508              //旋转到正常角度
 509              Matrix.setRotateM(transform, 0, 180f, 0.0f, 0, 1.0f);
 510              //调整大小比例
<abbr title=" 511              Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 1);"> 511              Matrix.scaleM(transform, 0, mCustomBitmapIconEffect.getScaleW(), mCustomBitmapIconEffect.getScaleH(), 🔵</abbr>
 512              if (moveBitmap) {
 513                  //调整位置
<abbr title=" 514                  Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.getPositionY(), 0f);"> 514                  Matrix.translateM(transform, 0, mCustomBitmapIconEffect.getPositionX(), mCustomBitmapIconEffect.ge🔵</abbr>
 515              } else {
 516                  float maxX = mCustomBitmapIconEffect.getMaxPositionX();
 517                  float minX = mCustomBitmapIconEffect.getMinPositionX();
 518                  float maxY = mCustomBitmapIconEffect.getMaxPositionY();
 519                  float minY = mCustomBitmapIconEffect.getMinPositionY();
 520                  float x = (float) Math.random() * (maxX - minX) + minX;
 521                  float y = (float) Math.random() * (maxY - minY) + minY;
 522                  //调整位置
 523                  Matrix.translateM(transform, 0, x, y, 0f);
 524                  mGSYVideoGLViewCustomRender.setCurrentMVPMatrix(transform);
 525              }
 526          }
 527      }
 528  
 529  
 530      /**
 531       * 设置GLRender的VertexShader的transformMatrix
 532       * 注意，这是android.opengl.Matrix
 533       */
 534      private class TaskLocal extends TimerTask {
 535          @Override
 536          public void run() {
 537              float[] transform = new float[16];
 538              switch (percentageType) {
 539                  case 1:
 540                      //给予x变化
 541                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 1.0f, 0, 0.0f);
 542                      break;
 543                  case 2:
 544                      //给予y变化
 545                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 1.0f, 0.0f);
 546                      break;
 547                  case 3:
 548                      //给予z变化
 549                      Matrix.setRotateM(transform, 0, 360 * percentage / 100, 0.0f, 0, 1.0f);
 550                      break;
 551                  case 4:
 552                      Matrix.setRotateM(transform, 0, 360, 0.0f, 0, 1.0f);
 553                      break;
 554              }
 555              //设置渲染transform
 556              detailPlayer.setMatrixGL(transform);
 557              percentage++;
 558              if (percentage &gt; 100) {
 559                  percentage = 1;
 560              }
 561          }
 562      }
 563  
 564      private int dp2px(int dp) {
 565          return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
 566                  getResources().getDisplayMetrics());
 567      }
 568  
 569      private void showToast(final String tip) {
 570          detailPlayer.post(new Runnable() {
 571              @Override
 572              public void run() {
 573                  Toast.makeText(DetailFilterActivity.this, tip, Toast.LENGTH_LONG).show();
 574              }
 575          });
 576      }





































 577  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            