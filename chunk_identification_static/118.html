<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>118</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    118
                    <a href="117.html">prev</a>
                    <a href="119.html">next</a>
                    <a href="118_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_620c8312d03fd2fb2b3aec6cbd0ce1f1323c0468_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;620c8312d03fd2fb2b3aec6cbd0ce1f1323c0468:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;620c8312d03fd2fb2b3aec6cbd0ce1f1323c0468^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;620c8312d03fd2fb2b3aec6cbd0ce1f1323c0468^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bafb939239dd037362fec74ebcc71f212341eba5:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.ActionBar;
  22 import androidx.appcompat.app.ActionBarDrawerToggle;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.app.AppCompatActivity;
  25 import androidx.appcompat.view.ContextThemeWrapper;
  26 import androidx.appcompat.widget.SearchView;
  27 import androidx.appcompat.widget.Toolbar;
  28 import androidx.core.view.GravityCompat;
  29 import androidx.drawerlayout.widget.DrawerLayout;
  30 import androidx.fragment.app.FragmentManager;
  31 import androidx.fragment.app.FragmentTransaction;
  32 import androidx.preference.PreferenceManager;
  33 
  34 import com.automattic.simplenote.analytics.AnalyticsTracker;
  35 import com.automattic.simplenote.models.Note;
  36 import com.automattic.simplenote.models.Tag;
  37 import com.automattic.simplenote.utils.CrashUtils;
  38 import com.automattic.simplenote.utils.DisplayUtils;
  39 import com.automattic.simplenote.utils.DrawableUtils;
  40 import com.automattic.simplenote.utils.HtmlCompat;
  41 import com.automattic.simplenote.utils.PrefUtils;
  42 import com.automattic.simplenote.utils.StrUtils;
  43 import com.automattic.simplenote.utils.TagsAdapter;
  44 import com.automattic.simplenote.utils.ThemeUtils;
  45 import com.automattic.simplenote.utils.UndoBarController;
  46 import com.google.android.material.navigation.NavigationView;
  47 import com.simperium.Simperium;
  48 import com.simperium.client.Bucket;
  49 import com.simperium.client.BucketObjectMissingException;
  50 import com.simperium.client.BucketObjectNameInvalid;
  51 import com.simperium.client.Query;
  52 import com.simperium.client.User;
  53 
  54 import org.wordpress.passcodelock.AppLockManager;
  55 
  56 import java.util.ArrayList;
  57 import java.util.Calendar;
  58 import java.util.HashMap;
  59 import java.util.List;
  60 import java.util.Map;
  61 
  62 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  67 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  68 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  70 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  71 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  72 
  73 public class NotesActivity extends AppCompatActivity implements
<abbr title="  74         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  74         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  75         Bucket.Listener&lt;Note&gt; {
  76 
  77     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  78     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  79     protected Bucket&lt;Note&gt; mNotesBucket;
  80     protected Bucket&lt;Tag&gt; mTagsBucket;
  81     private boolean mIsShowingMarkdown;
  82     private boolean mShouldSelectNewNote;
  83     private boolean mIsSettingsClicked;
  84     private boolean mIsTabetFullscreen;
  85 
  86     private String mTabletSearchQuery;
  87     private UndoBarController mUndoBarController;
  88     private View mFragmentsContainer;
  89     private SearchView mSearchView;
  90     private MenuItem mSearchMenuItem;
  91     private NoteListFragment mNoteListFragment;
  92     private NoteEditorFragment mNoteEditorFragment;
  93     private Note mCurrentNote;
  94     private MenuItem mEmptyTrashMenuItem;
  95 
  96     // Menu drawer
  97     private static final int GROUP_PRIMARY = 100;
  98     private static final int GROUP_SECONDARY = 101;
  99     private static final int GROUP_TERTIARY = 102;
 100     private DrawerLayout mDrawerLayout;
 101     private Menu mNavigationMenu;
 102     private ActionBarDrawerToggle mDrawerToggle;
 103     private TagsAdapter mTagsAdapter;
 104     private TagsAdapter.TagMenuItem mSelectedTag;
 105     // Tags bucket listener
 106     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 107         void updateNavigationDrawer() {
 108             runOnUiThread(new Runnable() {
 109                 public void run() {
 110                     updateNavigationDrawerItems();
 111                 }
 112             });
 113         }
 114 
 115         @Override
 116         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 117             updateNavigationDrawer();
 118         }
 119 
 120         @Override
 121         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 122             updateNavigationDrawer();
 123         }
 124 
 125         @Override
 126         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 127             updateNavigationDrawer();
 128         }
 129 
 130         @Override
 131         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 132             // noop
 133         }
 134     };
 135 
 136     @Override
 137     protected void onCreate(Bundle savedInstanceState) {
 138         ThemeUtils.setTheme(this);
 139         super.onCreate(savedInstanceState);
 140 
 141         setContentView(R.layout.activity_notes);
 142 
 143         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 144 
 145         Simplenote currentApp = (Simplenote) getApplication();
 146         if (mNotesBucket == null) {
 147             mNotesBucket = currentApp.getNotesBucket();
 148         }
 149 
 150         if (mTagsBucket == null) {
 151             mTagsBucket = currentApp.getTagsBucket();
 152         }
 153 
 154         Toolbar toolbar = findViewById(R.id.toolbar);
 155         setSupportActionBar(toolbar);
 156         configureNavigationDrawer(toolbar);
 157 
 158         if (savedInstanceState == null) {
 159             mNoteListFragment = new NoteListFragment();
 160             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 161             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 162             fragmentTransaction.commit();
 163         } else {
<abbr title=" 164             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 164             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 165         }
 166         mIsTabetFullscreen = mNoteListFragment.isHidden();
 167 
 168         if (DisplayUtils.isLargeScreen(this)) {
 169             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 171             } else if (DisplayUtils.isLandscape(this)) {
 172                 addEditorFragment();
 173             }
 174         }
 175 
 176         // enable ActionBar app icon to behave as action to toggle nav drawer
 177         ActionBar actionBar = getSupportActionBar();
 178         if (actionBar != null) {
 179             actionBar.setDisplayHomeAsUpEnabled(true);
 180             actionBar.setHomeButtonEnabled(true);
 181 
 182             // Add loading indicator to show when indexing
<abbr title=" 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 184             actionBar.setDisplayShowCustomEnabled(true);
 185             actionBar.setCustomView(progressBar);
 186             setToolbarProgressVisibility(false);
 187         }
 188 
 189         mUndoBarController = new UndoBarController(this);
 190 
 191         // Creates &#x27;Welcome&#x27; note
 192         checkForFirstLaunch();
 193 
 194         checkForSharedContent();
 195 
 196         currentApp.getSimperium().setOnUserCreatedListener(this);
 197         currentApp.getSimperium().setUserStatusChangeListener(this);
 198     }
 199 
 200     @Override
 201     protected void onResume() {
 202         super.onResume();
 203 
 204         // Ensure user has valid authorization
 205         if (userAuthenticationIsInvalid()) {
 206             startLoginActivity(true);
 207             Intent intent = getIntent();
 208 
 209             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 210                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 211                 AnalyticsTracker.track(
 212                         NOTE_WIDGET_SIGN_IN_TAPPED,
 213                         CATEGORY_WIDGET,
 214                         &quot;note_widget_sign_in_tapped&quot;
 215                 );
 216             }
 217         }
 218 
 219         disableScreenshotsIfLocked(this);
 220 
 221         mNotesBucket.start();
 222         mTagsBucket.start();
 223 
 224         mNotesBucket.addOnNetworkChangeListener(this);
 225         mNotesBucket.addOnSaveObjectListener(this);
 226         mNotesBucket.addOnDeleteObjectListener(this);
 227         mTagsBucket.addListener(mTagsMenuUpdater);
 228 
 229         updateNavigationDrawerItems();
 230 
 231         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 232         if (userIsUnauthorized()) {
 233             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 234                 mSelectedTag = null;
 235                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 236             }
 237         }
 238 
 239         filterListBySelectedTag();
 240 
 241         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 242             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 242             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 243             mShouldSelectNewNote = false;
 244         }
 245 
 246         if (mIsShowingMarkdown) {
 247             setMarkdownShowing(false);
 248         }
 249 
 250         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 251         if(DisplayUtils.isLargeScreenLandscape(this)) {
 252             if (mIsTabetFullscreen) {
 253                 ft.hide(mNoteListFragment);
 254             } else {
 255                 ft.show(mNoteListFragment);
 256             }
 257         } else {
 258             ft.show(mNoteListFragment);
 259         }
 260         ft.commitNow();
 261     }
 262 
 263     @Override
 264     protected void onPause() {
 265         super.onPause();  // Always call the superclass method first
 266         mTagsBucket.removeListener(mTagsMenuUpdater);
 267         mTagsBucket.stop();
 268 
 269         mNotesBucket.removeOnNetworkChangeListener(this);
 270         mNotesBucket.removeOnSaveObjectListener(this);
 271         mNotesBucket.removeOnDeleteObjectListener(this);
 272         mNotesBucket.stop();
 273     }
 274 
 275     @Override
 276     public void setTitle(CharSequence title) {
 277         if (getSupportActionBar() != null) {
 278             getSupportActionBar().setTitle(title);
 279         }
 280     }
 281 
 282     @Override
 283     public void onBackPressed() {
 284         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 285             mDrawerLayout.closeDrawer(GravityCompat.START);
 286         } else {
 287             super.onBackPressed();
 288         }
 289     }
 290 
 291     @Override
 292     public void onActionModeCreated() {
 293         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 294     }
 295 
 296     @Override
 297     public void onActionModeDestroyed() {
 298         if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 299             mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 300         }
 301     }
 302 
 303     private ColorStateList getIconSelector() {
 304         int[][] states = new int[][] {
 305                 new int[] { android.R.attr.state_checked}, // checked
 306                 new int[] {-android.R.attr.state_checked}  // unchecked
 307         };
 308 
 309         int[] colors = new int[] {
 310                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 311                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 312         };
 313 
 314         return new ColorStateList(states, colors);
 315     }
 316 
 317     private ColorStateList getTextSelector() {
 318         int[][] states = new int[][] {
 319             new int[] {-android.R.attr.state_enabled}, // disabled
 320             new int[] { android.R.attr.state_checked}, // checked
 321             new int[] {-android.R.attr.state_checked}  // unchecked
 322         };
 323 
 324         int[] colors = new int[] {
 325             getResources().getColor(R.color.text_title_disabled, getTheme()),
 326             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 327             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 328         };
 329 
 330         return new ColorStateList(states, colors);
 331     }
 332 
 333     private void configureNavigationDrawer(Toolbar toolbar) {
 334         ColorStateList iconSelector = getIconSelector();
 335         ColorStateList textSelector = getTextSelector();
 336         mDrawerLayout = findViewById(R.id.drawer_layout);
 337         NavigationView navigationView = findViewById(R.id.navigation_view);
 338         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 339         navigationView.setItemIconTintList(iconSelector);
 340         navigationView.setItemTextColor(textSelector);
 341         navigationView.setNavigationItemSelectedListener(
 342             new NavigationView.OnNavigationItemSelectedListener() {
 343                 @Override
 344                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 345                     mDrawerLayout.closeDrawer(GravityCompat.START);
 346 
 347                     if (item.getItemId() == SETTINGS_ID) {
 348                         AnalyticsTracker.track(
 349                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 350                                 AnalyticsTracker.CATEGORY_TAG,
 351                                 &quot;selected_tag_in_navigation_drawer&quot;,
 352                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 353                         );
 354                         mIsSettingsClicked = true;
 355                         return false;
 356                     } else {
 357                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 358                         filterListBySelectedTag();
 359                         return true;
 360                     }
 361                 }
 362             }
 363         );
 364 
 365         mNavigationMenu = navigationView.getMenu();
<abbr title=" 366         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 366         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 367         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 367         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 368         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 368         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 369         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 370 
 371         if (mSelectedTag == null)
 372             mSelectedTag = mTagsAdapter.getDefaultItem();
 373 
 374         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 375                 R.string.close_drawer) {
 376             public void onDrawerClosed(View view) {
 377                 supportInvalidateOptionsMenu();
 378 
 379                 if (mIsSettingsClicked) {
 380                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 381                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 382                     mIsSettingsClicked = false;
 383                 }
 384             }
 385 
 386             public void onDrawerOpened(View drawerView) {
 387                 // noop
 388             }
 389 
 390             @Override
 391             public void onDrawerSlide(View drawerView, float slideOffset) {
 392                 super.onDrawerSlide(drawerView, 0f);
 393             }
 394         };
 395 
 396         mDrawerLayout.addDrawerListener(mDrawerToggle);
 397     }
 398 
 399     private void filterListBySelectedTag() {
 400         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 401 
 402         if (selectedMenuItem != null) {
 403             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 404         } else {
 405             mSelectedTag = mTagsAdapter.getDefaultItem();
 406         }
 407 
 408         checkEmptyListText(false);
 409 
 410         if (mNoteListFragment.isHidden()) {
 411             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 412             fragmentTransaction.show(mNoteListFragment);
 413             fragmentTransaction.commitNowAllowingStateLoss();
 414         }
 415 
 416         // Disable long press on notes when viewing Trash.
 417         if (mSelectedTag.id == TRASH_ID) {
 418             getNoteListFragment().getListView().setLongClickable(false);
 419         } else {
 420             getNoteListFragment().getListView().setLongClickable(true);
 421         }
 422 
 423         getNoteListFragment().refreshListFromNavSelect();
 424 
 425         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 426 
 427         switch ((int) mSelectedTag.id) {
 428             case ALL_NOTES_ID:
 429                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 430                 break;
 431             case TRASH_ID:
 432                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 433                 break;
 434             case UNTAGGED_NOTES_ID:
 435                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 436                 break;
 437             default:
 438                 properties = null;
 439                 break;
 440         }
 441 
 442         AnalyticsTracker.track(
 443                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 444                 AnalyticsTracker.CATEGORY_TAG,
 445                 &quot;selected_tag_in_navigation_drawer&quot;,
 446                 properties
 447         );
 448 
 449         setSelectedTagActive();
 450     }
 451 
 452     private void checkForFirstLaunch() {
 453         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 454             // Create the welcome note
 455             try {
 456                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 457                 welcomeNote.setCreationDate(Calendar.getInstance());
 458                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 459                 welcomeNote.setContent(getString(R.string.welcome_note));
 460                 welcomeNote.getTitle();
 461                 welcomeNote.save();
 462             } catch (BucketObjectNameInvalid e) {
 463                 // this won&#x27;t happen because welcome-android is a valid name
 464             }
 465 
 466             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 467             SharedPreferences.Editor editor = preferences.edit();
 468             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 469             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 470             editor.apply();
 471         }
 472     }
 473 
 474     private void checkForSharedContent() {
 475         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 476             // Check share action
 477             Intent intent = getIntent();
 478             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 479             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 480 
<abbr title=" 481             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 481             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 482             String intentAction = StrUtils.notNullStr(intent.getAction());
 483             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 484             if (!TextUtils.isEmpty(text)) {
 485                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 486                     text = subject + &quot;\n\n&quot; + text;
 487                 }
 488                 Note note = mNotesBucket.newObject();
 489                 note.setCreationDate(Calendar.getInstance());
 490                 note.setModificationDate(note.getCreationDate());
 491                 note.setContent(text);
 492                 note.save();
 493                 setCurrentNote(note);
 494                 mShouldSelectNewNote = true;
 495 
 496                 AnalyticsTracker.track(
 497                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 498                         AnalyticsTracker.CATEGORY_NOTE,
 499                         &quot;external_share&quot;
 500                 );
 501 
 502                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 503                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 504                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 505                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 506                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 507                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 508                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 509                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 510                     }
 511                 }
 512             }
 513         }
 514     }
 515 
 516     private void updateNavigationDrawerItems() {
 517         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 518         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 519         if (isAlphaSort) {
 520             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 521         } else {
 522             tagCursor = Tag.allWithName(mTagsBucket).execute();
 523         }
 524 
 525         mTagsAdapter.changeCursor(tagCursor);
 526         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 527         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 528 
 529         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 530             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 530             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 531 
 532             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 533                 String name = mTagsAdapter.getItem(i).name;
 534                 int id = (int) mTagsAdapter.getItem(i).id;
 535 
 536                 if (id &gt;= 0) { // Custom tags have a positive ID.
 537                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 538                 }
 539             }
 540 
<abbr title=" 541             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 541             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 542             setSelectedTagActive();
 543         }
 544     }
 545 
 546     public void launchEditTags(View view) {
 547         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 548     }
 549 
 550     private void setSelectedTagActive() {
 551         if (mSelectedTag == null) {
 552             mSelectedTag = mTagsAdapter.getDefaultItem();
 553         }
 554 
 555         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 556 
 557         if (selectedMenuItem != null) {
 558             selectedMenuItem.setChecked(true);
 559         } else {
 560             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 561         }
 562 
 563         setTitle(mSelectedTag.name);
 564     }
 565 
 566     public TagsAdapter.TagMenuItem getSelectedTag() {
 567         if (mSelectedTag == null) {
 568             mSelectedTag = mTagsAdapter.getDefaultItem();
 569         }
 570 
 571         return mSelectedTag;
 572     }
 573 
 574     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 575     public void updateTrashMenuItem() {
 576         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 577             return;
 578 
 579         // Disable the trash icon if there are no notes trashed.
 580         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 581         if (query.count() == 0) {
 582             mEmptyTrashMenuItem.setEnabled(false);
 583         } else {
 584             mEmptyTrashMenuItem.setEnabled(true);
 585         }
 586     }
 587 
 588     private void addEditorFragment() {
 589         FragmentManager fm = getSupportFragmentManager();
 590         FragmentTransaction ft = fm.beginTransaction();
 591         mNoteEditorFragment = new NoteEditorFragment();
 592         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 593         ft.commitAllowingStateLoss();
 594         fm.executePendingTransactions();
 595     }
 596 
 597     private boolean userAccountRequired() {
 598         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 599     }
 600 
 601     /**
 602      * Checks for a previously valid user that is now not authenticated
 603      * Also checks if user account is required (added in version 1.5.6)
 604      *
 605      * @return true if user has invalid authorization
 606      */
 607     private boolean userAuthenticationIsInvalid() {
 608         Simplenote currentApp = (Simplenote) getApplication();
 609         Simperium simperium = currentApp.getSimperium();
 610         User user = simperium.getUser();
 611         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 612         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 613                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 614     }
 615 
 616     public boolean userIsUnauthorized() {
 617         Simplenote currentApp = (Simplenote) getApplication();
 618         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 619     }
 620 
 621     public void setCurrentNote(Note note) {
 622         mCurrentNote = note;
 623     }
 624 
 625     public NoteListFragment getNoteListFragment() {
 626         return mNoteListFragment;
 627     }
 628 
 629     @Override
 630     public boolean onCreateOptionsMenu(final Menu menu) {
 631         super.onCreateOptionsMenu(menu);
 632         MenuInflater inflater = getMenuInflater();
 633         inflater.inflate(R.menu.notes_list, menu);
 634 
 635         // restore the search query if on a landscape tablet
 636         String searchQuery = null;
 637         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 638             searchQuery = mSearchView.getQuery().toString();
 639 
 640         mSearchMenuItem = menu.findItem(R.id.menu_search);
 641         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 642 
 643         if (!TextUtils.isEmpty(searchQuery)) {
 644             mSearchView.setQuery(searchQuery, false);
 645             mSearchMenuItem.expandActionView();
 646         } else {
 647             // Workaround for setting the search placeholder text color
 648             @SuppressWarnings(&quot;ResourceType&quot;)
 649             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 650             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 651                     hintHexColor,
 652                     getString(R.string.search))));
 653         }
 654 
 655         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 656             @Override
 657             public boolean onQueryTextChange(String newText) {
 658                 if (mSearchMenuItem.isActionViewExpanded()) {
 659                     getNoteListFragment().searchNotes(newText);
 660                 }
 661                 return true;
 662             }
 663 
 664             @Override
 665             public boolean onQueryTextSubmit(String queryText) {
 666                 getNoteListFragment().searchNotes(queryText);
 667                 return true;
 668             }
 669 
 670         });
 671 
 672         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 673             @Override
 674             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 675 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 676                 getNoteListFragment().searchNotes(&quot;&quot;);</span>
 677 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679                     updateActionsForLargeLandscape(menu);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680                 }</span>
 681 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);</span>
 683 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 684 
 685                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 686                     updateActionsForLargeLandscape(menu);
 687                 }
 688 
 689                 checkEmptyListText(true);
 690 
 691                 if (mNoteListFragment != null) {
 692                     mNoteListFragment.setFloatingActionButtonVisible(false);
 693                 }
 694 
 695                 AnalyticsTracker.track(
 696                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 697                         AnalyticsTracker.CATEGORY_NOTE,
 698                         &quot;action_bar_search_tap&quot;
 699                 );
 700                 return true;
 701             }
 702 
 703             @Override
 704             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 705                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 706 
 707                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 708                     updateActionsForLargeLandscape(menu);
 709                 }
 710 
 711                 // Show all notes again
 712                 if (mNoteListFragment != null) {
 713                     mNoteListFragment.setFloatingActionButtonVisible(true);
 714                 }
 715 
 716                 mTabletSearchQuery = &quot;&quot;;
 717                 mSearchView.setQuery(&quot;&quot;, false);
 718                 checkEmptyListText(false);
 719                 getNoteListFragment().clearSearch();
 720                 return true;
 721             }
 722         });
 723 
 724         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 725             @Override
 726             public boolean onMenuItemClick(MenuItem item) {
 727                 if (!mSearchMenuItem.isActionViewExpanded())
 728                     showDetailPlaceholder();
 729                 return false;
 730             }
 731         });
 732 
 733         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 734         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 735             trashItem.setTitle(R.string.undelete);
 736             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 737         } else {
 738             trashItem.setTitle(R.string.delete);
 739             trashItem.setIcon(R.drawable.ic_trash_24dp);
 740         }
 741 
 742         if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 743             // Restore the search query on landscape tablets
 744             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 745                 mSearchMenuItem.expandActionView();
 746                 mSearchView.setQuery(mTabletSearchQuery, false);
 747                 mSearchView.clearFocus();
 748             }
 749 
 750             updateActionsForLargeLandscape(menu);
 751         } else {
 752             menu.findItem(R.id.menu_search).setVisible(true);
 753             menu.findItem(R.id.menu_share).setVisible(false);
 754             menu.findItem(R.id.menu_view_info).setVisible(false);
 755             menu.findItem(R.id.menu_checklist).setVisible(false);
 756             menu.findItem(R.id.menu_history).setVisible(false);
 757             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 758             menu.findItem(R.id.menu_sidebar).setVisible(false);
 759             trashItem.setVisible(false);
 760             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 761         }
 762 
 763         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 764             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 765             mEmptyTrashMenuItem.setVisible(true);
 766 
 767             updateTrashMenuItem();
 768 
 769             menu.findItem(R.id.menu_search).setVisible(false);
 770             menu.findItem(R.id.menu_share).setVisible(false);
 771             menu.findItem(R.id.menu_history).setVisible(false);
 772             menu.findItem(R.id.menu_checklist).setVisible(false);
 773         }
 774 
 775         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 776 
 777         return true;
 778     }
 779 
 780     @Override
 781     public boolean onOptionsItemSelected(MenuItem item) {
 782         if (mDrawerToggle.onOptionsItemSelected(item)) {
 783             return true;
 784         }
 785         switch (item.getItemId()) {
 786             case R.id.menu_sidebar:
 787                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 788                 if (mNoteListFragment.isHidden()) {
 789                     ft.show(mNoteListFragment);
 790                 } else {
 791                     ft.hide(mNoteListFragment);
 792                 }
 793                 ft.commitNowAllowingStateLoss();
 794                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 795                 return true;
 796             case R.id.menu_markdown_preview:
 797                 if (mIsShowingMarkdown) {
 798                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 799                     item.setTitle(getString(R.string.markdown_show));
 800                     setMarkdownShowing(false);
 801                     mCurrentNote.setPreviewEnabled(false);
 802                 } else {
 803                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 804                     item.setTitle(getString(R.string.markdown_hide));
 805                     setMarkdownShowing(true);
 806                     mCurrentNote.setPreviewEnabled(true);
 807                 }
 808 
 809                 mCurrentNote.save();
 810                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 811 
 812                 return true;
 813             case R.id.menu_delete:
 814                 if (mNoteEditorFragment != null) {
 815                     if (mCurrentNote != null) {
 816                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 817                         mCurrentNote.setModificationDate(Calendar.getInstance());
 818                         mCurrentNote.save();
 819 
 820                         updateViewsAfterTrashAction(mCurrentNote);
 821                     }
 822                 }
 823                 return true;
 824             case R.id.menu_empty_trash:
<abbr title=" 825                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 825                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 826 
 827                 alert.setTitle(R.string.empty_trash);
 828                 alert.setMessage(R.string.confirm_empty_trash);
 829                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 830                     public void onClick(DialogInterface dialog, int whichButton) {
 831                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 832                         AnalyticsTracker.track(
 833                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 834                                 AnalyticsTracker.CATEGORY_NOTE,
 835                                 &quot;overflow_menu&quot;
 836                         );
 837                     }
 838                 });
 839                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 840                     public void onClick(DialogInterface dialog, int whichButton) {
 841                         // Do nothing, just closing the dialog
 842                     }
 843                 });
 844                 alert.show();
 845                 return true;
 846             case android.R.id.home:
 847                 invalidateOptionsMenu();
 848                 return true;
 849             default:
 850                 return super.onOptionsItemSelected(item);
 851         }
 852     }
 853 
 854     @Override
 855     public boolean onPrepareOptionsMenu(Menu menu) {
 856         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 857 
 858         if (mIsShowingMarkdown) {
 859             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 860             markdownItem.setTitle(getString(R.string.markdown_hide));
 861         } else {
 862             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 863             markdownItem.setTitle(getString(R.string.markdown_show));
 864         }
 865 
 866         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 867 
 868         return super.onPrepareOptionsMenu(menu);
 869     }
 870 
 871     private void updateActionsForLargeLandscape(Menu menu) {
 872         if (mCurrentNote != null) {
 873             menu.findItem(R.id.menu_checklist).setVisible(true);
 874             menu.findItem(R.id.menu_delete).setVisible(true);
 875             menu.findItem(R.id.menu_history).setVisible(true);
 876             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 877             menu.findItem(R.id.menu_share).setVisible(true);
 878             menu.findItem(R.id.menu_sidebar).setVisible(true);
 879             menu.findItem(R.id.menu_view_info).setVisible(true);
 880         } else {
 881             menu.findItem(R.id.menu_checklist).setVisible(false);
 882             menu.findItem(R.id.menu_delete).setVisible(false);
 883             menu.findItem(R.id.menu_history).setVisible(false);
 884             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 885             menu.findItem(R.id.menu_share).setVisible(false);
 886             menu.findItem(R.id.menu_sidebar).setVisible(false);
 887             menu.findItem(R.id.menu_view_info).setVisible(false);
 888         }
 889 
 890         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 891     }
 892 
 893     public void updateViewsAfterTrashAction(Note note) {
 894         if (note == null || isFinishing()) {
 895             return;
 896         }
 897 
 898         if (note.isDeleted()) {
 899             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 900             deletedNoteIds.add(note.getSimperiumKey());
 901             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 902             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 903             AnalyticsTracker.track(
 904                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 905                     AnalyticsTracker.CATEGORY_NOTE,
 906                     &quot;overflow_menu&quot;
 907             );
 908         } else {
 909             AnalyticsTracker.track(
 910                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 911                     AnalyticsTracker.CATEGORY_NOTE,
 912                     &quot;overflow_menu&quot;
 913             );
 914         }
 915 
 916         // If we just deleted/restored the active note, show the placeholder
 917         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 918             showDetailPlaceholder();
 919         }
 920 
 921         NoteListFragment fragment = getNoteListFragment();
 922         if (fragment != null) {
 923             fragment.getPrefs();
 924             fragment.refreshList();
 925         }
 926 
 927         invalidateOptionsMenu();
 928     }
 929 
 930     public void setMarkdownShowing(boolean isMarkdownShowing) {
 931         mIsShowingMarkdown = isMarkdownShowing;
 932         if (mNoteEditorFragment != null) {
 933             if (isMarkdownShowing) {
 934                 mNoteEditorFragment.showMarkdown();
 935             } else {
 936                 mNoteEditorFragment.hideMarkdown();
 937             }
 938         }
 939         invalidateOptionsMenu();
 940     }
 941 
 942     /**
 943      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 944      * the item with the given ID was selected. Used for tablets only.
 945      */
 946     @Override
<abbr title=" 947     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 947     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 948         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 949             // Launch the editor activity
 950             Bundle arguments = new Bundle();
 951             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 952             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 953             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 954 
 955             if (matchOffsets != null) {
 956                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 957             }
 958 
 959             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 960             editNoteIntent.putExtras(arguments);
 961             if (mNoteListFragment.isHidden()) {
 962                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 963             }
 964             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 965         } else {
 966             mNoteEditorFragment.setNote(noteID, matchOffsets);
 967             getNoteListFragment().setNoteSelected(noteID);
 968             setMarkdownShowing(isPreviewEnabled);
 969 
 970             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 971                 mTabletSearchQuery = mSearchView.getQuery().toString();
 972             }
 973 
 974             mNoteEditorFragment.clearMarkdown();
 975 
 976             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 977                 setMarkdownShowing(false);
 978             }
 979 
 980             invalidateOptionsMenu();
 981         }
 982 
 983         AnalyticsTracker.track(
 984                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 985                 AnalyticsTracker.CATEGORY_NOTE,
 986                 &quot;note_list_row_tap&quot;
 987         );
 988     }
 989 
 990     @Override
 991     public void onUserCreated(User user) {
 992         // New account created
 993         AnalyticsTracker.track(
 994                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 995                 AnalyticsTracker.CATEGORY_USER,
 996                 &quot;account_created_from_login_activity&quot;
 997         );
 998     }
 999 
1000     public void onUserStatusChange(User.Status status) {
1001         switch (status) {
1002             // successfully used access token to connect to simperium bucket
1003             case AUTHORIZED:
1004                 runOnUiThread(new Runnable() {
1005                     @Override
1006                     public void run() {
1007                         if (!mNotesBucket.hasChangeVersion()) {
1008                             setToolbarProgressVisibility(true);
1009                         }
1010                     }
1011                 });
1012                 break;
1013 
1014             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1015             case NOT_AUTHORIZED:
1016                 runOnUiThread(new Runnable() {
1017                     @Override
1018                     public void run() {
1019                         startLoginActivity(true);
1020                     }
1021                 });
1022                 break;
1023 
<abbr title="1024             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1024             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1025             case UNKNOWN:
1026                 break;
1027         }
1028     }
1029 
1030     private void setToolbarProgressVisibility(boolean isVisible) {
1031         if (getSupportActionBar() != null) {
1032             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1033         }
1034     }
1035 
1036     public void startLoginActivity(boolean signInFirst) {
1037         // Clear some account-specific prefs
1038         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1039         editor.remove(PrefUtils.PREF_WP_TOKEN);
1040         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1041         editor.apply();
1042 
1043         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1044         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1045     }
1046 
1047     @Override
1048     public void recreate() {
1049         Handler handler = new Handler();
1050         handler.post(new Runnable() {
1051             @Override
1052             public void run() {
1053                 NotesActivity.super.recreate();
1054             }
1055         });
1056     }
1057 
1058     @Override
1059     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1060         super.onActivityResult(requestCode, resultCode, data);
1061         switch (requestCode) {
1062             case Simplenote.INTENT_PREFERENCES:
<abbr title="1063                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1063                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1064                 invalidateOptionsMenu();
1065                 NoteListFragment fragment = getNoteListFragment();
1066                 if (fragment != null) {
1067                     fragment.getPrefs();
1068                     fragment.refreshList();
1069                 }
1070 
1071                 break;
1072             case Simplenote.INTENT_EDIT_NOTE:
1073                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1074                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1075                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1076                         if (noteId != null) {
1077                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1078                             deletedNoteIds.add(noteId);
1079                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1080                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1080                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1081                         }
<abbr title="1082                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1082                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1083                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1084                         mNoteListFragment.setNoteSelected(selectedNoteId);
1085                         if (mNoteEditorFragment != null) {
1086                             mNoteEditorFragment.setNote(selectedNoteId);
1087                         }
1088                     }
1089                 }
1090                 break;
1091             case Simperium.SIGNUP_SIGNIN_REQUEST:
1092                 invalidateOptionsMenu();
1093 
1094                 Simplenote app = (Simplenote) getApplication();
1095                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1096                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1097 
1098                 AnalyticsTracker.track(
1099                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1100                         AnalyticsTracker.CATEGORY_USER,
1101                         &quot;signed_in_from_login_activity&quot;
1102                 );
1103 
1104                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1105                     finish();
1106                 }
1107 
1108                 break;
1109         }
1110     }
1111 
1112     @Override
1113     public void onUndo() {
1114         if (mUndoBarController == null) return;
1115 
1116         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1117         if (deletedNoteIds != null) {
1118             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1119                 Note deletedNote;
1120                 try {
1121                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1122                 } catch (BucketObjectMissingException e) {
1123                     return;
1124                 }
1125                 if (deletedNote != null) {
1126                     deletedNote.setDeleted(false);
1127                     deletedNote.setModificationDate(Calendar.getInstance());
1128                     deletedNote.save();
1129                     NoteListFragment fragment = getNoteListFragment();
1130                     if (fragment != null) {
1131                         fragment.getPrefs();
1132                         fragment.refreshList();
1133                     }
1134                 }
1135             }
1136         }
1137     }
1138 
1139     @Override
1140     protected void onPostCreate(Bundle savedInstanceState) {
1141         super.onPostCreate(savedInstanceState);
1142         // Sync the toggle state after onRestoreInstanceState has occurred.
1143         mDrawerToggle.syncState();
1144     }
1145 
1146     @Override
1147     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1148         super.onConfigurationChanged(newConfig);
1149 
1150         mDrawerToggle.onConfigurationChanged(newConfig);
1151 
1152         if (DisplayUtils.isLargeScreen(this)) {
1153             mIsShowingMarkdown = false;
1154 
1155             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1156                 // Add the editor fragment
1157                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1158                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1158                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1159                 } else if (DisplayUtils.isLandscape(this)) {
1160                     addEditorFragment();
1161                 }
1162 
1163                 if (mNoteListFragment != null) {
1164                     mNoteListFragment.setActivateOnItemClick(true);
1165                     mNoteListFragment.setDividerVisible(true);
1166                 }
1167 
1168                 // Select the current note on a tablet
1169                 if (mCurrentNote != null) {
<abbr title="1170                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1170                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1171                 } else {
1172                     mNoteEditorFragment.setPlaceholderVisible(true);
1173                     mNoteListFragment.getListView().clearChoices();
1174                 }
1175 
1176                 invalidateOptionsMenu();
<abbr title="1177             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1177             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1178             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1179                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1179                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1180             }
1181         }
1182 
1183         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1184             // Remove the editor fragment when rotating back to portrait
1185             mCurrentNote = null;
1186             if (mNoteListFragment != null) {
1187                 mNoteListFragment.setActivateOnItemClick(false);
1188                 mNoteListFragment.setDividerVisible(false);
1189                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1190                 mNoteListFragment.refreshList();
1191             }
1192             FragmentManager fm = getSupportFragmentManager();
1193             FragmentTransaction ft = fm.beginTransaction();
1194             ft.remove(mNoteEditorFragment);
1195             mNoteEditorFragment = null;
1196             ft.commitAllowingStateLoss();
1197             fm.executePendingTransactions();
1198             invalidateOptionsMenu();
1199         }
1200     }
1201 
1202     public void checkEmptyListText(boolean isSearch) {
1203         if (isSearch) {
<abbr title="1204             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1204             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1205             getNoteListFragment().setEmptyListViewClickable(false);
1206         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1207             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1207             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1208             AnalyticsTracker.track(
1209                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1210                     AnalyticsTracker.CATEGORY_NOTE,
1211                     &quot;trash_filter_selected&quot;
1212             );
1213             getNoteListFragment().setEmptyListViewClickable(false);
1214         } else {
<abbr title="1215             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1215             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1216             getNoteListFragment().setEmptyListViewClickable(true);
1217         }
1218     }
1219 
1220     public void showDetailPlaceholder() {
1221         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1222             mCurrentNote = null;
1223             mNoteEditorFragment.setPlaceholderVisible(true);
1224             mNoteEditorFragment.clearMarkdown();
1225             mNoteEditorFragment.hideMarkdown();
1226             mIsShowingMarkdown = false;
1227         }
1228     }
1229 
1230     public void stopListeningToNotesBucket() {
1231         mNotesBucket.removeOnNetworkChangeListener(this);
1232         mNotesBucket.removeOnSaveObjectListener(this);
1233         mNotesBucket.removeOnDeleteObjectListener(this);
1234     }
1235 
1236     // Returns the appropriate view to show the undo bar within
1237     private View getUndoView() {
1238         View undoView = mFragmentsContainer;
1239         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1240                 getNoteListFragment() != null &amp;&amp;
1241                 getNoteListFragment().getRootView() != null) {
1242             undoView = getNoteListFragment().getRootView();
1243         }
1244 
1245         return undoView;
1246     }
1247 
1248     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1249         if (mUndoBarController != null) {
1250             mUndoBarController.setDeletedNoteIds(noteIds);
1251             mUndoBarController.showUndoBar(
1252                     getUndoView(),
<abbr title="1253                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1253                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1254             );
1255         }
1256     }
1257 
1258     /* Simperium Bucket Listeners */
1259     // received a change from the network, refresh the list
1260     @Override
1261     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1262         runOnUiThread(new Runnable() {
1263             @Override
1264             public void run() {
1265                 if (type == Bucket.ChangeType.INDEX) {
1266                     setToolbarProgressVisibility(false);
1267                 }
1268                 mNoteListFragment.refreshList();
1269             }
1270         });
1271     }
1272 
1273     @Override
1274     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1275         runOnUiThread(new Runnable() {
1276             @Override
1277             public void run() {
1278                 mNoteListFragment.refreshList();
1279             }
1280         });
1281     }
1282 
1283     @Override
1284     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1285         runOnUiThread(new Runnable() {
1286             @Override
1287             public void run() {
1288                 mNoteListFragment.refreshList();
1289             }
1290         });
1291     }
1292 
1293     @Override
1294     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1295         // noop, NoteEditorFragment will handle this
1296     }
1297 
1298     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1299 
1300         @Override
1301         protected Void doInBackground(Void... voids) {
1302             if (mNotesBucket == null) return null;
1303 
1304             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1305             Bucket.ObjectCursor c = query.execute();
1306             while (c.moveToNext()) {
1307                 c.getObject().delete();
1308             }
1309 
1310             return null;
1311         }
1312 
1313         @Override
1314         protected void onPostExecute(Void nada) {
1315             showDetailPlaceholder();
1316         }
1317     }
1318 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.ActionBar;
  22 import androidx.appcompat.app.ActionBarDrawerToggle;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.app.AppCompatActivity;
  25 import androidx.appcompat.view.ContextThemeWrapper;
  26 import androidx.appcompat.widget.SearchView;
  27 import androidx.appcompat.widget.Toolbar;
  28 import androidx.core.view.GravityCompat;
  29 import androidx.drawerlayout.widget.DrawerLayout;
  30 import androidx.fragment.app.FragmentManager;
  31 import androidx.fragment.app.FragmentTransaction;
  32 import androidx.preference.PreferenceManager;
  33 
  34 import com.automattic.simplenote.analytics.AnalyticsTracker;
  35 import com.automattic.simplenote.models.Note;
  36 import com.automattic.simplenote.models.Tag;
  37 import com.automattic.simplenote.utils.CrashUtils;
  38 import com.automattic.simplenote.utils.DisplayUtils;
  39 import com.automattic.simplenote.utils.DrawableUtils;
  40 import com.automattic.simplenote.utils.HtmlCompat;
  41 import com.automattic.simplenote.utils.PrefUtils;
  42 import com.automattic.simplenote.utils.StrUtils;
  43 import com.automattic.simplenote.utils.TagsAdapter;
  44 import com.automattic.simplenote.utils.ThemeUtils;
  45 import com.automattic.simplenote.utils.UndoBarController;
  46 import com.google.android.material.navigation.NavigationView;
  47 import com.simperium.Simperium;
  48 import com.simperium.client.Bucket;
  49 import com.simperium.client.BucketObjectMissingException;
  50 import com.simperium.client.BucketObjectNameInvalid;
  51 import com.simperium.client.Query;
  52 import com.simperium.client.User;
  53 
  54 import org.wordpress.passcodelock.AppLockManager;
  55 
  56 import java.util.ArrayList;
  57 import java.util.Calendar;
  58 import java.util.HashMap;
  59 import java.util.List;
  60 import java.util.Map;
  61 
  62 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  67 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  68 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  69 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  70 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  71 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  72 
  73 public class NotesActivity extends AppCompatActivity implements
<abbr title="  74         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  74         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  75         Bucket.Listener&lt;Note&gt; {
  76 
  77     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  78     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  79     protected Bucket&lt;Note&gt; mNotesBucket;
  80     protected Bucket&lt;Tag&gt; mTagsBucket;
  81     private boolean mIsShowingMarkdown;
  82     private boolean mShouldSelectNewNote;
  83     private boolean mIsSettingsClicked;
  84     private boolean mIsTabetFullscreen;
  85 
  86     private String mTabletSearchQuery;
  87     private UndoBarController mUndoBarController;
  88     private View mFragmentsContainer;
  89     private SearchView mSearchView;
  90     private MenuItem mSearchMenuItem;
  91     private NoteListFragment mNoteListFragment;
  92     private NoteEditorFragment mNoteEditorFragment;
  93     private Note mCurrentNote;
  94     private MenuItem mEmptyTrashMenuItem;
  95 
  96     // Menu drawer
  97     private static final int GROUP_PRIMARY = 100;
  98     private static final int GROUP_SECONDARY = 101;
  99     private static final int GROUP_TERTIARY = 102;
 100     private DrawerLayout mDrawerLayout;
 101     private Menu mNavigationMenu;
 102     private ActionBarDrawerToggle mDrawerToggle;
 103     private TagsAdapter mTagsAdapter;
 104     private TagsAdapter.TagMenuItem mSelectedTag;
 105     // Tags bucket listener
 106     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 107         void updateNavigationDrawer() {
 108             runOnUiThread(new Runnable() {
 109                 public void run() {
 110                     updateNavigationDrawerItems();
 111                 }
 112             });
 113         }
 114 
 115         @Override
 116         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 117             updateNavigationDrawer();
 118         }
 119 
 120         @Override
 121         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 122             updateNavigationDrawer();
 123         }
 124 
 125         @Override
 126         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 127             updateNavigationDrawer();
 128         }
 129 
 130         @Override
 131         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 132             // noop
 133         }
 134     };
 135 
 136     @Override
 137     protected void onCreate(Bundle savedInstanceState) {
 138         ThemeUtils.setTheme(this);
 139         super.onCreate(savedInstanceState);
 140 
 141         setContentView(R.layout.activity_notes);
 142 
 143         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 144 
 145         Simplenote currentApp = (Simplenote) getApplication();
 146         if (mNotesBucket == null) {
 147             mNotesBucket = currentApp.getNotesBucket();
 148         }
 149 
 150         if (mTagsBucket == null) {
 151             mTagsBucket = currentApp.getTagsBucket();
 152         }
 153 
 154         Toolbar toolbar = findViewById(R.id.toolbar);
 155         setSupportActionBar(toolbar);
 156         configureNavigationDrawer(toolbar);
 157 
 158         if (savedInstanceState == null) {
 159             mNoteListFragment = new NoteListFragment();
 160             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 161             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 162             fragmentTransaction.commit();
 163         } else {
<abbr title=" 164             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 164             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 165         }
 166         mIsTabetFullscreen = mNoteListFragment.isHidden();
 167 
 168         if (DisplayUtils.isLargeScreen(this)) {
 169             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 171             } else if (DisplayUtils.isLandscape(this)) {
 172                 addEditorFragment();
 173             }
 174         }
 175 
 176         // enable ActionBar app icon to behave as action to toggle nav drawer
 177         ActionBar actionBar = getSupportActionBar();
 178         if (actionBar != null) {
 179             actionBar.setDisplayHomeAsUpEnabled(true);
 180             actionBar.setHomeButtonEnabled(true);
 181 
 182             // Add loading indicator to show when indexing
<abbr title=" 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 184             actionBar.setDisplayShowCustomEnabled(true);
 185             actionBar.setCustomView(progressBar);
 186             setToolbarProgressVisibility(false);
 187         }
 188 
 189         mUndoBarController = new UndoBarController(this);
 190 
 191         // Creates &#x27;Welcome&#x27; note
 192         checkForFirstLaunch();
 193 
 194         checkForSharedContent();
 195 
 196         currentApp.getSimperium().setOnUserCreatedListener(this);
 197         currentApp.getSimperium().setUserStatusChangeListener(this);
 198     }
 199 
 200     @Override
 201     protected void onResume() {
 202         super.onResume();
 203 
 204         // Ensure user has valid authorization
 205         if (userAuthenticationIsInvalid()) {
 206             startLoginActivity(true);
 207             Intent intent = getIntent();
 208 
 209             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 210                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 211                 AnalyticsTracker.track(
 212                         NOTE_WIDGET_SIGN_IN_TAPPED,
 213                         CATEGORY_WIDGET,
 214                         &quot;note_widget_sign_in_tapped&quot;
 215                 );
 216             }
 217         }
 218 
 219         disableScreenshotsIfLocked(this);
 220 
 221         mNotesBucket.start();
 222         mTagsBucket.start();
 223 
 224         mNotesBucket.addOnNetworkChangeListener(this);
 225         mNotesBucket.addOnSaveObjectListener(this);
 226         mNotesBucket.addOnDeleteObjectListener(this);
 227         mTagsBucket.addListener(mTagsMenuUpdater);
 228 
 229         updateNavigationDrawerItems();
 230 
 231         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 232         if (userIsUnauthorized()) {
 233             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 234                 mSelectedTag = null;
 235                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 236             }
 237         }
 238 
 239         filterListBySelectedTag();
 240 
 241         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 242             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 242             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 243             mShouldSelectNewNote = false;
 244         }
 245 
 246         if (mIsShowingMarkdown) {
 247             setMarkdownShowing(false);
 248         }
 249 
 250         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 251         if(DisplayUtils.isLargeScreenLandscape(this)) {
 252             if (mIsTabetFullscreen) {
 253                 ft.hide(mNoteListFragment);
 254             } else {
 255                 ft.show(mNoteListFragment);
 256             }
 257         } else {
 258             ft.show(mNoteListFragment);
 259         }
 260         ft.commitNow();
 261     }
 262 
 263     @Override
 264     protected void onPause() {
 265         super.onPause();  // Always call the superclass method first
 266         mTagsBucket.removeListener(mTagsMenuUpdater);
 267         mTagsBucket.stop();
 268 
 269         mNotesBucket.removeOnNetworkChangeListener(this);
 270         mNotesBucket.removeOnSaveObjectListener(this);
 271         mNotesBucket.removeOnDeleteObjectListener(this);
 272         mNotesBucket.stop();
 273     }
 274 
 275     @Override
 276     public void setTitle(CharSequence title) {
 277         if (getSupportActionBar() != null) {
 278             getSupportActionBar().setTitle(title);
 279         }
 280     }
 281 
 282     @Override
 283     public void onBackPressed() {
 284         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 285             mDrawerLayout.closeDrawer(GravityCompat.START);
 286         } else {
 287             super.onBackPressed();
 288         }
 289     }
 290 
 291     @Override
 292     public void onActionModeCreated() {
 293         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 294     }
 295 
 296     @Override
 297     public void onActionModeDestroyed() {
 298         if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {
 299         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 300     }
 301     }
 302 
 303     private ColorStateList getIconSelector() {
 304         int[][] states = new int[][] {
 305                 new int[] { android.R.attr.state_checked}, // checked
 306                 new int[] {-android.R.attr.state_checked}  // unchecked
 307         };
 308 
 309         int[] colors = new int[] {
 310                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 311                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 312         };
 313 
 314         return new ColorStateList(states, colors);
 315     }
 316 
 317     private ColorStateList getTextSelector() {
 318         int[][] states = new int[][] {
 319             new int[] {-android.R.attr.state_enabled}, // disabled
 320             new int[] { android.R.attr.state_checked}, // checked
 321             new int[] {-android.R.attr.state_checked}  // unchecked
 322         };
 323 
 324         int[] colors = new int[] {
 325             getResources().getColor(R.color.text_title_disabled, getTheme()),
 326             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 327             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 328         };
 329 
 330         return new ColorStateList(states, colors);
 331     }
 332 
 333     private void configureNavigationDrawer(Toolbar toolbar) {
 334         ColorStateList iconSelector = getIconSelector();
 335         ColorStateList textSelector = getTextSelector();
 336         mDrawerLayout = findViewById(R.id.drawer_layout);
 337         NavigationView navigationView = findViewById(R.id.navigation_view);
 338         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 339         navigationView.setItemIconTintList(iconSelector);
 340         navigationView.setItemTextColor(textSelector);
 341         navigationView.setNavigationItemSelectedListener(
 342             new NavigationView.OnNavigationItemSelectedListener() {
 343                 @Override
 344                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 345                     mDrawerLayout.closeDrawer(GravityCompat.START);
 346 
 347                     if (item.getItemId() == SETTINGS_ID) {
 348                         AnalyticsTracker.track(
 349                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 350                                 AnalyticsTracker.CATEGORY_TAG,
 351                                 &quot;selected_tag_in_navigation_drawer&quot;,
 352                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 353                         );
 354                         mIsSettingsClicked = true;
 355                         return false;
 356                     } else {
 357                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 358                         filterListBySelectedTag();
 359                         return true;
 360                     }
 361                 }
 362             }
 363         );
 364 
 365         mNavigationMenu = navigationView.getMenu();
<abbr title=" 366         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 366         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 367         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 367         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 368         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 368         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 369         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 370 
 371         if (mSelectedTag == null)
 372             mSelectedTag = mTagsAdapter.getDefaultItem();
 373 
 374         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 375                 R.string.close_drawer) {
 376             public void onDrawerClosed(View view) {
 377                 supportInvalidateOptionsMenu();
 378 
 379                 if (mIsSettingsClicked) {
 380                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 381                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 382                     mIsSettingsClicked = false;
 383                 }
 384             }
 385 
 386             public void onDrawerOpened(View drawerView) {
 387                 // noop
 388             }
 389 
 390             @Override
 391             public void onDrawerSlide(View drawerView, float slideOffset) {
 392                 super.onDrawerSlide(drawerView, 0f);
 393             }
 394         };
 395 
 396         mDrawerLayout.addDrawerListener(mDrawerToggle);
 397     }
 398 
 399     private void filterListBySelectedTag() {
 400         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 401 
 402         if (selectedMenuItem != null) {
 403             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 404         } else {
 405             mSelectedTag = mTagsAdapter.getDefaultItem();
 406         }
 407 
 408         checkEmptyListText(false);
 409 
 410         if (mNoteListFragment.isHidden()) {
 411             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 412             fragmentTransaction.show(mNoteListFragment);
 413             fragmentTransaction.commitNowAllowingStateLoss();
 414         }
 415 
 416         // Disable long press on notes when viewing Trash.
 417         if (mSelectedTag.id == TRASH_ID) {
 418             getNoteListFragment().getListView().setLongClickable(false);
 419         } else {
 420             getNoteListFragment().getListView().setLongClickable(true);
 421         }
 422 
 423         getNoteListFragment().refreshListFromNavSelect();
 424 
 425         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 426 
 427         switch ((int) mSelectedTag.id) {
 428             case ALL_NOTES_ID:
 429                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 430                 break;
 431             case TRASH_ID:
 432                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 433                 break;
 434             case UNTAGGED_NOTES_ID:
 435                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 436                 break;
 437             default:
 438                 properties = null;
 439                 break;
 440         }
 441 
 442         AnalyticsTracker.track(
 443                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 444                 AnalyticsTracker.CATEGORY_TAG,
 445                 &quot;selected_tag_in_navigation_drawer&quot;,
 446                 properties
 447         );
 448 
 449         setSelectedTagActive();
 450     }
 451 
 452     private void checkForFirstLaunch() {
 453         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 454             // Create the welcome note
 455             try {
 456                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 457                 welcomeNote.setCreationDate(Calendar.getInstance());
 458                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 459                 welcomeNote.setContent(getString(R.string.welcome_note));
 460                 welcomeNote.getTitle();
 461                 welcomeNote.save();
 462             } catch (BucketObjectNameInvalid e) {
 463                 // this won&#x27;t happen because welcome-android is a valid name
 464             }
 465 
 466             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 467             SharedPreferences.Editor editor = preferences.edit();
 468             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 469             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 470             editor.apply();
 471         }
 472     }
 473 
 474     private void checkForSharedContent() {
 475         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 476             // Check share action
 477             Intent intent = getIntent();
 478             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 479             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 480 
<abbr title=" 481             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 481             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 482             String intentAction = StrUtils.notNullStr(intent.getAction());
 483             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 484             if (!TextUtils.isEmpty(text)) {
 485                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 486                     text = subject + &quot;\n\n&quot; + text;
 487                 }
 488                 Note note = mNotesBucket.newObject();
 489                 note.setCreationDate(Calendar.getInstance());
 490                 note.setModificationDate(note.getCreationDate());
 491                 note.setContent(text);
 492                 note.save();
 493                 setCurrentNote(note);
 494                 mShouldSelectNewNote = true;
 495 
 496                 AnalyticsTracker.track(
 497                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 498                         AnalyticsTracker.CATEGORY_NOTE,
 499                         &quot;external_share&quot;
 500                 );
 501 
 502                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 503                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 504                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 505                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 506                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 507                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 508                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 509                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 510                     }
 511                 }
 512             }
 513         }
 514     }
 515 
 516     private void updateNavigationDrawerItems() {
 517         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 518         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 519         if (isAlphaSort) {
 520             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 521         } else {
 522             tagCursor = Tag.allWithName(mTagsBucket).execute();
 523         }
 524 
 525         mTagsAdapter.changeCursor(tagCursor);
 526         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 527         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 528 
 529         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 530             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 530             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 531 
 532             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 533                 String name = mTagsAdapter.getItem(i).name;
 534                 int id = (int) mTagsAdapter.getItem(i).id;
 535 
 536                 if (id &gt;= 0) { // Custom tags have a positive ID.
 537                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 538                 }
 539             }
 540 
<abbr title=" 541             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 541             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 542             setSelectedTagActive();
 543         }
 544     }
 545 
 546     public void launchEditTags(View view) {
 547         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 548     }
 549 
 550     private void setSelectedTagActive() {
 551         if (mSelectedTag == null) {
 552             mSelectedTag = mTagsAdapter.getDefaultItem();
 553         }
 554 
 555         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 556 
 557         if (selectedMenuItem != null) {
 558             selectedMenuItem.setChecked(true);
 559         } else {
 560             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 561         }
 562 
 563         setTitle(mSelectedTag.name);
 564     }
 565 
 566     public TagsAdapter.TagMenuItem getSelectedTag() {
 567         if (mSelectedTag == null) {
 568             mSelectedTag = mTagsAdapter.getDefaultItem();
 569         }
 570 
 571         return mSelectedTag;
 572     }
 573 
 574     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 575     public void updateTrashMenuItem() {
 576         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 577             return;
 578 
 579         // Disable the trash icon if there are no notes trashed.
 580         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 581         if (query.count() == 0) {
 582             mEmptyTrashMenuItem.setEnabled(false);
 583         } else {
 584             mEmptyTrashMenuItem.setEnabled(true);
 585         }
 586     }
 587 
 588     private void addEditorFragment() {
 589         FragmentManager fm = getSupportFragmentManager();
 590         FragmentTransaction ft = fm.beginTransaction();
 591         mNoteEditorFragment = new NoteEditorFragment();
 592         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 593         ft.commitAllowingStateLoss();
 594         fm.executePendingTransactions();
 595     }
 596 
 597     private boolean userAccountRequired() {
 598         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 599     }
 600 
 601     /**
 602      * Checks for a previously valid user that is now not authenticated
 603      * Also checks if user account is required (added in version 1.5.6)
 604      *
 605      * @return true if user has invalid authorization
 606      */
 607     private boolean userAuthenticationIsInvalid() {
 608         Simplenote currentApp = (Simplenote) getApplication();
 609         Simperium simperium = currentApp.getSimperium();
 610         User user = simperium.getUser();
 611         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 612         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 613                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 614     }
 615 
 616     public boolean userIsUnauthorized() {
 617         Simplenote currentApp = (Simplenote) getApplication();
 618         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 619     }
 620 
 621     public void setCurrentNote(Note note) {
 622         mCurrentNote = note;
 623     }
 624 
 625     public NoteListFragment getNoteListFragment() {
 626         return mNoteListFragment;
 627     }
 628 
 629     @Override
 630     public boolean onCreateOptionsMenu(final Menu menu) {
 631         super.onCreateOptionsMenu(menu);
 632         MenuInflater inflater = getMenuInflater();
 633         inflater.inflate(R.menu.notes_list, menu);
 634 
 635         // restore the search query if on a landscape tablet
 636         String searchQuery = null;
 637         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 638             searchQuery = mSearchView.getQuery().toString();
 639 
 640         mSearchMenuItem = menu.findItem(R.id.menu_search);
 641         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 642 
 643         if (!TextUtils.isEmpty(searchQuery)) {
 644             mSearchView.setQuery(searchQuery, false);
 645             mSearchMenuItem.expandActionView();
 646         } else {
 647             // Workaround for setting the search placeholder text color
 648             @SuppressWarnings(&quot;ResourceType&quot;)
 649             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 650             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 651                     hintHexColor,
 652                     getString(R.string.search))));
 653         }
 654 
 655         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 656             @Override
 657             public boolean onQueryTextChange(String newText) {
 658                 if (mSearchMenuItem.isActionViewExpanded()) {
 659                     getNoteListFragment().searchNotes(newText);
 660                 }
 661                 return true;
 662             }
 663 
 664             @Override
 665             public boolean onQueryTextSubmit(String queryText) {
 666                 getNoteListFragment().searchNotes(queryText);
 667                 return true;
 668             }
 669 
 670         });
 671 
 672         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 673             @Override
 674             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 675 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 676                 getNoteListFragment().searchNotes(&quot;&quot;);</span>
 677 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {</span>
 679 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);</span>
 681 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 682 
 683                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 684                     updateActionsForLargeLandscape(menu);
 685                 }
 686 
 687                 checkEmptyListText(true);
 688 
 689                 if (mNoteListFragment != null) {
 690                     mNoteListFragment.setFloatingActionButtonVisible(false);
 691                 }
 692 
 693                 AnalyticsTracker.track(
 694                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 695                         AnalyticsTracker.CATEGORY_NOTE,
 696                         &quot;action_bar_search_tap&quot;
 697                 );
 698                 return true;
 699             }
 700 
 701             @Override
 702             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 703                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 704 
 705                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 706                     updateActionsForLargeLandscape(menu);
 707                 }
 708 
 709                 // Show all notes again
 710                 if (mNoteListFragment != null) {
 711                     mNoteListFragment.setFloatingActionButtonVisible(true);
 712                 }
 713 
 714                 mTabletSearchQuery = &quot;&quot;;
 715                 mSearchView.setQuery(&quot;&quot;, false);
 716                 checkEmptyListText(false);
 717                 getNoteListFragment().clearSearch();
 718                 return true;
 719             }
 720         });
 721 
 722         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 723             @Override
 724             public boolean onMenuItemClick(MenuItem item) {
 725                 if (!mSearchMenuItem.isActionViewExpanded())
 726                     showDetailPlaceholder();
 727                 return false;
 728             }
 729         });
 730 
 731         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 732         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 733             trashItem.setTitle(R.string.undelete);
 734             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 735         } else {
 736             trashItem.setTitle(R.string.delete);
 737             trashItem.setIcon(R.drawable.ic_trash_24dp);
 738         }
 739 
 740         if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 741             // Restore the search query on landscape tablets
 742             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 743                 mSearchMenuItem.expandActionView();
 744                 mSearchView.setQuery(mTabletSearchQuery, false);
 745                 mSearchView.clearFocus();
 746             }
 747 
 748             updateActionsForLargeLandscape(menu);
 749         } else {
 750             menu.findItem(R.id.menu_search).setVisible(true);
 751             menu.findItem(R.id.menu_share).setVisible(false);
 752             menu.findItem(R.id.menu_view_info).setVisible(false);
 753             menu.findItem(R.id.menu_checklist).setVisible(false);
 754             menu.findItem(R.id.menu_history).setVisible(false);
 755             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 756             menu.findItem(R.id.menu_sidebar).setVisible(false);
 757             trashItem.setVisible(false);
 758             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 759         }
 760 
 761         if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 762             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 763             mEmptyTrashMenuItem.setVisible(true);
 764 
 765             updateTrashMenuItem();
 766 
 767             menu.findItem(R.id.menu_search).setVisible(false);
 768             menu.findItem(R.id.menu_share).setVisible(false);
 769             menu.findItem(R.id.menu_history).setVisible(false);
 770             menu.findItem(R.id.menu_checklist).setVisible(false);
 771         }
 772 
 773         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 774 
 775         return true;
 776     }
 777 
 778     @Override
 779     public boolean onOptionsItemSelected(MenuItem item) {
 780         if (mDrawerToggle.onOptionsItemSelected(item)) {
 781             return true;
 782         }
 783         switch (item.getItemId()) {
 784             case R.id.menu_sidebar:
 785                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 786                 if (mNoteListFragment.isHidden()) {
 787                     ft.show(mNoteListFragment);
 788                 } else {
 789                     ft.hide(mNoteListFragment);
 790                 }
 791                 ft.commitNowAllowingStateLoss();
 792                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 793                 return true;
 794             case R.id.menu_markdown_preview:
 795                 if (mIsShowingMarkdown) {
 796                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 797                     item.setTitle(getString(R.string.markdown_show));
 798                     setMarkdownShowing(false);
 799                     mCurrentNote.setPreviewEnabled(false);
 800                 } else {
 801                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 802                     item.setTitle(getString(R.string.markdown_hide));
 803                     setMarkdownShowing(true);
 804                     mCurrentNote.setPreviewEnabled(true);
 805                 }
 806 
 807                 mCurrentNote.save();
 808                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 809 
 810                 return true;
 811             case R.id.menu_delete:
 812                 if (mNoteEditorFragment != null) {
 813                     if (mCurrentNote != null) {
 814                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 815                         mCurrentNote.setModificationDate(Calendar.getInstance());
 816                         mCurrentNote.save();
 817 
 818                         updateViewsAfterTrashAction(mCurrentNote);
 819                     }
 820                 }
 821                 return true;
 822             case R.id.menu_empty_trash:
<abbr title=" 823                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 823                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 824 
 825                 alert.setTitle(R.string.empty_trash);
 826                 alert.setMessage(R.string.confirm_empty_trash);
 827                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 828                     public void onClick(DialogInterface dialog, int whichButton) {
 829                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 830                         AnalyticsTracker.track(
 831                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 832                                 AnalyticsTracker.CATEGORY_NOTE,
 833                                 &quot;overflow_menu&quot;
 834                         );
 835                     }
 836                 });
 837                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 838                     public void onClick(DialogInterface dialog, int whichButton) {
 839                         // Do nothing, just closing the dialog
 840                     }
 841                 });
 842                 alert.show();
 843                 return true;
 844             case android.R.id.home:
 845                 invalidateOptionsMenu();
 846                 return true;
 847             default:
 848                 return super.onOptionsItemSelected(item);
 849         }
 850     }
 851 
 852     @Override
 853     public boolean onPrepareOptionsMenu(Menu menu) {
 854         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 855 
 856         if (mIsShowingMarkdown) {
 857             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 858             markdownItem.setTitle(getString(R.string.markdown_hide));
 859         } else {
 860             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 861             markdownItem.setTitle(getString(R.string.markdown_show));
 862         }
 863 
 864         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 865 
 866         return super.onPrepareOptionsMenu(menu);
 867     }
 868 
 869     private void updateActionsForLargeLandscape(Menu menu) {
 870         if (mCurrentNote != null) {
 871             menu.findItem(R.id.menu_checklist).setVisible(true);
 872             menu.findItem(R.id.menu_delete).setVisible(true);
 873             menu.findItem(R.id.menu_history).setVisible(true);
 874             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 875             menu.findItem(R.id.menu_share).setVisible(true);
 876             menu.findItem(R.id.menu_sidebar).setVisible(true);
 877             menu.findItem(R.id.menu_view_info).setVisible(true);
 878         } else {
 879             menu.findItem(R.id.menu_checklist).setVisible(false);
 880             menu.findItem(R.id.menu_delete).setVisible(false);
 881             menu.findItem(R.id.menu_history).setVisible(false);
 882             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 883             menu.findItem(R.id.menu_share).setVisible(false);
 884             menu.findItem(R.id.menu_sidebar).setVisible(false);
 885             menu.findItem(R.id.menu_view_info).setVisible(false);
 886         }
 887 
 888         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 889     }
 890 
 891     public void updateViewsAfterTrashAction(Note note) {
 892         if (note == null || isFinishing()) {
 893             return;
 894         }
 895 
 896         if (note.isDeleted()) {
 897             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 898             deletedNoteIds.add(note.getSimperiumKey());
 899             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 900             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 901             AnalyticsTracker.track(
 902                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 903                     AnalyticsTracker.CATEGORY_NOTE,
 904                     &quot;overflow_menu&quot;
 905             );
 906         } else {
 907             AnalyticsTracker.track(
 908                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 909                     AnalyticsTracker.CATEGORY_NOTE,
 910                     &quot;overflow_menu&quot;
 911             );
 912         }
 913 
 914         // If we just deleted/restored the active note, show the placeholder
 915         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 916             showDetailPlaceholder();
 917         }
 918 
 919         NoteListFragment fragment = getNoteListFragment();
 920         if (fragment != null) {
 921             fragment.getPrefs();
 922             fragment.refreshList();
 923         }
 924 
 925         invalidateOptionsMenu();
 926     }
 927 
 928     public void setMarkdownShowing(boolean isMarkdownShowing) {
 929         mIsShowingMarkdown = isMarkdownShowing;
 930         if (mNoteEditorFragment != null) {
 931             if (isMarkdownShowing) {
 932                 mNoteEditorFragment.showMarkdown();
 933             } else {
 934                 mNoteEditorFragment.hideMarkdown();
 935             }
 936         }
 937         invalidateOptionsMenu();
 938     }
 939 
 940     /**
 941      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 942      * the item with the given ID was selected. Used for tablets only.
 943      */
 944     @Override
<abbr title=" 945     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 945     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 946         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 947             // Launch the editor activity
 948             Bundle arguments = new Bundle();
 949             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 950             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 951             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 952 
 953             if (matchOffsets != null) {
 954                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 955             }
 956 
 957             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 958             editNoteIntent.putExtras(arguments);
 959             if (mNoteListFragment.isHidden()) {
 960                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 961             }
 962             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 963         } else {
 964             mNoteEditorFragment.setNote(noteID, matchOffsets);
 965             getNoteListFragment().setNoteSelected(noteID);
 966             setMarkdownShowing(isPreviewEnabled);
 967 
 968             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 969                 mTabletSearchQuery = mSearchView.getQuery().toString();
 970             }
 971 
 972             mNoteEditorFragment.clearMarkdown();
 973 
 974             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 975                 setMarkdownShowing(false);
 976             }
 977 
 978             invalidateOptionsMenu();
 979         }
 980 
 981         AnalyticsTracker.track(
 982                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 983                 AnalyticsTracker.CATEGORY_NOTE,
 984                 &quot;note_list_row_tap&quot;
 985         );
 986     }
 987 
 988     @Override
 989     public void onUserCreated(User user) {
 990         // New account created
 991         AnalyticsTracker.track(
 992                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 993                 AnalyticsTracker.CATEGORY_USER,
 994                 &quot;account_created_from_login_activity&quot;
 995         );
 996     }
 997 
 998     public void onUserStatusChange(User.Status status) {
 999         switch (status) {
1000             // successfully used access token to connect to simperium bucket
1001             case AUTHORIZED:
1002                 runOnUiThread(new Runnable() {
1003                     @Override
1004                     public void run() {
1005                         if (!mNotesBucket.hasChangeVersion()) {
1006                             setToolbarProgressVisibility(true);
1007                         }
1008                     }
1009                 });
1010                 break;
1011 
1012             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1013             case NOT_AUTHORIZED:
1014                 runOnUiThread(new Runnable() {
1015                     @Override
1016                     public void run() {
1017                         startLoginActivity(true);
1018                     }
1019                 });
1020                 break;
1021 
<abbr title="1022             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1022             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1023             case UNKNOWN:
1024                 break;
1025         }
1026     }
1027 
1028     private void setToolbarProgressVisibility(boolean isVisible) {
1029         if (getSupportActionBar() != null) {
1030             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1031         }
1032     }
1033 
1034     public void startLoginActivity(boolean signInFirst) {
1035         // Clear some account-specific prefs
1036         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1037         editor.remove(PrefUtils.PREF_WP_TOKEN);
1038         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1039         editor.apply();
1040 
1041         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1042         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1043     }
1044 
1045     @Override
1046     public void recreate() {
1047         Handler handler = new Handler();
1048         handler.post(new Runnable() {
1049             @Override
1050             public void run() {
1051                 NotesActivity.super.recreate();
1052             }
1053         });
1054     }
1055 
1056     @Override
1057     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1058         super.onActivityResult(requestCode, resultCode, data);
1059         switch (requestCode) {
1060             case Simplenote.INTENT_PREFERENCES:
<abbr title="1061                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1061                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1062                 invalidateOptionsMenu();
1063                 NoteListFragment fragment = getNoteListFragment();
1064                 if (fragment != null) {
1065                     fragment.getPrefs();
1066                     fragment.refreshList();
1067                 }
1068 
1069                 break;
1070             case Simplenote.INTENT_EDIT_NOTE:
1071                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1072                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1073                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1074                         if (noteId != null) {
1075                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1076                             deletedNoteIds.add(noteId);
1077                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1078                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1078                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1079                         }
<abbr title="1080                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1080                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1081                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1082                         mNoteListFragment.setNoteSelected(selectedNoteId);
1083                         if (mNoteEditorFragment != null) {
1084                             mNoteEditorFragment.setNote(selectedNoteId);
1085                         }
1086                     }
1087                 }
1088                 break;
1089             case Simperium.SIGNUP_SIGNIN_REQUEST:
1090                 invalidateOptionsMenu();
1091 
1092                 Simplenote app = (Simplenote) getApplication();
1093                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1094                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1095 
1096                 AnalyticsTracker.track(
1097                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1098                         AnalyticsTracker.CATEGORY_USER,
1099                         &quot;signed_in_from_login_activity&quot;
1100                 );
1101 
1102                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1103                     finish();
1104                 }
1105 
1106                 break;
1107         }
1108     }
1109 
1110     @Override
1111     public void onUndo() {
1112         if (mUndoBarController == null) return;
1113 
1114         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1115         if (deletedNoteIds != null) {
1116             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1117                 Note deletedNote;
1118                 try {
1119                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1120                 } catch (BucketObjectMissingException e) {
1121                     return;
1122                 }
1123                 if (deletedNote != null) {
1124                     deletedNote.setDeleted(false);
1125                     deletedNote.setModificationDate(Calendar.getInstance());
1126                     deletedNote.save();
1127                     NoteListFragment fragment = getNoteListFragment();
1128                     if (fragment != null) {
1129                         fragment.getPrefs();
1130                         fragment.refreshList();
1131                     }
1132                 }
1133             }
1134         }
1135     }
1136 
1137     @Override
1138     protected void onPostCreate(Bundle savedInstanceState) {
1139         super.onPostCreate(savedInstanceState);
1140         // Sync the toggle state after onRestoreInstanceState has occurred.
1141         mDrawerToggle.syncState();
1142     }
1143 
1144     @Override
1145     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1146         super.onConfigurationChanged(newConfig);
1147 
1148         mDrawerToggle.onConfigurationChanged(newConfig);
1149 
1150         if (DisplayUtils.isLargeScreen(this)) {
1151             mIsShowingMarkdown = false;
1152 
1153             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1154                 // Add the editor fragment
1155                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1156                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1156                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1157                 } else if (DisplayUtils.isLandscape(this)) {
1158                     addEditorFragment();
1159                 }
1160 
1161                 if (mNoteListFragment != null) {
1162                     mNoteListFragment.setActivateOnItemClick(true);
1163                     mNoteListFragment.setDividerVisible(true);
1164                 }
1165 
1166                 // Select the current note on a tablet
1167                 if (mCurrentNote != null) {
<abbr title="1168                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1168                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1169                 } else {
1170                     mNoteEditorFragment.setPlaceholderVisible(true);
1171                     mNoteListFragment.getListView().clearChoices();
1172                 }
1173 
1174                 invalidateOptionsMenu();
<abbr title="1175             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1175             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1176             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1177                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1177                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1178             }
1179         }
1180 
1181         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1182             // Remove the editor fragment when rotating back to portrait
1183             mCurrentNote = null;
1184             if (mNoteListFragment != null) {
1185                 mNoteListFragment.setActivateOnItemClick(false);
1186                 mNoteListFragment.setDividerVisible(false);
1187                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1188                 mNoteListFragment.refreshList();
1189             }
1190             FragmentManager fm = getSupportFragmentManager();
1191             FragmentTransaction ft = fm.beginTransaction();
1192             ft.remove(mNoteEditorFragment);
1193             mNoteEditorFragment = null;
1194             ft.commitAllowingStateLoss();
1195             fm.executePendingTransactions();
1196             invalidateOptionsMenu();
1197         }
1198     }
1199 
1200     public void checkEmptyListText(boolean isSearch) {
1201         if (isSearch) {
<abbr title="1202             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1202             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1203             getNoteListFragment().setEmptyListViewClickable(false);
1204         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1205             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1205             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1206             AnalyticsTracker.track(
1207                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1208                     AnalyticsTracker.CATEGORY_NOTE,
1209                     &quot;trash_filter_selected&quot;
1210             );
1211             getNoteListFragment().setEmptyListViewClickable(false);
1212         } else {
<abbr title="1213             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1213             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1214             getNoteListFragment().setEmptyListViewClickable(true);
1215         }
1216     }
1217 
1218     public void showDetailPlaceholder() {
1219         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1220             mCurrentNote = null;
1221             mNoteEditorFragment.setPlaceholderVisible(true);
1222             mNoteEditorFragment.clearMarkdown();
1223             mNoteEditorFragment.hideMarkdown();
1224             mIsShowingMarkdown = false;
1225         }
1226     }
1227 
1228     public void stopListeningToNotesBucket() {
1229         mNotesBucket.removeOnNetworkChangeListener(this);
1230         mNotesBucket.removeOnSaveObjectListener(this);
1231         mNotesBucket.removeOnDeleteObjectListener(this);
1232     }
1233 
1234     // Returns the appropriate view to show the undo bar within
1235     private View getUndoView() {
1236         View undoView = mFragmentsContainer;
1237         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1238                 getNoteListFragment() != null &amp;&amp;
1239                 getNoteListFragment().getRootView() != null) {
1240             undoView = getNoteListFragment().getRootView();
1241         }
1242 
1243         return undoView;
1244     }
1245 
1246     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1247         if (mUndoBarController != null) {
1248             mUndoBarController.setDeletedNoteIds(noteIds);
1249             mUndoBarController.showUndoBar(
1250                     getUndoView(),
<abbr title="1251                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1251                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1252             );
1253         }
1254     }
1255 
1256     /* Simperium Bucket Listeners */
1257     // received a change from the network, refresh the list
1258     @Override
1259     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1260         runOnUiThread(new Runnable() {
1261             @Override
1262             public void run() {
1263                 if (type == Bucket.ChangeType.INDEX) {
1264                     setToolbarProgressVisibility(false);
1265                 }
1266                 mNoteListFragment.refreshList();
1267             }
1268         });
1269     }
1270 
1271     @Override
1272     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1273         runOnUiThread(new Runnable() {
1274             @Override
1275             public void run() {
1276                 mNoteListFragment.refreshList();
1277             }
1278         });
1279     }
1280 
1281     @Override
1282     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1283         runOnUiThread(new Runnable() {
1284             @Override
1285             public void run() {
1286                 mNoteListFragment.refreshList();
1287             }
1288         });
1289     }
1290 
1291     @Override
1292     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1293         // noop, NoteEditorFragment will handle this
1294     }
1295 
1296     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1297 
1298         @Override
1299         protected Void doInBackground(Void... voids) {
1300             if (mNotesBucket == null) return null;
1301 
1302             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1303             Bucket.ObjectCursor c = query.execute();
1304             while (c.moveToNext()) {
1305                 c.getObject().delete();
1306             }
1307 
1308             return null;
1309         }
1310 
1311         @Override
1312         protected void onPostExecute(Void nada) {
1313             showDetailPlaceholder();
1314         }
1315     }
1316 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.content.DialogInterface;
   5 import android.content.Intent;
   6 import android.content.SharedPreferences;
   7 import android.content.res.ColorStateList;
   8 import android.content.res.Configuration;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.text.TextUtils;
  13 import android.view.Menu;
  14 import android.view.MenuInflater;
  15 import android.view.MenuItem;
  16 import android.view.View;
  17 import android.widget.ListView;
  18 import android.widget.ProgressBar;
  19 import androidx.annotation.NonNull;
  20 import androidx.appcompat.app.ActionBar;
  21 import androidx.appcompat.app.ActionBarDrawerToggle;
  22 import androidx.appcompat.app.AlertDialog;
  23 import androidx.appcompat.app.AppCompatActivity;
  24 import androidx.appcompat.view.ContextThemeWrapper;
  25 import androidx.appcompat.widget.SearchView;
  26 import androidx.appcompat.widget.Toolbar;
  27 import androidx.core.view.GravityCompat;
  28 import androidx.drawerlayout.widget.DrawerLayout;
  29 import androidx.fragment.app.FragmentManager;
  30 import androidx.fragment.app.FragmentTransaction;
  31 import androidx.preference.PreferenceManager;
  32 import com.automattic.simplenote.analytics.AnalyticsTracker;
  33 import com.automattic.simplenote.models.Note;
  34 import com.automattic.simplenote.models.Tag;
  35 import com.automattic.simplenote.utils.CrashUtils;
  36 import com.automattic.simplenote.utils.DisplayUtils;
  37 import com.automattic.simplenote.utils.DrawableUtils;
  38 import com.automattic.simplenote.utils.HtmlCompat;
  39 import com.automattic.simplenote.utils.PrefUtils;
  40 import com.automattic.simplenote.utils.StrUtils;
  41 import com.automattic.simplenote.utils.TagsAdapter;
  42 import com.automattic.simplenote.utils.ThemeUtils;
  43 import com.automattic.simplenote.utils.UndoBarController;
  44 import com.google.android.material.navigation.NavigationView;
  45 import com.simperium.Simperium;
  46 import com.simperium.client.Bucket;
  47 import com.simperium.client.BucketObjectMissingException;
  48 import com.simperium.client.BucketObjectNameInvalid;
  49 import com.simperium.client.Query;
  50 import com.simperium.client.User;
  51 import java.util.ArrayList;
  52 import java.util.Calendar;
  53 import java.util.HashMap;
  54 import java.util.List;
  55 import java.util.Map;
  56 import org.wordpress.passcodelock.AppLockManager;
  57 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  58 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  59 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  60 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  61 import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  62 import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  63 import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  64 import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  65 import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  66 import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  67 
  68 
<abbr title="  69 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  69 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  70     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  71 
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73 
  74     protected Bucket&lt;Note&gt; mNotesBucket;
  75 
  76     protected Bucket&lt;Tag&gt; mTagsBucket;
  77 
  78     private boolean mIsShowingMarkdown;
  79 
  80     private boolean mShouldSelectNewNote;
  81 
  82     private boolean mIsSettingsClicked;
  83 
  84     private boolean mIsTabetFullscreen;
  85 
  86     private String mTabletSearchQuery;
  87 
  88     private UndoBarController mUndoBarController;
  89 
  90     private View mFragmentsContainer;
  91 
  92     private SearchView mSearchView;
  93 
  94     private MenuItem mSearchMenuItem;
  95 
  96     private NoteListFragment mNoteListFragment;
  97 
  98     private NoteEditorFragment mNoteEditorFragment;
  99 
 100     private Note mCurrentNote;
 101 
 102     private MenuItem mEmptyTrashMenuItem;
 103 
 104     // Menu drawer
 105     // Menu drawer
 106     private static final int GROUP_PRIMARY = 100;
 107 
 108     private static final int GROUP_SECONDARY = 101;
 109 
 110     private static final int GROUP_TERTIARY = 102;
 111 
 112     private DrawerLayout mDrawerLayout;
 113 
 114     private Menu mNavigationMenu;
 115 
 116     private ActionBarDrawerToggle mDrawerToggle;
 117 
 118     private TagsAdapter mTagsAdapter;
 119 
 120     private TagsAdapter.TagMenuItem mSelectedTag;
 121 
 122     // Tags bucket listener
 123     // Tags bucket listener
 124     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 125         void updateNavigationDrawer() {
 126             runOnUiThread(new Runnable() {
 127                 public void run() {
 128                     updateNavigationDrawerItems();
 129                 }
 130             });
 131         }
 132 
 133         @Override
 134         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 135             updateNavigationDrawer();
 136         }
 137 
 138         @Override
 139         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 140             updateNavigationDrawer();
 141         }
 142 
 143         @Override
 144         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 145             updateNavigationDrawer();
 146         }
 147 
 148         @Override
 149         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 150             // noop
 151         }
 152     };
 153 
 154     @Override
 155     protected void onCreate(Bundle savedInstanceState) {
 156         ThemeUtils.setTheme(this);
 157         super.onCreate(savedInstanceState);
 158 
 159         setContentView(R.layout.activity_notes);
 160 
 161         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 162 
 163         Simplenote currentApp = (Simplenote) getApplication();
 164         if (mNotesBucket == null) {
 165             mNotesBucket = currentApp.getNotesBucket();
 166         }
 167 
 168         if (mTagsBucket == null) {
 169             mTagsBucket = currentApp.getTagsBucket();
 170         }
 171 
 172         Toolbar toolbar = findViewById(R.id.toolbar);
 173         setSupportActionBar(toolbar);
 174         configureNavigationDrawer(toolbar);
 175 
 176         if (savedInstanceState == null) {
 177             mNoteListFragment = new NoteListFragment();
 178             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 179             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 180             fragmentTransaction.commit();
 181         } else {
<abbr title=" 182             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 182             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 183         }
 184         mIsTabetFullscreen = mNoteListFragment.isHidden();
 185 
 186         if (DisplayUtils.isLargeScreen(this)) {
 187             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 188                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 188                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 189             } else if (DisplayUtils.isLandscape(this)) {
 190                 addEditorFragment();
 191             }
 192         }
 193 
 194         // enable ActionBar app icon to behave as action to toggle nav drawer
 195         ActionBar actionBar = getSupportActionBar();
 196         if (actionBar != null) {
 197             actionBar.setDisplayHomeAsUpEnabled(true);
 198             actionBar.setHomeButtonEnabled(true);
 199 
 200             // Add loading indicator to show when indexing
<abbr title=" 201             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 201             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 202             actionBar.setDisplayShowCustomEnabled(true);
 203             actionBar.setCustomView(progressBar);
 204             setToolbarProgressVisibility(false);
 205         }
 206 
 207         mUndoBarController = new UndoBarController(this);
 208 
 209         // Creates &#x27;Welcome&#x27; note
 210         checkForFirstLaunch();
 211 
 212         checkForSharedContent();
 213 
 214         currentApp.getSimperium().setOnUserCreatedListener(this);
 215         currentApp.getSimperium().setUserStatusChangeListener(this);
 216     }
 217 
 218     @Override
 219     protected void onResume() {
 220         super.onResume();
 221 
 222         // Ensure user has valid authorization
 223         if (userAuthenticationIsInvalid()) {
 224             startLoginActivity(true);
 225             Intent intent = getIntent();
 226 
 227             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 228                     intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 229                 AnalyticsTracker.track(
 230                         NOTE_WIDGET_SIGN_IN_TAPPED,
 231                         CATEGORY_WIDGET,
 232                         &quot;note_widget_sign_in_tapped&quot;
 233                 );
 234             }
 235         }
 236 
 237         disableScreenshotsIfLocked(this);
 238 
 239         mNotesBucket.start();
 240         mTagsBucket.start();
 241 
 242         mNotesBucket.addOnNetworkChangeListener(this);
 243         mNotesBucket.addOnSaveObjectListener(this);
 244         mNotesBucket.addOnDeleteObjectListener(this);
 245         mTagsBucket.addListener(mTagsMenuUpdater);
 246 
 247         updateNavigationDrawerItems();
 248 
 249         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 250         if (userIsUnauthorized()) {
 251             if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 252                 mSelectedTag = null;
 253                 mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 254             }
 255         }
 256 
 257         filterListBySelectedTag();
 258 
 259         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 260             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 260             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCuðŸ”µ</abbr>
 261             mShouldSelectNewNote = false;
 262         }
 263 
 264         if (mIsShowingMarkdown) {
 265             setMarkdownShowing(false);
 266         }
 267 
 268         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 269         if(DisplayUtils.isLargeScreenLandscape(this)) {
 270             if (mIsTabetFullscreen) {
 271                 ft.hide(mNoteListFragment);
 272             } else {
 273                 ft.show(mNoteListFragment);
 274             }
 275         } else {
 276             ft.show(mNoteListFragment);
 277         }
 278         ft.commitNow();
 279     }
 280 
 281     @Override
 282     protected void onPause() {
 283         super.onPause();  // Always call the superclass method first
 284         mTagsBucket.removeListener(mTagsMenuUpdater);
 285         mTagsBucket.stop();
 286 
 287         mNotesBucket.removeOnNetworkChangeListener(this);
 288         mNotesBucket.removeOnSaveObjectListener(this);
 289         mNotesBucket.removeOnDeleteObjectListener(this);
 290         mNotesBucket.stop();
 291     }
 292 
 293     @Override
 294     public void setTitle(CharSequence title) {
 295         if (getSupportActionBar() != null) {
 296             getSupportActionBar().setTitle(title);
 297         }
 298     }
 299 
 300     @Override
 301     public void onBackPressed() {
 302         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 303             mDrawerLayout.closeDrawer(GravityCompat.START);
 304         } else {
 305             super.onBackPressed();
 306         }
 307     }
 308 
 309     @Override
 310     public void onActionModeCreated() {
 311         mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 312     }
 313 
 314     @Override
 315     public void onActionModeDestroyed() {
 316         if ((mSearchMenuItem != null) &amp;&amp; (!mSearchMenuItem.isActionViewExpanded())) {
 317             mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 318         }
 319     }
 320 
 321     private ColorStateList getIconSelector() {
 322         int[][] states = new int[][] {
 323                 new int[] { android.R.attr.state_checked}, // checked
 324                 new int[] {-android.R.attr.state_checked}  // unchecked
 325         };
 326 
 327         int[] colors = new int[] {
 328                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 329                 ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 330         };
 331 
 332         return new ColorStateList(states, colors);
 333     }
 334 
 335     private ColorStateList getTextSelector() {
 336         int[][] states = new int[][] {
 337             new int[] {-android.R.attr.state_enabled}, // disabled
 338             new int[] { android.R.attr.state_checked}, // checked
 339             new int[] {-android.R.attr.state_checked}  // unchecked
 340         };
 341 
 342         int[] colors = new int[] {
 343             getResources().getColor(R.color.text_title_disabled, getTheme()),
 344             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 345             ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 346         };
 347 
 348         return new ColorStateList(states, colors);
 349     }
 350 
 351     private void configureNavigationDrawer(Toolbar toolbar) {
 352         ColorStateList iconSelector = getIconSelector();
 353         ColorStateList textSelector = getTextSelector();
 354         mDrawerLayout = findViewById(R.id.drawer_layout);
 355         NavigationView navigationView = findViewById(R.id.navigation_view);
 356         navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 357         navigationView.setItemIconTintList(iconSelector);
 358         navigationView.setItemTextColor(textSelector);
 359         navigationView.setNavigationItemSelectedListener(
 360             new NavigationView.OnNavigationItemSelectedListener() {
 361                 @Override
 362                 public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 363                     mDrawerLayout.closeDrawer(GravityCompat.START);
 364 
 365                     if (item.getItemId() == SETTINGS_ID) {
 366                         AnalyticsTracker.track(
 367                                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 368                                 AnalyticsTracker.CATEGORY_TAG,
 369                                 &quot;selected_tag_in_navigation_drawer&quot;,
 370                                 new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 371                         );
 372                         mIsSettingsClicked = true;
 373                         return false;
 374                     } else {
 375                         mSelectedTag = mTagsAdapter.getTagFromItem(item);
 376                         filterListBySelectedTag();
 377                         return true;
 378                     }
 379                 }
 380             }
 381         );
 382 
 383         mNavigationMenu = navigationView.getMenu();
<abbr title=" 384         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 384         mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcoðŸ”µ</abbr>
<abbr title=" 385         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 385         mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawðŸ”µ</abbr>
<abbr title=" 386         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 386         mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(ðŸ”µ</abbr>
 387         mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 388 
 389         if (mSelectedTag == null)
 390             mSelectedTag = mTagsAdapter.getDefaultItem();
 391 
 392         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 393                 R.string.close_drawer) {
 394             public void onDrawerClosed(View view) {
 395                 supportInvalidateOptionsMenu();
 396 
 397                 if (mIsSettingsClicked) {
 398                     Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 399                     startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 400                     mIsSettingsClicked = false;
 401                 }
 402             }
 403 
 404             public void onDrawerOpened(View drawerView) {
 405                 // noop
 406             }
 407 
 408             @Override
 409             public void onDrawerSlide(View drawerView, float slideOffset) {
 410                 super.onDrawerSlide(drawerView, 0f);
 411             }
 412         };
 413 
 414         mDrawerLayout.addDrawerListener(mDrawerToggle);
 415     }
 416 
 417     private void filterListBySelectedTag() {
 418         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 419 
 420         if (selectedMenuItem != null) {
 421             mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 422         } else {
 423             mSelectedTag = mTagsAdapter.getDefaultItem();
 424         }
 425 
 426         checkEmptyListText(false);
 427 
 428         if (mNoteListFragment.isHidden()) {
 429             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 430             fragmentTransaction.show(mNoteListFragment);
 431             fragmentTransaction.commitNowAllowingStateLoss();
 432         }
 433 
 434         // Disable long press on notes when viewing Trash.
 435         if (mSelectedTag.id == TRASH_ID) {
 436             getNoteListFragment().getListView().setLongClickable(false);
 437         } else {
 438             getNoteListFragment().getListView().setLongClickable(true);
 439         }
 440 
 441         getNoteListFragment().refreshListFromNavSelect();
 442 
 443         Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 444 
 445         switch ((int) mSelectedTag.id) {
 446             case ALL_NOTES_ID:
 447                 properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 448                 break;
 449             case TRASH_ID:
 450                 properties.put(&quot;tag&quot;, &quot;trash&quot;);
 451                 break;
 452             case UNTAGGED_NOTES_ID:
 453                 properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 454                 break;
 455             default:
 456                 properties = null;
 457                 break;
 458         }
 459 
 460         AnalyticsTracker.track(
 461                 AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 462                 AnalyticsTracker.CATEGORY_TAG,
 463                 &quot;selected_tag_in_navigation_drawer&quot;,
 464                 properties
 465         );
 466 
 467         setSelectedTagActive();
 468     }
 469 
 470     private void checkForFirstLaunch() {
 471         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 472             // Create the welcome note
 473             try {
 474                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 475                 welcomeNote.setCreationDate(Calendar.getInstance());
 476                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 477                 welcomeNote.setContent(getString(R.string.welcome_note));
 478                 welcomeNote.getTitle();
 479                 welcomeNote.save();
 480             } catch (BucketObjectNameInvalid e) {
 481                 // this won&#x27;t happen because welcome-android is a valid name
 482             }
 483 
 484             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 485             SharedPreferences.Editor editor = preferences.edit();
 486             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 487             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 488             editor.apply();
 489         }
 490     }
 491 
 492     private void checkForSharedContent() {
 493         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 494             // Check share action
 495             Intent intent = getIntent();
 496             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 497             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 498 
<abbr title=" 499             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 499             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 500             String intentAction = StrUtils.notNullStr(intent.getAction());
 501             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 502             if (!TextUtils.isEmpty(text)) {
 503                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 504                     text = subject + &quot;\n\n&quot; + text;
 505                 }
 506                 Note note = mNotesBucket.newObject();
 507                 note.setCreationDate(Calendar.getInstance());
 508                 note.setModificationDate(note.getCreationDate());
 509                 note.setContent(text);
 510                 note.save();
 511                 setCurrentNote(note);
 512                 mShouldSelectNewNote = true;
 513 
 514                 AnalyticsTracker.track(
 515                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 516                         AnalyticsTracker.CATEGORY_NOTE,
 517                         &quot;external_share&quot;
 518                 );
 519 
 520                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 521                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 522                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 523                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 524                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 525                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 526                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 527                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 528                     }
 529                 }
 530             }
 531         }
 532     }
 533 
 534     private void updateNavigationDrawerItems() {
 535         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 536         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 537         if (isAlphaSort) {
 538             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 539         } else {
 540             tagCursor = Tag.allWithName(mTagsBucket).execute();
 541         }
 542 
 543         mTagsAdapter.changeCursor(tagCursor);
 544         mNavigationMenu.removeGroup(GROUP_SECONDARY);
 545         mNavigationMenu.removeGroup(GROUP_TERTIARY);
 546 
 547         if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 548             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 548             mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionVðŸ”µ</abbr>
 549 
 550             for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 551                 String name = mTagsAdapter.getItem(i).name;
 552                 int id = (int) mTagsAdapter.getItem(i).id;
 553 
 554                 if (id &gt;= 0) { // Custom tags have a positive ID.
 555                     mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 556                 }
 557             }
 558 
<abbr title=" 559             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 559             mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untaggedðŸ”µ</abbr>
 560             setSelectedTagActive();
 561         }
 562     }
 563 
 564     public void launchEditTags(View view) {
 565         startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 566     }
 567 
 568     private void setSelectedTagActive() {
 569         if (mSelectedTag == null) {
 570             mSelectedTag = mTagsAdapter.getDefaultItem();
 571         }
 572 
 573         MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 574 
 575         if (selectedMenuItem != null) {
 576             selectedMenuItem.setChecked(true);
 577         } else {
 578             mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 579         }
 580 
 581         setTitle(mSelectedTag.name);
 582     }
 583 
 584     public TagsAdapter.TagMenuItem getSelectedTag() {
 585         if (mSelectedTag == null) {
 586             mSelectedTag = mTagsAdapter.getDefaultItem();
 587         }
 588 
 589         return mSelectedTag;
 590     }
 591 
 592     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 593     public void updateTrashMenuItem() {
 594         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 595             return;
 596 
 597         // Disable the trash icon if there are no notes trashed.
 598         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 599         if (query.count() == 0) {
 600             mEmptyTrashMenuItem.setEnabled(false);
 601         } else {
 602             mEmptyTrashMenuItem.setEnabled(true);
 603         }
 604     }
 605 
 606     private void addEditorFragment() {
 607         FragmentManager fm = getSupportFragmentManager();
 608         FragmentTransaction ft = fm.beginTransaction();
 609         mNoteEditorFragment = new NoteEditorFragment();
 610         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 611         ft.commitAllowingStateLoss();
 612         fm.executePendingTransactions();
 613     }
 614 
 615     private boolean userAccountRequired() {
 616         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 617     }
 618 
 619     /**
 620      * Checks for a previously valid user that is now not authenticated
 621      * Also checks if user account is required (added in version 1.5.6)
 622      *
 623      * @return true if user has invalid authorization
 624      */
 625     private boolean userAuthenticationIsInvalid() {
 626         Simplenote currentApp = (Simplenote) getApplication();
 627         Simperium simperium = currentApp.getSimperium();
 628         User user = simperium.getUser();
 629         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 630         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 631                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 632     }
 633 
 634     public boolean userIsUnauthorized() {
 635         Simplenote currentApp = (Simplenote) getApplication();
 636         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 637     }
 638 
 639     public void setCurrentNote(Note note) {
 640         mCurrentNote = note;
 641     }
 642 
 643     public NoteListFragment getNoteListFragment() {
 644         return mNoteListFragment;
 645     }
 646 
 647     @Override
 648     public boolean onCreateOptionsMenu(final Menu menu) {
 649         super.onCreateOptionsMenu(menu);
 650         MenuInflater inflater = getMenuInflater();
 651         inflater.inflate(R.menu.notes_list, menu);
 652         // restore the search query if on a landscape tablet
 653         String searchQuery = null;
 654         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 655             searchQuery = mSearchView.getQuery().toString();
 656         }
 657         mSearchMenuItem = menu.findItem(R.id.menu_search);
 658         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 659         if (!TextUtils.isEmpty(searchQuery)) {
 660             mSearchView.setQuery(searchQuery, false);
 661             mSearchMenuItem.expandActionView();
 662         } else {
 663             // Workaround for setting the search placeholder text color
 664             @SuppressWarnings(&quot;ResourceType&quot;)
 665             String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
<abbr title=" 666             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 666             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 667         }
 668         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 669             @Override
 670             public boolean onQueryTextChange(String newText) {
 671                 if (mSearchMenuItem.isActionViewExpanded()) {
 672                     getNoteListFragment().searchNotes(newText);
 673                 }
 674                 return true;
 675             }
 676 
 677             @Override
 678             public boolean onQueryTextSubmit(String queryText) {
 679                 getNoteListFragment().searchNotes(queryText);
 680                 return true;
 681             }
 682         });
 683         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 684             @Override
 685             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 686 
 687 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 688                 getNoteListFragment().searchNotes(&quot;&quot;);</span>
 689 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 690 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 690 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 691 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);</span>
 694 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 695 
 696                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 697                     updateActionsForLargeLandscape(menu);
 698                 }
 699                 checkEmptyListText(true);
 700                 if (mNoteListFragment != null) {
 701                     mNoteListFragment.setFloatingActionButtonVisible(false);
 702                 }
<abbr title=" 703                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGORY_NOTE, &quot;action_bar_search_tap&quot;);"> 703                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_NOTES_SEARCHED, AnalyticsTracker.CATEGOðŸ”µ</abbr>
 704                 return true;
 705             }
 706 
 707             @Override
 708             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 709                 mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);
 710                 if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 711                     updateActionsForLargeLandscape(menu);
 712                 }
 713                 // Show all notes again
 714                 if (mNoteListFragment != null) {
 715                     mNoteListFragment.setFloatingActionButtonVisible(true);
 716                 }
 717                 mTabletSearchQuery = &quot;&quot;;
 718                 mSearchView.setQuery(&quot;&quot;, false);
 719                 checkEmptyListText(false);
 720                 getNoteListFragment().clearSearch();
 721                 return true;
 722             }
 723         });
 724         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 725             @Override
 726             public boolean onMenuItemClick(MenuItem item) {
 727                 if (!mSearchMenuItem.isActionViewExpanded()) {
 728                     showDetailPlaceholder();
 729                 }
 730                 return false;
 731             }
 732         });
 733         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 734         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 735             trashItem.setTitle(R.string.undelete);
 736             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 737         } else {
 738             trashItem.setTitle(R.string.delete);
 739             trashItem.setIcon(R.drawable.ic_trash_24dp);
 740         }
 741         if (DisplayUtils.isLargeScreenLandscape(this)) {
 742             // Restore the search query on landscape tablets
 743             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 744                 mSearchMenuItem.expandActionView();
 745                 mSearchView.setQuery(mTabletSearchQuery, false);
 746                 mSearchView.clearFocus();
 747             }
 748             updateActionsForLargeLandscape(menu);
 749         } else {
 750             menu.findItem(R.id.menu_search).setVisible(true);
 751             menu.findItem(R.id.menu_share).setVisible(false);
 752             menu.findItem(R.id.menu_view_info).setVisible(false);
 753             menu.findItem(R.id.menu_checklist).setVisible(false);
 754             menu.findItem(R.id.menu_history).setVisible(false);
 755             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 756             menu.findItem(R.id.menu_sidebar).setVisible(false);
 757             trashItem.setVisible(false);
 758             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 759         }
 760         if ((mSelectedTag != null) &amp;&amp; (mSelectedTag.id == TRASH_ID)) {
 761             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 762             mEmptyTrashMenuItem.setVisible(true);
 763             updateTrashMenuItem();
 764             menu.findItem(R.id.menu_search).setVisible(false);
 765             menu.findItem(R.id.menu_share).setVisible(false);
 766             menu.findItem(R.id.menu_history).setVisible(false);
 767             menu.findItem(R.id.menu_checklist).setVisible(false);
 768         }
 769         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 770         return true;
 771     }
 772 
 773     @Override
 774     public boolean onOptionsItemSelected(MenuItem item) {
 775         if (mDrawerToggle.onOptionsItemSelected(item)) {
 776             return true;
 777         }
 778         switch (item.getItemId()) {
 779             case R.id.menu_sidebar:
 780                 FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 781                 if (mNoteListFragment.isHidden()) {
 782                     ft.show(mNoteListFragment);
 783                 } else {
 784                     ft.hide(mNoteListFragment);
 785                 }
 786                 ft.commitNowAllowingStateLoss();
 787                 mIsTabetFullscreen = mNoteListFragment.isHidden();
 788                 return true;
 789             case R.id.menu_markdown_preview:
 790                 if (mIsShowingMarkdown) {
 791                     item.setIcon(R.drawable.ic_visibility_on_24dp);
 792                     item.setTitle(getString(R.string.markdown_show));
 793                     setMarkdownShowing(false);
 794                     mCurrentNote.setPreviewEnabled(false);
 795                 } else {
 796                     item.setIcon(R.drawable.ic_visibility_off_24dp);
 797                     item.setTitle(getString(R.string.markdown_hide));
 798                     setMarkdownShowing(true);
 799                     mCurrentNote.setPreviewEnabled(true);
 800                 }
 801 
 802                 mCurrentNote.save();
 803                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 804 
 805                 return true;
 806             case R.id.menu_delete:
 807                 if (mNoteEditorFragment != null) {
 808                     if (mCurrentNote != null) {
 809                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 810                         mCurrentNote.setModificationDate(Calendar.getInstance());
 811                         mCurrentNote.save();
 812 
 813                         updateViewsAfterTrashAction(mCurrentNote);
 814                     }
 815                 }
 816                 return true;
 817             case R.id.menu_empty_trash:
<abbr title=" 818                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 818                 AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.styleðŸ”µ</abbr>
 819 
 820                 alert.setTitle(R.string.empty_trash);
 821                 alert.setMessage(R.string.confirm_empty_trash);
 822                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 823                     public void onClick(DialogInterface dialog, int whichButton) {
 824                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 825                         AnalyticsTracker.track(
 826                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 827                                 AnalyticsTracker.CATEGORY_NOTE,
 828                                 &quot;overflow_menu&quot;
 829                         );
 830                     }
 831                 });
 832                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 833                     public void onClick(DialogInterface dialog, int whichButton) {
 834                         // Do nothing, just closing the dialog
 835                     }
 836                 });
 837                 alert.show();
 838                 return true;
 839             case android.R.id.home:
 840                 invalidateOptionsMenu();
 841                 return true;
 842             default:
 843                 return super.onOptionsItemSelected(item);
 844         }
 845     }
 846 
 847     @Override
 848     public boolean onPrepareOptionsMenu(Menu menu) {
 849         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 850 
 851         if (mIsShowingMarkdown) {
 852             markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 853             markdownItem.setTitle(getString(R.string.markdown_hide));
 854         } else {
 855             markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 856             markdownItem.setTitle(getString(R.string.markdown_show));
 857         }
 858 
 859         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 860 
 861         return super.onPrepareOptionsMenu(menu);
 862     }
 863 
 864     private void updateActionsForLargeLandscape(Menu menu) {
 865         if (mCurrentNote != null) {
 866             menu.findItem(R.id.menu_checklist).setVisible(true);
 867             menu.findItem(R.id.menu_delete).setVisible(true);
 868             menu.findItem(R.id.menu_history).setVisible(true);
 869             menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 870             menu.findItem(R.id.menu_share).setVisible(true);
 871             menu.findItem(R.id.menu_sidebar).setVisible(true);
 872             menu.findItem(R.id.menu_view_info).setVisible(true);
 873         } else {
 874             menu.findItem(R.id.menu_checklist).setVisible(false);
 875             menu.findItem(R.id.menu_delete).setVisible(false);
 876             menu.findItem(R.id.menu_history).setVisible(false);
 877             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 878             menu.findItem(R.id.menu_share).setVisible(false);
 879             menu.findItem(R.id.menu_sidebar).setVisible(false);
 880             menu.findItem(R.id.menu_view_info).setVisible(false);
 881         }
 882 
 883         menu.findItem(R.id.menu_empty_trash).setVisible(false);
 884     }
 885 
 886     public void updateViewsAfterTrashAction(Note note) {
 887         if (note == null || isFinishing()) {
 888             return;
 889         }
 890 
 891         if (note.isDeleted()) {
 892             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 893             deletedNoteIds.add(note.getSimperiumKey());
 894             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 895             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 896             AnalyticsTracker.track(
 897                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 898                     AnalyticsTracker.CATEGORY_NOTE,
 899                     &quot;overflow_menu&quot;
 900             );
 901         } else {
 902             AnalyticsTracker.track(
 903                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 904                     AnalyticsTracker.CATEGORY_NOTE,
 905                     &quot;overflow_menu&quot;
 906             );
 907         }
 908 
 909         // If we just deleted/restored the active note, show the placeholder
 910         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 911             showDetailPlaceholder();
 912         }
 913 
 914         NoteListFragment fragment = getNoteListFragment();
 915         if (fragment != null) {
 916             fragment.getPrefs();
 917             fragment.refreshList();
 918         }
 919 
 920         invalidateOptionsMenu();
 921     }
 922 
 923     public void setMarkdownShowing(boolean isMarkdownShowing) {
 924         mIsShowingMarkdown = isMarkdownShowing;
 925         if (mNoteEditorFragment != null) {
 926             if (isMarkdownShowing) {
 927                 mNoteEditorFragment.showMarkdown();
 928             } else {
 929                 mNoteEditorFragment.hideMarkdown();
 930             }
 931         }
 932         invalidateOptionsMenu();
 933     }
 934 
 935     /**
 936      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 937      * the item with the given ID was selected. Used for tablets only.
 938      */
 939     @Override
<abbr title=" 940     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 940     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 941         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 942             // Launch the editor activity
 943             Bundle arguments = new Bundle();
 944             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 945             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 946             arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 947 
 948             if (matchOffsets != null) {
 949                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 950             }
 951 
 952             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 953             editNoteIntent.putExtras(arguments);
 954             if (mNoteListFragment.isHidden()) {
 955                 editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 956             }
 957             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 958         } else {
 959             mNoteEditorFragment.setNote(noteID, matchOffsets);
 960             getNoteListFragment().setNoteSelected(noteID);
 961             setMarkdownShowing(isPreviewEnabled);
 962 
 963             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 964                 mTabletSearchQuery = mSearchView.getQuery().toString();
 965             }
 966 
 967             mNoteEditorFragment.clearMarkdown();
 968 
 969             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 970                 setMarkdownShowing(false);
 971             }
 972 
 973             invalidateOptionsMenu();
 974         }
 975 
 976         AnalyticsTracker.track(
 977                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 978                 AnalyticsTracker.CATEGORY_NOTE,
 979                 &quot;note_list_row_tap&quot;
 980         );
 981     }
 982 
 983     @Override
 984     public void onUserCreated(User user) {
 985         // New account created
 986         AnalyticsTracker.track(
 987                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 988                 AnalyticsTracker.CATEGORY_USER,
 989                 &quot;account_created_from_login_activity&quot;
 990         );
 991     }
 992 
 993     public void onUserStatusChange(User.Status status) {
 994         switch (status) {
 995             // successfully used access token to connect to simperium bucket
 996             case AUTHORIZED:
 997                 runOnUiThread(new Runnable() {
 998                     @Override
 999                     public void run() {
1000                         if (!mNotesBucket.hasChangeVersion()) {
1001                             setToolbarProgressVisibility(true);
1002                         }
1003                     }
1004                 });
1005                 break;
1006 
1007             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1008             case NOT_AUTHORIZED:
1009                 runOnUiThread(new Runnable() {
1010                     @Override
1011                     public void run() {
1012                         startLoginActivity(true);
1013                     }
1014                 });
1015                 break;
1016 
<abbr title="1017             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1017             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
1018             case UNKNOWN:
1019                 break;
1020         }
1021     }
1022 
1023     private void setToolbarProgressVisibility(boolean isVisible) {
1024         if (getSupportActionBar() != null) {
1025             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1026         }
1027     }
1028 
1029     public void startLoginActivity(boolean signInFirst) {
1030         // Clear some account-specific prefs
1031         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1032         editor.remove(PrefUtils.PREF_WP_TOKEN);
1033         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1034         editor.apply();
1035 
1036         Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1037         startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1038     }
1039 
1040     @Override
1041     public void recreate() {
1042         Handler handler = new Handler();
1043         handler.post(new Runnable() {
1044             @Override
1045             public void run() {
1046                 NotesActivity.super.recreate();
1047             }
1048         });
1049     }
1050 
1051     @Override
1052     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1053         super.onActivityResult(requestCode, resultCode, data);
1054         switch (requestCode) {
1055             case Simplenote.INTENT_PREFERENCES:
<abbr title="1056                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1056                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
1057                 invalidateOptionsMenu();
1058                 NoteListFragment fragment = getNoteListFragment();
1059                 if (fragment != null) {
1060                     fragment.getPrefs();
1061                     fragment.refreshList();
1062                 }
1063 
1064                 break;
1065             case Simplenote.INTENT_EDIT_NOTE:
1066                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
1067                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1068                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1069                         if (noteId != null) {
1070                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1071                             deletedNoteIds.add(noteId);
1072                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title="1073                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));">1073                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
1074                         }
<abbr title="1075                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1075                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
1076                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1077                         mNoteListFragment.setNoteSelected(selectedNoteId);
1078                         if (mNoteEditorFragment != null) {
1079                             mNoteEditorFragment.setNote(selectedNoteId);
1080                         }
1081                     }
1082                 }
1083                 break;
1084             case Simperium.SIGNUP_SIGNIN_REQUEST:
1085                 invalidateOptionsMenu();
1086 
1087                 Simplenote app = (Simplenote) getApplication();
1088                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1089                 CrashUtils.setCurrentUser(app.getSimperium().getUser());
1090 
1091                 AnalyticsTracker.track(
1092                         AnalyticsTracker.Stat.USER_SIGNED_IN,
1093                         AnalyticsTracker.CATEGORY_USER,
1094                         &quot;signed_in_from_login_activity&quot;
1095                 );
1096 
1097                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1098                     finish();
1099                 }
1100 
1101                 break;
1102         }
1103     }
1104 
1105     @Override
1106     public void onUndo() {
1107         if (mUndoBarController == null) return;
1108 
1109         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1110         if (deletedNoteIds != null) {
1111             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1112                 Note deletedNote;
1113                 try {
1114                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1115                 } catch (BucketObjectMissingException e) {
1116                     return;
1117                 }
1118                 if (deletedNote != null) {
1119                     deletedNote.setDeleted(false);
1120                     deletedNote.setModificationDate(Calendar.getInstance());
1121                     deletedNote.save();
1122                     NoteListFragment fragment = getNoteListFragment();
1123                     if (fragment != null) {
1124                         fragment.getPrefs();
1125                         fragment.refreshList();
1126                     }
1127                 }
1128             }
1129         }
1130     }
1131 
1132     @Override
1133     protected void onPostCreate(Bundle savedInstanceState) {
1134         super.onPostCreate(savedInstanceState);
1135         // Sync the toggle state after onRestoreInstanceState has occurred.
1136         mDrawerToggle.syncState();
1137     }
1138 
1139     @Override
1140     public void onConfigurationChanged(@NonNull Configuration newConfig) {
1141         super.onConfigurationChanged(newConfig);
1142 
1143         mDrawerToggle.onConfigurationChanged(newConfig);
1144 
1145         if (DisplayUtils.isLargeScreen(this)) {
1146             mIsShowingMarkdown = false;
1147 
1148             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1149                 // Add the editor fragment
1150                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1151                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1151                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
1152                 } else if (DisplayUtils.isLandscape(this)) {
1153                     addEditorFragment();
1154                 }
1155 
1156                 if (mNoteListFragment != null) {
1157                     mNoteListFragment.setActivateOnItemClick(true);
1158                     mNoteListFragment.setDividerVisible(true);
1159                 }
1160 
1161                 // Select the current note on a tablet
1162                 if (mCurrentNote != null) {
<abbr title="1163                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1163                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1164                 } else {
1165                     mNoteEditorFragment.setPlaceholderVisible(true);
1166                     mNoteListFragment.getListView().clearChoices();
1167                 }
1168 
1169                 invalidateOptionsMenu();
<abbr title="1170             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait">1170             // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to poðŸ”µ</abbr>
1171             } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1172                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1172                 onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(),ðŸ”µ</abbr>
1173             }
1174         }
1175 
1176         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1177             // Remove the editor fragment when rotating back to portrait
1178             mCurrentNote = null;
1179             if (mNoteListFragment != null) {
1180                 mNoteListFragment.setActivateOnItemClick(false);
1181                 mNoteListFragment.setDividerVisible(false);
1182                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1183                 mNoteListFragment.refreshList();
1184             }
1185             FragmentManager fm = getSupportFragmentManager();
1186             FragmentTransaction ft = fm.beginTransaction();
1187             ft.remove(mNoteEditorFragment);
1188             mNoteEditorFragment = null;
1189             ft.commitAllowingStateLoss();
1190             fm.executePendingTransactions();
1191             invalidateOptionsMenu();
1192         }
1193     }
1194 
1195     public void checkEmptyListText(boolean isSearch) {
1196         if (isSearch) {
<abbr title="1197             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1197             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1198             getNoteListFragment().setEmptyListViewClickable(false);
1199         } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1200             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1200             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1201             AnalyticsTracker.track(
1202                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1203                     AnalyticsTracker.CATEGORY_NOTE,
1204                     &quot;trash_filter_selected&quot;
1205             );
1206             getNoteListFragment().setEmptyListViewClickable(false);
1207         } else {
<abbr title="1208             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1208             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1209             getNoteListFragment().setEmptyListViewClickable(true);
1210         }
1211     }
1212 
1213     public void showDetailPlaceholder() {
1214         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1215             mCurrentNote = null;
1216             mNoteEditorFragment.setPlaceholderVisible(true);
1217             mNoteEditorFragment.clearMarkdown();
1218             mNoteEditorFragment.hideMarkdown();
1219             mIsShowingMarkdown = false;
1220         }
1221     }
1222 
1223     public void stopListeningToNotesBucket() {
1224         mNotesBucket.removeOnNetworkChangeListener(this);
1225         mNotesBucket.removeOnSaveObjectListener(this);
1226         mNotesBucket.removeOnDeleteObjectListener(this);
1227     }
1228 
1229     // Returns the appropriate view to show the undo bar within
1230     private View getUndoView() {
1231         View undoView = mFragmentsContainer;
1232         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1233                 getNoteListFragment() != null &amp;&amp;
1234                 getNoteListFragment().getRootView() != null) {
1235             undoView = getNoteListFragment().getRootView();
1236         }
1237 
1238         return undoView;
1239     }
1240 
1241     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1242         if (mUndoBarController != null) {
1243             mUndoBarController.setDeletedNoteIds(noteIds);
1244             mUndoBarController.showUndoBar(
1245                     getUndoView(),
<abbr title="1246                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1246                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1247             );
1248         }
1249     }
1250 
1251     /* Simperium Bucket Listeners */
1252     // received a change from the network, refresh the list
1253     @Override
1254     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1255         runOnUiThread(new Runnable() {
1256             @Override
1257             public void run() {
1258                 if (type == Bucket.ChangeType.INDEX) {
1259                     setToolbarProgressVisibility(false);
1260                 }
1261                 mNoteListFragment.refreshList();
1262             }
1263         });
1264     }
1265 
1266     @Override
1267     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1268         runOnUiThread(new Runnable() {
1269             @Override
1270             public void run() {
1271                 mNoteListFragment.refreshList();
1272             }
1273         });
1274     }
1275 
1276     @Override
1277     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1278         runOnUiThread(new Runnable() {
1279             @Override
1280             public void run() {
1281                 mNoteListFragment.refreshList();
1282             }
1283         });
1284     }
1285 
1286     @Override
1287     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1288         // noop, NoteEditorFragment will handle this
1289     }
1290 
1291     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1292         @Override
1293         protected Void doInBackground(Void... voids) {
1294             if (mNotesBucket == null) {
1295                 return null;
1296             }
1297             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1298             Bucket.ObjectCursor c = query.execute();
1299             while (c.moveToNext()) {
1300                 c.getObject().delete();
1301             }
1302             return null;
1303         }
1304 
1305         @Override
1306         protected void onPostExecute(Void nada) {
1307             showDetailPlaceholder();
1308         }
1309     }
1310 }
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.TextUtils;
  13  import android.view.Menu;
  14  import android.view.MenuInflater;
  15  import android.view.MenuItem;
  16  import android.view.View;
  17  import android.widget.ListView;
  18  import android.widget.ProgressBar;
  19  
  20  import androidx.annotation.NonNull;
  21  import androidx.appcompat.app.ActionBar;
  22  import androidx.appcompat.app.ActionBarDrawerToggle;
  23  import androidx.appcompat.app.AlertDialog;
  24  import androidx.appcompat.app.AppCompatActivity;
  25  import androidx.appcompat.view.ContextThemeWrapper;
  26  import androidx.appcompat.widget.SearchView;
  27  import androidx.appcompat.widget.Toolbar;
  28  import androidx.core.view.GravityCompat;
  29  import androidx.drawerlayout.widget.DrawerLayout;
  30  import androidx.fragment.app.FragmentManager;
  31  import androidx.fragment.app.FragmentTransaction;
  32  import androidx.preference.PreferenceManager;
  33  
  34  import com.automattic.simplenote.analytics.AnalyticsTracker;
  35  import com.automattic.simplenote.models.Note;
  36  import com.automattic.simplenote.models.Tag;
  37  import com.automattic.simplenote.utils.CrashUtils;
  38  import com.automattic.simplenote.utils.DisplayUtils;
  39  import com.automattic.simplenote.utils.DrawableUtils;
  40  import com.automattic.simplenote.utils.HtmlCompat;
  41  import com.automattic.simplenote.utils.PrefUtils;
  42  import com.automattic.simplenote.utils.StrUtils;
  43  import com.automattic.simplenote.utils.TagsAdapter;
  44  import com.automattic.simplenote.utils.ThemeUtils;
  45  import com.automattic.simplenote.utils.UndoBarController;
  46  import com.google.android.material.navigation.NavigationView;
  47  import com.simperium.Simperium;
  48  import com.simperium.client.Bucket;
  49  import com.simperium.client.BucketObjectMissingException;
  50  import com.simperium.client.BucketObjectNameInvalid;
  51  import com.simperium.client.Query;
  52  import com.simperium.client.User;
  53  
  54  import org.wordpress.passcodelock.AppLockManager;
  55  
  56  import java.util.ArrayList;
  57  import java.util.Calendar;
  58  import java.util.HashMap;
  59  import java.util.List;
  60  import java.util.Map;
  61  
  62  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  67  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  68  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  70  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  72  
  73  public class NotesActivity extends AppCompatActivity implements
<abbr title="  74          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  74          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  75          Bucket.Listener&lt;Note&gt; {
  76  
  77      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  78      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  79      protected Bucket&lt;Note&gt; mNotesBucket;
  80      protected Bucket&lt;Tag&gt; mTagsBucket;
  81      private boolean mIsShowingMarkdown;
  82      private boolean mShouldSelectNewNote;
  83      private boolean mIsSettingsClicked;
  84      private boolean mIsTabetFullscreen;
  85  
  86      private String mTabletSearchQuery;
  87      private UndoBarController mUndoBarController;
  88      private View mFragmentsContainer;
  89      private SearchView mSearchView;
  90      private MenuItem mSearchMenuItem;
  91      private NoteListFragment mNoteListFragment;
  92      private NoteEditorFragment mNoteEditorFragment;
  93      private Note mCurrentNote;
  94      private MenuItem mEmptyTrashMenuItem;
  95  
  96      // Menu drawer
  97      private static final int GROUP_PRIMARY = 100;
  98      private static final int GROUP_SECONDARY = 101;
  99      private static final int GROUP_TERTIARY = 102;
 100      private DrawerLayout mDrawerLayout;
 101      private Menu mNavigationMenu;
 102      private ActionBarDrawerToggle mDrawerToggle;
 103      private TagsAdapter mTagsAdapter;
 104      private TagsAdapter.TagMenuItem mSelectedTag;
 105      // Tags bucket listener
 106      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 107          void updateNavigationDrawer() {
 108              runOnUiThread(new Runnable() {
 109                  public void run() {
 110                      updateNavigationDrawerItems();
 111                  }
 112              });
 113          }
 114  
 115          @Override
 116          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 117              updateNavigationDrawer();
 118          }
 119  
 120          @Override
 121          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 122              updateNavigationDrawer();
 123          }
 124  
 125          @Override
 126          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 127              updateNavigationDrawer();
 128          }
 129  
 130          @Override
 131          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 132              // noop
 133          }
 134      };
 135  
 136      @Override
 137      protected void onCreate(Bundle savedInstanceState) {
 138          ThemeUtils.setTheme(this);
 139          super.onCreate(savedInstanceState);
 140  
 141          setContentView(R.layout.activity_notes);
 142  
 143          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 144  
 145          Simplenote currentApp = (Simplenote) getApplication();
 146          if (mNotesBucket == null) {
 147              mNotesBucket = currentApp.getNotesBucket();
 148          }
 149  
 150          if (mTagsBucket == null) {
 151              mTagsBucket = currentApp.getTagsBucket();
 152          }
 153  
 154          Toolbar toolbar = findViewById(R.id.toolbar);
 155          setSupportActionBar(toolbar);
 156          configureNavigationDrawer(toolbar);
 157  
 158          if (savedInstanceState == null) {
 159              mNoteListFragment = new NoteListFragment();
 160              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 161              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 162              fragmentTransaction.commit();
 163          } else {
 164              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 165          }
 166          mIsTabetFullscreen = mNoteListFragment.isHidden();
 167  
 168          if (DisplayUtils.isLargeScreen(this)) {
 169              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 170                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 170                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 171              } else if (DisplayUtils.isLandscape(this)) {
 172                  addEditorFragment();
 173              }
 174          }
 175  
 176          // enable ActionBar app icon to behave as action to toggle nav drawer
 177          ActionBar actionBar = getSupportActionBar();
 178          if (actionBar != null) {
 179              actionBar.setDisplayHomeAsUpEnabled(true);
 180              actionBar.setHomeButtonEnabled(true);
 181  
 182              // Add loading indicator to show when indexing
<abbr title=" 183              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 183              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 184              actionBar.setDisplayShowCustomEnabled(true);
 185              actionBar.setCustomView(progressBar);
 186              setToolbarProgressVisibility(false);
 187          }
 188  
 189          mUndoBarController = new UndoBarController(this);
 190  
 191          // Creates &#x27;Welcome&#x27; note
 192          checkForFirstLaunch();
 193  
 194          checkForSharedContent();
 195  
 196          currentApp.getSimperium().setOnUserCreatedListener(this);
 197          currentApp.getSimperium().setUserStatusChangeListener(this);
 198      }
 199  
 200      @Override
 201      protected void onResume() {
 202          super.onResume();
 203  
 204          // Ensure user has valid authorization
 205          if (userAuthenticationIsInvalid()) {
 206              startLoginActivity(true);
 207              Intent intent = getIntent();
 208  
 209              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 210                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 211                  AnalyticsTracker.track(
 212                          NOTE_WIDGET_SIGN_IN_TAPPED,
 213                          CATEGORY_WIDGET,
 214                          &quot;note_widget_sign_in_tapped&quot;
 215                  );
 216              }
 217          }
 218  
 219          disableScreenshotsIfLocked(this);
 220  
 221          mNotesBucket.start();
 222          mTagsBucket.start();
 223  
 224          mNotesBucket.addOnNetworkChangeListener(this);
 225          mNotesBucket.addOnSaveObjectListener(this);
 226          mNotesBucket.addOnDeleteObjectListener(this);
 227          mTagsBucket.addListener(mTagsMenuUpdater);
 228  
 229          updateNavigationDrawerItems();
 230  
 231          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 232          if (userIsUnauthorized()) {
 233              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 234                  mSelectedTag = null;
 235                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 236              }
 237          }
 238  
 239          filterListBySelectedTag();
 240  
 241          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 242              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 242              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 243              mShouldSelectNewNote = false;
 244          }
 245  
 246          if (mIsShowingMarkdown) {
 247              setMarkdownShowing(false);
 248          }
 249  
 250          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 251          if(DisplayUtils.isLargeScreenLandscape(this)) {
 252              if (mIsTabetFullscreen) {
 253                  ft.hide(mNoteListFragment);
 254              } else {
 255                  ft.show(mNoteListFragment);
 256              }
 257          } else {
 258              ft.show(mNoteListFragment);
 259          }
 260          ft.commitNow();
 261      }
 262  
 263      @Override
 264      protected void onPause() {
 265          super.onPause();  // Always call the superclass method first
 266          mTagsBucket.removeListener(mTagsMenuUpdater);
 267          mTagsBucket.stop();
 268  
 269          mNotesBucket.removeOnNetworkChangeListener(this);
 270          mNotesBucket.removeOnSaveObjectListener(this);
 271          mNotesBucket.removeOnDeleteObjectListener(this);
 272          mNotesBucket.stop();
 273      }
 274  
 275      @Override
 276      public void setTitle(CharSequence title) {
 277          if (getSupportActionBar() != null) {
 278              getSupportActionBar().setTitle(title);
 279          }
 280      }
 281  
 282      @Override
 283      public void onBackPressed() {
 284          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 285              mDrawerLayout.closeDrawer(GravityCompat.START);
 286          } else {
 287              super.onBackPressed();
 288          }
 289      }
 290  
 291      @Override
 292      public void onActionModeCreated() {
 293          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 294      }
 295  
 296      @Override
 297      public void onActionModeDestroyed() {
 298          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);



 299      }
 300  
 301      private ColorStateList getIconSelector() {
 302          int[][] states = new int[][] {
 303                  new int[] { android.R.attr.state_checked}, // checked
 304                  new int[] {-android.R.attr.state_checked}  // unchecked
 305          };
 306  
 307          int[] colors = new int[] {
 308                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 309                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 310          };
 311  
 312          return new ColorStateList(states, colors);
 313      }
 314  
 315      private ColorStateList getTextSelector() {
 316          int[][] states = new int[][] {
 317              new int[] {-android.R.attr.state_enabled}, // disabled
 318              new int[] { android.R.attr.state_checked}, // checked
 319              new int[] {-android.R.attr.state_checked}  // unchecked
 320          };
 321  
 322          int[] colors = new int[] {
 323              getResources().getColor(R.color.text_title_disabled, getTheme()),
 324              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 325              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 326          };
 327  
 328          return new ColorStateList(states, colors);
 329      }
 330  
 331      private void configureNavigationDrawer(Toolbar toolbar) {
 332          ColorStateList iconSelector = getIconSelector();
 333          ColorStateList textSelector = getTextSelector();
 334          mDrawerLayout = findViewById(R.id.drawer_layout);
 335          NavigationView navigationView = findViewById(R.id.navigation_view);
 336          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 337          navigationView.setItemIconTintList(iconSelector);
 338          navigationView.setItemTextColor(textSelector);
 339          navigationView.setNavigationItemSelectedListener(
 340              new NavigationView.OnNavigationItemSelectedListener() {
 341                  @Override
 342                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 343                      mDrawerLayout.closeDrawer(GravityCompat.START);
 344  
 345                      if (item.getItemId() == SETTINGS_ID) {
 346                          AnalyticsTracker.track(
 347                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 348                                  AnalyticsTracker.CATEGORY_TAG,
 349                                  &quot;selected_tag_in_navigation_drawer&quot;,
 350                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 351                          );
 352                          mIsSettingsClicked = true;
 353                          return false;
 354                      } else {
 355                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 356                          filterListBySelectedTag();
 357                          return true;
 358                      }
 359                  }
 360              }
 361          );
 362  
 363          mNavigationMenu = navigationView.getMenu();
<abbr title=" 364          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 364          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 365          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 365          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 366          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 366          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 367          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 368  
 369          if (mSelectedTag == null)
 370              mSelectedTag = mTagsAdapter.getDefaultItem();
 371  
 372          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 373                  R.string.close_drawer) {
 374              public void onDrawerClosed(View view) {
 375                  supportInvalidateOptionsMenu();
 376  
 377                  if (mIsSettingsClicked) {
 378                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 379                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 380                      mIsSettingsClicked = false;
 381                  }
 382              }
 383  
 384              public void onDrawerOpened(View drawerView) {
 385                  // noop
 386              }
 387  
 388              @Override
 389              public void onDrawerSlide(View drawerView, float slideOffset) {
 390                  super.onDrawerSlide(drawerView, 0f);
 391              }
 392          };
 393  
 394          mDrawerLayout.addDrawerListener(mDrawerToggle);
 395      }
 396  
 397      private void filterListBySelectedTag() {
 398          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 399  
 400          if (selectedMenuItem != null) {
 401              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 402          } else {
 403              mSelectedTag = mTagsAdapter.getDefaultItem();
 404          }
 405  
 406          checkEmptyListText(false);
 407  
 408          if (mNoteListFragment.isHidden()) {
 409              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 410              fragmentTransaction.show(mNoteListFragment);
 411              fragmentTransaction.commitNowAllowingStateLoss();
 412          }
 413  
 414          // Disable long press on notes when viewing Trash.
 415          if (mSelectedTag.id == TRASH_ID) {
 416              getNoteListFragment().getListView().setLongClickable(false);
 417          } else {
 418              getNoteListFragment().getListView().setLongClickable(true);
 419          }
 420  
 421          getNoteListFragment().refreshListFromNavSelect();
 422  
 423          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 424  
 425          switch ((int) mSelectedTag.id) {
 426              case ALL_NOTES_ID:
 427                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 428                  break;
 429              case TRASH_ID:
 430                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 431                  break;
 432              case UNTAGGED_NOTES_ID:
 433                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 434                  break;
 435              default:
 436                  properties = null;
 437                  break;
 438          }
 439  
 440          AnalyticsTracker.track(
 441                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 442                  AnalyticsTracker.CATEGORY_TAG,
 443                  &quot;selected_tag_in_navigation_drawer&quot;,
 444                  properties
 445          );
 446  
 447          setSelectedTagActive();
 448      }
 449  
 450      private void checkForFirstLaunch() {
 451          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 452              // Create the welcome note
 453              try {
 454                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 455                  welcomeNote.setCreationDate(Calendar.getInstance());
 456                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 457                  welcomeNote.setContent(getString(R.string.welcome_note));
 458                  welcomeNote.getTitle();
 459                  welcomeNote.save();
 460              } catch (BucketObjectNameInvalid e) {
 461                  // this won&#x27;t happen because welcome-android is a valid name
 462              }
 463  
 464              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 465              SharedPreferences.Editor editor = preferences.edit();
 466              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 467              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 468              editor.apply();
 469          }
 470      }
 471  
 472      private void checkForSharedContent() {
 473          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 474              // Check share action
 475              Intent intent = getIntent();
 476              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 477              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 478  
 479              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 480              String intentAction = StrUtils.notNullStr(intent.getAction());
 481              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 482              if (!TextUtils.isEmpty(text)) {
 483                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 484                      text = subject + &quot;\n\n&quot; + text;
 485                  }
 486                  Note note = mNotesBucket.newObject();
 487                  note.setCreationDate(Calendar.getInstance());
 488                  note.setModificationDate(note.getCreationDate());
 489                  note.setContent(text);
 490                  note.save();
 491                  setCurrentNote(note);
 492                  mShouldSelectNewNote = true;
 493  
 494                  AnalyticsTracker.track(
 495                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 496                          AnalyticsTracker.CATEGORY_NOTE,
 497                          &quot;external_share&quot;
 498                  );
 499  
 500                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 501                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 502                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 503                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 504                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 505                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 506                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 507                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 508                      }
 509                  }
 510              }
 511          }
 512      }
 513  
 514      private void updateNavigationDrawerItems() {
 515          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 516          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 517          if (isAlphaSort) {
 518              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 519          } else {
 520              tagCursor = Tag.allWithName(mTagsBucket).execute();
 521          }
 522  
 523          mTagsAdapter.changeCursor(tagCursor);
 524          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 525          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 526  
 527          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 528              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 528              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 529  
 530              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 531                  String name = mTagsAdapter.getItem(i).name;
 532                  int id = (int) mTagsAdapter.getItem(i).id;
 533  
 534                  if (id &gt;= 0) { // Custom tags have a positive ID.
 535                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 536                  }
 537              }
 538  
<abbr title=" 539              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 539              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr>
 540              setSelectedTagActive();
 541          }
 542      }
 543  
 544      public void launchEditTags(View view) {
 545          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 546      }
 547  
 548      private void setSelectedTagActive() {
 549          if (mSelectedTag == null) {
 550              mSelectedTag = mTagsAdapter.getDefaultItem();
 551          }
 552  
 553          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 554  
 555          if (selectedMenuItem != null) {
 556              selectedMenuItem.setChecked(true);
 557          } else {
 558              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 559          }
 560  
 561          setTitle(mSelectedTag.name);
 562      }
 563  
 564      public TagsAdapter.TagMenuItem getSelectedTag() {
 565          if (mSelectedTag == null) {
 566              mSelectedTag = mTagsAdapter.getDefaultItem();
 567          }
 568  
 569          return mSelectedTag;
 570      }
 571  
 572      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 573      public void updateTrashMenuItem() {
 574          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 575              return;
 576  
 577          // Disable the trash icon if there are no notes trashed.
 578          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 579          if (query.count() == 0) {
 580              mEmptyTrashMenuItem.setEnabled(false);
 581          } else {
 582              mEmptyTrashMenuItem.setEnabled(true);
 583          }
 584      }
 585  
 586      private void addEditorFragment() {
 587          FragmentManager fm = getSupportFragmentManager();
 588          FragmentTransaction ft = fm.beginTransaction();
 589          mNoteEditorFragment = new NoteEditorFragment();
 590          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 591          ft.commitAllowingStateLoss();
 592          fm.executePendingTransactions();
 593      }
 594  
 595      private boolean userAccountRequired() {
 596          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 597      }
 598  
 599      /**
 600       * Checks for a previously valid user that is now not authenticated
 601       * Also checks if user account is required (added in version 1.5.6)
 602       *
 603       * @return true if user has invalid authorization
 604       */
 605      private boolean userAuthenticationIsInvalid() {
 606          Simplenote currentApp = (Simplenote) getApplication();
 607          Simperium simperium = currentApp.getSimperium();
 608          User user = simperium.getUser();
 609          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 610          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 611                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 612      }
 613  
 614      public boolean userIsUnauthorized() {
 615          Simplenote currentApp = (Simplenote) getApplication();
 616          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 617      }
 618  
 619      public void setCurrentNote(Note note) {
 620          mCurrentNote = note;
 621      }
 622  
 623      public NoteListFragment getNoteListFragment() {
 624          return mNoteListFragment;
 625      }
 626  
 627      @Override
 628      public boolean onCreateOptionsMenu(final Menu menu) {
 629          super.onCreateOptionsMenu(menu);
 630          MenuInflater inflater = getMenuInflater();
 631          inflater.inflate(R.menu.notes_list, menu);
 632  
 633          // restore the search query if on a landscape tablet
 634          String searchQuery = null;
 635          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 636              searchQuery = mSearchView.getQuery().toString();
 637  
 638          mSearchMenuItem = menu.findItem(R.id.menu_search);
 639          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 640  
 641          if (!TextUtils.isEmpty(searchQuery)) {
 642              mSearchView.setQuery(searchQuery, false);
 643              mSearchMenuItem.expandActionView();
 644          } else {
 645              // Workaround for setting the search placeholder text color
 646              @SuppressWarnings(&quot;ResourceType&quot;)
 647              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 648              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 649                      hintHexColor,
 650                      getString(R.string.search))));
 651          }
 652  
 653          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 654              @Override
 655              public boolean onQueryTextChange(String newText) {
 656                  if (mSearchMenuItem.isActionViewExpanded()) {
 657                      getNoteListFragment().searchNotes(newText);
 658                  }
 659                  return true;
 660              }
 661  
 662              @Override
 663              public boolean onQueryTextSubmit(String queryText) {
 664                  getNoteListFragment().searchNotes(queryText);
 665                  return true;
 666              }
 667  
 668          });
 669  
 670          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 671              @Override
 672              public boolean onMenuItemActionExpand(MenuItem menuItem) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +                getNoteListFragment().searchNotes(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 674 +</span>
 675                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 676                      updateActionsForLargeLandscape(menu);
 677                  }
 678  
 679                  checkEmptyListText(true);
 680  
 681                  if (mNoteListFragment != null) {
 682                      mNoteListFragment.setFloatingActionButtonVisible(false);
 683                  }
 684  
 685                  AnalyticsTracker.track(
 686                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 687                          AnalyticsTracker.CATEGORY_NOTE,
 688                          &quot;action_bar_search_tap&quot;
 689                  );
 690                  return true;
 691              }
 692  
 693              @Override
 694              public boolean onMenuItemActionCollapse(MenuItem menuItem) {


 695                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 696                      updateActionsForLargeLandscape(menu);
 697                  }
 698  
 699                  // Show all notes again
 700                  if (mNoteListFragment != null) {
 701                      mNoteListFragment.setFloatingActionButtonVisible(true);
 702                  }
 703  
 704                  mTabletSearchQuery = &quot;&quot;;
 705                  mSearchView.setQuery(&quot;&quot;, false);
 706                  checkEmptyListText(false);
 707                  getNoteListFragment().clearSearch();
 708                  return true;
 709              }
 710          });
 711  
 712          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 713              @Override
 714              public boolean onMenuItemClick(MenuItem item) {
 715                  if (!mSearchMenuItem.isActionViewExpanded())
 716                      showDetailPlaceholder();
 717                  return false;
 718              }
 719          });
 720  
 721          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 722          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 723              trashItem.setTitle(R.string.undelete);
 724              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 725          } else {
 726              trashItem.setTitle(R.string.delete);
 727              trashItem.setIcon(R.drawable.ic_trash_24dp);
 728          }
 729  
 730          if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 731              // Restore the search query on landscape tablets
 732              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 733                  mSearchMenuItem.expandActionView();
 734                  mSearchView.setQuery(mTabletSearchQuery, false);
 735                  mSearchView.clearFocus();
 736              }
 737  
 738              updateActionsForLargeLandscape(menu);
 739          } else {
 740              menu.findItem(R.id.menu_search).setVisible(true);
 741              menu.findItem(R.id.menu_share).setVisible(false);
 742              menu.findItem(R.id.menu_view_info).setVisible(false);
 743              menu.findItem(R.id.menu_checklist).setVisible(false);
 744              menu.findItem(R.id.menu_history).setVisible(false);
 745              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 746              menu.findItem(R.id.menu_sidebar).setVisible(false);
 747              trashItem.setVisible(false);
 748              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 749          }
 750  
 751          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 752              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 753              mEmptyTrashMenuItem.setVisible(true);
 754  
 755              updateTrashMenuItem();
 756  
 757              menu.findItem(R.id.menu_search).setVisible(false);
 758              menu.findItem(R.id.menu_share).setVisible(false);
 759              menu.findItem(R.id.menu_history).setVisible(false);
 760              menu.findItem(R.id.menu_checklist).setVisible(false);
 761          }
 762  
 763          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 764  
 765          return true;
 766      }
 767  
 768      @Override
 769      public boolean onOptionsItemSelected(MenuItem item) {
 770          if (mDrawerToggle.onOptionsItemSelected(item)) {
 771              return true;
 772          }
 773          switch (item.getItemId()) {
 774              case R.id.menu_sidebar:
 775                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 776                  if (mNoteListFragment.isHidden()) {
 777                      ft.show(mNoteListFragment);
 778                  } else {
 779                      ft.hide(mNoteListFragment);
 780                  }
 781                  ft.commitNowAllowingStateLoss();
 782                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 783                  return true;
 784              case R.id.menu_markdown_preview:
 785                  if (mIsShowingMarkdown) {
 786                      item.setIcon(R.drawable.ic_visibility_on_24dp);
 787                      item.setTitle(getString(R.string.markdown_show));
 788                      setMarkdownShowing(false);
 789                      mCurrentNote.setPreviewEnabled(false);
 790                  } else {
 791                      item.setIcon(R.drawable.ic_visibility_off_24dp);
 792                      item.setTitle(getString(R.string.markdown_hide));
 793                      setMarkdownShowing(true);
 794                      mCurrentNote.setPreviewEnabled(true);
 795                  }
 796  
 797                  mCurrentNote.save();
 798                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 799  
 800                  return true;
 801              case R.id.menu_delete:
 802                  if (mNoteEditorFragment != null) {
 803                      if (mCurrentNote != null) {
 804                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 805                          mCurrentNote.setModificationDate(Calendar.getInstance());
 806                          mCurrentNote.save();
 807  
 808                          updateViewsAfterTrashAction(mCurrentNote);
 809                      }
 810                  }
 811                  return true;
 812              case R.id.menu_empty_trash:
<abbr title=" 813                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 813                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog))ðŸ”µ</abbr>
 814  
 815                  alert.setTitle(R.string.empty_trash);
 816                  alert.setMessage(R.string.confirm_empty_trash);
 817                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 818                      public void onClick(DialogInterface dialog, int whichButton) {
 819                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 820                          AnalyticsTracker.track(
 821                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 822                                  AnalyticsTracker.CATEGORY_NOTE,
 823                                  &quot;overflow_menu&quot;
 824                          );
 825                      }
 826                  });
 827                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 828                      public void onClick(DialogInterface dialog, int whichButton) {
 829                          // Do nothing, just closing the dialog
 830                      }
 831                  });
 832                  alert.show();
 833                  return true;
 834              case android.R.id.home:
 835                  invalidateOptionsMenu();
 836                  return true;
 837              default:
 838                  return super.onOptionsItemSelected(item);
 839          }
 840      }
 841  
 842      @Override
 843      public boolean onPrepareOptionsMenu(Menu menu) {
 844          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 845  
 846          if (mIsShowingMarkdown) {
 847              markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 848              markdownItem.setTitle(getString(R.string.markdown_hide));
 849          } else {
 850              markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 851              markdownItem.setTitle(getString(R.string.markdown_show));
 852          }
 853  
 854          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 855  
 856          return super.onPrepareOptionsMenu(menu);
 857      }
 858  
 859      private void updateActionsForLargeLandscape(Menu menu) {
 860          if (mCurrentNote != null) {
 861              menu.findItem(R.id.menu_checklist).setVisible(true);
 862              menu.findItem(R.id.menu_delete).setVisible(true);
 863              menu.findItem(R.id.menu_history).setVisible(true);
 864              menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 865              menu.findItem(R.id.menu_share).setVisible(true);
 866              menu.findItem(R.id.menu_sidebar).setVisible(true);
 867              menu.findItem(R.id.menu_view_info).setVisible(true);
 868          } else {
 869              menu.findItem(R.id.menu_checklist).setVisible(false);
 870              menu.findItem(R.id.menu_delete).setVisible(false);
 871              menu.findItem(R.id.menu_history).setVisible(false);
 872              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 873              menu.findItem(R.id.menu_share).setVisible(false);
 874              menu.findItem(R.id.menu_sidebar).setVisible(false);
 875              menu.findItem(R.id.menu_view_info).setVisible(false);
 876          }
 877  
 878          menu.findItem(R.id.menu_empty_trash).setVisible(false);
 879      }
 880  
 881      public void updateViewsAfterTrashAction(Note note) {
 882          if (note == null || isFinishing()) {
 883              return;
 884          }
 885  
 886          if (note.isDeleted()) {
 887              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 888              deletedNoteIds.add(note.getSimperiumKey());
 889              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 890              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 891              AnalyticsTracker.track(
 892                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 893                      AnalyticsTracker.CATEGORY_NOTE,
 894                      &quot;overflow_menu&quot;
 895              );
 896          } else {
 897              AnalyticsTracker.track(
 898                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 899                      AnalyticsTracker.CATEGORY_NOTE,
 900                      &quot;overflow_menu&quot;
 901              );
 902          }
 903  
 904          // If we just deleted/restored the active note, show the placeholder
 905          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 906              showDetailPlaceholder();
 907          }
 908  
 909          NoteListFragment fragment = getNoteListFragment();
 910          if (fragment != null) {
 911              fragment.getPrefs();
 912              fragment.refreshList();
 913          }
 914  
 915          invalidateOptionsMenu();
 916      }
 917  
 918      public void setMarkdownShowing(boolean isMarkdownShowing) {
 919          mIsShowingMarkdown = isMarkdownShowing;
 920          if (mNoteEditorFragment != null) {
 921              if (isMarkdownShowing) {
 922                  mNoteEditorFragment.showMarkdown();
 923              } else {
 924                  mNoteEditorFragment.hideMarkdown();
 925              }
 926          }
 927          invalidateOptionsMenu();
 928      }
 929  
 930      /**
 931       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 932       * the item with the given ID was selected. Used for tablets only.
 933       */
 934      @Override
<abbr title=" 935      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 935      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 936          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 937              // Launch the editor activity
 938              Bundle arguments = new Bundle();
 939              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 940              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 941              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 942  
 943              if (matchOffsets != null) {
 944                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 945              }
 946  
 947              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 948              editNoteIntent.putExtras(arguments);
 949              if (mNoteListFragment.isHidden()) {
 950                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 951              }
 952              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 953          } else {
 954              mNoteEditorFragment.setNote(noteID, matchOffsets);
 955              getNoteListFragment().setNoteSelected(noteID);
 956              setMarkdownShowing(isPreviewEnabled);
 957  
 958              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 959                  mTabletSearchQuery = mSearchView.getQuery().toString();
 960              }
 961  
 962              mNoteEditorFragment.clearMarkdown();
 963  
 964              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 965                  setMarkdownShowing(false);
 966              }
 967  
 968              invalidateOptionsMenu();
 969          }
 970  
 971          AnalyticsTracker.track(
 972                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 973                  AnalyticsTracker.CATEGORY_NOTE,
 974                  &quot;note_list_row_tap&quot;
 975          );
 976      }
 977  
 978      @Override
 979      public void onUserCreated(User user) {
 980          // New account created
 981          AnalyticsTracker.track(
 982                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 983                  AnalyticsTracker.CATEGORY_USER,
 984                  &quot;account_created_from_login_activity&quot;
 985          );
 986      }
 987  
 988      public void onUserStatusChange(User.Status status) {
 989          switch (status) {
 990              // successfully used access token to connect to simperium bucket
 991              case AUTHORIZED:
 992                  runOnUiThread(new Runnable() {
 993                      @Override
 994                      public void run() {
 995                          if (!mNotesBucket.hasChangeVersion()) {
 996                              setToolbarProgressVisibility(true);
 997                          }
 998                      }
 999                  });
1000                  break;
1001  
1002              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1003              case NOT_AUTHORIZED:
1004                  runOnUiThread(new Runnable() {
1005                      @Override
1006                      public void run() {
1007                          startLoginActivity(true);
1008                      }
1009                  });
1010                  break;
1011  
<abbr title="1012              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1012              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
1013              case UNKNOWN:
1014                  break;
1015          }
1016      }
1017  
1018      private void setToolbarProgressVisibility(boolean isVisible) {
1019          if (getSupportActionBar() != null) {
1020              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1021          }
1022      }
1023  
1024      public void startLoginActivity(boolean signInFirst) {
1025          // Clear some account-specific prefs
1026          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1027          editor.remove(PrefUtils.PREF_WP_TOKEN);
1028          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1029          editor.apply();
1030  
1031          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1032          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1033      }
1034  
1035      @Override
1036      public void recreate() {
1037          Handler handler = new Handler();
1038          handler.post(new Runnable() {
1039              @Override
1040              public void run() {
1041                  NotesActivity.super.recreate();
1042              }
1043          });
1044      }
1045  
1046      @Override
1047      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1048          super.onActivityResult(requestCode, resultCode, data);
1049          switch (requestCode) {
1050              case Simplenote.INTENT_PREFERENCES:
<abbr title="1051                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1051                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1052                  invalidateOptionsMenu();
1053                  NoteListFragment fragment = getNoteListFragment();
1054                  if (fragment != null) {
1055                      fragment.getPrefs();
1056                      fragment.refreshList();
1057                  }
1058  
1059                  break;
1060              case Simplenote.INTENT_EDIT_NOTE:
1061                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1062                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1063                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1064                          if (noteId != null) {
1065                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1066                              deletedNoteIds.add(noteId);
1067                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1068                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1069                          }
<abbr title="1070                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1070                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1071                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1072                          mNoteListFragment.setNoteSelected(selectedNoteId);
1073                          if (mNoteEditorFragment != null) {
1074                              mNoteEditorFragment.setNote(selectedNoteId);
1075                          }
1076                      }
1077                  }
1078                  break;
1079              case Simperium.SIGNUP_SIGNIN_REQUEST:
1080                  invalidateOptionsMenu();
1081  
1082                  Simplenote app = (Simplenote) getApplication();
1083                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1084                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1085  
1086                  AnalyticsTracker.track(
1087                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1088                          AnalyticsTracker.CATEGORY_USER,
1089                          &quot;signed_in_from_login_activity&quot;
1090                  );
1091  
1092                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1093                      finish();
1094                  }
1095  
1096                  break;
1097          }
1098      }
1099  
1100      @Override
1101      public void onUndo() {
1102          if (mUndoBarController == null) return;
1103  
1104          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1105          if (deletedNoteIds != null) {
1106              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1107                  Note deletedNote;
1108                  try {
1109                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1110                  } catch (BucketObjectMissingException e) {
1111                      return;
1112                  }
1113                  if (deletedNote != null) {
1114                      deletedNote.setDeleted(false);
1115                      deletedNote.setModificationDate(Calendar.getInstance());
1116                      deletedNote.save();
1117                      NoteListFragment fragment = getNoteListFragment();
1118                      if (fragment != null) {
1119                          fragment.getPrefs();
1120                          fragment.refreshList();
1121                      }
1122                  }
1123              }
1124          }
1125      }
1126  
1127      @Override
1128      protected void onPostCreate(Bundle savedInstanceState) {
1129          super.onPostCreate(savedInstanceState);
1130          // Sync the toggle state after onRestoreInstanceState has occurred.
1131          mDrawerToggle.syncState();
1132      }
1133  
1134      @Override
1135      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1136          super.onConfigurationChanged(newConfig);
1137  
1138          mDrawerToggle.onConfigurationChanged(newConfig);
1139  
1140          if (DisplayUtils.isLargeScreen(this)) {
1141              mIsShowingMarkdown = false;
1142  
1143              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1144                  // Add the editor fragment
1145                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1146                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1146                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1147                  } else if (DisplayUtils.isLandscape(this)) {
1148                      addEditorFragment();
1149                  }
1150  
1151                  if (mNoteListFragment != null) {
1152                      mNoteListFragment.setActivateOnItemClick(true);
1153                      mNoteListFragment.setDividerVisible(true);
1154                  }
1155  
1156                  // Select the current note on a tablet
1157                  if (mCurrentNote != null) {
<abbr title="1158                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1158                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1159                  } else {
1160                      mNoteEditorFragment.setPlaceholderVisible(true);
1161                      mNoteListFragment.getListView().clearChoices();
1162                  }
1163  
1164                  invalidateOptionsMenu();
1165              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1166              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1167                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1167                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1168              }
1169          }
1170  
1171          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1172              // Remove the editor fragment when rotating back to portrait
1173              mCurrentNote = null;
1174              if (mNoteListFragment != null) {
1175                  mNoteListFragment.setActivateOnItemClick(false);
1176                  mNoteListFragment.setDividerVisible(false);
1177                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1178                  mNoteListFragment.refreshList();
1179              }
1180              FragmentManager fm = getSupportFragmentManager();
1181              FragmentTransaction ft = fm.beginTransaction();
1182              ft.remove(mNoteEditorFragment);
1183              mNoteEditorFragment = null;
1184              ft.commitAllowingStateLoss();
1185              fm.executePendingTransactions();
1186              invalidateOptionsMenu();
1187          }
1188      }
1189  
1190      public void checkEmptyListText(boolean isSearch) {
1191          if (isSearch) {
<abbr title="1192              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1192              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1193              getNoteListFragment().setEmptyListViewClickable(false);
1194          } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1195              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1195              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1196              AnalyticsTracker.track(
1197                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1198                      AnalyticsTracker.CATEGORY_NOTE,
1199                      &quot;trash_filter_selected&quot;
1200              );
1201              getNoteListFragment().setEmptyListViewClickable(false);
1202          } else {
<abbr title="1203              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1203              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1204              getNoteListFragment().setEmptyListViewClickable(true);
1205          }
1206      }
1207  
1208      public void showDetailPlaceholder() {
1209          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1210              mCurrentNote = null;
1211              mNoteEditorFragment.setPlaceholderVisible(true);
1212              mNoteEditorFragment.clearMarkdown();
1213              mNoteEditorFragment.hideMarkdown();
1214              mIsShowingMarkdown = false;
1215          }
1216      }
1217  
1218      public void stopListeningToNotesBucket() {
1219          mNotesBucket.removeOnNetworkChangeListener(this);
1220          mNotesBucket.removeOnSaveObjectListener(this);
1221          mNotesBucket.removeOnDeleteObjectListener(this);
1222      }
1223  
1224      // Returns the appropriate view to show the undo bar within
1225      private View getUndoView() {
1226          View undoView = mFragmentsContainer;
1227          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1228                  getNoteListFragment() != null &amp;&amp;
1229                  getNoteListFragment().getRootView() != null) {
1230              undoView = getNoteListFragment().getRootView();
1231          }
1232  
1233          return undoView;
1234      }
1235  
1236      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1237          if (mUndoBarController != null) {
1238              mUndoBarController.setDeletedNoteIds(noteIds);
1239              mUndoBarController.showUndoBar(
1240                      getUndoView(),
1241                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1242              );
1243          }
1244      }
1245  
1246      /* Simperium Bucket Listeners */
1247      // received a change from the network, refresh the list
1248      @Override
1249      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1250          runOnUiThread(new Runnable() {
1251              @Override
1252              public void run() {
1253                  if (type == Bucket.ChangeType.INDEX) {
1254                      setToolbarProgressVisibility(false);
1255                  }
1256                  mNoteListFragment.refreshList();
1257              }
1258          });
1259      }
1260  
1261      @Override
1262      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1263          runOnUiThread(new Runnable() {
1264              @Override
1265              public void run() {
1266                  mNoteListFragment.refreshList();
1267              }
1268          });
1269      }
1270  
1271      @Override
1272      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1273          runOnUiThread(new Runnable() {
1274              @Override
1275              public void run() {
1276                  mNoteListFragment.refreshList();
1277              }
1278          });
1279      }
1280  
1281      @Override
1282      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1283          // noop, NoteEditorFragment will handle this
1284      }
1285  
1286      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1287  
1288          @Override
1289          protected Void doInBackground(Void... voids) {
1290              if (mNotesBucket == null) return null;
1291  
1292              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1293              Bucket.ObjectCursor c = query.execute();
1294              while (c.moveToNext()) {
1295                  c.getObject().delete();
1296              }
1297  
1298              return null;
1299          }
1300  
1301          @Override
1302          protected void onPostExecute(Void nada) {
1303              showDetailPlaceholder();
1304          }
1305      }
1306  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.content.DialogInterface;
   5  import android.content.Intent;
   6  import android.content.SharedPreferences;
   7  import android.content.res.ColorStateList;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.TextUtils;
  13  import android.view.Menu;
  14  import android.view.MenuInflater;
  15  import android.view.MenuItem;
  16  import android.view.View;
  17  import android.widget.ListView;
  18  import android.widget.ProgressBar;
  19  
  20  import androidx.annotation.NonNull;
  21  import androidx.appcompat.app.ActionBar;
  22  import androidx.appcompat.app.ActionBarDrawerToggle;
  23  import androidx.appcompat.app.AlertDialog;
  24  import androidx.appcompat.app.AppCompatActivity;
  25  import androidx.appcompat.view.ContextThemeWrapper;
  26  import androidx.appcompat.widget.SearchView;
  27  import androidx.appcompat.widget.Toolbar;
  28  import androidx.core.view.GravityCompat;
  29  import androidx.drawerlayout.widget.DrawerLayout;
  30  import androidx.fragment.app.FragmentManager;
  31  import androidx.fragment.app.FragmentTransaction;
  32  import androidx.preference.PreferenceManager;
  33  
  34  import com.automattic.simplenote.analytics.AnalyticsTracker;
  35  import com.automattic.simplenote.models.Note;
  36  import com.automattic.simplenote.models.Tag;
  37  import com.automattic.simplenote.utils.CrashUtils;
  38  import com.automattic.simplenote.utils.DisplayUtils;
  39  import com.automattic.simplenote.utils.DrawableUtils;
  40  import com.automattic.simplenote.utils.HtmlCompat;
  41  import com.automattic.simplenote.utils.PrefUtils;
  42  import com.automattic.simplenote.utils.StrUtils;
  43  import com.automattic.simplenote.utils.TagsAdapter;
  44  import com.automattic.simplenote.utils.ThemeUtils;
  45  import com.automattic.simplenote.utils.UndoBarController;
  46  import com.google.android.material.navigation.NavigationView;
  47  import com.simperium.Simperium;
  48  import com.simperium.client.Bucket;
  49  import com.simperium.client.BucketObjectMissingException;
  50  import com.simperium.client.BucketObjectNameInvalid;
  51  import com.simperium.client.Query;
  52  import com.simperium.client.User;
  53  
  54  import org.wordpress.passcodelock.AppLockManager;
  55  
  56  import java.util.ArrayList;
  57  import java.util.Calendar;
  58  import java.util.HashMap;
  59  import java.util.List;
  60  import java.util.Map;
  61  
  62  import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63  import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64  import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66  import static com.automattic.simplenote.utils.TagsAdapter.ALL_NOTES_ID;
  67  import static com.automattic.simplenote.utils.TagsAdapter.DEFAULT_ITEM_POSITION;
  68  import static com.automattic.simplenote.utils.TagsAdapter.SETTINGS_ID;
  69  import static com.automattic.simplenote.utils.TagsAdapter.TAGS_ID;
  70  import static com.automattic.simplenote.utils.TagsAdapter.TRASH_ID;
  71  import static com.automattic.simplenote.utils.TagsAdapter.UNTAGGED_NOTES_ID;
  72  
  73  public class NotesActivity extends AppCompatActivity implements
<abbr title="  74          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  74          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  75          Bucket.Listener&lt;Note&gt; {
  76  
  77      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  78      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  79      protected Bucket&lt;Note&gt; mNotesBucket;
  80      protected Bucket&lt;Tag&gt; mTagsBucket;
  81      private boolean mIsShowingMarkdown;
  82      private boolean mShouldSelectNewNote;
  83      private boolean mIsSettingsClicked;
  84      private boolean mIsTabetFullscreen;
  85  
  86      private String mTabletSearchQuery;
  87      private UndoBarController mUndoBarController;
  88      private View mFragmentsContainer;
  89      private SearchView mSearchView;
  90      private MenuItem mSearchMenuItem;
  91      private NoteListFragment mNoteListFragment;
  92      private NoteEditorFragment mNoteEditorFragment;
  93      private Note mCurrentNote;
  94      private MenuItem mEmptyTrashMenuItem;
  95  
  96      // Menu drawer
  97      private static final int GROUP_PRIMARY = 100;
  98      private static final int GROUP_SECONDARY = 101;
  99      private static final int GROUP_TERTIARY = 102;
 100      private DrawerLayout mDrawerLayout;
 101      private Menu mNavigationMenu;
 102      private ActionBarDrawerToggle mDrawerToggle;
 103      private TagsAdapter mTagsAdapter;
 104      private TagsAdapter.TagMenuItem mSelectedTag;
 105      // Tags bucket listener
 106      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 107          void updateNavigationDrawer() {
 108              runOnUiThread(new Runnable() {
 109                  public void run() {
 110                      updateNavigationDrawerItems();
 111                  }
 112              });
 113          }
 114  
 115          @Override
 116          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 117              updateNavigationDrawer();
 118          }
 119  
 120          @Override
 121          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 122              updateNavigationDrawer();
 123          }
 124  
 125          @Override
 126          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 127              updateNavigationDrawer();
 128          }
 129  
 130          @Override
 131          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 132              // noop
 133          }
 134      };
 135  
 136      @Override
 137      protected void onCreate(Bundle savedInstanceState) {
 138          ThemeUtils.setTheme(this);
 139          super.onCreate(savedInstanceState);
 140  
 141          setContentView(R.layout.activity_notes);
 142  
 143          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 144  
 145          Simplenote currentApp = (Simplenote) getApplication();
 146          if (mNotesBucket == null) {
 147              mNotesBucket = currentApp.getNotesBucket();
 148          }
 149  
 150          if (mTagsBucket == null) {
 151              mTagsBucket = currentApp.getTagsBucket();
 152          }
 153  
 154          Toolbar toolbar = findViewById(R.id.toolbar);
 155          setSupportActionBar(toolbar);
 156          configureNavigationDrawer(toolbar);
 157  
 158          if (savedInstanceState == null) {
 159              mNoteListFragment = new NoteListFragment();
 160              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 161              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 162              fragmentTransaction.commit();
 163          } else {
 164              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 165          }
 166          mIsTabetFullscreen = mNoteListFragment.isHidden();
 167  
 168          if (DisplayUtils.isLargeScreen(this)) {
 169              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 170                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 170                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 171              } else if (DisplayUtils.isLandscape(this)) {
 172                  addEditorFragment();
 173              }
 174          }
 175  
 176          // enable ActionBar app icon to behave as action to toggle nav drawer
 177          ActionBar actionBar = getSupportActionBar();
 178          if (actionBar != null) {
 179              actionBar.setDisplayHomeAsUpEnabled(true);
 180              actionBar.setHomeButtonEnabled(true);
 181  
 182              // Add loading indicator to show when indexing
<abbr title=" 183              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 183              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 184              actionBar.setDisplayShowCustomEnabled(true);
 185              actionBar.setCustomView(progressBar);
 186              setToolbarProgressVisibility(false);
 187          }
 188  
 189          mUndoBarController = new UndoBarController(this);
 190  
 191          // Creates &#x27;Welcome&#x27; note
 192          checkForFirstLaunch();
 193  
 194          checkForSharedContent();
 195  
 196          currentApp.getSimperium().setOnUserCreatedListener(this);
 197          currentApp.getSimperium().setUserStatusChangeListener(this);
 198      }
 199  
 200      @Override
 201      protected void onResume() {
 202          super.onResume();
 203  
 204          // Ensure user has valid authorization
 205          if (userAuthenticationIsInvalid()) {
 206              startLoginActivity(true);
 207              Intent intent = getIntent();
 208  
 209              if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 210                      intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 211                  AnalyticsTracker.track(
 212                          NOTE_WIDGET_SIGN_IN_TAPPED,
 213                          CATEGORY_WIDGET,
 214                          &quot;note_widget_sign_in_tapped&quot;
 215                  );
 216              }
 217          }
 218  
 219          disableScreenshotsIfLocked(this);
 220  
 221          mNotesBucket.start();
 222          mTagsBucket.start();
 223  
 224          mNotesBucket.addOnNetworkChangeListener(this);
 225          mNotesBucket.addOnSaveObjectListener(this);
 226          mNotesBucket.addOnDeleteObjectListener(this);
 227          mTagsBucket.addListener(mTagsMenuUpdater);
 228  
 229          updateNavigationDrawerItems();
 230  
 231          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 232          if (userIsUnauthorized()) {
 233              if (mTagsAdapter.getPosition(mSelectedTag) == -1) {
 234                  mSelectedTag = null;
 235                  mNavigationMenu.getItem(DEFAULT_ITEM_POSITION).setChecked(true);
 236              }
 237          }
 238  
 239          filterListBySelectedTag();
 240  
 241          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
<abbr title=" 242              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());"> 242              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNoteðŸ”µ</abbr>
 243              mShouldSelectNewNote = false;
 244          }
 245  
 246          if (mIsShowingMarkdown) {
 247              setMarkdownShowing(false);
 248          }
 249  
 250          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 251          if(DisplayUtils.isLargeScreenLandscape(this)) {
 252              if (mIsTabetFullscreen) {
 253                  ft.hide(mNoteListFragment);
 254              } else {
 255                  ft.show(mNoteListFragment);
 256              }
 257          } else {
 258              ft.show(mNoteListFragment);
 259          }
 260          ft.commitNow();
 261      }
 262  
 263      @Override
 264      protected void onPause() {
 265          super.onPause();  // Always call the superclass method first
 266          mTagsBucket.removeListener(mTagsMenuUpdater);
 267          mTagsBucket.stop();
 268  
 269          mNotesBucket.removeOnNetworkChangeListener(this);
 270          mNotesBucket.removeOnSaveObjectListener(this);
 271          mNotesBucket.removeOnDeleteObjectListener(this);
 272          mNotesBucket.stop();
 273      }
 274  
 275      @Override
 276      public void setTitle(CharSequence title) {
 277          if (getSupportActionBar() != null) {
 278              getSupportActionBar().setTitle(title);
 279          }
 280      }
 281  
 282      @Override
 283      public void onBackPressed() {
 284          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 285              mDrawerLayout.closeDrawer(GravityCompat.START);
 286          } else {
 287              super.onBackPressed();
 288          }
 289      }
 290  
 291      @Override
 292      public void onActionModeCreated() {
 293          mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);
 294      }
 295  
 296      @Override
 297      public void onActionModeDestroyed() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -        mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +        if (mSearchMenuItem != null &amp;&amp; !mSearchMenuItem.isActionViewExpanded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +            mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        }</span>
 302      }
 303  
 304      private ColorStateList getIconSelector() {
 305          int[][] states = new int[][] {
 306                  new int[] { android.R.attr.state_checked}, // checked
 307                  new int[] {-android.R.attr.state_checked}  // unchecked
 308          };
 309  
 310          int[] colors = new int[] {
 311                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 312                  ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.toolbarIconColor)
 313          };
 314  
 315          return new ColorStateList(states, colors);
 316      }
 317  
 318      private ColorStateList getTextSelector() {
 319          int[][] states = new int[][] {
 320              new int[] {-android.R.attr.state_enabled}, // disabled
 321              new int[] { android.R.attr.state_checked}, // checked
 322              new int[] {-android.R.attr.state_checked}  // unchecked
 323          };
 324  
 325          int[] colors = new int[] {
 326              getResources().getColor(R.color.text_title_disabled, getTheme()),
 327              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.colorAccent),
 328              ThemeUtils.getColorFromAttribute(NotesActivity.this, R.attr.noteTitleColor)
 329          };
 330  
 331          return new ColorStateList(states, colors);
 332      }
 333  
 334      private void configureNavigationDrawer(Toolbar toolbar) {
 335          ColorStateList iconSelector = getIconSelector();
 336          ColorStateList textSelector = getTextSelector();
 337          mDrawerLayout = findViewById(R.id.drawer_layout);
 338          NavigationView navigationView = findViewById(R.id.navigation_view);
 339          navigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 340          navigationView.setItemIconTintList(iconSelector);
 341          navigationView.setItemTextColor(textSelector);
 342          navigationView.setNavigationItemSelectedListener(
 343              new NavigationView.OnNavigationItemSelectedListener() {
 344                  @Override
 345                  public boolean onNavigationItemSelected(@NonNull MenuItem item) {
 346                      mDrawerLayout.closeDrawer(GravityCompat.START);
 347  
 348                      if (item.getItemId() == SETTINGS_ID) {
 349                          AnalyticsTracker.track(
 350                                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 351                                  AnalyticsTracker.CATEGORY_TAG,
 352                                  &quot;selected_tag_in_navigation_drawer&quot;,
 353                                  new HashMap&lt;String, String&gt;(1){{put(&quot;tag&quot;, &quot;settings&quot;);}}
 354                          );
 355                          mIsSettingsClicked = true;
 356                          return false;
 357                      } else {
 358                          mSelectedTag = mTagsAdapter.getTagFromItem(item);
 359                          filterListBySelectedTag();
 360                          return true;
 361                      }
 362                  }
 363              }
 364          );
 365  
 366          mNavigationMenu = navigationView.getMenu();
<abbr title=" 367          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawable.ic_notes_24dp).setCheckable(true);"> 367          mNavigationMenu.add(GROUP_PRIMARY, ALL_NOTES_ID, Menu.NONE, getString(R.string.all_notes)).setIcon(R.drawaðŸ”µ</abbr>
<abbr title=" 368          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_trash_24dp).setCheckable(true);"> 368          mNavigationMenu.add(GROUP_PRIMARY, TRASH_ID, Menu.NONE, getString(R.string.trash)).setIcon(R.drawable.ic_tðŸ”µ</abbr>
<abbr title=" 369          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawable.ic_settings_24dp).setCheckable(false);"> 369          mNavigationMenu.add(GROUP_PRIMARY, SETTINGS_ID, Menu.NONE, getString(R.string.settings)).setIcon(R.drawablðŸ”µ</abbr>
 370          mTagsAdapter = new TagsAdapter(this, mNotesBucket);
 371  
 372          if (mSelectedTag == null)
 373              mSelectedTag = mTagsAdapter.getDefaultItem();
 374  
 375          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 376                  R.string.close_drawer) {
 377              public void onDrawerClosed(View view) {
 378                  supportInvalidateOptionsMenu();
 379  
 380                  if (mIsSettingsClicked) {
 381                      Intent intent = new Intent(NotesActivity.this, PreferencesActivity.class);
 382                      startActivityForResult(intent, Simplenote.INTENT_PREFERENCES);
 383                      mIsSettingsClicked = false;
 384                  }
 385              }
 386  
 387              public void onDrawerOpened(View drawerView) {
 388                  // noop
 389              }
 390  
 391              @Override
 392              public void onDrawerSlide(View drawerView, float slideOffset) {
 393                  super.onDrawerSlide(drawerView, 0f);
 394              }
 395          };
 396  
 397          mDrawerLayout.addDrawerListener(mDrawerToggle);
 398      }
 399  
 400      private void filterListBySelectedTag() {
 401          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 402  
 403          if (selectedMenuItem != null) {
 404              mSelectedTag = mTagsAdapter.getTagFromItem(selectedMenuItem);
 405          } else {
 406              mSelectedTag = mTagsAdapter.getDefaultItem();
 407          }
 408  
 409          checkEmptyListText(false);
 410  
 411          if (mNoteListFragment.isHidden()) {
 412              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 413              fragmentTransaction.show(mNoteListFragment);
 414              fragmentTransaction.commitNowAllowingStateLoss();
 415          }
 416  
 417          // Disable long press on notes when viewing Trash.
 418          if (mSelectedTag.id == TRASH_ID) {
 419              getNoteListFragment().getListView().setLongClickable(false);
 420          } else {
 421              getNoteListFragment().getListView().setLongClickable(true);
 422          }
 423  
 424          getNoteListFragment().refreshListFromNavSelect();
 425  
 426          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;(1);
 427  
 428          switch ((int) mSelectedTag.id) {
 429              case ALL_NOTES_ID:
 430                  properties.put(&quot;tag&quot;, &quot;all_notes&quot;);
 431                  break;
 432              case TRASH_ID:
 433                  properties.put(&quot;tag&quot;, &quot;trash&quot;);
 434                  break;
 435              case UNTAGGED_NOTES_ID:
 436                  properties.put(&quot;tag&quot;, &quot;untagged_notes&quot;);
 437                  break;
 438              default:
 439                  properties = null;
 440                  break;
 441          }
 442  
 443          AnalyticsTracker.track(
 444                  AnalyticsTracker.Stat.LIST_TAG_VIEWED,
 445                  AnalyticsTracker.CATEGORY_TAG,
 446                  &quot;selected_tag_in_navigation_drawer&quot;,
 447                  properties
 448          );
 449  
 450          setSelectedTagActive();
 451      }
 452  
 453      private void checkForFirstLaunch() {
 454          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 455              // Create the welcome note
 456              try {
 457                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 458                  welcomeNote.setCreationDate(Calendar.getInstance());
 459                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 460                  welcomeNote.setContent(getString(R.string.welcome_note));
 461                  welcomeNote.getTitle();
 462                  welcomeNote.save();
 463              } catch (BucketObjectNameInvalid e) {
 464                  // this won&#x27;t happen because welcome-android is a valid name
 465              }
 466  
 467              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 468              SharedPreferences.Editor editor = preferences.edit();
 469              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 470              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 471              editor.apply();
 472          }
 473      }
 474  
 475      private void checkForSharedContent() {
 476          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 477              // Check share action
 478              Intent intent = getIntent();
 479              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 480              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 481  
 482              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 483              String intentAction = StrUtils.notNullStr(intent.getAction());
 484              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 485              if (!TextUtils.isEmpty(text)) {
 486                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 487                      text = subject + &quot;\n\n&quot; + text;
 488                  }
 489                  Note note = mNotesBucket.newObject();
 490                  note.setCreationDate(Calendar.getInstance());
 491                  note.setModificationDate(note.getCreationDate());
 492                  note.setContent(text);
 493                  note.save();
 494                  setCurrentNote(note);
 495                  mShouldSelectNewNote = true;
 496  
 497                  AnalyticsTracker.track(
 498                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 499                          AnalyticsTracker.CATEGORY_NOTE,
 500                          &quot;external_share&quot;
 501                  );
 502  
 503                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 504                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 505                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 506                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 507                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 508                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 509                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 510                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 511                      }
 512                  }
 513              }
 514          }
 515      }
 516  
 517      private void updateNavigationDrawerItems() {
 518          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 519          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 520          if (isAlphaSort) {
 521              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 522          } else {
 523              tagCursor = Tag.allWithName(mTagsBucket).execute();
 524          }
 525  
 526          mTagsAdapter.changeCursor(tagCursor);
 527          mNavigationMenu.removeGroup(GROUP_SECONDARY);
 528          mNavigationMenu.removeGroup(GROUP_TERTIARY);
 529  
 530          if (mTagsAdapter.getCountCustom() &gt; 0) {
<abbr title=" 531              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layout.drawer_action_edit).setEnabled(false);"> 531              mNavigationMenu.add(GROUP_SECONDARY, TAGS_ID, Menu.NONE, getString(R.string.tags)).setActionView(R.layðŸ”µ</abbr>
 532  
 533              for (int i = 0; i &lt; mTagsAdapter.getCount(); i++) {
 534                  String name = mTagsAdapter.getItem(i).name;
 535                  int id = (int) mTagsAdapter.getItem(i).id;
 536  
 537                  if (id &gt;= 0) { // Custom tags have a positive ID.
 538                      mNavigationMenu.add(GROUP_SECONDARY, id, Menu.NONE, name).setCheckable(true);
 539                  }
 540              }
 541  
<abbr title=" 542              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).setIcon(R.drawable.ic_untagged_24dp).setCheckable(true);"> 542              mNavigationMenu.add(GROUP_TERTIARY, UNTAGGED_NOTES_ID, Menu.NONE, getString(R.string.untagged_notes)).ðŸ”µ</abbr>
 543              setSelectedTagActive();
 544          }
 545      }
 546  
 547      public void launchEditTags(View view) {
 548          startActivity(new Intent(NotesActivity.this, TagsActivity.class));
 549      }
 550  
 551      private void setSelectedTagActive() {
 552          if (mSelectedTag == null) {
 553              mSelectedTag = mTagsAdapter.getDefaultItem();
 554          }
 555  
 556          MenuItem selectedMenuItem = mNavigationMenu.findItem((int) mSelectedTag.id);
 557  
 558          if (selectedMenuItem != null) {
 559              selectedMenuItem.setChecked(true);
 560          } else {
 561              mNavigationMenu.findItem(ALL_NOTES_ID).setChecked(true);
 562          }
 563  
 564          setTitle(mSelectedTag.name);
 565      }
 566  
 567      public TagsAdapter.TagMenuItem getSelectedTag() {
 568          if (mSelectedTag == null) {
 569              mSelectedTag = mTagsAdapter.getDefaultItem();
 570          }
 571  
 572          return mSelectedTag;
 573      }
 574  
 575      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 576      public void updateTrashMenuItem() {
 577          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 578              return;
 579  
 580          // Disable the trash icon if there are no notes trashed.
 581          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 582          if (query.count() == 0) {
 583              mEmptyTrashMenuItem.setEnabled(false);
 584          } else {
 585              mEmptyTrashMenuItem.setEnabled(true);
 586          }
 587      }
 588  
 589      private void addEditorFragment() {
 590          FragmentManager fm = getSupportFragmentManager();
 591          FragmentTransaction ft = fm.beginTransaction();
 592          mNoteEditorFragment = new NoteEditorFragment();
 593          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 594          ft.commitAllowingStateLoss();
 595          fm.executePendingTransactions();
 596      }
 597  
 598      private boolean userAccountRequired() {
 599          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 600      }
 601  
 602      /**
 603       * Checks for a previously valid user that is now not authenticated
 604       * Also checks if user account is required (added in version 1.5.6)
 605       *
 606       * @return true if user has invalid authorization
 607       */
 608      private boolean userAuthenticationIsInvalid() {
 609          Simplenote currentApp = (Simplenote) getApplication();
 610          Simperium simperium = currentApp.getSimperium();
 611          User user = simperium.getUser();
 612          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 613          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 614                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 615      }
 616  
 617      public boolean userIsUnauthorized() {
 618          Simplenote currentApp = (Simplenote) getApplication();
 619          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 620      }
 621  
 622      public void setCurrentNote(Note note) {
 623          mCurrentNote = note;
 624      }
 625  
 626      public NoteListFragment getNoteListFragment() {
 627          return mNoteListFragment;
 628      }
 629  
 630      @Override
 631      public boolean onCreateOptionsMenu(final Menu menu) {
 632          super.onCreateOptionsMenu(menu);
 633          MenuInflater inflater = getMenuInflater();
 634          inflater.inflate(R.menu.notes_list, menu);
 635  
 636          // restore the search query if on a landscape tablet
 637          String searchQuery = null;
 638          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 639              searchQuery = mSearchView.getQuery().toString();
 640  
 641          mSearchMenuItem = menu.findItem(R.id.menu_search);
 642          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 643  
 644          if (!TextUtils.isEmpty(searchQuery)) {
 645              mSearchView.setQuery(searchQuery, false);
 646              mSearchMenuItem.expandActionView();
 647          } else {
 648              // Workaround for setting the search placeholder text color
 649              @SuppressWarnings(&quot;ResourceType&quot;)
 650              String hintHexColor = getString(R.color.text_title_disabled).replace(&quot;ff&quot;, &quot;&quot;);
 651              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 652                      hintHexColor,
 653                      getString(R.string.search))));
 654          }
 655  
 656          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 657              @Override
 658              public boolean onQueryTextChange(String newText) {
 659                  if (mSearchMenuItem.isActionViewExpanded()) {
 660                      getNoteListFragment().searchNotes(newText);
 661                  }
 662                  return true;
 663              }
 664  
 665              @Override
 666              public boolean onQueryTextSubmit(String queryText) {
 667                  getNoteListFragment().searchNotes(queryText);
 668                  return true;
 669              }
 670  
 671          });
 672  
 673          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 674              @Override
 675              public boolean onMenuItemActionExpand(MenuItem menuItem) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +                mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_LOCKED_CLOSED);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +</span>
 678                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 679                      updateActionsForLargeLandscape(menu);
 680                  }
 681  
 682                  checkEmptyListText(true);
 683  
 684                  if (mNoteListFragment != null) {
 685                      mNoteListFragment.setFloatingActionButtonVisible(false);
 686                  }
 687  
 688                  AnalyticsTracker.track(
 689                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 690                          AnalyticsTracker.CATEGORY_NOTE,
 691                          &quot;action_bar_search_tap&quot;
 692                  );
 693                  return true;
 694              }
 695  
 696              @Override
 697              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 698 +                mDrawerLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 699 +</span>
 700                  if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 701                      updateActionsForLargeLandscape(menu);
 702                  }
 703  
 704                  // Show all notes again
 705                  if (mNoteListFragment != null) {
 706                      mNoteListFragment.setFloatingActionButtonVisible(true);
 707                  }
 708  
 709                  mTabletSearchQuery = &quot;&quot;;
 710                  mSearchView.setQuery(&quot;&quot;, false);
 711                  checkEmptyListText(false);
 712                  getNoteListFragment().clearSearch();
 713                  return true;
 714              }
 715          });
 716  
 717          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 718              @Override
 719              public boolean onMenuItemClick(MenuItem item) {
 720                  if (!mSearchMenuItem.isActionViewExpanded())
 721                      showDetailPlaceholder();
 722                  return false;
 723              }
 724          });
 725  
 726          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 727          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 728              trashItem.setTitle(R.string.undelete);
 729              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 730          } else {
 731              trashItem.setTitle(R.string.delete);
 732              trashItem.setIcon(R.drawable.ic_trash_24dp);
 733          }
 734  
 735          if (DisplayUtils.isLargeScreenLandscape(NotesActivity.this)) {
 736              // Restore the search query on landscape tablets
 737              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 738                  mSearchMenuItem.expandActionView();
 739                  mSearchView.setQuery(mTabletSearchQuery, false);
 740                  mSearchView.clearFocus();
 741              }
 742  
 743              updateActionsForLargeLandscape(menu);
 744          } else {
 745              menu.findItem(R.id.menu_search).setVisible(true);
 746              menu.findItem(R.id.menu_share).setVisible(false);
 747              menu.findItem(R.id.menu_view_info).setVisible(false);
 748              menu.findItem(R.id.menu_checklist).setVisible(false);
 749              menu.findItem(R.id.menu_history).setVisible(false);
 750              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 751              menu.findItem(R.id.menu_sidebar).setVisible(false);
 752              trashItem.setVisible(false);
 753              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 754          }
 755  
 756          if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
 757              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 758              mEmptyTrashMenuItem.setVisible(true);
 759  
 760              updateTrashMenuItem();
 761  
 762              menu.findItem(R.id.menu_search).setVisible(false);
 763              menu.findItem(R.id.menu_share).setVisible(false);
 764              menu.findItem(R.id.menu_history).setVisible(false);
 765              menu.findItem(R.id.menu_checklist).setVisible(false);
 766          }
 767  
 768          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.toolbarIconColor);
 769  
 770          return true;
 771      }
 772  
 773      @Override
 774      public boolean onOptionsItemSelected(MenuItem item) {
 775          if (mDrawerToggle.onOptionsItemSelected(item)) {
 776              return true;
 777          }
 778          switch (item.getItemId()) {
 779              case R.id.menu_sidebar:
 780                  FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 781                  if (mNoteListFragment.isHidden()) {
 782                      ft.show(mNoteListFragment);
 783                  } else {
 784                      ft.hide(mNoteListFragment);
 785                  }
 786                  ft.commitNowAllowingStateLoss();
 787                  mIsTabetFullscreen = mNoteListFragment.isHidden();
 788                  return true;
 789              case R.id.menu_markdown_preview:
 790                  if (mIsShowingMarkdown) {
 791                      item.setIcon(R.drawable.ic_visibility_on_24dp);
 792                      item.setTitle(getString(R.string.markdown_show));
 793                      setMarkdownShowing(false);
 794                      mCurrentNote.setPreviewEnabled(false);
 795                  } else {
 796                      item.setIcon(R.drawable.ic_visibility_off_24dp);
 797                      item.setTitle(getString(R.string.markdown_hide));
 798                      setMarkdownShowing(true);
 799                      mCurrentNote.setPreviewEnabled(true);
 800                  }
 801  
 802                  mCurrentNote.save();
 803                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.toolbarIconColor);
 804  
 805                  return true;
 806              case R.id.menu_delete:
 807                  if (mNoteEditorFragment != null) {
 808                      if (mCurrentNote != null) {
 809                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 810                          mCurrentNote.setModificationDate(Calendar.getInstance());
 811                          mCurrentNote.save();
 812  
 813                          updateViewsAfterTrashAction(mCurrentNote);
 814                      }
 815                  }
 816                  return true;
 817              case R.id.menu_empty_trash:
<abbr title=" 818                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog));"> 818                  AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(this, R.style.Dialog))ðŸ”µ</abbr>
 819  
 820                  alert.setTitle(R.string.empty_trash);
 821                  alert.setMessage(R.string.confirm_empty_trash);
 822                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 823                      public void onClick(DialogInterface dialog, int whichButton) {
 824                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 825                          AnalyticsTracker.track(
 826                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 827                                  AnalyticsTracker.CATEGORY_NOTE,
 828                                  &quot;overflow_menu&quot;
 829                          );
 830                      }
 831                  });
 832                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 833                      public void onClick(DialogInterface dialog, int whichButton) {
 834                          // Do nothing, just closing the dialog
 835                      }
 836                  });
 837                  alert.show();
 838                  return true;
 839              case android.R.id.home:
 840                  invalidateOptionsMenu();
 841                  return true;
 842              default:
 843                  return super.onOptionsItemSelected(item);
 844          }
 845      }
 846  
 847      @Override
 848      public boolean onPrepareOptionsMenu(Menu menu) {
 849          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 850  
 851          if (mIsShowingMarkdown) {
 852              markdownItem.setIcon(R.drawable.ic_visibility_off_24dp);
 853              markdownItem.setTitle(getString(R.string.markdown_hide));
 854          } else {
 855              markdownItem.setIcon(R.drawable.ic_visibility_on_24dp);
 856              markdownItem.setTitle(getString(R.string.markdown_show));
 857          }
 858  
 859          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.toolbarIconColor);
 860  
 861          return super.onPrepareOptionsMenu(menu);
 862      }
 863  
 864      private void updateActionsForLargeLandscape(Menu menu) {
 865          if (mCurrentNote != null) {
 866              menu.findItem(R.id.menu_checklist).setVisible(true);
 867              menu.findItem(R.id.menu_delete).setVisible(true);
 868              menu.findItem(R.id.menu_history).setVisible(true);
 869              menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 870              menu.findItem(R.id.menu_share).setVisible(true);
 871              menu.findItem(R.id.menu_sidebar).setVisible(true);
 872              menu.findItem(R.id.menu_view_info).setVisible(true);
 873          } else {
 874              menu.findItem(R.id.menu_checklist).setVisible(false);
 875              menu.findItem(R.id.menu_delete).setVisible(false);
 876              menu.findItem(R.id.menu_history).setVisible(false);
 877              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 878              menu.findItem(R.id.menu_share).setVisible(false);
 879              menu.findItem(R.id.menu_sidebar).setVisible(false);
 880              menu.findItem(R.id.menu_view_info).setVisible(false);
 881          }
 882  
 883          menu.findItem(R.id.menu_empty_trash).setVisible(false);
 884      }
 885  
 886      public void updateViewsAfterTrashAction(Note note) {
 887          if (note == null || isFinishing()) {
 888              return;
 889          }
 890  
 891          if (note.isDeleted()) {
 892              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 893              deletedNoteIds.add(note.getSimperiumKey());
 894              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 895              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 896              AnalyticsTracker.track(
 897                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 898                      AnalyticsTracker.CATEGORY_NOTE,
 899                      &quot;overflow_menu&quot;
 900              );
 901          } else {
 902              AnalyticsTracker.track(
 903                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 904                      AnalyticsTracker.CATEGORY_NOTE,
 905                      &quot;overflow_menu&quot;
 906              );
 907          }
 908  
 909          // If we just deleted/restored the active note, show the placeholder
 910          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 911              showDetailPlaceholder();
 912          }
 913  
 914          NoteListFragment fragment = getNoteListFragment();
 915          if (fragment != null) {
 916              fragment.getPrefs();
 917              fragment.refreshList();
 918          }
 919  
 920          invalidateOptionsMenu();
 921      }
 922  
 923      public void setMarkdownShowing(boolean isMarkdownShowing) {
 924          mIsShowingMarkdown = isMarkdownShowing;
 925          if (mNoteEditorFragment != null) {
 926              if (isMarkdownShowing) {
 927                  mNoteEditorFragment.showMarkdown();
 928              } else {
 929                  mNoteEditorFragment.hideMarkdown();
 930              }
 931          }
 932          invalidateOptionsMenu();
 933      }
 934  
 935      /**
 936       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 937       * the item with the given ID was selected. Used for tablets only.
 938       */
 939      @Override
<abbr title=" 940      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, boolean isPreviewEnabled) {"> 940      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled, booleaðŸ”µ</abbr>
 941          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 942              // Launch the editor activity
 943              Bundle arguments = new Bundle();
 944              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 945              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 946              arguments.putBoolean(NoteEditorFragment.ARG_PREVIEW_ENABLED, isPreviewEnabled);
 947  
 948              if (matchOffsets != null) {
 949                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 950              }
 951  
 952              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 953              editNoteIntent.putExtras(arguments);
 954              if (mNoteListFragment.isHidden()) {
 955                  editNoteIntent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);
 956              }
 957              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 958          } else {
 959              mNoteEditorFragment.setNote(noteID, matchOffsets);
 960              getNoteListFragment().setNoteSelected(noteID);
 961              setMarkdownShowing(isPreviewEnabled);
 962  
 963              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 964                  mTabletSearchQuery = mSearchView.getQuery().toString();
 965              }
 966  
 967              mNoteEditorFragment.clearMarkdown();
 968  
 969              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 970                  setMarkdownShowing(false);
 971              }
 972  
 973              invalidateOptionsMenu();
 974          }
 975  
 976          AnalyticsTracker.track(
 977                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 978                  AnalyticsTracker.CATEGORY_NOTE,
 979                  &quot;note_list_row_tap&quot;
 980          );
 981      }
 982  
 983      @Override
 984      public void onUserCreated(User user) {
 985          // New account created
 986          AnalyticsTracker.track(
 987                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 988                  AnalyticsTracker.CATEGORY_USER,
 989                  &quot;account_created_from_login_activity&quot;
 990          );
 991      }
 992  
 993      public void onUserStatusChange(User.Status status) {
 994          switch (status) {
 995              // successfully used access token to connect to simperium bucket
 996              case AUTHORIZED:
 997                  runOnUiThread(new Runnable() {
 998                      @Override
 999                      public void run() {
1000                          if (!mNotesBucket.hasChangeVersion()) {
1001                              setToolbarProgressVisibility(true);
1002                          }
1003                      }
1004                  });
1005                  break;
1006  
1007              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
1008              case NOT_AUTHORIZED:
1009                  runOnUiThread(new Runnable() {
1010                      @Override
1011                      public void run() {
1012                          startLoginActivity(true);
1013                      }
1014                  });
1015                  break;
1016  
<abbr title="1017              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything">1017              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
1018              case UNKNOWN:
1019                  break;
1020          }
1021      }
1022  
1023      private void setToolbarProgressVisibility(boolean isVisible) {
1024          if (getSupportActionBar() != null) {
1025              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
1026          }
1027      }
1028  
1029      public void startLoginActivity(boolean signInFirst) {
1030          // Clear some account-specific prefs
1031          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
1032          editor.remove(PrefUtils.PREF_WP_TOKEN);
1033          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
1034          editor.apply();
1035  
1036          Intent intent = new Intent(NotesActivity.this, SimplenoteAuthenticationActivity.class);
1037          startActivityForResult(intent, Simperium.SIGNUP_SIGNIN_REQUEST);
1038      }
1039  
1040      @Override
1041      public void recreate() {
1042          Handler handler = new Handler();
1043          handler.post(new Runnable() {
1044              @Override
1045              public void run() {
1046                  NotesActivity.super.recreate();
1047              }
1048          });
1049      }
1050  
1051      @Override
1052      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
1053          super.onActivityResult(requestCode, resultCode, data);
1054          switch (requestCode) {
1055              case Simplenote.INTENT_PREFERENCES:
<abbr title="1056                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)">1056                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
1057                  invalidateOptionsMenu();
1058                  NoteListFragment fragment = getNoteListFragment();
1059                  if (fragment != null) {
1060                      fragment.getPrefs();
1061                      fragment.refreshList();
1062                  }
1063  
1064                  break;
1065              case Simplenote.INTENT_EDIT_NOTE:
1066                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
1067                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
1068                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
1069                          if (noteId != null) {
1070                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
1071                              deletedNoteIds.add(noteId);
1072                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
1073                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
1074                          }
<abbr title="1075                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {">1075                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
1076                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
1077                          mNoteListFragment.setNoteSelected(selectedNoteId);
1078                          if (mNoteEditorFragment != null) {
1079                              mNoteEditorFragment.setNote(selectedNoteId);
1080                          }
1081                      }
1082                  }
1083                  break;
1084              case Simperium.SIGNUP_SIGNIN_REQUEST:
1085                  invalidateOptionsMenu();
1086  
1087                  Simplenote app = (Simplenote) getApplication();
1088                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
1089                  CrashUtils.setCurrentUser(app.getSimperium().getUser());
1090  
1091                  AnalyticsTracker.track(
1092                          AnalyticsTracker.Stat.USER_SIGNED_IN,
1093                          AnalyticsTracker.CATEGORY_USER,
1094                          &quot;signed_in_from_login_activity&quot;
1095                  );
1096  
1097                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
1098                      finish();
1099                  }
1100  
1101                  break;
1102          }
1103      }
1104  
1105      @Override
1106      public void onUndo() {
1107          if (mUndoBarController == null) return;
1108  
1109          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
1110          if (deletedNoteIds != null) {
1111              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
1112                  Note deletedNote;
1113                  try {
1114                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
1115                  } catch (BucketObjectMissingException e) {
1116                      return;
1117                  }
1118                  if (deletedNote != null) {
1119                      deletedNote.setDeleted(false);
1120                      deletedNote.setModificationDate(Calendar.getInstance());
1121                      deletedNote.save();
1122                      NoteListFragment fragment = getNoteListFragment();
1123                      if (fragment != null) {
1124                          fragment.getPrefs();
1125                          fragment.refreshList();
1126                      }
1127                  }
1128              }
1129          }
1130      }
1131  
1132      @Override
1133      protected void onPostCreate(Bundle savedInstanceState) {
1134          super.onPostCreate(savedInstanceState);
1135          // Sync the toggle state after onRestoreInstanceState has occurred.
1136          mDrawerToggle.syncState();
1137      }
1138  
1139      @Override
1140      public void onConfigurationChanged(@NonNull Configuration newConfig) {
1141          super.onConfigurationChanged(newConfig);
1142  
1143          mDrawerToggle.onConfigurationChanged(newConfig);
1144  
1145          if (DisplayUtils.isLargeScreen(this)) {
1146              mIsShowingMarkdown = false;
1147  
1148              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
1149                  // Add the editor fragment
1150                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title="1151                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);">1151                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
1152                  } else if (DisplayUtils.isLandscape(this)) {
1153                      addEditorFragment();
1154                  }
1155  
1156                  if (mNoteListFragment != null) {
1157                      mNoteListFragment.setActivateOnItemClick(true);
1158                      mNoteListFragment.setDividerVisible(true);
1159                  }
1160  
1161                  // Select the current note on a tablet
1162                  if (mCurrentNote != null) {
<abbr title="1163                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1163                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurðŸ”µ</abbr>
1164                  } else {
1165                      mNoteEditorFragment.setPlaceholderVisible(true);
1166                      mNoteListFragment.getListView().clearChoices();
1167                  }
1168  
1169                  invalidateOptionsMenu();
1170              // Go to NoteEditorActivity if note editing was fullscreen and orientation was switched to portrait
1171              } else if (mNoteListFragment.isHidden() &amp;&amp; mCurrentNote != null) {
<abbr title="1172                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentNote.isPreviewEnabled());">1172                  onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled(), mCurrentðŸ”µ</abbr>
1173              }
1174          }
1175  
1176          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1177              // Remove the editor fragment when rotating back to portrait
1178              mCurrentNote = null;
1179              if (mNoteListFragment != null) {
1180                  mNoteListFragment.setActivateOnItemClick(false);
1181                  mNoteListFragment.setDividerVisible(false);
1182                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1183                  mNoteListFragment.refreshList();
1184              }
1185              FragmentManager fm = getSupportFragmentManager();
1186              FragmentTransaction ft = fm.beginTransaction();
1187              ft.remove(mNoteEditorFragment);
1188              mNoteEditorFragment = null;
1189              ft.commitAllowingStateLoss();
1190              fm.executePendingTransactions();
1191              invalidateOptionsMenu();
1192          }
1193      }
1194  
1195      public void checkEmptyListText(boolean isSearch) {
1196          if (isSearch) {
<abbr title="1197              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1197              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1198              getNoteListFragment().setEmptyListViewClickable(false);
1199          } else if (mSelectedTag != null &amp;&amp; mSelectedTag.id == TRASH_ID) {
<abbr title="1200              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1200              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1201              AnalyticsTracker.track(
1202                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1203                      AnalyticsTracker.CATEGORY_NOTE,
1204                      &quot;trash_filter_selected&quot;
1205              );
1206              getNoteListFragment().setEmptyListViewClickable(false);
1207          } else {
<abbr title="1208              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1208              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1209              getNoteListFragment().setEmptyListViewClickable(true);
1210          }
1211      }
1212  
1213      public void showDetailPlaceholder() {
1214          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1215              mCurrentNote = null;
1216              mNoteEditorFragment.setPlaceholderVisible(true);
1217              mNoteEditorFragment.clearMarkdown();
1218              mNoteEditorFragment.hideMarkdown();
1219              mIsShowingMarkdown = false;
1220          }
1221      }
1222  
1223      public void stopListeningToNotesBucket() {
1224          mNotesBucket.removeOnNetworkChangeListener(this);
1225          mNotesBucket.removeOnSaveObjectListener(this);
1226          mNotesBucket.removeOnDeleteObjectListener(this);
1227      }
1228  
1229      // Returns the appropriate view to show the undo bar within
1230      private View getUndoView() {
1231          View undoView = mFragmentsContainer;
1232          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1233                  getNoteListFragment() != null &amp;&amp;
1234                  getNoteListFragment().getRootView() != null) {
1235              undoView = getNoteListFragment().getRootView();
1236          }
1237  
1238          return undoView;
1239      }
1240  
1241      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1242          if (mUndoBarController != null) {
1243              mUndoBarController.setDeletedNoteIds(noteIds);
1244              mUndoBarController.showUndoBar(
1245                      getUndoView(),
1246                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1247              );
1248          }
1249      }
1250  
1251      /* Simperium Bucket Listeners */
1252      // received a change from the network, refresh the list
1253      @Override
1254      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1255          runOnUiThread(new Runnable() {
1256              @Override
1257              public void run() {
1258                  if (type == Bucket.ChangeType.INDEX) {
1259                      setToolbarProgressVisibility(false);
1260                  }
1261                  mNoteListFragment.refreshList();
1262              }
1263          });
1264      }
1265  
1266      @Override
1267      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1268          runOnUiThread(new Runnable() {
1269              @Override
1270              public void run() {
1271                  mNoteListFragment.refreshList();
1272              }
1273          });
1274      }
1275  
1276      @Override
1277      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1278          runOnUiThread(new Runnable() {
1279              @Override
1280              public void run() {
1281                  mNoteListFragment.refreshList();
1282              }
1283          });
1284      }
1285  
1286      @Override
1287      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1288          // noop, NoteEditorFragment will handle this
1289      }
1290  
1291      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1292  
1293          @Override
1294          protected Void doInBackground(Void... voids) {
1295              if (mNotesBucket == null) return null;
1296  
1297              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1298              Bucket.ObjectCursor c = query.execute();
1299              while (c.moveToNext()) {
1300                  c.getObject().delete();
1301              }
1302  
1303              return null;
1304          }
1305  
1306          @Override
1307          protected void onPostExecute(Void nada) {
1308              showDetailPlaceholder();
1309          }
1310      }
1311  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            