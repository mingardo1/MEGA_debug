<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>551</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    551
                    <a href="550.html">prev</a>
                    <a href="552.html">next</a>
                    <a href="551_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_480cc75b1cb442e73c527d4143197bb30c9b53c5_kafka09/kafka09-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5:kafka09/kafka09-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5^1:kafka09/kafka09-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5^2:kafka09/kafka09-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cf3543519ddfe6db5473b2b15766ed32bc95d5cf:kafka09/kafka09-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [b], [j], [j]], subset: [[b], [b], [b], [b], [b], [j], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.flink.api.common.typeinfo.TypeInformation;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29 import org.apache.flink.streaming.api.datastream.DataStream;
  30 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
  32 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;</span>
  34 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span>
  36 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  37 import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;
  38 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  39 import org.apache.flink.table.api.TableSchema;
  40 import org.apache.flink.table.runtime.types.CRow;
  41 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  42 import org.apache.flink.table.sinks.RetractStreamTableSink;
  43 import org.apache.flink.table.sinks.TableSink;
  44 import org.apache.flink.types.Row;
  45 
  46 import java.util.Optional;
  47 import java.util.Properties;
  48 
  49 /**
  50  * Date: 2018/12/18
  51  * Company: www.dtstack.com
  52  *
  53  * @author DocLi
  54  * @modifyer maqi
  55  */
  56 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  57     private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  58 
  59     protected String[] fieldNames;
  60 
  61     protected TypeInformation&lt;?&gt;[] fieldTypes;
  62 
  63     protected String topic;
  64 
  65     protected Properties properties;
  66 
  67 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     protected FlinkKafkaProducer09&lt;Row&gt; kafkaProducer09;</span>
  69 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 	protected FlinkKafkaProducer09&lt;Row&gt; kafkaProducer09;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 	/** The schema of the table. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 	private TableSchema schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
  75 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 	protected FlinkKafkaProducer09&lt;CRow&gt; kafkaProducer09;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 	protected CRowTypeInfo typeInformation;</span>
  78 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  79 
  80     /** The schema of the table. */
  81     private TableSchema schema;
  82 
  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     /** Partitioner to select Kafka partition for each item. */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85     protected Optional&lt;FlinkKafkaPartitioner&lt;Row&gt;&gt; partitioner;</span>
  86 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 	/** Partitioner to select Kafka partition for each item. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 	protected Optional&lt;FlinkKafkaPartitioner&lt;Row&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 	private String[] partitionKeys;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	protected int parallelism;</span>
  93 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94 	/** Partitioner to select Kafka partition for each item. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 	protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;</span>
  96 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  97 
  98     private String[] partitionKeys;
  99 
 100     protected int parallelism;
 101 
 102     protected String sinkOperatorName;
 103 
 104     @Override
 105     public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
 106         KafkaSinkTableInfo kafka09SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
 107         this.topic = kafka09SinkTableInfo.getTopic();
 108 
 109         properties = new Properties();
 110         properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());
 111         for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {
 112             properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));
 113         }
 114 
 115         this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());
 116         this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);
 117         this.fieldNames = kafka09SinkTableInfo.getFields();
 118         TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];
 119         for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {
 120             types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);
 121         }
 122         this.fieldTypes = types;
 123 
 124         TableSchema.Builder schemaBuilder = TableSchema.builder();
 125         for (int i = 0; i &lt; fieldNames.length; i++) {
 126             schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 127         }
 128         this.schema = schemaBuilder.build();
 129 
 130         Integer parallelism = kafka09SinkTableInfo.getParallelism();
 131         if (parallelism != null) {
 132             this.parallelism = parallelism;
 133         }
 134 
 135 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 137                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 137                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partðŸ”µ</abbr></span>
 138 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 140                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 140                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 		return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 	public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 		return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 	}</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 		typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;CRow&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 151                 .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partitionKeys);"> 151                 .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 		return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 	}</span>
 154 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 155 
<abbr title=" 156         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTableInfo.getName());"> 156         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SðŸ”µ</abbr>
 157 
 158 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169         consumeDataStream(dataStream);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173     public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         DataStream&lt;Row&gt; ds = dataStream</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                 .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                 .returns(getOutputType().getTypeAt(1))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                 .setParallelism(parallelism);</span>
 179 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 	public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 		return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 		DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 .returns(getOutputType().getTypeAt(1))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 		mapDataStream.addSink(kafkaProducer09)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 .name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 	public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 198 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 198 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 	}</span>
 200 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 		DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 				.returns(typeInformation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 				.setParallelism(parallelism);</span>
 207 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 208 
 209         DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer09).name(sinkOperatorName);
 210         return dataStreamSink;
 211 
 212     }
 213 
 214     @Override
 215     public TableSchema getTableSchema() {
 216         return schema;
 217     }
 218 
 219     @Override
<abbr title=" 220     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 220     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr>
 221         this.fieldNames = fieldNames;
 222         this.fieldTypes = fieldTypes;
 223         return this;
 224     }
 225 
 226     @Override
 227     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 228         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 228         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr>
 229     }
 230 
 231     private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {
 232         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {
 233             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 234         }
 235         return null;
 236     }
 237 
 238 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.flink.api.common.typeinfo.TypeInformation;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29 import org.apache.flink.streaming.api.datastream.DataStream;
  30 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  31 import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;
  32 import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;
  33 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  34 import org.apache.flink.table.api.TableSchema;
  35 import org.apache.flink.table.runtime.types.CRow;
  36 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  37 import org.apache.flink.table.sinks.RetractStreamTableSink;
  38 import org.apache.flink.table.sinks.TableSink;
  39 import org.apache.flink.types.Row;
  40 
  41 import java.util.Optional;
  42 import java.util.Properties;
  43 
  44 /**
  45  * Date: 2018/12/18
  46  * Company: www.dtstack.com
  47  *
  48  * @author DocLi
  49  * @modifyer maqi
  50  */
  51 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  52     private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  53 
  54     protected String[] fieldNames;
  55 
  56     protected TypeInformation&lt;?&gt;[] fieldTypes;
  57 
  58     protected String topic;
  59 
  60     protected Properties properties;
  61 
  62     protected FlinkKafkaProducer09&lt;CRow&gt; kafkaProducer09;
  63 	protected CRowTypeInfo typeInformation;
  64 
  65     /** The schema of the table. */
  66     private TableSchema schema;
  67 
  68     /** Partitioner to select Kafka partition for each item. */
  69     protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;
  70 
  71     private String[] partitionKeys;
  72 
  73     protected int parallelism;
  74 
  75     protected String sinkOperatorName;
  76 
  77     @Override
  78 	public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  79 		KafkaSinkTableInfo kafka09SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  80 		this.topic = kafka09SinkTableInfo.getTopic();
  81 
  82 		properties = new Properties();
  83 		properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());
  84 		for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {
  85 			properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));
  86 		}
  87 
  88 		this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());
  89 		this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);
  90 		this.fieldNames = kafka09SinkTableInfo.getFields();
  91 		TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];
  92 		for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {
  93 			types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);
  94 		}
  95 		this.fieldTypes = types;
  96 
  97 		TableSchema.Builder schemaBuilder = TableSchema.builder();
  98 		for (int i=0;i&lt;fieldNames.length;i++) {
  99             schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 100         }
 101 		this.schema = schemaBuilder.build();
 102 
 103 		Integer parallelism = kafka09SinkTableInfo.getParallelism();
 104 		if (parallelism != null) {
 105 			this.parallelism = parallelism;
 106 		}
 107 
 108 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 110                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 110                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 112         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTableInfo.getName());"> 112         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113 </span>
 114 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 116                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 116                 .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 		return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 	}</span>
 119 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 		typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;CRow&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 122                 .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partitionKeys);"> 122                 .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partðŸ”µ</abbr></span>
 123 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 124 		return this;
 125 	}
 126 
 127     @Override
 128 	public TypeInformation&lt;Row&gt; getRecordType() {
 129 		return new RowTypeInfo(fieldTypes, fieldNames);
 130 	}
 131 
 132     @Override
 133 	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 134 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         consumeDataStream(dataStream);</span>
 136 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 		DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139                 .returns(getOutputType().getTypeAt(1))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140                 .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 		mapDataStream.addSink(kafkaProducer09)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143                 .name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));</span>
 144 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 		DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 				.returns(typeInformation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 				.setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 		mapDataStream.addSink(kafkaProducer09)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                 .name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));</span>
 152 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 153 	}
 154 
 155     @Override
 156     public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 157         DataStream&lt;Row&gt; ds = dataStream
 158                 .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)
 159                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)
 160                 .returns(getOutputType().getTypeAt(1))
 161                 .setParallelism(parallelism);
 162 
 163         DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer09).name(sinkOperatorName);
 164         return dataStreamSink;
 165 
 166     }
 167 
 168     @Override
 169     public TableSchema getTableSchema() {
 170         return schema;
 171     }
 172 
 173     @Override
 174 	public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 175 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 175 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNðŸ”µ</abbr>
 176 	}
 177 
 178     @Override
 179 	public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
 180 		this.fieldNames = fieldNames;
 181 		this.fieldTypes = fieldTypes;
 182 		return this;
 183 	}
 184 
 185     private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 186 		if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){
 187 			return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 188 		}
 189 		return null;
 190 	}
 191 
 192 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.kafka;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  22 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  23 import java.util.Optional;
  24 import java.util.Properties;
  25 import org.apache.commons.lang3.StringUtils;
  26 import org.apache.flink.api.common.typeinfo.TypeInformation;
  27 import org.apache.flink.api.java.tuple.Tuple2;
  28 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  29 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  30 import org.apache.flink.streaming.api.datastream.DataStream;
  31 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  32 import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;
  33 import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;
  34 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  35 import org.apache.flink.table.api.TableSchema;
  36 import org.apache.flink.table.runtime.types.CRow;
  37 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  38 import org.apache.flink.table.sinks.RetractStreamTableSink;
  39 import org.apache.flink.table.sinks.TableSink;
  40 import org.apache.flink.types.Row;
  41 
  42 
  43 /**
  44  * Date: 2018/12/18
  45  * Company: www.dtstack.com
  46  *
  47  * @author DocLi
  48  * @modifyer maqi
  49  */
  50 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt; , IStreamSinkGener&lt;KafkaSink&gt; {
  51 				private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  52 
  53 	protected String[] fieldNames;
  54 
  55 	protected TypeInformation&lt;?&gt;[] fieldTypes;
  56 
  57 	protected String topic;
  58 
  59 	protected Properties properties;
  60 
  61 	protected FlinkKafkaProducer09&lt;CRow&gt; kafkaProducer09;
  62 
  63 	protected CRowTypeInfo typeInformation;
  64 
  65 	/** The schema of the table. */
  66 	private TableSchema schema;
  67 
  68 	/** Partitioner to select Kafka partition for each item. */
  69 	protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;
  70 
  71 	private String[] partitionKeys;
  72 
  73 	protected int parallelism;
  74 
  75 				protected String sinkOperatorName;
  76 
  77 	@Override
  78 	public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  79 		KafkaSinkTableInfo kafka09SinkTableInfo = ((KafkaSinkTableInfo) (targetTableInfo));
  80 		this.topic = kafka09SinkTableInfo.getTopic();
  81 		properties = new Properties();
  82 		properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());
  83 		for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {
  84 			properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));
  85 		}
  86 		this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());
  87 		this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);
  88 		this.fieldNames = kafka09SinkTableInfo.getFields();
  89 		TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];
  90 		for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {
  91 			types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);
  92 		}
  93 		this.fieldTypes = types;
  94 		TableSchema.Builder schemaBuilder = TableSchema.builder();
  95 		for (int i = 0; i &lt; fieldNames.length; i++) {
  96 			schemaBuilder.field(fieldNames[i], fieldTypes[i]);
  97 		}
  98 		this.schema = schemaBuilder.build();
  99 		Integer parallelism = kafka09SinkTableInfo.getParallelism();
 100 		if (parallelism != null) {
 101 			this.parallelism = parallelism;
 102 		}
 103 		typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));
<abbr title=" 104 		this.kafkaProducer09 = ((FlinkKafkaProducer09&lt;CRow&gt;) (new KafkaProducer09Factory().createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partitionKeys)));"> 104 		this.kafkaProducer09 = ((FlinkKafkaProducer09&lt;CRow&gt;) (new KafkaProducer09Factory().createKafkaProducer(ðŸ”µ</abbr>
<abbr title=" 105 		sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTableInfo.getName());"> 105 		sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTabðŸ”µ</abbr>
 106 		return this;
 107 	}
 108 
 109 	@Override
 110 	public TypeInformation&lt;Row&gt; getRecordType() {
 111 		return new RowTypeInfo(fieldTypes, fieldNames);
 112 	}
 113 
 114 	@Override
 115 	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 116 		consumeDataStream(dataStream);
 117 	}
 118 
 119 	@Override
 120 	public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
<abbr title=" 121 		DataStream&lt;CRow&gt; ds = dataStream.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0)).returns(typeInformation).setParallelism(parallelism);"> 121 		DataStream&lt;CRow&gt; ds = dataStream.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0)).rðŸ”µ</abbr>
 122 		DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer09).name(sinkOperatorName);
 123 		return dataStreamSink;
 124 	}
 125 
 126 	@Override
 127 	public TableSchema getTableSchema() {
 128 		return schema;
 129 	}
 130 
 131 	@Override
 132 	public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
 133 		this.fieldNames = fieldNames;
 134 		this.fieldTypes = fieldTypes;
 135 		return this;
 136 	}
 137 
 138 	@Override
 139 	public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 140 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 140 		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNðŸ”µ</abbr>
 141 	}
 142 
 143 	private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 144 		if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){
 145 			return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 146 		}
 147 		return null;
 148 	}
 149 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka;
  20  
  21  import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22  import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23  import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.flink.api.common.typeinfo.TypeInformation;
  26  import org.apache.flink.api.java.tuple.Tuple2;
  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29  import org.apache.flink.streaming.api.datastream.DataStream;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
  31  import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkFixedPartitioner;</span>
  33  import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  34  import org.apache.flink.table.api.TableSchema;


  35  import org.apache.flink.table.sinks.RetractStreamTableSink;
  36  import org.apache.flink.table.sinks.TableSink;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.table.utils.TableConnectorUtils;</span>
  38  import org.apache.flink.types.Row;
  39  
  40  import java.util.Optional;
  41  import java.util.Properties;
  42  
  43  /**
  44   * Date: 2018/12/18
  45   * Company: www.dtstack.com
  46   *
  47   * @author DocLi
  48   * @modifyer maqi
  49   */
  50  public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +    private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
  52  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -	protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +    protected String[] fieldNames;</span>
  55  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -	protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
  58  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -	protected String topic;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    protected String topic;</span>
  61  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -	protected Properties properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +    protected Properties properties;</span>
  64  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -	protected FlinkKafkaProducer09&lt;Row&gt; kafkaProducer09;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +    protected FlinkKafkaProducer09&lt;Row&gt; kafkaProducer09;</span>

  67  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -	/** The schema of the table. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -	private TableSchema schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    /** The schema of the table. */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private TableSchema schema;</span>
  72  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -	/** Partitioner to select Kafka partition for each item. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -	protected Optional&lt;FlinkKafkaPartitioner&lt;Row&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    /** Partitioner to select Kafka partition for each item. */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +    protected Optional&lt;FlinkKafkaPartitioner&lt;Row&gt;&gt; partitioner;</span>
  77  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -	private String[] partitionKeys;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    private String[] partitionKeys;</span>
  80  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -	protected int parallelism;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +    protected int parallelism;</span>
  83  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    protected String sinkOperatorName;</span>
  85  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +    public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        KafkaSinkTableInfo kafka09SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +        this.topic = kafka09SinkTableInfo.getTopic();</span>
  90  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -	public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -		KafkaSinkTableInfo kafka09SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -		this.topic = kafka09SinkTableInfo.getTopic();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        properties = new Properties();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +        for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +            properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        }</span>
 100  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -		properties = new Properties();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -		properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -		for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -			properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -		}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        this.fieldNames = kafka09SinkTableInfo.getFields();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        this.fieldTypes = types;</span>
 114  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -		this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -		this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -		this.fieldNames = kafka09SinkTableInfo.getFields();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -		TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -		for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -			types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -		this.fieldTypes = types;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -		TableSchema.Builder schemaBuilder = TableSchema.builder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -		for (int i=0;i&lt;fieldNames.length;i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        TableSchema.Builder schemaBuilder = TableSchema.builder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        for (int i = 0; i &lt; fieldNames.length; i++) {</span>
 128              schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 129          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -		this.schema = schemaBuilder.build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        this.schema = schemaBuilder.build();</span>
 132  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -		Integer parallelism = kafka09SinkTableInfo.getParallelism();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -		if (parallelism != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -			this.parallelism = parallelism;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -		}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        Integer parallelism = kafka09SinkTableInfo.getParallelism();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        if (parallelism != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +            this.parallelism = parallelism;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        }</span>
 141  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>
<abbr title=" 144                  .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 144                  .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, ðŸ”µ</abbr>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -		return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -	}</span>
 147  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -	public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -		return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 152 +        sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTableInfo.getName());"> 152 +        sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka09SinkTableIðŸ”µ</abbr></span>
 153  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -		DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +    public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +    public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +        consumeDataStream(dataStream);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +        DataStream&lt;Row&gt; ds = dataStream</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
 176                  .returns(getOutputType().getTypeAt(1))
 177                  .setParallelism(parallelism);




 178  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -		mapDataStream.addSink(kafkaProducer09)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                .name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer09).name(sinkOperatorName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        return dataStreamSink;</span>
 184  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -	public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    }</span>
 190  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -	public String[] getFieldNames() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -		return fieldNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +    public TableSchema getTableSchema() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +        return schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +    }</span>
 199  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -	public TypeInformation&lt;?&gt;[] getFieldTypes() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -		return fieldTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +    public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    }</span>
 210  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -	public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -		this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -		this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -		return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +    public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 219 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 219 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNameðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +    }</span>
 221  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -	private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -		if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -			return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -		return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +    private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +    }</span>
 234  
 235  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka;
  20  
  21  import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22  import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23  import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.flink.api.common.typeinfo.TypeInformation;
  26  import org.apache.flink.api.java.tuple.Tuple2;
  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29  import org.apache.flink.streaming.api.datastream.DataStream;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span>
  31  import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer09;
  32  import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkFixedPartitioner;
  33  import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  34  import org.apache.flink.table.api.TableSchema;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
  37  import org.apache.flink.table.sinks.RetractStreamTableSink;
  38  import org.apache.flink.table.sinks.TableSink;
  39  import org.apache.flink.table.utils.TableConnectorUtils;
  40  import org.apache.flink.types.Row;
  41  
  42  import java.util.Optional;
  43  import java.util.Properties;
  44  
  45  /**
  46   * Date: 2018/12/18
  47   * Company: www.dtstack.com
  48   *
  49   * @author DocLi
  50   * @modifyer maqi
  51   */
  52  public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {

  53  
  54  	protected String[] fieldNames;

  55  
  56  	protected TypeInformation&lt;?&gt;[] fieldTypes;

  57  
  58  	protected String topic;

  59  
  60  	protected Properties properties;

  61  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -	protected FlinkKafkaProducer09&lt;Row&gt; kafkaProducer09;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +	protected FlinkKafkaProducer09&lt;CRow&gt; kafkaProducer09;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +	protected CRowTypeInfo typeInformation;</span>
  65  
  66  	/** The schema of the table. */
  67  	private TableSchema schema;


  68  
  69  	/** Partitioner to select Kafka partition for each item. */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -	protected Optional&lt;FlinkKafkaPartitioner&lt;Row&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +	protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;</span>

  72  
  73  	private String[] partitionKeys;

  74  
  75  	protected int parallelism;

  76  

  77  




  78  
  79  	@Override
  80  	public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  81  		KafkaSinkTableInfo kafka09SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  82  		this.topic = kafka09SinkTableInfo.getTopic();





  83  
  84  		properties = new Properties();
  85  		properties.setProperty(&quot;bootstrap.servers&quot;, kafka09SinkTableInfo.getBootstrapServers());
  86  		for (String key : kafka09SinkTableInfo.getKafkaParamKeys()) {
  87  			properties.setProperty(key, kafka09SinkTableInfo.getKafkaParam(key));
  88  		}








  89  
  90  		this.partitioner = Optional.of(new CustomerFlinkPartition&lt;&gt;());
  91  		this.partitionKeys = getPartitionKeys(kafka09SinkTableInfo);
  92  		this.fieldNames = kafka09SinkTableInfo.getFields();
  93  		TypeInformation[] types = new TypeInformation[kafka09SinkTableInfo.getFields().length];
  94  		for (int i = 0; i &lt; kafka09SinkTableInfo.getFieldClasses().length; i++) {
  95  			types[i] = TypeInformation.of(kafka09SinkTableInfo.getFieldClasses()[i]);
  96  		}
  97  		this.fieldTypes = types;
  98  
  99  		TableSchema.Builder schemaBuilder = TableSchema.builder();
 100  		for (int i=0;i&lt;fieldNames.length;i++) {


 101              schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 102          }
 103  		this.schema = schemaBuilder.build();

 104  
 105  		Integer parallelism = kafka09SinkTableInfo.getParallelism();
 106  		if (parallelism != null) {
 107  			this.parallelism = parallelism;
 108  		}




 109  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;Row&gt;) new KafkaProducer09Factory()</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 111 -                .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, partitionKeys);"> 111 -                .createKafkaProducer(kafka09SinkTableInfo, getOutputType().getTypeAt(1), properties, partitioner, ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +		typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +		this.kafkaProducer09 = (FlinkKafkaProducer09&lt;CRow&gt;) new KafkaProducer09Factory()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 114 +                .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partitionKeys);"> 114 +                .createKafkaProducer(kafka09SinkTableInfo, typeInformation, properties, partitioner, partitionKeysðŸ”µ</abbr></span>
 115  		return this;
 116  	}
 117  
 118  	@Override
 119  	public TypeInformation&lt;Row&gt; getRecordType() {
 120  		return new RowTypeInfo(fieldTypes, fieldNames);
 121  	}

 122  
 123  	@Override
 124  	public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -		DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>


















<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                .returns(getOutputType().getTypeAt(1))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -                .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +		DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +				.map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +				.returns(typeInformation)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +				.setParallelism(parallelism);</span>
 133  
 134  		mapDataStream.addSink(kafkaProducer09)
 135                  .name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));
 136  	}


 137  
 138  	@Override
 139  	public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
 140  		return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));
 141  	}

 142  
 143  	@Override
 144  	public String[] getFieldNames() {
 145  		return fieldNames;
 146  	}




 147  
 148  	@Override
 149  	public TypeInformation&lt;?&gt;[] getFieldTypes() {
 150  		return fieldTypes;
 151  	}






 152  
 153  	@Override
 154  	public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
 155  		this.fieldNames = fieldNames;
 156  		this.fieldTypes = fieldTypes;
 157  		return this;
 158  	}




 159  
 160  	private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 161  		if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){
 162  			return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 163  		}
 164  		return null;
 165  	}






 166  
 167  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            