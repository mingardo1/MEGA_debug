<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>387</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    387
                    <a href="386.html">prev</a>
                    <a href="388.html">next</a>
                    <a href="387_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b33108525150e417d003328be87242cc626fe203_rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203^1:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b33108525150e417d003328be87242cc626fe203^2:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b59ef71c4aa3401fd523d61328334a6bac817e1c:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.BaseSideInfo;
  25 import com.dtstack.flink.sql.side.CacheMissVal;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  29 import com.dtstack.flink.sql.util.DateUtil;
  30 import com.google.common.collect.Lists;
  31 import com.google.common.collect.Maps;
  32 import io.vertx.core.json.JsonArray;
  33 import io.vertx.core.json.JsonObject;
  34 import io.vertx.ext.sql.SQLClient;
  35 import io.vertx.ext.sql.SQLConnection;
  36 import org.apache.commons.lang3.StringUtils;
  37 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  38 import org.apache.flink.table.runtime.types.CRow;
  39 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  40 import org.apache.flink.types.Row;
  41 import org.slf4j.Logger;
  42 import org.slf4j.LoggerFactory;
  43 
  44 import java.math.BigDecimal;
  45 import java.sql.Timestamp;
  46 import java.time.Instant;
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.concurrent.CountDownLatch;
  50 import java.util.concurrent.ScheduledFuture;
  51 import java.util.concurrent.atomic.AtomicBoolean;
  52 import java.util.concurrent.atomic.AtomicLong;
  53 
  54 /**
  55  * Date: 2018/11/26
  56  * Company: www.dtstack.com
  57  *
  58  * @author maqi
  59  */
  60 
  61 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  62 
  63     private static final long serialVersionUID = 2098635244857937720L;
  64 
  65     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  66 
  67     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  68 
<abbr title="  69     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  69     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  70 
<abbr title="  71     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  71     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  72 
  73     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  74 
  75     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  76 
  77     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  78 
<abbr title="  79     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  79     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  80 
  81     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  82 
  83     private transient SQLClient rdbSqlClient;
  84 
  85     private final static AtomicBoolean CONN_STATUS = new AtomicBoolean(true);
  86 
  87     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  88         super(sideInfo);
  89         init(sideInfo);
  90     }
  91 
  92     protected void init(BaseSideInfo sideInfo) {
  93         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  94         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  95         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  95         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  96         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  97     }
  98 
  99     @Override
 100 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 106     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 106     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         AtomicLong networkLogCounter = new AtomicLong(0L);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         while (!CONN_STATUS.get()){//network is unhealth</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110             if(networkLogCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                 LOG.info(&quot;network unhealth to block task&quot;);</span>
 112 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133                     try {</span>
 134 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         CRow copyCrow = new CRow(Row.copy(input.row()), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142                 return;</span>
 143 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 144             }
 145             Thread.sleep(100);
 146         }
 147         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 148         rdbSqlClient.getConnection(conn -&gt; {
 149             if(conn.failed()){
 150                 CONN_STATUS.set(false);
 151                 connectWithRetry(params, input, resultFuture, rdbSqlClient);
 152                 return;
 153             }
 154             CONN_STATUS.set(true);
 155             ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 156             cancelTimerWhenComplete(resultFuture, timerFuture);
 157             handleQuery(conn.result(), params, input, resultFuture);
 158         });
 159 
 160     }
 161 
<abbr title=" 162     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 162     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 163         AtomicLong failCounter = new AtomicLong(0);
 164         AtomicBoolean finishFlag = new AtomicBoolean(false);
 165         while(!finishFlag.get()){
 166             CountDownLatch latch = new CountDownLatch(1);
 167             rdbSqlClient.getConnection(conn -&gt; {
 168                 try {
 169                     if(conn.failed()){
 170                         if(failCounter.getAndIncrement() % 1000 == 0){
 171                             LOG.error(&quot;getConnection error&quot;, conn.cause());
 172                         }
 173                         if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getAsyncFailMaxNum(3L)){
 174                             dealFillDataError(input, resultFuture, conn.cause());
 175                             finishFlag.set(true);
 176                         }
 177                         conn.result().close();
 178                         return;
 179                     }
 180                     CONN_STATUS.set(true);
 181                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 182                     cancelTimerWhenComplete(resultFuture, timerFuture);
 183                     handleQuery(conn.result(), inputParams, input, resultFuture);
 184                     finishFlag.set(true);
 185                 } catch (Exception e) {
 186                     dealFillDataError(input, resultFuture, e);
 187                 } finally {
 188                     latch.countDown();
 189                 }
 190             });
 191                         //ä¸»çº¿ç¨‹é˜»å¡ž
 192             try {
 193                 latch.wait();
 194             } catch (InterruptedException e) {
 195                 LOG.error(&quot;&quot;, e);
 196             }
 197         }
 198     }
 199 
 200 
 201     private Object convertDataType(Object val) {
 202         if (val == null) {
 203             // OK
 204         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 205             // OK
 206         } else if (val instanceof Boolean) {
 207             // OK
 208         } else if (val instanceof String) {
 209             // OK
 210         } else if (val instanceof Character) {
 211             // OK
 212         } else if (val instanceof CharSequence) {
 213 
 214         } else if (val instanceof JsonObject) {
 215 
 216         } else if (val instanceof JsonArray) {
 217 
 218         } else if (val instanceof Map) {
 219 
 220         } else if (val instanceof List) {
 221 
 222         } else if (val instanceof byte[]) {
 223 
 224         } else if (val instanceof Instant) {
 225 
 226         } else if (val instanceof Timestamp) {
 227             val = DateUtil.timestampToString((Timestamp) val);
 228         } else if (val instanceof java.util.Date) {
 229             val = DateUtil.dateToString((java.sql.Date) val);
 230         } else {
 231             val = val.toString();
 232         }
 233         return val;
 234 
 235     }
 236 
 237     @Override
 238     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {
 239         return StringUtils.join(inputParam.values(),&quot;_&quot;);
 240     }
 241 
 242     @Override
 243     public Row fillData(Row input, Object line) {
 244         JsonArray jsonArray = (JsonArray) line;
 245         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 246         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 247             Object obj = input.getField(entry.getValue());
<abbr title=" 248             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 248             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 249             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 250                 obj = ((Timestamp) obj).getTime();
 251             }
 252 
 253             row.setField(entry.getKey(), obj);
 254         }
 255 
 256         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 257             if (jsonArray == null) {
 258                 row.setField(entry.getKey(), null);
 259             } else {
 260                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 261                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 262                 row.setField(entry.getKey(), object);
 263             }
 264         }
 265 
 266         return row;
 267     }
 268 
 269 
 270     @Override
 271     public void close() throws Exception {
 272         super.close();
 273         if (rdbSqlClient != null) {
 274             rdbSqlClient.close();
 275         }
 276 
 277     }
 278 
 279     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 280         this.rdbSqlClient = rdbSqlClient;
 281     }
 282 
<abbr title=" 283     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 283     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResulðŸ”µ</abbr>
 284         String key = buildCacheKey(inputParams);
 285         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 286         connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {
 287             if (rs.failed()) {
 288                 dealFillDataError(input, resultFuture, rs.cause());
 289                 return;
 290             }
 291 
 292             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 293 
 294             int resultSize = rs.result().getResults().size();
 295             if (resultSize &gt; 0) {
 296                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 297 
 298                 for (JsonArray line : rs.result().getResults()) {
 299                     Row row = fillData(input.row(), line);
 300                     if (openCache()) {
 301                         cacheContent.add(line);
 302                     }
 303                     rowList.add(new CRow(row, input.change()));
 304                 }
 305 
 306                 if (openCache()) {
 307                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 308                 }
 309 
 310                 resultFuture.complete(rowList);
 311             } else {
 312                 dealMissKey(input, resultFuture);
 313                 if (openCache()) {
 314                     putCache(key, CacheMissVal.getMissKeyObj());
 315                 }
 316             }
 317 
 318             // and close the connection
 319             connection.close(done -&gt; {
 320                 if (done.failed()) {
 321                     throw new RuntimeException(done.cause());
 322                 }
 323             });
 324         });
 325     }
 326 
 327     private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){
 328         Map&lt;String, Object&gt; result = Maps.newHashMap();
 329         inputParam.forEach((k,v) -&gt; {
 330             result.put(k, convertDataType(v));
 331         });
 332         return result;
 333     }
 334 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.BaseSideInfo;
  25 import com.dtstack.flink.sql.side.CacheMissVal;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  29 import com.dtstack.flink.sql.util.DateUtil;
  30 import io.vertx.core.json.JsonArray;
  31 import io.vertx.core.json.JsonObject;
  32 import io.vertx.ext.sql.SQLClient;
  33 import io.vertx.ext.sql.SQLConnection;
  34 import org.apache.commons.lang3.StringUtils;
  35 import com.google.common.collect.Lists;
  36 import com.google.common.collect.Maps;
  37 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  38 import org.apache.flink.table.runtime.types.CRow;
  39 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  40 import org.apache.flink.types.Row;
  41 import org.slf4j.Logger;
  42 import org.slf4j.LoggerFactory;
  43 
  44 import java.math.BigDecimal;
  45 import java.sql.Timestamp;
  46 import java.time.Instant;
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.concurrent.CountDownLatch;
  50 import java.util.concurrent.ScheduledFuture;
  51 import java.util.concurrent.atomic.AtomicBoolean;
  52 import java.util.concurrent.atomic.AtomicLong;
  53 
  54 /**
  55  * Date: 2018/11/26
  56  * Company: www.dtstack.com
  57  *
  58  * @author maqi
  59  */
  60 
  61 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  62 
  63     private static final long serialVersionUID = 2098635244857937720L;
  64 
  65     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  66 
  67     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  68 
<abbr title="  69     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  69     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  70 
<abbr title="  71     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  71     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  72 
  73     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  74 
  75     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  76 
  77     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  78 
<abbr title="  79     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  79     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  80 
  81     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  82 
  83     private transient SQLClient rdbSqlClient;
  84 
  85     private final static AtomicBoolean CONN_STATUS = new AtomicBoolean(true);
  86 
  87     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  88         super(sideInfo);
  89         init(sideInfo);
  90     }
  91 
  92     protected void init(BaseSideInfo sideInfo) {
  93         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  94         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  95         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  95         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  96         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  97     }
  98 
  99     @Override
 100     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){
 101 
 102     }
 103 
 104     @Override
<abbr title=" 105     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 105     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 106 
 107         AtomicLong networkLogCounter = new AtomicLong(0L);
 108         while (!CONN_STATUS.get()){//network is unhealth
 109             if(networkLogCounter.getAndIncrement() % 1000 == 0){
 110                 LOG.info(&quot;network unhealth to block task&quot;);
 111             }
 112             Thread.sleep(100);
 113         }
 114         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 115         rdbSqlClient.getConnection(conn -&gt; {
 116             if(conn.failed()){
 117                 CONN_STATUS.set(false);
 118                 connectWithRetry(params, input, resultFuture, rdbSqlClient);
 119                 return;
 120             }
 121             CONN_STATUS.set(true);
 122             ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 123             cancelTimerWhenComplete(resultFuture, timerFuture);
 124             handleQuery(conn.result(), params, input, resultFuture);
 125         });
 126 
 127     }
 128 
<abbr title=" 129     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 129     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 130         AtomicLong failCounter = new AtomicLong(0);
 131         AtomicBoolean finishFlag = new AtomicBoolean(false);
 132         while(!finishFlag.get()){
 133             CountDownLatch latch = new CountDownLatch(1);
 134             rdbSqlClient.getConnection(conn -&gt; {
 135                 try {
 136                     if(conn.failed()){
 137                         if(failCounter.getAndIncrement() % 1000 == 0){
 138                             LOG.error(&quot;getConnection error&quot;, conn.cause());
 139                         }
 140                         if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getAsyncFailMaxNum(3L)){
 141                             dealFillDataError(input, resultFuture, conn.cause());
 142                             finishFlag.set(true);
 143                         }
 144                         conn.result().close();
 145                         return;
 146                     }
 147                     CONN_STATUS.set(true);
 148                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 149                     cancelTimerWhenComplete(resultFuture, timerFuture);
 150                     handleQuery(conn.result(), inputParams, input, resultFuture);
 151                     finishFlag.set(true);
 152                 } catch (Exception e) {
 153                     dealFillDataError(input, resultFuture, e);
 154                 } finally {
 155                     latch.countDown();
 156                 }
 157             });
 158                         //ä¸»çº¿ç¨‹é˜»å¡ž
 159             try {
 160                 latch.wait();
 161             } catch (InterruptedException e) {
 162                 LOG.error(&quot;&quot;, e);
 163             }
 164         }
 165     }
 166 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 167 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 196                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 196                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         rdbSQLClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             if (conn.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 //Treatment failures</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 if (rs.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                         List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 222                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 222                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                     } catch (Exception e){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                 // and close the connection</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                     if (done.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238             });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240     }</span>
 241 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         CRow copyCrow = new CRow(Row.copy(input.row()), input.change());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 270                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 270                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         rdbSQLClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277             if (conn.failed()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278                 //Treatment failures</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280                 return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                 if (rs.failed()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294                     try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295                         List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 296                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 296                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298                     } catch (Exception e){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306                 // and close the connection</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                     if (done.failed()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311                 });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312             });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     }</span>
 315 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 316 
 317 
 318 
 319     private Object convertDataType(Object val) {
 320         if (val == null) {
 321             // OK
 322         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 323             // OK
 324         } else if (val instanceof Boolean) {
 325             // OK
 326         } else if (val instanceof String) {
 327             // OK
 328         } else if (val instanceof Character) {
 329             // OK
 330         } else if (val instanceof CharSequence) {
 331 
 332         } else if (val instanceof JsonObject) {
 333 
 334         } else if (val instanceof JsonArray) {
 335 
 336         } else if (val instanceof Map) {
 337 
 338         } else if (val instanceof List) {
 339 
 340         } else if (val instanceof byte[]) {
 341 
 342         } else if (val instanceof Instant) {
 343 
 344         } else if (val instanceof Timestamp) {
 345             val = DateUtil.timestampToString((Timestamp) val);
 346         } else if (val instanceof java.util.Date) {
 347             val = DateUtil.dateToString((java.sql.Date) val);
 348         } else {
 349             val = val.toString();
 350         }
 351         return val;
 352 
 353     }
 354 
 355     @Override
 356     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {
 357         return StringUtils.join(inputParam.values(),&quot;_&quot;);
 358     }
 359 
 360     @Override
 361     public Row fillData(Row input, Object line) {
 362         JsonArray jsonArray = (JsonArray) line;
 363         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 364         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 365             Object obj = input.getField(entry.getValue());
<abbr title=" 366             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 366             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 367             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 368                 obj = ((Timestamp) obj).getTime();
 369             }
 370 
 371             row.setField(entry.getKey(), obj);
 372         }
 373 
 374         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 375             if (jsonArray == null) {
 376                 row.setField(entry.getKey(), null);
 377             } else {
 378                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 379                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 380                 row.setField(entry.getKey(), object);
 381             }
 382         }
 383 
 384         return row;
 385     }
 386 
 387 
 388     @Override
 389     public void close() throws Exception {
 390         super.close();
 391         if (rdbSqlClient != null) {
 392             rdbSqlClient.close();
 393         }
 394 
 395     }
 396 
 397     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 398         this.rdbSqlClient = rdbSqlClient;
 399     }
 400 
<abbr title=" 401     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 401     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResulðŸ”µ</abbr>
 402         String key = buildCacheKey(inputParams);
 403         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 404         connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {
 405             if (rs.failed()) {
 406                 dealFillDataError(input, resultFuture, rs.cause());
 407                 return;
 408             }
 409 
 410             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 411 
 412             int resultSize = rs.result().getResults().size();
 413             if (resultSize &gt; 0) {
 414                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 415 
 416                 for (JsonArray line : rs.result().getResults()) {
 417                     Row row = fillData(input.row(), line);
 418                     if (openCache()) {
 419                         cacheContent.add(line);
 420                     }
 421                     rowList.add(new CRow(row, input.change()));
 422                 }
 423 
 424                 if (openCache()) {
 425                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 426                 }
 427 
 428                 resultFuture.complete(rowList);
 429             } else {
 430                 dealMissKey(input, resultFuture);
 431                 if (openCache()) {
 432                     putCache(key, CacheMissVal.getMissKeyObj());
 433                 }
 434             }
 435 
 436             // and close the connection
 437             connection.close(done -&gt; {
 438                 if (done.failed()) {
 439                     throw new RuntimeException(done.cause());
 440                 }
 441             });
 442         });
 443     }
 444 
 445     private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){
 446         Map&lt;String, Object&gt; result = Maps.newHashMap();
 447         inputParam.forEach((k,v) -&gt; {
 448             result.put(k, convertDataType(v));
 449         });
 450         return result;
 451     }
 452 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.rdb.async;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  22 import com.dtstack.flink.sql.side.BaseSideInfo;
  23 import com.dtstack.flink.sql.side.CacheMissVal;
  24 import com.dtstack.flink.sql.side.cache.CacheObj;
  25 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  26 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  27 import com.dtstack.flink.sql.util.DateUtil;
  28 import com.google.common.collect.Lists;
  29 import com.google.common.collect.Maps;
  30 import io.vertx.core.json.JsonArray;
  31 import io.vertx.core.json.JsonObject;
  32 import io.vertx.ext.sql.SQLClient;
  33 import io.vertx.ext.sql.SQLConnection;
  34 import java.math.BigDecimal;
  35 import java.sql.Timestamp;
  36 import java.time.Instant;
  37 import java.util.List;
  38 import java.util.Map;
  39 import java.util.concurrent.CountDownLatch;
  40 import java.util.concurrent.ScheduledFuture;
  41 import java.util.concurrent.atomic.AtomicBoolean;
  42 import java.util.concurrent.atomic.AtomicLong;
  43 import org.apache.commons.lang3.StringUtils;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.table.runtime.types.CRow;
  46 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  47 import org.apache.flink.types.Row;
  48 import org.slf4j.Logger;
  49 import org.slf4j.LoggerFactory;
  50 
  51 
  52 /**
  53  * Date: 2018/11/26
  54  * Company: www.dtstack.com
  55  *
  56  * @author maqi
  57  */
  58 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  59     private static final long serialVersionUID = 2098635244857937720L;
  60 
  61     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  62 
  63     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  64 
<abbr title="  65     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  65     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  66 
<abbr title="  67     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  67     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  68 
  69     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  70 
  71     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  72 
  73     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  74 
<abbr title="  75     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  75     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  76 
  77     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  78 
  79     private transient SQLClient rdbSqlClient;
  80 
  81     private final static AtomicBoolean CONN_STATUS = new AtomicBoolean(true);
  82 
  83     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  84         super(sideInfo);
  85         init(sideInfo);
  86     }
  87 
  88     protected void init(BaseSideInfo sideInfo) {
  89         RdbSideTableInfo rdbSideTableInfo = ((RdbSideTableInfo) (sideInfo.getSideTableInfo()));
  90         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  91         int rdbPoolSize = (rdbSideTableInfo.getAsyncPoolSize() &gt; 0) ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  91         int rdbPoolSize = (rdbSideTableInfo.getAsyncPoolSize() &gt; 0) ? rdbSideTableInfo.getAsyncPoolSize()ðŸ”µ</abbr>
  92         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  93     }
  94 
  95     @Override
  96     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) {
  97     }
  98 
  99     @Override
<abbr title=" 100     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 100     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 101         AtomicLong networkLogCounter = new AtomicLong(0L);
 102         while (!CONN_STATUS.get()) {
 103         //network is unhealth
 104             if ((networkLogCounter.getAndIncrement() % 1000) == 0) {
 105                 LOG.info(&quot;network unhealth to block task&quot;);
 106             }
 107             Thread.sleep(100);
 108         }
 109         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 110         rdbSqlClient.getConnection(( conn) -&gt; {
 111             if (conn.failed()) {
 112                 CONN_STATUS.set(false);
 113                 connectWithRetry(params, input, resultFuture, rdbSqlClient);
 114                 return;
 115             }
 116             CONN_STATUS.set(true);
 117             ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 118             cancelTimerWhenComplete(resultFuture, timerFuture);
 119             handleQuery(conn.result(), params, input, resultFuture);
 120         });
 121     }
 122 
<abbr title=" 123     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 123     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 124         AtomicLong failCounter = new AtomicLong(0);
 125         AtomicBoolean finishFlag = new AtomicBoolean(false);
 126         while (!finishFlag.get()) {
 127             CountDownLatch latch = new CountDownLatch(1);
 128             rdbSqlClient.getConnection(( conn) -&gt; {
 129                 try {
 130                     if (conn.failed()) {
 131                         if ((failCounter.getAndIncrement() % 1000) == 0) {
 132                             LOG.error(&quot;getConnection error&quot;, conn.cause());
 133                         }
 134                         if (failCounter.get() &gt;= sideInfo.getSideTableInfo().getAsyncFailMaxNum(3L)) {
 135                             dealFillDataError(input, resultFuture, conn.cause());
 136                             finishFlag.set(true);
 137                         }
 138                         conn.result().close();
 139                         return;
 140                     }
 141                     CONN_STATUS.set(true);
 142                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 143                     cancelTimerWhenComplete(resultFuture, timerFuture);
 144                     handleQuery(conn.result(), inputParams, input, resultFuture);
 145                     finishFlag.set(true);
 146                 } catch ( e) {
 147                     dealFillDataError(input, resultFuture, e);
 148                 } finally {
 149                     latch.countDown();
 150                 }
 151             });
 152             // ä¸»çº¿ç¨‹é˜»å¡ž
 153             try {
 154                 latch.wait();
 155             } catch (java.lang.InterruptedException e) {
 156                 LOG.error(&quot;&quot;, e);
 157             }
 158         }
 159     }
 160 
 161     private Object convertDataType(Object val) {
 162         if (val == null) {
 163             // OK
 164         } else if ((val instanceof Number) &amp;&amp; (!(val instanceof BigDecimal))) {
 165             // OK
 166         } else if (val instanceof Boolean) {
 167             // OK
 168         } else if (val instanceof String) {
 169             // OK
 170         } else if (val instanceof Character) {
 171             // OK
 172         } else if (val instanceof CharSequence) {
 173         } else if (val instanceof JsonObject) {
 174         } else if (val instanceof JsonArray) {
 175         } else if (val instanceof Map) {
 176         } else if (val instanceof List) {
 177         } else if (val instanceof byte[]) {
 178         } else if (val instanceof Instant) {
 179         } else if (val instanceof Timestamp) {
 180             val = DateUtil.timestampToString(((Timestamp) (val)));
 181         } else if (val instanceof java.util.Date) {
 182             val = DateUtil.dateToString(((java.sql.Date) (val)));
 183         } else {
 184             val = val.toString();
 185         }
 186         return val;
 187     }
 188 
 189     @Override
 190     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {
 191         return StringUtils.join(inputParam.values(), &quot;_&quot;);
 192     }
 193 
 194     @Override
 195     public Row fillData(Row input, Object line) {
 196         JsonArray jsonArray = ((JsonArray) (line));
 197         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 198         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 199             Object obj = input.getField(entry.getValue());
<abbr title=" 200             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 200             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr>
 201             if ((obj instanceof Timestamp) &amp;&amp; isTimeIndicatorTypeInfo) {
 202                 obj = ((Timestamp) (obj)).getTime();
 203             }
 204             row.setField(entry.getKey(), obj);
 205         }
 206         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 207             if (jsonArray == null) {
 208                 row.setField(entry.getKey(), null);
 209             } else {
 210                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 211                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 212                 row.setField(entry.getKey(), object);
 213             }
 214         }
 215         return row;
 216     }
 217 
 218     @Override
 219     public void close() throws Exception {
 220         super.close();
 221         if (rdbSqlClient != null) {
 222             rdbSqlClient.close();
 223         }
 224     }
 225 
 226     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 227         this.rdbSqlClient = rdbSqlClient;
 228     }
 229 
<abbr title=" 230     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) {"> 230     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResulðŸ”µ</abbr>
 231         String key = buildCacheKey(inputParams);
 232         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 233         connection.queryWithParams(sideInfo.getSqlCondition(), params, ( rs) -&gt; {
 234             if (rs.failed()) {
 235                 dealFillDataError(input, resultFuture, rs.cause());
 236                 return;
 237             }
 238             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 239             int resultSize = rs.result().getResults().size();
 240             if (resultSize &gt; 0) {
 241                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 242                 for (JsonArray line : rs.result().getResults()) {
 243                     Row row = fillData(input.row(), line);
 244                     if (openCache()) {
 245                         cacheContent.add(line);
 246                     }
 247                     rowList.add(new CRow(row, input.change()));
 248                 }
 249                 if (openCache()) {
 250                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 251                 }
 252                 resultFuture.complete(rowList);
 253             } else {
 254                 dealMissKey(input, resultFuture);
 255                 if (openCache()) {
 256                     putCache(key, CacheMissVal.getMissKeyObj());
 257                 }
 258             }
 259                 // and close the connection
 260             connection.close(( done) -&gt; {
 261                 if (done.failed()) {
 262                     throw new RuntimeException(done.cause());
 263                 }
 264             });
 265         });
 266     }
 267 
 268     private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam) {
 269         Map&lt;String, Object&gt; result = Maps.newHashMap();
 270         inputParam.forEach(( k, v) -&gt; {
 271             result.put(k, convertDataType(v));
 272         });
 273         return result;
 274     }
 275 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.side.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.BaseSideInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import com.dtstack.flink.sql.side.CacheMissVal;</span>
  27  import com.dtstack.flink.sql.side.cache.CacheObj;
  28  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  30  import com.dtstack.flink.sql.util.DateUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.google.common.collect.Maps;</span>
  33  import io.vertx.core.json.JsonArray;
  34  import io.vertx.core.json.JsonObject;
  35  import io.vertx.ext.sql.SQLClient;
  36  import io.vertx.ext.sql.SQLConnection;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.apache.commons.lang3.StringUtils;</span>
  39  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40  import org.apache.flink.table.runtime.types.CRow;
  41  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42  import org.apache.flink.types.Row;
  43  import org.slf4j.Logger;
  44  import org.slf4j.LoggerFactory;
  45  
  46  import java.math.BigDecimal;
  47  import java.sql.Timestamp;
  48  import java.time.Instant;
  49  import java.util.List;
  50  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import java.util.concurrent.CountDownLatch;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +import java.util.concurrent.ScheduledFuture;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import java.util.concurrent.atomic.AtomicBoolean;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import java.util.concurrent.atomic.AtomicLong;</span>
  55  
  56  /**
  57   * Date: 2018/11/26
  58   * Company: www.dtstack.com
  59   *
  60   * @author maqi
  61   */
  62  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -public class RdbAsyncReqRow extends AsyncReqRow {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +public class RdbAsyncReqRow extends BaseAsyncReqRow {</span>
  65  
  66      private static final long serialVersionUID = 2098635244857937720L;
  67  
  68      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  69  
  70      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  71  
  72      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  73  
<abbr title="  74      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  74      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  75  
  76      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  77  
  78      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  79  
  80      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  81  
<abbr title="  82      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  82      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  83  
  84      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  85  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -    private transient SQLClient rdbSQLClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -    public RdbAsyncReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +    private transient SQLClient rdbSqlClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    private final static AtomicBoolean CONN_STATUS = new AtomicBoolean(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +    public RdbAsyncReqRow(BaseSideInfo sideInfo) {</span>
  94          super(sideInfo);
  95          init(sideInfo);
  96      }
  97  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    protected void init(SideInfo sideInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    protected void init(BaseSideInfo sideInfo) {</span>
 100          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
 101          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title=" 102          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;"> 102          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
 103          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
 104      }
 105  
 106      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        CRow copyCrow = new CRow(input.row(), input.change());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -                dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 119 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 119 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +        AtomicLong networkLogCounter = new AtomicLong(0L);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        while (!CONN_STATUS.get()){//network is unhealth</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +            if(networkLogCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                LOG.info(&quot;network unhealth to block task&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +            Thread.sleep(100);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        Map&lt;String, Object&gt; params = formatInputParam(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            if(conn.failed()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                CONN_STATUS.set(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                connectWithRetry(params, input, resultFuture, rdbSqlClient);</span>
 133                  return;
 134              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                        resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +            CONN_STATUS.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +            cancelTimerWhenComplete(resultFuture, timerFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +            handleQuery(conn.result(), params, input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 159 +    private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 159 +    private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        AtomicLong failCounter = new AtomicLong(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        AtomicBoolean finishFlag = new AtomicBoolean(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        while(!finishFlag.get()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +            CountDownLatch latch = new CountDownLatch(1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +            rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                    if(conn.failed()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                        if(failCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                            LOG.error(&quot;getConnection error&quot;, conn.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                        if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getAsyncFailMaxNum(3L)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                            dealFillDataError(input, resultFuture, conn.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                            finishFlag.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                        conn.result().close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                        return;</span>
 176                      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 178 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 178 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -        rdbSQLClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -            if (conn.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                //Treatment failures</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -            String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                if (rs.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                    LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                    resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -                List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                        dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                        resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                    } catch (Exception e){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                    dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                // and close the connection</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                connection.close(done -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -                    if (done.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -                        throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                    CONN_STATUS.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                    ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                    cancelTimerWhenComplete(resultFuture, timerFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    handleQuery(conn.result(), inputParams, input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    finishFlag.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                    dealFillDataError(input, resultFuture, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    latch.countDown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                }</span>
 230              });
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                        //ä¸»çº¿ç¨‹é˜»å¡ž</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                latch.wait();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +            } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        }</span>
 239      }
 240  
 241  
 242      private Object convertDataType(Object val) {
 243          if (val == null) {
 244              // OK
 245          } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 246              // OK
 247          } else if (val instanceof Boolean) {
 248              // OK
 249          } else if (val instanceof String) {
 250              // OK
 251          } else if (val instanceof Character) {
 252              // OK
 253          } else if (val instanceof CharSequence) {
 254  
 255          } else if (val instanceof JsonObject) {
 256  
 257          } else if (val instanceof JsonArray) {
 258  
 259          } else if (val instanceof Map) {
 260  
 261          } else if (val instanceof List) {
 262  
 263          } else if (val instanceof byte[]) {
 264  
 265          } else if (val instanceof Instant) {
 266  
 267          } else if (val instanceof Timestamp) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -            val = DateUtil.getStringFromTimestamp((Timestamp) val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +            val = DateUtil.timestampToString((Timestamp) val);</span>
 270          } else if (val instanceof java.util.Date) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -            val = DateUtil.getStringFromDate((java.sql.Date) val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +            val = DateUtil.dateToString((java.sql.Date) val);</span>
 273          } else {
 274              val = val.toString();
 275          }
 276          return val;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        for (JsonArray line : results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -            if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                cacheContent.add(line);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -            rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -        return rowList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        return StringUtils.join(inputParam.values(),&quot;_&quot;);</span>
 295      }
 296  
 297      @Override
 298      public Row fillData(Row input, Object line) {
 299          JsonArray jsonArray = (JsonArray) line;
 300          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 301          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 302              Object obj = input.getField(entry.getValue());
<abbr title=" 303              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 303              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 304              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 305                  obj = ((Timestamp) obj).getTime();
 306              }
 307  
 308              row.setField(entry.getKey(), obj);
 309          }
 310  
 311          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 312              if (jsonArray == null) {
 313                  row.setField(entry.getKey(), null);
 314              } else {
 315                  String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 316                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 317                  row.setField(entry.getKey(), object);
 318              }
 319          }
 320  
 321          return row;
 322      }
 323  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +</span>
 325      @Override
 326      public void close() throws Exception {
 327          super.close();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -        if (rdbSQLClient != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -            rdbSQLClient.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -    public String buildCacheKey(JsonArray jsonArray) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -        for (Object ele : jsonArray.getList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -            sb.append(ele.toString())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -    public void setRdbSQLClient(SQLClient rdbSQLClient) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -        this.rdbSQLClient = rdbSQLClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        if (rdbSqlClient != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +            rdbSqlClient.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +    public void setRdbSqlClient(SQLClient rdbSqlClient) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        this.rdbSqlClient = rdbSqlClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 358 +    private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 358 +    private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +            if (rs.failed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +                dealFillDataError(input, resultFuture, rs.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +            List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +            int resultSize = rs.result().getResults().size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +            if (resultSize &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +                List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +                for (JsonArray line : rs.result().getResults()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +                    Row row = fillData(input.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                    if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +                        cacheContent.add(line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +                    rowList.add(new CRow(row, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +                if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +                    putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +                resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +                dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +                if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                    putCache(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +            // and close the connection</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                if (done.failed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                    throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +    private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +        Map&lt;String, Object&gt; result = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        inputParam.forEach((k,v) -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +            result.put(k, convertDataType(v));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +        return result;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +    }</span>
 409  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;
  23  import com.dtstack.flink.sql.side.*;



  24  import com.dtstack.flink.sql.side.cache.CacheObj;
  25  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  26  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  27  import com.dtstack.flink.sql.util.DateUtil;


  28  import io.vertx.core.json.JsonArray;
  29  import io.vertx.core.json.JsonObject;
  30  import io.vertx.ext.sql.SQLClient;
  31  import io.vertx.ext.sql.SQLConnection;
  32  import com.google.common.collect.Lists;

  33  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  34  import org.apache.flink.table.runtime.types.CRow;
  35  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  36  import org.apache.flink.types.Row;
  37  import org.slf4j.Logger;
  38  import org.slf4j.LoggerFactory;
  39  
  40  import java.math.BigDecimal;
  41  import java.sql.Timestamp;
  42  import java.time.Instant;
  43  import java.util.List;
  44  import java.util.Map;




  45  
  46  /**
  47   * Date: 2018/11/26
  48   * Company: www.dtstack.com
  49   *
  50   * @author maqi
  51   */
  52  
  53  public class RdbAsyncReqRow extends AsyncReqRow {

  54  
  55      private static final long serialVersionUID = 2098635244857937720L;
  56  
  57      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  58  
  59      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  60  
  61      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  62  
<abbr title="  63      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  63      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  64  
  65      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  66  
  67      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  68  
  69      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  70  
<abbr title="  71      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  71      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  72  
  73      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  74  
  75      private transient SQLClient rdbSQLClient;
  76  
  77      public RdbAsyncReqRow(SideInfo sideInfo) {





  78          super(sideInfo);
  79          init(sideInfo);
  80      }
  81  
  82      protected void init(SideInfo sideInfo) {

  83          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  84          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  85          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  85          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
  86          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  87      }
  88  
  89      @Override
  90      public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        CRow copyCrow = new CRow(Row.copy(input.row()), input.change());</span>
  93          JsonArray inputParams = new JsonArray();
  94          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
  95              Object equalObj = copyCrow.row().getField(conValIndex);
  96              if (equalObj == null) {
  97                  dealMissKey(copyCrow, resultFuture);



















  98                  return;
  99              }
 100              inputParams.add(convertDataType(equalObj));
 101          }
 102  
 103          String key = buildCacheKey(inputParams);
 104          if (openCache()) {
 105              CacheObj val = getFromCache(key);
 106              if (val != null) {
 107                  if (ECacheContentType.MissVal == val.getType()) {
 108                      dealMissKey(copyCrow, resultFuture);
 109                      return;
 110                  } else if (ECacheContentType.MultiLine == val.getType()) {
 111                      try {
 112                          List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());
 113                          resultFuture.complete(rowList);
 114                      } catch (Exception e) {
 115                          dealFillDataError(resultFuture, e, copyCrow);

























 116                      }
 117                  } else {
<abbr title=" 118                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 118                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr>
 119                  }
 120                  return;
 121              }
 122          }
 123  
 124          rdbSQLClient.getConnection(conn -&gt; {
 125              if (conn.failed()) {
 126                  //Treatment failures
 127                  resultFuture.completeExceptionally(conn.cause());
 128                  return;
 129              }
 130  
 131              final SQLConnection connection = conn.result();
 132              String sqlCondition = sideInfo.getSqlCondition();
 133              connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 134                  if (rs.failed()) {
 135                      LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 136                      resultFuture.completeExceptionally(rs.cause());
 137                      return;
 138                  }
 139                  List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 140                  List&lt;JsonArray&gt; results = rs.result().getResults();
 141                  if (results.size() &gt; 0) {
 142                      try {
 143                          List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);
 144                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 145                          resultFuture.complete(rowList);
 146                      } catch (Exception e){
 147                          dealFillDataError(resultFuture, e, copyCrow);
 148                      }
 149                  } else {
 150                      dealMissKey(copyCrow, resultFuture);
 151                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 152                  }
 153  
 154                  // and close the connection
 155                  connection.close(done -&gt; {
 156                      if (done.failed()) {
 157                          throw new RuntimeException(done.cause());
 158                      }
 159                  });










 160              });
 161          });







 162      }
 163  
 164  
 165      private Object convertDataType(Object val) {
 166          if (val == null) {
 167              // OK
 168          } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 169              // OK
 170          } else if (val instanceof Boolean) {
 171              // OK
 172          } else if (val instanceof String) {
 173              // OK
 174          } else if (val instanceof Character) {
 175              // OK
 176          } else if (val instanceof CharSequence) {
 177  
 178          } else if (val instanceof JsonObject) {
 179  
 180          } else if (val instanceof JsonArray) {
 181  
 182          } else if (val instanceof Map) {
 183  
 184          } else if (val instanceof List) {
 185  
 186          } else if (val instanceof byte[]) {
 187  
 188          } else if (val instanceof Instant) {
 189  
 190          } else if (val instanceof Timestamp) {
 191              val = DateUtil.getStringFromTimestamp((Timestamp) val);

 192          } else if (val instanceof java.util.Date) {
 193              val = DateUtil.getStringFromDate((java.sql.Date) val);

 194          } else {
 195              val = val.toString();
 196          }
 197          return val;
 198      }
 199  
 200      protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {
 201          List&lt;CRow&gt; rowList = Lists.newArrayList();
 202          for (JsonArray line : results) {
 203              Row row = fillData(inputRow.row(), line);
 204              if (null != cacheContent &amp;&amp; openCache()) {
 205                  cacheContent.add(line);
 206              }
 207              rowList.add(new CRow(row, inputRow.change()));
 208          }
 209          return rowList;






 210      }
 211  
 212      @Override
 213      public Row fillData(Row input, Object line) {
 214          JsonArray jsonArray = (JsonArray) line;
 215          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 216          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 217              Object obj = input.getField(entry.getValue());
<abbr title=" 218              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 218              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 219              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 220                  obj = ((Timestamp) obj).getTime();
 221              }
 222  
 223              row.setField(entry.getKey(), obj);
 224          }
 225  
 226          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 227              if (jsonArray == null) {
 228                  row.setField(entry.getKey(), null);
 229              } else {
 230                  String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 231                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 232                  row.setField(entry.getKey(), object);
 233              }
 234          }
 235  
 236          return row;
 237      }
 238  

 239      @Override
 240      public void close() throws Exception {
 241          super.close();
 242          if (rdbSQLClient != null) {
 243              rdbSQLClient.close();
 244          }
 245  
 246      }
 247  
 248      public String buildCacheKey(JsonArray jsonArray) {
 249          StringBuilder sb = new StringBuilder();
 250          for (Object ele : jsonArray.getList()) {
 251              sb.append(ele.toString())
 252                      .append(&quot;_&quot;);
 253          }
 254  
 255          return sb.toString();
 256      }
 257  
 258      public void setRdbSQLClient(SQLClient rdbSQLClient) {
 259          this.rdbSQLClient = rdbSQLClient;
 260      }
 261  





























































 262  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            