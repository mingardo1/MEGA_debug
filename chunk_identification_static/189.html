<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>189</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    189
                    <a href="188.html">prev</a>
                    <a href="190.html">next</a>
                    <a href="189_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_692aea06e8e2a934cbc3b09e2c86512228ca614b_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/util/service/ResourcePurgeServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;692aea06e8e2a934cbc3b09e2c86512228ca614b:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/util/service/ResourcePurgeServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;692aea06e8e2a934cbc3b09e2c86512228ca614b^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/util/service/ResourcePurgeServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;692aea06e8e2a934cbc3b09e2c86512228ca614b^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/util/service/ResourcePurgeServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;750f8f9bf103dbaee3d988a7c3332eba9d3b9933:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/util/service/ResourcePurgeServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b]], subset: [[b], [b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-392708096265613810" onmouseenter="enter('-392708096265613810');" onmouseout="out('-392708096265613810');" style="">  18 package org.broadleafcommerce.core.util.service;                                                         </span>
<span  style="">  19                                                                                                          </span>
<span class="4020017653195254006" onmouseenter="enter('4020017653195254006');" onmouseout="out('4020017653195254006');" style="">  20 import org.apache.commons.collections.MapUtils;                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="7132038483204039493" onmouseenter="enter('7132038483204039493');" onmouseout="out('7132038483204039493');" style="">  24 import org.broadleafcommerce.common.notification.service.NotificationDispatcher;                         </span>
<span class="-840358981756149848" onmouseenter="enter('-840358981756149848');" onmouseout="out('-840358981756149848');" style="">  25 import org.broadleafcommerce.common.notification.service.type.EmailNotification;                         </span>
<span class="-7956607451590208760" onmouseenter="enter('-7956607451590208760');" onmouseout="out('-7956607451590208760');" style="">  26 import org.broadleafcommerce.common.notification.service.type.NotificationEventType;                     </span>
<span class="1373992879208813777" onmouseenter="enter('1373992879208813777');" onmouseout="out('1373992879208813777');" style="">  27 import org.broadleafcommerce.common.time.SystemTime;                                                     </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  28 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  29 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-9126455085472227806" onmouseenter="enter('-9126455085472227806');" onmouseout="out('-9126455085472227806');" style="">  30 import org.broadleafcommerce.core.order.domain.OrderImpl;                                                </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  31 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="">  33 import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                             </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="">  34 import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                              </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="">  35 import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                          </span>
<span class="8877081811676575024" onmouseenter="enter('8877081811676575024');" onmouseout="out('8877081811676575024');" style="">  36 import org.broadleafcommerce.core.util.service.type.PurgeOrderHistoryVariableNames;                      </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  37 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="">  38 import org.broadleafcommerce.profile.core.service.CustomerService;                                       </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  39 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  42 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                             </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                              </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                          </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import org.broadleafcommerce.profile.core.service.CustomerService;                                       </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import org.springframework.stereotype.Service;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.springframework.transaction.TransactionStatus;                                                </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 /**                                                                                                      </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  57 =======                                                                                                  </span>
<span class="-1504015732959009083" onmouseenter="enter('-1504015732959009083');" onmouseout="out('-1504015732959009083');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import org.hibernate.Session;                                                                            </span>
<span class="1031102842064240387" onmouseenter="enter('1031102842064240387');" onmouseout="out('1031102842064240387');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import org.hibernate.jdbc.Work;                                                                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 import org.springframework.core.env.Environment;                                                         </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  62 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  63 import org.springframework.stereotype.Service;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  64 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  65 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  66 import org.springframework.transaction.TransactionStatus;                                                </span>
<span  style="">  67                                                                                                          </span>
<span class="-7136330293413175449" onmouseenter="enter('-7136330293413175449');" onmouseout="out('-7136330293413175449');" style="">  68 import java.sql.Connection;                                                                              </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  69 import java.sql.SQLException;                                                                            </span>
<span class="6402527026259660908" onmouseenter="enter('6402527026259660908');" onmouseout="out('6402527026259660908');" style="">  70 import java.sql.Statement;                                                                               </span>
<span class="196713859697444637" onmouseenter="enter('196713859697444637');" onmouseout="out('196713859697444637');" style="">  71 import java.util.*;                                                                                      </span>
<span  style="">  72                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  73 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  74 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  75 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  76                                                                                                          </span>
<span  style="">  77                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  78 /**                                                                                                      </span>
<span class="-3191869593089593640" onmouseenter="enter('-3191869593089593640');" onmouseout="out('-3191869593089593640');" style=""><abbr title="  79  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous Customers).">  79  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymoðŸ”µ</abbr></span>
<span class="832835515286180797" onmouseenter="enter('832835515286180797');" onmouseout="out('832835515286180797');" style="">  80  * {@link ResourcePurgeService} for additional API documentation.                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  81  * &lt;p/&gt;                                                                                                  </span>
<span class="-315394129855994292" onmouseenter="enter('-315394129855994292');" onmouseout="out('-315394129855994292');" style="">  82  * A basic Quartz scheduled job configuration for calling this service can be configured as follows:     </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  83  * &lt;p/&gt;                                                                                                  </span>
<span class="-131984816008333551" onmouseenter="enter('-131984816008333551');" onmouseout="out('-131984816008333551');" style="">  84  * {@code                                                                                                </span>
<span class="8079836627557216097" onmouseenter="enter('8079836627557216097');" onmouseout="out('8079836627557216097');" style="">  85  * &lt;bean id=&quot;purgeCartConfig&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;           </span>
<span class="8809411245832543538" onmouseenter="enter('8809411245832543538');" onmouseout="out('8809411245832543538');" style="">  86  * &lt;property name=&quot;sourceMap&quot;&gt;                                                                           </span>
<span class="-4290418952995175850" onmouseenter="enter('-4290418952995175850');" onmouseout="out('-4290418952995175850');" style="">  87  * &lt;map&gt;                                                                                                 </span>
<span class="5370217760353547455" onmouseenter="enter('5370217760353547455');" onmouseout="out('5370217760353547455');" style="">  88  * &lt;entry key=&quot;SECONDS_OLD&quot; value=&quot;2592000&quot;/&gt;                                                            </span>
<span class="-1857330153031469850" onmouseenter="enter('-1857330153031469850');" onmouseout="out('-1857330153031469850');" style="">  89  * &lt;entry key=&quot;STATUS&quot; value=&quot;IN_PROCESS&quot;/&gt;                                                              </span>
<span class="-1596267147682690356" onmouseenter="enter('-1596267147682690356');" onmouseout="out('-1596267147682690356');" style="">  90  * &lt;/map&gt;                                                                                                </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  91  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  92  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  93  * &lt;p/&gt;                                                                                                  </span>
<span class="5857689149403140530" onmouseenter="enter('5857689149403140530');" onmouseout="out('5857689149403140530');" style=""><abbr title="  94  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;">  94  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactðŸ”µ</abbr></span>
<span class="-390919979070777656" onmouseenter="enter('-390919979070777656');" onmouseout="out('-390919979070777656');" style="">  95  * &lt;property name=&quot;targetObject&quot; ref=&quot;blResourcePurgeService&quot; /&gt;                                         </span>
<span class="-1711168238872066589" onmouseenter="enter('-1711168238872066589');" onmouseout="out('-1711168238872066589');" style="">  96  * &lt;property name=&quot;targetMethod&quot; value=&quot;purgeCarts&quot; /&gt;                                                   </span>
<span class="4875414778543091051" onmouseenter="enter('4875414778543091051');" onmouseout="out('4875414778543091051');" style="">  97  * &lt;property name=&quot;arguments&quot;&gt;                                                                           </span>
<span class="6000473589228105200" onmouseenter="enter('6000473589228105200');" onmouseout="out('6000473589228105200');" style="">  98  * &lt;list&gt;                                                                                                </span>
<span class="-1321283090282055520" onmouseenter="enter('-1321283090282055520');" onmouseout="out('-1321283090282055520');" style="">  99  * &lt;ref bean=&quot;purgeCartConfig&quot;/&gt;                                                                         </span>
<span class="2486531046171828364" onmouseenter="enter('2486531046171828364');" onmouseout="out('2486531046171828364');" style=""> 100  * &lt;/list&gt;                                                                                               </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style=""> 101  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style=""> 102  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style=""> 103  * &lt;p/&gt;                                                                                                  </span>
<span class="-7915154528943636028" onmouseenter="enter('-7915154528943636028');" onmouseout="out('-7915154528943636028');" style=""> 104  * &lt;bean id=&quot;purgeCartTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;   </span>
<span class="5235847799914996571" onmouseenter="enter('5235847799914996571');" onmouseout="out('5235847799914996571');" style=""> 105  * &lt;property name=&quot;jobDetail&quot; ref=&quot;purgeCartJobDetail&quot; /&gt;                                                </span>
<span class="-1206739829467768833" onmouseenter="enter('-1206739829467768833');" onmouseout="out('-1206739829467768833');" style=""> 106  * &lt;property name=&quot;startDelay&quot; value=&quot;30000&quot; /&gt;                                                          </span>
<span class="-7327795866109106158" onmouseenter="enter('-7327795866109106158');" onmouseout="out('-7327795866109106158');" style=""> 107  * &lt;property name=&quot;repeatInterval&quot; value=&quot;86400000&quot; /&gt;                                                   </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style=""> 108  * &lt;/bean&gt;                                                                                               </span>
<span class="8941010846014250828" onmouseenter="enter('8941010846014250828');" onmouseout="out('8941010846014250828');" style=""> 109  * }                                                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 110  *                                                                                                       </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style=""> 111  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 112  */                                                                                                      </span>
<span class="-5822344749670970380" onmouseenter="enter('-5822344749670970380');" onmouseout="out('-5822344749670970380');" style=""> 113 @Service(&quot;blResourcePurgeService&quot;)                                                                       </span>
<span class="873248027020485265" onmouseenter="enter('873248027020485265');" onmouseout="out('873248027020485265');" style=""> 114 public class ResourcePurgeServiceImpl implements ResourcePurgeService {                                  </span>
<span  style=""> 115                                                                                                          </span>
<span class="-6373274908004434475" onmouseenter="enter('-6373274908004434475');" onmouseout="out('-6373274908004434475');" style=""> 116     private static final Log LOG = LogFactory.getLog(ResourcePurgeServiceImpl.class);                    </span>
<span  style=""> 117                                                                                                          </span>
<span class="149979258544894255" onmouseenter="enter('149979258544894255');" onmouseout="out('149979258544894255');" style=""> 118     private static final Long BATCH_SIZE = 50L;                                                          </span>
<span class="-4253097523145751645" onmouseenter="enter('-4253097523145751645');" onmouseout="out('-4253097523145751645');" style=""><abbr title=" 119     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48 HOURS"> 119     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48ðŸ”µ</abbr></span>
<span  style=""> 120                                                                                                          </span>
<span class="8526754740985159609" onmouseenter="enter('8526754740985159609');" onmouseout="out('8526754740985159609');" style=""> 121     protected PurgeErrorCache customerPurgeErrors = new PurgeErrorCache();                               </span>
<span class="4108358954087572821" onmouseenter="enter('4108358954087572821');" onmouseout="out('4108358954087572821');" style=""> 122     protected PurgeErrorCache historyPurgeErrors = new PurgeErrorCache();                                </span>
<span class="7366515115260261905" onmouseenter="enter('7366515115260261905');" onmouseout="out('7366515115260261905');" style=""> 123     protected PurgeErrorCache cartPurgeErrors = new PurgeErrorCache();                                   </span>
<span  style=""> 124                                                                                                          </span>
<span class="-2629969533830190342" onmouseenter="enter('-2629969533830190342');" onmouseout="out('-2629969533830190342');" style=""> 125     @Resource(name = &quot;blTransactionManager&quot;)                                                             </span>
<span class="-8090157640080505156" onmouseenter="enter('-8090157640080505156');" onmouseout="out('-8090157640080505156');" style=""> 126     protected PlatformTransactionManager transactionManager;                                             </span>
<span  style=""> 127                                                                                                          </span>
<span class="-2129959487514464786" onmouseenter="enter('-2129959487514464786');" onmouseout="out('-2129959487514464786');" style=""> 128     @Resource(name = &quot;blResourcePurgeDao&quot;)                                                               </span>
<span class="1336580446360306350" onmouseenter="enter('1336580446360306350');" onmouseout="out('1336580446360306350');" style=""> 129     protected ResourcePurgeDao resourcePurgeDao;                                                         </span>
<span  style=""> 130                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 131     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 132     protected OrderService orderService;                                                                 </span>
<span  style=""> 133                                                                                                          </span>
<span class="6969754559269026560" onmouseenter="enter('6969754559269026560');" onmouseout="out('6969754559269026560');" style=""> 134     @Resource(name = &quot;blCustomerService&quot;)                                                                </span>
<span class="5369585293672379772" onmouseenter="enter('5369585293672379772');" onmouseout="out('5369585293672379772');" style=""> 135     protected CustomerService customerService;                                                           </span>
<span  style=""> 136                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 137 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138     @Autowired                                                                                           </span>
<span class="-772913752442459972" onmouseenter="enter('-772913752442459972');" onmouseout="out('-772913752442459972');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     @Qualifier(&quot;blNotificationDispatcher&quot;)                                                               </span>
<span class="-1953064040931552296" onmouseenter="enter('-1953064040931552296');" onmouseout="out('-1953064040931552296');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     protected NotificationDispatcher notificationDispatcher;                                             </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 141 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 142             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; +"> 142             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration proviðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="-6288858101655041374" onmouseenter="enter('-6288858101655041374');" onmouseout="out('-6288858101655041374');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         synchronized(cartPurgeErrors) {                                                                  </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                              </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 149             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();"> 149             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue(ðŸ”µ</abbr></span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 150             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));"> 150             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCarðŸ”µ</abbr></span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             for (Order cart : carts) {                                                                   </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,              </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154                 try {                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 155 =======                                                                                                  </span>
<span class="695241785881102503" onmouseenter="enter('695241785881102503');" onmouseout="out('695241785881102503');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156     @Resource(name = &quot;blDeleteStatementGenerator&quot;)                                                       </span>
<span class="-7581585138447328467" onmouseenter="enter('-7581585138447328467');" onmouseout="out('-7581585138447328467');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157     protected DeleteStatementGenerator deleteStatementGenerator;                                         </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160     protected Environment env;                                                                           </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161                                                                                                          </span>
<span class="5710637357667853932" onmouseenter="enter('5710637357667853932');" onmouseout="out('5710637357667853932');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162     @PersistenceContext(unitName = &quot;blPU&quot;)                                                               </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163     protected EntityManager em;                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                                                                                                          </span>
<span class="-3119890949520834785" onmouseenter="enter('-3119890949520834785');" onmouseout="out('-3119890949520834785');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165     @Resource(name = &quot;blResourcePurgeExtensionManager&quot;)                                                  </span>
<span class="8180782340617912300" onmouseenter="enter('8180782340617912300');" onmouseout="out('8180782340617912300');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     protected ResourcePurgeExtensionManager extensionManager;                                            </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 167 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style=""> 168                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 169     @Override                                                                                            </span>
<span class="4309385457274814832" onmouseenter="enter('4309385457274814832');" onmouseout="out('4309385457274814832');" style=""> 170     public void purgeCarts(final Map&lt;String, String&gt; config) {                                           </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 171         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="5550302810575666152" onmouseenter="enter('5550302810575666152');" onmouseout="out('5550302810575666152');" style=""> 172             LOG.debug(&quot;Purging carts&quot;);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 174         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style=""><abbr title=" 175             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; +"> 175             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration proviðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 176                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 178         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 179         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="2493213668953797556" onmouseenter="enter('2493213668953797556');" onmouseout="out('2493213668953797556');" style=""> 180         synchronized (cartPurgeErrors) {                                                                 </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 181             Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                              </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style=""><abbr title=" 182             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();"> 182             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue(ðŸ”µ</abbr></span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style=""><abbr title=" 183             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));"> 183             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCarðŸ”µ</abbr></span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 184             for (Order cart : carts) {                                                                   </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 185                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,              </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 186                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 187                 try {                                                                                    </span>
<span class="4510796021165287410" onmouseenter="enter('4510796021165287410');" onmouseout="out('4510796021165287410');" style=""> 188                     deleteCart(cart);                                                                    </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 189                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 190                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 191                 } catch (Exception e) {                                                                  </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style=""> 192                     if (!status.isCompleted()) {                                                         </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 193                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194                     }                                                                                    </span>
<span class="5109618921839591834" onmouseenter="enter('5109618921839591834');" onmouseout="out('5109618921839591834');" style=""> 195                     LOG.error(String.format(&quot;Not able to purge Cart ID: %d&quot;, cart.getId()), e);          </span>
<span class="-4853598595361674600" onmouseenter="enter('-4853598595361674600');" onmouseout="out('-4853598595361674600');" style=""> 196                     cartPurgeErrors.add(cart.getId());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199         }                                                                                                </span>
<span class="7794934293570296678" onmouseenter="enter('7794934293570296678');" onmouseout="out('7794934293570296678');" style=""><abbr title=" 200         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, cartPurgeErrors.size()));"> 200         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d faðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201     }                                                                                                    </span>
<span  style=""> 202                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 203     @Override                                                                                            </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 204 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-3155325957841664585" onmouseenter="enter('-3155325957841664585');" onmouseout="out('-3155325957841664585');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205     public void notifyCarts(final Map&lt;String, String&gt; config) {                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-3286686306843613123" onmouseenter="enter('-3286686306843613123');" onmouseout="out('-3286686306843613123');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207             LOG.debug(&quot;Notifying carts of purge&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="2705292744574863925" onmouseenter="enter('2705292744574863925');" onmouseout="out('2705292744574863925');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 210             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuration provided. &quot; +"> 210             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuraðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="8814839157010793891" onmouseenter="enter('8814839157010793891');" onmouseout="out('8814839157010793891');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         int batchCount = 0;                                                                              </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                  </span>
<span class="2835180694455823862" onmouseenter="enter('2835180694455823862');" onmouseout="out('2835180694455823862');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;&gt;(failedCartIds)).intValue();      </span>
<span class="-5922847017937203398" onmouseenter="enter('-5922847017937203398');" onmouseout="out('-5922847017937203398');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217         List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;&gt;(failedCartIds)); </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         for (Order cart : carts) {                                                                       </span>
<span class="2587782700097468426" onmouseenter="enter('2587782700097468426');" onmouseout="out('2587782700097468426');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             notifyCart(cart);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221     }                                                                                                    </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 222 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="7229609060981046917" onmouseenter="enter('7229609060981046917');" onmouseout="out('7229609060981046917');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223         synchronized(customerPurgeErrors) {                                                              </span>
<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                      </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 225             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 225             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).iðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 226             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 226             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;LongðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227             for (Customer customer : customers) {                                                        </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,          </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                 try {                                                                                    </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                     deleteCustomer(customer);                                                            </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                 } catch (Exception e) {                                                                  </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235                     if (! status.isCompleted()) {                                                        </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237                     }                                                                                    </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                     LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);  </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                     customerPurgeErrors.add(customer.getId());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242         }                                                                                                </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 243         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 243         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246     /**                                                                                                  </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 247      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 247      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  ExpðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248      *                                                                                                   </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249      * @param purgeParams configured parameters for the cart purge process                               </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250      * @return set of cart ids to ignore/exclude from the next purge run                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251      */                                                                                                  </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252     protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                           </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254         Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);         </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255         return ignoreFailedCartIds;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 259      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 259      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260      *                                                                                                   </span>
<span class="-1716018750408229582" onmouseenter="enter('-1716018750408229582');" onmouseout="out('-1716018750408229582');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261      * @param purgeParams configured parameters for the Cart purge process                               </span>
<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262      * @param cartsInError list of cart ids to be ignored/excluded from the query                        </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263      * @return list of carts to delete                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264      */                                                                                                  </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 265     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 265     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;LonðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 270         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 270         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273     /**                                                                                                  </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 274      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 274      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275      *                                                                                                   </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276      * @param purgeParams configured parameters for the Customer purge process used in the query         </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277      * @param cartsInError list of cart ids to ignore/exclude from the next purge run                    </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278      * @return count of carts to delete                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279      */                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280     /**                                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282      */                                                                                                  </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {         </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         Long cartBatchSize = purgeParams.getBatchSize();                                                 </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 289         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 289         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThresholdðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290         //return the lesser of the parameter batch size of the count of the orders to purge              </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 295      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 295      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296      *                                                                                                   </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 297 =======                                                                                                  </span>
<span class="-1802669755772945786" onmouseenter="enter('-1802669755772945786');" onmouseout="out('-1802669755772945786');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 298     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; depends, final Map&lt;String, Integer&gt; config) {"> 298     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStateðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299                                                                                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-8653909733810486694" onmouseenter="enter('-8653909733810486694');" onmouseout="out('-8653909733810486694');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             LOG.debug(&quot;Purging historical orders&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302         }                                                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                                                                                                          </span>
<span class="-3654204218851766889" onmouseenter="enter('-3654204218851766889');" onmouseout="out('-3654204218851766889');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304         String enablePurge = env.getProperty(&quot;enable.purge.order.history&quot;);                              </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305                                                                                                          </span>
<span class="-6307477278678171490" onmouseenter="enter('-6307477278678171490');" onmouseout="out('-6307477278678171490');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         if (!Boolean.parseBoolean(enablePurge)) {                                                        </span>
<span class="-3484703522134094040" onmouseenter="enter('-3484703522134094040');" onmouseout="out('-3484703522134094040');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 307             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.history to true.&quot;);"> 307             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.hisðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309         }                                                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                                                                                                          </span>
<span class="-2659324279400027158" onmouseenter="enter('-2659324279400027158');" onmouseout="out('-2659324279400027158');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311         Integer daysCount = config.get(PurgeOrderHistoryVariableNames.OLDER_THAN_DAYS.toString());       </span>
<span class="8879960017039434329" onmouseenter="enter('8879960017039434329');" onmouseout="out('8879960017039434329');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312         Integer batchSize = config.get(PurgeOrderHistoryVariableNames.BATCH_SIZE.toString());            </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313                                                                                                          </span>
<span class="2743860540483018997" onmouseenter="enter('2743860540483018997');" onmouseout="out('2743860540483018997');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         List&lt;Order&gt; oldOrders = orderService.findOrdersByDaysCount(daysCount, batchSize);                </span>
<span class="8291766046289306970" onmouseenter="enter('8291766046289306970');" onmouseout="out('8291766046289306970');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends);"> 315         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends)ðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316                                                                                                          </span>
<span class="-4732634170977321510" onmouseenter="enter('-4732634170977321510');" onmouseout="out('-4732634170977321510');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         List&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderDependencies = new ArrayList&lt;&gt;();            </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318                                                                                                          </span>
<span class="8048050619804607819" onmouseenter="enter('8048050619804607819');" onmouseout="out('8048050619804607819');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 319         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, &quot;ORDER_ID&quot;));"> 319         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, ðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                                                                                                          </span>
<span class="7928252889655920702" onmouseenter="enter('7928252889655920702');" onmouseout="out('7928252889655920702');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         dependencies.put(&quot;BLC_ORDER&quot;, orderDependencies);                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                                                                                                          </span>
<span class="1355272824006853176" onmouseenter="enter('1355272824006853176');" onmouseout="out('1355272824006853176');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         ArrayList&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderItemDependencies = new ArrayList&lt;&gt;();   </span>
<span class="6007887936589274996" onmouseenter="enter('6007887936589274996');" onmouseout="out('6007887936589274996');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 324         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, &quot;ORDER_MULTISHIP_OPTION_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 324         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, ðŸ”µ</abbr></span>
<span class="8628014233398989009" onmouseenter="enter('8628014233398989009');" onmouseout="out('8628014233398989009');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 325         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORDER_ITEM_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 325         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORðŸ”µ</abbr></span>
<span class="-4082949278907558346" onmouseenter="enter('-4082949278907558346');" onmouseout="out('-4082949278907558346');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         dependencies.put(&quot;BLC_ORDER_ITEM&quot;, orderItemDependencies);                                       </span>
<span class="-7586552207458707428" onmouseenter="enter('-7586552207458707428');" onmouseout="out('-7586552207458707428');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 327         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_PAYMENT_LOG&quot;, &quot;ORDER_PAYMENT_ID&quot;, &quot;ORDER_PAYMENT_ID&quot;)));"> 327         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.ðŸ”µ</abbr></span>
<span class="6578497182871896533" onmouseenter="enter('6578497182871896533');" onmouseout="out('6578497182871896533');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         extensionManager.getProxy().addPurgeDependencies(dependencies);                                  </span>
<span class="4830318402684525340" onmouseenter="enter('4830318402684525340');" onmouseout="out('4830318402684525340');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         Set&lt;String&gt; exclusions = new HashSet&lt;&gt;();                                                        </span>
<span class="-4430846773603202851" onmouseenter="enter('-4430846773603202851');" onmouseout="out('-4430846773603202851');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330         exclusions.add(&quot;BLC_ADMIN_USER&quot;);                                                                </span>
<span class="34011160929975445" onmouseenter="enter('34011160929975445');" onmouseout="out('34011160929975445');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331         extensionManager.getProxy().addPurgeExclusions(exclusions);                                      </span>
<span class="4783797439534498468" onmouseenter="enter('4783797439534498468');" onmouseout="out('4783797439534498468');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 332         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrderImpl.class, &quot;?&quot;, dependencies, exclusions);"> 332         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrðŸ”µ</abbr></span>
<span class="3783061397625598902" onmouseenter="enter('3783061397625598902');" onmouseout="out('3783061397625598902');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         for (Order order : oldOrders) {                                                                  </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334             TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                  </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335                     TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336             try {                                                                                        </span>
<span class="-8448685700561076869" onmouseenter="enter('-8448685700561076869');" onmouseout="out('-8448685700561076869');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337                 em.unwrap(Session.class).doWork(new Work() {                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338                     @Override                                                                            </span>
<span class="-4124393681745953188" onmouseenter="enter('-4124393681745953188');" onmouseout="out('-4124393681745953188');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339                     public void execute(Connection connection) throws SQLException {                     </span>
<span class="-7878705497542337751" onmouseenter="enter('-7878705497542337751');" onmouseout="out('-7878705497542337751');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340                         Statement statement = connection.createStatement();                              </span>
<span class="-3449158197612158484" onmouseenter="enter('-3449158197612158484');" onmouseout="out('-3449158197612158484');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341                         for (String value : deleteStatement.values()) {                                  </span>
<span class="-4055740799466096202" onmouseenter="enter('-4055740799466096202');" onmouseout="out('-4055740799466096202');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                             String sql = value.replace(&quot;?&quot;, String.valueOf(order.getId()));              </span>
<span class="5121719000459724566" onmouseenter="enter('5121719000459724566');" onmouseout="out('5121719000459724566');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                             LOG.debug(sql);                                                              </span>
<span class="5795758955073093328" onmouseenter="enter('5795758955073093328');" onmouseout="out('5795758955073093328');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344                             statement.addBatch(sql);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345                         }                                                                                </span>
<span class="2322675505205288495" onmouseenter="enter('2322675505205288495');" onmouseout="out('2322675505205288495');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346                         extensionManager.getProxy().addPurgeStatements(statement, rootTypeIdValue);      </span>
<span class="-1332092965431964598" onmouseenter="enter('-1332092965431964598');" onmouseout="out('-1332092965431964598');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347                         statement.executeBatch();                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348                     }                                                                                    </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349                 });                                                                                      </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350                 TransactionUtils.finalizeTransaction(status, transactionManager, false);                 </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351             } catch (Exception e) {                                                                      </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352                 if (!status.isCompleted()) {                                                             </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353                     TransactionUtils.finalizeTransaction(status, transactionManager, true);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354                 }                                                                                        </span>
<span class="5843261671853400812" onmouseenter="enter('5843261671853400812');" onmouseout="out('5843261671853400812');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355                 LOG.error(String.format(&quot;Not able to purge Order ID: %d&quot;, order.getId()), e);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357         }                                                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358                                                                                                          </span>
<span class="-1073654053478996749" onmouseenter="enter('-1073654053478996749');" onmouseout="out('-1073654053478996749');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359         LOG.info(&quot;Finished purging historical orders.&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361                                                                                                          </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 362 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style=""> 363                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 364     @Override                                                                                            </span>
<span class="4447368119484600014" onmouseenter="enter('4447368119484600014');" onmouseout="out('4447368119484600014');" style=""> 365     public void purgeCustomers(final Map&lt;String, String&gt; config) {                                       </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 366         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="1532316588592469018" onmouseenter="enter('1532316588592469018');" onmouseout="out('1532316588592469018');" style=""> 367             LOG.debug(&quot;Purging customers&quot;);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 368         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 369         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="362564872021724408" onmouseenter="enter('362564872021724408');" onmouseout="out('362564872021724408');" style=""><abbr title=" 370             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. &quot; +"> 370             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration pðŸ”µ</abbr></span>
<span class="-7406017465356863948" onmouseenter="enter('-7406017465356863948');" onmouseout="out('-7406017465356863948');" style=""> 371                     &quot;In the absence of config params, all customers would be candidates for deletion.&quot;); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 372         }                                                                                                </span>
<span class="-2250958415199181791" onmouseenter="enter('-2250958415199181791');" onmouseout="out('-2250958415199181791');" style=""> 373         CustomerPurgeParams purgeParams = new CustomerPurgeParams(config).invoke();                      </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 374         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="2523117162231837045" onmouseenter="enter('2523117162231837045');" onmouseout="out('2523117162231837045');" style=""> 375         synchronized (customerPurgeErrors) {                                                             </span>
<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style=""> 376             Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                      </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style=""><abbr title=" 377             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 377             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).iðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style=""><abbr title=" 378             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 378             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;LongðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style=""> 379             for (Customer customer : customers) {                                                        </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style=""> 380                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,          </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 381                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 382                 try {                                                                                    </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style=""> 383                     deleteCustomer(customer);                                                            </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 384                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 385                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 386                 } catch (Exception e) {                                                                  </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style=""> 387                     if (!status.isCompleted()) {                                                         </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 388                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389                     }                                                                                    </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style=""> 390                     LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);  </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style=""> 391                     customerPurgeErrors.add(customer.getId());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 392                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 393             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 394         }                                                                                                </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style=""><abbr title=" 395         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 395         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396     }                                                                                                    </span>
<span  style=""> 397                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 398     /**                                                                                                  </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style=""><abbr title=" 399      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 399      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  ExpðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 400      *                                                                                                   </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style=""> 401      * @param purgeParams configured parameters for the cart purge process                               </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style=""> 402      * @return set of cart ids to ignore/exclude from the next purge run                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 403      */                                                                                                  </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style=""> 404     protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                           </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 405         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style=""> 406         Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);         </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style=""> 407         return ignoreFailedCartIds;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 408     }                                                                                                    </span>
<span  style=""> 409                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 410     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 411      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 411      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 412      *                                                                                                   </span>
<span class="2629836549582755488" onmouseenter="enter('2629836549582755488');" onmouseout="out('2629836549582755488');" style=""> 413      * @param purgeParams  configured parameters for the Cart purge process                              </span>
<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style=""> 414      * @param cartsInError list of cart ids to be ignored/excluded from the query                        </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style=""> 415      * @return list of carts to delete                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 416      */                                                                                                  </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style=""><abbr title=" 417     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 417     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;LonðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 418         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 419         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 420         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 421         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style=""><abbr title=" 422         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 422         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423     }                                                                                                    </span>
<span  style=""> 424                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 425     /**                                                                                                  </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style=""><abbr title=" 426      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 426      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 427      *                                                                                                   </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style=""> 428      * @param purgeParams configured parameters for the Customer purge process used in the query         </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style=""> 429      * @param cartsInError list of cart ids to ignore/exclude from the next purge run                    </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style=""> 430      * @return count of carts to delete                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 431      */                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 432     /**                                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 433      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 434      */                                                                                                  </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style=""> 435     protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {         </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 436         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 437         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 438         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 439         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style=""> 440         Long cartBatchSize = purgeParams.getBatchSize();                                                 </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style=""><abbr title=" 441         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 441         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThresholdðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style=""> 442         //return the lesser of the parameter batch size of the count of the orders to purge              </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style=""> 443         return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 444     }                                                                                                    </span>
<span  style=""> 445                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 446     /**                                                                                                  </span>
<span class="-4831217906829284324" onmouseenter="enter('-4831217906829284324');" onmouseout="out('-4831217906829284324');" style=""> 447      * Notify the cart&#x27;s owner of a pending purge of their cart.                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 448      *                                                                                                   </span>
<span class="-1591121872845752466" onmouseenter="enter('-1591121872845752466');" onmouseout="out('-1591121872845752466');" style=""> 449      * @param cart the cart                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 450      */                                                                                                  </span>
<span class="-1439517530326153748" onmouseenter="enter('-1439517530326153748');" onmouseout="out('-1439517530326153748');" style=""> 451     protected void notifyCart(Order cart) {                                                              </span>
<span class="6785017572112928400" onmouseenter="enter('6785017572112928400');" onmouseout="out('6785017572112928400');" style=""> 452         String emailAddress = getEmailForCart(cart);                                                     </span>
<span class="-8702812354445074278" onmouseenter="enter('-8702812354445074278');" onmouseout="out('-8702812354445074278');" style=""> 453         if (emailAddress != null) {                                                                      </span>
<span class="4884753630904156580" onmouseenter="enter('4884753630904156580');" onmouseout="out('4884753630904156580');" style=""> 454             Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();                                               </span>
<span class="-1876686562124284125" onmouseenter="enter('-1876686562124284125');" onmouseout="out('-1876686562124284125');" style=""> 455             context.put(&quot;cart&quot;, cart);                                                                   </span>
<span class="-7081183395280146833" onmouseenter="enter('-7081183395280146833');" onmouseout="out('-7081183395280146833');" style=""> 456             context.put(&quot;customer&quot;, cart.getCustomer());                                                 </span>
<span class="2299045321537655635" onmouseenter="enter('2299045321537655635');" onmouseout="out('2299045321537655635');" style=""> 457             context.put(&quot;emailAddress&quot;, emailAddress);                                                   </span>
<span  style=""> 458                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 459             try {                                                                                        </span>
<span class="-335501726229324372" onmouseenter="enter('-335501726229324372');" onmouseout="out('-335501726229324372');" style=""><abbr title=" 460                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificationEventType.NOTIFY_ABANDONED_CART, context));"> 460                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificatðŸ”µ</abbr></span>
<span class="9220844322816084446" onmouseenter="enter('9220844322816084446');" onmouseout="out('9220844322816084446');" style=""> 461             } catch (ServiceException e) {                                                               </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 462                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-238742426127135817" onmouseenter="enter('-238742426127135817');" onmouseout="out('-238742426127135817');" style=""> 463                     LOG.debug(&quot;Failure to send email notification&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467     }                                                                                                    </span>
<span  style=""> 468                                                                                                          </span>
<span class="962012931445232765" onmouseenter="enter('962012931445232765');" onmouseout="out('962012931445232765');" style=""> 469     protected String getEmailForCart(Order cart) {                                                       </span>
<span class="-1013041921655187511" onmouseenter="enter('-1013041921655187511');" onmouseout="out('-1013041921655187511');" style=""> 470         if (cart.getEmailAddress() != null) {                                                            </span>
<span class="9127709401881574307" onmouseenter="enter('9127709401881574307');" onmouseout="out('9127709401881574307');" style=""> 471             return cart.getEmailAddress();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472         }                                                                                                </span>
<span  style=""> 473                                                                                                          </span>
<span class="-4914468579235587722" onmouseenter="enter('-4914468579235587722');" onmouseout="out('-4914468579235587722');" style=""> 474         if (cart.getCustomer() != null &amp;&amp; cart.getCustomer().getEmailAddress() != null) {                </span>
<span class="4109268194947089596" onmouseenter="enter('4109268194947089596');" onmouseout="out('4109268194947089596');" style=""> 475             return cart.getCustomer().getEmailAddress();                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476         }                                                                                                </span>
<span  style=""> 477                                                                                                          </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 478         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479     }                                                                                                    </span>
<span  style=""> 480                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 481     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 482      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 482      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 483      *                                                                                                   </span>
<span class="-6771798214247950041" onmouseenter="enter('-6771798214247950041');" onmouseout="out('-6771798214247950041');" style=""> 484      * @param cart the cart to remove                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 485      */                                                                                                  </span>
<span class="621215427910457813" onmouseenter="enter('621215427910457813');" onmouseout="out('621215427910457813');" style=""> 486     protected void deleteCart(Order cart) {                                                              </span>
<span class="-3274557726078521593" onmouseenter="enter('-3274557726078521593');" onmouseout="out('-3274557726078521593');" style=""><abbr title=" 487         //We delete the order this way (rather than with a delete query) in order to ensure the cascades take place"> 487         //We delete the order this way (rather than with a delete query) in order to ensure the cascades ðŸ”µ</abbr></span>
<span class="5643426177894030209" onmouseenter="enter('5643426177894030209');" onmouseout="out('5643426177894030209');" style=""> 488         orderService.deleteOrder(cart);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489     }                                                                                                    </span>
<span  style=""> 490                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 491     /**                                                                                                  </span>
<span class="3205340653525749512" onmouseenter="enter('3205340653525749512');" onmouseout="out('3205340653525749512');" style=""> 492      * Get the Customer Ids from cache that should be ignored due to errors in previous purge attempts   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 493      *                                                                                                   </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 494      * @param purgeParams configured parameters for the Customer purge process                           </span>
<span class="-5970206514796632950" onmouseenter="enter('-5970206514796632950');" onmouseout="out('-5970206514796632950');" style=""> 495      * @return set of customer ids to ignore/exclude from the next purge run                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 496      */                                                                                                  </span>
<span class="-3065693137793837519" onmouseenter="enter('-3065693137793837519');" onmouseout="out('-3065693137793837519');" style=""> 497     protected Set&lt;Long&gt; getCustomersInErrorToIgnore(CustomerPurgeParams purgeParams) {                   </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 498         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-7599335319839599610" onmouseenter="enter('-7599335319839599610');" onmouseout="out('-7599335319839599610');" style=""> 499         Set&lt;Long&gt; ignoreFailedCustomerIds = customerPurgeErrors.getEntriesSince(ignoreFailedExpiration); </span>
<span class="-6742430259144212604" onmouseenter="enter('-6742430259144212604');" onmouseout="out('-6742430259144212604');" style=""> 500         return ignoreFailedCustomerIds;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501     }                                                                                                    </span>
<span  style=""> 502                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 503     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 504      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 504      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 505      *                                                                                                   </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style=""> 506      * @param purgeParams      configured parameters for the Customer purge process                      </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 507      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="6504215439929103259" onmouseenter="enter('6504215439929103259');" onmouseout="out('6504215439929103259');" style=""> 508      * @return list of customers to delete                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 509      */                                                                                                  </span>
<span class="-1507004170363559761" onmouseenter="enter('-1507004170363559761');" onmouseout="out('-1507004170363559761');" style=""><abbr title=" 510     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; customersInError) {"> 510     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int lengtðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 511         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 512         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 513         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 514         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-2312253704458899930" onmouseenter="enter('-2312253704458899930');" onmouseout="out('-2312253704458899930');" style=""><abbr title=" 515         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, startPos, length, customersInError);"> 515         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 516     }                                                                                                    </span>
<span  style=""> 517                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 518     /**                                                                                                  </span>
<span class="8648259411111567723" onmouseenter="enter('8648259411111567723');" onmouseout="out('8648259411111567723');" style=""><abbr title=" 519      * Get the count of customers to delete from the database. Subclasses may override for custom customer retrieval logic."> 519      * Get the count of customers to delete from the database. Subclasses may override for custom customeðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 520      *                                                                                                   </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style=""> 521      * @param purgeParams      configured parameters for the Customer purge process                      </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 522      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 523      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 524      */                                                                                                  </span>
<span class="8294886805011187143" onmouseenter="enter('8294886805011187143');" onmouseout="out('8294886805011187143');" style=""><abbr title=" 525     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInError) {"> 525     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInErrorðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 526         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 527         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 528         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 529         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-6790142400743483163" onmouseenter="enter('-6790142400743483163');" onmouseout="out('-6790142400743483163');" style=""> 530         Long customerBatchSize = purgeParams.getBatchSize();                                             </span>
<span class="-6217873247193256304" onmouseenter="enter('-6217873247193256304');" onmouseout="out('-6217873247193256304');" style=""><abbr title=" 531         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, customersInError);"> 531         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, ðŸ”µ</abbr></span>
<span class="-4628315344870235824" onmouseenter="enter('-4628315344870235824');" onmouseout="out('-4628315344870235824');" style=""> 532         //return the lesser of the parameter batch size of the count of the customers to purge           </span>
<span class="-6036527682216446677" onmouseenter="enter('-6036527682216446677');" onmouseout="out('-6036527682216446677');" style=""><abbr title=" 533         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCount;"> 533         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : custðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 534     }                                                                                                    </span>
<span  style=""> 535                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 536     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 537      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 537      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 538      *                                                                                                   </span>
<span class="-897887194989371766" onmouseenter="enter('-897887194989371766');" onmouseout="out('-897887194989371766');" style=""> 539      * @param customer the customer to remove                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 540      */                                                                                                  </span>
<span class="9030957329407065452" onmouseenter="enter('9030957329407065452');" onmouseout="out('9030957329407065452');" style=""> 541     protected void deleteCustomer(Customer customer) {                                                   </span>
<span class="-4425816966306665584" onmouseenter="enter('-4425816966306665584');" onmouseout="out('-4425816966306665584');" style=""><abbr title=" 542         //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take place"> 542         //We delete the customer this way (rather than with a delete query) in order to ensure the cascadðŸ”µ</abbr></span>
<span class="4420445378351605906" onmouseenter="enter('4420445378351605906');" onmouseout="out('4420445378351605906');" style=""> 543         customerService.deleteCustomer(customer);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544     }                                                                                                    </span>
<span  style=""> 545                                                                                                          </span>
<span class="2605850108496977404" onmouseenter="enter('2605850108496977404');" onmouseout="out('2605850108496977404');" style=""> 546     private class CartPurgeParams {                                                                      </span>
<span  style=""> 547                                                                                                          </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 548         private Map&lt;String, String&gt; config;                                                              </span>
<span class="1381900387592843642" onmouseenter="enter('1381900387592843642');" onmouseout="out('1381900387592843642');" style=""> 549         private String[] nameArray;                                                                      </span>
<span class="8331062799574265987" onmouseenter="enter('8331062799574265987');" onmouseout="out('8331062799574265987');" style=""> 550         private OrderStatus[] statusArray;                                                               </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 551         private Date dateCreatedMinThreshold;                                                            </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 552         private Boolean isPreview;                                                                       </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 553         private Long batchSize;                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 554         private Long failedRetryTime;                                                                    </span>
<span  style=""> 555                                                                                                          </span>
<span class="2815224750970340197" onmouseenter="enter('2815224750970340197');" onmouseout="out('2815224750970340197');" style=""> 556         public CartPurgeParams(Map&lt;String, String&gt; config) {                                             </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 557             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558         }                                                                                                </span>
<span  style=""> 559                                                                                                          </span>
<span class="-686271337436163522" onmouseenter="enter('-686271337436163522');" onmouseout="out('-686271337436163522');" style=""> 560         public String[] getNameArray() {                                                                 </span>
<span class="-6597175720812897488" onmouseenter="enter('-6597175720812897488');" onmouseout="out('-6597175720812897488');" style=""> 561             return nameArray;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 562         }                                                                                                </span>
<span  style=""> 563                                                                                                          </span>
<span class="-4470666030488291109" onmouseenter="enter('-4470666030488291109');" onmouseout="out('-4470666030488291109');" style=""> 564         public OrderStatus[] getStatusArray() {                                                          </span>
<span class="1669553314396389775" onmouseenter="enter('1669553314396389775');" onmouseout="out('1669553314396389775');" style=""> 565             return statusArray;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566         }                                                                                                </span>
<span  style=""> 567                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 568         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 569             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570         }                                                                                                </span>
<span  style=""> 571                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 572         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 573             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 574         }                                                                                                </span>
<span  style=""> 575                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 576         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 577             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 578         }                                                                                                </span>
<span  style=""> 579                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 580         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 581             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582         }                                                                                                </span>
<span  style=""> 583                                                                                                          </span>
<span class="-2086671766953086341" onmouseenter="enter('-2086671766953086341');" onmouseout="out('-2086671766953086341');" style=""> 584         public CartPurgeParams invoke() {                                                                </span>
<span class="2406323390572474949" onmouseenter="enter('2406323390572474949');" onmouseout="out('2406323390572474949');" style=""> 585             nameArray = null;                                                                            </span>
<span class="-8056479474459794956" onmouseenter="enter('-8056479474459794956');" onmouseout="out('-8056479474459794956');" style=""> 586             statusArray = null;                                                                          </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 587             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 588             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 589             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 590             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span  style=""> 591                                                                                                          </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 592             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="7230126592195401480" onmouseenter="enter('7230126592195401480');" onmouseout="out('7230126592195401480');" style=""> 593                 if (PurgeCartVariableNames.STATUS.toString().equals(entry.getKey())) {                   </span>
<span class="-3887059016856253482" onmouseenter="enter('-3887059016856253482');" onmouseout="out('-3887059016856253482');" style=""> 594                     String[] temp = entry.getValue().split(&quot;,&quot;);                                         </span>
<span class="-984189042629809269" onmouseenter="enter('-984189042629809269');" onmouseout="out('-984189042629809269');" style=""> 595                     statusArray = new OrderStatus[temp.length];                                          </span>
<span class="7424479410662112456" onmouseenter="enter('7424479410662112456');" onmouseout="out('7424479410662112456');" style=""> 596                     int index = 0;                                                                       </span>
<span class="-6857112710843456451" onmouseenter="enter('-6857112710843456451');" onmouseout="out('-6857112710843456451');" style=""> 597                     for (String name : temp) {                                                           </span>
<span class="4249642856708256048" onmouseenter="enter('4249642856708256048');" onmouseout="out('4249642856708256048');" style=""> 598                         OrderStatus orderStatus = OrderStatus.getInstance(name);                         </span>
<span class="354647143791226174" onmouseenter="enter('354647143791226174');" onmouseout="out('354647143791226174');" style=""> 599                         statusArray[index] = orderStatus;                                                </span>
<span class="8743575581853771534" onmouseenter="enter('8743575581853771534');" onmouseout="out('8743575581853771534');" style=""> 600                         index++;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 602                 }                                                                                        </span>
<span class="-680570050183499360" onmouseenter="enter('-680570050183499360');" onmouseout="out('-680570050183499360');" style=""> 603                 if (PurgeCartVariableNames.NAME.toString().equals(entry.getKey())) {                     </span>
<span class="3793410955933370059" onmouseenter="enter('3793410955933370059');" onmouseout="out('3793410955933370059');" style=""> 604                     nameArray = entry.getValue().split(&quot;,&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605                 }                                                                                        </span>
<span class="5654291195038602061" onmouseenter="enter('5654291195038602061');" onmouseout="out('5654291195038602061');" style=""> 606                 if (PurgeCartVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {              </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 607                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 608                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609                 }                                                                                        </span>
<span class="-3116043338550155301" onmouseenter="enter('-3116043338550155301');" onmouseout="out('-3116043338550155301');" style=""> 610                 if (PurgeCartVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {               </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 611                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612                 }                                                                                        </span>
<span class="-7209605236483980682" onmouseenter="enter('-7209605236483980682');" onmouseout="out('-7209605236483980682');" style=""> 613                 if (PurgeCartVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {               </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 614                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615                 }                                                                                        </span>
<span class="6665497140882829750" onmouseenter="enter('6665497140882829750');" onmouseout="out('6665497140882829750');" style=""> 616                 if (PurgeCartVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {     </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 617                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 617                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 618                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 619             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 620             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 621         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 622     }                                                                                                    </span>
<span  style=""> 623                                                                                                          </span>
<span class="6135355437794836082" onmouseenter="enter('6135355437794836082');" onmouseout="out('6135355437794836082');" style=""> 624     private class CustomerPurgeParams {                                                                  </span>
<span  style=""> 625                                                                                                          </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 626         private Map&lt;String, String&gt; config;                                                              </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 627         private Date dateCreatedMinThreshold;                                                            </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 628         private Boolean isPreview;                                                                       </span>
<span class="5345429142323969812" onmouseenter="enter('5345429142323969812');" onmouseout="out('5345429142323969812');" style=""> 629         private Boolean isRegistered;                                                                    </span>
<span class="3484617240152312252" onmouseenter="enter('3484617240152312252');" onmouseout="out('3484617240152312252');" style=""> 630         private Boolean isDeactivated;                                                                   </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 631         private Long batchSize;                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 632         private Long failedRetryTime;                                                                    </span>
<span  style=""> 633                                                                                                          </span>
<span class="-3439970468083719495" onmouseenter="enter('-3439970468083719495');" onmouseout="out('-3439970468083719495');" style=""> 634         public CustomerPurgeParams(Map&lt;String, String&gt; config) {                                         </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 635             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 636         }                                                                                                </span>
<span  style=""> 637                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 638         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 639             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640         }                                                                                                </span>
<span  style=""> 641                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 642         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 643             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 644         }                                                                                                </span>
<span  style=""> 645                                                                                                          </span>
<span class="-4523160162166092089" onmouseenter="enter('-4523160162166092089');" onmouseout="out('-4523160162166092089');" style=""> 646         public Boolean getIsRegistered() {                                                               </span>
<span class="6500879271821699409" onmouseenter="enter('6500879271821699409');" onmouseout="out('6500879271821699409');" style=""> 647             return isRegistered;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 648         }                                                                                                </span>
<span  style=""> 649                                                                                                          </span>
<span class="831937501284736178" onmouseenter="enter('831937501284736178');" onmouseout="out('831937501284736178');" style=""> 650         public Boolean getIsDeactivated() {                                                              </span>
<span class="-8572023523120285779" onmouseenter="enter('-8572023523120285779');" onmouseout="out('-8572023523120285779');" style=""> 651             return isDeactivated;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 652         }                                                                                                </span>
<span  style=""> 653                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 654         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 655             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 656         }                                                                                                </span>
<span  style=""> 657                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 658         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 659             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660         }                                                                                                </span>
<span  style=""> 661                                                                                                          </span>
<span class="4345643298854756592" onmouseenter="enter('4345643298854756592');" onmouseout="out('4345643298854756592');" style=""> 662         public CustomerPurgeParams invoke() {                                                            </span>
<span class="-2554699908388798358" onmouseenter="enter('-2554699908388798358');" onmouseout="out('-2554699908388798358');" style=""> 663             isRegistered = null;                                                                         </span>
<span class="-4109360067770509892" onmouseenter="enter('-4109360067770509892');" onmouseout="out('-4109360067770509892');" style=""> 664             isDeactivated = null;                                                                        </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 665             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 666             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 667             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 668             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span  style=""> 669                                                                                                          </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 670             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="8500820035603099955" onmouseenter="enter('8500820035603099955');" onmouseout="out('8500820035603099955');" style=""> 671                 if (PurgeCustomerVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {          </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 672                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 673                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 674                 }                                                                                        </span>
<span class="472649037401986768" onmouseenter="enter('472649037401986768');" onmouseout="out('472649037401986768');" style=""> 675                 if (PurgeCustomerVariableNames.IS_REGISTERED.toString().equals(entry.getKey())) {        </span>
<span class="3066848756297460347" onmouseenter="enter('3066848756297460347');" onmouseout="out('3066848756297460347');" style=""> 676                     isRegistered = Boolean.parseBoolean(entry.getValue());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 677                 }                                                                                        </span>
<span class="-6798790184150039593" onmouseenter="enter('-6798790184150039593');" onmouseout="out('-6798790184150039593');" style=""> 678                 if (PurgeCustomerVariableNames.IS_DEACTIVATED.toString().equals(entry.getKey())) {       </span>
<span class="8770174800886691615" onmouseenter="enter('8770174800886691615');" onmouseout="out('8770174800886691615');" style=""> 679                     isDeactivated = Boolean.parseBoolean(entry.getValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 680                 }                                                                                        </span>
<span class="-4202787563999133129" onmouseenter="enter('-4202787563999133129');" onmouseout="out('-4202787563999133129');" style=""> 681                 if (PurgeCustomerVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {           </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 682                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 683                 }                                                                                        </span>
<span class="2949192035259803609" onmouseenter="enter('2949192035259803609');" onmouseout="out('2949192035259803609');" style=""> 684                 if (PurgeCustomerVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {           </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 685                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 686                 }                                                                                        </span>
<span class="3875509270375211860" onmouseenter="enter('3875509270375211860');" onmouseout="out('3875509270375211860');" style=""> 687                 if (PurgeCustomerVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) { </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 688                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 688                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 689                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 691             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 692         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 693     }                                                                                                    </span>
<span  style=""> 694                                                                                                          </span>
<span class="-4423643614963439423" onmouseenter="enter('-4423643614963439423');" onmouseout="out('-4423643614963439423');" style=""> 695     private class PurgeErrorCache {                                                                      </span>
<span  style=""> 696                                                                                                          </span>
<span class="198672241784651248" onmouseenter="enter('198672241784651248');" onmouseout="out('198672241784651248');" style=""> 697         private Map&lt;Long, Long&gt; cache = new HashMap&lt;Long, Long&gt;();                                       </span>
<span  style=""> 698                                                                                                          </span>
<span class="-5066122402174219646" onmouseenter="enter('-5066122402174219646');" onmouseout="out('-5066122402174219646');" style=""> 699         public Long add(Long entry) {                                                                    </span>
<span class="1483875087127814333" onmouseenter="enter('1483875087127814333');" onmouseout="out('1483875087127814333');" style=""> 700             if (!cache.containsKey(entry)) {                                                             </span>
<span class="-1518558382272290563" onmouseenter="enter('-1518558382272290563');" onmouseout="out('-1518558382272290563');" style=""> 701                 return cache.put(entry, new Long(System.currentTimeMillis()));                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 702             }                                                                                            </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 703             return null;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 704         }                                                                                                </span>
<span  style=""> 705                                                                                                          </span>
<span class="-5864460220203783413" onmouseenter="enter('-5864460220203783413');" onmouseout="out('-5864460220203783413');" style=""> 706         public Set&lt;Long&gt; getEntriesSince(long expiredTime) {                                             </span>
<span class="-5150169203707964219" onmouseenter="enter('-5150169203707964219');" onmouseout="out('-5150169203707964219');" style=""> 707             for (Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext(); ) { </span>
<span class="-7841947474939136830" onmouseenter="enter('-7841947474939136830');" onmouseout="out('-7841947474939136830');" style=""> 708                 Map.Entry&lt;Long, Long&gt; entry = item.next();                                               </span>
<span class="3419674656987096917" onmouseenter="enter('3419674656987096917');" onmouseout="out('3419674656987096917');" style=""> 709                 if (entry.getValue().longValue() &lt; expiredTime) {                                        </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style=""> 710                     item.remove();                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 711                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 712             }                                                                                            </span>
<span class="4846818570039273159" onmouseenter="enter('4846818570039273159');" onmouseout="out('4846818570039273159');" style=""> 713             return cache.keySet();                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 714         }                                                                                                </span>
<span  style=""> 715                                                                                                          </span>
<span class="5501185527198334216" onmouseenter="enter('5501185527198334216');" onmouseout="out('5501185527198334216');" style=""> 716         public int size() {                                                                              </span>
<span class="4045092944756323954" onmouseenter="enter('4045092944756323954');" onmouseout="out('4045092944756323954');" style=""> 717             return cache.size();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 718         }                                                                                                </span>
<span  style=""> 719                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720     }                                                                                                    </span>
<span  style=""> 721                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 722 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-392708096265613810" onmouseenter="enter('-392708096265613810');" onmouseout="out('-392708096265613810');" style="">  18 package org.broadleafcommerce.core.util.service;                                                         </span>
<span  style="">  19                                                                                                          </span>
<span class="4020017653195254006" onmouseenter="enter('4020017653195254006');" onmouseout="out('4020017653195254006');" style="">  20 import org.apache.commons.collections.MapUtils;                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  21 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  22 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  23 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="7132038483204039493" onmouseenter="enter('7132038483204039493');" onmouseout="out('7132038483204039493');" style="">  24 import org.broadleafcommerce.common.notification.service.NotificationDispatcher;                         </span>
<span class="-840358981756149848" onmouseenter="enter('-840358981756149848');" onmouseout="out('-840358981756149848');" style="">  25 import org.broadleafcommerce.common.notification.service.type.EmailNotification;                         </span>
<span class="-7956607451590208760" onmouseenter="enter('-7956607451590208760');" onmouseout="out('-7956607451590208760');" style="">  26 import org.broadleafcommerce.common.notification.service.type.NotificationEventType;                     </span>
<span class="1373992879208813777" onmouseenter="enter('1373992879208813777');" onmouseout="out('1373992879208813777');" style="">  27 import org.broadleafcommerce.common.time.SystemTime;                                                     </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  28 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  29 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-9126455085472227806" onmouseenter="enter('-9126455085472227806');" onmouseout="out('-9126455085472227806');" style="">  30 import org.broadleafcommerce.core.order.domain.OrderImpl;                                                </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  31 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="">  33 import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                             </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="">  34 import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                              </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="">  35 import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                          </span>
<span class="8877081811676575024" onmouseenter="enter('8877081811676575024');" onmouseout="out('8877081811676575024');" style="">  36 import org.broadleafcommerce.core.util.service.type.PurgeOrderHistoryVariableNames;                      </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  37 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="">  38 import org.broadleafcommerce.profile.core.service.CustomerService;                                       </span>
<span class="-1504015732959009083" onmouseenter="enter('-1504015732959009083');" onmouseout="out('-1504015732959009083');" style="">  39 import org.hibernate.Session;                                                                            </span>
<span class="1031102842064240387" onmouseenter="enter('1031102842064240387');" onmouseout="out('1031102842064240387');" style="">  40 import org.hibernate.jdbc.Work;                                                                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  41 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  42 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  43 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  44 import org.springframework.stereotype.Service;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  45 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  46 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  47 import org.springframework.transaction.TransactionStatus;                                                </span>
<span  style="">  48                                                                                                          </span>
<span class="-7136330293413175449" onmouseenter="enter('-7136330293413175449');" onmouseout="out('-7136330293413175449');" style="">  49 import java.sql.Connection;                                                                              </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  50 import java.sql.SQLException;                                                                            </span>
<span class="6402527026259660908" onmouseenter="enter('6402527026259660908');" onmouseout="out('6402527026259660908');" style="">  51 import java.sql.Statement;                                                                               </span>
<span class="196713859697444637" onmouseenter="enter('196713859697444637');" onmouseout="out('196713859697444637');" style="">  52 import java.util.*;                                                                                      </span>
<span  style="">  53                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  54 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  55 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  56 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  57                                                                                                          </span>
<span  style="">  58                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  59 /**                                                                                                      </span>
<span class="-3191869593089593640" onmouseenter="enter('-3191869593089593640');" onmouseout="out('-3191869593089593640');" style=""><abbr title="  60  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous Customers).">  60  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymoðŸ”µ</abbr></span>
<span class="832835515286180797" onmouseenter="enter('832835515286180797');" onmouseout="out('832835515286180797');" style="">  61  * {@link ResourcePurgeService} for additional API documentation.                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  62  * &lt;p/&gt;                                                                                                  </span>
<span class="-315394129855994292" onmouseenter="enter('-315394129855994292');" onmouseout="out('-315394129855994292');" style="">  63  * A basic Quartz scheduled job configuration for calling this service can be configured as follows:     </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  64  * &lt;p/&gt;                                                                                                  </span>
<span class="-131984816008333551" onmouseenter="enter('-131984816008333551');" onmouseout="out('-131984816008333551');" style="">  65  * {@code                                                                                                </span>
<span class="8079836627557216097" onmouseenter="enter('8079836627557216097');" onmouseout="out('8079836627557216097');" style="">  66  * &lt;bean id=&quot;purgeCartConfig&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;           </span>
<span class="8809411245832543538" onmouseenter="enter('8809411245832543538');" onmouseout="out('8809411245832543538');" style="">  67  * &lt;property name=&quot;sourceMap&quot;&gt;                                                                           </span>
<span class="-4290418952995175850" onmouseenter="enter('-4290418952995175850');" onmouseout="out('-4290418952995175850');" style="">  68  * &lt;map&gt;                                                                                                 </span>
<span class="5370217760353547455" onmouseenter="enter('5370217760353547455');" onmouseout="out('5370217760353547455');" style="">  69  * &lt;entry key=&quot;SECONDS_OLD&quot; value=&quot;2592000&quot;/&gt;                                                            </span>
<span class="-1857330153031469850" onmouseenter="enter('-1857330153031469850');" onmouseout="out('-1857330153031469850');" style="">  70  * &lt;entry key=&quot;STATUS&quot; value=&quot;IN_PROCESS&quot;/&gt;                                                              </span>
<span class="-1596267147682690356" onmouseenter="enter('-1596267147682690356');" onmouseout="out('-1596267147682690356');" style="">  71  * &lt;/map&gt;                                                                                                </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  72  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  73  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  74  * &lt;p/&gt;                                                                                                  </span>
<span class="5857689149403140530" onmouseenter="enter('5857689149403140530');" onmouseout="out('5857689149403140530');" style=""><abbr title="  75  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;">  75  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactðŸ”µ</abbr></span>
<span class="-390919979070777656" onmouseenter="enter('-390919979070777656');" onmouseout="out('-390919979070777656');" style="">  76  * &lt;property name=&quot;targetObject&quot; ref=&quot;blResourcePurgeService&quot; /&gt;                                         </span>
<span class="-1711168238872066589" onmouseenter="enter('-1711168238872066589');" onmouseout="out('-1711168238872066589');" style="">  77  * &lt;property name=&quot;targetMethod&quot; value=&quot;purgeCarts&quot; /&gt;                                                   </span>
<span class="4875414778543091051" onmouseenter="enter('4875414778543091051');" onmouseout="out('4875414778543091051');" style="">  78  * &lt;property name=&quot;arguments&quot;&gt;                                                                           </span>
<span class="6000473589228105200" onmouseenter="enter('6000473589228105200');" onmouseout="out('6000473589228105200');" style="">  79  * &lt;list&gt;                                                                                                </span>
<span class="-1321283090282055520" onmouseenter="enter('-1321283090282055520');" onmouseout="out('-1321283090282055520');" style="">  80  * &lt;ref bean=&quot;purgeCartConfig&quot;/&gt;                                                                         </span>
<span class="2486531046171828364" onmouseenter="enter('2486531046171828364');" onmouseout="out('2486531046171828364');" style="">  81  * &lt;/list&gt;                                                                                               </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  82  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  83  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  84  * &lt;p/&gt;                                                                                                  </span>
<span class="-7915154528943636028" onmouseenter="enter('-7915154528943636028');" onmouseout="out('-7915154528943636028');" style="">  85  * &lt;bean id=&quot;purgeCartTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;   </span>
<span class="5235847799914996571" onmouseenter="enter('5235847799914996571');" onmouseout="out('5235847799914996571');" style="">  86  * &lt;property name=&quot;jobDetail&quot; ref=&quot;purgeCartJobDetail&quot; /&gt;                                                </span>
<span class="-1206739829467768833" onmouseenter="enter('-1206739829467768833');" onmouseout="out('-1206739829467768833');" style="">  87  * &lt;property name=&quot;startDelay&quot; value=&quot;30000&quot; /&gt;                                                          </span>
<span class="-7327795866109106158" onmouseenter="enter('-7327795866109106158');" onmouseout="out('-7327795866109106158');" style="">  88  * &lt;property name=&quot;repeatInterval&quot; value=&quot;86400000&quot; /&gt;                                                   </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  89  * &lt;/bean&gt;                                                                                               </span>
<span class="8941010846014250828" onmouseenter="enter('8941010846014250828');" onmouseout="out('8941010846014250828');" style="">  90  * }                                                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  91  *                                                                                                       </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  92  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  93  */                                                                                                      </span>
<span class="-5822344749670970380" onmouseenter="enter('-5822344749670970380');" onmouseout="out('-5822344749670970380');" style="">  94 @Service(&quot;blResourcePurgeService&quot;)                                                                       </span>
<span class="873248027020485265" onmouseenter="enter('873248027020485265');" onmouseout="out('873248027020485265');" style="">  95 public class ResourcePurgeServiceImpl implements ResourcePurgeService {                                  </span>
<span  style="">  96                                                                                                          </span>
<span class="-6373274908004434475" onmouseenter="enter('-6373274908004434475');" onmouseout="out('-6373274908004434475');" style="">  97     private static final Log LOG = LogFactory.getLog(ResourcePurgeServiceImpl.class);                    </span>
<span  style="">  98                                                                                                          </span>
<span class="149979258544894255" onmouseenter="enter('149979258544894255');" onmouseout="out('149979258544894255');" style="">  99     private static final Long BATCH_SIZE = 50L;                                                          </span>
<span class="-4253097523145751645" onmouseenter="enter('-4253097523145751645');" onmouseout="out('-4253097523145751645');" style=""><abbr title=" 100     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48 HOURS"> 100     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48ðŸ”µ</abbr></span>
<span  style=""> 101                                                                                                          </span>
<span class="8526754740985159609" onmouseenter="enter('8526754740985159609');" onmouseout="out('8526754740985159609');" style=""> 102     protected PurgeErrorCache customerPurgeErrors = new PurgeErrorCache();                               </span>
<span class="4108358954087572821" onmouseenter="enter('4108358954087572821');" onmouseout="out('4108358954087572821');" style=""> 103     protected PurgeErrorCache historyPurgeErrors = new PurgeErrorCache();                                </span>
<span class="7366515115260261905" onmouseenter="enter('7366515115260261905');" onmouseout="out('7366515115260261905');" style=""> 104     protected PurgeErrorCache cartPurgeErrors = new PurgeErrorCache();                                   </span>
<span  style=""> 105                                                                                                          </span>
<span class="-2629969533830190342" onmouseenter="enter('-2629969533830190342');" onmouseout="out('-2629969533830190342');" style=""> 106     @Resource(name = &quot;blTransactionManager&quot;)                                                             </span>
<span class="-8090157640080505156" onmouseenter="enter('-8090157640080505156');" onmouseout="out('-8090157640080505156');" style=""> 107     protected PlatformTransactionManager transactionManager;                                             </span>
<span  style=""> 108                                                                                                          </span>
<span class="-2129959487514464786" onmouseenter="enter('-2129959487514464786');" onmouseout="out('-2129959487514464786');" style=""> 109     @Resource(name = &quot;blResourcePurgeDao&quot;)                                                               </span>
<span class="1336580446360306350" onmouseenter="enter('1336580446360306350');" onmouseout="out('1336580446360306350');" style=""> 110     protected ResourcePurgeDao resourcePurgeDao;                                                         </span>
<span  style=""> 111                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 112     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 113     protected OrderService orderService;                                                                 </span>
<span  style=""> 114                                                                                                          </span>
<span class="6969754559269026560" onmouseenter="enter('6969754559269026560');" onmouseout="out('6969754559269026560');" style=""> 115     @Resource(name = &quot;blCustomerService&quot;)                                                                </span>
<span class="5369585293672379772" onmouseenter="enter('5369585293672379772');" onmouseout="out('5369585293672379772');" style=""> 116     protected CustomerService customerService;                                                           </span>
<span  style=""> 117                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style=""> 118     @Autowired                                                                                           </span>
<span class="-772913752442459972" onmouseenter="enter('-772913752442459972');" onmouseout="out('-772913752442459972');" style=""> 119     @Qualifier(&quot;blNotificationDispatcher&quot;)                                                               </span>
<span class="-1953064040931552296" onmouseenter="enter('-1953064040931552296');" onmouseout="out('-1953064040931552296');" style=""> 120     protected NotificationDispatcher notificationDispatcher;                                             </span>
<span  style=""> 121                                                                                                          </span>
<span class="695241785881102503" onmouseenter="enter('695241785881102503');" onmouseout="out('695241785881102503');" style=""> 122     @Resource(name = &quot;blDeleteStatementGenerator&quot;)                                                       </span>
<span class="-7581585138447328467" onmouseenter="enter('-7581585138447328467');" onmouseout="out('-7581585138447328467');" style=""> 123     protected DeleteStatementGenerator deleteStatementGenerator;                                         </span>
<span  style=""> 124                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style=""> 125     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style=""> 126     protected Environment env;                                                                           </span>
<span  style=""> 127                                                                                                          </span>
<span class="5710637357667853932" onmouseenter="enter('5710637357667853932');" onmouseout="out('5710637357667853932');" style=""> 128     @PersistenceContext(unitName = &quot;blPU&quot;)                                                               </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 129     protected EntityManager em;                                                                          </span>
<span  style=""> 130                                                                                                          </span>
<span class="-3119890949520834785" onmouseenter="enter('-3119890949520834785');" onmouseout="out('-3119890949520834785');" style=""> 131     @Resource(name = &quot;blResourcePurgeExtensionManager&quot;)                                                  </span>
<span class="8180782340617912300" onmouseenter="enter('8180782340617912300');" onmouseout="out('8180782340617912300');" style=""> 132     protected ResourcePurgeExtensionManager extensionManager;                                            </span>
<span  style=""> 133                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134     @Override                                                                                            </span>
<span class="4309385457274814832" onmouseenter="enter('4309385457274814832');" onmouseout="out('4309385457274814832');" style=""> 135     public void purgeCarts(final Map&lt;String, String&gt; config) {                                           </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 136         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="5550302810575666152" onmouseenter="enter('5550302810575666152');" onmouseout="out('5550302810575666152');" style=""> 137             LOG.debug(&quot;Purging carts&quot;);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 139         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style=""><abbr title=" 140             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; +"> 140             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration proviðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 141                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 143         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 144         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="-6288858101655041374" onmouseenter="enter('-6288858101655041374');" onmouseout="out('-6288858101655041374');" style=""> 145         synchronized(cartPurgeErrors) {                                                                  </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 146             Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                              </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style=""><abbr title=" 147             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();"> 147             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue(ðŸ”µ</abbr></span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style=""><abbr title=" 148             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));"> 148             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCarðŸ”µ</abbr></span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 149             for (Order cart : carts) {                                                                   </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 150                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,              </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 151                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 152                 try {                                                                                    </span>
<span class="4510796021165287410" onmouseenter="enter('4510796021165287410');" onmouseout="out('4510796021165287410');" style=""> 153                     deleteCart(cart);                                                                    </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 154                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 155                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 156                 } catch (Exception e) {                                                                  </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 157                     if (! status.isCompleted()) {                                                        </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 158                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159                     }                                                                                    </span>
<span class="5109618921839591834" onmouseenter="enter('5109618921839591834');" onmouseout="out('5109618921839591834');" style=""> 160                     LOG.error(String.format(&quot;Not able to purge Cart ID: %d&quot;, cart.getId()), e);          </span>
<span class="-4853598595361674600" onmouseenter="enter('-4853598595361674600');" onmouseout="out('-4853598595361674600');" style=""> 161                     cartPurgeErrors.add(cart.getId());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164         }                                                                                                </span>
<span class="7794934293570296678" onmouseenter="enter('7794934293570296678');" onmouseout="out('7794934293570296678');" style=""><abbr title=" 165         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, cartPurgeErrors.size()));"> 165         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d faðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166     }                                                                                                    </span>
<span  style=""> 167                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 168     @Override                                                                                            </span>
<span class="-3155325957841664585" onmouseenter="enter('-3155325957841664585');" onmouseout="out('-3155325957841664585');" style=""> 169     public void notifyCarts(final Map&lt;String, String&gt; config) {                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 170         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-3286686306843613123" onmouseenter="enter('-3286686306843613123');" onmouseout="out('-3286686306843613123');" style=""> 171             LOG.debug(&quot;Notifying carts of purge&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 173         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="2705292744574863925" onmouseenter="enter('2705292744574863925');" onmouseout="out('2705292744574863925');" style=""><abbr title=" 174             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuration provided. &quot; +"> 174             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuraðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 175                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 177         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="8814839157010793891" onmouseenter="enter('8814839157010793891');" onmouseout="out('8814839157010793891');" style=""> 178         int batchCount = 0;                                                                              </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 179         Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                  </span>
<span class="2835180694455823862" onmouseenter="enter('2835180694455823862');" onmouseout="out('2835180694455823862');" style=""> 180         batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;&gt;(failedCartIds)).intValue();      </span>
<span class="-5922847017937203398" onmouseenter="enter('-5922847017937203398');" onmouseout="out('-5922847017937203398');" style=""> 181         List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;&gt;(failedCartIds)); </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 182         for (Order cart : carts) {                                                                       </span>
<span class="2587782700097468426" onmouseenter="enter('2587782700097468426');" onmouseout="out('2587782700097468426');" style=""> 183             notifyCart(cart);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span  style=""> 186                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 187     @Override                                                                                            </span>
<span class="-1802669755772945786" onmouseenter="enter('-1802669755772945786');" onmouseout="out('-1802669755772945786');" style=""><abbr title=" 188     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; depends, final Map&lt;String, Integer&gt; config) {"> 188     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStateðŸ”µ</abbr></span>
<span  style=""> 189                                                                                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 190         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-8653909733810486694" onmouseenter="enter('-8653909733810486694');" onmouseout="out('-8653909733810486694');" style=""> 191             LOG.debug(&quot;Purging historical orders&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192         }                                                                                                </span>
<span  style=""> 193                                                                                                          </span>
<span class="-3654204218851766889" onmouseenter="enter('-3654204218851766889');" onmouseout="out('-3654204218851766889');" style=""> 194         String enablePurge = env.getProperty(&quot;enable.purge.order.history&quot;);                              </span>
<span  style=""> 195                                                                                                          </span>
<span class="-6307477278678171490" onmouseenter="enter('-6307477278678171490');" onmouseout="out('-6307477278678171490');" style=""> 196         if (!Boolean.parseBoolean(enablePurge)) {                                                        </span>
<span class="-3484703522134094040" onmouseenter="enter('-3484703522134094040');" onmouseout="out('-3484703522134094040');" style=""><abbr title=" 197             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.history to true.&quot;);"> 197             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.hisðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 198             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199         }                                                                                                </span>
<span  style=""> 200                                                                                                          </span>
<span class="-2659324279400027158" onmouseenter="enter('-2659324279400027158');" onmouseout="out('-2659324279400027158');" style=""> 201         Integer daysCount = config.get(PurgeOrderHistoryVariableNames.OLDER_THAN_DAYS.toString());       </span>
<span class="8879960017039434329" onmouseenter="enter('8879960017039434329');" onmouseout="out('8879960017039434329');" style=""> 202         Integer batchSize = config.get(PurgeOrderHistoryVariableNames.BATCH_SIZE.toString());            </span>
<span  style=""> 203                                                                                                          </span>
<span class="2743860540483018997" onmouseenter="enter('2743860540483018997');" onmouseout="out('2743860540483018997');" style=""> 204         List&lt;Order&gt; oldOrders = orderService.findOrdersByDaysCount(daysCount, batchSize);                </span>
<span class="8291766046289306970" onmouseenter="enter('8291766046289306970');" onmouseout="out('8291766046289306970');" style=""><abbr title=" 205         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends);"> 205         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends)ðŸ”µ</abbr></span>
<span  style=""> 206                                                                                                          </span>
<span class="-4732634170977321510" onmouseenter="enter('-4732634170977321510');" onmouseout="out('-4732634170977321510');" style=""> 207         List&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderDependencies = new ArrayList&lt;&gt;();            </span>
<span  style=""> 208                                                                                                          </span>
<span class="8048050619804607819" onmouseenter="enter('8048050619804607819');" onmouseout="out('8048050619804607819');" style=""><abbr title=" 209         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, &quot;ORDER_ID&quot;));"> 209         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, ðŸ”µ</abbr></span>
<span  style=""> 210                                                                                                          </span>
<span class="7928252889655920702" onmouseenter="enter('7928252889655920702');" onmouseout="out('7928252889655920702');" style=""> 211         dependencies.put(&quot;BLC_ORDER&quot;, orderDependencies);                                                </span>
<span  style=""> 212                                                                                                          </span>
<span class="1355272824006853176" onmouseenter="enter('1355272824006853176');" onmouseout="out('1355272824006853176');" style=""> 213         ArrayList&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderItemDependencies = new ArrayList&lt;&gt;();   </span>
<span class="6007887936589274996" onmouseenter="enter('6007887936589274996');" onmouseout="out('6007887936589274996');" style=""><abbr title=" 214         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, &quot;ORDER_MULTISHIP_OPTION_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 214         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, ðŸ”µ</abbr></span>
<span class="8628014233398989009" onmouseenter="enter('8628014233398989009');" onmouseout="out('8628014233398989009');" style=""><abbr title=" 215         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORDER_ITEM_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 215         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORðŸ”µ</abbr></span>
<span class="-4082949278907558346" onmouseenter="enter('-4082949278907558346');" onmouseout="out('-4082949278907558346');" style=""> 216         dependencies.put(&quot;BLC_ORDER_ITEM&quot;, orderItemDependencies);                                       </span>
<span class="-7586552207458707428" onmouseenter="enter('-7586552207458707428');" onmouseout="out('-7586552207458707428');" style=""><abbr title=" 217         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_PAYMENT_LOG&quot;, &quot;ORDER_PAYMENT_ID&quot;, &quot;ORDER_PAYMENT_ID&quot;)));"> 217         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.ðŸ”µ</abbr></span>
<span class="6578497182871896533" onmouseenter="enter('6578497182871896533');" onmouseout="out('6578497182871896533');" style=""> 218         extensionManager.getProxy().addPurgeDependencies(dependencies);                                  </span>
<span class="4830318402684525340" onmouseenter="enter('4830318402684525340');" onmouseout="out('4830318402684525340');" style=""> 219         Set&lt;String&gt; exclusions = new HashSet&lt;&gt;();                                                        </span>
<span class="-4430846773603202851" onmouseenter="enter('-4430846773603202851');" onmouseout="out('-4430846773603202851');" style=""> 220         exclusions.add(&quot;BLC_ADMIN_USER&quot;);                                                                </span>
<span class="34011160929975445" onmouseenter="enter('34011160929975445');" onmouseout="out('34011160929975445');" style=""> 221         extensionManager.getProxy().addPurgeExclusions(exclusions);                                      </span>
<span class="4783797439534498468" onmouseenter="enter('4783797439534498468');" onmouseout="out('4783797439534498468');" style=""><abbr title=" 222         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrderImpl.class, &quot;?&quot;, dependencies, exclusions);"> 222         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrðŸ”µ</abbr></span>
<span class="3783061397625598902" onmouseenter="enter('3783061397625598902');" onmouseout="out('3783061397625598902');" style=""> 223         for (Order order : oldOrders) {                                                                  </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 224             TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                  </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 225                     TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 226             try {                                                                                        </span>
<span class="-8448685700561076869" onmouseenter="enter('-8448685700561076869');" onmouseout="out('-8448685700561076869');" style=""> 227                 em.unwrap(Session.class).doWork(new Work() {                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 228                     @Override                                                                            </span>
<span class="-4124393681745953188" onmouseenter="enter('-4124393681745953188');" onmouseout="out('-4124393681745953188');" style=""> 229                     public void execute(Connection connection) throws SQLException {                     </span>
<span class="-7878705497542337751" onmouseenter="enter('-7878705497542337751');" onmouseout="out('-7878705497542337751');" style=""> 230                         Statement statement = connection.createStatement();                              </span>
<span class="-3449158197612158484" onmouseenter="enter('-3449158197612158484');" onmouseout="out('-3449158197612158484');" style=""> 231                         for (String value : deleteStatement.values()) {                                  </span>
<span class="-4055740799466096202" onmouseenter="enter('-4055740799466096202');" onmouseout="out('-4055740799466096202');" style=""> 232                             String sql = value.replace(&quot;?&quot;, String.valueOf(order.getId()));              </span>
<span class="5121719000459724566" onmouseenter="enter('5121719000459724566');" onmouseout="out('5121719000459724566');" style=""> 233                             LOG.debug(sql);                                                              </span>
<span class="5795758955073093328" onmouseenter="enter('5795758955073093328');" onmouseout="out('5795758955073093328');" style=""> 234                             statement.addBatch(sql);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235                         }                                                                                </span>
<span class="2322675505205288495" onmouseenter="enter('2322675505205288495');" onmouseout="out('2322675505205288495');" style=""> 236                         extensionManager.getProxy().addPurgeStatements(statement, rootTypeIdValue);      </span>
<span class="-1332092965431964598" onmouseenter="enter('-1332092965431964598');" onmouseout="out('-1332092965431964598');" style=""> 237                         statement.executeBatch();                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238                     }                                                                                    </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 239                 });                                                                                      </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 240                 TransactionUtils.finalizeTransaction(status, transactionManager, false);                 </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 241             } catch (Exception e) {                                                                      </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style=""> 242                 if (!status.isCompleted()) {                                                             </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 243                     TransactionUtils.finalizeTransaction(status, transactionManager, true);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                 }                                                                                        </span>
<span class="5843261671853400812" onmouseenter="enter('5843261671853400812');" onmouseout="out('5843261671853400812');" style=""> 245                 LOG.error(String.format(&quot;Not able to purge Order ID: %d&quot;, order.getId()), e);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247         }                                                                                                </span>
<span  style=""> 248                                                                                                          </span>
<span class="-1073654053478996749" onmouseenter="enter('-1073654053478996749');" onmouseout="out('-1073654053478996749');" style=""> 249         LOG.info(&quot;Finished purging historical orders.&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250     }                                                                                                    </span>
<span  style=""> 251                                                                                                          </span>
<span  style=""> 252                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 253     @Override                                                                                            </span>
<span class="4447368119484600014" onmouseenter="enter('4447368119484600014');" onmouseout="out('4447368119484600014');" style=""> 254     public void purgeCustomers(final Map&lt;String, String&gt; config) {                                       </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 255         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="1532316588592469018" onmouseenter="enter('1532316588592469018');" onmouseout="out('1532316588592469018');" style=""> 256             LOG.debug(&quot;Purging customers&quot;);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 258         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="362564872021724408" onmouseenter="enter('362564872021724408');" onmouseout="out('362564872021724408');" style=""><abbr title=" 259             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. &quot; +"> 259             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration pðŸ”µ</abbr></span>
<span class="-7406017465356863948" onmouseenter="enter('-7406017465356863948');" onmouseout="out('-7406017465356863948');" style=""> 260                     &quot;In the absence of config params, all customers would be candidates for deletion.&quot;); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="-2250958415199181791" onmouseenter="enter('-2250958415199181791');" onmouseout="out('-2250958415199181791');" style=""> 262         CustomerPurgeParams purgeParams = new CustomerPurgeParams(config).invoke();                      </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 263         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="7229609060981046917" onmouseenter="enter('7229609060981046917');" onmouseout="out('7229609060981046917');" style=""> 264         synchronized(customerPurgeErrors) {                                                              </span>
<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style=""> 265             Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                      </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style=""><abbr title=" 266             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 266             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).iðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style=""><abbr title=" 267             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 267             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;LongðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style=""> 268             for (Customer customer : customers) {                                                        </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style=""> 269                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,          </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 270                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 271                 try {                                                                                    </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style=""> 272                     deleteCustomer(customer);                                                            </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 273                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 274                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 275                 } catch (Exception e) {                                                                  </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 276                     if (! status.isCompleted()) {                                                        </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 277                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278                     }                                                                                    </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style=""> 279                     LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);  </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style=""> 280                     customerPurgeErrors.add(customer.getId());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 281                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 282             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283         }                                                                                                </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style=""><abbr title=" 284         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 284         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 287     /**                                                                                                  </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style=""><abbr title=" 288      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 288      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  ExpðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 289      *                                                                                                   </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style=""> 290      * @param purgeParams configured parameters for the cart purge process                               </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style=""> 291      * @return set of cart ids to ignore/exclude from the next purge run                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 292      */                                                                                                  </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style=""> 293     protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                           </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 294         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style=""> 295         Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);         </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style=""> 296         return ignoreFailedCartIds;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 297     }                                                                                                    </span>
<span  style=""> 298                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 299     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 300      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 300      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 301      *                                                                                                   </span>
<span class="2629836549582755488" onmouseenter="enter('2629836549582755488');" onmouseout="out('2629836549582755488');" style=""> 302      * @param purgeParams  configured parameters for the Cart purge process                              </span>
<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style=""> 303      * @param cartsInError list of cart ids to be ignored/excluded from the query                        </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style=""> 304      * @return list of carts to delete                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 305      */                                                                                                  </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style=""><abbr title=" 306     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 306     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;LonðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 307         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 308         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 309         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 310         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style=""><abbr title=" 311         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 311         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312     }                                                                                                    </span>
<span  style=""> 313                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 314     /**                                                                                                  </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style=""><abbr title=" 315      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 315      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 316      *                                                                                                   </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style=""> 317      * @param purgeParams configured parameters for the Customer purge process used in the query         </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style=""> 318      * @param cartsInError list of cart ids to ignore/exclude from the next purge run                    </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style=""> 319      * @return count of carts to delete                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 320      */                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 321     /**                                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 322      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 323      */                                                                                                  </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style=""> 324     protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {         </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 325         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 326         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 327         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 328         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style=""> 329         Long cartBatchSize = purgeParams.getBatchSize();                                                 </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style=""><abbr title=" 330         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 330         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThresholdðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style=""> 331         //return the lesser of the parameter batch size of the count of the orders to purge              </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style=""> 332         return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333     }                                                                                                    </span>
<span  style=""> 334                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 335     /**                                                                                                  </span>
<span class="-4831217906829284324" onmouseenter="enter('-4831217906829284324');" onmouseout="out('-4831217906829284324');" style=""> 336      * Notify the cart&#x27;s owner of a pending purge of their cart.                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 337      *                                                                                                   </span>
<span class="-1591121872845752466" onmouseenter="enter('-1591121872845752466');" onmouseout="out('-1591121872845752466');" style=""> 338      * @param cart the cart                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 339      */                                                                                                  </span>
<span class="-1439517530326153748" onmouseenter="enter('-1439517530326153748');" onmouseout="out('-1439517530326153748');" style=""> 340     protected void notifyCart(Order cart) {                                                              </span>
<span class="6785017572112928400" onmouseenter="enter('6785017572112928400');" onmouseout="out('6785017572112928400');" style=""> 341         String emailAddress = getEmailForCart(cart);                                                     </span>
<span class="-8702812354445074278" onmouseenter="enter('-8702812354445074278');" onmouseout="out('-8702812354445074278');" style=""> 342         if (emailAddress != null) {                                                                      </span>
<span class="4884753630904156580" onmouseenter="enter('4884753630904156580');" onmouseout="out('4884753630904156580');" style=""> 343             Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();                                               </span>
<span class="-1876686562124284125" onmouseenter="enter('-1876686562124284125');" onmouseout="out('-1876686562124284125');" style=""> 344             context.put(&quot;cart&quot;, cart);                                                                   </span>
<span class="-7081183395280146833" onmouseenter="enter('-7081183395280146833');" onmouseout="out('-7081183395280146833');" style=""> 345             context.put(&quot;customer&quot;, cart.getCustomer());                                                 </span>
<span class="2299045321537655635" onmouseenter="enter('2299045321537655635');" onmouseout="out('2299045321537655635');" style=""> 346             context.put(&quot;emailAddress&quot;, emailAddress);                                                   </span>
<span  style=""> 347                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 348             try {                                                                                        </span>
<span class="-335501726229324372" onmouseenter="enter('-335501726229324372');" onmouseout="out('-335501726229324372');" style=""><abbr title=" 349                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificationEventType.NOTIFY_ABANDONED_CART, context));"> 349                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificatðŸ”µ</abbr></span>
<span class="9220844322816084446" onmouseenter="enter('9220844322816084446');" onmouseout="out('9220844322816084446');" style=""> 350             } catch (ServiceException e) {                                                               </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 351                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-238742426127135817" onmouseenter="enter('-238742426127135817');" onmouseout="out('-238742426127135817');" style=""> 352                     LOG.debug(&quot;Failure to send email notification&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 353                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356     }                                                                                                    </span>
<span  style=""> 357                                                                                                          </span>
<span class="962012931445232765" onmouseenter="enter('962012931445232765');" onmouseout="out('962012931445232765');" style=""> 358     protected String getEmailForCart(Order cart) {                                                       </span>
<span class="-1013041921655187511" onmouseenter="enter('-1013041921655187511');" onmouseout="out('-1013041921655187511');" style=""> 359         if (cart.getEmailAddress() != null) {                                                            </span>
<span class="9127709401881574307" onmouseenter="enter('9127709401881574307');" onmouseout="out('9127709401881574307');" style=""> 360             return cart.getEmailAddress();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 361         }                                                                                                </span>
<span  style=""> 362                                                                                                          </span>
<span class="-4914468579235587722" onmouseenter="enter('-4914468579235587722');" onmouseout="out('-4914468579235587722');" style=""> 363         if (cart.getCustomer() != null &amp;&amp; cart.getCustomer().getEmailAddress() != null) {                </span>
<span class="4109268194947089596" onmouseenter="enter('4109268194947089596');" onmouseout="out('4109268194947089596');" style=""> 364             return cart.getCustomer().getEmailAddress();                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365         }                                                                                                </span>
<span  style=""> 366                                                                                                          </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 367         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 368     }                                                                                                    </span>
<span  style=""> 369                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 370     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 371      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 371      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 372      *                                                                                                   </span>
<span class="-6771798214247950041" onmouseenter="enter('-6771798214247950041');" onmouseout="out('-6771798214247950041');" style=""> 373      * @param cart the cart to remove                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 374      */                                                                                                  </span>
<span class="621215427910457813" onmouseenter="enter('621215427910457813');" onmouseout="out('621215427910457813');" style=""> 375     protected void deleteCart(Order cart) {                                                              </span>
<span class="-3274557726078521593" onmouseenter="enter('-3274557726078521593');" onmouseout="out('-3274557726078521593');" style=""><abbr title=" 376         //We delete the order this way (rather than with a delete query) in order to ensure the cascades take place"> 376         //We delete the order this way (rather than with a delete query) in order to ensure the cascades ðŸ”µ</abbr></span>
<span class="5643426177894030209" onmouseenter="enter('5643426177894030209');" onmouseout="out('5643426177894030209');" style=""> 377         orderService.deleteOrder(cart);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378     }                                                                                                    </span>
<span  style=""> 379                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 380     /**                                                                                                  </span>
<span class="3205340653525749512" onmouseenter="enter('3205340653525749512');" onmouseout="out('3205340653525749512');" style=""> 381      * Get the Customer Ids from cache that should be ignored due to errors in previous purge attempts   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 382      *                                                                                                   </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 383      * @param purgeParams configured parameters for the Customer purge process                           </span>
<span class="-5970206514796632950" onmouseenter="enter('-5970206514796632950');" onmouseout="out('-5970206514796632950');" style=""> 384      * @return set of customer ids to ignore/exclude from the next purge run                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 385      */                                                                                                  </span>
<span class="-3065693137793837519" onmouseenter="enter('-3065693137793837519');" onmouseout="out('-3065693137793837519');" style=""> 386     protected Set&lt;Long&gt; getCustomersInErrorToIgnore(CustomerPurgeParams purgeParams) {                   </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 387         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-7599335319839599610" onmouseenter="enter('-7599335319839599610');" onmouseout="out('-7599335319839599610');" style=""> 388         Set&lt;Long&gt; ignoreFailedCustomerIds = customerPurgeErrors.getEntriesSince(ignoreFailedExpiration); </span>
<span class="-6742430259144212604" onmouseenter="enter('-6742430259144212604');" onmouseout="out('-6742430259144212604');" style=""> 389         return ignoreFailedCustomerIds;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390     }                                                                                                    </span>
<span  style=""> 391                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 392     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 393      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 393      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 394      *                                                                                                   </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style=""> 395      * @param purgeParams      configured parameters for the Customer purge process                      </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 396      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="6504215439929103259" onmouseenter="enter('6504215439929103259');" onmouseout="out('6504215439929103259');" style=""> 397      * @return list of customers to delete                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 398      */                                                                                                  </span>
<span class="-1507004170363559761" onmouseenter="enter('-1507004170363559761');" onmouseout="out('-1507004170363559761');" style=""><abbr title=" 399     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; customersInError) {"> 399     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int lengtðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 400         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 401         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 402         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 403         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-2312253704458899930" onmouseenter="enter('-2312253704458899930');" onmouseout="out('-2312253704458899930');" style=""><abbr title=" 404         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, startPos, length, customersInError);"> 404         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 405     }                                                                                                    </span>
<span  style=""> 406                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 407     /**                                                                                                  </span>
<span class="8648259411111567723" onmouseenter="enter('8648259411111567723');" onmouseout="out('8648259411111567723');" style=""><abbr title=" 408      * Get the count of customers to delete from the database. Subclasses may override for custom customer retrieval logic."> 408      * Get the count of customers to delete from the database. Subclasses may override for custom customeðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 409      *                                                                                                   </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style=""> 410      * @param purgeParams      configured parameters for the Customer purge process                      </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 411      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 412      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 413      */                                                                                                  </span>
<span class="8294886805011187143" onmouseenter="enter('8294886805011187143');" onmouseout="out('8294886805011187143');" style=""><abbr title=" 414     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInError) {"> 414     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInErrorðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 415         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 416         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 417         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 418         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-6790142400743483163" onmouseenter="enter('-6790142400743483163');" onmouseout="out('-6790142400743483163');" style=""> 419         Long customerBatchSize = purgeParams.getBatchSize();                                             </span>
<span class="-6217873247193256304" onmouseenter="enter('-6217873247193256304');" onmouseout="out('-6217873247193256304');" style=""><abbr title=" 420         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, customersInError);"> 420         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, ðŸ”µ</abbr></span>
<span class="-4628315344870235824" onmouseenter="enter('-4628315344870235824');" onmouseout="out('-4628315344870235824');" style=""> 421         //return the lesser of the parameter batch size of the count of the customers to purge           </span>
<span class="-6036527682216446677" onmouseenter="enter('-6036527682216446677');" onmouseout="out('-6036527682216446677');" style=""><abbr title=" 422         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCount;"> 422         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : custðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423     }                                                                                                    </span>
<span  style=""> 424                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 425     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 426      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 426      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 427      *                                                                                                   </span>
<span class="-897887194989371766" onmouseenter="enter('-897887194989371766');" onmouseout="out('-897887194989371766');" style=""> 428      * @param customer the customer to remove                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 429      */                                                                                                  </span>
<span class="9030957329407065452" onmouseenter="enter('9030957329407065452');" onmouseout="out('9030957329407065452');" style=""> 430     protected void deleteCustomer(Customer customer) {                                                   </span>
<span class="-4425816966306665584" onmouseenter="enter('-4425816966306665584');" onmouseout="out('-4425816966306665584');" style=""><abbr title=" 431         //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take place"> 431         //We delete the customer this way (rather than with a delete query) in order to ensure the cascadðŸ”µ</abbr></span>
<span class="4420445378351605906" onmouseenter="enter('4420445378351605906');" onmouseout="out('4420445378351605906');" style=""> 432         customerService.deleteCustomer(customer);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433     }                                                                                                    </span>
<span  style=""> 434                                                                                                          </span>
<span class="2605850108496977404" onmouseenter="enter('2605850108496977404');" onmouseout="out('2605850108496977404');" style=""> 435     private class CartPurgeParams {                                                                      </span>
<span  style=""> 436                                                                                                          </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 437         private Map&lt;String, String&gt; config;                                                              </span>
<span class="1381900387592843642" onmouseenter="enter('1381900387592843642');" onmouseout="out('1381900387592843642');" style=""> 438         private String[] nameArray;                                                                      </span>
<span class="8331062799574265987" onmouseenter="enter('8331062799574265987');" onmouseout="out('8331062799574265987');" style=""> 439         private OrderStatus[] statusArray;                                                               </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 440         private Date dateCreatedMinThreshold;                                                            </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 441         private Boolean isPreview;                                                                       </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 442         private Long batchSize;                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 443         private Long failedRetryTime;                                                                    </span>
<span  style=""> 444                                                                                                          </span>
<span class="2815224750970340197" onmouseenter="enter('2815224750970340197');" onmouseout="out('2815224750970340197');" style=""> 445         public CartPurgeParams(Map&lt;String, String&gt; config) {                                             </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 446             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 447         }                                                                                                </span>
<span  style=""> 448                                                                                                          </span>
<span class="-686271337436163522" onmouseenter="enter('-686271337436163522');" onmouseout="out('-686271337436163522');" style=""> 449         public String[] getNameArray() {                                                                 </span>
<span class="-6597175720812897488" onmouseenter="enter('-6597175720812897488');" onmouseout="out('-6597175720812897488');" style=""> 450             return nameArray;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 451         }                                                                                                </span>
<span  style=""> 452                                                                                                          </span>
<span class="-4470666030488291109" onmouseenter="enter('-4470666030488291109');" onmouseout="out('-4470666030488291109');" style=""> 453         public OrderStatus[] getStatusArray() {                                                          </span>
<span class="1669553314396389775" onmouseenter="enter('1669553314396389775');" onmouseout="out('1669553314396389775');" style=""> 454             return statusArray;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455         }                                                                                                </span>
<span  style=""> 456                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 457         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 458             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459         }                                                                                                </span>
<span  style=""> 460                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 461         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 462             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463         }                                                                                                </span>
<span  style=""> 464                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 465         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 466             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467         }                                                                                                </span>
<span  style=""> 468                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 469         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 470             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471         }                                                                                                </span>
<span  style=""> 472                                                                                                          </span>
<span class="-2086671766953086341" onmouseenter="enter('-2086671766953086341');" onmouseout="out('-2086671766953086341');" style=""> 473         public CartPurgeParams invoke() {                                                                </span>
<span class="2406323390572474949" onmouseenter="enter('2406323390572474949');" onmouseout="out('2406323390572474949');" style=""> 474             nameArray = null;                                                                            </span>
<span class="-8056479474459794956" onmouseenter="enter('-8056479474459794956');" onmouseout="out('-8056479474459794956');" style=""> 475             statusArray = null;                                                                          </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 476             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 477             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 478             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 479             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span  style=""> 480                                                                                                          </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 481             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="7230126592195401480" onmouseenter="enter('7230126592195401480');" onmouseout="out('7230126592195401480');" style=""> 482                 if (PurgeCartVariableNames.STATUS.toString().equals(entry.getKey())) {                   </span>
<span class="-3887059016856253482" onmouseenter="enter('-3887059016856253482');" onmouseout="out('-3887059016856253482');" style=""> 483                     String[] temp = entry.getValue().split(&quot;,&quot;);                                         </span>
<span class="-984189042629809269" onmouseenter="enter('-984189042629809269');" onmouseout="out('-984189042629809269');" style=""> 484                     statusArray = new OrderStatus[temp.length];                                          </span>
<span class="7424479410662112456" onmouseenter="enter('7424479410662112456');" onmouseout="out('7424479410662112456');" style=""> 485                     int index = 0;                                                                       </span>
<span class="-6857112710843456451" onmouseenter="enter('-6857112710843456451');" onmouseout="out('-6857112710843456451');" style=""> 486                     for (String name : temp) {                                                           </span>
<span class="4249642856708256048" onmouseenter="enter('4249642856708256048');" onmouseout="out('4249642856708256048');" style=""> 487                         OrderStatus orderStatus = OrderStatus.getInstance(name);                         </span>
<span class="354647143791226174" onmouseenter="enter('354647143791226174');" onmouseout="out('354647143791226174');" style=""> 488                         statusArray[index] = orderStatus;                                                </span>
<span class="8743575581853771534" onmouseenter="enter('8743575581853771534');" onmouseout="out('8743575581853771534');" style=""> 489                         index++;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 491                 }                                                                                        </span>
<span class="-680570050183499360" onmouseenter="enter('-680570050183499360');" onmouseout="out('-680570050183499360');" style=""> 492                 if (PurgeCartVariableNames.NAME.toString().equals(entry.getKey())) {                     </span>
<span class="3793410955933370059" onmouseenter="enter('3793410955933370059');" onmouseout="out('3793410955933370059');" style=""> 493                     nameArray = entry.getValue().split(&quot;,&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494                 }                                                                                        </span>
<span class="5654291195038602061" onmouseenter="enter('5654291195038602061');" onmouseout="out('5654291195038602061');" style=""> 495                 if (PurgeCartVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {              </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 496                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 497                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 498                 }                                                                                        </span>
<span class="-3116043338550155301" onmouseenter="enter('-3116043338550155301');" onmouseout="out('-3116043338550155301');" style=""> 499                 if (PurgeCartVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {               </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 500                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501                 }                                                                                        </span>
<span class="-7209605236483980682" onmouseenter="enter('-7209605236483980682');" onmouseout="out('-7209605236483980682');" style=""> 502                 if (PurgeCartVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {               </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 503                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504                 }                                                                                        </span>
<span class="6665497140882829750" onmouseenter="enter('6665497140882829750');" onmouseout="out('6665497140882829750');" style=""> 505                 if (PurgeCartVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {     </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 506                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 506                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 509             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511     }                                                                                                    </span>
<span  style=""> 512                                                                                                          </span>
<span class="6135355437794836082" onmouseenter="enter('6135355437794836082');" onmouseout="out('6135355437794836082');" style=""> 513     private class CustomerPurgeParams {                                                                  </span>
<span  style=""> 514                                                                                                          </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 515         private Map&lt;String, String&gt; config;                                                              </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 516         private Date dateCreatedMinThreshold;                                                            </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 517         private Boolean isPreview;                                                                       </span>
<span class="5345429142323969812" onmouseenter="enter('5345429142323969812');" onmouseout="out('5345429142323969812');" style=""> 518         private Boolean isRegistered;                                                                    </span>
<span class="3484617240152312252" onmouseenter="enter('3484617240152312252');" onmouseout="out('3484617240152312252');" style=""> 519         private Boolean isDeactivated;                                                                   </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 520         private Long batchSize;                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 521         private Long failedRetryTime;                                                                    </span>
<span  style=""> 522                                                                                                          </span>
<span class="-3439970468083719495" onmouseenter="enter('-3439970468083719495');" onmouseout="out('-3439970468083719495');" style=""> 523         public CustomerPurgeParams(Map&lt;String, String&gt; config) {                                         </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 524             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525         }                                                                                                </span>
<span  style=""> 526                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 527         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 528             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 529         }                                                                                                </span>
<span  style=""> 530                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 531         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 532             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533         }                                                                                                </span>
<span  style=""> 534                                                                                                          </span>
<span class="-4523160162166092089" onmouseenter="enter('-4523160162166092089');" onmouseout="out('-4523160162166092089');" style=""> 535         public Boolean getIsRegistered() {                                                               </span>
<span class="6500879271821699409" onmouseenter="enter('6500879271821699409');" onmouseout="out('6500879271821699409');" style=""> 536             return isRegistered;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537         }                                                                                                </span>
<span  style=""> 538                                                                                                          </span>
<span class="831937501284736178" onmouseenter="enter('831937501284736178');" onmouseout="out('831937501284736178');" style=""> 539         public Boolean getIsDeactivated() {                                                              </span>
<span class="-8572023523120285779" onmouseenter="enter('-8572023523120285779');" onmouseout="out('-8572023523120285779');" style=""> 540             return isDeactivated;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541         }                                                                                                </span>
<span  style=""> 542                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 543         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 544             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545         }                                                                                                </span>
<span  style=""> 546                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 547         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 548             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 549         }                                                                                                </span>
<span  style=""> 550                                                                                                          </span>
<span class="4345643298854756592" onmouseenter="enter('4345643298854756592');" onmouseout="out('4345643298854756592');" style=""> 551         public CustomerPurgeParams invoke() {                                                            </span>
<span class="-2554699908388798358" onmouseenter="enter('-2554699908388798358');" onmouseout="out('-2554699908388798358');" style=""> 552             isRegistered = null;                                                                         </span>
<span class="-4109360067770509892" onmouseenter="enter('-4109360067770509892');" onmouseout="out('-4109360067770509892');" style=""> 553             isDeactivated = null;                                                                        </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 554             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 555             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 556             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 557             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span  style=""> 558                                                                                                          </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 559             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="8500820035603099955" onmouseenter="enter('8500820035603099955');" onmouseout="out('8500820035603099955');" style=""> 560                 if (PurgeCustomerVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {          </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 561                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 562                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 563                 }                                                                                        </span>
<span class="472649037401986768" onmouseenter="enter('472649037401986768');" onmouseout="out('472649037401986768');" style=""> 564                 if (PurgeCustomerVariableNames.IS_REGISTERED.toString().equals(entry.getKey())) {        </span>
<span class="3066848756297460347" onmouseenter="enter('3066848756297460347');" onmouseout="out('3066848756297460347');" style=""> 565                     isRegistered = Boolean.parseBoolean(entry.getValue());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566                 }                                                                                        </span>
<span class="-6798790184150039593" onmouseenter="enter('-6798790184150039593');" onmouseout="out('-6798790184150039593');" style=""> 567                 if (PurgeCustomerVariableNames.IS_DEACTIVATED.toString().equals(entry.getKey())) {       </span>
<span class="8770174800886691615" onmouseenter="enter('8770174800886691615');" onmouseout="out('8770174800886691615');" style=""> 568                     isDeactivated = Boolean.parseBoolean(entry.getValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 569                 }                                                                                        </span>
<span class="-4202787563999133129" onmouseenter="enter('-4202787563999133129');" onmouseout="out('-4202787563999133129');" style=""> 570                 if (PurgeCustomerVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {           </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 571                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572                 }                                                                                        </span>
<span class="2949192035259803609" onmouseenter="enter('2949192035259803609');" onmouseout="out('2949192035259803609');" style=""> 573                 if (PurgeCustomerVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {           </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 574                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575                 }                                                                                        </span>
<span class="3875509270375211860" onmouseenter="enter('3875509270375211860');" onmouseout="out('3875509270375211860');" style=""> 576                 if (PurgeCustomerVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) { </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 577                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 577                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 578                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 580             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 581         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582     }                                                                                                    </span>
<span  style=""> 583                                                                                                          </span>
<span class="-4423643614963439423" onmouseenter="enter('-4423643614963439423');" onmouseout="out('-4423643614963439423');" style=""> 584     private class PurgeErrorCache {                                                                      </span>
<span  style=""> 585                                                                                                          </span>
<span class="198672241784651248" onmouseenter="enter('198672241784651248');" onmouseout="out('198672241784651248');" style=""> 586         private Map&lt;Long, Long&gt; cache = new HashMap&lt;Long, Long&gt;();                                       </span>
<span  style=""> 587                                                                                                          </span>
<span class="-5066122402174219646" onmouseenter="enter('-5066122402174219646');" onmouseout="out('-5066122402174219646');" style=""> 588         public Long add(Long entry) {                                                                    </span>
<span class="7659524906429939754" onmouseenter="enter('7659524906429939754');" onmouseout="out('7659524906429939754');" style=""> 589             if (! cache.containsKey(entry)) {                                                            </span>
<span class="-1518558382272290563" onmouseenter="enter('-1518558382272290563');" onmouseout="out('-1518558382272290563');" style=""> 590                 return cache.put(entry, new Long(System.currentTimeMillis()));                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 591             }                                                                                            </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 592             return null;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593         }                                                                                                </span>
<span  style=""> 594                                                                                                          </span>
<span class="-5864460220203783413" onmouseenter="enter('-5864460220203783413');" onmouseout="out('-5864460220203783413');" style=""> 595         public Set&lt;Long&gt; getEntriesSince(long expiredTime) {                                             </span>
<span class="3678487184380758864" onmouseenter="enter('3678487184380758864');" onmouseout="out('3678487184380758864');" style=""> 596             for(Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext(); ) {  </span>
<span class="-7841947474939136830" onmouseenter="enter('-7841947474939136830');" onmouseout="out('-7841947474939136830');" style=""> 597                 Map.Entry&lt;Long, Long&gt; entry = item.next();                                               </span>
<span class="936602580368160114" onmouseenter="enter('936602580368160114');" onmouseout="out('936602580368160114');" style=""> 598                 if(entry.getValue().longValue() &lt; expiredTime) {                                         </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style=""> 599                   item.remove();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601             }                                                                                            </span>
<span class="4846818570039273159" onmouseenter="enter('4846818570039273159');" onmouseout="out('4846818570039273159');" style=""> 602             return cache.keySet();                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 603         }                                                                                                </span>
<span  style=""> 604                                                                                                          </span>
<span class="5501185527198334216" onmouseenter="enter('5501185527198334216');" onmouseout="out('5501185527198334216');" style=""> 605         public int size() {                                                                              </span>
<span class="4045092944756323954" onmouseenter="enter('4045092944756323954');" onmouseout="out('4045092944756323954');" style=""> 606             return cache.size();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607         }                                                                                                </span>
<span  style=""> 608                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609     }                                                                                                    </span>
<span  style=""> 610                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 611 }                                                                                                        </span>













































































































</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-392708096265613810" onmouseenter="enter('-392708096265613810');" onmouseout="out('-392708096265613810');" style="">  18 package org.broadleafcommerce.core.util.service;                                                         </span>
<span  style="">  19                                                                                                          </span>
<span class="-7136330293413175449" onmouseenter="enter('-7136330293413175449');" onmouseout="out('-7136330293413175449');" style="">  20 import java.sql.Connection;                                                                              </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  21 import java.sql.SQLException;                                                                            </span>
<span class="6402527026259660908" onmouseenter="enter('6402527026259660908');" onmouseout="out('6402527026259660908');" style="">  22 import java.sql.Statement;                                                                               </span>
<span class="196713859697444637" onmouseenter="enter('196713859697444637');" onmouseout="out('196713859697444637');" style="">  23 import java.util.*;                                                                                      </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  24 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  25 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  26 import javax.persistence.PersistenceContext;                                                             </span>
<span class="4020017653195254006" onmouseenter="enter('4020017653195254006');" onmouseout="out('4020017653195254006');" style="">  27 import org.apache.commons.collections.MapUtils;                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  28 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  29 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  30 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="7132038483204039493" onmouseenter="enter('7132038483204039493');" onmouseout="out('7132038483204039493');" style="">  31 import org.broadleafcommerce.common.notification.service.NotificationDispatcher;                         </span>
<span class="-840358981756149848" onmouseenter="enter('-840358981756149848');" onmouseout="out('-840358981756149848');" style="">  32 import org.broadleafcommerce.common.notification.service.type.EmailNotification;                         </span>
<span class="-7956607451590208760" onmouseenter="enter('-7956607451590208760');" onmouseout="out('-7956607451590208760');" style="">  33 import org.broadleafcommerce.common.notification.service.type.NotificationEventType;                     </span>
<span class="1373992879208813777" onmouseenter="enter('1373992879208813777');" onmouseout="out('1373992879208813777');" style="">  34 import org.broadleafcommerce.common.time.SystemTime;                                                     </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  35 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  36 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-9126455085472227806" onmouseenter="enter('-9126455085472227806');" onmouseout="out('-9126455085472227806');" style="">  37 import org.broadleafcommerce.core.order.domain.OrderImpl;                                                </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  38 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  39 import org.broadleafcommerce.core.order.service.type.OrderStatus;                                        </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="">  40 import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                             </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="">  41 import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                              </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="">  42 import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                          </span>
<span class="8877081811676575024" onmouseenter="enter('8877081811676575024');" onmouseout="out('8877081811676575024');" style="">  43 import org.broadleafcommerce.core.util.service.type.PurgeOrderHistoryVariableNames;                      </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  44 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="">  45 import org.broadleafcommerce.profile.core.service.CustomerService;                                       </span>
<span class="-1504015732959009083" onmouseenter="enter('-1504015732959009083');" onmouseout="out('-1504015732959009083');" style="">  46 import org.hibernate.Session;                                                                            </span>
<span class="1031102842064240387" onmouseenter="enter('1031102842064240387');" onmouseout="out('1031102842064240387');" style="">  47 import org.hibernate.jdbc.Work;                                                                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  48 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="">  49 import org.springframework.beans.factory.annotation.Qualifier;                                           </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  50 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  51 import org.springframework.stereotype.Service;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  52 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  53 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  54 import org.springframework.transaction.TransactionStatus;                                                </span>
<span  style="">  55                                                                                                          </span>
<span  style="">  56                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  57 /**                                                                                                      </span>
<span class="-3191869593089593640" onmouseenter="enter('-3191869593089593640');" onmouseout="out('-3191869593089593640');" style=""><abbr title="  58  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous Customers).">  58  * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymoðŸ”µ</abbr></span>
<span class="832835515286180797" onmouseenter="enter('832835515286180797');" onmouseout="out('832835515286180797');" style="">  59  * {@link ResourcePurgeService} for additional API documentation.                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  60  * &lt;p/&gt;                                                                                                  </span>
<span class="-315394129855994292" onmouseenter="enter('-315394129855994292');" onmouseout="out('-315394129855994292');" style="">  61  * A basic Quartz scheduled job configuration for calling this service can be configured as follows:     </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  62  * &lt;p/&gt;                                                                                                  </span>
<span class="-131984816008333551" onmouseenter="enter('-131984816008333551');" onmouseout="out('-131984816008333551');" style="">  63  * {@code                                                                                                </span>
<span class="8079836627557216097" onmouseenter="enter('8079836627557216097');" onmouseout="out('8079836627557216097');" style="">  64  * &lt;bean id=&quot;purgeCartConfig&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;           </span>
<span class="8809411245832543538" onmouseenter="enter('8809411245832543538');" onmouseout="out('8809411245832543538');" style="">  65  * &lt;property name=&quot;sourceMap&quot;&gt;                                                                           </span>
<span class="-4290418952995175850" onmouseenter="enter('-4290418952995175850');" onmouseout="out('-4290418952995175850');" style="">  66  * &lt;map&gt;                                                                                                 </span>
<span class="5370217760353547455" onmouseenter="enter('5370217760353547455');" onmouseout="out('5370217760353547455');" style="">  67  * &lt;entry key=&quot;SECONDS_OLD&quot; value=&quot;2592000&quot;/&gt;                                                            </span>
<span class="-1857330153031469850" onmouseenter="enter('-1857330153031469850');" onmouseout="out('-1857330153031469850');" style="">  68  * &lt;entry key=&quot;STATUS&quot; value=&quot;IN_PROCESS&quot;/&gt;                                                              </span>
<span class="-1596267147682690356" onmouseenter="enter('-1596267147682690356');" onmouseout="out('-1596267147682690356');" style="">  69  * &lt;/map&gt;                                                                                                </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  70  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  71  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  72  * &lt;p/&gt;                                                                                                  </span>
<span class="5857689149403140530" onmouseenter="enter('5857689149403140530');" onmouseout="out('5857689149403140530');" style=""><abbr title="  73  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;">  73  * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactðŸ”µ</abbr></span>
<span class="-390919979070777656" onmouseenter="enter('-390919979070777656');" onmouseout="out('-390919979070777656');" style="">  74  * &lt;property name=&quot;targetObject&quot; ref=&quot;blResourcePurgeService&quot; /&gt;                                         </span>
<span class="-1711168238872066589" onmouseenter="enter('-1711168238872066589');" onmouseout="out('-1711168238872066589');" style="">  75  * &lt;property name=&quot;targetMethod&quot; value=&quot;purgeCarts&quot; /&gt;                                                   </span>
<span class="4875414778543091051" onmouseenter="enter('4875414778543091051');" onmouseout="out('4875414778543091051');" style="">  76  * &lt;property name=&quot;arguments&quot;&gt;                                                                           </span>
<span class="6000473589228105200" onmouseenter="enter('6000473589228105200');" onmouseout="out('6000473589228105200');" style="">  77  * &lt;list&gt;                                                                                                </span>
<span class="-1321283090282055520" onmouseenter="enter('-1321283090282055520');" onmouseout="out('-1321283090282055520');" style="">  78  * &lt;ref bean=&quot;purgeCartConfig&quot;/&gt;                                                                         </span>
<span class="2486531046171828364" onmouseenter="enter('2486531046171828364');" onmouseout="out('2486531046171828364');" style="">  79  * &lt;/list&gt;                                                                                               </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  80  * &lt;/property&gt;                                                                                           </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  81  * &lt;/bean&gt;                                                                                               </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  82  * &lt;p/&gt;                                                                                                  </span>
<span class="-7915154528943636028" onmouseenter="enter('-7915154528943636028');" onmouseout="out('-7915154528943636028');" style="">  83  * &lt;bean id=&quot;purgeCartTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;   </span>
<span class="5235847799914996571" onmouseenter="enter('5235847799914996571');" onmouseout="out('5235847799914996571');" style="">  84  * &lt;property name=&quot;jobDetail&quot; ref=&quot;purgeCartJobDetail&quot; /&gt;                                                </span>
<span class="-1206739829467768833" onmouseenter="enter('-1206739829467768833');" onmouseout="out('-1206739829467768833');" style="">  85  * &lt;property name=&quot;startDelay&quot; value=&quot;30000&quot; /&gt;                                                          </span>
<span class="-7327795866109106158" onmouseenter="enter('-7327795866109106158');" onmouseout="out('-7327795866109106158');" style="">  86  * &lt;property name=&quot;repeatInterval&quot; value=&quot;86400000&quot; /&gt;                                                   </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  87  * &lt;/bean&gt;                                                                                               </span>
<span class="3684153123693005881" onmouseenter="enter('3684153123693005881');" onmouseout="out('3684153123693005881');" style="">  88  *}                                                                                                      </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  89  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  90  */                                                                                                      </span>
<span class="-5822344749670970380" onmouseenter="enter('-5822344749670970380');" onmouseout="out('-5822344749670970380');" style="">  91 @Service(&quot;blResourcePurgeService&quot;)                                                                       </span>
<span class="873248027020485265" onmouseenter="enter('873248027020485265');" onmouseout="out('873248027020485265');" style="">  92 public class ResourcePurgeServiceImpl implements ResourcePurgeService {                                  </span>
<span class="-6373274908004434475" onmouseenter="enter('-6373274908004434475');" onmouseout="out('-6373274908004434475');" style="">  93     private static final Log LOG = LogFactory.getLog(ResourcePurgeServiceImpl.class);                    </span>
<span  style="">  94                                                                                                          </span>
<span class="149979258544894255" onmouseenter="enter('149979258544894255');" onmouseout="out('149979258544894255');" style="">  95     private static final Long BATCH_SIZE = 50L;                                                          </span>
<span  style="">  96                                                                                                          </span>
<span class="-4766580338300075029" onmouseenter="enter('-4766580338300075029');" onmouseout="out('-4766580338300075029');" style="">  97     //48 HOURS                                                                                           </span>
<span class="-4253097523145751645" onmouseenter="enter('-4253097523145751645');" onmouseout="out('-4253097523145751645');" style=""><abbr title="  98     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48 HOURS">  98     private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48ðŸ”µ</abbr></span>
<span  style="">  99                                                                                                          </span>
<span class="8526754740985159609" onmouseenter="enter('8526754740985159609');" onmouseout="out('8526754740985159609');" style=""> 100     protected PurgeErrorCache customerPurgeErrors = new PurgeErrorCache();                               </span>
<span  style=""> 101                                                                                                          </span>
<span class="4108358954087572821" onmouseenter="enter('4108358954087572821');" onmouseout="out('4108358954087572821');" style=""> 102     protected PurgeErrorCache historyPurgeErrors = new PurgeErrorCache();                                </span>
<span  style=""> 103                                                                                                          </span>
<span class="7366515115260261905" onmouseenter="enter('7366515115260261905');" onmouseout="out('7366515115260261905');" style=""> 104     protected PurgeErrorCache cartPurgeErrors = new PurgeErrorCache();                                   </span>
<span  style=""> 105                                                                                                          </span>
<span class="-2629969533830190342" onmouseenter="enter('-2629969533830190342');" onmouseout="out('-2629969533830190342');" style=""> 106     @Resource(name = &quot;blTransactionManager&quot;)                                                             </span>
<span class="-8090157640080505156" onmouseenter="enter('-8090157640080505156');" onmouseout="out('-8090157640080505156');" style=""> 107     protected PlatformTransactionManager transactionManager;                                             </span>
<span  style=""> 108                                                                                                          </span>
<span class="-2129959487514464786" onmouseenter="enter('-2129959487514464786');" onmouseout="out('-2129959487514464786');" style=""> 109     @Resource(name = &quot;blResourcePurgeDao&quot;)                                                               </span>
<span class="1336580446360306350" onmouseenter="enter('1336580446360306350');" onmouseout="out('1336580446360306350');" style=""> 110     protected ResourcePurgeDao resourcePurgeDao;                                                         </span>
<span  style=""> 111                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 112     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 113     protected OrderService orderService;                                                                 </span>
<span  style=""> 114                                                                                                          </span>
<span class="6969754559269026560" onmouseenter="enter('6969754559269026560');" onmouseout="out('6969754559269026560');" style=""> 115     @Resource(name = &quot;blCustomerService&quot;)                                                                </span>
<span class="5369585293672379772" onmouseenter="enter('5369585293672379772');" onmouseout="out('5369585293672379772');" style=""> 116     protected CustomerService customerService;                                                           </span>
<span  style=""> 117                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style=""> 118     @Autowired                                                                                           </span>
<span class="-772913752442459972" onmouseenter="enter('-772913752442459972');" onmouseout="out('-772913752442459972');" style=""> 119     @Qualifier(&quot;blNotificationDispatcher&quot;)                                                               </span>
<span class="-1953064040931552296" onmouseenter="enter('-1953064040931552296');" onmouseout="out('-1953064040931552296');" style=""> 120     protected NotificationDispatcher notificationDispatcher;                                             </span>
<span  style=""> 121                                                                                                          </span>
<span class="695241785881102503" onmouseenter="enter('695241785881102503');" onmouseout="out('695241785881102503');" style=""> 122     @Resource(name = &quot;blDeleteStatementGenerator&quot;)                                                       </span>
<span class="-7581585138447328467" onmouseenter="enter('-7581585138447328467');" onmouseout="out('-7581585138447328467');" style=""> 123     protected DeleteStatementGenerator deleteStatementGenerator;                                         </span>
<span  style=""> 124                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style=""> 125     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style=""> 126     protected Environment env;                                                                           </span>
<span  style=""> 127                                                                                                          </span>
<span class="5710637357667853932" onmouseenter="enter('5710637357667853932');" onmouseout="out('5710637357667853932');" style=""> 128     @PersistenceContext(unitName = &quot;blPU&quot;)                                                               </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 129     protected EntityManager em;                                                                          </span>
<span  style=""> 130                                                                                                          </span>
<span class="-3119890949520834785" onmouseenter="enter('-3119890949520834785');" onmouseout="out('-3119890949520834785');" style=""> 131     @Resource(name = &quot;blResourcePurgeExtensionManager&quot;)                                                  </span>
<span class="8180782340617912300" onmouseenter="enter('8180782340617912300');" onmouseout="out('8180782340617912300');" style=""> 132     protected ResourcePurgeExtensionManager extensionManager;                                            </span>
<span  style=""> 133                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134     @Override                                                                                            </span>
<span class="4309385457274814832" onmouseenter="enter('4309385457274814832');" onmouseout="out('4309385457274814832');" style=""> 135     public void purgeCarts(final Map&lt;String, String&gt; config) {                                           </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 136         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="5550302810575666152" onmouseenter="enter('5550302810575666152');" onmouseout="out('5550302810575666152');" style=""> 137             LOG.debug(&quot;Purging carts&quot;);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 139         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style=""><abbr title=" 140             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; +"> 140             throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration proviðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 141                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 143         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 144         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="-6288858101655041374" onmouseenter="enter('-6288858101655041374');" onmouseout="out('-6288858101655041374');" style=""> 145         synchronized(cartPurgeErrors) {                                                                  </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 146             Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                              </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style=""><abbr title=" 147             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();"> 147             batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue(ðŸ”µ</abbr></span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style=""><abbr title=" 148             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));"> 148             List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCarðŸ”µ</abbr></span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 149             for (Order cart : carts) {                                                                   </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 150                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,              </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 151                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 152                 try {                                                                                    </span>
<span class="4510796021165287410" onmouseenter="enter('4510796021165287410');" onmouseout="out('4510796021165287410');" style=""> 153                     deleteCart(cart);                                                                    </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 154                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 155                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 156                 } catch (Exception e) {                                                                  </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 157                     if (! status.isCompleted()) {                                                        </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 158                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159                     }                                                                                    </span>
<span class="5109618921839591834" onmouseenter="enter('5109618921839591834');" onmouseout="out('5109618921839591834');" style=""> 160                     LOG.error(String.format(&quot;Not able to purge Cart ID: %d&quot;, cart.getId()), e);          </span>
<span class="-4853598595361674600" onmouseenter="enter('-4853598595361674600');" onmouseout="out('-4853598595361674600');" style=""> 161                     cartPurgeErrors.add(cart.getId());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164         }                                                                                                </span>
<span class="7794934293570296678" onmouseenter="enter('7794934293570296678');" onmouseout="out('7794934293570296678');" style=""><abbr title=" 165         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, cartPurgeErrors.size()));"> 165         LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d faðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166     }                                                                                                    </span>
<span  style=""> 167                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 168     @Override                                                                                            </span>
<span class="-3155325957841664585" onmouseenter="enter('-3155325957841664585');" onmouseout="out('-3155325957841664585');" style=""> 169     public void notifyCarts(final Map&lt;String, String&gt; config) {                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 170         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-3286686306843613123" onmouseenter="enter('-3286686306843613123');" onmouseout="out('-3286686306843613123');" style=""> 171             LOG.debug(&quot;Notifying carts of purge&quot;);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 173         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="2705292744574863925" onmouseenter="enter('2705292744574863925');" onmouseout="out('2705292744574863925');" style=""><abbr title=" 174             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuration provided. &quot; +"> 174             throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuraðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 175                     &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176         }                                                                                                </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 177         CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                              </span>
<span class="8814839157010793891" onmouseenter="enter('8814839157010793891');" onmouseout="out('8814839157010793891');" style=""> 178         int batchCount = 0;                                                                              </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 179         Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                  </span>
<span class="2835180694455823862" onmouseenter="enter('2835180694455823862');" onmouseout="out('2835180694455823862');" style=""> 180         batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;&gt;(failedCartIds)).intValue();      </span>
<span class="-5922847017937203398" onmouseenter="enter('-5922847017937203398');" onmouseout="out('-5922847017937203398');" style=""> 181         List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;&gt;(failedCartIds)); </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 182         for (Order cart : carts) {                                                                       </span>
<span class="2587782700097468426" onmouseenter="enter('2587782700097468426');" onmouseout="out('2587782700097468426');" style=""> 183             notifyCart(cart);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185     }                                                                                                    </span>
<span  style=""> 186                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 187     @Override                                                                                            </span>
<span class="-1802669755772945786" onmouseenter="enter('-1802669755772945786');" onmouseout="out('-1802669755772945786');" style=""><abbr title=" 188     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; depends, final Map&lt;String, Integer&gt; config) {"> 188     public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStateðŸ”µ</abbr></span>
<span  style=""> 189                                                                                                          </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 190         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="-8653909733810486694" onmouseenter="enter('-8653909733810486694');" onmouseout="out('-8653909733810486694');" style=""> 191             LOG.debug(&quot;Purging historical orders&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192         }                                                                                                </span>
<span  style=""> 193                                                                                                          </span>
<span class="-3654204218851766889" onmouseenter="enter('-3654204218851766889');" onmouseout="out('-3654204218851766889');" style=""> 194         String enablePurge = env.getProperty(&quot;enable.purge.order.history&quot;);                              </span>
<span  style=""> 195                                                                                                          </span>
<span class="-6307477278678171490" onmouseenter="enter('-6307477278678171490');" onmouseout="out('-6307477278678171490');" style=""> 196         if (!Boolean.parseBoolean(enablePurge)) {                                                        </span>
<span class="-3484703522134094040" onmouseenter="enter('-3484703522134094040');" onmouseout="out('-3484703522134094040');" style=""><abbr title=" 197             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.history to true.&quot;);"> 197             LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.hisðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 198             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199         }                                                                                                </span>
<span  style=""> 200                                                                                                          </span>
<span class="-2659324279400027158" onmouseenter="enter('-2659324279400027158');" onmouseout="out('-2659324279400027158');" style=""> 201         Integer daysCount = config.get(PurgeOrderHistoryVariableNames.OLDER_THAN_DAYS.toString());       </span>
<span class="8879960017039434329" onmouseenter="enter('8879960017039434329');" onmouseout="out('8879960017039434329');" style=""> 202         Integer batchSize = config.get(PurgeOrderHistoryVariableNames.BATCH_SIZE.toString());            </span>
<span  style=""> 203                                                                                                          </span>
<span class="2743860540483018997" onmouseenter="enter('2743860540483018997');" onmouseout="out('2743860540483018997');" style=""> 204         List&lt;Order&gt; oldOrders = orderService.findOrdersByDaysCount(daysCount, batchSize);                </span>
<span class="8291766046289306970" onmouseenter="enter('8291766046289306970');" onmouseout="out('8291766046289306970');" style=""><abbr title=" 205         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends);"> 205         Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends)ðŸ”µ</abbr></span>
<span  style=""> 206                                                                                                          </span>
<span class="-4732634170977321510" onmouseenter="enter('-4732634170977321510');" onmouseout="out('-4732634170977321510');" style=""> 207         List&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderDependencies = new ArrayList&lt;&gt;();            </span>
<span  style=""> 208                                                                                                          </span>
<span class="8048050619804607819" onmouseenter="enter('8048050619804607819');" onmouseout="out('8048050619804607819');" style=""><abbr title=" 209         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, &quot;ORDER_ID&quot;));"> 209         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, ðŸ”µ</abbr></span>
<span  style=""> 210                                                                                                          </span>
<span class="7928252889655920702" onmouseenter="enter('7928252889655920702');" onmouseout="out('7928252889655920702');" style=""> 211         dependencies.put(&quot;BLC_ORDER&quot;, orderDependencies);                                                </span>
<span  style=""> 212                                                                                                          </span>
<span class="1355272824006853176" onmouseenter="enter('1355272824006853176');" onmouseout="out('1355272824006853176');" style=""> 213         ArrayList&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderItemDependencies = new ArrayList&lt;&gt;();   </span>
<span class="6007887936589274996" onmouseenter="enter('6007887936589274996');" onmouseout="out('6007887936589274996');" style=""><abbr title=" 214         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, &quot;ORDER_MULTISHIP_OPTION_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 214         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, ðŸ”µ</abbr></span>
<span class="8628014233398989009" onmouseenter="enter('8628014233398989009');" onmouseout="out('8628014233398989009');" style=""><abbr title=" 215         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORDER_ITEM_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 215         orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORðŸ”µ</abbr></span>
<span class="-4082949278907558346" onmouseenter="enter('-4082949278907558346');" onmouseout="out('-4082949278907558346');" style=""> 216         dependencies.put(&quot;BLC_ORDER_ITEM&quot;, orderItemDependencies);                                       </span>
<span class="-7586552207458707428" onmouseenter="enter('-7586552207458707428');" onmouseout="out('-7586552207458707428');" style=""><abbr title=" 217         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_PAYMENT_LOG&quot;, &quot;ORDER_PAYMENT_ID&quot;, &quot;ORDER_PAYMENT_ID&quot;)));"> 217         dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.ðŸ”µ</abbr></span>
<span class="6578497182871896533" onmouseenter="enter('6578497182871896533');" onmouseout="out('6578497182871896533');" style=""> 218         extensionManager.getProxy().addPurgeDependencies(dependencies);                                  </span>
<span class="4830318402684525340" onmouseenter="enter('4830318402684525340');" onmouseout="out('4830318402684525340');" style=""> 219         Set&lt;String&gt; exclusions = new HashSet&lt;&gt;();                                                        </span>
<span class="-4430846773603202851" onmouseenter="enter('-4430846773603202851');" onmouseout="out('-4430846773603202851');" style=""> 220         exclusions.add(&quot;BLC_ADMIN_USER&quot;);                                                                </span>
<span class="34011160929975445" onmouseenter="enter('34011160929975445');" onmouseout="out('34011160929975445');" style=""> 221         extensionManager.getProxy().addPurgeExclusions(exclusions);                                      </span>
<span class="4783797439534498468" onmouseenter="enter('4783797439534498468');" onmouseout="out('4783797439534498468');" style=""><abbr title=" 222         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrderImpl.class, &quot;?&quot;, dependencies, exclusions);"> 222         Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrðŸ”µ</abbr></span>
<span class="3783061397625598902" onmouseenter="enter('3783061397625598902');" onmouseout="out('3783061397625598902');" style=""> 223         for (Order order : oldOrders) {                                                                  </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 224             TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                  </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 225                     TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 226             try {                                                                                        </span>
<span class="-8448685700561076869" onmouseenter="enter('-8448685700561076869');" onmouseout="out('-8448685700561076869');" style=""> 227                 em.unwrap(Session.class).doWork(new Work() {                                             </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 228                     @Override                                                                            </span>
<span class="-4124393681745953188" onmouseenter="enter('-4124393681745953188');" onmouseout="out('-4124393681745953188');" style=""> 229                     public void execute(Connection connection) throws SQLException {                     </span>
<span class="-7878705497542337751" onmouseenter="enter('-7878705497542337751');" onmouseout="out('-7878705497542337751');" style=""> 230                         Statement statement = connection.createStatement();                              </span>
<span class="-3449158197612158484" onmouseenter="enter('-3449158197612158484');" onmouseout="out('-3449158197612158484');" style=""> 231                         for (String value : deleteStatement.values()) {                                  </span>
<span class="-4055740799466096202" onmouseenter="enter('-4055740799466096202');" onmouseout="out('-4055740799466096202');" style=""> 232                             String sql = value.replace(&quot;?&quot;, String.valueOf(order.getId()));              </span>
<span class="5121719000459724566" onmouseenter="enter('5121719000459724566');" onmouseout="out('5121719000459724566');" style=""> 233                             LOG.debug(sql);                                                              </span>
<span class="5795758955073093328" onmouseenter="enter('5795758955073093328');" onmouseout="out('5795758955073093328');" style=""> 234                             statement.addBatch(sql);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235                         }                                                                                </span>
<span class="2322675505205288495" onmouseenter="enter('2322675505205288495');" onmouseout="out('2322675505205288495');" style=""> 236                         extensionManager.getProxy().addPurgeStatements(statement, rootTypeIdValue);      </span>
<span class="-1332092965431964598" onmouseenter="enter('-1332092965431964598');" onmouseout="out('-1332092965431964598');" style=""> 237                         statement.executeBatch();                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238                     }                                                                                    </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 239                 });                                                                                      </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 240                 TransactionUtils.finalizeTransaction(status, transactionManager, false);                 </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 241             } catch (Exception e) {                                                                      </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style=""> 242                 if (!status.isCompleted()) {                                                             </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 243                     TransactionUtils.finalizeTransaction(status, transactionManager, true);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                 }                                                                                        </span>
<span class="5843261671853400812" onmouseenter="enter('5843261671853400812');" onmouseout="out('5843261671853400812');" style=""> 245                 LOG.error(String.format(&quot;Not able to purge Order ID: %d&quot;, order.getId()), e);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247         }                                                                                                </span>
<span  style=""> 248                                                                                                          </span>
<span class="-1073654053478996749" onmouseenter="enter('-1073654053478996749');" onmouseout="out('-1073654053478996749');" style=""> 249         LOG.info(&quot;Finished purging historical orders.&quot;);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250     }                                                                                                    </span>
<span  style=""> 251                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 252     @Override                                                                                            </span>
<span class="4447368119484600014" onmouseenter="enter('4447368119484600014');" onmouseout="out('4447368119484600014');" style=""> 253     public void purgeCustomers(final Map&lt;String, String&gt; config) {                                       </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 254         if (LOG.isDebugEnabled()) {                                                                      </span>
<span class="1532316588592469018" onmouseenter="enter('1532316588592469018');" onmouseout="out('1532316588592469018');" style=""> 255             LOG.debug(&quot;Purging customers&quot;);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 256         }                                                                                                </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 257         if (MapUtils.isEmpty(config)) {                                                                  </span>
<span class="362564872021724408" onmouseenter="enter('362564872021724408');" onmouseout="out('362564872021724408');" style=""><abbr title=" 258             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. &quot; +"> 258             throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration pðŸ”µ</abbr></span>
<span class="-7406017465356863948" onmouseenter="enter('-7406017465356863948');" onmouseout="out('-7406017465356863948');" style=""> 259                     &quot;In the absence of config params, all customers would be candidates for deletion.&quot;); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260         }                                                                                                </span>
<span class="-2250958415199181791" onmouseenter="enter('-2250958415199181791');" onmouseout="out('-2250958415199181791');" style=""> 261         CustomerPurgeParams purgeParams = new CustomerPurgeParams(config).invoke();                      </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 262         int processedCount = 0, batchCount = 0;                                                          </span>
<span class="7229609060981046917" onmouseenter="enter('7229609060981046917');" onmouseout="out('7229609060981046917');" style=""> 263         synchronized(customerPurgeErrors) {                                                              </span>
<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style=""> 264             Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                      </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style=""><abbr title=" 265             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 265             batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).iðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style=""><abbr title=" 266             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 266             List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;LongðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style=""> 267             for (Customer customer : customers) {                                                        </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style=""> 268                 TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,          </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 269                         TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 270                 try {                                                                                    </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style=""> 271                     deleteCustomer(customer);                                                            </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 272                     TransactionUtils.finalizeTransaction(status, transactionManager, false);             </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 273                     processedCount++;                                                                    </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 274                 } catch (Exception e) {                                                                  </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 275                     if (! status.isCompleted()) {                                                        </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 276                         TransactionUtils.finalizeTransaction(status, transactionManager, true);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277                     }                                                                                    </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style=""> 278                     LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);  </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style=""> 279                     customerPurgeErrors.add(customer.getId());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 280                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 281             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 282         }                                                                                                </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style=""><abbr title=" 283         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 283         LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284     }                                                                                                    </span>
<span  style=""> 285                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 286     /**                                                                                                  </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style=""><abbr title=" 287      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 287      * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  ExpðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288      *                                                                                                   </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style=""> 289      * @param purgeParams configured parameters for the cart purge process                               </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style=""> 290      * @return set of cart ids to ignore/exclude from the next purge run                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 291      */                                                                                                  </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style=""> 292     protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                           </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 293         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style=""> 294         Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);         </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style=""> 295         return ignoreFailedCartIds;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296     }                                                                                                    </span>
<span  style=""> 297                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 298     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 299      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 299      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 300      *                                                                                                   </span>
<span class="-1716018750408229582" onmouseenter="enter('-1716018750408229582');" onmouseout="out('-1716018750408229582');" style=""> 301      * @param purgeParams configured parameters for the Cart purge process                               </span>
<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style=""> 302      * @param cartsInError list of cart ids to be ignored/excluded from the query                        </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style=""> 303      * @return list of carts to delete                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 304      */                                                                                                  </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style=""><abbr title=" 305     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 305     protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;LonðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 306         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 307         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 308         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 309         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style=""><abbr title=" 310         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 310         return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311     }                                                                                                    </span>
<span  style=""> 312                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 313     /**                                                                                                  </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style=""><abbr title=" 314      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 314      * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 315      *                                                                                                   </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style=""> 316      * @param purgeParams configured parameters for the Customer purge process used in the query         </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style=""> 317      * @param cartsInError list of cart ids to ignore/exclude from the next purge run                    </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style=""> 318      * @return count of carts to delete                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 319      */                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 320     /**                                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 321      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 322      */                                                                                                  </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style=""> 323     protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {         </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 324         String[] nameArray = purgeParams.getNameArray();                                                 </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 325         OrderStatus[] statusArray = purgeParams.getStatusArray();                                        </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 326         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 327         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style=""> 328         Long cartBatchSize = purgeParams.getBatchSize();                                                 </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style=""><abbr title=" 329         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 329         Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThresholdðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style=""> 330         //return the lesser of the parameter batch size of the count of the orders to purge              </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style=""> 331         return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332     }                                                                                                    </span>
<span  style=""> 333                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 334     /**                                                                                                  </span>
<span class="-4831217906829284324" onmouseenter="enter('-4831217906829284324');" onmouseout="out('-4831217906829284324');" style=""> 335      * Notify the cart&#x27;s owner of a pending purge of their cart.                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 336      *                                                                                                   </span>
<span class="-1591121872845752466" onmouseenter="enter('-1591121872845752466');" onmouseout="out('-1591121872845752466');" style=""> 337      * @param cart the cart                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 338      */                                                                                                  </span>
<span class="-1439517530326153748" onmouseenter="enter('-1439517530326153748');" onmouseout="out('-1439517530326153748');" style=""> 339     protected void notifyCart(Order cart) {                                                              </span>
<span class="6785017572112928400" onmouseenter="enter('6785017572112928400');" onmouseout="out('6785017572112928400');" style=""> 340         String emailAddress = getEmailForCart(cart);                                                     </span>
<span class="-8702812354445074278" onmouseenter="enter('-8702812354445074278');" onmouseout="out('-8702812354445074278');" style=""> 341         if (emailAddress != null) {                                                                      </span>
<span class="4884753630904156580" onmouseenter="enter('4884753630904156580');" onmouseout="out('4884753630904156580');" style=""> 342             Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();                                               </span>
<span class="-1876686562124284125" onmouseenter="enter('-1876686562124284125');" onmouseout="out('-1876686562124284125');" style=""> 343             context.put(&quot;cart&quot;, cart);                                                                   </span>
<span class="-7081183395280146833" onmouseenter="enter('-7081183395280146833');" onmouseout="out('-7081183395280146833');" style=""> 344             context.put(&quot;customer&quot;, cart.getCustomer());                                                 </span>
<span class="2299045321537655635" onmouseenter="enter('2299045321537655635');" onmouseout="out('2299045321537655635');" style=""> 345             context.put(&quot;emailAddress&quot;, emailAddress);                                                   </span>
<span  style=""> 346                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 347             try {                                                                                        </span>
<span class="-335501726229324372" onmouseenter="enter('-335501726229324372');" onmouseout="out('-335501726229324372');" style=""><abbr title=" 348                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificationEventType.NOTIFY_ABANDONED_CART, context));"> 348                 notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificatðŸ”µ</abbr></span>
<span class="9220844322816084446" onmouseenter="enter('9220844322816084446');" onmouseout="out('9220844322816084446');" style=""> 349             } catch (ServiceException e) {                                                               </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 350                 if (LOG.isDebugEnabled()) {                                                              </span>
<span class="-238742426127135817" onmouseenter="enter('-238742426127135817');" onmouseout="out('-238742426127135817');" style=""> 351                     LOG.debug(&quot;Failure to send email notification&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 352                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 353             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355     }                                                                                                    </span>
<span  style=""> 356                                                                                                          </span>
<span class="962012931445232765" onmouseenter="enter('962012931445232765');" onmouseout="out('962012931445232765');" style=""> 357     protected String getEmailForCart(Order cart) {                                                       </span>
<span class="-1013041921655187511" onmouseenter="enter('-1013041921655187511');" onmouseout="out('-1013041921655187511');" style=""> 358         if (cart.getEmailAddress() != null) {                                                            </span>
<span class="9127709401881574307" onmouseenter="enter('9127709401881574307');" onmouseout="out('9127709401881574307');" style=""> 359             return cart.getEmailAddress();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 360         }                                                                                                </span>
<span  style=""> 361                                                                                                          </span>
<span class="-4914468579235587722" onmouseenter="enter('-4914468579235587722');" onmouseout="out('-4914468579235587722');" style=""> 362         if (cart.getCustomer() != null &amp;&amp; cart.getCustomer().getEmailAddress() != null) {                </span>
<span class="4109268194947089596" onmouseenter="enter('4109268194947089596');" onmouseout="out('4109268194947089596');" style=""> 363             return cart.getCustomer().getEmailAddress();                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364         }                                                                                                </span>
<span  style=""> 365                                                                                                          </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 366         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 367     }                                                                                                    </span>
<span  style=""> 368                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 369     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 370      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 370      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 371      *                                                                                                   </span>
<span class="-6771798214247950041" onmouseenter="enter('-6771798214247950041');" onmouseout="out('-6771798214247950041');" style=""> 372      * @param cart the cart to remove                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 373      */                                                                                                  </span>
<span class="621215427910457813" onmouseenter="enter('621215427910457813');" onmouseout="out('621215427910457813');" style=""> 374     protected void deleteCart(Order cart) {                                                              </span>
<span class="-3274557726078521593" onmouseenter="enter('-3274557726078521593');" onmouseout="out('-3274557726078521593');" style=""><abbr title=" 375         //We delete the order this way (rather than with a delete query) in order to ensure the cascades take place"> 375         //We delete the order this way (rather than with a delete query) in order to ensure the cascades ðŸ”µ</abbr></span>
<span class="5643426177894030209" onmouseenter="enter('5643426177894030209');" onmouseout="out('5643426177894030209');" style=""> 376         orderService.deleteOrder(cart);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377     }                                                                                                    </span>
<span  style=""> 378                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 379     /**                                                                                                  </span>
<span class="3205340653525749512" onmouseenter="enter('3205340653525749512');" onmouseout="out('3205340653525749512');" style=""> 380      * Get the Customer Ids from cache that should be ignored due to errors in previous purge attempts   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 381      *                                                                                                   </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 382      * @param purgeParams configured parameters for the Customer purge process                           </span>
<span class="-5970206514796632950" onmouseenter="enter('-5970206514796632950');" onmouseout="out('-5970206514796632950');" style=""> 383      * @return set of customer ids to ignore/exclude from the next purge run                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 384      */                                                                                                  </span>
<span class="-3065693137793837519" onmouseenter="enter('-3065693137793837519');" onmouseout="out('-3065693137793837519');" style=""> 385     protected Set&lt;Long&gt; getCustomersInErrorToIgnore(CustomerPurgeParams purgeParams) {                   </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 386         long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                      </span>
<span class="-7599335319839599610" onmouseenter="enter('-7599335319839599610');" onmouseout="out('-7599335319839599610');" style=""> 387         Set&lt;Long&gt; ignoreFailedCustomerIds = customerPurgeErrors.getEntriesSince(ignoreFailedExpiration); </span>
<span class="-6742430259144212604" onmouseenter="enter('-6742430259144212604');" onmouseout="out('-6742430259144212604');" style=""> 388         return ignoreFailedCustomerIds;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389     }                                                                                                    </span>
<span  style=""> 390                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 391     /**                                                                                                  </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""><abbr title=" 392      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 392      * Get the list of carts to delete from the database. Subclasses may override for custom cart retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 393      *                                                                                                   </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 394      * @param purgeParams configured parameters for the Customer purge process                           </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 395      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="6504215439929103259" onmouseenter="enter('6504215439929103259');" onmouseout="out('6504215439929103259');" style=""> 396      * @return list of customers to delete                                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 397      */                                                                                                  </span>
<span class="-1507004170363559761" onmouseenter="enter('-1507004170363559761');" onmouseout="out('-1507004170363559761');" style=""><abbr title=" 398     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; customersInError) {"> 398     protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int lengtðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 399         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 400         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 401         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 402         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-2312253704458899930" onmouseenter="enter('-2312253704458899930');" onmouseout="out('-2312253704458899930');" style=""><abbr title=" 403         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, startPos, length, customersInError);"> 403         return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 404     }                                                                                                    </span>
<span  style=""> 405                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 406     /**                                                                                                  </span>
<span class="8648259411111567723" onmouseenter="enter('8648259411111567723');" onmouseout="out('8648259411111567723');" style=""><abbr title=" 407      * Get the count of customers to delete from the database. Subclasses may override for custom customer retrieval logic."> 407      * Get the count of customers to delete from the database. Subclasses may override for custom customeðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 408      *                                                                                                   </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 409      * @param purgeParams configured parameters for the Customer purge process                           </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 410      * @param customersInError list of customer ids to be ignored/excluded from the query                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 411      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 412      */                                                                                                  </span>
<span class="8294886805011187143" onmouseenter="enter('8294886805011187143');" onmouseout="out('8294886805011187143');" style=""><abbr title=" 413     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInError) {"> 413     protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInErrorðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 414         Boolean isRegistered = purgeParams.getIsRegistered();                                            </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 415         Boolean isDeactivated = purgeParams.getIsDeactivated();                                          </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 416         Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                         </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 417         Boolean isPreview = purgeParams.getIsPreview();                                                  </span>
<span class="-6790142400743483163" onmouseenter="enter('-6790142400743483163');" onmouseout="out('-6790142400743483163');" style=""> 418         Long customerBatchSize = purgeParams.getBatchSize();                                             </span>
<span class="-6217873247193256304" onmouseenter="enter('-6217873247193256304');" onmouseout="out('-6217873247193256304');" style=""><abbr title=" 419         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, customersInError);"> 419         Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, ðŸ”µ</abbr></span>
<span class="-4628315344870235824" onmouseenter="enter('-4628315344870235824');" onmouseout="out('-4628315344870235824');" style=""> 420         //return the lesser of the parameter batch size of the count of the customers to purge           </span>
<span class="-6036527682216446677" onmouseenter="enter('-6036527682216446677');" onmouseout="out('-6036527682216446677');" style=""><abbr title=" 421         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCount;"> 421         return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : custðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422     }                                                                                                    </span>
<span  style=""> 423                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 424     /**                                                                                                  </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""><abbr title=" 425      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic."> 425      * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logiðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 426      *                                                                                                   </span>
<span class="-897887194989371766" onmouseenter="enter('-897887194989371766');" onmouseout="out('-897887194989371766');" style=""> 427      * @param customer the customer to remove                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 428      */                                                                                                  </span>
<span class="9030957329407065452" onmouseenter="enter('9030957329407065452');" onmouseout="out('9030957329407065452');" style=""> 429     protected void deleteCustomer(Customer customer) {                                                   </span>
<span class="-4425816966306665584" onmouseenter="enter('-4425816966306665584');" onmouseout="out('-4425816966306665584');" style=""><abbr title=" 430         //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take place"> 430         //We delete the customer this way (rather than with a delete query) in order to ensure the cascadðŸ”µ</abbr></span>
<span class="4420445378351605906" onmouseenter="enter('4420445378351605906');" onmouseout="out('4420445378351605906');" style=""> 431         customerService.deleteCustomer(customer);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 432     }                                                                                                    </span>
<span  style=""> 433                                                                                                          </span>
<span class="2605850108496977404" onmouseenter="enter('2605850108496977404');" onmouseout="out('2605850108496977404');" style=""> 434     private class CartPurgeParams {                                                                      </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 435         private Map&lt;String, String&gt; config;                                                              </span>
<span  style=""> 436                                                                                                          </span>
<span class="1381900387592843642" onmouseenter="enter('1381900387592843642');" onmouseout="out('1381900387592843642');" style=""> 437         private String[] nameArray;                                                                      </span>
<span  style=""> 438                                                                                                          </span>
<span class="8331062799574265987" onmouseenter="enter('8331062799574265987');" onmouseout="out('8331062799574265987');" style=""> 439         private OrderStatus[] statusArray;                                                               </span>
<span  style=""> 440                                                                                                          </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 441         private Date dateCreatedMinThreshold;                                                            </span>
<span  style=""> 442                                                                                                          </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 443         private Boolean isPreview;                                                                       </span>
<span  style=""> 444                                                                                                          </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 445         private Long batchSize;                                                                          </span>
<span  style=""> 446                                                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 447         private Long failedRetryTime;                                                                    </span>
<span  style=""> 448                                                                                                          </span>
<span class="2815224750970340197" onmouseenter="enter('2815224750970340197');" onmouseout="out('2815224750970340197');" style=""> 449         public CartPurgeParams(Map&lt;String, String&gt; config) {                                             </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 450             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 451         }                                                                                                </span>
<span  style=""> 452                                                                                                          </span>
<span class="-686271337436163522" onmouseenter="enter('-686271337436163522');" onmouseout="out('-686271337436163522');" style=""> 453         public String[] getNameArray() {                                                                 </span>
<span class="-6597175720812897488" onmouseenter="enter('-6597175720812897488');" onmouseout="out('-6597175720812897488');" style=""> 454             return nameArray;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455         }                                                                                                </span>
<span  style=""> 456                                                                                                          </span>
<span class="-4470666030488291109" onmouseenter="enter('-4470666030488291109');" onmouseout="out('-4470666030488291109');" style=""> 457         public OrderStatus[] getStatusArray() {                                                          </span>
<span class="1669553314396389775" onmouseenter="enter('1669553314396389775');" onmouseout="out('1669553314396389775');" style=""> 458             return statusArray;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459         }                                                                                                </span>
<span  style=""> 460                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 461         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 462             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463         }                                                                                                </span>
<span  style=""> 464                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 465         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 466             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467         }                                                                                                </span>
<span  style=""> 468                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 469         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 470             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471         }                                                                                                </span>
<span  style=""> 472                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 473         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 474             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 475         }                                                                                                </span>
<span  style=""> 476                                                                                                          </span>
<span class="-2086671766953086341" onmouseenter="enter('-2086671766953086341');" onmouseout="out('-2086671766953086341');" style=""> 477         public CartPurgeParams invoke() {                                                                </span>
<span class="2406323390572474949" onmouseenter="enter('2406323390572474949');" onmouseout="out('2406323390572474949');" style=""> 478             nameArray = null;                                                                            </span>
<span class="-8056479474459794956" onmouseenter="enter('-8056479474459794956');" onmouseout="out('-8056479474459794956');" style=""> 479             statusArray = null;                                                                          </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 480             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 481             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 482             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 483             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 484             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="7230126592195401480" onmouseenter="enter('7230126592195401480');" onmouseout="out('7230126592195401480');" style=""> 485                 if (PurgeCartVariableNames.STATUS.toString().equals(entry.getKey())) {                   </span>
<span class="-3887059016856253482" onmouseenter="enter('-3887059016856253482');" onmouseout="out('-3887059016856253482');" style=""> 486                     String[] temp = entry.getValue().split(&quot;,&quot;);                                         </span>
<span class="-984189042629809269" onmouseenter="enter('-984189042629809269');" onmouseout="out('-984189042629809269');" style=""> 487                     statusArray = new OrderStatus[temp.length];                                          </span>
<span class="7424479410662112456" onmouseenter="enter('7424479410662112456');" onmouseout="out('7424479410662112456');" style=""> 488                     int index = 0;                                                                       </span>
<span class="-6857112710843456451" onmouseenter="enter('-6857112710843456451');" onmouseout="out('-6857112710843456451');" style=""> 489                     for (String name : temp) {                                                           </span>
<span class="4249642856708256048" onmouseenter="enter('4249642856708256048');" onmouseout="out('4249642856708256048');" style=""> 490                         OrderStatus orderStatus = OrderStatus.getInstance(name);                         </span>
<span class="354647143791226174" onmouseenter="enter('354647143791226174');" onmouseout="out('354647143791226174');" style=""> 491                         statusArray[index] = orderStatus;                                                </span>
<span class="8743575581853771534" onmouseenter="enter('8743575581853771534');" onmouseout="out('8743575581853771534');" style=""> 492                         index++;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 493                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494                 }                                                                                        </span>
<span class="-680570050183499360" onmouseenter="enter('-680570050183499360');" onmouseout="out('-680570050183499360');" style=""> 495                 if (PurgeCartVariableNames.NAME.toString().equals(entry.getKey())) {                     </span>
<span class="3793410955933370059" onmouseenter="enter('3793410955933370059');" onmouseout="out('3793410955933370059');" style=""> 496                     nameArray = entry.getValue().split(&quot;,&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497                 }                                                                                        </span>
<span class="5654291195038602061" onmouseenter="enter('5654291195038602061');" onmouseout="out('5654291195038602061');" style=""> 498                 if (PurgeCartVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {              </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 499                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 500                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 501                 }                                                                                        </span>
<span class="-3116043338550155301" onmouseenter="enter('-3116043338550155301');" onmouseout="out('-3116043338550155301');" style=""> 502                 if (PurgeCartVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {               </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 503                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504                 }                                                                                        </span>
<span class="-7209605236483980682" onmouseenter="enter('-7209605236483980682');" onmouseout="out('-7209605236483980682');" style=""> 505                 if (PurgeCartVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {               </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 506                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                 }                                                                                        </span>
<span class="6665497140882829750" onmouseenter="enter('6665497140882829750');" onmouseout="out('6665497140882829750');" style=""> 508                 if (PurgeCartVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {     </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 509                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 509                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 512             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514     }                                                                                                    </span>
<span  style=""> 515                                                                                                          </span>
<span class="6135355437794836082" onmouseenter="enter('6135355437794836082');" onmouseout="out('6135355437794836082');" style=""> 516     private class CustomerPurgeParams {                                                                  </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 517         private Map&lt;String, String&gt; config;                                                              </span>
<span  style=""> 518                                                                                                          </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 519         private Date dateCreatedMinThreshold;                                                            </span>
<span  style=""> 520                                                                                                          </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 521         private Boolean isPreview;                                                                       </span>
<span  style=""> 522                                                                                                          </span>
<span class="5345429142323969812" onmouseenter="enter('5345429142323969812');" onmouseout="out('5345429142323969812');" style=""> 523         private Boolean isRegistered;                                                                    </span>
<span  style=""> 524                                                                                                          </span>
<span class="3484617240152312252" onmouseenter="enter('3484617240152312252');" onmouseout="out('3484617240152312252');" style=""> 525         private Boolean isDeactivated;                                                                   </span>
<span  style=""> 526                                                                                                          </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 527         private Long batchSize;                                                                          </span>
<span  style=""> 528                                                                                                          </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 529         private Long failedRetryTime;                                                                    </span>
<span  style=""> 530                                                                                                          </span>
<span class="-3439970468083719495" onmouseenter="enter('-3439970468083719495');" onmouseout="out('-3439970468083719495');" style=""> 531         public CustomerPurgeParams(Map&lt;String, String&gt; config) {                                         </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 532             this.config = config;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533         }                                                                                                </span>
<span  style=""> 534                                                                                                          </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 535         public Date getDateCreatedMinThreshold() {                                                       </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 536             return dateCreatedMinThreshold;                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537         }                                                                                                </span>
<span  style=""> 538                                                                                                          </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 539         public Boolean getIsPreview() {                                                                  </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 540             return isPreview;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541         }                                                                                                </span>
<span  style=""> 542                                                                                                          </span>
<span class="-4523160162166092089" onmouseenter="enter('-4523160162166092089');" onmouseout="out('-4523160162166092089');" style=""> 543         public Boolean getIsRegistered() {                                                               </span>
<span class="6500879271821699409" onmouseenter="enter('6500879271821699409');" onmouseout="out('6500879271821699409');" style=""> 544             return isRegistered;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545         }                                                                                                </span>
<span  style=""> 546                                                                                                          </span>
<span class="831937501284736178" onmouseenter="enter('831937501284736178');" onmouseout="out('831937501284736178');" style=""> 547         public Boolean getIsDeactivated() {                                                              </span>
<span class="-8572023523120285779" onmouseenter="enter('-8572023523120285779');" onmouseout="out('-8572023523120285779');" style=""> 548             return isDeactivated;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 549         }                                                                                                </span>
<span  style=""> 550                                                                                                          </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 551         public Long getBatchSize() {                                                                     </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 552             return batchSize;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 553         }                                                                                                </span>
<span  style=""> 554                                                                                                          </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 555         public Long getFailedRetryTime() {                                                               </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 556             return failedRetryTime;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 557         }                                                                                                </span>
<span  style=""> 558                                                                                                          </span>
<span class="4345643298854756592" onmouseenter="enter('4345643298854756592');" onmouseout="out('4345643298854756592');" style=""> 559         public CustomerPurgeParams invoke() {                                                            </span>
<span class="-2554699908388798358" onmouseenter="enter('-2554699908388798358');" onmouseout="out('-2554699908388798358');" style=""> 560             isRegistered = null;                                                                         </span>
<span class="-4109360067770509892" onmouseenter="enter('-4109360067770509892');" onmouseout="out('-4109360067770509892');" style=""> 561             isDeactivated = null;                                                                        </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 562             dateCreatedMinThreshold = null;                                                              </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 563             isPreview = null;                                                                            </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 564             batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                             </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 565             failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                  </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 566             for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                  </span>
<span class="8500820035603099955" onmouseenter="enter('8500820035603099955');" onmouseout="out('8500820035603099955');" style=""> 567                 if (PurgeCustomerVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {          </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 568                     Long secondsOld = Long.parseLong(entry.getValue());                                  </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 569                     dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570                 }                                                                                        </span>
<span class="472649037401986768" onmouseenter="enter('472649037401986768');" onmouseout="out('472649037401986768');" style=""> 571                 if (PurgeCustomerVariableNames.IS_REGISTERED.toString().equals(entry.getKey())) {        </span>
<span class="3066848756297460347" onmouseenter="enter('3066848756297460347');" onmouseout="out('3066848756297460347');" style=""> 572                     isRegistered = Boolean.parseBoolean(entry.getValue());                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573                 }                                                                                        </span>
<span class="-6798790184150039593" onmouseenter="enter('-6798790184150039593');" onmouseout="out('-6798790184150039593');" style=""> 574                 if (PurgeCustomerVariableNames.IS_DEACTIVATED.toString().equals(entry.getKey())) {       </span>
<span class="8770174800886691615" onmouseenter="enter('8770174800886691615');" onmouseout="out('8770174800886691615');" style=""> 575                     isDeactivated = Boolean.parseBoolean(entry.getValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 576                 }                                                                                        </span>
<span class="-4202787563999133129" onmouseenter="enter('-4202787563999133129');" onmouseout="out('-4202787563999133129');" style=""> 577                 if (PurgeCustomerVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {           </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 578                     isPreview = Boolean.parseBoolean(entry.getValue());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579                 }                                                                                        </span>
<span class="2949192035259803609" onmouseenter="enter('2949192035259803609');" onmouseout="out('2949192035259803609');" style=""> 580                 if (PurgeCustomerVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {           </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 581                     batchSize = Long.parseLong(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 582                 }                                                                                        </span>
<span class="3875509270375211860" onmouseenter="enter('3875509270375211860');" onmouseout="out('3875509270375211860');" style=""> 583                 if (PurgeCustomerVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) { </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""><abbr title=" 584                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);"> 584                     failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 10ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586             }                                                                                            </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 587             return this;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 588         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589     }                                                                                                    </span>
<span  style=""> 590                                                                                                          </span>
<span class="-4423643614963439423" onmouseenter="enter('-4423643614963439423');" onmouseout="out('-4423643614963439423');" style=""> 591     private class PurgeErrorCache {                                                                      </span>
<span class="198672241784651248" onmouseenter="enter('198672241784651248');" onmouseout="out('198672241784651248');" style=""> 592         private Map&lt;Long, Long&gt; cache = new HashMap&lt;Long, Long&gt;();                                       </span>
<span  style=""> 593                                                                                                          </span>
<span class="-5066122402174219646" onmouseenter="enter('-5066122402174219646');" onmouseout="out('-5066122402174219646');" style=""> 594         public Long add(Long entry) {                                                                    </span>
<span class="1483875087127814333" onmouseenter="enter('1483875087127814333');" onmouseout="out('1483875087127814333');" style=""> 595             if (!cache.containsKey(entry)) {                                                             </span>
<span class="-1518558382272290563" onmouseenter="enter('-1518558382272290563');" onmouseout="out('-1518558382272290563');" style=""> 596                 return cache.put(entry, new Long(System.currentTimeMillis()));                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597             }                                                                                            </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 598             return null;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 599         }                                                                                                </span>
<span  style=""> 600                                                                                                          </span>
<span class="-5864460220203783413" onmouseenter="enter('-5864460220203783413');" onmouseout="out('-5864460220203783413');" style=""> 601         public Set&lt;Long&gt; getEntriesSince(long expiredTime) {                                             </span>
<span class="5364107475307863209" onmouseenter="enter('5364107475307863209');" onmouseout="out('5364107475307863209');" style=""> 602             for (Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext();) {  </span>
<span class="-7841947474939136830" onmouseenter="enter('-7841947474939136830');" onmouseout="out('-7841947474939136830');" style=""> 603                 Map.Entry&lt;Long, Long&gt; entry = item.next();                                               </span>
<span class="3419674656987096917" onmouseenter="enter('3419674656987096917');" onmouseout="out('3419674656987096917');" style=""> 604                 if (entry.getValue().longValue() &lt; expiredTime) {                                        </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style=""> 605                     item.remove();                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 606                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607             }                                                                                            </span>
<span class="4846818570039273159" onmouseenter="enter('4846818570039273159');" onmouseout="out('4846818570039273159');" style=""> 608             return cache.keySet();                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 609         }                                                                                                </span>
<span  style=""> 610                                                                                                          </span>
<span class="5501185527198334216" onmouseenter="enter('5501185527198334216');" onmouseout="out('5501185527198334216');" style=""> 611         public int size() {                                                                              </span>
<span class="4045092944756323954" onmouseenter="enter('4045092944756323954');" onmouseout="out('4045092944756323954');" style=""> 612             return cache.size();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 613         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 614     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615 }                                                                                                        </span>









































































































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-392708096265613810" onmouseenter="enter('-392708096265613810');" onmouseout="out('-392708096265613810');" style="">  18  package org.broadleafcommerce.core.util.service;                                                                  </span>
<span  style="">  19                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  20  import java.util.ArrayList;                                                                                       </span>
<span class="1748005127055838442" onmouseenter="enter('1748005127055838442');" onmouseout="out('1748005127055838442');" style="">  21  import java.util.Date;                                                                                            </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  22  import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  23  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  24  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  25  import java.util.Map;                                                                                             </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  26  import java.util.Set;                                                                                             </span>
<span  style="">  27                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  28  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  29                                                                                                                    </span>
<span class="4020017653195254006" onmouseenter="enter('4020017653195254006');" onmouseout="out('4020017653195254006');" style="">  30  import org.apache.commons.collections.MapUtils;                                                                   </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  31  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  32  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.common.exception.ServiceException;                                                   </span>
<span class="7132038483204039493" onmouseenter="enter('7132038483204039493');" onmouseout="out('7132038483204039493');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.broadleafcommerce.common.notification.service.NotificationDispatcher;                                  </span>
<span class="-840358981756149848" onmouseenter="enter('-840358981756149848');" onmouseout="out('-840358981756149848');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.broadleafcommerce.common.notification.service.type.EmailNotification;                                  </span>
<span class="-7956607451590208760" onmouseenter="enter('-7956607451590208760');" onmouseout="out('-7956607451590208760');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.broadleafcommerce.common.notification.service.type.NotificationEventType;                              </span>
<span class="1373992879208813777" onmouseenter="enter('1373992879208813777');" onmouseout="out('1373992879208813777');" style="">  37  import org.broadleafcommerce.common.time.SystemTime;                                                              </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  38  import org.broadleafcommerce.common.util.TransactionUtils;                                                        </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  39  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>

<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  40  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  41  import org.broadleafcommerce.core.order.service.type.OrderStatus;                                                 </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="">  42  import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                                      </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="">  43  import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                                       </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="">  44  import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                                   </span>

<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  45  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="">  46  import org.broadleafcommerce.profile.core.service.CustomerService;                                                </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-4664978283136443479" onmouseenter="enter('-4664978283136443479');" onmouseout="out('-4664978283136443479');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.springframework.beans.factory.annotation.Qualifier;                                                    </span>


<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  49  import org.springframework.stereotype.Service;                                                                    </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  50  import org.springframework.transaction.PlatformTransactionManager;                                                </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  51  import org.springframework.transaction.TransactionDefinition;                                                     </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  52  import org.springframework.transaction.TransactionStatus;                                                         </span>










<span  style="">  53                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  54  /**                                                                                                               </span>
<span class="-3191869593089593640" onmouseenter="enter('-3191869593089593640');" onmouseout="out('-3191869593089593640');" style=""><abbr title="  55   * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous Customers).">  55   * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous CustomðŸ”µ</abbr></span>
<span class="832835515286180797" onmouseenter="enter('832835515286180797');" onmouseout="out('832835515286180797');" style="">  56   * {@link ResourcePurgeService} for additional API documentation.                                                 </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  57   * &lt;p/&gt;                                                                                                           </span>
<span class="-315394129855994292" onmouseenter="enter('-315394129855994292');" onmouseout="out('-315394129855994292');" style="">  58   * A basic Quartz scheduled job configuration for calling this service can be configured as follows:              </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  59   * &lt;p/&gt;                                                                                                           </span>
<span class="-131984816008333551" onmouseenter="enter('-131984816008333551');" onmouseout="out('-131984816008333551');" style="">  60   * {@code                                                                                                         </span>
<span class="8079836627557216097" onmouseenter="enter('8079836627557216097');" onmouseout="out('8079836627557216097');" style="">  61   * &lt;bean id=&quot;purgeCartConfig&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;                    </span>
<span class="8809411245832543538" onmouseenter="enter('8809411245832543538');" onmouseout="out('8809411245832543538');" style="">  62   * &lt;property name=&quot;sourceMap&quot;&gt;                                                                                    </span>
<span class="-4290418952995175850" onmouseenter="enter('-4290418952995175850');" onmouseout="out('-4290418952995175850');" style="">  63   * &lt;map&gt;                                                                                                          </span>
<span class="5370217760353547455" onmouseenter="enter('5370217760353547455');" onmouseout="out('5370217760353547455');" style="">  64   * &lt;entry key=&quot;SECONDS_OLD&quot; value=&quot;2592000&quot;/&gt;                                                                     </span>
<span class="-1857330153031469850" onmouseenter="enter('-1857330153031469850');" onmouseout="out('-1857330153031469850');" style="">  65   * &lt;entry key=&quot;STATUS&quot; value=&quot;IN_PROCESS&quot;/&gt;                                                                       </span>
<span class="-1596267147682690356" onmouseenter="enter('-1596267147682690356');" onmouseout="out('-1596267147682690356');" style="">  66   * &lt;/map&gt;                                                                                                         </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  67   * &lt;/property&gt;                                                                                                    </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  68   * &lt;/bean&gt;                                                                                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  69   * &lt;p/&gt;                                                                                                           </span>
<span class="5857689149403140530" onmouseenter="enter('5857689149403140530');" onmouseout="out('5857689149403140530');" style="">  70   * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;</span>
<span class="-390919979070777656" onmouseenter="enter('-390919979070777656');" onmouseout="out('-390919979070777656');" style="">  71   * &lt;property name=&quot;targetObject&quot; ref=&quot;blResourcePurgeService&quot; /&gt;                                                  </span>
<span class="-1711168238872066589" onmouseenter="enter('-1711168238872066589');" onmouseout="out('-1711168238872066589');" style="">  72   * &lt;property name=&quot;targetMethod&quot; value=&quot;purgeCarts&quot; /&gt;                                                            </span>
<span class="4875414778543091051" onmouseenter="enter('4875414778543091051');" onmouseout="out('4875414778543091051');" style="">  73   * &lt;property name=&quot;arguments&quot;&gt;                                                                                    </span>
<span class="6000473589228105200" onmouseenter="enter('6000473589228105200');" onmouseout="out('6000473589228105200');" style="">  74   * &lt;list&gt;                                                                                                         </span>
<span class="-1321283090282055520" onmouseenter="enter('-1321283090282055520');" onmouseout="out('-1321283090282055520');" style="">  75   * &lt;ref bean=&quot;purgeCartConfig&quot;/&gt;                                                                                  </span>
<span class="2486531046171828364" onmouseenter="enter('2486531046171828364');" onmouseout="out('2486531046171828364');" style="">  76   * &lt;/list&gt;                                                                                                        </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  77   * &lt;/property&gt;                                                                                                    </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  78   * &lt;/bean&gt;                                                                                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  79   * &lt;p/&gt;                                                                                                           </span>
<span class="-7915154528943636028" onmouseenter="enter('-7915154528943636028');" onmouseout="out('-7915154528943636028');" style="">  80   * &lt;bean id=&quot;purgeCartTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;            </span>
<span class="5235847799914996571" onmouseenter="enter('5235847799914996571');" onmouseout="out('5235847799914996571');" style="">  81   * &lt;property name=&quot;jobDetail&quot; ref=&quot;purgeCartJobDetail&quot; /&gt;                                                         </span>
<span class="-1206739829467768833" onmouseenter="enter('-1206739829467768833');" onmouseout="out('-1206739829467768833');" style="">  82   * &lt;property name=&quot;startDelay&quot; value=&quot;30000&quot; /&gt;                                                                   </span>
<span class="-7327795866109106158" onmouseenter="enter('-7327795866109106158');" onmouseout="out('-7327795866109106158');" style="">  83   * &lt;property name=&quot;repeatInterval&quot; value=&quot;86400000&quot; /&gt;                                                            </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  84   * &lt;/bean&gt;                                                                                                        </span>
<span class="3684153123693005881" onmouseenter="enter('3684153123693005881');" onmouseout="out('3684153123693005881');" style="">  85   *}                                                                                                               </span>


<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  86   * @author Jeff Fischer                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  87   */                                                                                                               </span>
<span class="-5822344749670970380" onmouseenter="enter('-5822344749670970380');" onmouseout="out('-5822344749670970380');" style="">  88  @Service(&quot;blResourcePurgeService&quot;)                                                                                </span>
<span class="873248027020485265" onmouseenter="enter('873248027020485265');" onmouseout="out('873248027020485265');" style="">  89  public class ResourcePurgeServiceImpl implements ResourcePurgeService {                                           </span>
<span  style="">  90                                                                                                                    </span>
<span class="-6373274908004434475" onmouseenter="enter('-6373274908004434475');" onmouseout="out('-6373274908004434475');" style="">  91      private static final Log LOG = LogFactory.getLog(ResourcePurgeServiceImpl.class);                             </span>
<span  style="">  92                                                                                                                    </span>
<span class="149979258544894255" onmouseenter="enter('149979258544894255');" onmouseout="out('149979258544894255');" style="">  93      private static final Long BATCH_SIZE = 50L;                                                                   </span>
<span class="-4253097523145751645" onmouseenter="enter('-4253097523145751645');" onmouseout="out('-4253097523145751645');" style="">  94      private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48 HOURS   </span>
<span  style="">  95                                                                                                                    </span>
<span class="8526754740985159609" onmouseenter="enter('8526754740985159609');" onmouseout="out('8526754740985159609');" style="">  96      protected PurgeErrorCache customerPurgeErrors = new PurgeErrorCache();                                        </span>

<span class="7366515115260261905" onmouseenter="enter('7366515115260261905');" onmouseout="out('7366515115260261905');" style="">  97      protected PurgeErrorCache cartPurgeErrors = new PurgeErrorCache();                                            </span>
<span  style="">  98                                                                                                                    </span>
<span class="-2629969533830190342" onmouseenter="enter('-2629969533830190342');" onmouseout="out('-2629969533830190342');" style="">  99      @Resource(name = &quot;blTransactionManager&quot;)                                                                      </span>
<span class="-8090157640080505156" onmouseenter="enter('-8090157640080505156');" onmouseout="out('-8090157640080505156');" style=""> 100      protected PlatformTransactionManager transactionManager;                                                      </span>
<span  style=""> 101                                                                                                                    </span>
<span class="-2129959487514464786" onmouseenter="enter('-2129959487514464786');" onmouseout="out('-2129959487514464786');" style=""> 102      @Resource(name = &quot;blResourcePurgeDao&quot;)                                                                        </span>
<span class="1336580446360306350" onmouseenter="enter('1336580446360306350');" onmouseout="out('1336580446360306350');" style=""> 103      protected ResourcePurgeDao resourcePurgeDao;                                                                  </span>
<span  style=""> 104                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 105      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 106      protected OrderService orderService;                                                                          </span>
<span  style=""> 107                                                                                                                    </span>
<span class="6969754559269026560" onmouseenter="enter('6969754559269026560');" onmouseout="out('6969754559269026560');" style=""> 108      @Resource(name = &quot;blCustomerService&quot;)                                                                         </span>
<span class="5369585293672379772" onmouseenter="enter('5369585293672379772');" onmouseout="out('5369585293672379772');" style=""> 109      protected CustomerService customerService;                                                                    </span>












<span  style=""> 110                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +    @Autowired                                                                                                    </span>
<span class="-772913752442459972" onmouseenter="enter('-772913752442459972');" onmouseout="out('-772913752442459972');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    @Qualifier(&quot;blNotificationDispatcher&quot;)                                                                        </span>
<span class="-1953064040931552296" onmouseenter="enter('-1953064040931552296');" onmouseout="out('-1953064040931552296');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    protected NotificationDispatcher notificationDispatcher;                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 115      @Override                                                                                                     </span>
<span class="4309385457274814832" onmouseenter="enter('4309385457274814832');" onmouseout="out('4309385457274814832');" style=""> 116      public void purgeCarts(final Map&lt;String, String&gt; config) {                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 117          if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="5550302810575666152" onmouseenter="enter('5550302810575666152');" onmouseout="out('5550302810575666152');" style=""> 118              LOG.debug(&quot;Purging carts&quot;);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 119          }                                                                                                         </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 120          if (MapUtils.isEmpty(config)) {                                                                           </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style=""> 121              throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; + </span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 122                      &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123          }                                                                                                         </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 124          CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                                       </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 125          int processedCount = 0, batchCount = 0;                                                                   </span>
<span class="-6288858101655041374" onmouseenter="enter('-6288858101655041374');" onmouseout="out('-6288858101655041374');" style=""> 126          synchronized(cartPurgeErrors) {                                                                           </span>

<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 127              Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                       </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style=""> 128              batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();       </span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style=""> 129              List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));  </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 130              for (Order cart : carts) {                                                                            </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 131                  TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                       </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 132                          TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 133                  try {                                                                                             </span>
<span class="4510796021165287410" onmouseenter="enter('4510796021165287410');" onmouseout="out('4510796021165287410');" style=""> 134                      deleteCart(cart);                                                                             </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 135                      TransactionUtils.finalizeTransaction(status, transactionManager, false);                      </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 136                      processedCount++;                                                                             </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 137                  } catch (Exception e) {                                                                           </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 138                      if (! status.isCompleted()) {                                                                 </span>

<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 139                          TransactionUtils.finalizeTransaction(status, transactionManager, true);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140                      }                                                                                             </span>
<span class="5109618921839591834" onmouseenter="enter('5109618921839591834');" onmouseout="out('5109618921839591834');" style=""> 141                      LOG.error(String.format(&quot;Not able to purge Cart ID: %d&quot;, cart.getId()), e);                   </span>
<span class="-4853598595361674600" onmouseenter="enter('-4853598595361674600');" onmouseout="out('-4853598595361674600');" style=""> 142                      cartPurgeErrors.add(cart.getId());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145          }                                                                                                         </span>
<span class="7794934293570296678" onmouseenter="enter('7794934293570296678');" onmouseout="out('7794934293570296678');" style=""><abbr title=" 146          LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, cartPurgeErrors.size()));"> 146          LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures caðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147      }                                                                                                             </span>
<span  style=""> 148                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 149      @Override                                                                                                     </span>
<span class="-3155325957841664585" onmouseenter="enter('-3155325957841664585');" onmouseout="out('-3155325957841664585');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +    public void notifyCarts(final Map&lt;String, String&gt; config) {                                                   </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="-3286686306843613123" onmouseenter="enter('-3286686306843613123');" onmouseout="out('-3286686306843613123');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            LOG.debug(&quot;Notifying carts of purge&quot;);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        }                                                                                                         </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +        if (MapUtils.isEmpty(config)) {                                                                           </span>
<span class="2705292744574863925" onmouseenter="enter('2705292744574863925');" onmouseout="out('2705292744574863925');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 155 +            throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuration provided. &quot; +"> 155 +            throw new IllegalArgumentException(&quot;Cannot notify carts of purge since there was no configuration provðŸ”µ</abbr></span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                    &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        }                                                                                                         </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                                       </span>
<span class="8814839157010793891" onmouseenter="enter('8814839157010793891');" onmouseout="out('8814839157010793891');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +        int batchCount = 0;                                                                                       </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                           </span>
<span class="2835180694455823862" onmouseenter="enter('2835180694455823862');" onmouseout="out('2835180694455823862');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;&gt;(failedCartIds)).intValue();               </span>
<span class="-5922847017937203398" onmouseenter="enter('-5922847017937203398');" onmouseout="out('-5922847017937203398');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;&gt;(failedCartIds));          </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        for (Order cart : carts) {                                                                                </span>
<span class="2587782700097468426" onmouseenter="enter('2587782700097468426');" onmouseout="out('2587782700097468426');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +            notifyCart(cart);                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +    @Override                                                                                                     </span>















































<span class="4447368119484600014" onmouseenter="enter('4447368119484600014');" onmouseout="out('4447368119484600014');" style=""> 169      public void purgeCustomers(final Map&lt;String, String&gt; config) {                                                </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 170          if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="1532316588592469018" onmouseenter="enter('1532316588592469018');" onmouseout="out('1532316588592469018');" style=""> 171              LOG.debug(&quot;Purging customers&quot;);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 172          }                                                                                                         </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 173          if (MapUtils.isEmpty(config)) {                                                                           </span>
<span class="362564872021724408" onmouseenter="enter('362564872021724408');" onmouseout="out('362564872021724408');" style=""><abbr title=" 174              throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. &quot; +"> 174              throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. ðŸ”µ</abbr></span>
<span class="-7406017465356863948" onmouseenter="enter('-7406017465356863948');" onmouseout="out('-7406017465356863948');" style=""> 175                      &quot;In the absence of config params, all customers would be candidates for deletion.&quot;);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176          }                                                                                                         </span>
<span class="-2250958415199181791" onmouseenter="enter('-2250958415199181791');" onmouseout="out('-2250958415199181791');" style=""> 177          CustomerPurgeParams purgeParams = new CustomerPurgeParams(config).invoke();                               </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 178          int processedCount = 0, batchCount = 0;                                                                   </span>
<span class="7229609060981046917" onmouseenter="enter('7229609060981046917');" onmouseout="out('7229609060981046917');" style=""> 179          synchronized(customerPurgeErrors) {                                                                       </span>

<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style=""> 180              Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                               </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style=""><abbr title=" 181              batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 181              batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue()ðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style=""><abbr title=" 182              List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 182              List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style=""> 183              for (Customer customer : customers) {                                                                 </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style=""> 184                  TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,                   </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 185                          TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 186                  try {                                                                                             </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style=""> 187                      deleteCustomer(customer);                                                                     </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 188                      TransactionUtils.finalizeTransaction(status, transactionManager, false);                      </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 189                      processedCount++;                                                                             </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 190                  } catch (Exception e) {                                                                           </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style=""> 191                      if (! status.isCompleted()) {                                                                 </span>

<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 192                          TransactionUtils.finalizeTransaction(status, transactionManager, true);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193                      }                                                                                             </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style=""> 194                      LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);           </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style=""> 195                      customerPurgeErrors.add(customer.getId());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198          }                                                                                                         </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style=""><abbr title=" 199          LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 199          LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failureðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200      }                                                                                                             </span>
<span  style=""> 201                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 202      /**                                                                                                           </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style=""><abbr title=" 203       * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 203       * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cachðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 204       *                                                                                                            </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style=""> 205       * @param purgeParams configured parameters for the cart purge process                                        </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style=""> 206       * @return set of cart ids to ignore/exclude from the next purge run                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 207       */                                                                                                           </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style=""> 208      protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                                    </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 209          long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                               </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style=""> 210          Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);                  </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style=""> 211          return ignoreFailedCartIds;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212      }                                                                                                             </span>
<span  style=""> 213                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 214      /**                                                                                                           </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""> 215       * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic.</span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 216       *                                                                                                            </span>
<span class="-1716018750408229582" onmouseenter="enter('-1716018750408229582');" onmouseout="out('-1716018750408229582');" style=""> 217       * @param purgeParams configured parameters for the Cart purge process                                        </span>

<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style=""> 218       * @param cartsInError list of cart ids to be ignored/excluded from the query                                 </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style=""> 219       * @return list of carts to delete                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 220       */                                                                                                           </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style=""><abbr title=" 221      protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 221      protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsIðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 222          String[] nameArray = purgeParams.getNameArray();                                                          </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 223          OrderStatus[] statusArray = purgeParams.getStatusArray();                                                 </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 224          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 225          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style=""><abbr title=" 226          return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 226          return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, leðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227      }                                                                                                             </span>
<span  style=""> 228                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 229      /**                                                                                                           </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style=""><abbr title=" 230       * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 230       * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logicðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 231       *                                                                                                            </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style=""> 232       * @param purgeParams configured parameters for the Customer purge process used in the query                  </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style=""> 233       * @param cartsInError list of cart ids to ignore/exclude from the next purge run                             </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style=""> 234       * @return count of carts to delete                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 235       */                                                                                                           </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 236      /**                                                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 237       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 238       */                                                                                                           </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style=""> 239      protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {                  </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 240          String[] nameArray = purgeParams.getNameArray();                                                          </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 241          OrderStatus[] statusArray = purgeParams.getStatusArray();                                                 </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 242          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 243          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style=""> 244          Long cartBatchSize = purgeParams.getBatchSize();                                                          </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style=""><abbr title=" 245          Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 245          Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreviðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style=""> 246          //return the lesser of the parameter batch size of the count of the orders to purge                       </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style=""> 247          return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248      }                                                                                                             </span>
<span  style=""> 249                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 250      /**                                                                                                           </span>
<span class="-4831217906829284324" onmouseenter="enter('-4831217906829284324');" onmouseout="out('-4831217906829284324');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +     * Notify the cart&#x27;s owner of a pending purge of their cart.                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +     *                                                                                                            </span>
<span class="-1591121872845752466" onmouseenter="enter('-1591121872845752466');" onmouseout="out('-1591121872845752466');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +     * @param cart the cart                                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +     */                                                                                                           </span>
<span class="-1439517530326153748" onmouseenter="enter('-1439517530326153748');" onmouseout="out('-1439517530326153748');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +    protected void notifyCart(Order cart) {                                                                       </span>
<span class="6785017572112928400" onmouseenter="enter('6785017572112928400');" onmouseout="out('6785017572112928400');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +        String emailAddress = getEmailForCart(cart);                                                              </span>
<span class="-8702812354445074278" onmouseenter="enter('-8702812354445074278');" onmouseout="out('-8702812354445074278');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +        if (emailAddress != null) {                                                                               </span>
<span class="4884753630904156580" onmouseenter="enter('4884753630904156580');" onmouseout="out('4884753630904156580');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +            Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();                                                        </span>
<span class="-1876686562124284125" onmouseenter="enter('-1876686562124284125');" onmouseout="out('-1876686562124284125');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +            context.put(&quot;cart&quot;, cart);                                                                            </span>
<span class="-7081183395280146833" onmouseenter="enter('-7081183395280146833');" onmouseout="out('-7081183395280146833');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +            context.put(&quot;customer&quot;, cart.getCustomer());                                                          </span>
<span class="2299045321537655635" onmouseenter="enter('2299045321537655635');" onmouseout="out('2299045321537655635');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +            context.put(&quot;emailAddress&quot;, emailAddress);                                                            </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +            try {                                                                                                 </span>
<span class="-335501726229324372" onmouseenter="enter('-335501726229324372');" onmouseout="out('-335501726229324372');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 264 +                notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificationEventType.NOTIFY_ABANDONED_CART, context));"> 264 +                notificationDispatcher.dispatchNotification(new EmailNotification(emailAddress, NotificationEventTðŸ”µ</abbr></span>
<span class="9220844322816084446" onmouseenter="enter('9220844322816084446');" onmouseout="out('9220844322816084446');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +            } catch (ServiceException e) {                                                                        </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                if (LOG.isDebugEnabled()) {                                                                       </span>
<span class="-238742426127135817" onmouseenter="enter('-238742426127135817');" onmouseout="out('-238742426127135817');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +                    LOG.debug(&quot;Failure to send email notification&quot;, e);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                                                                                                                  </span>
<span class="962012931445232765" onmouseenter="enter('962012931445232765');" onmouseout="out('962012931445232765');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +    protected String getEmailForCart(Order cart) {                                                                </span>
<span class="-1013041921655187511" onmouseenter="enter('-1013041921655187511');" onmouseout="out('-1013041921655187511');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +        if (cart.getEmailAddress() != null) {                                                                     </span>
<span class="9127709401881574307" onmouseenter="enter('9127709401881574307');" onmouseout="out('9127709401881574307');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            return cart.getEmailAddress();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                                                                                                                  </span>
<span class="-4914468579235587722" onmouseenter="enter('-4914468579235587722');" onmouseout="out('-4914468579235587722');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +        if (cart.getCustomer() != null &amp;&amp; cart.getCustomer().getEmailAddress() != null) {                         </span>
<span class="4109268194947089596" onmouseenter="enter('4109268194947089596');" onmouseout="out('4109268194947089596');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +            return cart.getCustomer().getEmailAddress();                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +                                                                                                                  </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +        return null;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +    /**                                                                                                           </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""> 286       * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic.       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 287       *                                                                                                            </span>
<span class="-6771798214247950041" onmouseenter="enter('-6771798214247950041');" onmouseout="out('-6771798214247950041');" style=""> 288       * @param cart the cart to remove                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 289       */                                                                                                           </span>
<span class="621215427910457813" onmouseenter="enter('621215427910457813');" onmouseout="out('621215427910457813');" style=""> 290      protected void deleteCart(Order cart) {                                                                       </span>
<span class="-3274557726078521593" onmouseenter="enter('-3274557726078521593');" onmouseout="out('-3274557726078521593');" style=""><abbr title=" 291          //We delete the order this way (rather than with a delete query) in order to ensure the cascades take place"> 291          //We delete the order this way (rather than with a delete query) in order to ensure the cascades take placðŸ”µ</abbr></span>
<span class="5643426177894030209" onmouseenter="enter('5643426177894030209');" onmouseout="out('5643426177894030209');" style=""> 292          orderService.deleteOrder(cart);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 293      }                                                                                                             </span>
<span  style=""> 294                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 295      /**                                                                                                           </span>
<span class="3205340653525749512" onmouseenter="enter('3205340653525749512');" onmouseout="out('3205340653525749512');" style=""> 296       * Get the Customer Ids from cache that should be ignored due to errors in previous purge attempts            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 297       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 298       * @param purgeParams configured parameters for the Customer purge process                                    </span>
<span class="-5970206514796632950" onmouseenter="enter('-5970206514796632950');" onmouseout="out('-5970206514796632950');" style=""> 299       * @return set of customer ids to ignore/exclude from the next purge run                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 300       */                                                                                                           </span>
<span class="-3065693137793837519" onmouseenter="enter('-3065693137793837519');" onmouseout="out('-3065693137793837519');" style=""> 301      protected Set&lt;Long&gt; getCustomersInErrorToIgnore(CustomerPurgeParams purgeParams) {                            </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 302          long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                               </span>
<span class="-7599335319839599610" onmouseenter="enter('-7599335319839599610');" onmouseout="out('-7599335319839599610');" style=""> 303          Set&lt;Long&gt; ignoreFailedCustomerIds = customerPurgeErrors.getEntriesSince(ignoreFailedExpiration);          </span>
<span class="-6742430259144212604" onmouseenter="enter('-6742430259144212604');" onmouseout="out('-6742430259144212604');" style=""> 304          return ignoreFailedCustomerIds;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305      }                                                                                                             </span>
<span  style=""> 306                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 307      /**                                                                                                           </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""> 308       * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic.</span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 309       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 310       * @param purgeParams configured parameters for the Customer purge process                                    </span>

<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 311       * @param customersInError list of customer ids to be ignored/excluded from the query                         </span>
<span class="6504215439929103259" onmouseenter="enter('6504215439929103259');" onmouseout="out('6504215439929103259');" style=""> 312       * @return list of customers to delete                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 313       */                                                                                                           </span>
<span class="-1507004170363559761" onmouseenter="enter('-1507004170363559761');" onmouseout="out('-1507004170363559761');" style=""><abbr title=" 314      protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; customersInError) {"> 314      protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;LðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 315          Boolean isRegistered = purgeParams.getIsRegistered();                                                     </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 316          Boolean isDeactivated = purgeParams.getIsDeactivated();                                                   </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 317          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 318          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-2312253704458899930" onmouseenter="enter('-2312253704458899930');" onmouseout="out('-2312253704458899930');" style=""><abbr title=" 319          return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, startPos, length, customersInError);"> 319          return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 320      }                                                                                                             </span>
<span  style=""> 321                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 322      /**                                                                                                           </span>
<span class="8648259411111567723" onmouseenter="enter('8648259411111567723');" onmouseout="out('8648259411111567723');" style=""><abbr title=" 323       * Get the count of customers to delete from the database. Subclasses may override for custom customer retrieval logic."> 323       * Get the count of customers to delete from the database. Subclasses may override for custom customer retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 324       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 325       * @param purgeParams configured parameters for the Customer purge process                                    </span>

<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 326       * @param customersInError list of customer ids to be ignored/excluded from the query                         </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 327       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 328       */                                                                                                           </span>
<span class="8294886805011187143" onmouseenter="enter('8294886805011187143');" onmouseout="out('8294886805011187143');" style=""> 329      protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInError) {      </span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 330          Boolean isRegistered = purgeParams.getIsRegistered();                                                     </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 331          Boolean isDeactivated = purgeParams.getIsDeactivated();                                                   </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 332          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 333          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-6790142400743483163" onmouseenter="enter('-6790142400743483163');" onmouseout="out('-6790142400743483163');" style=""> 334          Long customerBatchSize = purgeParams.getBatchSize();                                                      </span>
<span class="-6217873247193256304" onmouseenter="enter('-6217873247193256304');" onmouseout="out('-6217873247193256304');" style=""><abbr title=" 335          Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, customersInError);"> 335          Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivðŸ”µ</abbr></span>
<span class="-4628315344870235824" onmouseenter="enter('-4628315344870235824');" onmouseout="out('-4628315344870235824');" style=""> 336          //return the lesser of the parameter batch size of the count of the customers to purge                    </span>
<span class="-6036527682216446677" onmouseenter="enter('-6036527682216446677');" onmouseout="out('-6036527682216446677');" style=""><abbr title=" 337          return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCount;"> 337          return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCounðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338      }                                                                                                             </span>
<span  style=""> 339                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 340      /**                                                                                                           </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""> 341       * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic.       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 342       *                                                                                                            </span>
<span class="-897887194989371766" onmouseenter="enter('-897887194989371766');" onmouseout="out('-897887194989371766');" style=""> 343       * @param customer the customer to remove                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 344       */                                                                                                           </span>
<span class="9030957329407065452" onmouseenter="enter('9030957329407065452');" onmouseout="out('9030957329407065452');" style=""> 345      protected void deleteCustomer(Customer customer) {                                                            </span>
<span class="-4425816966306665584" onmouseenter="enter('-4425816966306665584');" onmouseout="out('-4425816966306665584');" style=""><abbr title=" 346          //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take place"> 346          //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take pðŸ”µ</abbr></span>
<span class="4420445378351605906" onmouseenter="enter('4420445378351605906');" onmouseout="out('4420445378351605906');" style=""> 347          customerService.deleteCustomer(customer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348      }                                                                                                             </span>
<span  style=""> 349                                                                                                                    </span>
<span class="2605850108496977404" onmouseenter="enter('2605850108496977404');" onmouseout="out('2605850108496977404');" style=""> 350      private class CartPurgeParams {                                                                               </span>
<span  style=""> 351                                                                                                                    </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 352          private Map&lt;String, String&gt; config;                                                                       </span>
<span class="1381900387592843642" onmouseenter="enter('1381900387592843642');" onmouseout="out('1381900387592843642');" style=""> 353          private String[] nameArray;                                                                               </span>
<span class="8331062799574265987" onmouseenter="enter('8331062799574265987');" onmouseout="out('8331062799574265987');" style=""> 354          private OrderStatus[] statusArray;                                                                        </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 355          private Date dateCreatedMinThreshold;                                                                     </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 356          private Boolean isPreview;                                                                                </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 357          private Long batchSize;                                                                                   </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 358          private Long failedRetryTime;                                                                             </span>
<span  style=""> 359                                                                                                                    </span>
<span class="2815224750970340197" onmouseenter="enter('2815224750970340197');" onmouseout="out('2815224750970340197');" style=""> 360          public CartPurgeParams(Map&lt;String, String&gt; config) {                                                      </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 361              this.config = config;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362          }                                                                                                         </span>
<span  style=""> 363                                                                                                                    </span>
<span class="-686271337436163522" onmouseenter="enter('-686271337436163522');" onmouseout="out('-686271337436163522');" style=""> 364          public String[] getNameArray() {                                                                          </span>
<span class="-6597175720812897488" onmouseenter="enter('-6597175720812897488');" onmouseout="out('-6597175720812897488');" style=""> 365              return nameArray;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366          }                                                                                                         </span>
<span  style=""> 367                                                                                                                    </span>
<span class="-4470666030488291109" onmouseenter="enter('-4470666030488291109');" onmouseout="out('-4470666030488291109');" style=""> 368          public OrderStatus[] getStatusArray() {                                                                   </span>
<span class="1669553314396389775" onmouseenter="enter('1669553314396389775');" onmouseout="out('1669553314396389775');" style=""> 369              return statusArray;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 370          }                                                                                                         </span>
<span  style=""> 371                                                                                                                    </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 372          public Date getDateCreatedMinThreshold() {                                                                </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 373              return dateCreatedMinThreshold;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 374          }                                                                                                         </span>
<span  style=""> 375                                                                                                                    </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 376          public Boolean getIsPreview() {                                                                           </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 377              return isPreview;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378          }                                                                                                         </span>
<span  style=""> 379                                                                                                                    </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 380          public Long getBatchSize() {                                                                              </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 381              return batchSize;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382          }                                                                                                         </span>
<span  style=""> 383                                                                                                                    </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 384          public Long getFailedRetryTime() {                                                                        </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 385              return failedRetryTime;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386          }                                                                                                         </span>
<span  style=""> 387                                                                                                                    </span>
<span class="-2086671766953086341" onmouseenter="enter('-2086671766953086341');" onmouseout="out('-2086671766953086341');" style=""> 388          public CartPurgeParams invoke() {                                                                         </span>
<span class="2406323390572474949" onmouseenter="enter('2406323390572474949');" onmouseout="out('2406323390572474949');" style=""> 389              nameArray = null;                                                                                     </span>
<span class="-8056479474459794956" onmouseenter="enter('-8056479474459794956');" onmouseout="out('-8056479474459794956');" style=""> 390              statusArray = null;                                                                                   </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 391              dateCreatedMinThreshold = null;                                                                       </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 392              isPreview = null;                                                                                     </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 393              batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                                      </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 394              failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                           </span>
<span  style=""> 395                                                                                                                    </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 396              for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                           </span>
<span class="7230126592195401480" onmouseenter="enter('7230126592195401480');" onmouseout="out('7230126592195401480');" style=""> 397                  if (PurgeCartVariableNames.STATUS.toString().equals(entry.getKey())) {                            </span>
<span class="-3887059016856253482" onmouseenter="enter('-3887059016856253482');" onmouseout="out('-3887059016856253482');" style=""> 398                      String[] temp = entry.getValue().split(&quot;,&quot;);                                                  </span>
<span class="-984189042629809269" onmouseenter="enter('-984189042629809269');" onmouseout="out('-984189042629809269');" style=""> 399                      statusArray = new OrderStatus[temp.length];                                                   </span>
<span class="7424479410662112456" onmouseenter="enter('7424479410662112456');" onmouseout="out('7424479410662112456');" style=""> 400                      int index = 0;                                                                                </span>
<span class="-6857112710843456451" onmouseenter="enter('-6857112710843456451');" onmouseout="out('-6857112710843456451');" style=""> 401                      for (String name : temp) {                                                                    </span>
<span class="4249642856708256048" onmouseenter="enter('4249642856708256048');" onmouseout="out('4249642856708256048');" style=""> 402                          OrderStatus orderStatus = OrderStatus.getInstance(name);                                  </span>
<span class="354647143791226174" onmouseenter="enter('354647143791226174');" onmouseout="out('354647143791226174');" style=""> 403                          statusArray[index] = orderStatus;                                                         </span>
<span class="8743575581853771534" onmouseenter="enter('8743575581853771534');" onmouseout="out('8743575581853771534');" style=""> 404                          index++;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 405                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 406                  }                                                                                                 </span>
<span class="-680570050183499360" onmouseenter="enter('-680570050183499360');" onmouseout="out('-680570050183499360');" style=""> 407                  if (PurgeCartVariableNames.NAME.toString().equals(entry.getKey())) {                              </span>
<span class="3793410955933370059" onmouseenter="enter('3793410955933370059');" onmouseout="out('3793410955933370059');" style=""> 408                      nameArray = entry.getValue().split(&quot;,&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409                  }                                                                                                 </span>
<span class="5654291195038602061" onmouseenter="enter('5654291195038602061');" onmouseout="out('5654291195038602061');" style=""> 410                  if (PurgeCartVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {                       </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 411                      Long secondsOld = Long.parseLong(entry.getValue());                                           </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 412                      dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 413                  }                                                                                                 </span>
<span class="-3116043338550155301" onmouseenter="enter('-3116043338550155301');" onmouseout="out('-3116043338550155301');" style=""> 414                  if (PurgeCartVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {                        </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 415                      isPreview = Boolean.parseBoolean(entry.getValue());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416                  }                                                                                                 </span>
<span class="-7209605236483980682" onmouseenter="enter('-7209605236483980682');" onmouseout="out('-7209605236483980682');" style=""> 417                  if (PurgeCartVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {                        </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 418                      batchSize = Long.parseLong(entry.getValue());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419                  }                                                                                                 </span>
<span class="6665497140882829750" onmouseenter="enter('6665497140882829750');" onmouseout="out('6665497140882829750');" style=""> 420                  if (PurgeCartVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {              </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""> 421                      failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423              }                                                                                                     </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 424              return this;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 425          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426      }                                                                                                             </span>
<span  style=""> 427                                                                                                                    </span>
<span class="6135355437794836082" onmouseenter="enter('6135355437794836082');" onmouseout="out('6135355437794836082');" style=""> 428      private class CustomerPurgeParams {                                                                           </span>
<span  style=""> 429                                                                                                                    </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 430          private Map&lt;String, String&gt; config;                                                                       </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 431          private Date dateCreatedMinThreshold;                                                                     </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 432          private Boolean isPreview;                                                                                </span>
<span class="5345429142323969812" onmouseenter="enter('5345429142323969812');" onmouseout="out('5345429142323969812');" style=""> 433          private Boolean isRegistered;                                                                             </span>
<span class="3484617240152312252" onmouseenter="enter('3484617240152312252');" onmouseout="out('3484617240152312252');" style=""> 434          private Boolean isDeactivated;                                                                            </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 435          private Long batchSize;                                                                                   </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 436          private Long failedRetryTime;                                                                             </span>
<span  style=""> 437                                                                                                                    </span>
<span class="-3439970468083719495" onmouseenter="enter('-3439970468083719495');" onmouseout="out('-3439970468083719495');" style=""> 438          public CustomerPurgeParams(Map&lt;String, String&gt; config) {                                                  </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 439              this.config = config;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440          }                                                                                                         </span>
<span  style=""> 441                                                                                                                    </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 442          public Date getDateCreatedMinThreshold() {                                                                </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 443              return dateCreatedMinThreshold;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 444          }                                                                                                         </span>
<span  style=""> 445                                                                                                                    </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 446          public Boolean getIsPreview() {                                                                           </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 447              return isPreview;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 448          }                                                                                                         </span>
<span  style=""> 449                                                                                                                    </span>
<span class="-4523160162166092089" onmouseenter="enter('-4523160162166092089');" onmouseout="out('-4523160162166092089');" style=""> 450          public Boolean getIsRegistered() {                                                                        </span>
<span class="6500879271821699409" onmouseenter="enter('6500879271821699409');" onmouseout="out('6500879271821699409');" style=""> 451              return isRegistered;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 452          }                                                                                                         </span>
<span  style=""> 453                                                                                                                    </span>
<span class="831937501284736178" onmouseenter="enter('831937501284736178');" onmouseout="out('831937501284736178');" style=""> 454          public Boolean getIsDeactivated() {                                                                       </span>
<span class="-8572023523120285779" onmouseenter="enter('-8572023523120285779');" onmouseout="out('-8572023523120285779');" style=""> 455              return isDeactivated;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456          }                                                                                                         </span>
<span  style=""> 457                                                                                                                    </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 458          public Long getBatchSize() {                                                                              </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 459              return batchSize;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460          }                                                                                                         </span>
<span  style=""> 461                                                                                                                    </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 462          public Long getFailedRetryTime() {                                                                        </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 463              return failedRetryTime;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464          }                                                                                                         </span>
<span  style=""> 465                                                                                                                    </span>
<span class="4345643298854756592" onmouseenter="enter('4345643298854756592');" onmouseout="out('4345643298854756592');" style=""> 466          public CustomerPurgeParams invoke() {                                                                     </span>
<span class="-2554699908388798358" onmouseenter="enter('-2554699908388798358');" onmouseout="out('-2554699908388798358');" style=""> 467              isRegistered = null;                                                                                  </span>
<span class="-4109360067770509892" onmouseenter="enter('-4109360067770509892');" onmouseout="out('-4109360067770509892');" style=""> 468              isDeactivated = null;                                                                                 </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 469              dateCreatedMinThreshold = null;                                                                       </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 470              isPreview = null;                                                                                     </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 471              batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                                      </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 472              failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                           </span>
<span  style=""> 473                                                                                                                    </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 474              for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                           </span>
<span class="8500820035603099955" onmouseenter="enter('8500820035603099955');" onmouseout="out('8500820035603099955');" style=""> 475                  if (PurgeCustomerVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {                   </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 476                      Long secondsOld = Long.parseLong(entry.getValue());                                           </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 477                      dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478                  }                                                                                                 </span>
<span class="472649037401986768" onmouseenter="enter('472649037401986768');" onmouseout="out('472649037401986768');" style=""> 479                  if (PurgeCustomerVariableNames.IS_REGISTERED.toString().equals(entry.getKey())) {                 </span>
<span class="3066848756297460347" onmouseenter="enter('3066848756297460347');" onmouseout="out('3066848756297460347');" style=""> 480                      isRegistered = Boolean.parseBoolean(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481                  }                                                                                                 </span>
<span class="-6798790184150039593" onmouseenter="enter('-6798790184150039593');" onmouseout="out('-6798790184150039593');" style=""> 482                  if (PurgeCustomerVariableNames.IS_DEACTIVATED.toString().equals(entry.getKey())) {                </span>
<span class="8770174800886691615" onmouseenter="enter('8770174800886691615');" onmouseout="out('8770174800886691615');" style=""> 483                      isDeactivated = Boolean.parseBoolean(entry.getValue());                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484                  }                                                                                                 </span>
<span class="-4202787563999133129" onmouseenter="enter('-4202787563999133129');" onmouseout="out('-4202787563999133129');" style=""> 485                  if (PurgeCustomerVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {                    </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 486                      isPreview = Boolean.parseBoolean(entry.getValue());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 487                  }                                                                                                 </span>
<span class="2949192035259803609" onmouseenter="enter('2949192035259803609');" onmouseout="out('2949192035259803609');" style=""> 488                  if (PurgeCustomerVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {                    </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 489                      batchSize = Long.parseLong(entry.getValue());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490                  }                                                                                                 </span>
<span class="3875509270375211860" onmouseenter="enter('3875509270375211860');" onmouseout="out('3875509270375211860');" style=""> 491                  if (PurgeCustomerVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {          </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""> 492                      failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 493                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494              }                                                                                                     </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 495              return this;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497      }                                                                                                             </span>
<span  style=""> 498                                                                                                                    </span>
<span class="-4423643614963439423" onmouseenter="enter('-4423643614963439423');" onmouseout="out('-4423643614963439423');" style=""> 499      private class PurgeErrorCache {                                                                               </span>
<span  style=""> 500                                                                                                                    </span>
<span class="198672241784651248" onmouseenter="enter('198672241784651248');" onmouseout="out('198672241784651248');" style=""> 501          private Map&lt;Long, Long&gt; cache = new HashMap&lt;Long, Long&gt;();                                                </span>
<span  style=""> 502                                                                                                                    </span>
<span class="-5066122402174219646" onmouseenter="enter('-5066122402174219646');" onmouseout="out('-5066122402174219646');" style=""> 503          public Long add(Long entry) {                                                                             </span>
<span class="7659524906429939754" onmouseenter="enter('7659524906429939754');" onmouseout="out('7659524906429939754');" style=""> 504              if (! cache.containsKey(entry)) {                                                                     </span>

<span class="-1518558382272290563" onmouseenter="enter('-1518558382272290563');" onmouseout="out('-1518558382272290563');" style=""> 505                  return cache.put(entry, new Long(System.currentTimeMillis()));                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506              }                                                                                                     </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 507              return null;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508          }                                                                                                         </span>
<span  style=""> 509                                                                                                                    </span>
<span class="-5864460220203783413" onmouseenter="enter('-5864460220203783413');" onmouseout="out('-5864460220203783413');" style=""> 510          public Set&lt;Long&gt; getEntriesSince(long expiredTime) {                                                      </span>
<span class="3678487184380758864" onmouseenter="enter('3678487184380758864');" onmouseout="out('3678487184380758864');" style=""> 511              for(Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext(); ) {           </span>

<span class="-7841947474939136830" onmouseenter="enter('-7841947474939136830');" onmouseout="out('-7841947474939136830');" style=""> 512                  Map.Entry&lt;Long, Long&gt; entry = item.next();                                                        </span>
<span class="936602580368160114" onmouseenter="enter('936602580368160114');" onmouseout="out('936602580368160114');" style=""> 513                  if(entry.getValue().longValue() &lt; expiredTime) {                                                  </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style=""> 514                    item.remove();                                                                                  </span>


<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 516              }                                                                                                     </span>
<span class="4846818570039273159" onmouseenter="enter('4846818570039273159');" onmouseout="out('4846818570039273159');" style=""> 517              return cache.keySet();                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518          }                                                                                                         </span>
<span  style=""> 519                                                                                                                    </span>
<span class="5501185527198334216" onmouseenter="enter('5501185527198334216');" onmouseout="out('5501185527198334216');" style=""> 520          public int size() {                                                                                       </span>
<span class="4045092944756323954" onmouseenter="enter('4045092944756323954');" onmouseout="out('4045092944756323954');" style=""> 521              return cache.size();                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522          }                                                                                                         </span>
<span  style=""> 523                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524      }                                                                                                             </span>
<span  style=""> 525                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-392708096265613810" onmouseenter="enter('-392708096265613810');" onmouseout="out('-392708096265613810');" style="">  18  package org.broadleafcommerce.core.util.service;                                                                  </span>
<span  style="">  19                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  20 -import java.util.ArrayList;                                                                                       </span>
<span class="1748005127055838442" onmouseenter="enter('1748005127055838442');" onmouseout="out('1748005127055838442');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  21 -import java.util.Date;                                                                                            </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  22 -import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  23 -import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  24 -import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  25 -import java.util.Map;                                                                                             </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  26 -import java.util.Set;                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  27 -                                                                                                                  </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  28 -import javax.annotation.Resource;                                                                                 </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  29 -                                                                                                                  </span>
<span class="4020017653195254006" onmouseenter="enter('4020017653195254006');" onmouseout="out('4020017653195254006');" style="">  30  import org.apache.commons.collections.MapUtils;                                                                   </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  31  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  32  import org.apache.commons.logging.LogFactory;                                                                     </span>




<span class="1373992879208813777" onmouseenter="enter('1373992879208813777');" onmouseout="out('1373992879208813777');" style="">  33  import org.broadleafcommerce.common.time.SystemTime;                                                              </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  34  import org.broadleafcommerce.common.util.TransactionUtils;                                                        </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  35  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-9126455085472227806" onmouseenter="enter('-9126455085472227806');" onmouseout="out('-9126455085472227806');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.broadleafcommerce.core.order.domain.OrderImpl;                                                         </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  37  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="614288234168063731" onmouseenter="enter('614288234168063731');" onmouseout="out('614288234168063731');" style="">  38  import org.broadleafcommerce.core.order.service.type.OrderStatus;                                                 </span>
<span class="-2163215554749194852" onmouseenter="enter('-2163215554749194852');" onmouseout="out('-2163215554749194852');" style="">  39  import org.broadleafcommerce.core.util.dao.ResourcePurgeDao;                                                      </span>
<span class="-588391581938444696" onmouseenter="enter('-588391581938444696');" onmouseout="out('-588391581938444696');" style="">  40  import org.broadleafcommerce.core.util.service.type.PurgeCartVariableNames;                                       </span>
<span class="191348614738138536" onmouseenter="enter('191348614738138536');" onmouseout="out('191348614738138536');" style="">  41  import org.broadleafcommerce.core.util.service.type.PurgeCustomerVariableNames;                                   </span>
<span class="8877081811676575024" onmouseenter="enter('8877081811676575024');" onmouseout="out('8877081811676575024');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import org.broadleafcommerce.core.util.service.type.PurgeOrderHistoryVariableNames;                               </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  43  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="2095059086545149108" onmouseenter="enter('2095059086545149108');" onmouseout="out('2095059086545149108');" style="">  44  import org.broadleafcommerce.profile.core.service.CustomerService;                                                </span>
<span class="-1504015732959009083" onmouseenter="enter('-1504015732959009083');" onmouseout="out('-1504015732959009083');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.hibernate.Session;                                                                                     </span>
<span class="1031102842064240387" onmouseenter="enter('1031102842064240387');" onmouseout="out('1031102842064240387');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import org.hibernate.jdbc.Work;                                                                                   </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.springframework.core.env.Environment;                                                                  </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  49  import org.springframework.stereotype.Service;                                                                    </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  50  import org.springframework.transaction.PlatformTransactionManager;                                                </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  51  import org.springframework.transaction.TransactionDefinition;                                                     </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  52  import org.springframework.transaction.TransactionStatus;                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +                                                                                                                  </span>
<span class="-7136330293413175449" onmouseenter="enter('-7136330293413175449');" onmouseout="out('-7136330293413175449');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import java.sql.Connection;                                                                                       </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import java.sql.SQLException;                                                                                     </span>
<span class="6402527026259660908" onmouseenter="enter('6402527026259660908');" onmouseout="out('6402527026259660908');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import java.sql.Statement;                                                                                        </span>
<span class="196713859697444637" onmouseenter="enter('196713859697444637');" onmouseout="out('196713859697444637');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +import java.util.*;                                                                                               </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +                                                                                                                  </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import javax.annotation.Resource;                                                                                 </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import javax.persistence.EntityManager;                                                                           </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import javax.persistence.PersistenceContext;                                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +                                                                                                                  </span>
<span  style="">  63                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  64  /**                                                                                                               </span>
<span class="-3191869593089593640" onmouseenter="enter('-3191869593089593640');" onmouseout="out('-3191869593089593640');" style=""><abbr title="  65   * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous Customers).">  65   * Service capable of deleting old or defunct entities from the persistence layer (e.g. Carts and anonymous CustomðŸ”µ</abbr></span>
<span class="832835515286180797" onmouseenter="enter('832835515286180797');" onmouseout="out('832835515286180797');" style="">  66   * {@link ResourcePurgeService} for additional API documentation.                                                 </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  67   * &lt;p/&gt;                                                                                                           </span>
<span class="-315394129855994292" onmouseenter="enter('-315394129855994292');" onmouseout="out('-315394129855994292');" style="">  68   * A basic Quartz scheduled job configuration for calling this service can be configured as follows:              </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  69   * &lt;p/&gt;                                                                                                           </span>
<span class="-131984816008333551" onmouseenter="enter('-131984816008333551');" onmouseout="out('-131984816008333551');" style="">  70   * {@code                                                                                                         </span>
<span class="8079836627557216097" onmouseenter="enter('8079836627557216097');" onmouseout="out('8079836627557216097');" style="">  71   * &lt;bean id=&quot;purgeCartConfig&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;                    </span>
<span class="8809411245832543538" onmouseenter="enter('8809411245832543538');" onmouseout="out('8809411245832543538');" style="">  72   * &lt;property name=&quot;sourceMap&quot;&gt;                                                                                    </span>
<span class="-4290418952995175850" onmouseenter="enter('-4290418952995175850');" onmouseout="out('-4290418952995175850');" style="">  73   * &lt;map&gt;                                                                                                          </span>
<span class="5370217760353547455" onmouseenter="enter('5370217760353547455');" onmouseout="out('5370217760353547455');" style="">  74   * &lt;entry key=&quot;SECONDS_OLD&quot; value=&quot;2592000&quot;/&gt;                                                                     </span>
<span class="-1857330153031469850" onmouseenter="enter('-1857330153031469850');" onmouseout="out('-1857330153031469850');" style="">  75   * &lt;entry key=&quot;STATUS&quot; value=&quot;IN_PROCESS&quot;/&gt;                                                                       </span>
<span class="-1596267147682690356" onmouseenter="enter('-1596267147682690356');" onmouseout="out('-1596267147682690356');" style="">  76   * &lt;/map&gt;                                                                                                         </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  77   * &lt;/property&gt;                                                                                                    </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  78   * &lt;/bean&gt;                                                                                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  79   * &lt;p/&gt;                                                                                                           </span>
<span class="5857689149403140530" onmouseenter="enter('5857689149403140530');" onmouseout="out('5857689149403140530');" style="">  80   * &lt;bean id=&quot;purgeCartJobDetail&quot; class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;</span>
<span class="-390919979070777656" onmouseenter="enter('-390919979070777656');" onmouseout="out('-390919979070777656');" style="">  81   * &lt;property name=&quot;targetObject&quot; ref=&quot;blResourcePurgeService&quot; /&gt;                                                  </span>
<span class="-1711168238872066589" onmouseenter="enter('-1711168238872066589');" onmouseout="out('-1711168238872066589');" style="">  82   * &lt;property name=&quot;targetMethod&quot; value=&quot;purgeCarts&quot; /&gt;                                                            </span>
<span class="4875414778543091051" onmouseenter="enter('4875414778543091051');" onmouseout="out('4875414778543091051');" style="">  83   * &lt;property name=&quot;arguments&quot;&gt;                                                                                    </span>
<span class="6000473589228105200" onmouseenter="enter('6000473589228105200');" onmouseout="out('6000473589228105200');" style="">  84   * &lt;list&gt;                                                                                                         </span>
<span class="-1321283090282055520" onmouseenter="enter('-1321283090282055520');" onmouseout="out('-1321283090282055520');" style="">  85   * &lt;ref bean=&quot;purgeCartConfig&quot;/&gt;                                                                                  </span>
<span class="2486531046171828364" onmouseenter="enter('2486531046171828364');" onmouseout="out('2486531046171828364');" style="">  86   * &lt;/list&gt;                                                                                                        </span>
<span class="1062872140657628429" onmouseenter="enter('1062872140657628429');" onmouseout="out('1062872140657628429');" style="">  87   * &lt;/property&gt;                                                                                                    </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  88   * &lt;/bean&gt;                                                                                                        </span>
<span class="4294780129258405519" onmouseenter="enter('4294780129258405519');" onmouseout="out('4294780129258405519');" style="">  89   * &lt;p/&gt;                                                                                                           </span>
<span class="-7915154528943636028" onmouseenter="enter('-7915154528943636028');" onmouseout="out('-7915154528943636028');" style="">  90   * &lt;bean id=&quot;purgeCartTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;            </span>
<span class="5235847799914996571" onmouseenter="enter('5235847799914996571');" onmouseout="out('5235847799914996571');" style="">  91   * &lt;property name=&quot;jobDetail&quot; ref=&quot;purgeCartJobDetail&quot; /&gt;                                                         </span>
<span class="-1206739829467768833" onmouseenter="enter('-1206739829467768833');" onmouseout="out('-1206739829467768833');" style="">  92   * &lt;property name=&quot;startDelay&quot; value=&quot;30000&quot; /&gt;                                                                   </span>
<span class="-7327795866109106158" onmouseenter="enter('-7327795866109106158');" onmouseout="out('-7327795866109106158');" style="">  93   * &lt;property name=&quot;repeatInterval&quot; value=&quot;86400000&quot; /&gt;                                                            </span>
<span class="-1776815082936035208" onmouseenter="enter('-1776815082936035208');" onmouseout="out('-1776815082936035208');" style="">  94   * &lt;/bean&gt;                                                                                                        </span>
<span class="3684153123693005881" onmouseenter="enter('3684153123693005881');" onmouseout="out('3684153123693005881');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  95 - *}                                                                                                               </span>
<span class="8941010846014250828" onmouseenter="enter('8941010846014250828');" onmouseout="out('8941010846014250828');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 + * }                                                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 + *                                                                                                                </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  98   * @author Jeff Fischer                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99   */                                                                                                               </span>
<span class="-5822344749670970380" onmouseenter="enter('-5822344749670970380');" onmouseout="out('-5822344749670970380');" style=""> 100  @Service(&quot;blResourcePurgeService&quot;)                                                                                </span>
<span class="873248027020485265" onmouseenter="enter('873248027020485265');" onmouseout="out('873248027020485265');" style=""> 101  public class ResourcePurgeServiceImpl implements ResourcePurgeService {                                           </span>
<span  style=""> 102                                                                                                                    </span>
<span class="-6373274908004434475" onmouseenter="enter('-6373274908004434475');" onmouseout="out('-6373274908004434475');" style=""> 103      private static final Log LOG = LogFactory.getLog(ResourcePurgeServiceImpl.class);                             </span>
<span  style=""> 104                                                                                                                    </span>
<span class="149979258544894255" onmouseenter="enter('149979258544894255');" onmouseout="out('149979258544894255');" style=""> 105      private static final Long BATCH_SIZE = 50L;                                                                   </span>
<span class="-4253097523145751645" onmouseenter="enter('-4253097523145751645');" onmouseout="out('-4253097523145751645');" style=""> 106      private static final Long PURGE_ERROR_CACHE_RETRY_SECONDS = System.currentTimeMillis() - 172800; //48 HOURS   </span>
<span  style=""> 107                                                                                                                    </span>
<span class="8526754740985159609" onmouseenter="enter('8526754740985159609');" onmouseout="out('8526754740985159609');" style=""> 108      protected PurgeErrorCache customerPurgeErrors = new PurgeErrorCache();                                        </span>
<span class="4108358954087572821" onmouseenter="enter('4108358954087572821');" onmouseout="out('4108358954087572821');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    protected PurgeErrorCache historyPurgeErrors = new PurgeErrorCache();                                         </span>
<span class="7366515115260261905" onmouseenter="enter('7366515115260261905');" onmouseout="out('7366515115260261905');" style=""> 110      protected PurgeErrorCache cartPurgeErrors = new PurgeErrorCache();                                            </span>
<span  style=""> 111                                                                                                                    </span>
<span class="-2629969533830190342" onmouseenter="enter('-2629969533830190342');" onmouseout="out('-2629969533830190342');" style=""> 112      @Resource(name = &quot;blTransactionManager&quot;)                                                                      </span>
<span class="-8090157640080505156" onmouseenter="enter('-8090157640080505156');" onmouseout="out('-8090157640080505156');" style=""> 113      protected PlatformTransactionManager transactionManager;                                                      </span>
<span  style=""> 114                                                                                                                    </span>
<span class="-2129959487514464786" onmouseenter="enter('-2129959487514464786');" onmouseout="out('-2129959487514464786');" style=""> 115      @Resource(name = &quot;blResourcePurgeDao&quot;)                                                                        </span>
<span class="1336580446360306350" onmouseenter="enter('1336580446360306350');" onmouseout="out('1336580446360306350');" style=""> 116      protected ResourcePurgeDao resourcePurgeDao;                                                                  </span>
<span  style=""> 117                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 118      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 119      protected OrderService orderService;                                                                          </span>
<span  style=""> 120                                                                                                                    </span>
<span class="6969754559269026560" onmouseenter="enter('6969754559269026560');" onmouseout="out('6969754559269026560');" style=""> 121      @Resource(name = &quot;blCustomerService&quot;)                                                                         </span>
<span class="5369585293672379772" onmouseenter="enter('5369585293672379772');" onmouseout="out('5369585293672379772');" style=""> 122      protected CustomerService customerService;                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                                                                                                                  </span>
<span class="695241785881102503" onmouseenter="enter('695241785881102503');" onmouseout="out('695241785881102503');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    @Resource(name = &quot;blDeleteStatementGenerator&quot;)                                                                </span>
<span class="-7581585138447328467" onmouseenter="enter('-7581585138447328467');" onmouseout="out('-7581585138447328467');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +    protected DeleteStatementGenerator deleteStatementGenerator;                                                  </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                                                                                                                  </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    @Autowired                                                                                                    </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    protected Environment env;                                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                                                                                                                  </span>
<span class="5710637357667853932" onmouseenter="enter('5710637357667853932');" onmouseout="out('5710637357667853932');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    @PersistenceContext(unitName = &quot;blPU&quot;)                                                                        </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +    protected EntityManager em;                                                                                   </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                                                                                                                  </span>
<span class="-3119890949520834785" onmouseenter="enter('-3119890949520834785');" onmouseout="out('-3119890949520834785');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    @Resource(name = &quot;blResourcePurgeExtensionManager&quot;)                                                           </span>
<span class="8180782340617912300" onmouseenter="enter('8180782340617912300');" onmouseout="out('8180782340617912300');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    protected ResourcePurgeExtensionManager extensionManager;                                                     </span>
<span  style=""> 135                                                                                                                    </span>




<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 136      @Override                                                                                                     </span>
<span class="4309385457274814832" onmouseenter="enter('4309385457274814832');" onmouseout="out('4309385457274814832');" style=""> 137      public void purgeCarts(final Map&lt;String, String&gt; config) {                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 138          if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="5550302810575666152" onmouseenter="enter('5550302810575666152');" onmouseout="out('5550302810575666152');" style=""> 139              LOG.debug(&quot;Purging carts&quot;);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140          }                                                                                                         </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 141          if (MapUtils.isEmpty(config)) {                                                                           </span>
<span class="3953017611065787641" onmouseenter="enter('3953017611065787641');" onmouseout="out('3953017611065787641');" style=""> 142              throw new IllegalArgumentException(&quot;Cannot purge carts since there was no configuration provided. &quot; + </span>
<span class="2154481066552651618" onmouseenter="enter('2154481066552651618');" onmouseout="out('2154481066552651618');" style=""> 143                      &quot;In the absence of config params, all carts would be candidates for deletion.&quot;);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144          }                                                                                                         </span>
<span class="949881309937992845" onmouseenter="enter('949881309937992845');" onmouseout="out('949881309937992845');" style=""> 145          CartPurgeParams purgeParams = new CartPurgeParams(config).invoke();                                       </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 146          int processedCount = 0, batchCount = 0;                                                                   </span>
<span class="-6288858101655041374" onmouseenter="enter('-6288858101655041374');" onmouseout="out('-6288858101655041374');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 147 -        synchronized(cartPurgeErrors) {                                                                           </span>
<span class="2493213668953797556" onmouseenter="enter('2493213668953797556');" onmouseout="out('2493213668953797556');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +        synchronized (cartPurgeErrors) {                                                                          </span>
<span class="1786167286676134702" onmouseenter="enter('1786167286676134702');" onmouseout="out('1786167286676134702');" style=""> 149              Set&lt;Long&gt; failedCartIds = getCartsInErrorToIgnore(purgeParams);                                       </span>
<span class="-2989498546082577495" onmouseenter="enter('-2989498546082577495');" onmouseout="out('-2989498546082577495');" style=""> 150              batchCount = getCartsToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCartIds)).intValue();       </span>
<span class="4775895442307908706" onmouseenter="enter('4775895442307908706');" onmouseout="out('4775895442307908706');" style=""> 151              List&lt;Order&gt; carts = getCartsToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCartIds));  </span>
<span class="4413969661253859769" onmouseenter="enter('4413969661253859769');" onmouseout="out('4413969661253859769');" style=""> 152              for (Order cart : carts) {                                                                            </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style=""> 153                  TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                       </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 154                          TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 155                  try {                                                                                             </span>
<span class="4510796021165287410" onmouseenter="enter('4510796021165287410');" onmouseout="out('4510796021165287410');" style=""> 156                      deleteCart(cart);                                                                             </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 157                      TransactionUtils.finalizeTransaction(status, transactionManager, false);                      </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 158                      processedCount++;                                                                             </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 159                  } catch (Exception e) {                                                                           </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 160 -                    if (! status.isCompleted()) {                                                                 </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    if (!status.isCompleted()) {                                                                  </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 162                          TransactionUtils.finalizeTransaction(status, transactionManager, true);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163                      }                                                                                             </span>
<span class="5109618921839591834" onmouseenter="enter('5109618921839591834');" onmouseout="out('5109618921839591834');" style=""> 164                      LOG.error(String.format(&quot;Not able to purge Cart ID: %d&quot;, cart.getId()), e);                   </span>
<span class="-4853598595361674600" onmouseenter="enter('-4853598595361674600');" onmouseout="out('-4853598595361674600');" style=""> 165                      cartPurgeErrors.add(cart.getId());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168          }                                                                                                         </span>
<span class="7794934293570296678" onmouseenter="enter('7794934293570296678');" onmouseout="out('7794934293570296678');" style=""><abbr title=" 169          LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, cartPurgeErrors.size()));"> 169          LOG.info(String.format(&quot;Cart purge batch processed.  Purged %d from total batch size of %d, %d failures caðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170      }                                                                                                             </span>
<span  style=""> 171                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 172      @Override                                                                                                     </span>
<span class="-1802669755772945786" onmouseenter="enter('-1802669755772945786');" onmouseout="out('-1802669755772945786');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 173 +    public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; depends, final Map&lt;String, Integer&gt; config) {"> 173 +    public void purgeOrderHistory(Class&lt;?&gt; rootType, String rootTypeIdValue, Map&lt;String, List&lt;DeleteStatementGenerðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                                                                                                                  </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +        if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="-8653909733810486694" onmouseenter="enter('-8653909733810486694');" onmouseout="out('-8653909733810486694');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +            LOG.debug(&quot;Purging historical orders&quot;);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                                                                                                                  </span>
<span class="-3654204218851766889" onmouseenter="enter('-3654204218851766889');" onmouseout="out('-3654204218851766889');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +        String enablePurge = env.getProperty(&quot;enable.purge.order.history&quot;);                                       </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                                                                                                                  </span>
<span class="-6307477278678171490" onmouseenter="enter('-6307477278678171490');" onmouseout="out('-6307477278678171490');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        if (!Boolean.parseBoolean(enablePurge)) {                                                                 </span>
<span class="-3484703522134094040" onmouseenter="enter('-3484703522134094040');" onmouseout="out('-3484703522134094040');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 182 +            LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.history to true.&quot;);"> 182 +            LOG.info(&quot;Save protection. Purging history is off. Please set property enable.purge.order.history to tðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +            return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                                                                                                                  </span>
<span class="-2659324279400027158" onmouseenter="enter('-2659324279400027158');" onmouseout="out('-2659324279400027158');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +        Integer daysCount = config.get(PurgeOrderHistoryVariableNames.OLDER_THAN_DAYS.toString());                </span>
<span class="8879960017039434329" onmouseenter="enter('8879960017039434329');" onmouseout="out('8879960017039434329');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        Integer batchSize = config.get(PurgeOrderHistoryVariableNames.BATCH_SIZE.toString());                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +                                                                                                                  </span>
<span class="2743860540483018997" onmouseenter="enter('2743860540483018997');" onmouseout="out('2743860540483018997');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +        List&lt;Order&gt; oldOrders = orderService.findOrdersByDaysCount(daysCount, batchSize);                         </span>
<span class="8291766046289306970" onmouseenter="enter('8291766046289306970');" onmouseout="out('8291766046289306970');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        Map&lt;String, List&lt;DeleteStatementGeneratorImpl.PathElement&gt;&gt; dependencies = new HashMap&lt;&gt;(depends);        </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                                                                                                                  </span>
<span class="-4732634170977321510" onmouseenter="enter('-4732634170977321510');" onmouseout="out('-4732634170977321510');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +        List&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderDependencies = new ArrayList&lt;&gt;();                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                                                                                                                  </span>
<span class="8048050619804607819" onmouseenter="enter('8048050619804607819');" onmouseout="out('8048050619804607819');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 194 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, &quot;ORDER_ID&quot;));"> 194 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_LOCK&quot;, &quot;ORDER_ID&quot;, &quot;ORDER_IDðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +                                                                                                                  </span>
<span class="7928252889655920702" onmouseenter="enter('7928252889655920702');" onmouseout="out('7928252889655920702');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +        dependencies.put(&quot;BLC_ORDER&quot;, orderDependencies);                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                                                                                                                  </span>
<span class="1355272824006853176" onmouseenter="enter('1355272824006853176');" onmouseout="out('1355272824006853176');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +        ArrayList&lt;DeleteStatementGeneratorImpl.PathElement&gt; orderItemDependencies = new ArrayList&lt;&gt;();            </span>
<span class="6007887936589274996" onmouseenter="enter('6007887936589274996');" onmouseout="out('6007887936589274996');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 199 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, &quot;ORDER_MULTISHIP_OPTION_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 199 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_ORDER_MULTISHIP_OPTION&quot;, &quot;ORDER_MUðŸ”µ</abbr></span>
<span class="8628014233398989009" onmouseenter="enter('8628014233398989009');" onmouseout="out('8628014233398989009');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 200 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORDER_ITEM_ID&quot;, &quot;ORDER_ITEM_ID&quot;));"> 200 +        orderDependencies.add(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_GIFTWRAP_ORDER_ITEM&quot;, &quot;ORDER_ITEM_ðŸ”µ</abbr></span>
<span class="-4082949278907558346" onmouseenter="enter('-4082949278907558346');" onmouseout="out('-4082949278907558346');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +        dependencies.put(&quot;BLC_ORDER_ITEM&quot;, orderItemDependencies);                                                </span>
<span class="-7586552207458707428" onmouseenter="enter('-7586552207458707428');" onmouseout="out('-7586552207458707428');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 202 +        dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.PathElement(&quot;BLC_PAYMENT_LOG&quot;, &quot;ORDER_PAYMENT_ID&quot;, &quot;ORDER_PAYMENT_ID&quot;)));"> 202 +        dependencies.put(&quot;BLC_ORDER_PAYMENT&quot;, Collections.singletonList(new DeleteStatementGeneratorImpl.PathElemeðŸ”µ</abbr></span>
<span class="6578497182871896533" onmouseenter="enter('6578497182871896533');" onmouseout="out('6578497182871896533');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +        extensionManager.getProxy().addPurgeDependencies(dependencies);                                           </span>
<span class="4830318402684525340" onmouseenter="enter('4830318402684525340');" onmouseout="out('4830318402684525340');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        Set&lt;String&gt; exclusions = new HashSet&lt;&gt;();                                                                 </span>
<span class="-4430846773603202851" onmouseenter="enter('-4430846773603202851');" onmouseout="out('-4430846773603202851');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        exclusions.add(&quot;BLC_ADMIN_USER&quot;);                                                                         </span>
<span class="34011160929975445" onmouseenter="enter('34011160929975445');" onmouseout="out('34011160929975445');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        extensionManager.getProxy().addPurgeExclusions(exclusions);                                               </span>
<span class="4783797439534498468" onmouseenter="enter('4783797439534498468');" onmouseout="out('4783797439534498468');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 207 +        Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrderImpl.class, &quot;?&quot;, dependencies, exclusions);"> 207 +        Map&lt;String, String&gt; deleteStatement = deleteStatementGenerator.generateDeleteStatementsForType(OrderImpl.cðŸ”µ</abbr></span>
<span class="3783061397625598902" onmouseenter="enter('3783061397625598902');" onmouseout="out('3783061397625598902');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +        for (Order order : oldOrders) {                                                                           </span>
<span class="-8072397698544203791" onmouseenter="enter('-8072397698544203791');" onmouseout="out('-8072397698544203791');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +            TransactionStatus status = TransactionUtils.createTransaction(&quot;Cart Purge&quot;,                           </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                    TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +            try {                                                                                                 </span>
<span class="-8448685700561076869" onmouseenter="enter('-8448685700561076869');" onmouseout="out('-8448685700561076869');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                em.unwrap(Session.class).doWork(new Work() {                                                      </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                    @Override                                                                                     </span>
<span class="-4124393681745953188" onmouseenter="enter('-4124393681745953188');" onmouseout="out('-4124393681745953188');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                    public void execute(Connection connection) throws SQLException {                              </span>
<span class="-7878705497542337751" onmouseenter="enter('-7878705497542337751');" onmouseout="out('-7878705497542337751');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +                        Statement statement = connection.createStatement();                                       </span>
<span class="-3449158197612158484" onmouseenter="enter('-3449158197612158484');" onmouseout="out('-3449158197612158484');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                        for (String value : deleteStatement.values()) {                                           </span>
<span class="-4055740799466096202" onmouseenter="enter('-4055740799466096202');" onmouseout="out('-4055740799466096202');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                            String sql = value.replace(&quot;?&quot;, String.valueOf(order.getId()));                       </span>
<span class="5121719000459724566" onmouseenter="enter('5121719000459724566');" onmouseout="out('5121719000459724566');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                            LOG.debug(sql);                                                                       </span>
<span class="5795758955073093328" onmouseenter="enter('5795758955073093328');" onmouseout="out('5795758955073093328');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                            statement.addBatch(sql);                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                        }                                                                                         </span>
<span class="2322675505205288495" onmouseenter="enter('2322675505205288495');" onmouseout="out('2322675505205288495');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                        extensionManager.getProxy().addPurgeStatements(statement, rootTypeIdValue);               </span>
<span class="-1332092965431964598" onmouseenter="enter('-1332092965431964598');" onmouseout="out('-1332092965431964598');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                        statement.executeBatch();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                    }                                                                                             </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                });                                                                                               </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                TransactionUtils.finalizeTransaction(status, transactionManager, false);                          </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +            } catch (Exception e) {                                                                               </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                if (!status.isCompleted()) {                                                                      </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    TransactionUtils.finalizeTransaction(status, transactionManager, true);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                }                                                                                                 </span>
<span class="5843261671853400812" onmouseenter="enter('5843261671853400812');" onmouseout="out('5843261671853400812');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                LOG.error(String.format(&quot;Not able to purge Order ID: %d&quot;, order.getId()), e);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                                                                                                                  </span>
<span class="-1073654053478996749" onmouseenter="enter('-1073654053478996749');" onmouseout="out('-1073654053478996749');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        LOG.info(&quot;Finished purging historical orders.&quot;);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                                                                                                                  </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +    @Override                                                                                                     </span>
<span class="4447368119484600014" onmouseenter="enter('4447368119484600014');" onmouseout="out('4447368119484600014');" style=""> 239      public void purgeCustomers(final Map&lt;String, String&gt; config) {                                                </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 240          if (LOG.isDebugEnabled()) {                                                                               </span>
<span class="1532316588592469018" onmouseenter="enter('1532316588592469018');" onmouseout="out('1532316588592469018');" style=""> 241              LOG.debug(&quot;Purging customers&quot;);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242          }                                                                                                         </span>
<span class="-7912775167730625298" onmouseenter="enter('-7912775167730625298');" onmouseout="out('-7912775167730625298');" style=""> 243          if (MapUtils.isEmpty(config)) {                                                                           </span>
<span class="362564872021724408" onmouseenter="enter('362564872021724408');" onmouseout="out('362564872021724408');" style=""><abbr title=" 244              throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. &quot; +"> 244              throw new IllegalArgumentException(&quot;Cannot purge customers since there was no configuration provided. ðŸ”µ</abbr></span>
<span class="-7406017465356863948" onmouseenter="enter('-7406017465356863948');" onmouseout="out('-7406017465356863948');" style=""> 245                      &quot;In the absence of config params, all customers would be candidates for deletion.&quot;);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246          }                                                                                                         </span>
<span class="-2250958415199181791" onmouseenter="enter('-2250958415199181791');" onmouseout="out('-2250958415199181791');" style=""> 247          CustomerPurgeParams purgeParams = new CustomerPurgeParams(config).invoke();                               </span>
<span class="5369169661750915035" onmouseenter="enter('5369169661750915035');" onmouseout="out('5369169661750915035');" style=""> 248          int processedCount = 0, batchCount = 0;                                                                   </span>
<span class="7229609060981046917" onmouseenter="enter('7229609060981046917');" onmouseout="out('7229609060981046917');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 249 -        synchronized(customerPurgeErrors) {                                                                       </span>
<span class="2523117162231837045" onmouseenter="enter('2523117162231837045');" onmouseout="out('2523117162231837045');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        synchronized (customerPurgeErrors) {                                                                      </span>
<span class="-5609340873002810378" onmouseenter="enter('-5609340873002810378');" onmouseout="out('-5609340873002810378');" style=""> 251              Set&lt;Long&gt; failedCustomerIds = getCustomersInErrorToIgnore(purgeParams);                               </span>
<span class="8543130203601748922" onmouseenter="enter('8543130203601748922');" onmouseout="out('8543130203601748922');" style=""><abbr title=" 252              batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue();"> 252              batchCount = getCustomersToPurgeLength(purgeParams, new ArrayList&lt;Long&gt;(failedCustomerIds)).intValue()ðŸ”µ</abbr></span>
<span class="2915362100650769672" onmouseenter="enter('2915362100650769672');" onmouseout="out('2915362100650769672');" style=""><abbr title=" 253              List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCustomerIds));"> 253              List&lt;Customer&gt; customers = getCustomersToPurge(purgeParams, 0, batchCount, new ArrayList&lt;Long&gt;(failedCðŸ”µ</abbr></span>
<span class="-5523479913680151900" onmouseenter="enter('-5523479913680151900');" onmouseout="out('-5523479913680151900');" style=""> 254              for (Customer customer : customers) {                                                                 </span>
<span class="-9202005329311486032" onmouseenter="enter('-9202005329311486032');" onmouseout="out('-9202005329311486032');" style=""> 255                  TransactionStatus status = TransactionUtils.createTransaction(&quot;Customer Purge&quot;,                   </span>
<span class="2643103741634911267" onmouseenter="enter('2643103741634911267');" onmouseout="out('2643103741634911267');" style=""> 256                          TransactionDefinition.PROPAGATION_REQUIRED, transactionManager, false);                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 257                  try {                                                                                             </span>
<span class="-955282435304412448" onmouseenter="enter('-955282435304412448');" onmouseout="out('-955282435304412448');" style=""> 258                      deleteCustomer(customer);                                                                     </span>
<span class="1624993680032303162" onmouseenter="enter('1624993680032303162');" onmouseout="out('1624993680032303162');" style=""> 259                      TransactionUtils.finalizeTransaction(status, transactionManager, false);                      </span>
<span class="2691960326393360410" onmouseenter="enter('2691960326393360410');" onmouseout="out('2691960326393360410');" style=""> 260                      processedCount++;                                                                             </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 261                  } catch (Exception e) {                                                                           </span>
<span class="5911094047410639407" onmouseenter="enter('5911094047410639407');" onmouseout="out('5911094047410639407');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 262 -                    if (! status.isCompleted()) {                                                                 </span>
<span class="8766574801619350132" onmouseenter="enter('8766574801619350132');" onmouseout="out('8766574801619350132');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                    if (!status.isCompleted()) {                                                                  </span>
<span class="8253539662668603618" onmouseenter="enter('8253539662668603618');" onmouseout="out('8253539662668603618');" style=""> 264                          TransactionUtils.finalizeTransaction(status, transactionManager, true);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 265                      }                                                                                             </span>
<span class="3330863195048517563" onmouseenter="enter('3330863195048517563');" onmouseout="out('3330863195048517563');" style=""> 266                      LOG.error(String.format(&quot;Not able to purge Customer ID: %d&quot;, customer.getId()), e);           </span>
<span class="-3642662021834427674" onmouseenter="enter('-3642662021834427674');" onmouseout="out('-3642662021834427674');" style=""> 267                      customerPurgeErrors.add(customer.getId());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270          }                                                                                                         </span>
<span class="3571526249001205797" onmouseenter="enter('3571526249001205797');" onmouseout="out('3571526249001205797');" style=""><abbr title=" 271          LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failures cached&quot;, processedCount, batchCount, customerPurgeErrors.size()));"> 271          LOG.info(String.format(&quot;Customer purge batch processed.  Purged %d from total batch size of %d, %d failureðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272      }                                                                                                             </span>
<span  style=""> 273                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 274      /**                                                                                                           </span>
<span class="-1093621207136706170" onmouseenter="enter('-1093621207136706170');" onmouseout="out('-1093621207136706170');" style=""><abbr title=" 275       * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cached errors removed."> 275       * Get the Carts Ids from cache that should be ignored due to errors in previous purge attempts.  Expired cachðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 276       *                                                                                                            </span>
<span class="-5486871214743958198" onmouseenter="enter('-5486871214743958198');" onmouseout="out('-5486871214743958198');" style=""> 277       * @param purgeParams configured parameters for the cart purge process                                        </span>
<span class="7166583232396076758" onmouseenter="enter('7166583232396076758');" onmouseout="out('7166583232396076758');" style=""> 278       * @return set of cart ids to ignore/exclude from the next purge run                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 279       */                                                                                                           </span>
<span class="4377962085469330071" onmouseenter="enter('4377962085469330071');" onmouseout="out('4377962085469330071');" style=""> 280      protected Set&lt;Long&gt; getCartsInErrorToIgnore(CartPurgeParams purgeParams) {                                    </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 281          long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                               </span>
<span class="-8375263543014534398" onmouseenter="enter('-8375263543014534398');" onmouseout="out('-8375263543014534398');" style=""> 282          Set&lt;Long&gt; ignoreFailedCartIds = cartPurgeErrors.getEntriesSince(ignoreFailedExpiration);                  </span>
<span class="-7159994013762311226" onmouseenter="enter('-7159994013762311226');" onmouseout="out('-7159994013762311226');" style=""> 283          return ignoreFailedCartIds;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284      }                                                                                                             </span>
<span  style=""> 285                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 286      /**                                                                                                           </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""> 287       * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic.</span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288       *                                                                                                            </span>
<span class="-1716018750408229582" onmouseenter="enter('-1716018750408229582');" onmouseout="out('-1716018750408229582');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 289 -     * @param purgeParams configured parameters for the Cart purge process                                        </span>
<span class="2629836549582755488" onmouseenter="enter('2629836549582755488');" onmouseout="out('2629836549582755488');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +     * @param purgeParams  configured parameters for the Cart purge process                                       </span>
<span class="-3810642240012955866" onmouseenter="enter('-3810642240012955866');" onmouseout="out('-3810642240012955866');" style=""> 291       * @param cartsInError list of cart ids to be ignored/excluded from the query                                 </span>
<span class="2126662938676087029" onmouseenter="enter('2126662938676087029');" onmouseout="out('2126662938676087029');" style=""> 292       * @return list of carts to delete                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 293       */                                                                                                           </span>
<span class="6282059334149758234" onmouseenter="enter('6282059334149758234');" onmouseout="out('6282059334149758234');" style=""><abbr title=" 294      protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsInError) {"> 294      protected List&lt;Order&gt; getCartsToPurge(CartPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; cartsIðŸ”µ</abbr></span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 295          String[] nameArray = purgeParams.getNameArray();                                                          </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 296          OrderStatus[] statusArray = purgeParams.getStatusArray();                                                 </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 297          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 298          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-4147099297420738868" onmouseenter="enter('-4147099297420738868');" onmouseout="out('-4147099297420738868');" style=""><abbr title=" 299          return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, length, cartsInError);"> 299          return resourcePurgeDao.findCarts(nameArray, statusArray, dateCreatedMinThreshold, isPreview, startPos, leðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 300      }                                                                                                             </span>
<span  style=""> 301                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 302      /**                                                                                                           </span>
<span class="3950155233466504101" onmouseenter="enter('3950155233466504101');" onmouseout="out('3950155233466504101');" style=""><abbr title=" 303       * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logic."> 303       * Get the count of carts to delete from the database. Subclasses may override for custom cart retrieval logicðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 304       *                                                                                                            </span>
<span class="3752639224019941217" onmouseenter="enter('3752639224019941217');" onmouseout="out('3752639224019941217');" style=""> 305       * @param purgeParams configured parameters for the Customer purge process used in the query                  </span>
<span class="-6443189664974809515" onmouseenter="enter('-6443189664974809515');" onmouseout="out('-6443189664974809515');" style=""> 306       * @param cartsInError list of cart ids to ignore/exclude from the next purge run                             </span>
<span class="5859026394925449069" onmouseenter="enter('5859026394925449069');" onmouseout="out('5859026394925449069');" style=""> 307       * @return count of carts to delete                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 308       */                                                                                                           </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 309      /**                                                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 310       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 311       */                                                                                                           </span>
<span class="-5853725283790786678" onmouseenter="enter('-5853725283790786678');" onmouseout="out('-5853725283790786678');" style=""> 312      protected Long getCartsToPurgeLength(CartPurgeParams purgeParams, List&lt;Long&gt; cartsInError) {                  </span>
<span class="5060813781700617578" onmouseenter="enter('5060813781700617578');" onmouseout="out('5060813781700617578');" style=""> 313          String[] nameArray = purgeParams.getNameArray();                                                          </span>
<span class="5115879946978512049" onmouseenter="enter('5115879946978512049');" onmouseout="out('5115879946978512049');" style=""> 314          OrderStatus[] statusArray = purgeParams.getStatusArray();                                                 </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 315          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 316          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-5641256246405563716" onmouseenter="enter('-5641256246405563716');" onmouseout="out('-5641256246405563716');" style=""> 317          Long cartBatchSize = purgeParams.getBatchSize();                                                          </span>
<span class="-4986951633838769352" onmouseenter="enter('-4986951633838769352');" onmouseout="out('-4986951633838769352');" style=""><abbr title=" 318          Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreview, cartsInError);"> 318          Long orderCount = resourcePurgeDao.findCartsCount(nameArray, statusArray, dateCreatedMinThreshold, isPreviðŸ”µ</abbr></span>
<span class="-7347257303279112080" onmouseenter="enter('-7347257303279112080');" onmouseout="out('-7347257303279112080');" style=""> 319          //return the lesser of the parameter batch size of the count of the orders to purge                       </span>
<span class="-6429562415480673638" onmouseenter="enter('-6429562415480673638');" onmouseout="out('-6429562415480673638');" style=""> 320          return cartBatchSize != null &amp;&amp; cartBatchSize &lt; orderCount ? cartBatchSize : orderCount;                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 321      }                                                                                                             </span>
<span  style=""> 322                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 323      /**                                                                                                           </span>



































<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""> 324       * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic.       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 325       *                                                                                                            </span>
<span class="-6771798214247950041" onmouseenter="enter('-6771798214247950041');" onmouseout="out('-6771798214247950041');" style=""> 326       * @param cart the cart to remove                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 327       */                                                                                                           </span>
<span class="621215427910457813" onmouseenter="enter('621215427910457813');" onmouseout="out('621215427910457813');" style=""> 328      protected void deleteCart(Order cart) {                                                                       </span>
<span class="-3274557726078521593" onmouseenter="enter('-3274557726078521593');" onmouseout="out('-3274557726078521593');" style=""><abbr title=" 329          //We delete the order this way (rather than with a delete query) in order to ensure the cascades take place"> 329          //We delete the order this way (rather than with a delete query) in order to ensure the cascades take placðŸ”µ</abbr></span>
<span class="5643426177894030209" onmouseenter="enter('5643426177894030209');" onmouseout="out('5643426177894030209');" style=""> 330          orderService.deleteOrder(cart);                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331      }                                                                                                             </span>
<span  style=""> 332                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 333      /**                                                                                                           </span>
<span class="3205340653525749512" onmouseenter="enter('3205340653525749512');" onmouseout="out('3205340653525749512');" style=""> 334       * Get the Customer Ids from cache that should be ignored due to errors in previous purge attempts            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 335       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style=""> 336       * @param purgeParams configured parameters for the Customer purge process                                    </span>
<span class="-5970206514796632950" onmouseenter="enter('-5970206514796632950');" onmouseout="out('-5970206514796632950');" style=""> 337       * @return set of customer ids to ignore/exclude from the next purge run                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 338       */                                                                                                           </span>
<span class="-3065693137793837519" onmouseenter="enter('-3065693137793837519');" onmouseout="out('-3065693137793837519');" style=""> 339      protected Set&lt;Long&gt; getCustomersInErrorToIgnore(CustomerPurgeParams purgeParams) {                            </span>
<span class="-1658335208745663908" onmouseenter="enter('-1658335208745663908');" onmouseout="out('-1658335208745663908');" style=""> 340          long ignoreFailedExpiration = purgeParams.getFailedRetryTime().longValue();                               </span>
<span class="-7599335319839599610" onmouseenter="enter('-7599335319839599610');" onmouseout="out('-7599335319839599610');" style=""> 341          Set&lt;Long&gt; ignoreFailedCustomerIds = customerPurgeErrors.getEntriesSince(ignoreFailedExpiration);          </span>
<span class="-6742430259144212604" onmouseenter="enter('-6742430259144212604');" onmouseout="out('-6742430259144212604');" style=""> 342          return ignoreFailedCustomerIds;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343      }                                                                                                             </span>
<span  style=""> 344                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 345      /**                                                                                                           </span>
<span class="-6733850410845357773" onmouseenter="enter('-6733850410845357773');" onmouseout="out('-6733850410845357773');" style=""> 346       * Get the list of carts to delete from the database. Subclasses may override for custom cart retrieval logic.</span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 347       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 348 -     * @param purgeParams configured parameters for the Customer purge process                                    </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +     * @param purgeParams      configured parameters for the Customer purge process                               </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 350       * @param customersInError list of customer ids to be ignored/excluded from the query                         </span>
<span class="6504215439929103259" onmouseenter="enter('6504215439929103259');" onmouseout="out('6504215439929103259');" style=""> 351       * @return list of customers to delete                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 352       */                                                                                                           </span>
<span class="-1507004170363559761" onmouseenter="enter('-1507004170363559761');" onmouseout="out('-1507004170363559761');" style=""><abbr title=" 353      protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;Long&gt; customersInError) {"> 353      protected List&lt;Customer&gt; getCustomersToPurge(CustomerPurgeParams purgeParams, int startPos, int length, List&lt;LðŸ”µ</abbr></span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 354          Boolean isRegistered = purgeParams.getIsRegistered();                                                     </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 355          Boolean isDeactivated = purgeParams.getIsDeactivated();                                                   </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 356          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 357          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-2312253704458899930" onmouseenter="enter('-2312253704458899930');" onmouseout="out('-2312253704458899930');" style=""><abbr title=" 358          return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, startPos, length, customersInError);"> 358          return resourcePurgeDao.findCustomers(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, staðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 359      }                                                                                                             </span>
<span  style=""> 360                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 361      /**                                                                                                           </span>
<span class="8648259411111567723" onmouseenter="enter('8648259411111567723');" onmouseout="out('8648259411111567723');" style=""><abbr title=" 362       * Get the count of customers to delete from the database. Subclasses may override for custom customer retrieval logic."> 362       * Get the count of customers to delete from the database. Subclasses may override for custom customer retrievðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 363       *                                                                                                            </span>
<span class="-9044452393864250158" onmouseenter="enter('-9044452393864250158');" onmouseout="out('-9044452393864250158');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 364 -     * @param purgeParams configured parameters for the Customer purge process                                    </span>
<span class="3496973929152014882" onmouseenter="enter('3496973929152014882');" onmouseout="out('3496973929152014882');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +     * @param purgeParams      configured parameters for the Customer purge process                               </span>
<span class="5306644792587265933" onmouseenter="enter('5306644792587265933');" onmouseout="out('5306644792587265933');" style=""> 366       * @param customersInError list of customer ids to be ignored/excluded from the query                         </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 367       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 368       */                                                                                                           </span>
<span class="8294886805011187143" onmouseenter="enter('8294886805011187143');" onmouseout="out('8294886805011187143');" style=""> 369      protected Long getCustomersToPurgeLength(CustomerPurgeParams purgeParams, List&lt;Long&gt; customersInError) {      </span>
<span class="-1326554466490988078" onmouseenter="enter('-1326554466490988078');" onmouseout="out('-1326554466490988078');" style=""> 370          Boolean isRegistered = purgeParams.getIsRegistered();                                                     </span>
<span class="2617473268597264846" onmouseenter="enter('2617473268597264846');" onmouseout="out('2617473268597264846');" style=""> 371          Boolean isDeactivated = purgeParams.getIsDeactivated();                                                   </span>
<span class="4819042421731102969" onmouseenter="enter('4819042421731102969');" onmouseout="out('4819042421731102969');" style=""> 372          Date dateCreatedMinThreshold = purgeParams.getDateCreatedMinThreshold();                                  </span>
<span class="2164087603983098692" onmouseenter="enter('2164087603983098692');" onmouseout="out('2164087603983098692');" style=""> 373          Boolean isPreview = purgeParams.getIsPreview();                                                           </span>
<span class="-6790142400743483163" onmouseenter="enter('-6790142400743483163');" onmouseout="out('-6790142400743483163');" style=""> 374          Long customerBatchSize = purgeParams.getBatchSize();                                                      </span>
<span class="-6217873247193256304" onmouseenter="enter('-6217873247193256304');" onmouseout="out('-6217873247193256304');" style=""><abbr title=" 375          Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivated, isPreview, customersInError);"> 375          Long customersCount = resourcePurgeDao.findCustomersCount(dateCreatedMinThreshold, isRegistered, isDeactivðŸ”µ</abbr></span>
<span class="-4628315344870235824" onmouseenter="enter('-4628315344870235824');" onmouseout="out('-4628315344870235824');" style=""> 376          //return the lesser of the parameter batch size of the count of the customers to purge                    </span>
<span class="-6036527682216446677" onmouseenter="enter('-6036527682216446677');" onmouseout="out('-6036527682216446677');" style=""><abbr title=" 377          return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCount;"> 377          return customerBatchSize != null &amp;&amp; customerBatchSize &lt; customersCount ? customerBatchSize : customersCounðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378      }                                                                                                             </span>
<span  style=""> 379                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 380      /**                                                                                                           </span>
<span class="2510158507653106712" onmouseenter="enter('2510158507653106712');" onmouseout="out('2510158507653106712');" style=""> 381       * Remove the cart from the persistence layer. Subclasses may override for custom cart retrieval logic.       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 382       *                                                                                                            </span>
<span class="-897887194989371766" onmouseenter="enter('-897887194989371766');" onmouseout="out('-897887194989371766');" style=""> 383       * @param customer the customer to remove                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 384       */                                                                                                           </span>
<span class="9030957329407065452" onmouseenter="enter('9030957329407065452');" onmouseout="out('9030957329407065452');" style=""> 385      protected void deleteCustomer(Customer customer) {                                                            </span>
<span class="-4425816966306665584" onmouseenter="enter('-4425816966306665584');" onmouseout="out('-4425816966306665584');" style=""><abbr title=" 386          //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take place"> 386          //We delete the customer this way (rather than with a delete query) in order to ensure the cascades take pðŸ”µ</abbr></span>
<span class="4420445378351605906" onmouseenter="enter('4420445378351605906');" onmouseout="out('4420445378351605906');" style=""> 387          customerService.deleteCustomer(customer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 388      }                                                                                                             </span>
<span  style=""> 389                                                                                                                    </span>
<span class="2605850108496977404" onmouseenter="enter('2605850108496977404');" onmouseout="out('2605850108496977404');" style=""> 390      private class CartPurgeParams {                                                                               </span>
<span  style=""> 391                                                                                                                    </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 392          private Map&lt;String, String&gt; config;                                                                       </span>
<span class="1381900387592843642" onmouseenter="enter('1381900387592843642');" onmouseout="out('1381900387592843642');" style=""> 393          private String[] nameArray;                                                                               </span>
<span class="8331062799574265987" onmouseenter="enter('8331062799574265987');" onmouseout="out('8331062799574265987');" style=""> 394          private OrderStatus[] statusArray;                                                                        </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 395          private Date dateCreatedMinThreshold;                                                                     </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 396          private Boolean isPreview;                                                                                </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 397          private Long batchSize;                                                                                   </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 398          private Long failedRetryTime;                                                                             </span>
<span  style=""> 399                                                                                                                    </span>
<span class="2815224750970340197" onmouseenter="enter('2815224750970340197');" onmouseout="out('2815224750970340197');" style=""> 400          public CartPurgeParams(Map&lt;String, String&gt; config) {                                                      </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 401              this.config = config;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402          }                                                                                                         </span>
<span  style=""> 403                                                                                                                    </span>
<span class="-686271337436163522" onmouseenter="enter('-686271337436163522');" onmouseout="out('-686271337436163522');" style=""> 404          public String[] getNameArray() {                                                                          </span>
<span class="-6597175720812897488" onmouseenter="enter('-6597175720812897488');" onmouseout="out('-6597175720812897488');" style=""> 405              return nameArray;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 406          }                                                                                                         </span>
<span  style=""> 407                                                                                                                    </span>
<span class="-4470666030488291109" onmouseenter="enter('-4470666030488291109');" onmouseout="out('-4470666030488291109');" style=""> 408          public OrderStatus[] getStatusArray() {                                                                   </span>
<span class="1669553314396389775" onmouseenter="enter('1669553314396389775');" onmouseout="out('1669553314396389775');" style=""> 409              return statusArray;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 410          }                                                                                                         </span>
<span  style=""> 411                                                                                                                    </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 412          public Date getDateCreatedMinThreshold() {                                                                </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 413              return dateCreatedMinThreshold;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414          }                                                                                                         </span>
<span  style=""> 415                                                                                                                    </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 416          public Boolean getIsPreview() {                                                                           </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 417              return isPreview;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418          }                                                                                                         </span>
<span  style=""> 419                                                                                                                    </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 420          public Long getBatchSize() {                                                                              </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 421              return batchSize;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422          }                                                                                                         </span>
<span  style=""> 423                                                                                                                    </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 424          public Long getFailedRetryTime() {                                                                        </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 425              return failedRetryTime;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426          }                                                                                                         </span>
<span  style=""> 427                                                                                                                    </span>
<span class="-2086671766953086341" onmouseenter="enter('-2086671766953086341');" onmouseout="out('-2086671766953086341');" style=""> 428          public CartPurgeParams invoke() {                                                                         </span>
<span class="2406323390572474949" onmouseenter="enter('2406323390572474949');" onmouseout="out('2406323390572474949');" style=""> 429              nameArray = null;                                                                                     </span>
<span class="-8056479474459794956" onmouseenter="enter('-8056479474459794956');" onmouseout="out('-8056479474459794956');" style=""> 430              statusArray = null;                                                                                   </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 431              dateCreatedMinThreshold = null;                                                                       </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 432              isPreview = null;                                                                                     </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 433              batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                                      </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 434              failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                           </span>
<span  style=""> 435                                                                                                                    </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 436              for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                           </span>
<span class="7230126592195401480" onmouseenter="enter('7230126592195401480');" onmouseout="out('7230126592195401480');" style=""> 437                  if (PurgeCartVariableNames.STATUS.toString().equals(entry.getKey())) {                            </span>
<span class="-3887059016856253482" onmouseenter="enter('-3887059016856253482');" onmouseout="out('-3887059016856253482');" style=""> 438                      String[] temp = entry.getValue().split(&quot;,&quot;);                                                  </span>
<span class="-984189042629809269" onmouseenter="enter('-984189042629809269');" onmouseout="out('-984189042629809269');" style=""> 439                      statusArray = new OrderStatus[temp.length];                                                   </span>
<span class="7424479410662112456" onmouseenter="enter('7424479410662112456');" onmouseout="out('7424479410662112456');" style=""> 440                      int index = 0;                                                                                </span>
<span class="-6857112710843456451" onmouseenter="enter('-6857112710843456451');" onmouseout="out('-6857112710843456451');" style=""> 441                      for (String name : temp) {                                                                    </span>
<span class="4249642856708256048" onmouseenter="enter('4249642856708256048');" onmouseout="out('4249642856708256048');" style=""> 442                          OrderStatus orderStatus = OrderStatus.getInstance(name);                                  </span>
<span class="354647143791226174" onmouseenter="enter('354647143791226174');" onmouseout="out('354647143791226174');" style=""> 443                          statusArray[index] = orderStatus;                                                         </span>
<span class="8743575581853771534" onmouseenter="enter('8743575581853771534');" onmouseout="out('8743575581853771534');" style=""> 444                          index++;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 445                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 446                  }                                                                                                 </span>
<span class="-680570050183499360" onmouseenter="enter('-680570050183499360');" onmouseout="out('-680570050183499360');" style=""> 447                  if (PurgeCartVariableNames.NAME.toString().equals(entry.getKey())) {                              </span>
<span class="3793410955933370059" onmouseenter="enter('3793410955933370059');" onmouseout="out('3793410955933370059');" style=""> 448                      nameArray = entry.getValue().split(&quot;,&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 449                  }                                                                                                 </span>
<span class="5654291195038602061" onmouseenter="enter('5654291195038602061');" onmouseout="out('5654291195038602061');" style=""> 450                  if (PurgeCartVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {                       </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 451                      Long secondsOld = Long.parseLong(entry.getValue());                                           </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 452                      dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453                  }                                                                                                 </span>
<span class="-3116043338550155301" onmouseenter="enter('-3116043338550155301');" onmouseout="out('-3116043338550155301');" style=""> 454                  if (PurgeCartVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {                        </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 455                      isPreview = Boolean.parseBoolean(entry.getValue());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                  }                                                                                                 </span>
<span class="-7209605236483980682" onmouseenter="enter('-7209605236483980682');" onmouseout="out('-7209605236483980682');" style=""> 457                  if (PurgeCartVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {                        </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 458                      batchSize = Long.parseLong(entry.getValue());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459                  }                                                                                                 </span>
<span class="6665497140882829750" onmouseenter="enter('6665497140882829750');" onmouseout="out('6665497140882829750');" style=""> 460                  if (PurgeCartVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {              </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""> 461                      failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463              }                                                                                                     </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 464              return this;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466      }                                                                                                             </span>
<span  style=""> 467                                                                                                                    </span>
<span class="6135355437794836082" onmouseenter="enter('6135355437794836082');" onmouseout="out('6135355437794836082');" style=""> 468      private class CustomerPurgeParams {                                                                           </span>
<span  style=""> 469                                                                                                                    </span>
<span class="-6856693435499536152" onmouseenter="enter('-6856693435499536152');" onmouseout="out('-6856693435499536152');" style=""> 470          private Map&lt;String, String&gt; config;                                                                       </span>
<span class="7302844206310806324" onmouseenter="enter('7302844206310806324');" onmouseout="out('7302844206310806324');" style=""> 471          private Date dateCreatedMinThreshold;                                                                     </span>
<span class="3463156531254861289" onmouseenter="enter('3463156531254861289');" onmouseout="out('3463156531254861289');" style=""> 472          private Boolean isPreview;                                                                                </span>
<span class="5345429142323969812" onmouseenter="enter('5345429142323969812');" onmouseout="out('5345429142323969812');" style=""> 473          private Boolean isRegistered;                                                                             </span>
<span class="3484617240152312252" onmouseenter="enter('3484617240152312252');" onmouseout="out('3484617240152312252');" style=""> 474          private Boolean isDeactivated;                                                                            </span>
<span class="3363239684744280345" onmouseenter="enter('3363239684744280345');" onmouseout="out('3363239684744280345');" style=""> 475          private Long batchSize;                                                                                   </span>
<span class="-1720740520590742633" onmouseenter="enter('-1720740520590742633');" onmouseout="out('-1720740520590742633');" style=""> 476          private Long failedRetryTime;                                                                             </span>
<span  style=""> 477                                                                                                                    </span>
<span class="-3439970468083719495" onmouseenter="enter('-3439970468083719495');" onmouseout="out('-3439970468083719495');" style=""> 478          public CustomerPurgeParams(Map&lt;String, String&gt; config) {                                                  </span>
<span class="1526321258924490874" onmouseenter="enter('1526321258924490874');" onmouseout="out('1526321258924490874');" style=""> 479              this.config = config;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 480          }                                                                                                         </span>
<span  style=""> 481                                                                                                                    </span>
<span class="-3992114832817711236" onmouseenter="enter('-3992114832817711236');" onmouseout="out('-3992114832817711236');" style=""> 482          public Date getDateCreatedMinThreshold() {                                                                </span>
<span class="-8327171784188005577" onmouseenter="enter('-8327171784188005577');" onmouseout="out('-8327171784188005577');" style=""> 483              return dateCreatedMinThreshold;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484          }                                                                                                         </span>
<span  style=""> 485                                                                                                                    </span>
<span class="-7033661251562410887" onmouseenter="enter('-7033661251562410887');" onmouseout="out('-7033661251562410887');" style=""> 486          public Boolean getIsPreview() {                                                                           </span>
<span class="3635536564656849411" onmouseenter="enter('3635536564656849411');" onmouseout="out('3635536564656849411');" style=""> 487              return isPreview;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488          }                                                                                                         </span>
<span  style=""> 489                                                                                                                    </span>
<span class="-4523160162166092089" onmouseenter="enter('-4523160162166092089');" onmouseout="out('-4523160162166092089');" style=""> 490          public Boolean getIsRegistered() {                                                                        </span>
<span class="6500879271821699409" onmouseenter="enter('6500879271821699409');" onmouseout="out('6500879271821699409');" style=""> 491              return isRegistered;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492          }                                                                                                         </span>
<span  style=""> 493                                                                                                                    </span>
<span class="831937501284736178" onmouseenter="enter('831937501284736178');" onmouseout="out('831937501284736178');" style=""> 494          public Boolean getIsDeactivated() {                                                                       </span>
<span class="-8572023523120285779" onmouseenter="enter('-8572023523120285779');" onmouseout="out('-8572023523120285779');" style=""> 495              return isDeactivated;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496          }                                                                                                         </span>
<span  style=""> 497                                                                                                                    </span>
<span class="3149650331594218019" onmouseenter="enter('3149650331594218019');" onmouseout="out('3149650331594218019');" style=""> 498          public Long getBatchSize() {                                                                              </span>
<span class="-1063261584196712790" onmouseenter="enter('-1063261584196712790');" onmouseout="out('-1063261584196712790');" style=""> 499              return batchSize;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500          }                                                                                                         </span>
<span  style=""> 501                                                                                                                    </span>
<span class="-7474777395027393628" onmouseenter="enter('-7474777395027393628');" onmouseout="out('-7474777395027393628');" style=""> 502          public Long getFailedRetryTime() {                                                                        </span>
<span class="-4165480757243396731" onmouseenter="enter('-4165480757243396731');" onmouseout="out('-4165480757243396731');" style=""> 503              return failedRetryTime;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504          }                                                                                                         </span>
<span  style=""> 505                                                                                                                    </span>
<span class="4345643298854756592" onmouseenter="enter('4345643298854756592');" onmouseout="out('4345643298854756592');" style=""> 506          public CustomerPurgeParams invoke() {                                                                     </span>
<span class="-2554699908388798358" onmouseenter="enter('-2554699908388798358');" onmouseout="out('-2554699908388798358');" style=""> 507              isRegistered = null;                                                                                  </span>
<span class="-4109360067770509892" onmouseenter="enter('-4109360067770509892');" onmouseout="out('-4109360067770509892');" style=""> 508              isDeactivated = null;                                                                                 </span>
<span class="-1181424468267428837" onmouseenter="enter('-1181424468267428837');" onmouseout="out('-1181424468267428837');" style=""> 509              dateCreatedMinThreshold = null;                                                                       </span>
<span class="2330543613004866024" onmouseenter="enter('2330543613004866024');" onmouseout="out('2330543613004866024');" style=""> 510              isPreview = null;                                                                                     </span>
<span class="1034098402978173738" onmouseenter="enter('1034098402978173738');" onmouseout="out('1034098402978173738');" style=""> 511              batchSize = ResourcePurgeServiceImpl.BATCH_SIZE;                                                      </span>
<span class="-7127736159085766714" onmouseenter="enter('-7127736159085766714');" onmouseout="out('-7127736159085766714');" style=""> 512              failedRetryTime = ResourcePurgeServiceImpl.PURGE_ERROR_CACHE_RETRY_SECONDS;                           </span>
<span  style=""> 513                                                                                                                    </span>
<span class="8666921673902727653" onmouseenter="enter('8666921673902727653');" onmouseout="out('8666921673902727653');" style=""> 514              for (Map.Entry&lt;String, String&gt; entry : config.entrySet()) {                                           </span>
<span class="8500820035603099955" onmouseenter="enter('8500820035603099955');" onmouseout="out('8500820035603099955');" style=""> 515                  if (PurgeCustomerVariableNames.SECONDS_OLD.toString().equals(entry.getKey())) {                   </span>
<span class="-4879128681210263705" onmouseenter="enter('-4879128681210263705');" onmouseout="out('-4879128681210263705');" style=""> 516                      Long secondsOld = Long.parseLong(entry.getValue());                                           </span>
<span class="-8853874189142713731" onmouseenter="enter('-8853874189142713731');" onmouseout="out('-8853874189142713731');" style=""> 517                      dateCreatedMinThreshold = new Date(SystemTime.asMillis() - (secondsOld * 1000));              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518                  }                                                                                                 </span>
<span class="472649037401986768" onmouseenter="enter('472649037401986768');" onmouseout="out('472649037401986768');" style=""> 519                  if (PurgeCustomerVariableNames.IS_REGISTERED.toString().equals(entry.getKey())) {                 </span>
<span class="3066848756297460347" onmouseenter="enter('3066848756297460347');" onmouseout="out('3066848756297460347');" style=""> 520                      isRegistered = Boolean.parseBoolean(entry.getValue());                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521                  }                                                                                                 </span>
<span class="-6798790184150039593" onmouseenter="enter('-6798790184150039593');" onmouseout="out('-6798790184150039593');" style=""> 522                  if (PurgeCustomerVariableNames.IS_DEACTIVATED.toString().equals(entry.getKey())) {                </span>
<span class="8770174800886691615" onmouseenter="enter('8770174800886691615');" onmouseout="out('8770174800886691615');" style=""> 523                      isDeactivated = Boolean.parseBoolean(entry.getValue());                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524                  }                                                                                                 </span>
<span class="-4202787563999133129" onmouseenter="enter('-4202787563999133129');" onmouseout="out('-4202787563999133129');" style=""> 525                  if (PurgeCustomerVariableNames.IS_PREVIEW.toString().equals(entry.getKey())) {                    </span>
<span class="3481328240562234443" onmouseenter="enter('3481328240562234443');" onmouseout="out('3481328240562234443');" style=""> 526                      isPreview = Boolean.parseBoolean(entry.getValue());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527                  }                                                                                                 </span>
<span class="2949192035259803609" onmouseenter="enter('2949192035259803609');" onmouseout="out('2949192035259803609');" style=""> 528                  if (PurgeCustomerVariableNames.BATCH_SIZE.toString().equals(entry.getKey())) {                    </span>
<span class="1087422815288012405" onmouseenter="enter('1087422815288012405');" onmouseout="out('1087422815288012405');" style=""> 529                      batchSize = Long.parseLong(entry.getValue());                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530                  }                                                                                                 </span>
<span class="3875509270375211860" onmouseenter="enter('3875509270375211860');" onmouseout="out('3875509270375211860');" style=""> 531                  if (PurgeCustomerVariableNames.RETRY_FAILED_SECONDS.toString().equals(entry.getKey())) {          </span>
<span class="4372616204493456495" onmouseenter="enter('4372616204493456495');" onmouseout="out('4372616204493456495');" style=""> 532                      failedRetryTime = System.currentTimeMillis() - (Long.parseLong(entry.getValue()) * 1000);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 534              }                                                                                                     </span>
<span class="2297715846939503398" onmouseenter="enter('2297715846939503398');" onmouseout="out('2297715846939503398');" style=""> 535              return this;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 536          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537      }                                                                                                             </span>
<span  style=""> 538                                                                                                                    </span>
<span class="-4423643614963439423" onmouseenter="enter('-4423643614963439423');" onmouseout="out('-4423643614963439423');" style=""> 539      private class PurgeErrorCache {                                                                               </span>
<span  style=""> 540                                                                                                                    </span>
<span class="198672241784651248" onmouseenter="enter('198672241784651248');" onmouseout="out('198672241784651248');" style=""> 541          private Map&lt;Long, Long&gt; cache = new HashMap&lt;Long, Long&gt;();                                                </span>
<span  style=""> 542                                                                                                                    </span>
<span class="-5066122402174219646" onmouseenter="enter('-5066122402174219646');" onmouseout="out('-5066122402174219646');" style=""> 543          public Long add(Long entry) {                                                                             </span>
<span class="7659524906429939754" onmouseenter="enter('7659524906429939754');" onmouseout="out('7659524906429939754');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 544 -            if (! cache.containsKey(entry)) {                                                                     </span>
<span class="1483875087127814333" onmouseenter="enter('1483875087127814333');" onmouseout="out('1483875087127814333');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +            if (!cache.containsKey(entry)) {                                                                      </span>
<span class="-1518558382272290563" onmouseenter="enter('-1518558382272290563');" onmouseout="out('-1518558382272290563');" style=""> 546                  return cache.put(entry, new Long(System.currentTimeMillis()));                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547              }                                                                                                     </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 548              return null;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 549          }                                                                                                         </span>
<span  style=""> 550                                                                                                                    </span>
<span class="-5864460220203783413" onmouseenter="enter('-5864460220203783413');" onmouseout="out('-5864460220203783413');" style=""> 551          public Set&lt;Long&gt; getEntriesSince(long expiredTime) {                                                      </span>
<span class="3678487184380758864" onmouseenter="enter('3678487184380758864');" onmouseout="out('3678487184380758864');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 552 -            for(Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext(); ) {           </span>
<span class="-5150169203707964219" onmouseenter="enter('-5150169203707964219');" onmouseout="out('-5150169203707964219');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +            for (Iterator&lt;Map.Entry&lt;Long, Long&gt;&gt; item = cache.entrySet().iterator(); item.hasNext(); ) {          </span>
<span class="-7841947474939136830" onmouseenter="enter('-7841947474939136830');" onmouseout="out('-7841947474939136830');" style=""> 554                  Map.Entry&lt;Long, Long&gt; entry = item.next();                                                        </span>
<span class="936602580368160114" onmouseenter="enter('936602580368160114');" onmouseout="out('936602580368160114');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 555 -                if(entry.getValue().longValue() &lt; expiredTime) {                                                  </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 556 -                  item.remove();                                                                                  </span>
<span class="3419674656987096917" onmouseenter="enter('3419674656987096917');" onmouseout="out('3419674656987096917');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +                if (entry.getValue().longValue() &lt; expiredTime) {                                                 </span>
<span class="-26897648866463209" onmouseenter="enter('-26897648866463209');" onmouseout="out('-26897648866463209');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 558 +                    item.remove();                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 559                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560              }                                                                                                     </span>
<span class="4846818570039273159" onmouseenter="enter('4846818570039273159');" onmouseout="out('4846818570039273159');" style=""> 561              return cache.keySet();                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 562          }                                                                                                         </span>
<span  style=""> 563                                                                                                                    </span>
<span class="5501185527198334216" onmouseenter="enter('5501185527198334216');" onmouseout="out('5501185527198334216');" style=""> 564          public int size() {                                                                                       </span>
<span class="4045092944756323954" onmouseenter="enter('4045092944756323954');" onmouseout="out('4045092944756323954');" style=""> 565              return cache.size();                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566          }                                                                                                         </span>
<span  style=""> 567                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 568      }                                                                                                             </span>
<span  style=""> 569                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            