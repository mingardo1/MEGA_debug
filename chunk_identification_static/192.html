<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>192</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    192
                    <a href="191.html">prev</a>
                    <a href="193.html">next</a>
                    <a href="192_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/FulfillmentGroupOfferProcessorTest.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/FulfillmentGroupOfferProcessorTest.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/FulfillmentGroupOfferProcessorTest.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/FulfillmentGroupOfferProcessorTest.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/test/java/org/broadleafcommerce/core/offer/service/processor/FulfillmentGroupOfferProcessorTest.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [sbj], [bj]], subset: [[b], [b], [sbj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import junit.framework.TestCase;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 </span>
  23 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;</span>
  26 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.broadleafcommerce.common.service.GenericEntityService;</span>
  28 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  31 import org.broadleafcommerce.core.offer.dao.OfferDao;
  32 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOffer;
  33 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOfferImpl;
  34 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  35 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  36 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  37 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustmentImpl;
  38 import org.broadleafcommerce.core.offer.domain.Offer;
  39 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  40 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  41 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  42 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  43 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  44 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  45 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  46 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  47 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  50 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  51 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  52 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  53 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  54 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  55 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  56 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  57 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  58 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  59 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  60 import org.broadleafcommerce.core.order.domain.Order;
  61 import org.broadleafcommerce.core.order.domain.OrderItem;
  62 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  63 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  64 import org.broadleafcommerce.core.order.domain.OrderMultishipOptionImpl;
  65 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  66 import org.broadleafcommerce.core.order.service.OrderItemService;
  67 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  68 import org.broadleafcommerce.core.order.service.OrderService;
  69 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  70 import org.broadleafcommerce.profile.core.domain.Address;
  71 import org.easymock.EasyMock;
  72 import org.easymock.IAnswer;
  73 import java.math.BigDecimal;
  74 import java.util.ArrayList;
  75 import java.util.HashMap;
  76 import java.util.List;
  77 import java.util.TimeZone;
  78 
  79 /**
  80  * 
  81  * @author jfischer
  82  *
  83  */
  84 public class FulfillmentGroupOfferProcessorTest extends TestCase {
  85 
  86     protected OfferDao offerDaoMock;
  87     protected OrderItemDao orderItemDaoMock;
  88     protected OfferServiceImpl offerService;
  89     protected final OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  90     protected OrderService orderServiceMock;
  91     protected OrderItemService orderItemServiceMock;
  92     protected FulfillmentGroupItemDao fgItemDaoMock;
  93     protected FulfillmentGroupService fgServiceMock;
  94     protected OrderMultishipOptionService multishipOptionServiceMock;
  95     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  96     protected OfferServiceUtilities offerServiceUtilitiesMock;
  97 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98     protected PromotableOfferUtility promotableOfferUtility;</span>
  99 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     protected FulfillmentGroupOfferProcessorImpl fgProcessor;</span>
 101 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102     protected GenericEntityService genericEntityServiceMock;</span>
 103 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 104 
 105     protected FulfillmentGroupOfferProcessorImpl fgProcessor;
 106 
 107     /**
<abbr title=" 108      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application context and"> 108      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application coðŸ”µ</abbr>
 109      * system properties service since it uses BLCSystemProperty
 110      * 
 111      * @author Phillip Verheyden (phillipuniverse)
 112      */
<abbr title=" 113     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorImpl {"> 113     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorIðŸ”µ</abbr>
 114         public TestableFulfillmentGroupOfferProcessor(PromotableOfferUtility promotableOfferUtility) {
 115             super(promotableOfferUtility);
 116         }
 117 
 118         @Override
 119         protected boolean getQualifyGroupAcrossAllOrderItems(PromotableFulfillmentGroup fg) {
 120             return false;
 121         }
 122     }
 123 
 124     @Override
 125     protected void setUp() throws Exception {
 126         offerService = new OfferServiceImpl();
 127         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 128         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 129         orderServiceMock = EasyMock.createMock(OrderService.class);
 130         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 131 
 132         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 133         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 134         offerDaoMock = EasyMock.createMock(OfferDao.class);
 135         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 136         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 137         offerServiceUtilitiesMock = EasyMock.createMock(OfferServiceUtilities.class);
 138         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 139 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 141 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         fgProcessor.setOfferDao(offerDaoMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         fgProcessor.setOrderItemDao(orderItemDaoMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
 147 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 149 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 150 
 151         fgProcessor = new TestableFulfillmentGroupOfferProcessor(promotableOfferUtility);
 152         fgProcessor.setOfferDao(offerDaoMock);
 153         fgProcessor.setOrderItemDao(orderItemDaoMock);
 154         fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 155         fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 156 
<abbr title=" 157         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 157         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 158         offerServiceUtilities.setOfferDao(offerDaoMock);
 159 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 160         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 160         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr></span>
 161 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         orderProcessor.setOfferDao(offerDaoMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         orderProcessor.setOrderItemDao(orderItemDaoMock);</span>
 167 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 170 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 171 
 172         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 173         orderProcessor.setOfferDao(offerDaoMock);
 174         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 175         orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 176         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 177         orderProcessor.setOrderItemDao(orderItemDaoMock);
 178         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 179 
 180         ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 181         itemProcessor.setOfferDao(offerDaoMock);
 182         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 183         itemProcessor.setOrderItemDao(orderItemDaoMock);
 184         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 185 
 186         offerService.setCustomerOfferDao(customerOfferDaoMock);
 187         offerService.setOfferCodeDao(offerCodeDaoMock);
 188         offerService.setOfferDao(offerDaoMock);
 189         offerService.setOrderOfferProcessor(orderProcessor);
 190         offerService.setItemOfferProcessor(itemProcessor);
 191         offerService.setFulfillmentGroupOfferProcessor(fgProcessor);
 192         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 193         offerService.setOrderService(orderServiceMock);
 194     }
 195     
 196     public void replay() {
 197         EasyMock.replay(offerDaoMock);
 198         EasyMock.replay(orderItemDaoMock);
 199         EasyMock.replay(orderServiceMock);
 200         EasyMock.replay(orderItemServiceMock);
 201         EasyMock.replay(fgItemDaoMock);
 202         EasyMock.replay(fgServiceMock);
 203         EasyMock.replay(multishipOptionServiceMock);
 204         EasyMock.replay(offerTimeZoneProcessorMock);
 205         EasyMock.replay(offerServiceUtilitiesMock);
 206     }
 207 
 208     public void verify() {
 209         EasyMock.verify(offerDaoMock);
 210         EasyMock.verify(orderItemDaoMock);
 211         EasyMock.verify(orderServiceMock);
 212         EasyMock.verify(orderItemServiceMock);
 213         EasyMock.verify(fgItemDaoMock);
 214         EasyMock.verify(fgServiceMock);
 215         EasyMock.verify(multishipOptionServiceMock);
 216         EasyMock.verify(offerTimeZoneProcessorMock);
 217         EasyMock.verify(offerServiceUtilitiesMock);
 218     }
 219 
 220     public void testApplyAllFulfillmentGroupOffersWithOrderItemOffers() throws Exception {
 221         final ThreadLocal&lt;Order&gt; myOrder = new ThreadLocal&lt;Order&gt;();
<abbr title=" 222         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 222         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
 223 
<abbr title=" 224         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).atLeastOnce();"> 224         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
 225 
<abbr title=" 226         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 226         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 227         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 227         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EðŸ”µ</abbr>
<abbr title=" 228         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 228         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).anðŸ”µ</abbr>
 229         
<abbr title=" 230         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 230         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 231         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 231         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 232         
 233         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
<abbr title=" 234         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 234         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 235         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 235         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
 236 
<abbr title=" 237         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 237         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
<abbr title=" 238         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupAdjustmentAnswer()).anyTimes();"> 238         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.ðŸ”µ</abbr>
 239 
<abbr title=" 240         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;Order&gt;() {"> 240         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;OðŸ”µ</abbr>
 241 
 242             @Override
 243             public Order answer() throws Throwable {
 244                 return myOrder.get();
 245             }
 246         }).anyTimes();
 247 
<abbr title=" 248         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 248         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).aðŸ”µ</abbr>
 249 
 250             @Override
 251             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 252                 List&lt;OrderMultishipOption&gt; options = new ArrayList&lt;OrderMultishipOption&gt;();
 253                 PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 254                 for (FulfillmentGroup fg : order.getOrder().getFulfillmentGroups()) {
 255                     Address address = fg.getAddress();
 256                     for (FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
 257                         for (int j = 0; j &lt; fgItem.getQuantity(); j++) {
 258                             OrderMultishipOption option = new OrderMultishipOptionImpl();
 259                             option.setOrder(order.getOrder());
 260                             option.setAddress(address);
 261                             option.setOrderItem(fgItem.getOrderItem());
 262                             options.add(option);
 263                         }
 264                     }
 265                 }
 266 
 267                 return options;
 268             }
 269         }).anyTimes();
 270 
 271         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 272         EasyMock.expectLastCall().anyTimes();
<abbr title=" 273         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(new IAnswer&lt;Order&gt;() {"> 273         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
 274 
 275             @Override
 276             public Order answer() throws Throwable {
 277                 Order order = (Order) EasyMock.getCurrentArguments()[0];
<abbr title=" 278                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups().get(1).getFulfillmentGroupItems());"> 278                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmenðŸ”µ</abbr>
 279                 order.getFulfillmentGroups().remove(order.getFulfillmentGroups().get(1));
 280 
 281                 return order;
 282             }
 283         }).anyTimes();
<abbr title=" 284         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 284         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 285         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 286         EasyMock.expectLastCall().anyTimes();
<abbr title=" 287         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 287         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 288 
 289         replay();
 290 
<abbr title=" 291         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 291         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 292         Order order = promotableOrder.getOrder();
 293         myOrder.set(promotableOrder.getOrder());
<abbr title=" 294         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 294         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 295         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 295         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 296         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 296         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 297         offers.get(1).setName(&quot;secondOffer&quot;);
 298 
 299         offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(
 300                 &quot;order.subTotal.getAmount()&gt;20&quot;,
 301                 OfferDiscountType.PERCENT_OFF,
<abbr title=" 302                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 302                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contaiðŸ”µ</abbr>
<abbr title=" 303                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 303                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contaiðŸ”µ</abbr>
 304                 ));
 305         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 306 
 307         offers.get(0).setTotalitarianOffer(true);
 308         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 309 
 310         int fgAdjustmentCount = 0;
 311         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 312             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 313         }
<abbr title=" 314         //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order item offers"> 314         //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than thðŸ”µ</abbr>
 315         // - it is therefore ignored
 316         //However, the second combinable fg offer is allowed to be applied.
 317         assertTrue(fgAdjustmentCount == 1);
 318 
 319         promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 320         myOrder.set(promotableOrder.getOrder());
 321         offers.get(2).setValue(new BigDecimal(&quot;1&quot;));
 322 
 323         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 324         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 325 
 326         fgAdjustmentCount = 0;
 327         order = promotableOrder.getOrder();
 328         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 329             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 330         }
 331 
<abbr title=" 332         //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fg offer is applied"> 332         //The totalitarian fg offer is now a better deal than the order item offers, therefore the totaliðŸ”µ</abbr>
 333         //and the order item offers are removed
 334         assertTrue(fgAdjustmentCount == 2);
 335 
 336         int itemAdjustmentCount = 0;
 337         for (OrderItem item : order.getOrderItems()) {
 338             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 339                 itemAdjustmentCount += detail.getOrderItemPriceDetailAdjustments().size();
 340             }
 341         }
 342 
 343         //Confirm that the order item offers are removed
 344         assertTrue(itemAdjustmentCount == 0);
 345         verify();
 346     }
 347 
 348     public void testApplyAllFulfillmentGroupOffers() {
<abbr title=" 349         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 349         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 350         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 350         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 351         replay();
 352 
 353         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 354 
<abbr title=" 355         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 355         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 356         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 356         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 357         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 358 
 359         boolean offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 360 
 361         assertTrue(offerApplied);
 362 
 363         order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 364 
 365         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 366         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 366         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 367         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 367         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 368         offers.get(1).setName(&quot;secondOffer&quot;);
 369         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 370         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(1));
 371 
 372         offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 373 
<abbr title=" 374         //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfillment groups"> 374         //the first offer applies to both fulfillment groups, but the second offer only applies to one ofðŸ”µ</abbr>
 375         assertTrue(offerApplied);
 376         int fgAdjustmentCount = 0;
 377         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 378             fgAdjustmentCount += fg.getCandidateFulfillmentGroupAdjustments().size();
 379         }
 380         assertTrue(fgAdjustmentCount == 3);
 381 
 382         verify();
 383     }
 384 
 385     public void testFilterFulfillmentGroupLevelOffer() {
 386         replay();
 387 
 388         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 389 
<abbr title=" 390         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 390         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 391         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 391         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 392         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 393 
 394         //test that the valid fg offer is included
 395         //No item criteria, so each fulfillment group applies
<abbr title=" 396         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 396         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 397 
 398         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 399         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 399         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 400         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 401 
 402         //test that the valid fg offer is included
 403         //only 1 fulfillment group has qualifying items
<abbr title=" 404         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 404         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 405 
 406         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 407         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 407         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 408         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 409 
 410         //test that the invalid fg offer is excluded - zipcode is wrong
 411         assertTrue(qualifiedOffers.size() == 0);
 412 
 413         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 414         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 414         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 415         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 416 
 417         //test that the invalid fg offer is excluded - no qualifying items
 418         assertTrue(qualifiedOffers.size() == 0);
 419 
 420         verify();
 421     }
 422 
 423     public void testCouldOfferApplyToFulfillmentGroup() {
 424         replay();
 425 
 426         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 427         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 427         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 428         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 428         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfilðŸ”µ</abbr>
 429         //test that the valid fg offer is included
 430         assertTrue(couldApply);
 431 
<abbr title=" 432         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF);"> 432         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 433         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 433         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroðŸ”µ</abbr>
 434         //test that the invalid fg offer is excluded
 435         assertFalse(couldApply);
 436 
 437         verify();
 438     }
 439 
 440     public void testCouldOrderItemMeetOfferRequirement() {
 441         replay();
 442 
 443         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 444         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 444         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 445         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 445         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 446         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 446         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), ðŸ”µ</abbr>
 447         //test that the valid fg offer is included
 448         assertTrue(couldApply);
 449 
<abbr title=" 450         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 450         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 451         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 452         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 452         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.geðŸ”µ</abbr>
 453         //test that the invalid fg offer is excluded
 454         assertFalse(couldApply);
 455 
 456         verify();
 457     }
 458 
 459     public void testCouldOfferApplyToOrderItems() {
 460         replay();
 461 
 462         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 463 
 464         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 465         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 466             orderItems.add(orderItem);
 467         }
 468 
<abbr title=" 469         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 469         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 470         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 470         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderðŸ”µ</abbr>
 471         //test that the valid fg offer is included
<abbr title=" 472         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 472         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1)ðŸ”µ</abbr>
 473 
<abbr title=" 474         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 474         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 475         candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 476         //test that the invalid fg offer is excluded because there are no qualifying items
<abbr title=" 477         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 477         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1ðŸ”µ</abbr>
 478 
 479         verify();
 480     }
 481 
<abbr title=" 482     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; {"> 482     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; ðŸ”µ</abbr>
 483 
 484         @Override
 485         public CandidateFulfillmentGroupOffer answer() throws Throwable {
 486             return new CandidateFulfillmentGroupOfferImpl();
 487         }
 488 
 489     }
 490 
 491     public class FulfillmentGroupAdjustmentAnswer implements IAnswer&lt;FulfillmentGroupAdjustment&gt; {
 492 
 493         @Override
 494         public FulfillmentGroupAdjustment answer() throws Throwable {
 495             return new FulfillmentGroupAdjustmentImpl();
 496         }
 497 
 498     }
 499 
 500     public class CandidateItemOfferAnswer implements IAnswer&lt;CandidateItemOffer&gt; {
 501 
 502         @Override
 503         public CandidateItemOffer answer() throws Throwable {
 504             return new CandidateItemOfferImpl();
 505         }
 506 
 507     }
 508 
 509     public class OrderItemAdjustmentAnswer implements IAnswer&lt;OrderItemAdjustment&gt; {
 510 
 511         @Override
 512         public OrderItemAdjustment answer() throws Throwable {
 513             return new OrderItemAdjustmentImpl();
 514         }
 515 
 516     }
 517 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import org.broadleafcommerce.common.service.GenericEntityService;
  21 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  22 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  23 import org.broadleafcommerce.core.offer.dao.OfferDao;
  24 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOffer;
  25 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOfferImpl;
  26 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  27 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  28 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  29 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustmentImpl;
  30 import org.broadleafcommerce.core.offer.domain.Offer;
  31 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  32 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  33 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  34 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  35 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  36 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  37 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  38 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  39 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  47 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  48 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  49 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  50 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  51 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  52 import org.broadleafcommerce.core.order.domain.Order;
  53 import org.broadleafcommerce.core.order.domain.OrderItem;
  54 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  55 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  56 import org.broadleafcommerce.core.order.domain.OrderMultishipOptionImpl;
  57 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  58 import org.broadleafcommerce.core.order.service.OrderItemService;
  59 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  60 import org.broadleafcommerce.core.order.service.OrderService;
  61 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  62 import org.broadleafcommerce.profile.core.domain.Address;
  63 import org.easymock.EasyMock;
  64 import org.easymock.IAnswer;
  65 import java.math.BigDecimal;
  66 import java.util.ArrayList;
  67 import java.util.HashMap;
  68 import java.util.List;
  69 import java.util.TimeZone;
  70 
  71 import junit.framework.TestCase;
  72 
  73 /**
  74  *
  75  * @author jfischer
  76  *
  77  */
  78 public class FulfillmentGroupOfferProcessorTest extends TestCase {
  79 
  80     protected OfferDao offerDaoMock;
  81     protected OrderItemDao orderItemDaoMock;
  82     protected OfferServiceImpl offerService;
  83     protected final OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  84     protected OrderService orderServiceMock;
  85     protected OrderItemService orderItemServiceMock;
  86     protected FulfillmentGroupItemDao fgItemDaoMock;
  87     protected FulfillmentGroupService fgServiceMock;
  88     protected OrderMultishipOptionService multishipOptionServiceMock;
  89     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  90     protected OfferServiceUtilities offerServiceUtilitiesMock;
  91     protected PromotableOfferUtility promotableOfferUtility;
  92     protected GenericEntityService genericEntityServiceMock;
  93 
  94     protected FulfillmentGroupOfferProcessorImpl fgProcessor;
  95 
  96     /**
<abbr title="  97      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application context and">  97      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application coðŸ”µ</abbr>
  98      * system properties service since it uses BLCSystemProperty
  99      *
 100      * @author Phillip Verheyden (phillipuniverse)
 101      */
<abbr title=" 102     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorImpl {"> 102     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorIðŸ”µ</abbr>
 103         public TestableFulfillmentGroupOfferProcessor(PromotableOfferUtility promotableOfferUtility) {
 104             super(promotableOfferUtility);
 105         }
 106 
 107         @Override
 108         protected boolean getQualifyGroupAcrossAllOrderItems(PromotableFulfillmentGroup fg) {
 109             return false;
 110         }
 111     }
 112 
 113     @Override
 114     protected void setUp() throws Exception {
 115         offerService = new OfferServiceImpl();
 116         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 117         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 118         orderServiceMock = EasyMock.createMock(OrderService.class);
 119         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 120 
 121         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 122         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 123         offerDaoMock = EasyMock.createMock(OfferDao.class);
 124         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 125         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 126         offerServiceUtilitiesMock = EasyMock.createMock(OfferServiceUtilities.class);
 127         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 128 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 130 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
 132 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 134 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 135 
 136         fgProcessor = new TestableFulfillmentGroupOfferProcessor(promotableOfferUtility);
 137         fgProcessor.setOfferDao(offerDaoMock);
 138         fgProcessor.setOrderItemDao(orderItemDaoMock);
 139         fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 140         fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 141 
<abbr title=" 142         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 142         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 143         offerServiceUtilities.setOfferDao(offerDaoMock);
 144 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 145         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 145         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr></span>
 146 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl();</span>
 149 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 152 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 153 
 154         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 155         orderProcessor.setOfferDao(offerDaoMock);
 156         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 157         orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 158         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 159         orderProcessor.setOrderItemDao(orderItemDaoMock);
 160         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 161 
 162         ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 163         itemProcessor.setOfferDao(offerDaoMock);
 164         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 165         itemProcessor.setOrderItemDao(orderItemDaoMock);
 166         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 167 
 168         offerService.setCustomerOfferDao(customerOfferDaoMock);
 169         offerService.setOfferCodeDao(offerCodeDaoMock);
 170         offerService.setOfferDao(offerDaoMock);
 171         offerService.setOrderOfferProcessor(orderProcessor);
 172         offerService.setItemOfferProcessor(itemProcessor);
 173         offerService.setFulfillmentGroupOfferProcessor(fgProcessor);
 174         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 175         offerService.setOrderService(orderServiceMock);
 176     }
 177 
 178     public void replay() {
 179         EasyMock.replay(offerDaoMock);
 180         EasyMock.replay(orderItemDaoMock);
 181         EasyMock.replay(orderServiceMock);
 182         EasyMock.replay(orderItemServiceMock);
 183         EasyMock.replay(fgItemDaoMock);
 184         EasyMock.replay(fgServiceMock);
 185         EasyMock.replay(multishipOptionServiceMock);
 186         EasyMock.replay(offerTimeZoneProcessorMock);
 187         EasyMock.replay(offerServiceUtilitiesMock);
 188     }
 189 
 190     public void verify() {
 191         EasyMock.verify(offerDaoMock);
 192         EasyMock.verify(orderItemDaoMock);
 193         EasyMock.verify(orderServiceMock);
 194         EasyMock.verify(orderItemServiceMock);
 195         EasyMock.verify(fgItemDaoMock);
 196         EasyMock.verify(fgServiceMock);
 197         EasyMock.verify(multishipOptionServiceMock);
 198         EasyMock.verify(offerTimeZoneProcessorMock);
 199         EasyMock.verify(offerServiceUtilitiesMock);
 200     }
 201 
 202     public void testApplyAllFulfillmentGroupOffersWithOrderItemOffers() throws Exception {
 203         final ThreadLocal&lt;Order&gt; myOrder = new ThreadLocal&lt;Order&gt;();
<abbr title=" 204         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 204         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
 205 
<abbr title=" 206         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).atLeastOnce();"> 206         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
 207 
<abbr title=" 208         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 208         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 209         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 209         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EðŸ”µ</abbr>
<abbr title=" 210         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 210         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).anðŸ”µ</abbr>
 211 
<abbr title=" 212         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 212         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 213         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 213         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 214 
 215         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
<abbr title=" 216         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 216         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 217         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 217         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
 218 
<abbr title=" 219         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 219         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
<abbr title=" 220         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupAdjustmentAnswer()).anyTimes();"> 220         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.ðŸ”µ</abbr>
 221 
<abbr title=" 222         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;Order&gt;() {"> 222         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;OðŸ”µ</abbr>
 223 
 224             @Override
 225             public Order answer() throws Throwable {
 226                 return myOrder.get();
 227             }
 228         }).anyTimes();
 229 
<abbr title=" 230         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 230         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).aðŸ”µ</abbr>
 231 
 232             @Override
 233             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 234                 List&lt;OrderMultishipOption&gt; options = new ArrayList&lt;OrderMultishipOption&gt;();
 235                 PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 236                 for (FulfillmentGroup fg : order.getOrder().getFulfillmentGroups()) {
 237                     Address address = fg.getAddress();
 238                     for (FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
 239                         for (int j = 0; j &lt; fgItem.getQuantity(); j++) {
 240                             OrderMultishipOption option = new OrderMultishipOptionImpl();
 241                             option.setOrder(order.getOrder());
 242                             option.setAddress(address);
 243                             option.setOrderItem(fgItem.getOrderItem());
 244                             options.add(option);
 245                         }
 246                     }
 247                 }
 248 
 249                 return options;
 250             }
 251         }).anyTimes();
 252 
 253         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 254         EasyMock.expectLastCall().anyTimes();
<abbr title=" 255         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(new IAnswer&lt;Order&gt;() {"> 255         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
 256 
 257             @Override
 258             public Order answer() throws Throwable {
 259                 Order order = (Order) EasyMock.getCurrentArguments()[0];
<abbr title=" 260                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups().get(1).getFulfillmentGroupItems());"> 260                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmenðŸ”µ</abbr>
 261                 order.getFulfillmentGroups().remove(order.getFulfillmentGroups().get(1));
 262 
 263                 return order;
 264             }
 265         }).anyTimes();
<abbr title=" 266         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 266         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 267         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 268         EasyMock.expectLastCall().anyTimes();
<abbr title=" 269         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 269         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 270 
 271         replay();
 272 
<abbr title=" 273         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 273         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 274         Order order = promotableOrder.getOrder();
 275         myOrder.set(promotableOrder.getOrder());
<abbr title=" 276         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 276         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 277         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 277         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 278         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 278         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 279         offers.get(1).setName(&quot;secondOffer&quot;);
 280 
 281         offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(
 282                 &quot;order.subTotal.getAmount()&gt;20&quot;,
 283                 OfferDiscountType.PERCENT_OFF,
<abbr title=" 284                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 284                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contaiðŸ”µ</abbr>
<abbr title=" 285                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 285                 &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contaiðŸ”µ</abbr>
 286                 ));
 287         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 288 
 289         offers.get(0).setTotalitarianOffer(true);
 290         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 291 
 292         int fgAdjustmentCount = 0;
 293         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 294             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 295         }
<abbr title=" 296         //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order item offers"> 296         //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than thðŸ”µ</abbr>
 297         // - it is therefore ignored
 298         //However, the second combinable fg offer is allowed to be applied.
 299         assertTrue(fgAdjustmentCount == 1);
 300 
 301         promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 302         myOrder.set(promotableOrder.getOrder());
 303         offers.get(2).setValue(new BigDecimal(&quot;1&quot;));
 304 
 305         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 306         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 307 
 308         fgAdjustmentCount = 0;
 309         order = promotableOrder.getOrder();
 310         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 311             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 312         }
 313 
<abbr title=" 314         //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fg offer is applied"> 314         //The totalitarian fg offer is now a better deal than the order item offers, therefore the totaliðŸ”µ</abbr>
 315         //and the order item offers are removed
 316         assertTrue(fgAdjustmentCount == 2);
 317 
 318         int itemAdjustmentCount = 0;
 319         for (OrderItem item : order.getOrderItems()) {
 320             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 321                 itemAdjustmentCount += detail.getOrderItemPriceDetailAdjustments().size();
 322             }
 323         }
 324 
 325         //Confirm that the order item offers are removed
 326         assertTrue(itemAdjustmentCount == 0);
 327         verify();
 328     }
 329 
 330     public void testApplyAllFulfillmentGroupOffers() {
<abbr title=" 331         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 331         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 332         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 332         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 333         replay();
 334 
 335         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 336 
<abbr title=" 337         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 337         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 338         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 338         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 339         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 340 
 341         boolean offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 342 
 343         assertTrue(offerApplied);
 344 
 345         order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 346 
 347         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 348         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 348         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 349         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 349         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 350         offers.get(1).setName(&quot;secondOffer&quot;);
 351         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 352         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(1));
 353 
 354         offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 355 
<abbr title=" 356         //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfillment groups"> 356         //the first offer applies to both fulfillment groups, but the second offer only applies to one ofðŸ”µ</abbr>
 357         assertTrue(offerApplied);
 358         int fgAdjustmentCount = 0;
 359         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 360             fgAdjustmentCount += fg.getCandidateFulfillmentGroupAdjustments().size();
 361         }
 362         assertTrue(fgAdjustmentCount == 3);
 363 
 364         verify();
 365     }
 366 
 367     public void testFilterFulfillmentGroupLevelOffer() {
 368         replay();
 369 
 370         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 371 
<abbr title=" 372         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 372         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 373         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 373         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 374         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 375 
 376         //test that the valid fg offer is included
 377         //No item criteria, so each fulfillment group applies
<abbr title=" 378         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 378         assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 379 
 380         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 381         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 381         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 382         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 383 
 384         //test that the valid fg offer is included
 385         //only 1 fulfillment group has qualifying items
<abbr title=" 386         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 386         assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0))ðŸ”µ</abbr>
 387 
 388         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 389         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 389         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 390         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 391 
 392         //test that the invalid fg offer is excluded - zipcode is wrong
 393         assertTrue(qualifiedOffers.size() == 0);
 394 
 395         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 396         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 396         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 397         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 398 
 399         //test that the invalid fg offer is excluded - no qualifying items
 400         assertTrue(qualifiedOffers.size() == 0);
 401 
 402         verify();
 403     }
 404 
 405     public void testCouldOfferApplyToFulfillmentGroup() {
 406         replay();
 407 
 408         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 409         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 409         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 410         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 410         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfilðŸ”µ</abbr>
 411         //test that the valid fg offer is included
 412         assertTrue(couldApply);
 413 
<abbr title=" 414         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF);"> 414         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 415         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 415         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroðŸ”µ</abbr>
 416         //test that the invalid fg offer is excluded
 417         assertFalse(couldApply);
 418 
 419         verify();
 420     }
 421 
 422     public void testCouldOrderItemMeetOfferRequirement() {
 423         replay();
 424 
 425         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 426         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 426         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 427         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 427         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 428         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 428         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), ðŸ”µ</abbr>
 429         //test that the valid fg offer is included
 430         assertTrue(couldApply);
 431 
<abbr title=" 432         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 432         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 433         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 434         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 434         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.geðŸ”µ</abbr>
 435         //test that the invalid fg offer is excluded
 436         assertFalse(couldApply);
 437 
 438         verify();
 439     }
 440 
 441     public void testCouldOfferApplyToOrderItems() {
 442         replay();
 443 
 444         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 445 
 446         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 447         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 448             orderItems.add(orderItem);
 449         }
 450 
<abbr title=" 451         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 451         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 452         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 452         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderðŸ”µ</abbr>
 453         //test that the valid fg offer is included
<abbr title=" 454         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 454         assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1)ðŸ”µ</abbr>
 455 
<abbr title=" 456         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 456         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 457         candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 458         //test that the invalid fg offer is excluded because there are no qualifying items
<abbr title=" 459         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);"> 459         assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1ðŸ”µ</abbr>
 460 
 461         verify();
 462     }
 463 
<abbr title=" 464     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; {"> 464     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; ðŸ”µ</abbr>
 465 
 466         @Override
 467         public CandidateFulfillmentGroupOffer answer() throws Throwable {
 468             return new CandidateFulfillmentGroupOfferImpl();
 469         }
 470 
 471     }
 472 
 473     public class FulfillmentGroupAdjustmentAnswer implements IAnswer&lt;FulfillmentGroupAdjustment&gt; {
 474 
 475         @Override
 476         public FulfillmentGroupAdjustment answer() throws Throwable {
 477             return new FulfillmentGroupAdjustmentImpl();
 478         }
 479 
 480     }
 481 
 482     public class CandidateItemOfferAnswer implements IAnswer&lt;CandidateItemOffer&gt; {
 483 
 484         @Override
 485         public CandidateItemOffer answer() throws Throwable {
 486             return new CandidateItemOfferImpl();
 487         }
 488 
 489     }
 490 
 491     public class OrderItemAdjustmentAnswer implements IAnswer&lt;OrderItemAdjustment&gt; {
 492 
 493         @Override
 494         public OrderItemAdjustment answer() throws Throwable {
 495             return new OrderItemAdjustmentImpl();
 496         }
 497 
 498     }
 499 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.service.processor;
  19 
  20 import java.math.BigDecimal;
  21 import java.util.ArrayList;
  22 import java.util.HashMap;
  23 import java.util.List;
  24 import java.util.TimeZone;
  25 import junit.framework.TestCase;
  26 import org.broadleafcommerce.common.service.GenericEntityService;
  27 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  28 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  29 import org.broadleafcommerce.core.offer.dao.OfferDao;
  30 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOffer;
  31 import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOfferImpl;
  32 import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  33 import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  34 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  35 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustmentImpl;
  36 import org.broadleafcommerce.core.offer.domain.Offer;
  37 import org.broadleafcommerce.core.offer.domain.OfferImpl;
  38 import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  39 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  40 import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  41 import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  42 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  43 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  44 import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  45 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;
  50 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;
  51 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  52 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  53 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  54 import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  55 import org.broadleafcommerce.core.order.dao.OrderItemDao;
  56 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  57 import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  58 import org.broadleafcommerce.core.order.domain.Order;
  59 import org.broadleafcommerce.core.order.domain.OrderItem;
  60 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  61 import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  62 import org.broadleafcommerce.core.order.domain.OrderMultishipOptionImpl;
  63 import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  64 import org.broadleafcommerce.core.order.service.OrderItemService;
  65 import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  66 import org.broadleafcommerce.core.order.service.OrderService;
  67 import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  68 import org.broadleafcommerce.profile.core.domain.Address;
  69 import org.easymock.EasyMock;
  70 import org.easymock.IAnswer;
  71 
  72 
  73 /**
  74  *
  75  * @author jfischer
  76  *
  77  */
  78 public class FulfillmentGroupOfferProcessorTest extends TestCase {
  79     protected OfferDao offerDaoMock;
  80 
  81     protected OrderItemDao orderItemDaoMock;
  82 
  83     protected OfferServiceImpl offerService;
  84 
  85     protected final OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  86 
  87     protected OrderService orderServiceMock;
  88 
  89     protected OrderItemService orderItemServiceMock;
  90 
  91     protected FulfillmentGroupItemDao fgItemDaoMock;
  92 
  93     protected FulfillmentGroupService fgServiceMock;
  94 
  95     protected OrderMultishipOptionService multishipOptionServiceMock;
  96 
  97     protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  98 
  99     protected OfferServiceUtilities offerServiceUtilitiesMock;
 100 
 101     protected PromotableOfferUtility promotableOfferUtility;
 102 
 103     protected GenericEntityService genericEntityServiceMock;
 104 
 105     protected FulfillmentGroupOfferProcessorImpl fgProcessor;
 106 
 107     /**
<abbr title=" 108      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application context and"> 108      * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application coðŸ”µ</abbr>
 109      * system properties service since it uses BLCSystemProperty
 110      *
 111      * @author Phillip Verheyden (phillipuniverse)
 112      */
<abbr title=" 113     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorImpl {"> 113     protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorIðŸ”µ</abbr>
 114         public TestableFulfillmentGroupOfferProcessor(PromotableOfferUtility promotableOfferUtility) {
 115             super(promotableOfferUtility);
 116         }
 117 
 118         @Override
 119         protected boolean getQualifyGroupAcrossAllOrderItems(PromotableFulfillmentGroup fg) {
 120             return false;
 121         }
 122     }
 123 
 124     @Override
 125     protected void setUp() throws Exception {
 126         offerService = new OfferServiceImpl();
 127         CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 128         OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 129         orderServiceMock = EasyMock.createMock(OrderService.class);
 130         orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 131         orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 132         fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 133         offerDaoMock = EasyMock.createMock(OfferDao.class);
 134         fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 135         multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 136         offerServiceUtilitiesMock = EasyMock.createMock(OfferServiceUtilities.class);
 137         offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
 138 
 139 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
 141 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 142 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 142 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 143 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 146 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 147 
 148         fgProcessor = new TestableFulfillmentGroupOfferProcessor(promotableOfferUtility);
 149         fgProcessor.setOfferDao(offerDaoMock);
 150         fgProcessor.setOrderItemDao(orderItemDaoMock);
 151         fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 152         fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
<abbr title=" 153         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);"> 153         OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtðŸ”µ</abbr>
 154         offerServiceUtilities.setOfferDao(offerDaoMock);
<abbr title=" 155         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));"> 155         offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtiliðŸ”µ</abbr>
 156         offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);
 157         OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);
 158         orderProcessor.setOfferDao(offerDaoMock);
 159         orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 160         orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 161         orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 162         orderProcessor.setOrderItemDao(orderItemDaoMock);
 163         orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 164         ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);
 165         itemProcessor.setOfferDao(offerDaoMock);
 166         itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 167         itemProcessor.setOrderItemDao(orderItemDaoMock);
 168         itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 169         offerService.setCustomerOfferDao(customerOfferDaoMock);
 170         offerService.setOfferCodeDao(offerCodeDaoMock);
 171         offerService.setOfferDao(offerDaoMock);
 172         offerService.setOrderOfferProcessor(orderProcessor);
 173         offerService.setItemOfferProcessor(itemProcessor);
 174         offerService.setFulfillmentGroupOfferProcessor(fgProcessor);
 175         offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));
 176         offerService.setOrderService(orderServiceMock);
 177     }
 178 
 179     public void replay() {
 180         EasyMock.replay(offerDaoMock);
 181         EasyMock.replay(orderItemDaoMock);
 182         EasyMock.replay(orderServiceMock);
 183         EasyMock.replay(orderItemServiceMock);
 184         EasyMock.replay(fgItemDaoMock);
 185         EasyMock.replay(fgServiceMock);
 186         EasyMock.replay(multishipOptionServiceMock);
 187         EasyMock.replay(offerTimeZoneProcessorMock);
 188         EasyMock.replay(offerServiceUtilitiesMock);
 189     }
 190 
 191     public void verify() {
 192         EasyMock.verify(offerDaoMock);
 193         EasyMock.verify(orderItemDaoMock);
 194         EasyMock.verify(orderServiceMock);
 195         EasyMock.verify(orderItemServiceMock);
 196         EasyMock.verify(fgItemDaoMock);
 197         EasyMock.verify(fgServiceMock);
 198         EasyMock.verify(multishipOptionServiceMock);
 199         EasyMock.verify(offerTimeZoneProcessorMock);
 200         EasyMock.verify(offerServiceUtilitiesMock);
 201     }
 202 
 203     public void testApplyAllFulfillmentGroupOffersWithOrderItemOffers() throws Exception {
 204         final ThreadLocal&lt;Order&gt; myOrder = new ThreadLocal&lt;Order&gt;();
<abbr title=" 205         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 205         EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.geðŸ”µ</abbr>
<abbr title=" 206         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).atLeastOnce();"> 206         EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCðŸ”µ</abbr>
<abbr title=" 207         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 207         EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.ðŸ”µ</abbr>
<abbr title=" 208         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(java.lang.Long.class), EasyMock.isA(java.lang.Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 208         EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(java.lang.Long.class), EasyMock.isA(javaðŸ”µ</abbr>
<abbr title=" 209         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(java.lang.Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 209         EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(java.lang.Boolean.cðŸ”µ</abbr>
<abbr title=" 210         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 210         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 211         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 211         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 212         EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
<abbr title=" 213         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 213         EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OffeðŸ”µ</abbr>
<abbr title=" 214         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 214         EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataðŸ”µ</abbr>
<abbr title=" 215         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 215         EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProviðŸ”µ</abbr>
<abbr title=" 216         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupAdjustmentAnswer()).anyTimes();"> 216         EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.ðŸ”µ</abbr>
<abbr title=" 217         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(java.lang.Long.class))).andAnswer(new IAnswer&lt;Order&gt;() {"> 217         EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(java.lang.Long.class))).andAnswer(newðŸ”µ</abbr>
 218             @Override
 219             public Order answer() throws Throwable {
 220                 return myOrder.get();
 221             }
 222         }).anyTimes();
<abbr title=" 223         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(java.lang.Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 223         EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(java.lang.Long.ðŸ”µ</abbr>
 224             @Override
 225             public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 226                 List&lt;OrderMultishipOption&gt; options = new ArrayList&lt;OrderMultishipOption&gt;();
 227                 PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 228                 for (FulfillmentGroup fg : order.getOrder().getFulfillmentGroups()) {
 229                     Address address = fg.getAddress();
 230                     for (FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
 231                         for (int j = 0; j &lt; fgItem.getQuantity(); j++) {
 232                             OrderMultishipOption option = new OrderMultishipOptionImpl();
 233                             option.setOrder(order.getOrder());
 234                             option.setAddress(address);
 235                             option.setOrderItem(fgItem.getOrderItem());
 236                             options.add(option);
 237                         }
 238                     }
 239                 }
 240                 return options;
 241             }
 242         }).anyTimes();
 243         multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 244         EasyMock.expectLastCall().anyTimes();
<abbr title=" 245         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(new IAnswer&lt;Order&gt;() {"> 245         EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EðŸ”µ</abbr>
 246             @Override
 247             public Order answer() throws Throwable {
 248                 Order order = ((Order) (EasyMock.getCurrentArguments()[0]));
<abbr title=" 249                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups().get(1).getFulfillmentGroupItems());"> 249                 order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmenðŸ”µ</abbr>
 250                 order.getFulfillmentGroups().remove(order.getFulfillmentGroups().get(1));
 251                 return order;
 252             }
 253         }).anyTimes();
<abbr title=" 254         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 254         EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupðŸ”µ</abbr>
 255         fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 256         EasyMock.expectLastCall().anyTimes();
<abbr title=" 257         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 257         EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(ðŸ”µ</abbr>
 258         replay();
<abbr title=" 259         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);"> 259         PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility)ðŸ”µ</abbr>
 260         Order order = promotableOrder.getOrder();
 261         myOrder.set(promotableOrder.getOrder());
<abbr title=" 262         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 262         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 263         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 263         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 264         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 264         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 265         offers.get(1).setName(&quot;secondOffer&quot;);
<abbr title=" 266         offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 266         offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, ðŸ”µ</abbr>
 267         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 268         offers.get(0).setTotalitarianOffer(true);
 269         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 270         int fgAdjustmentCount = 0;
 271         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 272             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 273         }
<abbr title=" 274         // The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order item offers"> 274         // The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than tðŸ”µ</abbr>
 275         // - it is therefore ignored
 276         // However, the second combinable fg offer is allowed to be applied.
 277         assertTrue(fgAdjustmentCount == 1);
 278         promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 279         myOrder.set(promotableOrder.getOrder());
 280         offers.get(2).setValue(new BigDecimal(&quot;1&quot;));
 281         offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 282         offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 283         fgAdjustmentCount = 0;
 284         order = promotableOrder.getOrder();
 285         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 286             fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 287         }
<abbr title=" 288         // The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fg offer is applied"> 288         // The totalitarian fg offer is now a better deal than the order item offers, therefore the totalðŸ”µ</abbr>
 289         // and the order item offers are removed
 290         assertTrue(fgAdjustmentCount == 2);
 291         int itemAdjustmentCount = 0;
 292         for (OrderItem item : order.getOrderItems()) {
 293             for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 294                 itemAdjustmentCount += detail.getOrderItemPriceDetailAdjustments().size();
 295             }
 296         }
 297         // Confirm that the order item offers are removed
 298         assertTrue(itemAdjustmentCount == 0);
 299         verify();
 300     }
 301 
 302     public void testApplyAllFulfillmentGroupOffers() {
<abbr title=" 303         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 303         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PðŸ”µ</abbr>
<abbr title=" 304         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 304         EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOðŸ”µ</abbr>
 305         replay();
 306         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 307         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 307         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 308         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 308         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 309         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 310         boolean offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 311         assertTrue(offerApplied);
 312         order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 313         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 314         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 314         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 315         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 315         offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fðŸ”µ</abbr>
 316         offers.get(1).setName(&quot;secondOffer&quot;);
 317         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 318         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(1));
 319         offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
<abbr title=" 320         // the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfillment groups"> 320         // the first offer applies to both fulfillment groups, but the second offer only applies to one oðŸ”µ</abbr>
 321         assertTrue(offerApplied);
 322         int fgAdjustmentCount = 0;
 323         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 324             fgAdjustmentCount += fg.getCandidateFulfillmentGroupAdjustments().size();
 325         }
 326         assertTrue(fgAdjustmentCount == 3);
 327         verify();
 328     }
 329 
 330     public void testFilterFulfillmentGroupLevelOffer() {
 331         replay();
 332         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 333         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 333         List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr>
<abbr title=" 334         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 334         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 335         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 336         // test that the valid fg offer is included
 337         // No item criteria, so each fulfillment group applies
<abbr title=" 338         assertTrue((qualifiedOffers.size() == 2) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 338         assertTrue((qualifiedOffers.size() == 2) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0ðŸ”µ</abbr>
 339         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 340         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 340         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 341         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 342         // test that the valid fg offer is included
 343         // only 1 fulfillment group has qualifying items
<abbr title=" 344         assertTrue((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));"> 344         assertTrue((qualifiedOffers.size() == 1) &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0ðŸ”µ</abbr>
 345         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 346         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 346         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 347         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 348         // test that the invalid fg offer is excluded - zipcode is wrong
 349         assertTrue(qualifiedOffers.size() == 0);
 350         qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 351         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 351         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 352         fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 353         // test that the invalid fg offer is excluded - no qualifying items
 354         assertTrue(qualifiedOffers.size() == 0);
 355         verify();
 356     }
 357 
 358     public void testCouldOfferApplyToFulfillmentGroup() {
 359         replay();
 360         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 361         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 361         List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
<abbr title=" 362         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 362         boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfilðŸ”µ</abbr>
 363         // test that the valid fg offer is included
 364         assertTrue(couldApply);
<abbr title=" 365         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF);"> 365         offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.addreðŸ”µ</abbr>
<abbr title=" 366         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 366         couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroðŸ”µ</abbr>
 367         // test that the invalid fg offer is excluded
 368         assertFalse(couldApply);
 369         verify();
 370     }
 371 
 372     public void testCouldOrderItemMeetOfferRequirement() {
 373         replay();
 374         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
<abbr title=" 375         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 375         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 376         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();"> 376         OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next(ðŸ”µ</abbr>
<abbr title=" 377         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 377         boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), ðŸ”µ</abbr>
 378         // test that the valid fg offer is included
 379         assertTrue(couldApply);
<abbr title=" 380         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 380         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 381         xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 382         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 382         couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.geðŸ”µ</abbr>
 383         // test that the invalid fg offer is excluded
 384         assertFalse(couldApply);
 385         verify();
 386     }
 387 
 388     public void testCouldOfferApplyToOrderItems() {
 389         replay();
 390         PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);
 391         List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 392         for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 393             orderItems.add(orderItem);
 394         }
<abbr title=" 395         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 395         List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;ðŸ”µ</abbr>
<abbr title=" 396         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);"> 396         CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderðŸ”µ</abbr>
 397         // test that the valid fg offer is included
<abbr title=" 398         assertTrue(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == 1));"> 398         assertTrue(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == 1ðŸ”µ</abbr>
<abbr title=" 399         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 399         offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfilðŸ”µ</abbr>
 400         candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 401         // test that the invalid fg offer is excluded because there are no qualifying items
<abbr title=" 402         assertFalse(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == 1));"> 402         assertFalse(candidates.isMatchedQualifier() &amp;&amp; (candidates.getCandidateQualifiersMap().size() == ðŸ”µ</abbr>
 403         verify();
 404     }
 405 
<abbr title=" 406     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; {"> 406     public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; ðŸ”µ</abbr>
 407         @Override
 408         public CandidateFulfillmentGroupOffer answer() throws Throwable {
 409             return new CandidateFulfillmentGroupOfferImpl();
 410         }
 411     }
 412 
 413     public class FulfillmentGroupAdjustmentAnswer implements IAnswer&lt;FulfillmentGroupAdjustment&gt; {
 414         @Override
 415         public FulfillmentGroupAdjustment answer() throws Throwable {
 416             return new FulfillmentGroupAdjustmentImpl();
 417         }
 418     }
 419 
 420     public class CandidateItemOfferAnswer implements IAnswer&lt;CandidateItemOffer&gt; {
 421         @Override
 422         public CandidateItemOffer answer() throws Throwable {
 423             return new CandidateItemOfferImpl();
 424         }
 425     }
 426 
 427     public class OrderItemAdjustmentAnswer implements IAnswer&lt;OrderItemAdjustment&gt; {
 428         @Override
 429         public OrderItemAdjustment answer() throws Throwable {
 430             return new OrderItemAdjustmentImpl();
 431         }
 432     }
 433 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import junit.framework.TestCase;</span>
  21  

  22  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  23  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  24  import org.broadleafcommerce.core.offer.dao.OfferDao;
  25  import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOffer;
  26  import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOfferImpl;
  27  import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  28  import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  29  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  30  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustmentImpl;
  31  import org.broadleafcommerce.core.offer.domain.Offer;
  32  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  33  import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  34  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  35  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  36  import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  37  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  38  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  39  import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  40  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtilityImpl;</span>
  46  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  47  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  48  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  49  import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  50  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  51  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  52  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  53  import org.broadleafcommerce.core.order.domain.Order;
  54  import org.broadleafcommerce.core.order.domain.OrderItem;
  55  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  56  import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  57  import org.broadleafcommerce.core.order.domain.OrderMultishipOptionImpl;
  58  import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  59  import org.broadleafcommerce.core.order.service.OrderItemService;
  60  import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  61  import org.broadleafcommerce.core.order.service.OrderService;
  62  import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  63  import org.broadleafcommerce.profile.core.domain.Address;
  64  import org.easymock.EasyMock;
  65  import org.easymock.IAnswer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
  67  import java.math.BigDecimal;
  68  import java.util.ArrayList;
  69  import java.util.HashMap;
  70  import java.util.List;
  71  import java.util.TimeZone;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import junit.framework.TestCase;</span>
  74  
  75  /**
  76   *
  77   * @author jfischer
  78   *
  79   */
  80  public class FulfillmentGroupOfferProcessorTest extends TestCase {
  81  
  82      protected OfferDao offerDaoMock;
  83      protected OrderItemDao orderItemDaoMock;
  84      protected OfferServiceImpl offerService;
  85      protected final OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  86      protected OrderService orderServiceMock;
  87      protected OrderItemService orderItemServiceMock;
  88      protected FulfillmentGroupItemDao fgItemDaoMock;
  89      protected FulfillmentGroupService fgServiceMock;
  90      protected OrderMultishipOptionService multishipOptionServiceMock;
  91      protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  92      protected OfferServiceUtilities offerServiceUtilitiesMock;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +    protected PromotableOfferUtility promotableOfferUtility;</span>
  94  
  95      protected FulfillmentGroupOfferProcessorImpl fgProcessor;
  96  
  97      /**
  98       * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application context and
  99       * system properties service since it uses BLCSystemProperty
 100       *
 101       * @author Phillip Verheyden (phillipuniverse)
 102       */
 103      protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorImpl {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        public TestableFulfillmentGroupOfferProcessor(PromotableOfferUtility promotableOfferUtility) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            super(promotableOfferUtility);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
 108          @Override
 109          protected boolean getQualifyGroupAcrossAllOrderItems(PromotableFulfillmentGroup fg) {
 110              return false;
 111          }
 112      }
 113  
 114      @Override
 115      protected void setUp() throws Exception {
 116          offerService = new OfferServiceImpl();
 117          CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 118          OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 119          orderServiceMock = EasyMock.createMock(OrderService.class);
 120          orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 121  
 122          orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 123          fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 124          offerDaoMock = EasyMock.createMock(OfferDao.class);
 125          fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 126          multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 127          offerServiceUtilitiesMock = EasyMock.createMock(OfferServiceUtilities.class);
 128          offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        fgProcessor = new TestableFulfillmentGroupOfferProcessor();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        promotableOfferUtility = new PromotableOfferUtilityImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        fgProcessor = new TestableFulfillmentGroupOfferProcessor(promotableOfferUtility);</span>
 134          fgProcessor.setOfferDao(offerDaoMock);
 135          fgProcessor.setOrderItemDao(orderItemDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 138          fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 139  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl(promotableOfferUtility);</span>
 142          offerServiceUtilities.setOfferDao(offerDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +        OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl(promotableOfferUtility);</span>
 149          orderProcessor.setOfferDao(offerDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 152          orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 153          orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 154          orderProcessor.setOrderItemDao(orderItemDaoMock);
 155          orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 156  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl(promotableOfferUtility);</span>
 159          itemProcessor.setOfferDao(offerDaoMock);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 162          itemProcessor.setOrderItemDao(orderItemDaoMock);
 163          itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 164  
 165          offerService.setCustomerOfferDao(customerOfferDaoMock);
 166          offerService.setOfferCodeDao(offerCodeDaoMock);
 167          offerService.setOfferDao(offerDaoMock);
 168          offerService.setOrderOfferProcessor(orderProcessor);
 169          offerService.setItemOfferProcessor(itemProcessor);
 170          offerService.setFulfillmentGroupOfferProcessor(fgProcessor);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        offerService.setPromotableItemFactory(new PromotableItemFactoryImpl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +        offerService.setPromotableItemFactory(new PromotableItemFactoryImpl(promotableOfferUtility));</span>
 173          offerService.setOrderService(orderServiceMock);
 174      }
 175  
 176      public void replay() {
 177          EasyMock.replay(offerDaoMock);
 178          EasyMock.replay(orderItemDaoMock);
 179          EasyMock.replay(orderServiceMock);
 180          EasyMock.replay(orderItemServiceMock);
 181          EasyMock.replay(fgItemDaoMock);
 182          EasyMock.replay(fgServiceMock);
 183          EasyMock.replay(multishipOptionServiceMock);
 184          EasyMock.replay(offerTimeZoneProcessorMock);
 185          EasyMock.replay(offerServiceUtilitiesMock);
 186      }
 187  
 188      public void verify() {
 189          EasyMock.verify(offerDaoMock);
 190          EasyMock.verify(orderItemDaoMock);
 191          EasyMock.verify(orderServiceMock);
 192          EasyMock.verify(orderItemServiceMock);
 193          EasyMock.verify(fgItemDaoMock);
 194          EasyMock.verify(fgServiceMock);
 195          EasyMock.verify(multishipOptionServiceMock);
 196          EasyMock.verify(offerTimeZoneProcessorMock);
 197          EasyMock.verify(offerServiceUtilitiesMock);
 198      }
 199  
 200      public void testApplyAllFulfillmentGroupOffersWithOrderItemOffers() throws Exception {
 201          final ThreadLocal&lt;Order&gt; myOrder = new ThreadLocal&lt;Order&gt;();
<abbr title=" 202          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 202          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrðŸ”µ</abbr>
 203  
<abbr title=" 204          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).atLeastOnce();"> 204          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrdeðŸ”µ</abbr>
 205  
<abbr title=" 206          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 206          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EðŸ”µ</abbr>
<abbr title=" 207          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 207          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 208          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 208          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OðŸ”µ</abbr>
 209  
<abbr title=" 210          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 210          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableðŸ”µ</abbr>
<abbr title=" 211          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 211          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.clasðŸ”µ</abbr>
 212  
 213          EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
<abbr title=" 214          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 214          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemðŸ”µ</abbr>
<abbr title=" 215          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 215          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 216  
<abbr title=" 217          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 217          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCrðŸ”µ</abbr>
<abbr title=" 218          EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupAdjustmentAnswer()).anyTimes();"> 218          EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateðŸ”µ</abbr>
 219  
 220          EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;Order&gt;() {
 221  
 222              @Override
 223              public Order answer() throws Throwable {
 224                  return myOrder.get();
 225              }
 226          }).anyTimes();
 227  
<abbr title=" 228          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 228          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(ðŸ”µ</abbr>
 229  
 230              @Override
 231              public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 232                  List&lt;OrderMultishipOption&gt; options = new ArrayList&lt;OrderMultishipOption&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -                PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 235                  for (FulfillmentGroup fg : order.getOrder().getFulfillmentGroups()) {
 236                      Address address = fg.getAddress();
 237                      for (FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
 238                          for (int j = 0; j &lt; fgItem.getQuantity(); j++) {
 239                              OrderMultishipOption option = new OrderMultishipOptionImpl();
 240                              option.setOrder(order.getOrder());
 241                              option.setAddress(address);
 242                              option.setOrderItem(fgItem.getOrderItem());
 243                              options.add(option);
 244                          }
 245                      }
 246                  }
 247  
 248                  return options;
 249              }
 250          }).anyTimes();
 251  
 252          multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 253          EasyMock.expectLastCall().anyTimes();
<abbr title=" 254          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(new IAnswer&lt;Order&gt;() {"> 254          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eðŸ”µ</abbr>
 255  
 256              @Override
 257              public Order answer() throws Throwable {
 258                  Order order = (Order) EasyMock.getCurrentArguments()[0];
<abbr title=" 259                  order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups().get(1).getFulfillmentGroupItems());"> 259                  order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups()ðŸ”µ</abbr>
 260                  order.getFulfillmentGroups().remove(order.getFulfillmentGroups().get(1));
 261  
 262                  return order;
 263              }
 264          }).anyTimes();
<abbr title=" 265          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 265          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnsweðŸ”µ</abbr>
 266          fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 267          EasyMock.expectLastCall().anyTimes();
<abbr title=" 268          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 268          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.ðŸ”µ</abbr>
 269  
 270          replay();
 271  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -        PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +        PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 274          Order order = promotableOrder.getOrder();
 275          myOrder.set(promotableOrder.getOrder());
<abbr title=" 276          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 276          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 277          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 277          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
<abbr title=" 278          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 278          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 279          offers.get(1).setName(&quot;secondOffer&quot;);
 280  
 281          offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(
 282                  &quot;order.subTotal.getAmount()&gt;20&quot;,
 283                  OfferDiscountType.PERCENT_OFF,
<abbr title=" 284                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 284                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eðŸ”µ</abbr>
<abbr title=" 285                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 285                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eðŸ”µ</abbr>
 286                  ));
 287          offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 288  
 289          offers.get(0).setTotalitarianOffer(true);
 290          offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 291  
 292          int fgAdjustmentCount = 0;
 293          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 294              fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 295          }
<abbr title=" 296          //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order item offers"> 296          //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order iðŸ”µ</abbr>
 297          // - it is therefore ignored
 298          //However, the second combinable fg offer is allowed to be applied.
 299          assertTrue(fgAdjustmentCount == 1);
 300  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        promotableOrder = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +        promotableOrder = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 303          myOrder.set(promotableOrder.getOrder());
 304          offers.get(2).setValue(new BigDecimal(&quot;1&quot;));
 305  
 306          offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 307          offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 308  
 309          fgAdjustmentCount = 0;
 310          order = promotableOrder.getOrder();
 311          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 312              fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 313          }
 314  
<abbr title=" 315          //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fg offer is applied"> 315          //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fgðŸ”µ</abbr>
 316          //and the order item offers are removed
 317          assertTrue(fgAdjustmentCount == 2);
 318  
 319          int itemAdjustmentCount = 0;
 320          for (OrderItem item : order.getOrderItems()) {
 321              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 322                  itemAdjustmentCount += detail.getOrderItemPriceDetailAdjustments().size();
 323              }
 324          }
 325  
 326          //Confirm that the order item offers are removed
 327          assertTrue(itemAdjustmentCount == 0);
 328          verify();
 329      }
 330  
 331      public void testApplyAllFulfillmentGroupOffers() {
<abbr title=" 332          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 332          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableðŸ”µ</abbr>
<abbr title=" 333          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 333          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.clasðŸ”µ</abbr>
 334          replay();
 335  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 338  
<abbr title=" 339          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 339          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 340          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 340          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
 341          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 342  
 343          boolean offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 344  
 345          assertTrue(offerApplied);
 346  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -        order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 349  
 350          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 351          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 351          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalðŸ”µ</abbr>
<abbr title=" 352          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 352          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 353          offers.get(1).setName(&quot;secondOffer&quot;);
 354          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 355          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(1));
 356  
 357          offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 358  
<abbr title=" 359          //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfillment groups"> 359          //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfðŸ”µ</abbr>
 360          assertTrue(offerApplied);
 361          int fgAdjustmentCount = 0;
 362          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 363              fgAdjustmentCount += fg.getCandidateFulfillmentGroupAdjustments().size();
 364          }
 365          assertTrue(fgAdjustmentCount == 3);
 366  
 367          verify();
 368      }
 369  
 370      public void testFilterFulfillmentGroupLevelOffer() {
 371          replay();
 372  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 375  
<abbr title=" 376          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 376          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 377          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 377          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
 378          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 379  
 380          //test that the valid fg offer is included
 381          //No item criteria, so each fulfillment group applies
 382          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));
 383  
 384          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 385          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 385          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 386          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 387  
 388          //test that the valid fg offer is included
 389          //only 1 fulfillment group has qualifying items
 390          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));
 391  
 392          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 393          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 393          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 394          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 395  
 396          //test that the invalid fg offer is excluded - zipcode is wrong
 397          assertTrue(qualifiedOffers.size() == 0);
 398  
 399          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 400          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 400          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 401          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 402  
 403          //test that the invalid fg offer is excluded - no qualifying items
 404          assertTrue(qualifiedOffers.size() == 0);
 405  
 406          verify();
 407      }
 408  
 409      public void testCouldOfferApplyToFulfillmentGroup() {
 410          replay();
 411  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
<abbr title=" 414          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 414          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
<abbr title=" 415          boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 415          boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGrouðŸ”µ</abbr>
 416          //test that the valid fg offer is included
 417          assertTrue(couldApply);
 418  
<abbr title=" 419          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF);"> 419          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalðŸ”µ</abbr>
<abbr title=" 420          couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 420          couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().getðŸ”µ</abbr>
 421          //test that the invalid fg offer is excluded
 422          assertFalse(couldApply);
 423  
 424          verify();
 425      }
 426  
 427      public void testCouldOrderItemMeetOfferRequirement() {
 428          replay();
 429  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
<abbr title=" 432          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 432          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulðŸ”µ</abbr>
 433          OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 434          boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 434          boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getðŸ”µ</abbr>
 435          //test that the valid fg offer is included
 436          assertTrue(couldApply);
 437  
<abbr title=" 438          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 438          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 439          xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 440          couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 440          couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountðŸ”µ</abbr>
 441          //test that the invalid fg offer is excluded
 442          assertFalse(couldApply);
 443  
 444          verify();
 445      }
 446  
 447      public void testCouldOfferApplyToOrderItems() {
 448          replay();
 449  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -        PromotableOrder order = dataProvider.createBasicPromotableOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 451 +        PromotableOrder order = dataProvider.createBasicPromotableOrder(promotableOfferUtility);</span>
 452  
 453          List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 454          for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 455              orderItems.add(orderItem);
 456          }
 457  
<abbr title=" 458          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 458          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulðŸ”µ</abbr>
 459          CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 460          //test that the valid fg offer is included
 461          assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 462  
<abbr title=" 463          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 463          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 464          candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 465          //test that the invalid fg offer is excluded because there are no qualifying items
 466          assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 467  
 468          verify();
 469      }
 470  
 471      public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; {
 472  
 473          @Override
 474          public CandidateFulfillmentGroupOffer answer() throws Throwable {
 475              return new CandidateFulfillmentGroupOfferImpl();
 476          }
 477  
 478      }
 479  
 480      public class FulfillmentGroupAdjustmentAnswer implements IAnswer&lt;FulfillmentGroupAdjustment&gt; {
 481  
 482          @Override
 483          public FulfillmentGroupAdjustment answer() throws Throwable {
 484              return new FulfillmentGroupAdjustmentImpl();
 485          }
 486  
 487      }
 488  
 489      public class CandidateItemOfferAnswer implements IAnswer&lt;CandidateItemOffer&gt; {
 490  
 491          @Override
 492          public CandidateItemOffer answer() throws Throwable {
 493              return new CandidateItemOfferImpl();
 494          }
 495  
 496      }
 497  
 498      public class OrderItemAdjustmentAnswer implements IAnswer&lt;OrderItemAdjustment&gt; {
 499  
 500          @Override
 501          public OrderItemAdjustment answer() throws Throwable {
 502              return new OrderItemAdjustmentImpl();
 503          }
 504  
 505      }
 506  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.service.processor;


  19  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  21  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;
  22  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;
  23  import org.broadleafcommerce.core.offer.dao.OfferDao;
  24  import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOffer;
  25  import org.broadleafcommerce.core.offer.domain.CandidateFulfillmentGroupOfferImpl;
  26  import org.broadleafcommerce.core.offer.domain.CandidateItemOffer;
  27  import org.broadleafcommerce.core.offer.domain.CandidateItemOfferImpl;
  28  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;
  29  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustmentImpl;
  30  import org.broadleafcommerce.core.offer.domain.Offer;
  31  import org.broadleafcommerce.core.offer.domain.OfferImpl;
  32  import org.broadleafcommerce.core.offer.domain.OfferQualifyingCriteriaXref;
  33  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustment;
  34  import org.broadleafcommerce.core.offer.domain.OrderItemAdjustmentImpl;
  35  import org.broadleafcommerce.core.offer.service.OfferDataItemProvider;
  36  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;
  37  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;
  38  import org.broadleafcommerce.core.offer.service.OfferServiceUtilitiesImpl;
  39  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;
  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;
  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;
  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactoryImpl;


  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;
  44  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;
  45  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;
  46  import org.broadleafcommerce.core.order.dao.FulfillmentGroupItemDao;
  47  import org.broadleafcommerce.core.order.dao.OrderItemDao;
  48  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;
  49  import org.broadleafcommerce.core.order.domain.FulfillmentGroupItem;
  50  import org.broadleafcommerce.core.order.domain.Order;
  51  import org.broadleafcommerce.core.order.domain.OrderItem;
  52  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;
  53  import org.broadleafcommerce.core.order.domain.OrderMultishipOption;
  54  import org.broadleafcommerce.core.order.domain.OrderMultishipOptionImpl;
  55  import org.broadleafcommerce.core.order.service.FulfillmentGroupService;
  56  import org.broadleafcommerce.core.order.service.OrderItemService;
  57  import org.broadleafcommerce.core.order.service.OrderMultishipOptionService;
  58  import org.broadleafcommerce.core.order.service.OrderService;
  59  import org.broadleafcommerce.core.order.service.call.FulfillmentGroupItemRequest;
  60  import org.broadleafcommerce.profile.core.domain.Address;
  61  import org.easymock.EasyMock;
  62  import org.easymock.IAnswer;
  63  
  64  import java.math.BigDecimal;
  65  import java.util.ArrayList;
  66  import java.util.HashMap;
  67  import java.util.List;
  68  import java.util.TimeZone;
  69  
  70  import junit.framework.TestCase;
  71  
  72  /**
  73   *
  74   * @author jfischer
  75   *
  76   */
  77  public class FulfillmentGroupOfferProcessorTest extends TestCase {
  78  
  79      protected OfferDao offerDaoMock;
  80      protected OrderItemDao orderItemDaoMock;
  81      protected OfferServiceImpl offerService;
  82      protected final OfferDataItemProvider dataProvider = new OfferDataItemProvider();
  83      protected OrderService orderServiceMock;
  84      protected OrderItemService orderItemServiceMock;
  85      protected FulfillmentGroupItemDao fgItemDaoMock;
  86      protected FulfillmentGroupService fgServiceMock;
  87      protected OrderMultishipOptionService multishipOptionServiceMock;
  88      protected OfferTimeZoneProcessor offerTimeZoneProcessorMock;
  89      protected OfferServiceUtilities offerServiceUtilitiesMock;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    protected GenericEntityService genericEntityServiceMock;</span>
  91  
  92      protected FulfillmentGroupOfferProcessorImpl fgProcessor;
  93  
  94      /**
  95       * Created to work around a dependency in FulfillmentGroupOfferProcessorImpl to a live application context and
  96       * system properties service since it uses BLCSystemProperty
  97       *
  98       * @author Phillip Verheyden (phillipuniverse)
  99       */
 100      protected static class TestableFulfillmentGroupOfferProcessor extends FulfillmentGroupOfferProcessorImpl {




 101          @Override
 102          protected boolean getQualifyGroupAcrossAllOrderItems(PromotableFulfillmentGroup fg) {
 103              return false;
 104          }
 105      }
 106  
 107      @Override
 108      protected void setUp() throws Exception {
 109          offerService = new OfferServiceImpl();
 110          CustomerOfferDao customerOfferDaoMock = EasyMock.createMock(CustomerOfferDao.class);
 111          OfferCodeDao offerCodeDaoMock = EasyMock.createMock(OfferCodeDao.class);
 112          orderServiceMock = EasyMock.createMock(OrderService.class);
 113          orderItemDaoMock = EasyMock.createMock(OrderItemDao.class);
 114  
 115          orderItemServiceMock = EasyMock.createMock(OrderItemService.class);
 116          fgItemDaoMock = EasyMock.createMock(FulfillmentGroupItemDao.class);
 117          offerDaoMock = EasyMock.createMock(OfferDao.class);
 118          fgServiceMock = EasyMock.createMock(FulfillmentGroupService.class);
 119          multishipOptionServiceMock = EasyMock.createMock(OrderMultishipOptionService.class);
 120          offerServiceUtilitiesMock = EasyMock.createMock(OfferServiceUtilities.class);
 121          offerTimeZoneProcessorMock = EasyMock.createMock(OfferTimeZoneProcessor.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        genericEntityServiceMock = EasyMock.createMock(GenericEntityService.class);</span>
 123  
 124          fgProcessor = new TestableFulfillmentGroupOfferProcessor();



 125          fgProcessor.setOfferDao(offerDaoMock);
 126          fgProcessor.setOrderItemDao(orderItemDaoMock);
 127          fgProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());

 128          fgProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 129  
 130          OfferServiceUtilitiesImpl offerServiceUtilities = new OfferServiceUtilitiesImpl();

 131          offerServiceUtilities.setOfferDao(offerDaoMock);
 132          offerServiceUtilities.setPromotableItemFactory(new PromotableItemFactoryImpl());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        offerServiceUtilities.setGenericEntityService(genericEntityServiceMock);</span>
 134  
 135          OrderOfferProcessorImpl orderProcessor = new OrderOfferProcessorImpl();



 136          orderProcessor.setOfferDao(offerDaoMock);
 137          orderProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());

 138          orderProcessor.setOfferServiceUtilities(offerServiceUtilitiesMock);
 139          orderProcessor.setOfferTimeZoneProcessor(offerTimeZoneProcessorMock);
 140          orderProcessor.setOrderItemDao(orderItemDaoMock);
 141          orderProcessor.setOfferServiceUtilities(offerServiceUtilities);
 142  
 143          ItemOfferProcessorImpl itemProcessor = new ItemOfferProcessorImpl();

 144          itemProcessor.setOfferDao(offerDaoMock);
 145          itemProcessor.setPromotableItemFactory(new PromotableItemFactoryImpl());

 146          itemProcessor.setOrderItemDao(orderItemDaoMock);
 147          itemProcessor.setOfferServiceUtilities(offerServiceUtilities);
 148  
 149          offerService.setCustomerOfferDao(customerOfferDaoMock);
 150          offerService.setOfferCodeDao(offerCodeDaoMock);
 151          offerService.setOfferDao(offerDaoMock);
 152          offerService.setOrderOfferProcessor(orderProcessor);
 153          offerService.setItemOfferProcessor(itemProcessor);
 154          offerService.setFulfillmentGroupOfferProcessor(fgProcessor);
 155          offerService.setPromotableItemFactory(new PromotableItemFactoryImpl());

 156          offerService.setOrderService(orderServiceMock);
 157      }
 158  
 159      public void replay() {
 160          EasyMock.replay(offerDaoMock);
 161          EasyMock.replay(orderItemDaoMock);
 162          EasyMock.replay(orderServiceMock);
 163          EasyMock.replay(orderItemServiceMock);
 164          EasyMock.replay(fgItemDaoMock);
 165          EasyMock.replay(fgServiceMock);
 166          EasyMock.replay(multishipOptionServiceMock);
 167          EasyMock.replay(offerTimeZoneProcessorMock);
 168          EasyMock.replay(offerServiceUtilitiesMock);
 169      }
 170  
 171      public void verify() {
 172          EasyMock.verify(offerDaoMock);
 173          EasyMock.verify(orderItemDaoMock);
 174          EasyMock.verify(orderServiceMock);
 175          EasyMock.verify(orderItemServiceMock);
 176          EasyMock.verify(fgItemDaoMock);
 177          EasyMock.verify(fgServiceMock);
 178          EasyMock.verify(multishipOptionServiceMock);
 179          EasyMock.verify(offerTimeZoneProcessorMock);
 180          EasyMock.verify(offerServiceUtilitiesMock);
 181      }
 182  
 183      public void testApplyAllFulfillmentGroupOffersWithOrderItemOffers() throws Exception {
 184          final ThreadLocal&lt;Order&gt; myOrder = new ThreadLocal&lt;Order&gt;();
<abbr title=" 185          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAnswer()).anyTimes();"> 185          EasyMock.expect(orderItemDaoMock.createOrderItemPriceDetail()).andAnswer(OfferDataItemProvider.getCreateOrðŸ”µ</abbr>
 186  
<abbr title=" 187          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrderItemQualifierAnswer()).atLeastOnce();"> 187          EasyMock.expect(orderItemDaoMock.createOrderItemQualifier()).andAnswer(OfferDataItemProvider.getCreateOrdeðŸ”µ</abbr>
 188  
<abbr title=" 189          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getAddItemToFulfillmentGroupAnswer()).anyTimes();"> 189          EasyMock.expect(fgServiceMock.addItemToFulfillmentGroup(EasyMock.isA(FulfillmentGroupItemRequest.class), EðŸ”µ</abbr>
<abbr title=" 190          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eq(false))).andAnswer(OfferDataItemProvider.getRemoveItemFromOrderAnswer()).anyTimes();"> 190          EasyMock.expect(orderServiceMock.removeItem(EasyMock.isA(Long.class), EasyMock.isA(Long.class), EasyMock.eðŸ”µ</abbr>
<abbr title=" 191          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OfferDataItemProvider.getSaveOrderAnswer()).anyTimes();"> 191          EasyMock.expect(orderServiceMock.save(EasyMock.isA(Order.class), EasyMock.isA(Boolean.class))).andAnswer(OðŸ”µ</abbr>
 192  
<abbr title=" 193          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 193          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableðŸ”µ</abbr>
<abbr title=" 194          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 194          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.clasðŸ”µ</abbr>
 195  
 196          EasyMock.expect(orderServiceMock.getAutomaticallyMergeLikeItems()).andReturn(true).anyTimes();
<abbr title=" 197          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemProvider.getSaveOrderItemAnswer()).anyTimes();"> 197          EasyMock.expect(orderItemServiceMock.saveOrderItem(EasyMock.isA(OrderItem.class))).andAnswer(OfferDataItemðŸ”µ</abbr>
<abbr title=" 198          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProvider.getSaveFulfillmentGroupItemAnswer()).anyTimes();"> 198          EasyMock.expect(fgItemDaoMock.save(EasyMock.isA(FulfillmentGroupItem.class))).andAnswer(OfferDataItemProviðŸ”µ</abbr>
 199  
<abbr title=" 200          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCreateOrderItemPriceDetailAdjustmentAnswer()).anyTimes();"> 200          EasyMock.expect(offerDaoMock.createOrderItemPriceDetailAdjustment()).andAnswer(OfferDataItemProvider.getCrðŸ”µ</abbr>
<abbr title=" 201          EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupAdjustmentAnswer()).anyTimes();"> 201          EasyMock.expect(offerDaoMock.createFulfillmentGroupAdjustment()).andAnswer(OfferDataItemProvider.getCreateðŸ”µ</abbr>
 202  
 203          EasyMock.expect(orderServiceMock.findOrderById(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;Order&gt;() {
 204  
 205              @Override
 206              public Order answer() throws Throwable {
 207                  return myOrder.get();
 208              }
 209          }).anyTimes();
 210  
<abbr title=" 211          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(new IAnswer&lt;List&lt;OrderMultishipOption&gt;&gt;() {"> 211          EasyMock.expect(multishipOptionServiceMock.findOrderMultishipOptions(EasyMock.isA(Long.class))).andAnswer(ðŸ”µ</abbr>
 212  
 213              @Override
 214              public List&lt;OrderMultishipOption&gt; answer() throws Throwable {
 215                  List&lt;OrderMultishipOption&gt; options = new ArrayList&lt;OrderMultishipOption&gt;();
 216                  PromotableOrder order = dataProvider.createBasicPromotableOrder();

 217                  for (FulfillmentGroup fg : order.getOrder().getFulfillmentGroups()) {
 218                      Address address = fg.getAddress();
 219                      for (FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
 220                          for (int j = 0; j &lt; fgItem.getQuantity(); j++) {
 221                              OrderMultishipOption option = new OrderMultishipOptionImpl();
 222                              option.setOrder(order.getOrder());
 223                              option.setAddress(address);
 224                              option.setOrderItem(fgItem.getOrderItem());
 225                              options.add(option);
 226                          }
 227                      }
 228                  }
 229  
 230                  return options;
 231              }
 232          }).anyTimes();
 233  
 234          multishipOptionServiceMock.deleteAllOrderMultishipOptions(EasyMock.isA(Order.class));
 235          EasyMock.expectLastCall().anyTimes();
<abbr title=" 236          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eq(false))).andAnswer(new IAnswer&lt;Order&gt;() {"> 236          EasyMock.expect(fgServiceMock.collapseToOneShippableFulfillmentGroup(EasyMock.isA(Order.class), EasyMock.eðŸ”µ</abbr>
 237  
 238              @Override
 239              public Order answer() throws Throwable {
 240                  Order order = (Order) EasyMock.getCurrentArguments()[0];
<abbr title=" 241                  order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups().get(1).getFulfillmentGroupItems());"> 241                  order.getFulfillmentGroups().get(0).getFulfillmentGroupItems().addAll(order.getFulfillmentGroups()ðŸ”µ</abbr>
 242                  order.getFulfillmentGroups().remove(order.getFulfillmentGroups().get(1));
 243  
 244                  return order;
 245              }
 246          }).anyTimes();
<abbr title=" 247          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnswer()).anyTimes();"> 247          EasyMock.expect(fgItemDaoMock.create()).andAnswer(OfferDataItemProvider.getCreateFulfillmentGroupItemAnsweðŸ”µ</abbr>
 248          fgItemDaoMock.delete(EasyMock.isA(FulfillmentGroupItem.class));
 249          EasyMock.expectLastCall().anyTimes();
<abbr title=" 250          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.getTimeZone(&quot;CST&quot;)).anyTimes();"> 250          EasyMock.expect(offerTimeZoneProcessorMock.getTimeZone(EasyMock.isA(OfferImpl.class))).andReturn(TimeZone.ðŸ”µ</abbr>
 251  
 252          replay();
 253  
 254          PromotableOrder promotableOrder = dataProvider.createBasicPromotableOrder();

 255          Order order = promotableOrder.getOrder();
 256          myOrder.set(promotableOrder.getOrder());
<abbr title=" 257          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 257          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 258          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 258          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
<abbr title=" 259          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 259          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 260          offers.get(1).setName(&quot;secondOffer&quot;);
 261  
 262          offers.addAll(dataProvider.createItemBasedOfferWithItemCriteria(
 263                  &quot;order.subTotal.getAmount()&gt;20&quot;,
 264                  OfferDiscountType.PERCENT_OFF,
<abbr title=" 265                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;,"> 265                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eðŸ”µ</abbr>
<abbr title=" 266                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;"> 266                  &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eðŸ”µ</abbr>
 267                  ));
 268          offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 269  
 270          offers.get(0).setTotalitarianOffer(true);
 271          offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 272  
 273          int fgAdjustmentCount = 0;
 274          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 275              fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 276          }
<abbr title=" 277          //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order item offers"> 277          //The totalitarian offer that applies to both fg&#x27;s is not combinable and is a worse offer than the order iðŸ”µ</abbr>
 278          // - it is therefore ignored
 279          //However, the second combinable fg offer is allowed to be applied.
 280          assertTrue(fgAdjustmentCount == 1);
 281  
 282          promotableOrder = dataProvider.createBasicPromotableOrder();

 283          myOrder.set(promotableOrder.getOrder());
 284          offers.get(2).setValue(new BigDecimal(&quot;1&quot;));
 285  
 286          offerService.applyAndSaveOffersToOrder(offers, promotableOrder.getOrder());
 287          offerService.applyAndSaveFulfillmentGroupOffersToOrder(offers, promotableOrder.getOrder());
 288  
 289          fgAdjustmentCount = 0;
 290          order = promotableOrder.getOrder();
 291          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {
 292              fgAdjustmentCount += fg.getFulfillmentGroupAdjustments().size();
 293          }
 294  
<abbr title=" 295          //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fg offer is applied"> 295          //The totalitarian fg offer is now a better deal than the order item offers, therefore the totalitarian fgðŸ”µ</abbr>
 296          //and the order item offers are removed
 297          assertTrue(fgAdjustmentCount == 2);
 298  
 299          int itemAdjustmentCount = 0;
 300          for (OrderItem item : order.getOrderItems()) {
 301              for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {
 302                  itemAdjustmentCount += detail.getOrderItemPriceDetailAdjustments().size();
 303              }
 304          }
 305  
 306          //Confirm that the order item offers are removed
 307          assertTrue(itemAdjustmentCount == 0);
 308          verify();
 309      }
 310  
 311      public void testApplyAllFulfillmentGroupOffers() {
<abbr title=" 312          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class), EasyMock.isA(HashMap.class))).andReturn(true).anyTimes();"> 312          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsQualifyingSubtotalRequirements(EasyMock.isA(PromotableðŸ”µ</abbr>
<abbr title=" 313          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.class), EasyMock.isA(Offer.class))).andReturn(true).anyTimes();"> 313          EasyMock.expect(offerServiceUtilitiesMock.orderMeetsSubtotalRequirements(EasyMock.isA(PromotableOrder.clasðŸ”µ</abbr>
 314          replay();
 315  
 316          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 317  
<abbr title=" 318          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 318          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 319          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 319          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
 320          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 321  
 322          boolean offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 323  
 324          assertTrue(offerApplied);
 325  
 326          order = dataProvider.createBasicPromotableOrder();

 327  
 328          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 329          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 329          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalðŸ”µ</abbr>
<abbr title=" 330          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;));"> 330          offers.addAll(dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmenðŸ”µ</abbr>
 331          offers.get(1).setName(&quot;secondOffer&quot;);
 332          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 333          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(1));
 334  
 335          offerApplied = fgProcessor.applyAllFulfillmentGroupOffers(qualifiedOffers, order);
 336  
<abbr title=" 337          //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfillment groups"> 337          //the first offer applies to both fulfillment groups, but the second offer only applies to one of the fulfðŸ”µ</abbr>
 338          assertTrue(offerApplied);
 339          int fgAdjustmentCount = 0;
 340          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {
 341              fgAdjustmentCount += fg.getCandidateFulfillmentGroupAdjustments().size();
 342          }
 343          assertTrue(fgAdjustmentCount == 3);
 344  
 345          verify();
 346      }
 347  
 348      public void testFilterFulfillmentGroupLevelOffer() {
 349          replay();
 350  
 351          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 352  
<abbr title=" 353          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 353          List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmðŸ”µ</abbr>
<abbr title=" 354          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 354          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
 355          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 356  
 357          //test that the valid fg offer is included
 358          //No item criteria, so each fulfillment group applies
 359          assertTrue(qualifiedOffers.size() == 2 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));
 360  
 361          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 362          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 362          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 363          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 364  
 365          //test that the valid fg offer is included
 366          //only 1 fulfillment group has qualifying items
 367          assertTrue(qualifiedOffers.size() == 1 &amp;&amp; qualifiedOffers.get(0).getOffer().equals(offers.get(0)));
 368  
 369          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 370          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 370          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 371          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 372  
 373          //test that the invalid fg offer is excluded - zipcode is wrong
 374          assertTrue(qualifiedOffers.size() == 0);
 375  
 376          qualifiedOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();
<abbr title=" 377          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;),MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 377          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 378          fgProcessor.filterFulfillmentGroupLevelOffer(order, qualifiedOffers, offers.get(0));
 379  
 380          //test that the invalid fg offer is excluded - no qualifying items
 381          assertTrue(qualifiedOffers.size() == 0);
 382  
 383          verify();
 384      }
 385  
 386      public void testCouldOfferApplyToFulfillmentGroup() {
 387          replay();
 388  
 389          PromotableOrder order = dataProvider.createBasicPromotableOrder();

<abbr title=" 390          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF);"> 390          List&lt;Offer&gt; offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.adðŸ”µ</abbr>
<abbr title=" 391          boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 391          boolean couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGrouðŸ”µ</abbr>
 392          //test that the valid fg offer is included
 393          assertTrue(couldApply);
 394  
<abbr title=" 395          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75240&quot;, OfferDiscountType.PERCENT_OFF);"> 395          offers = dataProvider.createFGBasedOffer(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalðŸ”µ</abbr>
<abbr title=" 396          couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().get(0));"> 396          couldApply = fgProcessor.couldOfferApplyToFulfillmentGroup(offers.get(0), order.getFulfillmentGroups().getðŸ”µ</abbr>
 397          //test that the invalid fg offer is excluded
 398          assertFalse(couldApply);
 399  
 400          verify();
 401      }
 402  
 403      public void testCouldOrderItemMeetOfferRequirement() {
 404          replay();
 405  
 406          PromotableOrder order = dataProvider.createBasicPromotableOrder();

<abbr title=" 407          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 407          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulðŸ”µ</abbr>
 408          OfferQualifyingCriteriaXref xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 409          boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 409          boolean couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getðŸ”µ</abbr>
 410          //test that the valid fg offer is included
 411          assertTrue(couldApply);
 412  
<abbr title=" 413          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 413          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 414          xref = offers.get(0).getQualifyingItemCriteriaXref().iterator().next();
<abbr title=" 415          couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountableOrderItems().get(0));"> 415          couldApply = fgProcessor.couldOrderItemMeetOfferRequirement(xref.getOfferItemCriteria(), order.getDiscountðŸ”µ</abbr>
 416          //test that the invalid fg offer is excluded
 417          assertFalse(couldApply);
 418  
 419          verify();
 420      }
 421  
 422      public void testCouldOfferApplyToOrderItems() {
 423          replay();
 424  
 425          PromotableOrder order = dataProvider.createBasicPromotableOrder();

 426  
 427          List&lt;PromotableOrderItem&gt; orderItems = new ArrayList&lt;PromotableOrderItem&gt;();
 428          for (PromotableOrderItem orderItem : order.getDiscountableOrderItems()) {
 429              orderItems.add(orderItem);
 430          }
 431  
<abbr title=" 432          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test1\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test2\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 432          List&lt;Offer&gt; offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulðŸ”µ</abbr>
 433          CandidatePromotionItems candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 434          //test that the valid fg offer is included
 435          assertTrue(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 436  
<abbr title=" 437          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGroup.address.postalCode==75244&quot;, OfferDiscountType.PERCENT_OFF, &quot;([MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test5\&quot;), MVEL.eval(\&quot;toUpperCase()\&quot;,\&quot;test6\&quot;)] contains MVEL.eval(\&quot;toUpperCase()\&quot;, discreteOrderItem.category.name))&quot;);"> 437          offers = dataProvider.createFGBasedOfferWithItemCriteria(&quot;order.subTotal.getAmount()&gt;20&quot;, &quot;fulfillmentGrouðŸ”µ</abbr>
 438          candidates = fgProcessor.couldOfferApplyToOrderItems(offers.get(0), orderItems);
 439          //test that the invalid fg offer is excluded because there are no qualifying items
 440          assertFalse(candidates.isMatchedQualifier() &amp;&amp; candidates.getCandidateQualifiersMap().size() == 1);
 441  
 442          verify();
 443      }
 444  
 445      public class CandidateFulfillmentGroupOfferAnswer implements IAnswer&lt;CandidateFulfillmentGroupOffer&gt; {
 446  
 447          @Override
 448          public CandidateFulfillmentGroupOffer answer() throws Throwable {
 449              return new CandidateFulfillmentGroupOfferImpl();
 450          }
 451  
 452      }
 453  
 454      public class FulfillmentGroupAdjustmentAnswer implements IAnswer&lt;FulfillmentGroupAdjustment&gt; {
 455  
 456          @Override
 457          public FulfillmentGroupAdjustment answer() throws Throwable {
 458              return new FulfillmentGroupAdjustmentImpl();
 459          }
 460  
 461      }
 462  
 463      public class CandidateItemOfferAnswer implements IAnswer&lt;CandidateItemOffer&gt; {
 464  
 465          @Override
 466          public CandidateItemOffer answer() throws Throwable {
 467              return new CandidateItemOfferImpl();
 468          }
 469  
 470      }
 471  
 472      public class OrderItemAdjustmentAnswer implements IAnswer&lt;OrderItemAdjustment&gt; {
 473  
 474          @Override
 475          public OrderItemAdjustment answer() throws Throwable {
 476              return new OrderItemAdjustmentImpl();
 477          }
 478  
 479      }
 480  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            