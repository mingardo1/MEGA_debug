<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>192</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    192
                    <a href="191.html">prev</a>
                    <a href="193.html">next</a>
                    <a href="192_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_89e275c67fd74f0edf3ff03711c8c7a4a9610791_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;89e275c67fd74f0edf3ff03711c8c7a4a9610791^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a48cd6ca647e4a58cde4097171bd233ed3e8511d:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/processor/OrderOfferProcessorImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-4156106492343801428" onmouseenter="enter('-4156106492343801428');" onmouseout="out('-4156106492343801428');" style="">  18 package org.broadleafcommerce.core.offer.service.processor;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  22 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  23 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  24 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="5599608658353832247" onmouseenter="enter('5599608658353832247');" onmouseout="out('5599608658353832247');" style="">  25 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;                               </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-556809404433666112" onmouseenter="enter('-556809404433666112');" onmouseout="out('-556809404433666112');" style="">  27 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;                                       </span>
<span class="-521081291127015873" onmouseenter="enter('-521081291127015873');" onmouseout="out('-521081291127015873');" style="">  28 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;                                          </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="2599349157106653381" onmouseenter="enter('2599349157106653381');" onmouseout="out('2599349157106653381');" style="">  30 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;                                   </span>
<span class="212527052176527689" onmouseenter="enter('212527052176527689');" onmouseout="out('212527052176527689');" style="">  31 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;                        </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  32 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="4826353322748911550" onmouseenter="enter('4826353322748911550');" onmouseout="out('4826353322748911550');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;              </span>
<span class="-6049809183476525616" onmouseenter="enter('-6049809183476525616');" onmouseout="out('-6049809183476525616');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="9000862227337796749" onmouseenter="enter('9000862227337796749');" onmouseout="out('9000862227337796749');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;               </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="-5253725521220244448" onmouseenter="enter('-5253725521220244448');" onmouseout="out('-5253725521220244448');" style="">  43 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;                                  </span>
<span class="1925170083501964673" onmouseenter="enter('1925170083501964673');" onmouseout="out('1925170083501964673');" style="">  44 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;                                      </span>
<span class="-7012758821456487335" onmouseenter="enter('-7012758821456487335');" onmouseout="out('-7012758821456487335');" style="">  45 import org.broadleafcommerce.core.order.dao.OrderItemDao;                                                </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  46 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  47 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  48 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  49 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  50 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  51 import org.springframework.stereotype.Service;                                                           </span>
<span  style="">  52                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  53 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  54 import java.util.Collections;                                                                            </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  55 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  56 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  57 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  58 import java.util.Map;                                                                                    </span>
<span  style="">  59                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  60 import javax.annotation.Resource;                                                                        </span>
<span  style="">  61                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  62 /**                                                                                                      </span>
<span class="5097862330762959365" onmouseenter="enter('5097862330762959365');" onmouseout="out('5097862330762959365');" style="">  63  * @author jfischer, bpolster                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  64  */                                                                                                      </span>
<span class="-2245109148562763451" onmouseenter="enter('-2245109148562763451');" onmouseout="out('-2245109148562763451');" style="">  65 @Service(&quot;blOrderOfferProcessor&quot;)                                                                        </span>
<span class="-4961554400286801245" onmouseenter="enter('-4961554400286801245');" onmouseout="out('-4961554400286801245');" style="">  66 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {      </span>
<span  style="">  67                                                                                                          </span>
<span class="-2801860175860773750" onmouseenter="enter('-2801860175860773750');" onmouseout="out('-2801860175860773750');" style="">  68     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);                     </span>
<span  style="">  69                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  70     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  71     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  72                                                                                                          </span>
<span class="-2264776225690683323" onmouseenter="enter('-2264776225690683323');" onmouseout="out('-2264776225690683323');" style="">  73     @Resource(name = &quot;blOrderItemDao&quot;)                                                                   </span>
<span class="1921252040396799605" onmouseenter="enter('1921252040396799605');" onmouseout="out('1921252040396799605');" style="">  74     protected OrderItemDao orderItemDao;                                                                 </span>
<span  style="">  75                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  76     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  77     protected OfferDao offerDao;                                                                         </span>
<span  style="">  78                                                                                                          </span>
<span class="2002571695049097079" onmouseenter="enter('2002571695049097079');" onmouseout="out('2002571695049097079');" style="">  79     @Resource(name = &quot;blOfferServiceUtilities&quot;)                                                          </span>
<span class="-2602045083470320651" onmouseenter="enter('-2602045083470320651');" onmouseout="out('-2602045083470320651');" style="">  80     protected OfferServiceUtilities offerServiceUtilities;                                               </span>
<span  style="">  81                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  82 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-2100856710351800386" onmouseenter="enter('-2100856710351800386');" onmouseout="out('-2100856710351800386');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {                      </span>
<span class="386697006679121838" onmouseenter="enter('386697006679121838');" onmouseout="out('386697006679121838');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         super(promotableOfferUtility);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85     }                                                                                                    </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  86 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88     @Override                                                                                            </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  89     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  90 =======                                                                                                  </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92     protected GenericEntityService entityService;                                                        </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  93 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style="">  94                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  95     @Override                                                                                            </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style=""><abbr title="  96     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  96     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="-6690931251258113559" onmouseenter="enter('-6690931251258113559');" onmouseout="out('-6690931251258113559');" style="">  97         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {           </span>
<span class="2381861258987592021" onmouseenter="enter('2381861258987592021');" onmouseout="out('2381861258987592021');" style=""><abbr title="  98             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  98             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="">  99             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100         }                                                                                                </span>
<span class="-1909487068460560279" onmouseenter="enter('-1909487068460560279');" onmouseout="out('-1909487068460560279');" style=""> 101         boolean orderLevelQualification = false;                                                         </span>
<span class="-826538299394729423" onmouseenter="enter('-826538299394729423');" onmouseout="out('-826538299394729423');" style=""> 102         //Order Qualification                                                                            </span>
<span class="-5521254225981685482" onmouseenter="enter('-5521254225981685482');" onmouseout="out('-5521254225981685482');" style=""> 103         orderQualification:                                                                              </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style=""> 104         {                                                                                                </span>
<span class="-7608560305899310529" onmouseenter="enter('-7608560305899310529');" onmouseout="out('-7608560305899310529');" style=""> 105             if (couldOfferApplyToOrder(offer, promotableOrder)) {                                        </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 106                 orderLevelQualification = true;                                                          </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 107                 break orderQualification;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108             }                                                                                            </span>
<span class="7444608498293955145" onmouseenter="enter('7444608498293955145');" onmouseout="out('7444608498293955145');" style=""><abbr title=" 109             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 109             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr></span>
<span class="5211303022284930113" onmouseenter="enter('5211303022284930113');" onmouseout="out('5211303022284930113');" style=""> 110                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {                         </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 111                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 112                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114             }                                                                                            </span>
<span class="-3473403760382889072" onmouseenter="enter('-3473403760382889072');" onmouseout="out('-3473403760382889072');" style=""> 115             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) { </span>
<span class="7357760135902725095" onmouseenter="enter('7357760135902725095');" onmouseout="out('7357760135902725095');" style=""> 116                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {                  </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 117                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 118                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 119                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121         }                                                                                                </span>
<span class="5034616183006708671" onmouseenter="enter('5034616183006708671');" onmouseout="out('5034616183006708671');" style=""> 122         //Item Qualification - new for 1.5!                                                              </span>
<span class="3708307267894275622" onmouseenter="enter('3708307267894275622');" onmouseout="out('3708307267894275622');" style=""> 123         if (orderLevelQualification) {                                                                   </span>
<span class="4083707686274340956" onmouseenter="enter('4083707686274340956');" onmouseout="out('4083707686274340956');" style=""><abbr title=" 124             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 124             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr></span>
<span class="2629114037035373615" onmouseenter="enter('2629114037035373615');" onmouseout="out('2629114037035373615');" style=""> 125             if (candidates.isMatchedQualifier()) {                                                       </span>
<span class="5830719426865289135" onmouseenter="enter('5830719426865289135');" onmouseout="out('5830719426865289135');" style=""><abbr title=" 126                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 126                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr></span>
<span class="-2643650349584698588" onmouseenter="enter('-2643650349584698588');" onmouseout="out('-2643650349584698588');" style=""><abbr title=" 127                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 127                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130     }                                                                                                    </span>
<span  style=""> 131                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 132     @Override                                                                                            </span>
<span class="-6078198317128464464" onmouseenter="enter('-6078198317128464464');" onmouseout="out('-6078198317128464464');" style=""> 133     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {                </span>
<span class="6994875763592911045" onmouseenter="enter('6994875763592911045');" onmouseout="out('6994875763592911045');" style=""> 134         return couldOfferApplyToOrder(offer, promotableOrder, null, null);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135     }                                                                                                    </span>
<span  style=""> 136                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 137     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 138      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 139      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 140      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 141      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 142      * @param order                                                                                      </span>
<span class="3239114303692248883" onmouseenter="enter('3239114303692248883');" onmouseout="out('3239114303692248883');" style=""> 143      * @param orderItem                                                                                  </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 144      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 145      */                                                                                                  </span>
<span class="-90678225806082002" onmouseenter="enter('-90678225806082002');" onmouseout="out('-90678225806082002');" style=""><abbr title=" 146     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 146     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="-1630600385205451505" onmouseenter="enter('-1630600385205451505');" onmouseout="out('-1630600385205451505');" style=""> 147         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 148     }                                                                                                    </span>
<span  style=""> 149                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 150     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 151      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 152      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 153      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 154      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 155      * @param order                                                                                      </span>
<span class="-7108679256071712026" onmouseenter="enter('-7108679256071712026');" onmouseout="out('-7108679256071712026');" style=""> 156      * @param fulfillmentGroup                                                                           </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 157      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 158      */                                                                                                  </span>
<span class="-667507213825504723" onmouseenter="enter('-667507213825504723');" onmouseout="out('-667507213825504723');" style=""><abbr title=" 159     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 159     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr></span>
<span class="-5817125691165623435" onmouseenter="enter('-5817125691165623435');" onmouseout="out('-5817125691165623435');" style=""> 160         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161     }                                                                                                    </span>
<span  style=""> 162                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 163     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 164      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 165      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 166      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 167      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 168      * @param order                                                                                      </span>
<span class="-4036081007465325177" onmouseenter="enter('-4036081007465325177');" onmouseout="out('-4036081007465325177');" style=""> 169      * @param promotableOrderItem                                                                        </span>
<span class="-8152129500080290565" onmouseenter="enter('-8152129500080290565');" onmouseout="out('-8152129500080290565');" style=""> 170      * @param promotableFulfillmentGroup                                                                 </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 171      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 172      */                                                                                                  </span>
<span class="-3457716414026742708" onmouseenter="enter('-3457716414026742708');" onmouseout="out('-3457716414026742708');" style=""><abbr title=" 173     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 173     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="6012064276783556206" onmouseenter="enter('6012064276783556206');" onmouseout="out('6012064276783556206');" style=""> 174         boolean appliesToItem = false;                                                                   </span>
<span class="2877098389407446108" onmouseenter="enter('2877098389407446108');" onmouseout="out('2877098389407446108');" style=""> 175         String rule = null;                                                                              </span>
<span class="1562125678824942427" onmouseenter="enter('1562125678824942427');" onmouseout="out('1562125678824942427');" style=""> 176         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());</span>
<span class="8836327960017040493" onmouseenter="enter('8836327960017040493');" onmouseout="out('8836327960017040493');" style=""> 177         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {                                     </span>
<span class="-7963530667142055111" onmouseenter="enter('-7963530667142055111');" onmouseout="out('-7963530667142055111');" style=""> 178             rule = orderRule.getOfferRule().getMatchRule();                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179         }                                                                                                </span>
<span  style=""> 180                                                                                                          </span>
<span class="5810732230915198369" onmouseenter="enter('5810732230915198369');" onmouseout="out('5810732230915198369');" style=""> 181         if (rule != null) {                                                                              </span>
<span  style=""> 182                                                                                                          </span>
<span class="8884608966566249698" onmouseenter="enter('8884608966566249698');" onmouseout="out('8884608966566249698');" style=""> 183             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();                                </span>
<span class="1671864453263259632" onmouseenter="enter('1671864453263259632');" onmouseout="out('1671864453263259632');" style=""> 184             promotableOrder.updateRuleVariables(vars);                                                   </span>
<span class="-7784011122993792428" onmouseenter="enter('-7784011122993792428');" onmouseout="out('-7784011122993792428');" style=""> 185             vars.put(&quot;offer&quot;, offer);                                                                    </span>
<span class="8596724536333203596" onmouseenter="enter('8596724536333203596');" onmouseout="out('8596724536333203596');" style=""> 186             if (promotableFulfillmentGroup != null) {                                                    </span>
<span class="4746323176778251021" onmouseenter="enter('4746323176778251021');" onmouseout="out('4746323176778251021');" style=""> 187                 promotableFulfillmentGroup.updateRuleVariables(vars);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188             }                                                                                            </span>
<span class="-4723719306153838221" onmouseenter="enter('-4723719306153838221');" onmouseout="out('-4723719306153838221');" style=""> 189             if (promotableOrderItem != null) {                                                           </span>
<span class="-3080150609740522861" onmouseenter="enter('-3080150609740522861');" onmouseout="out('-3080150609740522861');" style=""> 190                 promotableOrderItem.updateRuleVariables(vars);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191             }                                                                                            </span>
<span class="8856405891316557013" onmouseenter="enter('8856405891316557013');" onmouseout="out('8856405891316557013');" style=""> 192             Boolean expressionOutcome = executeExpression(rule, vars);                                   </span>
<span class="5232502196242835360" onmouseenter="enter('5232502196242835360');" onmouseout="out('5232502196242835360');" style=""> 193             if (expressionOutcome != null &amp;&amp; expressionOutcome) {                                        </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 194                 appliesToItem = true;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195             }                                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 196         } else {                                                                                         </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 197             appliesToItem = true;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198         }                                                                                                </span>
<span  style=""> 199                                                                                                          </span>
<span class="8141379926235681461" onmouseenter="enter('8141379926235681461');" onmouseout="out('8141379926235681461');" style=""> 200         return appliesToItem;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201     }                                                                                                    </span>
<span  style=""> 202                                                                                                          </span>
<span class="7829573362373940985" onmouseenter="enter('7829573362373940985');" onmouseout="out('7829573362373940985');" style=""><abbr title=" 203     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 203     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr></span>
<span class="306330145608771928" onmouseenter="enter('306330145608771928');" onmouseout="out('306330145608771928');" style=""><abbr title=" 204         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 204         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr></span>
<span class="5216830913987868628" onmouseenter="enter('5216830913987868628');" onmouseout="out('5216830913987868628');" style=""> 205         qualifiedOrderOffers.add(promotableCandidateOrderOffer);                                         </span>
<span  style=""> 206                                                                                                          </span>
<span class="8900972580850147104" onmouseenter="enter('8900972580850147104');" onmouseout="out('8900972580850147104');" style=""> 207         return promotableCandidateOrderOffer;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208     }                                                                                                    </span>
<span  style=""> 209                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 210     @Override                                                                                            </span>
<span class="5964334254617273825" onmouseenter="enter('5964334254617273825');" onmouseout="out('5964334254617273825');" style=""><abbr title=" 211     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 211     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr></span>
<span class="3985416668088414845" onmouseenter="enter('3985416668088414845');" onmouseout="out('3985416668088414845');" style=""><abbr title=" 212         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 212         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 213         int offerCount = 0;                                                                              </span>
<span class="6508259141671549344" onmouseenter="enter('6508259141671549344');" onmouseout="out('6508259141671549344');" style=""> 214         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {                           </span>
<span class="8700395077100738449" onmouseenter="enter('8700395077100738449');" onmouseout="out('8700395077100738449');" style=""> 215             if (offerCount == 0) {                                                                       </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 216                 remainingCandidateOffers.add(candidateOffer);                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 217             } else {                                                                                     </span>
<span class="-2676530692785987369" onmouseenter="enter('-2676530692785987369');" onmouseout="out('-2676530692785987369');" style=""> 218                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;                           </span>
<span class="2920776142298371855" onmouseenter="enter('2920776142298371855');" onmouseout="out('2920776142298371855');" style=""> 219                         !candidateOffer.getOffer().isTotalitarianOffer()) {                              </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 220                     remainingCandidateOffers.add(candidateOffer);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222             }                                                                                            </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 223             offerCount++;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224         }                                                                                                </span>
<span class="5367008489542993301" onmouseenter="enter('5367008489542993301');" onmouseout="out('5367008489542993301');" style=""> 225         return remainingCandidateOffers;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226     }                                                                                                    </span>
<span  style=""> 227                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 228     @Override                                                                                            </span>
<span class="8954636300636023369" onmouseenter="enter('8954636300636023369');" onmouseout="out('8954636300636023369');" style=""><abbr title=" 229     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 229     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr></span>
<span class="-7971504164894226146" onmouseenter="enter('-7971504164894226146');" onmouseout="out('-7971504164894226146');" style=""><abbr title=" 230         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 230         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr></span>
<span class="1108112804447486968" onmouseenter="enter('1108112804447486968');" onmouseout="out('1108112804447486968');" style=""> 231         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();             </span>
<span class="3603986812472116533" onmouseenter="enter('3603986812472116533');" onmouseout="out('3603986812472116533');" style=""> 232         while (orderOfferIterator.hasNext()) {                                                           </span>
<span class="-7865108167409889797" onmouseenter="enter('-7865108167409889797');" onmouseout="out('-7865108167409889797');" style=""> 233             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();                        </span>
<span  style=""> 234                                                                                                          </span>
<span class="-919097363910280710" onmouseenter="enter('-919097363910280710');" onmouseout="out('-919097363910280710');" style=""> 235             if (promotableOrder.canApplyOrderOffer(orderOffer)) {                                        </span>
<span class="4017990809944563089" onmouseenter="enter('4017990809944563089');" onmouseout="out('4017990809944563089');" style=""><abbr title=" 236                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 236                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr></span>
<span class="-4210377854282903954" onmouseenter="enter('-4210377854282903954');" onmouseout="out('-4210377854282903954');" style=""> 237                     applyOrderOffer(promotableOrder, orderOffer);                                        </span>
<span  style=""> 238                                                                                                          </span>
<span class="5366287165432255586" onmouseenter="enter('5366287165432255586');" onmouseout="out('5366287165432255586');" style=""><abbr title=" 239                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 239                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr></span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 240                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="3222834402337240688" onmouseenter="enter('3222834402337240688');" onmouseout="out('3222834402337240688');" style=""><abbr title=" 241                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 241                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242                         }                                                                                </span>
<span class="-4644781248556093759" onmouseenter="enter('-4644781248556093759');" onmouseout="out('-4644781248556093759');" style=""> 243                         compareAndAdjustOrderAndItemOffers(promotableOrder);                             </span>
<span class="-8504589987429997467" onmouseenter="enter('-8504589987429997467');" onmouseout="out('-8504589987429997467');" style=""><abbr title=" 244                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 244                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr></span>
<span class="-473363534111382515" onmouseenter="enter('-473363534111382515');" onmouseout="out('-473363534111382515');" style=""><abbr title=" 245                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 245                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr></span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 246                         continue;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247                     }                                                                                    </span>
<span  style=""> 248                                                                                                          </span>
<span class="-155427173834895323" onmouseenter="enter('-155427173834895323');" onmouseout="out('-155427173834895323');" style=""> 249                     if (!orderOffer.isCombinable()) {                                                    </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 250                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="-641512738818000762" onmouseenter="enter('-641512738818000762');" onmouseout="out('-641512738818000762');" style=""><abbr title=" 251                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 251                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252                         }                                                                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 253                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 254                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 255                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 256             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257         }                                                                                                </span>
<span class="1071860375321424059" onmouseenter="enter('1071860375321424059');" onmouseout="out('1071860375321424059');" style=""> 258         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259     }                                                                                                    </span>
<span  style=""> 260                                                                                                          </span>
<span class="1494850857047655937" onmouseenter="enter('1494850857047655937');" onmouseout="out('1494850857047655937');" style=""><abbr title=" 261     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 261     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr></span>
<span class="-2808877570377534999" onmouseenter="enter('-2808877570377534999');" onmouseout="out('-2808877570377534999');" style=""><abbr title=" 262         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 262         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263     }                                                                                                    </span>
<span  style=""> 264                                                                                                          </span>
<span class="-8447973418270990594" onmouseenter="enter('-8447973418270990594');" onmouseout="out('-8447973418270990594');" style=""><abbr title=" 265     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 265     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="8346114644175432666" onmouseenter="enter('8346114644175432666');" onmouseout="out('8346114644175432666');" style=""> 266         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267     }                                                                                                    </span>
<span  style=""> 268                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 269     /**                                                                                                  </span>
<span class="7019315089426478439" onmouseenter="enter('7019315089426478439');" onmouseout="out('7019315089426478439');" style=""> 270      * Called when the system must determine whether to apply order or item adjustments.                 </span>
<span class="-8371223817828724637" onmouseenter="enter('-8371223817828724637');" onmouseout="out('-8371223817828724637');" style=""> 271      * @param promotableOrder                                                                            </span>
<span class="-2490256996948663406" onmouseenter="enter('-2490256996948663406');" onmouseout="out('-2490256996948663406');" style=""> 272      * @param orderOffersApplied                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 273      */                                                                                                  </span>
<span class="7043079218483465061" onmouseenter="enter('7043079218483465061');" onmouseout="out('7043079218483465061');" style=""> 274     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {                 </span>
<span class="-4146438378303178005" onmouseenter="enter('-4146438378303178005');" onmouseout="out('-4146438378303178005');" style=""> 275         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();                    </span>
<span class="7927037930311470382" onmouseenter="enter('7927037930311470382');" onmouseout="out('7927037930311470382');" style=""> 276         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();                      </span>
<span  style=""> 277                                                                                                          </span>
<span class="-1625160164833054598" onmouseenter="enter('-1625160164833054598');" onmouseout="out('-1625160164833054598');" style=""> 278         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {                              </span>
<span class="-7027301438537880380" onmouseenter="enter('-7027301438537880380');" onmouseout="out('-7027301438537880380');" style=""> 279             promotableOrder.removeAllCandidateItemOfferAdjustments();                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 280         } else {                                                                                         </span>
<span class="6517108348190993777" onmouseenter="enter('6517108348190993777');" onmouseout="out('6517108348190993777');" style=""> 281             promotableOrder.removeAllCandidateOrderOfferAdjustments();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 282         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283     }                                                                                                    </span>
<span  style=""> 284                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 285     /**                                                                                                  </span>
<span class="-6223401290020760984" onmouseenter="enter('-6223401290020760984');" onmouseout="out('-6223401290020760984');" style=""> 286      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer</span>
<span class="6836988226136200872" onmouseenter="enter('6836988226136200872');" onmouseout="out('6836988226136200872');" style=""> 287      * and associates the OrderAdjustment to the Order.                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288      *                                                                                                   </span>
<span class="6951516900174217638" onmouseenter="enter('6951516900174217638');" onmouseout="out('6951516900174217638');" style=""> 289      * @param orderOffer a CandidateOrderOffer to apply to an Order                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 290      */                                                                                                  </span>
<span class="-1056565336427362312" onmouseenter="enter('-1056565336427362312');" onmouseout="out('-1056565336427362312');" style=""><abbr title=" 291     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 291     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr></span>
<span class="-3917047491438167754" onmouseenter="enter('-3917047491438167754');" onmouseout="out('-3917047491438167754');" style=""><abbr title=" 292         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 292         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr></span>
<span class="2459651529956168438" onmouseenter="enter('2459651529956168438');" onmouseout="out('2459651529956168438');" style=""> 293         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294     }                                                                                                    </span>
<span  style=""> 295                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 296     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 297     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 298         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 299     }                                                                                                    </span>
<span  style=""> 300                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 301     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 302     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 303         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304     }                                                                                                    </span>
<span  style=""> 305                                                                                                          </span>
<span class="-7694825550100150639" onmouseenter="enter('-7694825550100150639');" onmouseout="out('-7694825550100150639');" style=""><abbr title=" 306     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 306     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr></span>
<span class="-2272462204816182006" onmouseenter="enter('-2272462204816182006');" onmouseout="out('-2272462204816182006');" style=""><abbr title=" 307         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 307         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr></span>
<span class="-7354354578377701904" onmouseenter="enter('-7354354578377701904');" onmouseout="out('-7354354578377701904');" style=""> 308         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {    </span>
<span class="-7366330237630024028" onmouseenter="enter('-7366330237630024028');" onmouseout="out('-7366330237630024028');" style=""> 309             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310         }                                                                                                </span>
<span class="7908136136791584596" onmouseenter="enter('7908136136791584596');" onmouseout="out('7908136136791584596');" style=""> 311         return adjustmentsMap;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312     }                                                                                                    </span>
<span  style=""> 313                                                                                                          </span>
<span class="8556164244366976053" onmouseenter="enter('8556164244366976053');" onmouseout="out('8556164244366976053');" style=""> 314     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {                        </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 315         Order order = promotableOrder.getOrder();                                                        </span>
<span  style=""> 316                                                                                                          </span>
<span class="-6033320157511533636" onmouseenter="enter('-6033320157511533636');" onmouseout="out('-6033320157511533636');" style=""><abbr title=" 317         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 317         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 318             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319         }                                                                                                </span>
<span  style=""> 320                                                                                                          </span>
<span class="-926001645706785786" onmouseenter="enter('-926001645706785786');" onmouseout="out('-926001645706785786');" style=""><abbr title=" 321         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 321         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr></span>
<span class="3944053196731100643" onmouseenter="enter('3944053196731100643');" onmouseout="out('3944053196731100643');" style=""> 322         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();             </span>
<span  style=""> 323                                                                                                          </span>
<span class="6446254784470090633" onmouseenter="enter('6446254784470090633');" onmouseout="out('6446254784470090633');" style=""> 324         while (orderAdjIterator.hasNext()) {                                                             </span>
<span class="8379122835997548797" onmouseenter="enter('8379122835997548797');" onmouseout="out('8379122835997548797');" style=""> 325             OrderAdjustment adjustment = orderAdjIterator.next();                                        </span>
<span class="-4215374844081079628" onmouseenter="enter('-4215374844081079628');" onmouseout="out('-4215374844081079628');" style=""> 326             if (adjustment.getOffer() != null) {                                                         </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 327                 Long offerId = adjustment.getOffer().getId();                                            </span>
<span class="5819609577497737127" onmouseenter="enter('5819609577497737127');" onmouseout="out('5819609577497737127');" style=""> 328                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);      </span>
<span class="6490885699345008591" onmouseenter="enter('6490885699345008591');" onmouseout="out('6490885699345008591');" style=""> 329                 if (promotableAdjustment != null) {                                                      </span>
<span class="8069062196406007718" onmouseenter="enter('8069062196406007718');" onmouseout="out('8069062196406007718');" style=""> 330                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 331                 } else {                                                                                 </span>
<span class="4531906782810290485" onmouseenter="enter('4531906782810290485');" onmouseout="out('4531906782810290485');" style=""> 332                     // No longer using this order adjustment, remove it.                                 </span>
<span class="-8642473006560883902" onmouseenter="enter('-8642473006560883902');" onmouseout="out('-8642473006560883902');" style=""> 333                     orderAdjIterator.remove();                                                           </span>
<span class="808032765038092054" onmouseenter="enter('808032765038092054');" onmouseout="out('808032765038092054');" style=""> 334                     entityService.remove(adjustment);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337         }                                                                                                </span>
<span  style=""> 338                                                                                                          </span>
<span class="9053649251777837824" onmouseenter="enter('9053649251777837824');" onmouseout="out('9053649251777837824');" style=""> 339         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {         </span>
<span class="8948825633726878072" onmouseenter="enter('8948825633726878072');" onmouseout="out('8948825633726878072');" style=""> 340             // Add the newly introduced adjustments.                                                     </span>
<span class="-1742313644800837850" onmouseenter="enter('-1742313644800837850');" onmouseout="out('-1742313644800837850');" style=""> 341             Offer offer = promotableOrderAdjustment.getOffer();                                          </span>
<span class="1325997209783346162" onmouseenter="enter('1325997209783346162');" onmouseout="out('1325997209783346162');" style=""> 342             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();                          </span>
<span class="-6738057894981368691" onmouseenter="enter('-6738057894981368691');" onmouseout="out('-6738057894981368691');" style=""> 343             orderAdjustment.init(order, offer, offer.getName());                                         </span>
<span class="-770736347184914897" onmouseenter="enter('-770736347184914897');" onmouseout="out('-770736347184914897');" style=""> 344             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());                    </span>
<span class="-1853577329694264316" onmouseenter="enter('-1853577329694264316');" onmouseout="out('-1853577329694264316');" style=""> 345             order.getOrderAdjustments().add(orderAdjustment);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 346         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 347     }                                                                                                    </span>
<span  style=""> 348                                                                                                          </span>
<span class="7254378221303205454" onmouseenter="enter('7254378221303205454');" onmouseout="out('7254378221303205454');" style=""><abbr title=" 349     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 349     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 350         Long offerId = adjustment.getOffer().getId();                                                    </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style=""> 351         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {                  </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 352             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="7257069809489192732" onmouseenter="enter('7257069809489192732');" onmouseout="out('7257069809489192732');" style=""> 353                 LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +      </span>
<span class="989054364510106270" onmouseenter="enter('989054364510106270');" onmouseout="out('989054364510106270');" style=""> 354                         promotableAdjustment.getAdjustmentValue());                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355             }                                                                                            </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style=""> 356             adjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357         }                                                                                                </span>
<span class="734930962553645377" onmouseenter="enter('734930962553645377');" onmouseout="out('734930962553645377');" style=""> 358         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {     </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 359             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="1970354127702343135" onmouseenter="enter('1970354127702343135');" onmouseout="out('1970354127702343135');" style=""><abbr title=" 360                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +"> 360                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to ðŸ”µ</abbr></span>
<span class="755598418585359348" onmouseenter="enter('755598418585359348');" onmouseout="out('755598418585359348');" style=""> 361                         promotableAdjustment.isFutureCredit());                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362             }                                                                                            </span>
<span class="-1212224207609501002" onmouseenter="enter('-1212224207609501002');" onmouseout="out('-1212224207609501002');" style=""> 363             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365     }                                                                                                    </span>
<span  style=""> 366                                                                                                          </span>
<span class="4939686944790593089" onmouseenter="enter('4939686944790593089');" onmouseout="out('4939686944790593089');" style=""> 367     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {                              </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 368         Order order = promotableOrder.getOrder();                                                        </span>
<span class="8870411702953196775" onmouseenter="enter('8870411702953196775');" onmouseout="out('8870411702953196775');" style=""><abbr title=" 369         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 369         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr></span>
<span  style=""> 370                                                                                                          </span>
<span class="45393343966675502" onmouseenter="enter('45393343966675502');" onmouseout="out('45393343966675502');" style=""> 371         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);                 </span>
<span  style=""> 372                                                                                                          </span>
<span class="-3971897302215245898" onmouseenter="enter('-3971897302215245898');" onmouseout="out('-3971897302215245898');" style=""> 373         for (OrderItem orderItem : orderItemList) {                                                      </span>
<span class="-3227733123108723187" onmouseenter="enter('-3227733123108723187');" onmouseout="out('-3227733123108723187');" style=""> 374             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);                       </span>
<span class="-7181450714367096357" onmouseenter="enter('-7181450714367096357');" onmouseout="out('-7181450714367096357');" style=""> 375             if (promotableItem == null) {                                                                </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 376                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377             }                                                                                            </span>
<span class="-4627052923559624390" onmouseenter="enter('-4627052923559624390');" onmouseout="out('-4627052923559624390');" style=""> 378             synchronizeItemPriceDetails(orderItem, promotableItem);                                      </span>
<span class="-6035169113045010952" onmouseenter="enter('-6035169113045010952');" onmouseout="out('-6035169113045010952');" style=""> 379             synchronizeItemQualifiers(orderItem, promotableItem);                                        </span>
<span  style=""> 380                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382     }                                                                                                    </span>
<span  style=""> 383                                                                                                          </span>
<span class="4641946456273473515" onmouseenter="enter('4641946456273473515');" onmouseout="out('4641946456273473515');" style=""><abbr title=" 384     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 384     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr></span>
<span class="8574464637260302488" onmouseenter="enter('8574464637260302488');" onmouseout="out('8574464637260302488');" style=""><abbr title=" 385         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 385         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr></span>
<span class="-6342291150701367795" onmouseenter="enter('-6342291150701367795');" onmouseout="out('-6342291150701367795');" style=""> 386         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;(); </span>
<span  style=""> 387                                                                                                          </span>
<span class="-4767625469055938064" onmouseenter="enter('-4767625469055938064');" onmouseout="out('-4767625469055938064');" style=""> 388         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {         </span>
<span class="5353286555635618569" onmouseenter="enter('5353286555635618569');" onmouseout="out('5353286555635618569');" style=""> 389             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);                            </span>
<span class="-2878152675586990901" onmouseenter="enter('-2878152675586990901');" onmouseout="out('-2878152675586990901');" style=""> 390             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);    </span>
<span class="5988062476356282201" onmouseenter="enter('5988062476356282201');" onmouseout="out('5988062476356282201');" style=""> 391             if (promotableDetail != null) {                                                              </span>
<span class="-2745140720553978382" onmouseenter="enter('-2745140720553978382');" onmouseout="out('-2745140720553978382');" style=""> 392                 processMatchingDetails(orderItemPriceDetail, promotableDetail);                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 393             } else {                                                                                     </span>
<span class="-8641070025229307801" onmouseenter="enter('-8641070025229307801');" onmouseout="out('-8641070025229307801');" style=""> 394                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 395             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 396         }                                                                                                </span>
<span  style=""> 397                                                                                                          </span>
<span class="-2102992530504048935" onmouseenter="enter('-2102992530504048935');" onmouseout="out('-2102992530504048935');" style=""><abbr title=" 398         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 398         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr></span>
<span  style=""> 399                                                                                                          </span>
<span class="3655839919190900579" onmouseenter="enter('3655839919190900579');" onmouseout="out('3655839919190900579');" style=""> 400         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {               </span>
<span class="848025138552610797" onmouseenter="enter('848025138552610797');" onmouseout="out('848025138552610797');" style=""> 401             if (unmatchedDetailsIterator.hasNext()) {                                                    </span>
<span class="-1286995204662994700" onmouseenter="enter('-1286995204662994700');" onmouseout="out('-1286995204662994700');" style=""> 402                 // Reuse an existing priceDetail                                                         </span>
<span class="-6274362249453165217" onmouseenter="enter('-6274362249453165217');" onmouseout="out('-6274362249453165217');" style=""> 403                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();                   </span>
<span  style=""> 404                                                                                                          </span>
<span class="8785556757346701489" onmouseenter="enter('8785556757346701489');" onmouseout="out('8785556757346701489');" style=""> 405                 // Reset use Sale flag to true                                                           </span>
<span class="-4586757194387339116" onmouseenter="enter('-4586757194387339116');" onmouseout="out('-4586757194387339116');" style=""> 406                 existingDetail.setUseSalePrice(true);                                                    </span>
<span  style=""> 407                                                                                                          </span>
<span class="7880433973363830475" onmouseenter="enter('7880433973363830475');" onmouseout="out('7880433973363830475');" style=""> 408                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);                    </span>
<span class="9163760465604163202" onmouseenter="enter('9163760465604163202');" onmouseout="out('9163760465604163202');" style=""> 409                 unmatchedDetailsIterator.remove();                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 410             } else {                                                                                     </span>
<span class="-3751890412067657497" onmouseenter="enter('-3751890412067657497');" onmouseout="out('-3751890412067657497');" style=""> 411                 // Create a new priceDetail                                                              </span>
<span class="-1690864448011816688" onmouseenter="enter('-1690864448011816688');" onmouseout="out('-1690864448011816688');" style=""> 412                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();         </span>
<span class="-3940721081423400252" onmouseenter="enter('-3940721081423400252');" onmouseout="out('-3940721081423400252');" style=""> 413                 newPriceDetail.setOrderItem(orderItem);                                                  </span>
<span class="-2358509328501908297" onmouseenter="enter('-2358509328501908297');" onmouseout="out('-2358509328501908297');" style=""> 414                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);                    </span>
<span class="7726531521682039639" onmouseenter="enter('7726531521682039639');" onmouseout="out('7726531521682039639');" style=""> 415                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417         }                                                                                                </span>
<span  style=""> 418                                                                                                          </span>
<span class="5078704746315005492" onmouseenter="enter('5078704746315005492');" onmouseout="out('5078704746315005492');" style=""> 419         // Remove any unmatched details                                                                  </span>
<span class="-596985917041158168" onmouseenter="enter('-596985917041158168');" onmouseout="out('-596985917041158168');" style=""> 420         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();     </span>
<span class="-2348069803911125145" onmouseenter="enter('-2348069803911125145');" onmouseout="out('-2348069803911125145');" style=""> 421         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422     }                                                                                                    </span>
<span  style=""> 423                                                                                                          </span>
<span class="-3359465330409353741" onmouseenter="enter('-3359465330409353741');" onmouseout="out('-3359465330409353741');" style=""><abbr title=" 424     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 424     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr></span>
<span class="6939567773624847901" onmouseenter="enter('6939567773624847901');" onmouseout="out('6939567773624847901');" style=""> 425         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem); </span>
<span class="-838353671554643485" onmouseenter="enter('-838353671554643485');" onmouseout="out('-838353671554643485');" style=""> 426         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();  </span>
<span  style=""> 427                                                                                                          </span>
<span class="6539711029953657105" onmouseenter="enter('6539711029953657105');" onmouseout="out('6539711029953657105');" style=""> 428         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {               </span>
<span class="2428508324486494962" onmouseenter="enter('2428508324486494962');" onmouseout="out('2428508324486494962');" style=""><abbr title=" 429             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 429             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr></span>
<span class="-4549367717464072284" onmouseenter="enter('-4549367717464072284');" onmouseout="out('-4549367717464072284');" style=""> 430             if (promotableQualifier != null) {                                                           </span>
<span class="-5773466494614436024" onmouseenter="enter('-5773466494614436024');" onmouseout="out('-5773466494614436024');" style=""> 431                 // Offer was used as a qualifier on previous run.   Update quantity if needed.           </span>
<span class="-3775165376026668506" onmouseenter="enter('-3775165376026668506');" onmouseout="out('-3775165376026668506');" style=""> 432                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {             </span>
<span class="6319516500536721656" onmouseenter="enter('6319516500536721656');" onmouseout="out('6319516500536721656');" style=""> 433                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 434                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 435             } else {                                                                                     </span>
<span class="-7107745465096608003" onmouseenter="enter('-7107745465096608003');" onmouseout="out('-7107745465096608003');" style=""> 436                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438         }                                                                                                </span>
<span  style=""> 439                                                                                                          </span>
<span class="6412010879861386561" onmouseenter="enter('6412010879861386561');" onmouseout="out('6412010879861386561');" style=""><abbr title=" 440         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 440         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr></span>
<span  style=""> 441                                                                                                          </span>
<span class="-5367673967409602220" onmouseenter="enter('-5367673967409602220');" onmouseout="out('-5367673967409602220');" style=""> 442         for (PromotionQualifier qualifier : qualifiersMap.values()) {                                    </span>
<span class="4352951882445574614" onmouseenter="enter('4352951882445574614');" onmouseout="out('4352951882445574614');" style=""> 443             if (unmatchedQualifiersIterator.hasNext()) {                                                 </span>
<span class="916500832219535438" onmouseenter="enter('916500832219535438');" onmouseout="out('916500832219535438');" style=""> 444                 // Reuse an existing qualifier                                                           </span>
<span class="-457617571898655971" onmouseenter="enter('-457617571898655971');" onmouseout="out('-457617571898655971');" style=""> 445                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();               </span>
<span class="-9191122370911430740" onmouseenter="enter('-9191122370911430740');" onmouseout="out('-9191122370911430740');" style=""> 446                 existingQualifier.setOffer(qualifier.getPromotion());                                    </span>
<span class="-5418424828849751920" onmouseenter="enter('-5418424828849751920');" onmouseout="out('-5418424828849751920');" style=""> 447                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                    </span>
<span class="-2784197009200988946" onmouseenter="enter('-2784197009200988946');" onmouseout="out('-2784197009200988946');" style=""> 448                 unmatchedQualifiersIterator.remove();                                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 449             } else {                                                                                     </span>
<span class="-4600119951921754996" onmouseenter="enter('-4600119951921754996');" onmouseout="out('-4600119951921754996');" style=""> 450                 // Create a new qualifier                                                                </span>
<span class="2495734798245487562" onmouseenter="enter('2495734798245487562');" onmouseout="out('2495734798245487562');" style=""> 451                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();               </span>
<span class="-7776554329531977433" onmouseenter="enter('-7776554329531977433');" onmouseout="out('-7776554329531977433');" style=""> 452                 newQualifier.setOrderItem(orderItem);                                                    </span>
<span class="-7457838790114620282" onmouseenter="enter('-7457838790114620282');" onmouseout="out('-7457838790114620282');" style=""> 453                 newQualifier.setOffer(qualifier.getPromotion());                                         </span>
<span class="35194467054568730" onmouseenter="enter('35194467054568730');" onmouseout="out('35194467054568730');" style=""> 454                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                         </span>
<span class="-7418439022636140038" onmouseenter="enter('-7418439022636140038');" onmouseout="out('-7418439022636140038');" style=""> 455                 orderItem.getOrderItemQualifiers().add(newQualifier);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457         }                                                                                                </span>
<span  style=""> 458                                                                                                          </span>
<span class="5791534705407165022" onmouseenter="enter('5791534705407165022');" onmouseout="out('5791534705407165022');" style=""> 459         // Remove any unmatched qualifiers                                                               </span>
<span class="-8561007497302660099" onmouseenter="enter('-8561007497302660099');" onmouseout="out('-8561007497302660099');" style=""> 460         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();          </span>
<span class="760711543792628805" onmouseenter="enter('760711543792628805');" onmouseout="out('760711543792628805');" style=""> 461         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462     }                                                                                                    </span>
<span  style=""> 463                                                                                                          </span>
<span class="6872064960056917626" onmouseenter="enter('6872064960056917626');" onmouseout="out('6872064960056917626');" style=""> 464     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,                               </span>
<span class="59795375183189524" onmouseenter="enter('59795375183189524');" onmouseout="out('59795375183189524');" style=""> 465             PromotableOrderItemPriceDetail promotableItemDetail) {                                       </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 466         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                    </span>
<span class="7510782226240613992" onmouseenter="enter('7510782226240613992');" onmouseout="out('7510782226240613992');" style=""> 467                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);                          </span>
<span  style=""> 468                                                                                                          </span>
<span class="-750959101585099141" onmouseenter="enter('-750959101585099141');" onmouseout="out('-750959101585099141');" style=""> 469         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {                            </span>
<span class="-3259655613865435165" onmouseenter="enter('-3259655613865435165');" onmouseout="out('-3259655613865435165');" style=""> 470             itemDetail.setQuantity(promotableItemDetail.getQuantity());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471         }                                                                                                </span>
<span  style=""> 472                                                                                                          </span>
<span class="9218754308308575613" onmouseenter="enter('9218754308308575613');" onmouseout="out('9218754308308575613');" style=""><abbr title=" 473         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 473         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr></span>
<span class="2783281510413095088" onmouseenter="enter('2783281510413095088');" onmouseout="out('2783281510413095088');" style=""><abbr title=" 474             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 474             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr></span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 475             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                    </span>
<span class="-4842011616043597197" onmouseenter="enter('-4842011616043597197');" onmouseout="out('-4842011616043597197');" style=""> 476                 itemAdjustment.setValue(adjustment.getAdjustmentValue());                                </span>
<span class="-5695031583799398466" onmouseenter="enter('-5695031583799398466');" onmouseout="out('-5695031583799398466');" style=""> 477                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 480     }                                                                                                    </span>
<span  style=""> 481                                                                                                          </span>
<span class="4651274540478945566" onmouseenter="enter('4651274540478945566');" onmouseout="out('4651274540478945566');" style=""> 482     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {                          </span>
<span class="1883813639191860394" onmouseenter="enter('1883813639191860394');" onmouseout="out('1883813639191860394');" style=""> 483         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();                                                     </span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 484         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 484         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 485             Long offerId = adjustment.getOffer().getId();                                                </span>
<span class="-11608270007353255" onmouseenter="enter('-11608270007353255');" onmouseout="out('-11608270007353255');" style=""> 486             offerIds.add(offerId);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 487         }                                                                                                </span>
<span class="-5651075727196406737" onmouseenter="enter('-5651075727196406737');" onmouseout="out('-5651075727196406737');" style=""> 488         Collections.sort(offerIds);                                                                      </span>
<span class="5891357179043449296" onmouseenter="enter('5891357179043449296');" onmouseout="out('5891357179043449296');" style=""> 489         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();</span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490     }                                                                                                    </span>
<span  style=""> 491                                                                                                          </span>
<span class="-6813037055353877100" onmouseenter="enter('-6813037055353877100');" onmouseout="out('-6813037055353877100');" style=""><abbr title=" 492     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 492     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr></span>
<span class="-5863956661369186771" onmouseenter="enter('-5863956661369186771');" onmouseout="out('-5863956661369186771');" style=""><abbr title=" 493         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 493         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr></span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 494         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4172210863560606018" onmouseenter="enter('-4172210863560606018');" onmouseout="out('-4172210863560606018');" style=""> 495             detailsMap.put(detail.buildDetailKey(), detail);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496         }                                                                                                </span>
<span class="1985757738719514214" onmouseenter="enter('1985757738719514214');" onmouseout="out('1985757738719514214');" style=""> 497         return detailsMap;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 498     }                                                                                                    </span>
<span  style=""> 499                                                                                                          </span>
<span class="-3836724244114507356" onmouseenter="enter('-3836724244114507356');" onmouseout="out('-3836724244114507356');" style=""> 500     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {     </span>
<span class="-1925492436839506759" onmouseenter="enter('-1925492436839506759');" onmouseout="out('-1925492436839506759');" style=""> 501         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();           </span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 502         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4593166378473264356" onmouseenter="enter('-4593166378473264356');" onmouseout="out('-4593166378473264356');" style=""> 503             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {                       </span>
<span class="3842824965672319387" onmouseenter="enter('3842824965672319387');" onmouseout="out('3842824965672319387');" style=""><abbr title=" 504                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 504                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr></span>
<span class="-8569849509682320504" onmouseenter="enter('-8569849509682320504');" onmouseout="out('-8569849509682320504');" style=""> 505                 if (existingQualifier != null) {                                                         </span>
<span class="-4445010116162684270" onmouseenter="enter('-4445010116162684270');" onmouseout="out('-4445010116162684270');" style=""><abbr title=" 506                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 506                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 507                 } else {                                                                                 </span>
<span class="-8046901564682421602" onmouseenter="enter('-8046901564682421602');" onmouseout="out('-8046901564682421602');" style=""> 508                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511         }                                                                                                </span>
<span class="4699150655190374848" onmouseenter="enter('4699150655190374848');" onmouseout="out('4699150655190374848');" style=""> 512         return qualifiersMap;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513     }                                                                                                    </span>
<span  style=""> 514                                                                                                          </span>
<span class="6650489462588239331" onmouseenter="enter('6650489462588239331');" onmouseout="out('6650489462588239331');" style=""> 515     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {                       </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 516         Order order = promotableOrder.getOrder();                                                        </span>
<span class="6561763597022577240" onmouseenter="enter('6561763597022577240');" onmouseout="out('6561763597022577240');" style=""><abbr title=" 517         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 517         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr></span>
<span  style=""> 518                                                                                                          </span>
<span class="6990956658692188299" onmouseenter="enter('6990956658692188299');" onmouseout="out('6990956658692188299');" style=""> 519         boolean syncNeededOnTotal = false;                                                               </span>
<span  style=""> 520                                                                                                          </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 521         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                       </span>
<span class="-439733037564232612" onmouseenter="enter('-439733037564232612');" onmouseout="out('-439733037564232612');" style=""> 522             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));                           </span>
<span class="3630381949999328071" onmouseenter="enter('3630381949999328071');" onmouseout="out('3630381949999328071');" style=""> 523             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);                                   </span>
<span class="6204032096114591207" onmouseenter="enter('6204032096114591207');" onmouseout="out('6204032096114591207');" style=""> 524             if (syncNeeded) {                                                                            </span>
<span class="-6169259820846196761" onmouseenter="enter('-6169259820846196761');" onmouseout="out('-6169259820846196761');" style=""> 525                 syncFulfillmentPrice(fg);                                                                </span>
<span class="-2299678048386624818" onmouseenter="enter('-2299678048386624818');" onmouseout="out('-2299678048386624818');" style=""> 526                 syncNeededOnTotal = true;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 528         }                                                                                                </span>
<span  style=""> 529                                                                                                          </span>
<span class="-5450932785890013448" onmouseenter="enter('-5450932785890013448');" onmouseout="out('-5450932785890013448');" style=""> 530         if (syncNeededOnTotal) {                                                                         </span>
<span class="-8777873539377505153" onmouseenter="enter('-8777873539377505153');" onmouseout="out('-8777873539377505153');" style=""> 531             Money syncFulfillmentPrice = Money.ZERO;                                                     </span>
<span  style=""> 532                                                                                                          </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 533             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-5396558836391507485" onmouseenter="enter('-5396558836391507485');" onmouseout="out('-5396558836391507485');" style=""> 534                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 535             }                                                                                            </span>
<span class="-4866549136483611279" onmouseenter="enter('-4866549136483611279');" onmouseout="out('-4866549136483611279');" style=""> 536             order.setTotalFulfillmentCharges(syncFulfillmentPrice);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538     }                                                                                                    </span>
<span  style=""> 539                                                                                                          </span>
<span class="2663354164110279617" onmouseenter="enter('2663354164110279617');" onmouseout="out('2663354164110279617');" style=""> 540     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {                            </span>
<span class="-1122908714199440396" onmouseenter="enter('-1122908714199440396');" onmouseout="out('-1122908714199440396');" style=""> 541         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 542     }                                                                                                    </span>
<span  style=""> 543                                                                                                          </span>
<span class="-1055395477678850539" onmouseenter="enter('-1055395477678850539');" onmouseout="out('-1055395477678850539');" style=""> 544     protected void syncFulfillmentPrice(FulfillmentGroup fg) {                                           </span>
<span class="6421033897115001406" onmouseenter="enter('6421033897115001406');" onmouseout="out('6421033897115001406');" style=""> 545         Money retailPrice = fg.getRetailFulfillmentPrice();                                              </span>
<span class="2458814602568234661" onmouseenter="enter('2458814602568234661');" onmouseout="out('2458814602568234661');" style=""> 546         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();  </span>
<span class="-5014608312607866780" onmouseenter="enter('-5014608312607866780');" onmouseout="out('-5014608312607866780');" style=""> 547         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);    </span>
<span  style=""> 548                                                                                                          </span>
<span class="723442610052021445" onmouseenter="enter('723442610052021445');" onmouseout="out('723442610052021445');" style=""> 549         fg.setFulfillmentPrice(fulfillmentPrice);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550     }                                                                                                    </span>
<span  style=""> 551                                                                                                          </span>
<span class="-613491293141460653" onmouseenter="enter('-613491293141460653');" onmouseout="out('-613491293141460653');" style=""><abbr title=" 552     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 552     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr></span>
<span class="-2168953774981447317" onmouseenter="enter('-2168953774981447317');" onmouseout="out('-2168953774981447317');" style=""> 553         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();   </span>
<span class="-1134830134613695083" onmouseenter="enter('-1134830134613695083');" onmouseout="out('-1134830134613695083');" style=""> 554         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {                             </span>
<span class="-3822470075223000180" onmouseenter="enter('-3822470075223000180');" onmouseout="out('-3822470075223000180');" style=""> 555             fgMap.put(fg.getFulfillmentGroup().getId(), fg);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 557         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558     }                                                                                                    </span>
<span  style=""> 559                                                                                                          </span>
<span class="6665195593296681168" onmouseenter="enter('6665195593296681168');" onmouseout="out('6665195593296681168');" style=""><abbr title=" 560     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 560     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr></span>
<span class="-7214313390686800174" onmouseenter="enter('-7214313390686800174');" onmouseout="out('-7214313390686800174');" style=""><abbr title=" 561         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 561         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr></span>
<span class="331019091121439684" onmouseenter="enter('331019091121439684');" onmouseout="out('331019091121439684');" style=""><abbr title=" 562         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 562         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr></span>
<span class="1110980486512930755" onmouseenter="enter('1110980486512930755');" onmouseout="out('1110980486512930755');" style=""><abbr title=" 563             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 563             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 564         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 565         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566     }                                                                                                    </span>
<span  style=""> 567                                                                                                          </span>
<span class="-7617178904345879788" onmouseenter="enter('-7617178904345879788');" onmouseout="out('-7617178904345879788');" style=""><abbr title=" 568     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 568     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr></span>
<span class="1705100339866591039" onmouseenter="enter('1705100339866591039');" onmouseout="out('1705100339866591039');" style=""><abbr title=" 569         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 569         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr></span>
<span class="6869467232437188017" onmouseenter="enter('6869467232437188017');" onmouseout="out('6869467232437188017');" style=""><abbr title=" 570         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 570         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr></span>
<span  style=""> 571                                                                                                          </span>
<span class="7622903297016040666" onmouseenter="enter('7622903297016040666');" onmouseout="out('7622903297016040666');" style=""> 572         // First try and update existing adjustment records                                              </span>
<span class="6593219943708493598" onmouseenter="enter('6593219943708493598');" onmouseout="out('6593219943708493598');" style=""> 573         while (adjustmentIterator.hasNext()) {                                                           </span>
<span class="5134089875457655542" onmouseenter="enter('5134089875457655542');" onmouseout="out('5134089875457655542');" style=""> 574             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();                           </span>
<span class="9090174154450682409" onmouseenter="enter('9090174154450682409');" onmouseout="out('9090174154450682409');" style=""><abbr title=" 575             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 575             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr></span>
<span class="7739365516519203047" onmouseenter="enter('7739365516519203047');" onmouseout="out('7739365516519203047');" style=""> 576             if (newAdj != null) {                                                                        </span>
<span class="5102959516436064847" onmouseenter="enter('5102959516436064847');" onmouseout="out('5102959516436064847');" style=""> 577                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {                        </span>
<span class="-6634291412355259187" onmouseenter="enter('-6634291412355259187');" onmouseout="out('-6634291412355259187');" style=""> 578                     // Update the currentAdj.                                                            </span>
<span class="-4755037759892167947" onmouseenter="enter('-4755037759892167947');" onmouseout="out('-4755037759892167947');" style=""> 579                     currentAdj.setValue(newAdj.getAdjustmentValue());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 580                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 581             } else {                                                                                     </span>
<span class="-5437992937664131712" onmouseenter="enter('-5437992937664131712');" onmouseout="out('-5437992937664131712');" style=""> 582                 // Removing no longer valid adjustment                                                   </span>
<span class="-6800144716907845476" onmouseenter="enter('-6800144716907845476');" onmouseout="out('-6800144716907845476');" style=""> 583                 adjustmentIterator.remove();                                                             </span>
<span class="855814523852624000" onmouseenter="enter('855814523852624000');" onmouseout="out('855814523852624000');" style=""> 584                 entityService.remove(currentAdj);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586         }                                                                                                </span>
<span  style=""> 587                                                                                                          </span>
<span class="4911772249630101500" onmouseenter="enter('4911772249630101500');" onmouseout="out('4911772249630101500');" style=""> 588         // Now add missing adjustments                                                                   </span>
<span class="8170167194272017979" onmouseenter="enter('8170167194272017979');" onmouseout="out('8170167194272017979');" style=""> 589         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {                  </span>
<span class="-4188265609244912176" onmouseenter="enter('-4188265609244912176');" onmouseout="out('-4188265609244912176');" style=""> 590             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();                 </span>
<span class="3068706828930127416" onmouseenter="enter('3068706828930127416');" onmouseout="out('3068706828930127416');" style=""> 591             fa.setFulfillmentGroup(fg);                                                                  </span>
<span class="5392928859383582349" onmouseenter="enter('5392928859383582349');" onmouseout="out('5392928859383582349');" style=""> 592             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);          </span>
<span class="4727884307924071496" onmouseenter="enter('4727884307924071496');" onmouseout="out('4727884307924071496');" style=""> 593             fa.setValue(newAdj.getAdjustmentValue());                                                    </span>
<span class="-1586043412444283157" onmouseenter="enter('-1586043412444283157');" onmouseout="out('-1586043412444283157');" style=""> 594             fg.getFulfillmentGroupAdjustments().add(fa);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595         }                                                                                                </span>
<span  style=""> 596                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597     }                                                                                                    </span>
<span  style=""> 598                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 599     @Override                                                                                            </span>
<span class="-4816910989941817274" onmouseenter="enter('-4816910989941817274');" onmouseout="out('-4816910989941817274');" style=""> 600     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {                       </span>
<span class="-3850751249412137645" onmouseenter="enter('-3850751249412137645');" onmouseout="out('-3850751249412137645');" style=""> 601         synchronizeOrderAdjustments(promotableOrder);                                                    </span>
<span class="4518036952510487894" onmouseenter="enter('4518036952510487894');" onmouseout="out('4518036952510487894');" style=""> 602         synchronizeOrderItems(promotableOrder);                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 603         if (extensionManager != null) {                                                                  </span>
<span class="-6179159556176464024" onmouseenter="enter('-6179159556176464024');" onmouseout="out('-6179159556176464024');" style=""> 604             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605         }                                                                                                </span>
<span class="-159866277563841870" onmouseenter="enter('-159866277563841870');" onmouseout="out('-159866277563841870');" style=""> 606         synchronizeFulfillmentGroups(promotableOrder);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 607     }                                                                                                    </span>
<span  style=""> 608                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 609     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 610     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 611         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612     }                                                                                                    </span>
<span  style=""> 613                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 614     @Override                                                                                            </span>
<span class="6530687858988053885" onmouseenter="enter('6530687858988053885');" onmouseout="out('6530687858988053885');" style=""> 615     public void setOrderItemDao(OrderItemDao orderItemDao) {                                             </span>
<span class="-8374754321118159364" onmouseenter="enter('-8374754321118159364');" onmouseout="out('-8374754321118159364');" style=""> 616         this.orderItemDao = orderItemDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 617     }                                                                                                    </span>
<span  style=""> 618                                                                                                          </span>
<span class="-6632247919309783023" onmouseenter="enter('-6632247919309783023');" onmouseout="out('-6632247919309783023');" style=""> 619     public OfferServiceUtilities getOfferServiceUtilities() {                                            </span>
<span class="-6406517936839827979" onmouseenter="enter('-6406517936839827979');" onmouseout="out('-6406517936839827979');" style=""> 620         return offerServiceUtilities;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 621     }                                                                                                    </span>
<span  style=""> 622                                                                                                          </span>
<span class="4442139862126007445" onmouseenter="enter('4442139862126007445');" onmouseout="out('4442139862126007445');" style=""> 623     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {                  </span>
<span class="4552134412879762115" onmouseenter="enter('4552134412879762115');" onmouseout="out('4552134412879762115');" style=""> 624         this.offerServiceUtilities = offerServiceUtilities;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 626 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-4156106492343801428" onmouseenter="enter('-4156106492343801428');" onmouseout="out('-4156106492343801428');" style="">  18 package org.broadleafcommerce.core.offer.service.processor;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  22 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  23 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  24 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="5599608658353832247" onmouseenter="enter('5599608658353832247');" onmouseout="out('5599608658353832247');" style="">  25 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;                               </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-556809404433666112" onmouseenter="enter('-556809404433666112');" onmouseout="out('-556809404433666112');" style="">  27 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;                                       </span>
<span class="-521081291127015873" onmouseenter="enter('-521081291127015873');" onmouseout="out('-521081291127015873');" style="">  28 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;                                          </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  29 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="2599349157106653381" onmouseenter="enter('2599349157106653381');" onmouseout="out('2599349157106653381');" style="">  30 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;                                   </span>
<span class="212527052176527689" onmouseenter="enter('212527052176527689');" onmouseout="out('212527052176527689');" style="">  31 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;                        </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  32 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="4826353322748911550" onmouseenter="enter('4826353322748911550');" onmouseout="out('4826353322748911550');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;              </span>
<span class="-6049809183476525616" onmouseenter="enter('-6049809183476525616');" onmouseout="out('-6049809183476525616');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="9000862227337796749" onmouseenter="enter('9000862227337796749');" onmouseout="out('9000862227337796749');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;               </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="-5253725521220244448" onmouseenter="enter('-5253725521220244448');" onmouseout="out('-5253725521220244448');" style="">  43 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;                                  </span>
<span class="1925170083501964673" onmouseenter="enter('1925170083501964673');" onmouseout="out('1925170083501964673');" style="">  44 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;                                      </span>
<span class="-7012758821456487335" onmouseenter="enter('-7012758821456487335');" onmouseout="out('-7012758821456487335');" style="">  45 import org.broadleafcommerce.core.order.dao.OrderItemDao;                                                </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  46 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  47 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  48 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  49 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  50 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  51 import org.springframework.stereotype.Service;                                                           </span>
<span  style="">  52                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  53 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  54 import java.util.Collections;                                                                            </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  55 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  56 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  57 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  58 import java.util.Map;                                                                                    </span>
<span  style="">  59                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  60 import javax.annotation.Resource;                                                                        </span>
<span  style="">  61                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  62 /**                                                                                                      </span>
<span class="5097862330762959365" onmouseenter="enter('5097862330762959365');" onmouseout="out('5097862330762959365');" style="">  63  * @author jfischer, bpolster                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  64  */                                                                                                      </span>
<span class="-2245109148562763451" onmouseenter="enter('-2245109148562763451');" onmouseout="out('-2245109148562763451');" style="">  65 @Service(&quot;blOrderOfferProcessor&quot;)                                                                        </span>
<span class="-4961554400286801245" onmouseenter="enter('-4961554400286801245');" onmouseout="out('-4961554400286801245');" style="">  66 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {      </span>
<span  style="">  67                                                                                                          </span>
<span class="-2801860175860773750" onmouseenter="enter('-2801860175860773750');" onmouseout="out('-2801860175860773750');" style="">  68     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);                     </span>
<span  style="">  69                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  70     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  71     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  72                                                                                                          </span>
<span class="-2264776225690683323" onmouseenter="enter('-2264776225690683323');" onmouseout="out('-2264776225690683323');" style="">  73     @Resource(name = &quot;blOrderItemDao&quot;)                                                                   </span>
<span class="1921252040396799605" onmouseenter="enter('1921252040396799605');" onmouseout="out('1921252040396799605');" style="">  74     protected OrderItemDao orderItemDao;                                                                 </span>
<span  style="">  75                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  76     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  77     protected OfferDao offerDao;                                                                         </span>
<span  style="">  78                                                                                                          </span>
<span class="2002571695049097079" onmouseenter="enter('2002571695049097079');" onmouseout="out('2002571695049097079');" style="">  79     @Resource(name = &quot;blOfferServiceUtilities&quot;)                                                          </span>
<span class="-2602045083470320651" onmouseenter="enter('-2602045083470320651');" onmouseout="out('-2602045083470320651');" style="">  80     protected OfferServiceUtilities offerServiceUtilities;                                               </span>
<span  style="">  81                                                                                                          </span>
<span class="-2100856710351800386" onmouseenter="enter('-2100856710351800386');" onmouseout="out('-2100856710351800386');" style="">  82     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {                      </span>
<span class="386697006679121838" onmouseenter="enter('386697006679121838');" onmouseout="out('386697006679121838');" style="">  83         super(promotableOfferUtility);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  84     }                                                                                                    </span>
<span  style="">  85                                                                                                          </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="">  86     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="">  87     protected GenericEntityService entityService;                                                        </span>
<span  style="">  88                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  89     @Override                                                                                            </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style=""><abbr title="  90     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  90     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="-6690931251258113559" onmouseenter="enter('-6690931251258113559');" onmouseout="out('-6690931251258113559');" style="">  91         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {           </span>
<span class="2381861258987592021" onmouseenter="enter('2381861258987592021');" onmouseout="out('2381861258987592021');" style=""><abbr title="  92             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  92             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="">  93             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94         }                                                                                                </span>
<span class="-1909487068460560279" onmouseenter="enter('-1909487068460560279');" onmouseout="out('-1909487068460560279');" style="">  95         boolean orderLevelQualification = false;                                                         </span>
<span class="-826538299394729423" onmouseenter="enter('-826538299394729423');" onmouseout="out('-826538299394729423');" style="">  96         //Order Qualification                                                                            </span>
<span class="-5521254225981685482" onmouseenter="enter('-5521254225981685482');" onmouseout="out('-5521254225981685482');" style="">  97         orderQualification:                                                                              </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="">  98         {                                                                                                </span>
<span class="-7608560305899310529" onmouseenter="enter('-7608560305899310529');" onmouseout="out('-7608560305899310529');" style="">  99             if (couldOfferApplyToOrder(offer, promotableOrder)) {                                        </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 100                 orderLevelQualification = true;                                                          </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 101                 break orderQualification;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 102             }                                                                                            </span>
<span class="7444608498293955145" onmouseenter="enter('7444608498293955145');" onmouseout="out('7444608498293955145');" style=""><abbr title=" 103             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 103             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr></span>
<span class="5211303022284930113" onmouseenter="enter('5211303022284930113');" onmouseout="out('5211303022284930113');" style=""> 104                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {                         </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 105                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 106                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108             }                                                                                            </span>
<span class="-3473403760382889072" onmouseenter="enter('-3473403760382889072');" onmouseout="out('-3473403760382889072');" style=""> 109             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) { </span>
<span class="7357760135902725095" onmouseenter="enter('7357760135902725095');" onmouseout="out('7357760135902725095');" style=""> 110                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {                  </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 111                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 112                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115         }                                                                                                </span>
<span class="5034616183006708671" onmouseenter="enter('5034616183006708671');" onmouseout="out('5034616183006708671');" style=""> 116         //Item Qualification - new for 1.5!                                                              </span>
<span class="3708307267894275622" onmouseenter="enter('3708307267894275622');" onmouseout="out('3708307267894275622');" style=""> 117         if (orderLevelQualification) {                                                                   </span>
<span class="4083707686274340956" onmouseenter="enter('4083707686274340956');" onmouseout="out('4083707686274340956');" style=""><abbr title=" 118             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 118             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr></span>
<span class="2629114037035373615" onmouseenter="enter('2629114037035373615');" onmouseout="out('2629114037035373615');" style=""> 119             if (candidates.isMatchedQualifier()) {                                                       </span>
<span class="5830719426865289135" onmouseenter="enter('5830719426865289135');" onmouseout="out('5830719426865289135');" style=""><abbr title=" 120                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 120                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr></span>
<span class="-2643650349584698588" onmouseenter="enter('-2643650349584698588');" onmouseout="out('-2643650349584698588');" style=""><abbr title=" 121                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 121                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124     }                                                                                                    </span>
<span  style=""> 125                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 126     @Override                                                                                            </span>
<span class="-6078198317128464464" onmouseenter="enter('-6078198317128464464');" onmouseout="out('-6078198317128464464');" style=""> 127     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {                </span>
<span class="6994875763592911045" onmouseenter="enter('6994875763592911045');" onmouseout="out('6994875763592911045');" style=""> 128         return couldOfferApplyToOrder(offer, promotableOrder, null, null);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 131     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 132      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 133      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 134      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 135      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 136      * @param order                                                                                      </span>
<span class="3239114303692248883" onmouseenter="enter('3239114303692248883');" onmouseout="out('3239114303692248883');" style=""> 137      * @param orderItem                                                                                  </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 138      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 139      */                                                                                                  </span>
<span class="-90678225806082002" onmouseenter="enter('-90678225806082002');" onmouseout="out('-90678225806082002');" style=""><abbr title=" 140     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 140     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="-1630600385205451505" onmouseenter="enter('-1630600385205451505');" onmouseout="out('-1630600385205451505');" style=""> 141         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142     }                                                                                                    </span>
<span  style=""> 143                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 144     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 145      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 146      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 147      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 148      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 149      * @param order                                                                                      </span>
<span class="-7108679256071712026" onmouseenter="enter('-7108679256071712026');" onmouseout="out('-7108679256071712026');" style=""> 150      * @param fulfillmentGroup                                                                           </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 151      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 152      */                                                                                                  </span>
<span class="-667507213825504723" onmouseenter="enter('-667507213825504723');" onmouseout="out('-667507213825504723');" style=""><abbr title=" 153     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 153     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr></span>
<span class="-5817125691165623435" onmouseenter="enter('-5817125691165623435');" onmouseout="out('-5817125691165623435');" style=""> 154         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155     }                                                                                                    </span>
<span  style=""> 156                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 157     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 158      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 159      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 160      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 161      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 162      * @param order                                                                                      </span>
<span class="-4036081007465325177" onmouseenter="enter('-4036081007465325177');" onmouseout="out('-4036081007465325177');" style=""> 163      * @param promotableOrderItem                                                                        </span>
<span class="-8152129500080290565" onmouseenter="enter('-8152129500080290565');" onmouseout="out('-8152129500080290565');" style=""> 164      * @param promotableFulfillmentGroup                                                                 </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 165      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 166      */                                                                                                  </span>
<span class="-3457716414026742708" onmouseenter="enter('-3457716414026742708');" onmouseout="out('-3457716414026742708');" style=""><abbr title=" 167     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 167     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="6012064276783556206" onmouseenter="enter('6012064276783556206');" onmouseout="out('6012064276783556206');" style=""> 168         boolean appliesToItem = false;                                                                   </span>
<span class="2877098389407446108" onmouseenter="enter('2877098389407446108');" onmouseout="out('2877098389407446108');" style=""> 169         String rule = null;                                                                              </span>
<span class="1562125678824942427" onmouseenter="enter('1562125678824942427');" onmouseout="out('1562125678824942427');" style=""> 170         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());</span>
<span class="8836327960017040493" onmouseenter="enter('8836327960017040493');" onmouseout="out('8836327960017040493');" style=""> 171         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {                                     </span>
<span class="-7963530667142055111" onmouseenter="enter('-7963530667142055111');" onmouseout="out('-7963530667142055111');" style=""> 172             rule = orderRule.getOfferRule().getMatchRule();                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173         }                                                                                                </span>
<span  style=""> 174                                                                                                          </span>
<span class="5810732230915198369" onmouseenter="enter('5810732230915198369');" onmouseout="out('5810732230915198369');" style=""> 175         if (rule != null) {                                                                              </span>
<span  style=""> 176                                                                                                          </span>
<span class="8884608966566249698" onmouseenter="enter('8884608966566249698');" onmouseout="out('8884608966566249698');" style=""> 177             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();                                </span>
<span class="1671864453263259632" onmouseenter="enter('1671864453263259632');" onmouseout="out('1671864453263259632');" style=""> 178             promotableOrder.updateRuleVariables(vars);                                                   </span>
<span class="-7784011122993792428" onmouseenter="enter('-7784011122993792428');" onmouseout="out('-7784011122993792428');" style=""> 179             vars.put(&quot;offer&quot;, offer);                                                                    </span>
<span class="8596724536333203596" onmouseenter="enter('8596724536333203596');" onmouseout="out('8596724536333203596');" style=""> 180             if (promotableFulfillmentGroup != null) {                                                    </span>
<span class="4746323176778251021" onmouseenter="enter('4746323176778251021');" onmouseout="out('4746323176778251021');" style=""> 181                 promotableFulfillmentGroup.updateRuleVariables(vars);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182             }                                                                                            </span>
<span class="-4723719306153838221" onmouseenter="enter('-4723719306153838221');" onmouseout="out('-4723719306153838221');" style=""> 183             if (promotableOrderItem != null) {                                                           </span>
<span class="-3080150609740522861" onmouseenter="enter('-3080150609740522861');" onmouseout="out('-3080150609740522861');" style=""> 184                 promotableOrderItem.updateRuleVariables(vars);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185             }                                                                                            </span>
<span class="8856405891316557013" onmouseenter="enter('8856405891316557013');" onmouseout="out('8856405891316557013');" style=""> 186             Boolean expressionOutcome = executeExpression(rule, vars);                                   </span>
<span class="5232502196242835360" onmouseenter="enter('5232502196242835360');" onmouseout="out('5232502196242835360');" style=""> 187             if (expressionOutcome != null &amp;&amp; expressionOutcome) {                                        </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 188                 appliesToItem = true;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189             }                                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 190         } else {                                                                                         </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 191             appliesToItem = true;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192         }                                                                                                </span>
<span  style=""> 193                                                                                                          </span>
<span class="8141379926235681461" onmouseenter="enter('8141379926235681461');" onmouseout="out('8141379926235681461');" style=""> 194         return appliesToItem;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195     }                                                                                                    </span>
<span  style=""> 196                                                                                                          </span>
<span class="7829573362373940985" onmouseenter="enter('7829573362373940985');" onmouseout="out('7829573362373940985');" style=""><abbr title=" 197     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 197     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr></span>
<span class="306330145608771928" onmouseenter="enter('306330145608771928');" onmouseout="out('306330145608771928');" style=""><abbr title=" 198         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 198         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr></span>
<span class="5216830913987868628" onmouseenter="enter('5216830913987868628');" onmouseout="out('5216830913987868628');" style=""> 199         qualifiedOrderOffers.add(promotableCandidateOrderOffer);                                         </span>
<span  style=""> 200                                                                                                          </span>
<span class="8900972580850147104" onmouseenter="enter('8900972580850147104');" onmouseout="out('8900972580850147104');" style=""> 201         return promotableCandidateOrderOffer;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202     }                                                                                                    </span>
<span  style=""> 203                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 204     @Override                                                                                            </span>
<span class="5964334254617273825" onmouseenter="enter('5964334254617273825');" onmouseout="out('5964334254617273825');" style=""><abbr title=" 205     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 205     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr></span>
<span class="3985416668088414845" onmouseenter="enter('3985416668088414845');" onmouseout="out('3985416668088414845');" style=""><abbr title=" 206         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 206         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 207         int offerCount = 0;                                                                              </span>
<span class="6508259141671549344" onmouseenter="enter('6508259141671549344');" onmouseout="out('6508259141671549344');" style=""> 208         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {                           </span>
<span class="8700395077100738449" onmouseenter="enter('8700395077100738449');" onmouseout="out('8700395077100738449');" style=""> 209             if (offerCount == 0) {                                                                       </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 210                 remainingCandidateOffers.add(candidateOffer);                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 211             } else {                                                                                     </span>
<span class="-2676530692785987369" onmouseenter="enter('-2676530692785987369');" onmouseout="out('-2676530692785987369');" style=""> 212                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;                           </span>
<span class="2920776142298371855" onmouseenter="enter('2920776142298371855');" onmouseout="out('2920776142298371855');" style=""> 213                         !candidateOffer.getOffer().isTotalitarianOffer()) {                              </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 214                     remainingCandidateOffers.add(candidateOffer);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216             }                                                                                            </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 217             offerCount++;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218         }                                                                                                </span>
<span class="5367008489542993301" onmouseenter="enter('5367008489542993301');" onmouseout="out('5367008489542993301');" style=""> 219         return remainingCandidateOffers;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220     }                                                                                                    </span>
<span  style=""> 221                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 222     @Override                                                                                            </span>
<span class="8954636300636023369" onmouseenter="enter('8954636300636023369');" onmouseout="out('8954636300636023369');" style=""><abbr title=" 223     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 223     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr></span>
<span class="-7971504164894226146" onmouseenter="enter('-7971504164894226146');" onmouseout="out('-7971504164894226146');" style=""><abbr title=" 224         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 224         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr></span>
<span class="1108112804447486968" onmouseenter="enter('1108112804447486968');" onmouseout="out('1108112804447486968');" style=""> 225         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();             </span>
<span class="3603986812472116533" onmouseenter="enter('3603986812472116533');" onmouseout="out('3603986812472116533');" style=""> 226         while (orderOfferIterator.hasNext()) {                                                           </span>
<span class="-7865108167409889797" onmouseenter="enter('-7865108167409889797');" onmouseout="out('-7865108167409889797');" style=""> 227             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();                        </span>
<span  style=""> 228                                                                                                          </span>
<span class="-919097363910280710" onmouseenter="enter('-919097363910280710');" onmouseout="out('-919097363910280710');" style=""> 229             if (promotableOrder.canApplyOrderOffer(orderOffer)) {                                        </span>
<span class="4017990809944563089" onmouseenter="enter('4017990809944563089');" onmouseout="out('4017990809944563089');" style=""><abbr title=" 230                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 230                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr></span>
<span class="-4210377854282903954" onmouseenter="enter('-4210377854282903954');" onmouseout="out('-4210377854282903954');" style=""> 231                     applyOrderOffer(promotableOrder, orderOffer);                                        </span>
<span  style=""> 232                                                                                                          </span>
<span class="5366287165432255586" onmouseenter="enter('5366287165432255586');" onmouseout="out('5366287165432255586');" style=""><abbr title=" 233                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 233                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr></span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 234                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="3222834402337240688" onmouseenter="enter('3222834402337240688');" onmouseout="out('3222834402337240688');" style=""><abbr title=" 235                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 235                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236                         }                                                                                </span>
<span class="-4644781248556093759" onmouseenter="enter('-4644781248556093759');" onmouseout="out('-4644781248556093759');" style=""> 237                         compareAndAdjustOrderAndItemOffers(promotableOrder);                             </span>
<span class="-8504589987429997467" onmouseenter="enter('-8504589987429997467');" onmouseout="out('-8504589987429997467');" style=""><abbr title=" 238                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 238                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr></span>
<span class="-473363534111382515" onmouseenter="enter('-473363534111382515');" onmouseout="out('-473363534111382515');" style=""><abbr title=" 239                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 239                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr></span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 240                         continue;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241                     }                                                                                    </span>
<span  style=""> 242                                                                                                          </span>
<span class="-155427173834895323" onmouseenter="enter('-155427173834895323');" onmouseout="out('-155427173834895323');" style=""> 243                     if (!orderOffer.isCombinable()) {                                                    </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 244                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="-641512738818000762" onmouseenter="enter('-641512738818000762');" onmouseout="out('-641512738818000762');" style=""><abbr title=" 245                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 245                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246                         }                                                                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 247                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251         }                                                                                                </span>
<span class="1071860375321424059" onmouseenter="enter('1071860375321424059');" onmouseout="out('1071860375321424059');" style=""> 252         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="1494850857047655937" onmouseenter="enter('1494850857047655937');" onmouseout="out('1494850857047655937');" style=""><abbr title=" 255     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 255     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr></span>
<span class="-2808877570377534999" onmouseenter="enter('-2808877570377534999');" onmouseout="out('-2808877570377534999');" style=""><abbr title=" 256         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 256         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257     }                                                                                                    </span>
<span  style=""> 258                                                                                                          </span>
<span class="-8447973418270990594" onmouseenter="enter('-8447973418270990594');" onmouseout="out('-8447973418270990594');" style=""><abbr title=" 259     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 259     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="8346114644175432666" onmouseenter="enter('8346114644175432666');" onmouseout="out('8346114644175432666');" style=""> 260         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261     }                                                                                                    </span>
<span  style=""> 262                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 263     /**                                                                                                  </span>
<span class="7019315089426478439" onmouseenter="enter('7019315089426478439');" onmouseout="out('7019315089426478439');" style=""> 264      * Called when the system must determine whether to apply order or item adjustments.                 </span>
<span class="-8371223817828724637" onmouseenter="enter('-8371223817828724637');" onmouseout="out('-8371223817828724637');" style=""> 265      * @param promotableOrder                                                                            </span>
<span class="-2490256996948663406" onmouseenter="enter('-2490256996948663406');" onmouseout="out('-2490256996948663406');" style=""> 266      * @param orderOffersApplied                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 267      */                                                                                                  </span>
<span class="7043079218483465061" onmouseenter="enter('7043079218483465061');" onmouseout="out('7043079218483465061');" style=""> 268     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {                 </span>
<span class="-4146438378303178005" onmouseenter="enter('-4146438378303178005');" onmouseout="out('-4146438378303178005');" style=""> 269         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();                    </span>
<span class="7927037930311470382" onmouseenter="enter('7927037930311470382');" onmouseout="out('7927037930311470382');" style=""> 270         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();                      </span>
<span  style=""> 271                                                                                                          </span>
<span class="-1625160164833054598" onmouseenter="enter('-1625160164833054598');" onmouseout="out('-1625160164833054598');" style=""> 272         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {                              </span>
<span class="-7027301438537880380" onmouseenter="enter('-7027301438537880380');" onmouseout="out('-7027301438537880380');" style=""> 273             promotableOrder.removeAllCandidateItemOfferAdjustments();                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 274         } else {                                                                                         </span>
<span class="6517108348190993777" onmouseenter="enter('6517108348190993777');" onmouseout="out('6517108348190993777');" style=""> 275             promotableOrder.removeAllCandidateOrderOfferAdjustments();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277     }                                                                                                    </span>
<span  style=""> 278                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 279     /**                                                                                                  </span>
<span class="-6223401290020760984" onmouseenter="enter('-6223401290020760984');" onmouseout="out('-6223401290020760984');" style=""> 280      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer</span>
<span class="6836988226136200872" onmouseenter="enter('6836988226136200872');" onmouseout="out('6836988226136200872');" style=""> 281      * and associates the OrderAdjustment to the Order.                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 282      *                                                                                                   </span>
<span class="6951516900174217638" onmouseenter="enter('6951516900174217638');" onmouseout="out('6951516900174217638');" style=""> 283      * @param orderOffer a CandidateOrderOffer to apply to an Order                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 284      */                                                                                                  </span>
<span class="-1056565336427362312" onmouseenter="enter('-1056565336427362312');" onmouseout="out('-1056565336427362312');" style=""><abbr title=" 285     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 285     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr></span>
<span class="-3917047491438167754" onmouseenter="enter('-3917047491438167754');" onmouseout="out('-3917047491438167754');" style=""><abbr title=" 286         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 286         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr></span>
<span class="2459651529956168438" onmouseenter="enter('2459651529956168438');" onmouseout="out('2459651529956168438');" style=""> 287         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288     }                                                                                                    </span>
<span  style=""> 289                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 290     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 291     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 292         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 293     }                                                                                                    </span>
<span  style=""> 294                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 295     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 296     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 297         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298     }                                                                                                    </span>
<span  style=""> 299                                                                                                          </span>
<span class="-7694825550100150639" onmouseenter="enter('-7694825550100150639');" onmouseout="out('-7694825550100150639');" style=""><abbr title=" 300     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 300     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr></span>
<span class="-2272462204816182006" onmouseenter="enter('-2272462204816182006');" onmouseout="out('-2272462204816182006');" style=""><abbr title=" 301         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 301         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr></span>
<span class="-7354354578377701904" onmouseenter="enter('-7354354578377701904');" onmouseout="out('-7354354578377701904');" style=""> 302         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {    </span>
<span class="-7366330237630024028" onmouseenter="enter('-7366330237630024028');" onmouseout="out('-7366330237630024028');" style=""> 303             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304         }                                                                                                </span>
<span class="7908136136791584596" onmouseenter="enter('7908136136791584596');" onmouseout="out('7908136136791584596');" style=""> 305         return adjustmentsMap;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 306     }                                                                                                    </span>
<span  style=""> 307                                                                                                          </span>
<span class="8556164244366976053" onmouseenter="enter('8556164244366976053');" onmouseout="out('8556164244366976053');" style=""> 308     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {                        </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 309         Order order = promotableOrder.getOrder();                                                        </span>
<span  style=""> 310                                                                                                          </span>
<span class="-6033320157511533636" onmouseenter="enter('-6033320157511533636');" onmouseout="out('-6033320157511533636');" style=""><abbr title=" 311         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 311         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 312             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313         }                                                                                                </span>
<span  style=""> 314                                                                                                          </span>
<span class="-926001645706785786" onmouseenter="enter('-926001645706785786');" onmouseout="out('-926001645706785786');" style=""><abbr title=" 315         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 315         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr></span>
<span class="3944053196731100643" onmouseenter="enter('3944053196731100643');" onmouseout="out('3944053196731100643');" style=""> 316         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();             </span>
<span  style=""> 317                                                                                                          </span>
<span class="6446254784470090633" onmouseenter="enter('6446254784470090633');" onmouseout="out('6446254784470090633');" style=""> 318         while (orderAdjIterator.hasNext()) {                                                             </span>
<span class="8379122835997548797" onmouseenter="enter('8379122835997548797');" onmouseout="out('8379122835997548797');" style=""> 319             OrderAdjustment adjustment = orderAdjIterator.next();                                        </span>
<span class="-4215374844081079628" onmouseenter="enter('-4215374844081079628');" onmouseout="out('-4215374844081079628');" style=""> 320             if (adjustment.getOffer() != null) {                                                         </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 321                 Long offerId = adjustment.getOffer().getId();                                            </span>
<span class="5819609577497737127" onmouseenter="enter('5819609577497737127');" onmouseout="out('5819609577497737127');" style=""> 322                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);      </span>
<span class="6490885699345008591" onmouseenter="enter('6490885699345008591');" onmouseout="out('6490885699345008591');" style=""> 323                 if (promotableAdjustment != null) {                                                      </span>
<span class="8069062196406007718" onmouseenter="enter('8069062196406007718');" onmouseout="out('8069062196406007718');" style=""> 324                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 325                 } else {                                                                                 </span>
<span class="4531906782810290485" onmouseenter="enter('4531906782810290485');" onmouseout="out('4531906782810290485');" style=""> 326                     // No longer using this order adjustment, remove it.                                 </span>
<span class="-8642473006560883902" onmouseenter="enter('-8642473006560883902');" onmouseout="out('-8642473006560883902');" style=""> 327                     orderAdjIterator.remove();                                                           </span>
<span class="808032765038092054" onmouseenter="enter('808032765038092054');" onmouseout="out('808032765038092054');" style=""> 328                     entityService.remove(adjustment);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 329                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 330             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331         }                                                                                                </span>
<span  style=""> 332                                                                                                          </span>
<span class="9053649251777837824" onmouseenter="enter('9053649251777837824');" onmouseout="out('9053649251777837824');" style=""> 333         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {         </span>
<span class="8948825633726878072" onmouseenter="enter('8948825633726878072');" onmouseout="out('8948825633726878072');" style=""> 334             // Add the newly introduced adjustments.                                                     </span>
<span class="-1742313644800837850" onmouseenter="enter('-1742313644800837850');" onmouseout="out('-1742313644800837850');" style=""> 335             Offer offer = promotableOrderAdjustment.getOffer();                                          </span>
<span class="1325997209783346162" onmouseenter="enter('1325997209783346162');" onmouseout="out('1325997209783346162');" style=""> 336             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();                          </span>
<span class="-6738057894981368691" onmouseenter="enter('-6738057894981368691');" onmouseout="out('-6738057894981368691');" style=""> 337             orderAdjustment.init(order, offer, offer.getName());                                         </span>
<span class="-770736347184914897" onmouseenter="enter('-770736347184914897');" onmouseout="out('-770736347184914897');" style=""> 338             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());                    </span>
<span class="-1853577329694264316" onmouseenter="enter('-1853577329694264316');" onmouseout="out('-1853577329694264316');" style=""> 339             order.getOrderAdjustments().add(orderAdjustment);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 341     }                                                                                                    </span>
<span  style=""> 342                                                                                                          </span>
<span class="7254378221303205454" onmouseenter="enter('7254378221303205454');" onmouseout="out('7254378221303205454');" style=""><abbr title=" 343     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 343     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 344         Long offerId = adjustment.getOffer().getId();                                                    </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style=""> 345         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {                  </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 346             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="7257069809489192732" onmouseenter="enter('7257069809489192732');" onmouseout="out('7257069809489192732');" style=""> 347                 LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +      </span>
<span class="989054364510106270" onmouseenter="enter('989054364510106270');" onmouseout="out('989054364510106270');" style=""> 348                         promotableAdjustment.getAdjustmentValue());                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349             }                                                                                            </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style=""> 350             adjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 351         }                                                                                                </span>
<span class="734930962553645377" onmouseenter="enter('734930962553645377');" onmouseout="out('734930962553645377');" style=""> 352         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {     </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 353             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="1970354127702343135" onmouseenter="enter('1970354127702343135');" onmouseout="out('1970354127702343135');" style=""><abbr title=" 354                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +"> 354                 LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to ðŸ”µ</abbr></span>
<span class="755598418585359348" onmouseenter="enter('755598418585359348');" onmouseout="out('755598418585359348');" style=""> 355                         promotableAdjustment.isFutureCredit());                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356             }                                                                                            </span>
<span class="-1212224207609501002" onmouseenter="enter('-1212224207609501002');" onmouseout="out('-1212224207609501002');" style=""> 357             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 358         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 359     }                                                                                                    </span>
<span  style=""> 360                                                                                                          </span>
<span class="4939686944790593089" onmouseenter="enter('4939686944790593089');" onmouseout="out('4939686944790593089');" style=""> 361     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {                              </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 362         Order order = promotableOrder.getOrder();                                                        </span>
<span class="8870411702953196775" onmouseenter="enter('8870411702953196775');" onmouseout="out('8870411702953196775');" style=""><abbr title=" 363         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 363         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr></span>
<span  style=""> 364                                                                                                          </span>
<span class="45393343966675502" onmouseenter="enter('45393343966675502');" onmouseout="out('45393343966675502');" style=""> 365         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);                 </span>
<span  style=""> 366                                                                                                          </span>
<span class="-3971897302215245898" onmouseenter="enter('-3971897302215245898');" onmouseout="out('-3971897302215245898');" style=""> 367         for (OrderItem orderItem : orderItemList) {                                                      </span>
<span class="-3227733123108723187" onmouseenter="enter('-3227733123108723187');" onmouseout="out('-3227733123108723187');" style=""> 368             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);                       </span>
<span class="-7181450714367096357" onmouseenter="enter('-7181450714367096357');" onmouseout="out('-7181450714367096357');" style=""> 369             if (promotableItem == null) {                                                                </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 370                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 371             }                                                                                            </span>
<span class="-4627052923559624390" onmouseenter="enter('-4627052923559624390');" onmouseout="out('-4627052923559624390');" style=""> 372             synchronizeItemPriceDetails(orderItem, promotableItem);                                      </span>
<span class="-6035169113045010952" onmouseenter="enter('-6035169113045010952');" onmouseout="out('-6035169113045010952');" style=""> 373             synchronizeItemQualifiers(orderItem, promotableItem);                                        </span>
<span  style=""> 374                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 375         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 376     }                                                                                                    </span>
<span  style=""> 377                                                                                                          </span>
<span class="4641946456273473515" onmouseenter="enter('4641946456273473515');" onmouseout="out('4641946456273473515');" style=""><abbr title=" 378     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 378     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr></span>
<span class="8574464637260302488" onmouseenter="enter('8574464637260302488');" onmouseout="out('8574464637260302488');" style=""><abbr title=" 379         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 379         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr></span>
<span class="-6342291150701367795" onmouseenter="enter('-6342291150701367795');" onmouseout="out('-6342291150701367795');" style=""> 380         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;(); </span>
<span  style=""> 381                                                                                                          </span>
<span class="-4767625469055938064" onmouseenter="enter('-4767625469055938064');" onmouseout="out('-4767625469055938064');" style=""> 382         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {         </span>
<span class="5353286555635618569" onmouseenter="enter('5353286555635618569');" onmouseout="out('5353286555635618569');" style=""> 383             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);                            </span>
<span class="-2878152675586990901" onmouseenter="enter('-2878152675586990901');" onmouseout="out('-2878152675586990901');" style=""> 384             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);    </span>
<span class="5988062476356282201" onmouseenter="enter('5988062476356282201');" onmouseout="out('5988062476356282201');" style=""> 385             if (promotableDetail != null) {                                                              </span>
<span class="-2745140720553978382" onmouseenter="enter('-2745140720553978382');" onmouseout="out('-2745140720553978382');" style=""> 386                 processMatchingDetails(orderItemPriceDetail, promotableDetail);                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 387             } else {                                                                                     </span>
<span class="-8641070025229307801" onmouseenter="enter('-8641070025229307801');" onmouseout="out('-8641070025229307801');" style=""> 388                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 389             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390         }                                                                                                </span>
<span  style=""> 391                                                                                                          </span>
<span class="-2102992530504048935" onmouseenter="enter('-2102992530504048935');" onmouseout="out('-2102992530504048935');" style=""><abbr title=" 392         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 392         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr></span>
<span  style=""> 393                                                                                                          </span>
<span class="3655839919190900579" onmouseenter="enter('3655839919190900579');" onmouseout="out('3655839919190900579');" style=""> 394         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {               </span>
<span class="848025138552610797" onmouseenter="enter('848025138552610797');" onmouseout="out('848025138552610797');" style=""> 395             if (unmatchedDetailsIterator.hasNext()) {                                                    </span>
<span class="-1286995204662994700" onmouseenter="enter('-1286995204662994700');" onmouseout="out('-1286995204662994700');" style=""> 396                 // Reuse an existing priceDetail                                                         </span>
<span class="-6274362249453165217" onmouseenter="enter('-6274362249453165217');" onmouseout="out('-6274362249453165217');" style=""> 397                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();                   </span>
<span  style=""> 398                                                                                                          </span>
<span class="8785556757346701489" onmouseenter="enter('8785556757346701489');" onmouseout="out('8785556757346701489');" style=""> 399                 // Reset use Sale flag to true                                                           </span>
<span class="-4586757194387339116" onmouseenter="enter('-4586757194387339116');" onmouseout="out('-4586757194387339116');" style=""> 400                 existingDetail.setUseSalePrice(true);                                                    </span>
<span  style=""> 401                                                                                                          </span>
<span class="7880433973363830475" onmouseenter="enter('7880433973363830475');" onmouseout="out('7880433973363830475');" style=""> 402                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);                    </span>
<span class="9163760465604163202" onmouseenter="enter('9163760465604163202');" onmouseout="out('9163760465604163202');" style=""> 403                 unmatchedDetailsIterator.remove();                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 404             } else {                                                                                     </span>
<span class="-3751890412067657497" onmouseenter="enter('-3751890412067657497');" onmouseout="out('-3751890412067657497');" style=""> 405                 // Create a new priceDetail                                                              </span>
<span class="-1690864448011816688" onmouseenter="enter('-1690864448011816688');" onmouseout="out('-1690864448011816688');" style=""> 406                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();         </span>
<span class="-3940721081423400252" onmouseenter="enter('-3940721081423400252');" onmouseout="out('-3940721081423400252');" style=""> 407                 newPriceDetail.setOrderItem(orderItem);                                                  </span>
<span class="-2358509328501908297" onmouseenter="enter('-2358509328501908297');" onmouseout="out('-2358509328501908297');" style=""> 408                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);                    </span>
<span class="7726531521682039639" onmouseenter="enter('7726531521682039639');" onmouseout="out('7726531521682039639');" style=""> 409                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 410             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411         }                                                                                                </span>
<span  style=""> 412                                                                                                          </span>
<span class="5078704746315005492" onmouseenter="enter('5078704746315005492');" onmouseout="out('5078704746315005492');" style=""> 413         // Remove any unmatched details                                                                  </span>
<span class="-596985917041158168" onmouseenter="enter('-596985917041158168');" onmouseout="out('-596985917041158168');" style=""> 414         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();     </span>
<span class="-2348069803911125145" onmouseenter="enter('-2348069803911125145');" onmouseout="out('-2348069803911125145');" style=""> 415         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416     }                                                                                                    </span>
<span  style=""> 417                                                                                                          </span>
<span class="-3359465330409353741" onmouseenter="enter('-3359465330409353741');" onmouseout="out('-3359465330409353741');" style=""><abbr title=" 418     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 418     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr></span>
<span class="6939567773624847901" onmouseenter="enter('6939567773624847901');" onmouseout="out('6939567773624847901');" style=""> 419         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem); </span>
<span class="-838353671554643485" onmouseenter="enter('-838353671554643485');" onmouseout="out('-838353671554643485');" style=""> 420         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();  </span>
<span  style=""> 421                                                                                                          </span>
<span class="6539711029953657105" onmouseenter="enter('6539711029953657105');" onmouseout="out('6539711029953657105');" style=""> 422         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {               </span>
<span class="2428508324486494962" onmouseenter="enter('2428508324486494962');" onmouseout="out('2428508324486494962');" style=""><abbr title=" 423             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 423             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr></span>
<span class="-4549367717464072284" onmouseenter="enter('-4549367717464072284');" onmouseout="out('-4549367717464072284');" style=""> 424             if (promotableQualifier != null) {                                                           </span>
<span class="-5773466494614436024" onmouseenter="enter('-5773466494614436024');" onmouseout="out('-5773466494614436024');" style=""> 425                 // Offer was used as a qualifier on previous run.   Update quantity if needed.           </span>
<span class="-3775165376026668506" onmouseenter="enter('-3775165376026668506');" onmouseout="out('-3775165376026668506');" style=""> 426                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {             </span>
<span class="6319516500536721656" onmouseenter="enter('6319516500536721656');" onmouseout="out('6319516500536721656');" style=""> 427                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 428                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 429             } else {                                                                                     </span>
<span class="-7107745465096608003" onmouseenter="enter('-7107745465096608003');" onmouseout="out('-7107745465096608003');" style=""> 430                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 431             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 432         }                                                                                                </span>
<span  style=""> 433                                                                                                          </span>
<span class="6412010879861386561" onmouseenter="enter('6412010879861386561');" onmouseout="out('6412010879861386561');" style=""><abbr title=" 434         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 434         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr></span>
<span  style=""> 435                                                                                                          </span>
<span class="-5367673967409602220" onmouseenter="enter('-5367673967409602220');" onmouseout="out('-5367673967409602220');" style=""> 436         for (PromotionQualifier qualifier : qualifiersMap.values()) {                                    </span>
<span class="4352951882445574614" onmouseenter="enter('4352951882445574614');" onmouseout="out('4352951882445574614');" style=""> 437             if (unmatchedQualifiersIterator.hasNext()) {                                                 </span>
<span class="916500832219535438" onmouseenter="enter('916500832219535438');" onmouseout="out('916500832219535438');" style=""> 438                 // Reuse an existing qualifier                                                           </span>
<span class="-457617571898655971" onmouseenter="enter('-457617571898655971');" onmouseout="out('-457617571898655971');" style=""> 439                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();               </span>
<span class="-9191122370911430740" onmouseenter="enter('-9191122370911430740');" onmouseout="out('-9191122370911430740');" style=""> 440                 existingQualifier.setOffer(qualifier.getPromotion());                                    </span>
<span class="-5418424828849751920" onmouseenter="enter('-5418424828849751920');" onmouseout="out('-5418424828849751920');" style=""> 441                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                    </span>
<span class="-2784197009200988946" onmouseenter="enter('-2784197009200988946');" onmouseout="out('-2784197009200988946');" style=""> 442                 unmatchedQualifiersIterator.remove();                                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 443             } else {                                                                                     </span>
<span class="-4600119951921754996" onmouseenter="enter('-4600119951921754996');" onmouseout="out('-4600119951921754996');" style=""> 444                 // Create a new qualifier                                                                </span>
<span class="2495734798245487562" onmouseenter="enter('2495734798245487562');" onmouseout="out('2495734798245487562');" style=""> 445                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();               </span>
<span class="-7776554329531977433" onmouseenter="enter('-7776554329531977433');" onmouseout="out('-7776554329531977433');" style=""> 446                 newQualifier.setOrderItem(orderItem);                                                    </span>
<span class="-7457838790114620282" onmouseenter="enter('-7457838790114620282');" onmouseout="out('-7457838790114620282');" style=""> 447                 newQualifier.setOffer(qualifier.getPromotion());                                         </span>
<span class="35194467054568730" onmouseenter="enter('35194467054568730');" onmouseout="out('35194467054568730');" style=""> 448                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                         </span>
<span class="-7418439022636140038" onmouseenter="enter('-7418439022636140038');" onmouseout="out('-7418439022636140038');" style=""> 449                 orderItem.getOrderItemQualifiers().add(newQualifier);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 450             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 451         }                                                                                                </span>
<span  style=""> 452                                                                                                          </span>
<span class="5791534705407165022" onmouseenter="enter('5791534705407165022');" onmouseout="out('5791534705407165022');" style=""> 453         // Remove any unmatched qualifiers                                                               </span>
<span class="-8561007497302660099" onmouseenter="enter('-8561007497302660099');" onmouseout="out('-8561007497302660099');" style=""> 454         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();          </span>
<span class="760711543792628805" onmouseenter="enter('760711543792628805');" onmouseout="out('760711543792628805');" style=""> 455         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456     }                                                                                                    </span>
<span  style=""> 457                                                                                                          </span>
<span class="6872064960056917626" onmouseenter="enter('6872064960056917626');" onmouseout="out('6872064960056917626');" style=""> 458     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,                               </span>
<span class="59795375183189524" onmouseenter="enter('59795375183189524');" onmouseout="out('59795375183189524');" style=""> 459             PromotableOrderItemPriceDetail promotableItemDetail) {                                       </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 460         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                    </span>
<span class="7510782226240613992" onmouseenter="enter('7510782226240613992');" onmouseout="out('7510782226240613992');" style=""> 461                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);                          </span>
<span  style=""> 462                                                                                                          </span>
<span class="-750959101585099141" onmouseenter="enter('-750959101585099141');" onmouseout="out('-750959101585099141');" style=""> 463         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {                            </span>
<span class="-3259655613865435165" onmouseenter="enter('-3259655613865435165');" onmouseout="out('-3259655613865435165');" style=""> 464             itemDetail.setQuantity(promotableItemDetail.getQuantity());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465         }                                                                                                </span>
<span  style=""> 466                                                                                                          </span>
<span class="9218754308308575613" onmouseenter="enter('9218754308308575613');" onmouseout="out('9218754308308575613');" style=""><abbr title=" 467         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 467         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr></span>
<span class="2783281510413095088" onmouseenter="enter('2783281510413095088');" onmouseout="out('2783281510413095088');" style=""><abbr title=" 468             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 468             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr></span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 469             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                    </span>
<span class="-4842011616043597197" onmouseenter="enter('-4842011616043597197');" onmouseout="out('-4842011616043597197');" style=""> 470                 itemAdjustment.setValue(adjustment.getAdjustmentValue());                                </span>
<span class="-5695031583799398466" onmouseenter="enter('-5695031583799398466');" onmouseout="out('-5695031583799398466');" style=""> 471                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474     }                                                                                                    </span>
<span  style=""> 475                                                                                                          </span>
<span class="4651274540478945566" onmouseenter="enter('4651274540478945566');" onmouseout="out('4651274540478945566');" style=""> 476     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {                          </span>
<span class="1883813639191860394" onmouseenter="enter('1883813639191860394');" onmouseout="out('1883813639191860394');" style=""> 477         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();                                                     </span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 478         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 478         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 479             Long offerId = adjustment.getOffer().getId();                                                </span>
<span class="-11608270007353255" onmouseenter="enter('-11608270007353255');" onmouseout="out('-11608270007353255');" style=""> 480             offerIds.add(offerId);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481         }                                                                                                </span>
<span class="-5651075727196406737" onmouseenter="enter('-5651075727196406737');" onmouseout="out('-5651075727196406737');" style=""> 482         Collections.sort(offerIds);                                                                      </span>
<span class="5891357179043449296" onmouseenter="enter('5891357179043449296');" onmouseout="out('5891357179043449296');" style=""> 483         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();</span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484     }                                                                                                    </span>
<span  style=""> 485                                                                                                          </span>
<span class="-6813037055353877100" onmouseenter="enter('-6813037055353877100');" onmouseout="out('-6813037055353877100');" style=""><abbr title=" 486     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 486     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr></span>
<span class="-5863956661369186771" onmouseenter="enter('-5863956661369186771');" onmouseout="out('-5863956661369186771');" style=""><abbr title=" 487         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 487         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr></span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 488         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4172210863560606018" onmouseenter="enter('-4172210863560606018');" onmouseout="out('-4172210863560606018');" style=""> 489             detailsMap.put(detail.buildDetailKey(), detail);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490         }                                                                                                </span>
<span class="1985757738719514214" onmouseenter="enter('1985757738719514214');" onmouseout="out('1985757738719514214');" style=""> 491         return detailsMap;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492     }                                                                                                    </span>
<span  style=""> 493                                                                                                          </span>
<span class="-3836724244114507356" onmouseenter="enter('-3836724244114507356');" onmouseout="out('-3836724244114507356');" style=""> 494     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {     </span>
<span class="-1925492436839506759" onmouseenter="enter('-1925492436839506759');" onmouseout="out('-1925492436839506759');" style=""> 495         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();           </span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 496         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4593166378473264356" onmouseenter="enter('-4593166378473264356');" onmouseout="out('-4593166378473264356');" style=""> 497             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {                       </span>
<span class="3842824965672319387" onmouseenter="enter('3842824965672319387');" onmouseout="out('3842824965672319387');" style=""><abbr title=" 498                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 498                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr></span>
<span class="-8569849509682320504" onmouseenter="enter('-8569849509682320504');" onmouseout="out('-8569849509682320504');" style=""> 499                 if (existingQualifier != null) {                                                         </span>
<span class="-4445010116162684270" onmouseenter="enter('-4445010116162684270');" onmouseout="out('-4445010116162684270');" style=""><abbr title=" 500                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 500                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 501                 } else {                                                                                 </span>
<span class="-8046901564682421602" onmouseenter="enter('-8046901564682421602');" onmouseout="out('-8046901564682421602');" style=""> 502                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505         }                                                                                                </span>
<span class="4699150655190374848" onmouseenter="enter('4699150655190374848');" onmouseout="out('4699150655190374848');" style=""> 506         return qualifiersMap;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507     }                                                                                                    </span>
<span  style=""> 508                                                                                                          </span>
<span class="6650489462588239331" onmouseenter="enter('6650489462588239331');" onmouseout="out('6650489462588239331');" style=""> 509     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {                       </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 510         Order order = promotableOrder.getOrder();                                                        </span>
<span class="6561763597022577240" onmouseenter="enter('6561763597022577240');" onmouseout="out('6561763597022577240');" style=""><abbr title=" 511         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 511         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr></span>
<span  style=""> 512                                                                                                          </span>
<span class="6990956658692188299" onmouseenter="enter('6990956658692188299');" onmouseout="out('6990956658692188299');" style=""> 513         boolean syncNeededOnTotal = false;                                                               </span>
<span  style=""> 514                                                                                                          </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 515         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                       </span>
<span class="-439733037564232612" onmouseenter="enter('-439733037564232612');" onmouseout="out('-439733037564232612');" style=""> 516             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));                           </span>
<span class="3630381949999328071" onmouseenter="enter('3630381949999328071');" onmouseout="out('3630381949999328071');" style=""> 517             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);                                   </span>
<span class="6204032096114591207" onmouseenter="enter('6204032096114591207');" onmouseout="out('6204032096114591207');" style=""> 518             if (syncNeeded) {                                                                            </span>
<span class="-6169259820846196761" onmouseenter="enter('-6169259820846196761');" onmouseout="out('-6169259820846196761');" style=""> 519                 syncFulfillmentPrice(fg);                                                                </span>
<span class="-2299678048386624818" onmouseenter="enter('-2299678048386624818');" onmouseout="out('-2299678048386624818');" style=""> 520                 syncNeededOnTotal = true;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522         }                                                                                                </span>
<span  style=""> 523                                                                                                          </span>
<span class="-5450932785890013448" onmouseenter="enter('-5450932785890013448');" onmouseout="out('-5450932785890013448');" style=""> 524         if (syncNeededOnTotal) {                                                                         </span>
<span class="-8777873539377505153" onmouseenter="enter('-8777873539377505153');" onmouseout="out('-8777873539377505153');" style=""> 525             Money syncFulfillmentPrice = Money.ZERO;                                                     </span>
<span  style=""> 526                                                                                                          </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 527             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-5396558836391507485" onmouseenter="enter('-5396558836391507485');" onmouseout="out('-5396558836391507485');" style=""> 528                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 529             }                                                                                            </span>
<span class="-4866549136483611279" onmouseenter="enter('-4866549136483611279');" onmouseout="out('-4866549136483611279');" style=""> 530             order.setTotalFulfillmentCharges(syncFulfillmentPrice);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532     }                                                                                                    </span>
<span  style=""> 533                                                                                                          </span>
<span class="2663354164110279617" onmouseenter="enter('2663354164110279617');" onmouseout="out('2663354164110279617');" style=""> 534     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {                            </span>
<span class="-1122908714199440396" onmouseenter="enter('-1122908714199440396');" onmouseout="out('-1122908714199440396');" style=""> 535         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 536     }                                                                                                    </span>
<span  style=""> 537                                                                                                          </span>
<span class="-1055395477678850539" onmouseenter="enter('-1055395477678850539');" onmouseout="out('-1055395477678850539');" style=""> 538     protected void syncFulfillmentPrice(FulfillmentGroup fg) {                                           </span>
<span class="6421033897115001406" onmouseenter="enter('6421033897115001406');" onmouseout="out('6421033897115001406');" style=""> 539         Money retailPrice = fg.getRetailFulfillmentPrice();                                              </span>
<span class="2458814602568234661" onmouseenter="enter('2458814602568234661');" onmouseout="out('2458814602568234661');" style=""> 540         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();  </span>
<span class="-5014608312607866780" onmouseenter="enter('-5014608312607866780');" onmouseout="out('-5014608312607866780');" style=""> 541         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);    </span>
<span  style=""> 542                                                                                                          </span>
<span class="723442610052021445" onmouseenter="enter('723442610052021445');" onmouseout="out('723442610052021445');" style=""> 543         fg.setFulfillmentPrice(fulfillmentPrice);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544     }                                                                                                    </span>
<span  style=""> 545                                                                                                          </span>
<span class="-613491293141460653" onmouseenter="enter('-613491293141460653');" onmouseout="out('-613491293141460653');" style=""><abbr title=" 546     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 546     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr></span>
<span class="-2168953774981447317" onmouseenter="enter('-2168953774981447317');" onmouseout="out('-2168953774981447317');" style=""> 547         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();   </span>
<span class="-1134830134613695083" onmouseenter="enter('-1134830134613695083');" onmouseout="out('-1134830134613695083');" style=""> 548         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {                             </span>
<span class="-3822470075223000180" onmouseenter="enter('-3822470075223000180');" onmouseout="out('-3822470075223000180');" style=""> 549             fgMap.put(fg.getFulfillmentGroup().getId(), fg);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 551         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 552     }                                                                                                    </span>
<span  style=""> 553                                                                                                          </span>
<span class="6665195593296681168" onmouseenter="enter('6665195593296681168');" onmouseout="out('6665195593296681168');" style=""><abbr title=" 554     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 554     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr></span>
<span class="-7214313390686800174" onmouseenter="enter('-7214313390686800174');" onmouseout="out('-7214313390686800174');" style=""><abbr title=" 555         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 555         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr></span>
<span class="331019091121439684" onmouseenter="enter('331019091121439684');" onmouseout="out('331019091121439684');" style=""><abbr title=" 556         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 556         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr></span>
<span class="1110980486512930755" onmouseenter="enter('1110980486512930755');" onmouseout="out('1110980486512930755');" style=""><abbr title=" 557             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 557             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 559         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560     }                                                                                                    </span>
<span  style=""> 561                                                                                                          </span>
<span class="-7617178904345879788" onmouseenter="enter('-7617178904345879788');" onmouseout="out('-7617178904345879788');" style=""><abbr title=" 562     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 562     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr></span>
<span class="1705100339866591039" onmouseenter="enter('1705100339866591039');" onmouseout="out('1705100339866591039');" style=""><abbr title=" 563         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 563         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr></span>
<span class="6869467232437188017" onmouseenter="enter('6869467232437188017');" onmouseout="out('6869467232437188017');" style=""><abbr title=" 564         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 564         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr></span>
<span  style=""> 565                                                                                                          </span>
<span class="7622903297016040666" onmouseenter="enter('7622903297016040666');" onmouseout="out('7622903297016040666');" style=""> 566         // First try and update existing adjustment records                                              </span>
<span class="6593219943708493598" onmouseenter="enter('6593219943708493598');" onmouseout="out('6593219943708493598');" style=""> 567         while (adjustmentIterator.hasNext()) {                                                           </span>
<span class="5134089875457655542" onmouseenter="enter('5134089875457655542');" onmouseout="out('5134089875457655542');" style=""> 568             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();                           </span>
<span class="9090174154450682409" onmouseenter="enter('9090174154450682409');" onmouseout="out('9090174154450682409');" style=""><abbr title=" 569             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 569             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr></span>
<span class="7739365516519203047" onmouseenter="enter('7739365516519203047');" onmouseout="out('7739365516519203047');" style=""> 570             if (newAdj != null) {                                                                        </span>
<span class="5102959516436064847" onmouseenter="enter('5102959516436064847');" onmouseout="out('5102959516436064847');" style=""> 571                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {                        </span>
<span class="-6634291412355259187" onmouseenter="enter('-6634291412355259187');" onmouseout="out('-6634291412355259187');" style=""> 572                     // Update the currentAdj.                                                            </span>
<span class="-4755037759892167947" onmouseenter="enter('-4755037759892167947');" onmouseout="out('-4755037759892167947');" style=""> 573                     currentAdj.setValue(newAdj.getAdjustmentValue());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 574                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 575             } else {                                                                                     </span>
<span class="-5437992937664131712" onmouseenter="enter('-5437992937664131712');" onmouseout="out('-5437992937664131712');" style=""> 576                 // Removing no longer valid adjustment                                                   </span>
<span class="-6800144716907845476" onmouseenter="enter('-6800144716907845476');" onmouseout="out('-6800144716907845476');" style=""> 577                 adjustmentIterator.remove();                                                             </span>
<span class="855814523852624000" onmouseenter="enter('855814523852624000');" onmouseout="out('855814523852624000');" style=""> 578                 entityService.remove(currentAdj);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 580         }                                                                                                </span>
<span  style=""> 581                                                                                                          </span>
<span class="4911772249630101500" onmouseenter="enter('4911772249630101500');" onmouseout="out('4911772249630101500');" style=""> 582         // Now add missing adjustments                                                                   </span>
<span class="8170167194272017979" onmouseenter="enter('8170167194272017979');" onmouseout="out('8170167194272017979');" style=""> 583         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {                  </span>
<span class="-4188265609244912176" onmouseenter="enter('-4188265609244912176');" onmouseout="out('-4188265609244912176');" style=""> 584             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();                 </span>
<span class="3068706828930127416" onmouseenter="enter('3068706828930127416');" onmouseout="out('3068706828930127416');" style=""> 585             fa.setFulfillmentGroup(fg);                                                                  </span>
<span class="5392928859383582349" onmouseenter="enter('5392928859383582349');" onmouseout="out('5392928859383582349');" style=""> 586             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);          </span>
<span class="4727884307924071496" onmouseenter="enter('4727884307924071496');" onmouseout="out('4727884307924071496');" style=""> 587             fa.setValue(newAdj.getAdjustmentValue());                                                    </span>
<span class="-1586043412444283157" onmouseenter="enter('-1586043412444283157');" onmouseout="out('-1586043412444283157');" style=""> 588             fg.getFulfillmentGroupAdjustments().add(fa);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589         }                                                                                                </span>
<span  style=""> 590                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 591     }                                                                                                    </span>
<span  style=""> 592                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 593     @Override                                                                                            </span>
<span class="-4816910989941817274" onmouseenter="enter('-4816910989941817274');" onmouseout="out('-4816910989941817274');" style=""> 594     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {                       </span>
<span class="-3850751249412137645" onmouseenter="enter('-3850751249412137645');" onmouseout="out('-3850751249412137645');" style=""> 595         synchronizeOrderAdjustments(promotableOrder);                                                    </span>
<span class="4518036952510487894" onmouseenter="enter('4518036952510487894');" onmouseout="out('4518036952510487894');" style=""> 596         synchronizeOrderItems(promotableOrder);                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 597         if (extensionManager != null) {                                                                  </span>
<span class="-6179159556176464024" onmouseenter="enter('-6179159556176464024');" onmouseout="out('-6179159556176464024');" style=""> 598             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 599         }                                                                                                </span>
<span class="-159866277563841870" onmouseenter="enter('-159866277563841870');" onmouseout="out('-159866277563841870');" style=""> 600         synchronizeFulfillmentGroups(promotableOrder);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601     }                                                                                                    </span>
<span  style=""> 602                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 603     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 604     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 605         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 606     }                                                                                                    </span>
<span  style=""> 607                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 608     @Override                                                                                            </span>
<span class="6530687858988053885" onmouseenter="enter('6530687858988053885');" onmouseout="out('6530687858988053885');" style=""> 609     public void setOrderItemDao(OrderItemDao orderItemDao) {                                             </span>
<span class="-8374754321118159364" onmouseenter="enter('-8374754321118159364');" onmouseout="out('-8374754321118159364');" style=""> 610         this.orderItemDao = orderItemDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 611     }                                                                                                    </span>
<span  style=""> 612                                                                                                          </span>
<span class="-6632247919309783023" onmouseenter="enter('-6632247919309783023');" onmouseout="out('-6632247919309783023');" style=""> 613     public OfferServiceUtilities getOfferServiceUtilities() {                                            </span>
<span class="-6406517936839827979" onmouseenter="enter('-6406517936839827979');" onmouseout="out('-6406517936839827979');" style=""> 614         return offerServiceUtilities;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615     }                                                                                                    </span>
<span  style=""> 616                                                                                                          </span>
<span class="4442139862126007445" onmouseenter="enter('4442139862126007445');" onmouseout="out('4442139862126007445');" style=""> 617     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {                  </span>
<span class="4552134412879762115" onmouseenter="enter('4552134412879762115');" onmouseout="out('4552134412879762115');" style=""> 618         this.offerServiceUtilities = offerServiceUtilities;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 619     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 620 }                                                                                                        </span>




</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-4156106492343801428" onmouseenter="enter('-4156106492343801428');" onmouseout="out('-4156106492343801428');" style="">  18 package org.broadleafcommerce.core.offer.service.processor;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  20 import java.util.ArrayList;                                                                              </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  21 import java.util.Collections;                                                                            </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  22 import java.util.HashMap;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  23 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  24 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  25 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  26 import javax.annotation.Resource;                                                                        </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  27 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  28 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  29 import org.broadleafcommerce.common.money.Money;                                                         </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="">  30 import org.broadleafcommerce.common.service.GenericEntityService;                                        </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="5599608658353832247" onmouseenter="enter('5599608658353832247');" onmouseout="out('5599608658353832247');" style="">  32 import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;                               </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  33 import org.broadleafcommerce.core.offer.domain.Offer;                                                    </span>
<span class="-556809404433666112" onmouseenter="enter('-556809404433666112');" onmouseout="out('-556809404433666112');" style="">  34 import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;                                       </span>
<span class="-521081291127015873" onmouseenter="enter('-521081291127015873');" onmouseout="out('-521081291127015873');" style="">  35 import org.broadleafcommerce.core.offer.domain.OrderAdjustment;                                          </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  36 import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                           </span>
<span class="2599349157106653381" onmouseenter="enter('2599349157106653381');" onmouseout="out('2599349157106653381');" style="">  37 import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;                                   </span>
<span class="212527052176527689" onmouseenter="enter('212527052176527689');" onmouseout="out('212527052176527689');" style="">  38 import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;                        </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  39 import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                             </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  40 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="4826353322748911550" onmouseenter="enter('4826353322748911550');" onmouseout="out('4826353322748911550');" style="">  41 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;              </span>
<span class="-6049809183476525616" onmouseenter="enter('-6049809183476525616');" onmouseout="out('-6049809183476525616');" style="">  42 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  43 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="">  44 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                  </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="9000862227337796749" onmouseenter="enter('9000862227337796749');" onmouseout="out('9000862227337796749');" style="">  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;               </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                     </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;          </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;</span>
<span class="-5253725521220244448" onmouseenter="enter('-5253725521220244448');" onmouseout="out('-5253725521220244448');" style="">  50 import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;                                  </span>
<span class="1925170083501964673" onmouseenter="enter('1925170083501964673');" onmouseout="out('1925170083501964673');" style="">  51 import org.broadleafcommerce.core.offer.service.type.OfferRuleType;                                      </span>
<span class="-7012758821456487335" onmouseenter="enter('-7012758821456487335');" onmouseout="out('-7012758821456487335');" style="">  52 import org.broadleafcommerce.core.order.dao.OrderItemDao;                                                </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  53 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  54 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  55 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  56 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  57 import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                       </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  58 import org.springframework.stereotype.Service;                                                           </span>
<span  style="">  59                                                                                                          </span>
<span  style="">  60                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  61 /**                                                                                                      </span>
<span class="5097862330762959365" onmouseenter="enter('5097862330762959365');" onmouseout="out('5097862330762959365');" style="">  62  * @author jfischer, bpolster                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  63  */                                                                                                      </span>
<span class="-2245109148562763451" onmouseenter="enter('-2245109148562763451');" onmouseout="out('-2245109148562763451');" style="">  64 @Service(&quot;blOrderOfferProcessor&quot;)                                                                        </span>
<span class="-4961554400286801245" onmouseenter="enter('-4961554400286801245');" onmouseout="out('-4961554400286801245');" style="">  65 public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {      </span>
<span class="-2801860175860773750" onmouseenter="enter('-2801860175860773750');" onmouseout="out('-2801860175860773750');" style="">  66     private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);                     </span>
<span  style="">  67                                                                                                          </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  68     @Resource(name = &quot;blPromotableItemFactory&quot;)                                                          </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  69     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  70                                                                                                          </span>
<span class="-2264776225690683323" onmouseenter="enter('-2264776225690683323');" onmouseout="out('-2264776225690683323');" style="">  71     @Resource(name = &quot;blOrderItemDao&quot;)                                                                   </span>
<span class="1921252040396799605" onmouseenter="enter('1921252040396799605');" onmouseout="out('1921252040396799605');" style="">  72     protected OrderItemDao orderItemDao;                                                                 </span>
<span  style="">  73                                                                                                          </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  74     @Resource(name = &quot;blOfferDao&quot;)                                                                       </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  75     protected OfferDao offerDao;                                                                         </span>
<span  style="">  76                                                                                                          </span>
<span class="2002571695049097079" onmouseenter="enter('2002571695049097079');" onmouseout="out('2002571695049097079');" style="">  77     @Resource(name = &quot;blOfferServiceUtilities&quot;)                                                          </span>
<span class="-2602045083470320651" onmouseenter="enter('-2602045083470320651');" onmouseout="out('-2602045083470320651');" style="">  78     protected OfferServiceUtilities offerServiceUtilities;                                               </span>
<span  style="">  79                                                                                                          </span>
<span class="-2100856710351800386" onmouseenter="enter('-2100856710351800386');" onmouseout="out('-2100856710351800386');" style="">  80     public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {                      </span>
<span class="386697006679121838" onmouseenter="enter('386697006679121838');" onmouseout="out('386697006679121838');" style="">  81         super(promotableOfferUtility);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  82     }                                                                                                    </span>
<span  style="">  83                                                                                                          </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="">  84     @Resource(name = &quot;blGenericEntityService&quot;)                                                           </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="">  85     protected GenericEntityService entityService;                                                        </span>
<span  style="">  86                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  87     @Override                                                                                            </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style=""><abbr title="  88     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  88     public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="-6690931251258113559" onmouseenter="enter('-6690931251258113559');" onmouseout="out('-6690931251258113559');" style="">  89         if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {           </span>
<span class="2381861258987592021" onmouseenter="enter('2381861258987592021');" onmouseout="out('2381861258987592021');" style=""><abbr title="  90             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  90             LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offeðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="">  91             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92         }                                                                                                </span>
<span class="-1909487068460560279" onmouseenter="enter('-1909487068460560279');" onmouseout="out('-1909487068460560279');" style="">  93         boolean orderLevelQualification = false;                                                         </span>
<span class="-826538299394729423" onmouseenter="enter('-826538299394729423');" onmouseout="out('-826538299394729423');" style="">  94         //Order Qualification                                                                            </span>
<span class="-5521254225981685482" onmouseenter="enter('-5521254225981685482');" onmouseout="out('-5521254225981685482');" style="">  95         orderQualification:                                                                              </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="">  96         {                                                                                                </span>
<span class="-7608560305899310529" onmouseenter="enter('-7608560305899310529');" onmouseout="out('-7608560305899310529');" style="">  97             if (couldOfferApplyToOrder(offer, promotableOrder)) {                                        </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style="">  98                 orderLevelQualification = true;                                                          </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style="">  99                 break orderQualification;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100             }                                                                                            </span>
<span class="7444608498293955145" onmouseenter="enter('7444608498293955145');" onmouseout="out('7444608498293955145');" style=""><abbr title=" 101             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 101             for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyðŸ”µ</abbr></span>
<span class="5211303022284930113" onmouseenter="enter('5211303022284930113');" onmouseout="out('5211303022284930113');" style=""> 102                 if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {                         </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 103                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 104                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106             }                                                                                            </span>
<span class="-3473403760382889072" onmouseenter="enter('-3473403760382889072');" onmouseout="out('-3473403760382889072');" style=""> 107             for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) { </span>
<span class="7357760135902725095" onmouseenter="enter('7357760135902725095');" onmouseout="out('7357760135902725095');" style=""> 108                 if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {                  </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 109                     orderLevelQualification = true;                                                      </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 110                     break orderQualification;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113         }                                                                                                </span>
<span class="5034616183006708671" onmouseenter="enter('5034616183006708671');" onmouseout="out('5034616183006708671');" style=""> 114         //Item Qualification - new for 1.5!                                                              </span>
<span class="3708307267894275622" onmouseenter="enter('3708307267894275622');" onmouseout="out('3708307267894275622');" style=""> 115         if (orderLevelQualification) {                                                                   </span>
<span class="4083707686274340956" onmouseenter="enter('4083707686274340956');" onmouseout="out('4083707686274340956');" style=""><abbr title=" 116             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 116             CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiðŸ”µ</abbr></span>
<span class="2629114037035373615" onmouseenter="enter('2629114037035373615');" onmouseout="out('2629114037035373615');" style=""> 117             if (candidates.isMatchedQualifier()) {                                                       </span>
<span class="5830719426865289135" onmouseenter="enter('5830719426865289135');" onmouseout="out('5830719426865289135');" style=""><abbr title=" 118                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 118                 PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder,ðŸ”µ</abbr></span>
<span class="-2643650349584698588" onmouseenter="enter('-2643650349584698588');" onmouseout="out('-2643650349584698588');" style=""><abbr title=" 119                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());"> 119                 candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap())ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 124     @Override                                                                                            </span>
<span class="-6078198317128464464" onmouseenter="enter('-6078198317128464464');" onmouseout="out('-6078198317128464464');" style=""> 125     public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {                </span>
<span class="6994875763592911045" onmouseenter="enter('6994875763592911045');" onmouseout="out('6994875763592911045');" style=""> 126         return couldOfferApplyToOrder(offer, promotableOrder, null, null);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127     }                                                                                                    </span>
<span  style=""> 128                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 129     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 130      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 131      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 132      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 133      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 134      * @param order                                                                                      </span>
<span class="3239114303692248883" onmouseenter="enter('3239114303692248883');" onmouseout="out('3239114303692248883');" style=""> 135      * @param orderItem                                                                                  </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 136      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 137      */                                                                                                  </span>
<span class="-90678225806082002" onmouseenter="enter('-90678225806082002');" onmouseout="out('-90678225806082002');" style=""><abbr title=" 138     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 138     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="-1630600385205451505" onmouseenter="enter('-1630600385205451505');" onmouseout="out('-1630600385205451505');" style=""> 139         return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140     }                                                                                                    </span>
<span  style=""> 141                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 142     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 143      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 144      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 145      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 146      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 147      * @param order                                                                                      </span>
<span class="-7108679256071712026" onmouseenter="enter('-7108679256071712026');" onmouseout="out('-7108679256071712026');" style=""> 148      * @param fulfillmentGroup                                                                           </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 149      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 150      */                                                                                                  </span>
<span class="-667507213825504723" onmouseenter="enter('-667507213825504723');" onmouseout="out('-667507213825504723');" style=""><abbr title=" 151     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 151     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfðŸ”µ</abbr></span>
<span class="-5817125691165623435" onmouseenter="enter('-5817125691165623435');" onmouseout="out('-5817125691165623435');" style=""> 152         return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153     }                                                                                                    </span>
<span  style=""> 154                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 155     /**                                                                                                  </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 156      * Private method which executes the appliesToOrderRules in the Offer to determine if this offer     </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 157      * can be applied to the Order, OrderItem, or FulfillmentGroup.                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 158      *                                                                                                   </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 159      * @param offer                                                                                      </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 160      * @param order                                                                                      </span>
<span class="-4036081007465325177" onmouseenter="enter('-4036081007465325177');" onmouseout="out('-4036081007465325177');" style=""> 161      * @param promotableOrderItem                                                                        </span>
<span class="-8152129500080290565" onmouseenter="enter('-8152129500080290565');" onmouseout="out('-8152129500080290565');" style=""> 162      * @param promotableFulfillmentGroup                                                                 </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 163      * @return true if offer can be applied, otherwise false                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 164      */                                                                                                  </span>
<span class="-3457716414026742708" onmouseenter="enter('-3457716414026742708');" onmouseout="out('-3457716414026742708');" style=""><abbr title=" 165     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 165     protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrdeðŸ”µ</abbr></span>
<span class="6012064276783556206" onmouseenter="enter('6012064276783556206');" onmouseout="out('6012064276783556206');" style=""> 166         boolean appliesToItem = false;                                                                   </span>
<span class="2877098389407446108" onmouseenter="enter('2877098389407446108');" onmouseout="out('2877098389407446108');" style=""> 167         String rule = null;                                                                              </span>
<span class="1562125678824942427" onmouseenter="enter('1562125678824942427');" onmouseout="out('1562125678824942427');" style=""> 168         OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());</span>
<span class="8836327960017040493" onmouseenter="enter('8836327960017040493');" onmouseout="out('8836327960017040493');" style=""> 169         if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {                                     </span>
<span class="-7963530667142055111" onmouseenter="enter('-7963530667142055111');" onmouseout="out('-7963530667142055111');" style=""> 170             rule = orderRule.getOfferRule().getMatchRule();                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171         }                                                                                                </span>
<span  style=""> 172                                                                                                          </span>
<span class="5810732230915198369" onmouseenter="enter('5810732230915198369');" onmouseout="out('5810732230915198369');" style=""> 173         if (rule != null) {                                                                              </span>
<span  style=""> 174                                                                                                          </span>
<span class="8884608966566249698" onmouseenter="enter('8884608966566249698');" onmouseout="out('8884608966566249698');" style=""> 175             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();                                </span>
<span class="1671864453263259632" onmouseenter="enter('1671864453263259632');" onmouseout="out('1671864453263259632');" style=""> 176             promotableOrder.updateRuleVariables(vars);                                                   </span>
<span class="-7784011122993792428" onmouseenter="enter('-7784011122993792428');" onmouseout="out('-7784011122993792428');" style=""> 177             vars.put(&quot;offer&quot;, offer);                                                                    </span>
<span class="8596724536333203596" onmouseenter="enter('8596724536333203596');" onmouseout="out('8596724536333203596');" style=""> 178             if (promotableFulfillmentGroup != null) {                                                    </span>
<span class="4746323176778251021" onmouseenter="enter('4746323176778251021');" onmouseout="out('4746323176778251021');" style=""> 179                 promotableFulfillmentGroup.updateRuleVariables(vars);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180             }                                                                                            </span>
<span class="-4723719306153838221" onmouseenter="enter('-4723719306153838221');" onmouseout="out('-4723719306153838221');" style=""> 181             if (promotableOrderItem != null) {                                                           </span>
<span class="-3080150609740522861" onmouseenter="enter('-3080150609740522861');" onmouseout="out('-3080150609740522861');" style=""> 182                 promotableOrderItem.updateRuleVariables(vars);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183             }                                                                                            </span>
<span class="8856405891316557013" onmouseenter="enter('8856405891316557013');" onmouseout="out('8856405891316557013');" style=""> 184             Boolean expressionOutcome = executeExpression(rule, vars);                                   </span>
<span class="5232502196242835360" onmouseenter="enter('5232502196242835360');" onmouseout="out('5232502196242835360');" style=""> 185             if (expressionOutcome != null &amp;&amp; expressionOutcome) {                                        </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 186                 appliesToItem = true;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187             }                                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 188         } else {                                                                                         </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 189             appliesToItem = true;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190         }                                                                                                </span>
<span  style=""> 191                                                                                                          </span>
<span class="8141379926235681461" onmouseenter="enter('8141379926235681461');" onmouseout="out('8141379926235681461');" style=""> 192         return appliesToItem;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193     }                                                                                                    </span>
<span  style=""> 194                                                                                                          </span>
<span class="7829573362373940985" onmouseenter="enter('7829573362373940985');" onmouseout="out('7829573362373940985');" style=""><abbr title=" 195     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 195     protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, LiðŸ”µ</abbr></span>
<span class="306330145608771928" onmouseenter="enter('306330145608771928');" onmouseout="out('306330145608771928');" style=""><abbr title=" 196         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 196         PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotaðŸ”µ</abbr></span>
<span class="5216830913987868628" onmouseenter="enter('5216830913987868628');" onmouseout="out('5216830913987868628');" style=""> 197         qualifiedOrderOffers.add(promotableCandidateOrderOffer);                                         </span>
<span  style=""> 198                                                                                                          </span>
<span class="8900972580850147104" onmouseenter="enter('8900972580850147104');" onmouseout="out('8900972580850147104');" style=""> 199         return promotableCandidateOrderOffer;                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202     @Override                                                                                            </span>
<span class="5964334254617273825" onmouseenter="enter('5964334254617273825');" onmouseout="out('5964334254617273825');" style=""><abbr title=" 203     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 203     public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandðŸ”µ</abbr></span>
<span class="3985416668088414845" onmouseenter="enter('3985416668088414845');" onmouseout="out('3985416668088414845');" style=""><abbr title=" 204         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 204         List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 205         int offerCount = 0;                                                                              </span>
<span class="6508259141671549344" onmouseenter="enter('6508259141671549344');" onmouseout="out('6508259141671549344');" style=""> 206         for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {                           </span>
<span class="8700395077100738449" onmouseenter="enter('8700395077100738449');" onmouseout="out('8700395077100738449');" style=""> 207             if (offerCount == 0) {                                                                       </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 208                 remainingCandidateOffers.add(candidateOffer);                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 209             } else {                                                                                     </span>
<span class="-2676530692785987369" onmouseenter="enter('-2676530692785987369');" onmouseout="out('-2676530692785987369');" style=""> 210                 if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;                           </span>
<span class="2920776142298371855" onmouseenter="enter('2920776142298371855');" onmouseout="out('2920776142298371855');" style=""> 211                         !candidateOffer.getOffer().isTotalitarianOffer()) {                              </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 212                     remainingCandidateOffers.add(candidateOffer);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214             }                                                                                            </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 215             offerCount++;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216         }                                                                                                </span>
<span class="5367008489542993301" onmouseenter="enter('5367008489542993301');" onmouseout="out('5367008489542993301');" style=""> 217         return remainingCandidateOffers;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218     }                                                                                                    </span>
<span  style=""> 219                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 220     @Override                                                                                            </span>
<span class="8954636300636023369" onmouseenter="enter('8954636300636023369');" onmouseout="out('8954636300636023369');" style=""><abbr title=" 221     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 221     public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promðŸ”µ</abbr></span>
<span class="-7971504164894226146" onmouseenter="enter('-7971504164894226146');" onmouseout="out('-7971504164894226146');" style=""><abbr title=" 222         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 222         // If order offer is not combinable, first verify order adjustment is zero, if zero, compare itemðŸ”µ</abbr></span>
<span class="1108112804447486968" onmouseenter="enter('1108112804447486968');" onmouseout="out('1108112804447486968');" style=""> 223         Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();             </span>
<span class="3603986812472116533" onmouseenter="enter('3603986812472116533');" onmouseout="out('3603986812472116533');" style=""> 224         while (orderOfferIterator.hasNext()) {                                                           </span>
<span class="-7865108167409889797" onmouseenter="enter('-7865108167409889797');" onmouseout="out('-7865108167409889797');" style=""> 225             PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();                        </span>
<span  style=""> 226                                                                                                          </span>
<span class="-919097363910280710" onmouseenter="enter('-919097363910280710');" onmouseout="out('-919097363910280710');" style=""> 227             if (promotableOrder.canApplyOrderOffer(orderOffer)) {                                        </span>
<span class="4017990809944563089" onmouseenter="enter('4017990809944563089');" onmouseout="out('4017990809944563089');" style=""><abbr title=" 228                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 228                 if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSuðŸ”µ</abbr></span>
<span class="-4210377854282903954" onmouseenter="enter('-4210377854282903954');" onmouseout="out('-4210377854282903954');" style=""> 229                     applyOrderOffer(promotableOrder, orderOffer);                                        </span>
<span  style=""> 230                                                                                                          </span>
<span class="5366287165432255586" onmouseenter="enter('5366287165432255586');" onmouseout="out('5366287165432255586');" style=""><abbr title=" 231                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {"> 231                     if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) ðŸ”µ</abbr></span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 232                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="3222834402337240688" onmouseenter="enter('3222834402337240688');" onmouseout="out('3222834402337240688');" style=""><abbr title=" 233                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 233                             LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offerðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234                         }                                                                                </span>
<span class="-4644781248556093759" onmouseenter="enter('-4644781248556093759');" onmouseout="out('-4644781248556093759');" style=""> 235                         compareAndAdjustOrderAndItemOffers(promotableOrder);                             </span>
<span class="-8504589987429997467" onmouseenter="enter('-8504589987429997467');" onmouseout="out('-8504589987429997467');" style=""><abbr title=" 236                         // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 236                         // We continue because this could be the first offer and marked as totalitarian, ðŸ”µ</abbr></span>
<span class="-473363534111382515" onmouseenter="enter('-473363534111382515');" onmouseout="out('-473363534111382515');" style=""><abbr title=" 237                         // item offer. There could be other order offers that are not totalitarian that also qualify."> 237                         // item offer. There could be other order offers that are not totalitarian that aðŸ”µ</abbr></span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 238                         continue;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239                     }                                                                                    </span>
<span  style=""> 240                                                                                                          </span>
<span class="-155427173834895323" onmouseenter="enter('-155427173834895323');" onmouseout="out('-155427173834895323');" style=""> 241                     if (!orderOffer.isCombinable()) {                                                    </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 242                         if (LOG.isTraceEnabled()) {                                                      </span>
<span class="-641512738818000762" onmouseenter="enter('-641512738818000762');" onmouseout="out('-641512738818000762');" style=""><abbr title=" 243                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 243                             LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffeðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                         }                                                                                </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 245                         break;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249         }                                                                                                </span>
<span class="1071860375321424059" onmouseenter="enter('1071860375321424059');" onmouseout="out('1071860375321424059');" style=""> 250         promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251     }                                                                                                    </span>
<span  style=""> 252                                                                                                          </span>
<span class="1494850857047655937" onmouseenter="enter('1494850857047655937');" onmouseout="out('1494850857047655937');" style=""><abbr title=" 253     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 253     protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateðŸ”µ</abbr></span>
<span class="-2808877570377534999" onmouseenter="enter('-2808877570377534999');" onmouseout="out('-2808877570377534999');" style=""><abbr title=" 254         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 254         return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 255     }                                                                                                    </span>
<span  style=""> 256                                                                                                          </span>
<span class="-8447973418270990594" onmouseenter="enter('-8447973418270990594');" onmouseout="out('-8447973418270990594');" style=""><abbr title=" 257     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 257     protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="8346114644175432666" onmouseenter="enter('8346114644175432666');" onmouseout="out('8346114644175432666');" style=""> 258         return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259     }                                                                                                    </span>
<span  style=""> 260                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 261     /**                                                                                                  </span>
<span class="7019315089426478439" onmouseenter="enter('7019315089426478439');" onmouseout="out('7019315089426478439');" style=""> 262      * Called when the system must determine whether to apply order or item adjustments.                 </span>
<span class="-8371223817828724637" onmouseenter="enter('-8371223817828724637');" onmouseout="out('-8371223817828724637');" style=""> 263      * @param promotableOrder                                                                            </span>
<span class="-2490256996948663406" onmouseenter="enter('-2490256996948663406');" onmouseout="out('-2490256996948663406');" style=""> 264      * @param orderOffersApplied                                                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 265      */                                                                                                  </span>
<span class="7043079218483465061" onmouseenter="enter('7043079218483465061');" onmouseout="out('7043079218483465061');" style=""> 266     protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {                 </span>
<span class="-4146438378303178005" onmouseenter="enter('-4146438378303178005');" onmouseout="out('-4146438378303178005');" style=""> 267         Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();                    </span>
<span class="7927037930311470382" onmouseenter="enter('7927037930311470382');" onmouseout="out('7927037930311470382');" style=""> 268         Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();                      </span>
<span  style=""> 269                                                                                                          </span>
<span class="-1625160164833054598" onmouseenter="enter('-1625160164833054598');" onmouseout="out('-1625160164833054598');" style=""> 270         if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {                              </span>
<span class="-7027301438537880380" onmouseenter="enter('-7027301438537880380');" onmouseout="out('-7027301438537880380');" style=""> 271             promotableOrder.removeAllCandidateItemOfferAdjustments();                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 272         } else {                                                                                         </span>
<span class="6517108348190993777" onmouseenter="enter('6517108348190993777');" onmouseout="out('6517108348190993777');" style=""> 273             promotableOrder.removeAllCandidateOrderOfferAdjustments();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275     }                                                                                                    </span>
<span  style=""> 276                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 277     /**                                                                                                  </span>
<span class="-6223401290020760984" onmouseenter="enter('-6223401290020760984');" onmouseout="out('-6223401290020760984');" style=""> 278      * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer</span>
<span class="6836988226136200872" onmouseenter="enter('6836988226136200872');" onmouseout="out('6836988226136200872');" style=""> 279      * and associates the OrderAdjustment to the Order.                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 280      *                                                                                                   </span>
<span class="6951516900174217638" onmouseenter="enter('6951516900174217638');" onmouseout="out('6951516900174217638');" style=""> 281      * @param orderOffer a CandidateOrderOffer to apply to an Order                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 282      */                                                                                                  </span>
<span class="-1056565336427362312" onmouseenter="enter('-1056565336427362312');" onmouseout="out('-1056565336427362312');" style=""><abbr title=" 283     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {"> 283     protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOfðŸ”µ</abbr></span>
<span class="-3917047491438167754" onmouseenter="enter('-3917047491438167754');" onmouseout="out('-3917047491438167754');" style=""><abbr title=" 284         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 284         PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderðŸ”µ</abbr></span>
<span class="2459651529956168438" onmouseenter="enter('2459651529956168438');" onmouseout="out('2459651529956168438');" style=""> 285         promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 286     }                                                                                                    </span>
<span  style=""> 287                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 288     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 289     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 290         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291     }                                                                                                    </span>
<span  style=""> 292                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 293     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 294     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 295         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296     }                                                                                                    </span>
<span  style=""> 297                                                                                                          </span>
<span class="-7694825550100150639" onmouseenter="enter('-7694825550100150639');" onmouseout="out('-7694825550100150639');" style=""><abbr title=" 298     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 298     protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder proðŸ”µ</abbr></span>
<span class="-2272462204816182006" onmouseenter="enter('-2272462204816182006');" onmouseout="out('-2272462204816182006');" style=""><abbr title=" 299         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();"> 299         Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustmentðŸ”µ</abbr></span>
<span class="-7354354578377701904" onmouseenter="enter('-7354354578377701904');" onmouseout="out('-7354354578377701904');" style=""> 300         for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {    </span>
<span class="-7366330237630024028" onmouseenter="enter('-7366330237630024028');" onmouseout="out('-7366330237630024028');" style=""> 301             adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302         }                                                                                                </span>
<span class="7908136136791584596" onmouseenter="enter('7908136136791584596');" onmouseout="out('7908136136791584596');" style=""> 303         return adjustmentsMap;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304     }                                                                                                    </span>
<span  style=""> 305                                                                                                          </span>
<span class="8556164244366976053" onmouseenter="enter('8556164244366976053');" onmouseout="out('8556164244366976053');" style=""> 306     protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {                        </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 307         Order order = promotableOrder.getOrder();                                                        </span>
<span class="-6033320157511533636" onmouseenter="enter('-6033320157511533636');" onmouseout="out('-6033320157511533636');" style=""><abbr title=" 308         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {"> 308         if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 309             return;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310         }                                                                                                </span>
<span class="-926001645706785786" onmouseenter="enter('-926001645706785786');" onmouseout="out('-926001645706785786');" style=""><abbr title=" 311         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 311         Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promoðŸ”µ</abbr></span>
<span class="3944053196731100643" onmouseenter="enter('3944053196731100643');" onmouseout="out('3944053196731100643');" style=""> 312         Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();             </span>
<span class="6446254784470090633" onmouseenter="enter('6446254784470090633');" onmouseout="out('6446254784470090633');" style=""> 313         while (orderAdjIterator.hasNext()) {                                                             </span>
<span class="8379122835997548797" onmouseenter="enter('8379122835997548797');" onmouseout="out('8379122835997548797');" style=""> 314             OrderAdjustment adjustment = orderAdjIterator.next();                                        </span>
<span class="-4215374844081079628" onmouseenter="enter('-4215374844081079628');" onmouseout="out('-4215374844081079628');" style=""> 315             if (adjustment.getOffer() != null) {                                                         </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 316                 Long offerId = adjustment.getOffer().getId();                                            </span>
<span class="5819609577497737127" onmouseenter="enter('5819609577497737127');" onmouseout="out('5819609577497737127');" style=""> 317                 PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);      </span>
<span class="6490885699345008591" onmouseenter="enter('6490885699345008591');" onmouseout="out('6490885699345008591');" style=""> 318                 if (promotableAdjustment != null) {                                                      </span>
<span class="8069062196406007718" onmouseenter="enter('8069062196406007718');" onmouseout="out('8069062196406007718');" style=""> 319                     updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 320                 } else {                                                                                 </span>
<span class="4531906782810290485" onmouseenter="enter('4531906782810290485');" onmouseout="out('4531906782810290485');" style=""> 321                     // No longer using this order adjustment, remove it.                                 </span>
<span class="-8642473006560883902" onmouseenter="enter('-8642473006560883902');" onmouseout="out('-8642473006560883902');" style=""> 322                     orderAdjIterator.remove();                                                           </span>
<span class="808032765038092054" onmouseenter="enter('808032765038092054');" onmouseout="out('808032765038092054');" style=""> 323                     entityService.remove(adjustment);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 324                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 325             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326         }                                                                                                </span>
<span class="9053649251777837824" onmouseenter="enter('9053649251777837824');" onmouseout="out('9053649251777837824');" style=""> 327         for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {         </span>
<span class="8948825633726878072" onmouseenter="enter('8948825633726878072');" onmouseout="out('8948825633726878072');" style=""> 328             // Add the newly introduced adjustments.                                                     </span>
<span class="-1742313644800837850" onmouseenter="enter('-1742313644800837850');" onmouseout="out('-1742313644800837850');" style=""> 329             Offer offer = promotableOrderAdjustment.getOffer();                                          </span>
<span class="1325997209783346162" onmouseenter="enter('1325997209783346162');" onmouseout="out('1325997209783346162');" style=""> 330             OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();                          </span>
<span class="-6738057894981368691" onmouseenter="enter('-6738057894981368691');" onmouseout="out('-6738057894981368691');" style=""> 331             orderAdjustment.init(order, offer, offer.getName());                                         </span>
<span class="-770736347184914897" onmouseenter="enter('-770736347184914897');" onmouseout="out('-770736347184914897');" style=""> 332             orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());                    </span>
<span class="-1853577329694264316" onmouseenter="enter('-1853577329694264316');" onmouseout="out('-1853577329694264316');" style=""> 333             order.getOrderAdjustments().add(orderAdjustment);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335     }                                                                                                    </span>
<span  style=""> 336                                                                                                          </span>
<span class="7254378221303205454" onmouseenter="enter('7254378221303205454');" onmouseout="out('7254378221303205454');" style=""><abbr title=" 337     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 337     protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustmenðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 338         Long offerId = adjustment.getOffer().getId();                                                    </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style=""> 339         if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {                  </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 340             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="6959375956364920547" onmouseenter="enter('6959375956364920547');" onmouseout="out('6959375956364920547');" style=""><abbr title=" 341                 LOG.debug(((&quot;Updating value for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + promotableAdjustment.getAdjustmentValue());"> 341                 LOG.debug(((&quot;Updating value for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + pðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 342             }                                                                                            </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style=""> 343             adjustment.setValue(promotableAdjustment.getAdjustmentValue());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344         }                                                                                                </span>
<span class="734930962553645377" onmouseenter="enter('734930962553645377');" onmouseout="out('734930962553645377');" style=""> 345         if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {     </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 346             if (LOG.isDebugEnabled()) {                                                                  </span>
<span class="-1157004103351245861" onmouseenter="enter('-1157004103351245861');" onmouseout="out('-1157004103351245861');" style=""><abbr title=" 347                 LOG.debug(((&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId) + &quot; to &quot;) + promotableAdjustment.isFutureCredit());"> 347                 LOG.debug(((&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId) + &quot; ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348             }                                                                                            </span>
<span class="-1212224207609501002" onmouseenter="enter('-1212224207609501002');" onmouseout="out('-1212224207609501002');" style=""> 349             adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 350         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 351     }                                                                                                    </span>
<span  style=""> 352                                                                                                          </span>
<span class="4939686944790593089" onmouseenter="enter('4939686944790593089');" onmouseout="out('4939686944790593089');" style=""> 353     protected void synchronizeOrderItems(PromotableOrder promotableOrder) {                              </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 354         Order order = promotableOrder.getOrder();                                                        </span>
<span class="8870411702953196775" onmouseenter="enter('8870411702953196775');" onmouseout="out('8870411702953196775');" style=""><abbr title=" 355         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 355         Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemðŸ”µ</abbr></span>
<span  style=""> 356                                                                                                          </span>
<span class="45393343966675502" onmouseenter="enter('45393343966675502');" onmouseout="out('45393343966675502');" style=""> 357         List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);                 </span>
<span  style=""> 358                                                                                                          </span>
<span class="-3971897302215245898" onmouseenter="enter('-3971897302215245898');" onmouseout="out('-3971897302215245898');" style=""> 359         for (OrderItem orderItem : orderItemList) {                                                      </span>
<span class="-3227733123108723187" onmouseenter="enter('-3227733123108723187');" onmouseout="out('-3227733123108723187');" style=""> 360             PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);                       </span>
<span class="-7181450714367096357" onmouseenter="enter('-7181450714367096357');" onmouseout="out('-7181450714367096357');" style=""> 361             if (promotableItem == null) {                                                                </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 362                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 363             }                                                                                            </span>
<span class="-4627052923559624390" onmouseenter="enter('-4627052923559624390');" onmouseout="out('-4627052923559624390');" style=""> 364             synchronizeItemPriceDetails(orderItem, promotableItem);                                      </span>
<span class="-6035169113045010952" onmouseenter="enter('-6035169113045010952');" onmouseout="out('-6035169113045010952');" style=""> 365             synchronizeItemQualifiers(orderItem, promotableItem);                                        </span>
<span  style=""> 366                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 367         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 368     }                                                                                                    </span>
<span  style=""> 369                                                                                                          </span>
<span class="4641946456273473515" onmouseenter="enter('4641946456273473515');" onmouseout="out('4641946456273473515');" style=""><abbr title=" 370     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 370     protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItðŸ”µ</abbr></span>
<span class="8574464637260302488" onmouseenter="enter('8574464637260302488');" onmouseout="out('8574464637260302488');" style=""><abbr title=" 371         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 371         Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promðŸ”µ</abbr></span>
<span class="-6342291150701367795" onmouseenter="enter('-6342291150701367795');" onmouseout="out('-6342291150701367795');" style=""> 372         Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;(); </span>
<span  style=""> 373                                                                                                          </span>
<span class="-4767625469055938064" onmouseenter="enter('-4767625469055938064');" onmouseout="out('-4767625469055938064');" style=""> 374         for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {         </span>
<span class="5353286555635618569" onmouseenter="enter('5353286555635618569');" onmouseout="out('5353286555635618569');" style=""> 375             String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);                            </span>
<span class="-2878152675586990901" onmouseenter="enter('-2878152675586990901');" onmouseout="out('-2878152675586990901');" style=""> 376             PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);    </span>
<span class="5988062476356282201" onmouseenter="enter('5988062476356282201');" onmouseout="out('5988062476356282201');" style=""> 377             if (promotableDetail != null) {                                                              </span>
<span class="-2745140720553978382" onmouseenter="enter('-2745140720553978382');" onmouseout="out('-2745140720553978382');" style=""> 378                 processMatchingDetails(orderItemPriceDetail, promotableDetail);                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 379             } else {                                                                                     </span>
<span class="-8641070025229307801" onmouseenter="enter('-8641070025229307801');" onmouseout="out('-8641070025229307801');" style=""> 380                 unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 382         }                                                                                                </span>
<span  style=""> 383                                                                                                          </span>
<span class="-2102992530504048935" onmouseenter="enter('-2102992530504048935');" onmouseout="out('-2102992530504048935');" style=""><abbr title=" 384         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();"> 384         Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator()ðŸ”µ</abbr></span>
<span  style=""> 385                                                                                                          </span>
<span class="3655839919190900579" onmouseenter="enter('3655839919190900579');" onmouseout="out('3655839919190900579');" style=""> 386         for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {               </span>
<span class="848025138552610797" onmouseenter="enter('848025138552610797');" onmouseout="out('848025138552610797');" style=""> 387             if (unmatchedDetailsIterator.hasNext()) {                                                    </span>
<span class="-1286995204662994700" onmouseenter="enter('-1286995204662994700');" onmouseout="out('-1286995204662994700');" style=""> 388                 // Reuse an existing priceDetail                                                         </span>
<span class="-6274362249453165217" onmouseenter="enter('-6274362249453165217');" onmouseout="out('-6274362249453165217');" style=""> 389                 OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();                   </span>
<span  style=""> 390                                                                                                          </span>
<span class="8785556757346701489" onmouseenter="enter('8785556757346701489');" onmouseout="out('8785556757346701489');" style=""> 391                 // Reset use Sale flag to true                                                           </span>
<span class="-4586757194387339116" onmouseenter="enter('-4586757194387339116');" onmouseout="out('-4586757194387339116');" style=""> 392                 existingDetail.setUseSalePrice(true);                                                    </span>
<span  style=""> 393                                                                                                          </span>
<span class="7880433973363830475" onmouseenter="enter('7880433973363830475');" onmouseout="out('7880433973363830475');" style=""> 394                 offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);                    </span>
<span class="9163760465604163202" onmouseenter="enter('9163760465604163202');" onmouseout="out('9163760465604163202');" style=""> 395                 unmatchedDetailsIterator.remove();                                                       </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 396             } else {                                                                                     </span>
<span class="-3751890412067657497" onmouseenter="enter('-3751890412067657497');" onmouseout="out('-3751890412067657497');" style=""> 397                 // Create a new priceDetail                                                              </span>
<span class="-1690864448011816688" onmouseenter="enter('-1690864448011816688');" onmouseout="out('-1690864448011816688');" style=""> 398                 OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();         </span>
<span class="-3940721081423400252" onmouseenter="enter('-3940721081423400252');" onmouseout="out('-3940721081423400252');" style=""> 399                 newPriceDetail.setOrderItem(orderItem);                                                  </span>
<span class="-2358509328501908297" onmouseenter="enter('-2358509328501908297');" onmouseout="out('-2358509328501908297');" style=""> 400                 offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);                    </span>
<span class="7726531521682039639" onmouseenter="enter('7726531521682039639');" onmouseout="out('7726531521682039639');" style=""> 401                 orderItem.getOrderItemPriceDetails().add(newPriceDetail);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403         }                                                                                                </span>
<span  style=""> 404                                                                                                          </span>
<span class="5078704746315005492" onmouseenter="enter('5078704746315005492');" onmouseout="out('5078704746315005492');" style=""> 405         // Remove any unmatched details                                                                  </span>
<span class="-596985917041158168" onmouseenter="enter('-596985917041158168');" onmouseout="out('-596985917041158168');" style=""> 406         Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();     </span>
<span class="-2348069803911125145" onmouseenter="enter('-2348069803911125145');" onmouseout="out('-2348069803911125145');" style=""> 407         offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 408     }                                                                                                    </span>
<span  style=""> 409                                                                                                          </span>
<span class="-3359465330409353741" onmouseenter="enter('-3359465330409353741');" onmouseout="out('-3359465330409353741');" style=""><abbr title=" 410     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {"> 410     protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItemðŸ”µ</abbr></span>
<span class="6939567773624847901" onmouseenter="enter('6939567773624847901');" onmouseout="out('6939567773624847901');" style=""> 411         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem); </span>
<span class="-838353671554643485" onmouseenter="enter('-838353671554643485');" onmouseout="out('-838353671554643485');" style=""> 412         Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();  </span>
<span  style=""> 413                                                                                                          </span>
<span class="6539711029953657105" onmouseenter="enter('6539711029953657105');" onmouseout="out('6539711029953657105');" style=""> 414         for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {               </span>
<span class="2428508324486494962" onmouseenter="enter('2428508324486494962');" onmouseout="out('2428508324486494962');" style=""><abbr title=" 415             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId());"> 415             PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().gðŸ”µ</abbr></span>
<span class="-4549367717464072284" onmouseenter="enter('-4549367717464072284');" onmouseout="out('-4549367717464072284');" style=""> 416             if (promotableQualifier != null) {                                                           </span>
<span class="-5773466494614436024" onmouseenter="enter('-5773466494614436024');" onmouseout="out('-5773466494614436024');" style=""> 417                 // Offer was used as a qualifier on previous run.   Update quantity if needed.           </span>
<span class="-3775165376026668506" onmouseenter="enter('-3775165376026668506');" onmouseout="out('-3775165376026668506');" style=""> 418                 if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {             </span>
<span class="6319516500536721656" onmouseenter="enter('6319516500536721656');" onmouseout="out('6319516500536721656');" style=""> 419                     orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 420                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 421             } else {                                                                                     </span>
<span class="-7107745465096608003" onmouseenter="enter('-7107745465096608003');" onmouseout="out('-7107745465096608003');" style=""> 422                 unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 424         }                                                                                                </span>
<span  style=""> 425                                                                                                          </span>
<span class="6412010879861386561" onmouseenter="enter('6412010879861386561');" onmouseout="out('6412010879861386561');" style=""><abbr title=" 426         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();"> 426         Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iteratðŸ”µ</abbr></span>
<span  style=""> 427                                                                                                          </span>
<span class="-5367673967409602220" onmouseenter="enter('-5367673967409602220');" onmouseout="out('-5367673967409602220');" style=""> 428         for (PromotionQualifier qualifier : qualifiersMap.values()) {                                    </span>
<span class="4352951882445574614" onmouseenter="enter('4352951882445574614');" onmouseout="out('4352951882445574614');" style=""> 429             if (unmatchedQualifiersIterator.hasNext()) {                                                 </span>
<span class="916500832219535438" onmouseenter="enter('916500832219535438');" onmouseout="out('916500832219535438');" style=""> 430                 // Reuse an existing qualifier                                                           </span>
<span class="-457617571898655971" onmouseenter="enter('-457617571898655971');" onmouseout="out('-457617571898655971');" style=""> 431                 OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();               </span>
<span class="-9191122370911430740" onmouseenter="enter('-9191122370911430740');" onmouseout="out('-9191122370911430740');" style=""> 432                 existingQualifier.setOffer(qualifier.getPromotion());                                    </span>
<span class="-5418424828849751920" onmouseenter="enter('-5418424828849751920');" onmouseout="out('-5418424828849751920');" style=""> 433                 existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                    </span>
<span class="-2784197009200988946" onmouseenter="enter('-2784197009200988946');" onmouseout="out('-2784197009200988946');" style=""> 434                 unmatchedQualifiersIterator.remove();                                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 435             } else {                                                                                     </span>
<span class="-4600119951921754996" onmouseenter="enter('-4600119951921754996');" onmouseout="out('-4600119951921754996');" style=""> 436                 // Create a new qualifier                                                                </span>
<span class="2495734798245487562" onmouseenter="enter('2495734798245487562');" onmouseout="out('2495734798245487562');" style=""> 437                 OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();               </span>
<span class="-7776554329531977433" onmouseenter="enter('-7776554329531977433');" onmouseout="out('-7776554329531977433');" style=""> 438                 newQualifier.setOrderItem(orderItem);                                                    </span>
<span class="-7457838790114620282" onmouseenter="enter('-7457838790114620282');" onmouseout="out('-7457838790114620282');" style=""> 439                 newQualifier.setOffer(qualifier.getPromotion());                                         </span>
<span class="35194467054568730" onmouseenter="enter('35194467054568730');" onmouseout="out('35194467054568730');" style=""> 440                 newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                         </span>
<span class="-7418439022636140038" onmouseenter="enter('-7418439022636140038');" onmouseout="out('-7418439022636140038');" style=""> 441                 orderItem.getOrderItemQualifiers().add(newQualifier);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443         }                                                                                                </span>
<span  style=""> 444                                                                                                          </span>
<span class="5791534705407165022" onmouseenter="enter('5791534705407165022');" onmouseout="out('5791534705407165022');" style=""> 445         // Remove any unmatched qualifiers                                                               </span>
<span class="-8561007497302660099" onmouseenter="enter('-8561007497302660099');" onmouseout="out('-8561007497302660099');" style=""> 446         Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();          </span>
<span class="760711543792628805" onmouseenter="enter('760711543792628805');" onmouseout="out('760711543792628805');" style=""> 447         offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 448     }                                                                                                    </span>
<span  style=""> 449                                                                                                          </span>
<span class="6872064960056917626" onmouseenter="enter('6872064960056917626');" onmouseout="out('6872064960056917626');" style=""> 450     protected void processMatchingDetails(OrderItemPriceDetail itemDetail,                               </span>
<span class="59795375183189524" onmouseenter="enter('59795375183189524');" onmouseout="out('59795375183189524');" style=""> 451             PromotableOrderItemPriceDetail promotableItemDetail) {                                       </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 452         Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                    </span>
<span class="7510782226240613992" onmouseenter="enter('7510782226240613992');" onmouseout="out('7510782226240613992');" style=""> 453                 offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);                          </span>
<span  style=""> 454                                                                                                          </span>
<span class="-750959101585099141" onmouseenter="enter('-750959101585099141');" onmouseout="out('-750959101585099141');" style=""> 455         if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {                            </span>
<span class="-3259655613865435165" onmouseenter="enter('-3259655613865435165');" onmouseout="out('-3259655613865435165');" style=""> 456             itemDetail.setQuantity(promotableItemDetail.getQuantity());                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457         }                                                                                                </span>
<span  style=""> 458                                                                                                          </span>
<span class="9218754308308575613" onmouseenter="enter('9218754308308575613');" onmouseout="out('9218754308308575613');" style=""><abbr title=" 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 459         for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAðŸ”µ</abbr></span>
<span class="2783281510413095088" onmouseenter="enter('2783281510413095088');" onmouseout="out('2783281510413095088');" style=""><abbr title=" 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());"> 460             OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId()ðŸ”µ</abbr></span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 461             if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                    </span>
<span class="-4842011616043597197" onmouseenter="enter('-4842011616043597197');" onmouseout="out('-4842011616043597197');" style=""> 462                 itemAdjustment.setValue(adjustment.getAdjustmentValue());                                </span>
<span class="-5695031583799398466" onmouseenter="enter('-5695031583799398466');" onmouseout="out('-5695031583799398466');" style=""> 463                 itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466     }                                                                                                    </span>
<span  style=""> 467                                                                                                          </span>
<span class="4651274540478945566" onmouseenter="enter('4651274540478945566');" onmouseout="out('4651274540478945566');" style=""> 468     protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {                          </span>
<span class="1883813639191860394" onmouseenter="enter('1883813639191860394');" onmouseout="out('1883813639191860394');" style=""> 469         List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();                                                     </span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""><abbr title=" 470         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {"> 470         for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments())ðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 471             Long offerId = adjustment.getOffer().getId();                                                </span>
<span class="-11608270007353255" onmouseenter="enter('-11608270007353255');" onmouseout="out('-11608270007353255');" style=""> 472             offerIds.add(offerId);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473         }                                                                                                </span>
<span class="-5651075727196406737" onmouseenter="enter('-5651075727196406737');" onmouseout="out('-5651075727196406737');" style=""> 474         Collections.sort(offerIds);                                                                      </span>
<span class="5891357179043449296" onmouseenter="enter('5891357179043449296');" onmouseout="out('5891357179043449296');" style=""> 475         return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();</span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476     }                                                                                                    </span>
<span  style=""> 477                                                                                                          </span>
<span class="-6813037055353877100" onmouseenter="enter('-6813037055353877100');" onmouseout="out('-6813037055353877100');" style=""><abbr title=" 478     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {"> 478     protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem iðŸ”µ</abbr></span>
<span class="-5863956661369186771" onmouseenter="enter('-5863956661369186771');" onmouseout="out('-5863956661369186771');" style=""><abbr title=" 479         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 479         Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPðŸ”µ</abbr></span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 480         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4172210863560606018" onmouseenter="enter('-4172210863560606018');" onmouseout="out('-4172210863560606018');" style=""> 481             detailsMap.put(detail.buildDetailKey(), detail);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 482         }                                                                                                </span>
<span class="1985757738719514214" onmouseenter="enter('1985757738719514214');" onmouseout="out('1985757738719514214');" style=""> 483         return detailsMap;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484     }                                                                                                    </span>
<span  style=""> 485                                                                                                          </span>
<span class="-3836724244114507356" onmouseenter="enter('-3836724244114507356');" onmouseout="out('-3836724244114507356');" style=""> 486     protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {     </span>
<span class="-1925492436839506759" onmouseenter="enter('-1925492436839506759');" onmouseout="out('-1925492436839506759');" style=""> 487         Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();           </span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 488         for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {        </span>
<span class="-4593166378473264356" onmouseenter="enter('-4593166378473264356');" onmouseout="out('-4593166378473264356');" style=""> 489             for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {                       </span>
<span class="3842824965672319387" onmouseenter="enter('3842824965672319387');" onmouseout="out('3842824965672319387');" style=""><abbr title=" 490                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());"> 490                 PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId()ðŸ”µ</abbr></span>
<span class="-8569849509682320504" onmouseenter="enter('-8569849509682320504');" onmouseout="out('-8569849509682320504');" style=""> 491                 if (existingQualifier != null) {                                                         </span>
<span class="-4445010116162684270" onmouseenter="enter('-4445010116162684270');" onmouseout="out('-4445010116162684270');" style=""><abbr title=" 492                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());"> 492                     existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantityðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 493                 } else {                                                                                 </span>
<span class="-8046901564682421602" onmouseenter="enter('-8046901564682421602');" onmouseout="out('-8046901564682421602');" style=""> 494                     qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497         }                                                                                                </span>
<span class="4699150655190374848" onmouseenter="enter('4699150655190374848');" onmouseout="out('4699150655190374848');" style=""> 498         return qualifiersMap;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499     }                                                                                                    </span>
<span  style=""> 500                                                                                                          </span>
<span class="6650489462588239331" onmouseenter="enter('6650489462588239331');" onmouseout="out('6650489462588239331');" style=""> 501     protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {                       </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 502         Order order = promotableOrder.getOrder();                                                        </span>
<span class="6561763597022577240" onmouseenter="enter('6561763597022577240');" onmouseout="out('6561763597022577240');" style=""><abbr title=" 503         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);"> 503         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder)ðŸ”µ</abbr></span>
<span class="6990956658692188299" onmouseenter="enter('6990956658692188299');" onmouseout="out('6990956658692188299');" style=""> 504         boolean syncNeededOnTotal = false;                                                               </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 505         for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                       </span>
<span class="-439733037564232612" onmouseenter="enter('-439733037564232612');" onmouseout="out('-439733037564232612');" style=""> 506             synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));                           </span>
<span class="3630381949999328071" onmouseenter="enter('3630381949999328071');" onmouseout="out('3630381949999328071');" style=""> 507             boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);                                   </span>
<span class="6204032096114591207" onmouseenter="enter('6204032096114591207');" onmouseout="out('6204032096114591207');" style=""> 508             if (syncNeeded) {                                                                            </span>
<span class="-6169259820846196761" onmouseenter="enter('-6169259820846196761');" onmouseout="out('-6169259820846196761');" style=""> 509                 syncFulfillmentPrice(fg);                                                                </span>
<span class="-2299678048386624818" onmouseenter="enter('-2299678048386624818');" onmouseout="out('-2299678048386624818');" style=""> 510                 syncNeededOnTotal = true;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512         }                                                                                                </span>
<span class="-5450932785890013448" onmouseenter="enter('-5450932785890013448');" onmouseout="out('-5450932785890013448');" style=""> 513         if (syncNeededOnTotal) {                                                                         </span>
<span class="-8777873539377505153" onmouseenter="enter('-8777873539377505153');" onmouseout="out('-8777873539377505153');" style=""> 514             Money syncFulfillmentPrice = Money.ZERO;                                                     </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 515             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-5396558836391507485" onmouseenter="enter('-5396558836391507485');" onmouseout="out('-5396558836391507485');" style=""> 516                 syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517             }                                                                                            </span>
<span class="-4866549136483611279" onmouseenter="enter('-4866549136483611279');" onmouseout="out('-4866549136483611279');" style=""> 518             order.setTotalFulfillmentCharges(syncFulfillmentPrice);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 520     }                                                                                                    </span>
<span  style=""> 521                                                                                                          </span>
<span class="2663354164110279617" onmouseenter="enter('2663354164110279617');" onmouseout="out('2663354164110279617');" style=""> 522     protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {                            </span>
<span class="-1122908714199440396" onmouseenter="enter('-1122908714199440396');" onmouseout="out('-1122908714199440396');" style=""> 523         return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524     }                                                                                                    </span>
<span  style=""> 525                                                                                                          </span>
<span class="-1055395477678850539" onmouseenter="enter('-1055395477678850539');" onmouseout="out('-1055395477678850539');" style=""> 526     protected void syncFulfillmentPrice(FulfillmentGroup fg) {                                           </span>
<span class="6421033897115001406" onmouseenter="enter('6421033897115001406');" onmouseout="out('6421033897115001406');" style=""> 527         Money retailPrice = fg.getRetailFulfillmentPrice();                                              </span>
<span class="2458814602568234661" onmouseenter="enter('2458814602568234661');" onmouseout="out('2458814602568234661');" style=""> 528         Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();  </span>
<span class="-5014608312607866780" onmouseenter="enter('-5014608312607866780');" onmouseout="out('-5014608312607866780');" style=""> 529         Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);    </span>
<span  style=""> 530                                                                                                          </span>
<span class="723442610052021445" onmouseenter="enter('723442610052021445');" onmouseout="out('723442610052021445');" style=""> 531         fg.setFulfillmentPrice(fulfillmentPrice);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532     }                                                                                                    </span>
<span  style=""> 533                                                                                                          </span>
<span class="-613491293141460653" onmouseenter="enter('-613491293141460653');" onmouseout="out('-613491293141460653');" style=""><abbr title=" 534     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {"> 534     protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder orðŸ”µ</abbr></span>
<span class="-2168953774981447317" onmouseenter="enter('-2168953774981447317');" onmouseout="out('-2168953774981447317');" style=""> 535         Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();   </span>
<span class="-1134830134613695083" onmouseenter="enter('-1134830134613695083');" onmouseout="out('-1134830134613695083');" style=""> 536         for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {                             </span>
<span class="-3822470075223000180" onmouseenter="enter('-3822470075223000180');" onmouseout="out('-3822470075223000180');" style=""> 537             fgMap.put(fg.getFulfillmentGroup().getId(), fg);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 539         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 540     }                                                                                                    </span>
<span  style=""> 541                                                                                                          </span>
<span class="6665195593296681168" onmouseenter="enter('6665195593296681168');" onmouseout="out('6665195593296681168');" style=""><abbr title=" 542     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 542     protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfilðŸ”µ</abbr></span>
<span class="-7214313390686800174" onmouseenter="enter('-7214313390686800174');" onmouseout="out('-7214313390686800174');" style=""><abbr title=" 543         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 543         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGrðŸ”µ</abbr></span>
<span class="331019091121439684" onmouseenter="enter('331019091121439684');" onmouseout="out('331019091121439684');" style=""><abbr title=" 544         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {"> 544         for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustmentsðŸ”µ</abbr></span>
<span class="1110980486512930755" onmouseenter="enter('1110980486512930755');" onmouseout="out('1110980486512930755');" style=""><abbr title=" 545             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);"> 545             fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 546         }                                                                                                </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 547         return fgMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548     }                                                                                                    </span>
<span  style=""> 549                                                                                                          </span>
<span class="-7617178904345879788" onmouseenter="enter('-7617178904345879788');" onmouseout="out('-7617178904345879788');" style=""><abbr title=" 550     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 550     protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroupðŸ”µ</abbr></span>
<span class="1705100339866591039" onmouseenter="enter('1705100339866591039');" onmouseout="out('1705100339866591039');" style=""><abbr title=" 551         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator();"> 551         Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iteðŸ”µ</abbr></span>
<span class="6869467232437188017" onmouseenter="enter('6869467232437188017');" onmouseout="out('6869467232437188017');" style=""><abbr title=" 552         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 552         Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(proðŸ”µ</abbr></span>
<span class="7622903297016040666" onmouseenter="enter('7622903297016040666');" onmouseout="out('7622903297016040666');" style=""> 553         // First try and update existing adjustment records                                              </span>
<span class="6593219943708493598" onmouseenter="enter('6593219943708493598');" onmouseout="out('6593219943708493598');" style=""> 554         while (adjustmentIterator.hasNext()) {                                                           </span>
<span class="5134089875457655542" onmouseenter="enter('5134089875457655542');" onmouseout="out('5134089875457655542');" style=""> 555             FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();                           </span>
<span class="9090174154450682409" onmouseenter="enter('9090174154450682409');" onmouseout="out('9090174154450682409');" style=""><abbr title=" 556             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId());"> 556             PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().gðŸ”µ</abbr></span>
<span class="7739365516519203047" onmouseenter="enter('7739365516519203047');" onmouseout="out('7739365516519203047');" style=""> 557             if (newAdj != null) {                                                                        </span>
<span class="5102959516436064847" onmouseenter="enter('5102959516436064847');" onmouseout="out('5102959516436064847');" style=""> 558                 if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {                        </span>
<span class="-6634291412355259187" onmouseenter="enter('-6634291412355259187');" onmouseout="out('-6634291412355259187');" style=""> 559                     // Update the currentAdj.                                                            </span>
<span class="-4755037759892167947" onmouseenter="enter('-4755037759892167947');" onmouseout="out('-4755037759892167947');" style=""> 560                     currentAdj.setValue(newAdj.getAdjustmentValue());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 561                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 562             } else {                                                                                     </span>
<span class="-5437992937664131712" onmouseenter="enter('-5437992937664131712');" onmouseout="out('-5437992937664131712');" style=""> 563                 // Removing no longer valid adjustment                                                   </span>
<span class="-6800144716907845476" onmouseenter="enter('-6800144716907845476');" onmouseout="out('-6800144716907845476');" style=""> 564                 adjustmentIterator.remove();                                                             </span>
<span class="855814523852624000" onmouseenter="enter('855814523852624000');" onmouseout="out('855814523852624000');" style=""> 565                 entityService.remove(currentAdj);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 567         }                                                                                                </span>
<span class="4911772249630101500" onmouseenter="enter('4911772249630101500');" onmouseout="out('4911772249630101500');" style=""> 568         // Now add missing adjustments                                                                   </span>
<span class="8170167194272017979" onmouseenter="enter('8170167194272017979');" onmouseout="out('8170167194272017979');" style=""> 569         for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {                  </span>
<span class="-4188265609244912176" onmouseenter="enter('-4188265609244912176');" onmouseout="out('-4188265609244912176');" style=""> 570             FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();                 </span>
<span class="3068706828930127416" onmouseenter="enter('3068706828930127416');" onmouseout="out('3068706828930127416');" style=""> 571             fa.setFulfillmentGroup(fg);                                                                  </span>
<span class="5392928859383582349" onmouseenter="enter('5392928859383582349');" onmouseout="out('5392928859383582349');" style=""> 572             fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);          </span>
<span class="4727884307924071496" onmouseenter="enter('4727884307924071496');" onmouseout="out('4727884307924071496');" style=""> 573             fa.setValue(newAdj.getAdjustmentValue());                                                    </span>
<span class="-1586043412444283157" onmouseenter="enter('-1586043412444283157');" onmouseout="out('-1586043412444283157');" style=""> 574             fg.getFulfillmentGroupAdjustments().add(fa);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 576     }                                                                                                    </span>
<span  style=""> 577                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 578     @Override                                                                                            </span>
<span class="-4816910989941817274" onmouseenter="enter('-4816910989941817274');" onmouseout="out('-4816910989941817274');" style=""> 579     public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {                       </span>
<span class="-3850751249412137645" onmouseenter="enter('-3850751249412137645');" onmouseout="out('-3850751249412137645');" style=""> 580         synchronizeOrderAdjustments(promotableOrder);                                                    </span>
<span class="4518036952510487894" onmouseenter="enter('4518036952510487894');" onmouseout="out('4518036952510487894');" style=""> 581         synchronizeOrderItems(promotableOrder);                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 582         if (extensionManager != null) {                                                                  </span>
<span class="-6179159556176464024" onmouseenter="enter('-6179159556176464024');" onmouseout="out('-6179159556176464024');" style=""> 583             extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 584         }                                                                                                </span>
<span class="-159866277563841870" onmouseenter="enter('-159866277563841870');" onmouseout="out('-159866277563841870');" style=""> 585         synchronizeFulfillmentGroups(promotableOrder);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586     }                                                                                                    </span>
<span  style=""> 587                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 588     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 589     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 590         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 591     }                                                                                                    </span>
<span  style=""> 592                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 593     @Override                                                                                            </span>
<span class="6530687858988053885" onmouseenter="enter('6530687858988053885');" onmouseout="out('6530687858988053885');" style=""> 594     public void setOrderItemDao(OrderItemDao orderItemDao) {                                             </span>
<span class="-8374754321118159364" onmouseenter="enter('-8374754321118159364');" onmouseout="out('-8374754321118159364');" style=""> 595         this.orderItemDao = orderItemDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 596     }                                                                                                    </span>
<span  style=""> 597                                                                                                          </span>
<span class="-6632247919309783023" onmouseenter="enter('-6632247919309783023');" onmouseout="out('-6632247919309783023');" style=""> 598     public OfferServiceUtilities getOfferServiceUtilities() {                                            </span>
<span class="-6406517936839827979" onmouseenter="enter('-6406517936839827979');" onmouseout="out('-6406517936839827979');" style=""> 599         return offerServiceUtilities;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600     }                                                                                                    </span>
<span  style=""> 601                                                                                                          </span>
<span class="4442139862126007445" onmouseenter="enter('4442139862126007445');" onmouseout="out('4442139862126007445');" style=""> 602     public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {                  </span>
<span class="4552134412879762115" onmouseenter="enter('4552134412879762115');" onmouseout="out('4552134412879762115');" style=""> 603         this.offerServiceUtilities = offerServiceUtilities;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 604     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 605 }                                                                                                        </span>



















</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-4156106492343801428" onmouseenter="enter('-4156106492343801428');" onmouseout="out('-4156106492343801428');" style="">  18  package org.broadleafcommerce.core.offer.service.processor;                                                       </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  22  import org.broadleafcommerce.common.money.Money;                                                                  </span>

<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  23  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="5599608658353832247" onmouseenter="enter('5599608658353832247');" onmouseout="out('5599608658353832247');" style="">  24  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;                                        </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  25  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  26 -import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                                 </span>
<span class="-556809404433666112" onmouseenter="enter('-556809404433666112');" onmouseout="out('-556809404433666112');" style="">  27  import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;                                                </span>
<span class="-521081291127015873" onmouseenter="enter('-521081291127015873');" onmouseout="out('-521081291127015873');" style="">  28  import org.broadleafcommerce.core.offer.domain.OrderAdjustment;                                                   </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  29  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="2599349157106653381" onmouseenter="enter('2599349157106653381');" onmouseout="out('2599349157106653381');" style="">  30  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;                                            </span>
<span class="212527052176527689" onmouseenter="enter('212527052176527689');" onmouseout="out('212527052176527689');" style="">  31  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;                                 </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  32  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                                      </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  33 -import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  34  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="4826353322748911550" onmouseenter="enter('4826353322748911550');" onmouseout="out('4826353322748911550');" style="">  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;                       </span>
<span class="-6049809183476525616" onmouseenter="enter('-6049809183476525616');" onmouseout="out('-6049809183476525616');" style="">  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;             </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="5738750158392070" onmouseenter="enter('5738750158392070');" onmouseout="out('5738750158392070');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOfferUtility;                           </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="9000862227337796749" onmouseenter="enter('9000862227337796749');" onmouseout="out('9000862227337796749');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;                        </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                              </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;                   </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;         </span>
<span class="-5253725521220244448" onmouseenter="enter('-5253725521220244448');" onmouseout="out('-5253725521220244448');" style="">  44  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;                                           </span>
<span class="1925170083501964673" onmouseenter="enter('1925170083501964673');" onmouseout="out('1925170083501964673');" style="">  45  import org.broadleafcommerce.core.offer.service.type.OfferRuleType;                                               </span>
<span class="-7012758821456487335" onmouseenter="enter('-7012758821456487335');" onmouseout="out('-7012758821456487335');" style="">  46  import org.broadleafcommerce.core.order.dao.OrderItemDao;                                                         </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  48  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  49  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  51  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                                </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  52  import org.springframework.stereotype.Service;                                                                    </span>
<span  style="">  53                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  54  import java.util.ArrayList;                                                                                       </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  55  import java.util.Collections;                                                                                     </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  56  import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  57  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  58  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  59  import java.util.Map;                                                                                             </span>
<span  style="">  60                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  61  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  62                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  63  /**                                                                                                               </span>
<span class="5097862330762959365" onmouseenter="enter('5097862330762959365');" onmouseout="out('5097862330762959365');" style="">  64   * @author jfischer, bpolster                                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65   */                                                                                                               </span>
<span class="-2245109148562763451" onmouseenter="enter('-2245109148562763451');" onmouseout="out('-2245109148562763451');" style="">  66  @Service(&quot;blOrderOfferProcessor&quot;)                                                                                 </span>
<span class="-4961554400286801245" onmouseenter="enter('-4961554400286801245');" onmouseout="out('-4961554400286801245');" style="">  67  public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {               </span>
<span  style="">  68                                                                                                                    </span>
<span class="-2801860175860773750" onmouseenter="enter('-2801860175860773750');" onmouseout="out('-2801860175860773750');" style="">  69      private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);                              </span>
<span  style="">  70                                                                                                                    </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  71      @Resource(name = &quot;blPromotableItemFactory&quot;)                                                                   </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  72      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style="">  73                                                                                                                    </span>
<span class="-2264776225690683323" onmouseenter="enter('-2264776225690683323');" onmouseout="out('-2264776225690683323');" style="">  74      @Resource(name = &quot;blOrderItemDao&quot;)                                                                            </span>
<span class="1921252040396799605" onmouseenter="enter('1921252040396799605');" onmouseout="out('1921252040396799605');" style="">  75      protected OrderItemDao orderItemDao;                                                                          </span>
<span  style="">  76                                                                                                                    </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  77      @Resource(name = &quot;blOfferDao&quot;)                                                                                </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  78      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  79                                                                                                                    </span>
<span class="2002571695049097079" onmouseenter="enter('2002571695049097079');" onmouseout="out('2002571695049097079');" style="">  80      @Resource(name = &quot;blOfferServiceUtilities&quot;)                                                                   </span>
<span class="-2602045083470320651" onmouseenter="enter('-2602045083470320651');" onmouseout="out('-2602045083470320651');" style="">  81      protected OfferServiceUtilities offerServiceUtilities;                                                        </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                                                                                                                  </span>
<span class="-2100856710351800386" onmouseenter="enter('-2100856710351800386');" onmouseout="out('-2100856710351800386');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    public OrderOfferProcessorImpl(PromotableOfferUtility promotableOfferUtility) {                               </span>
<span class="386697006679121838" onmouseenter="enter('386697006679121838');" onmouseout="out('386697006679121838');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        super(promotableOfferUtility);                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    }                                                                                                             </span>
<span  style="">  86                                                                                                                    </span>



<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  87      @Override                                                                                                     </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style=""><abbr title="  88      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  88      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiðŸ”µ</abbr></span>
<span class="-6690931251258113559" onmouseenter="enter('-6690931251258113559');" onmouseout="out('-6690931251258113559');" style="">  89          if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {                    </span>
<span class="2381861258987592021" onmouseenter="enter('2381861258987592021');" onmouseout="out('2381861258987592021');" style=""><abbr title="  90              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  90              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot;ðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="">  91              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92          }                                                                                                         </span>
<span class="-1909487068460560279" onmouseenter="enter('-1909487068460560279');" onmouseout="out('-1909487068460560279');" style="">  93          boolean orderLevelQualification = false;                                                                  </span>
<span class="-826538299394729423" onmouseenter="enter('-826538299394729423');" onmouseout="out('-826538299394729423');" style="">  94          //Order Qualification                                                                                     </span>
<span class="-5521254225981685482" onmouseenter="enter('-5521254225981685482');" onmouseout="out('-5521254225981685482');" style="">  95          orderQualification:                                                                                       </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="">  96          {                                                                                                         </span>
<span class="-7608560305899310529" onmouseenter="enter('-7608560305899310529');" onmouseout="out('-7608560305899310529');" style="">  97              if (couldOfferApplyToOrder(offer, promotableOrder)) {                                                 </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style="">  98                  orderLevelQualification = true;                                                                   </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style="">  99                  break orderQualification;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100              }                                                                                                     </span>
<span class="7444608498293955145" onmouseenter="enter('7444608498293955145');" onmouseout="out('7444608498293955145');" style=""><abbr title=" 101              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 101              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountTðŸ”µ</abbr></span>
<span class="5211303022284930113" onmouseenter="enter('5211303022284930113');" onmouseout="out('5211303022284930113');" style=""> 102                  if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {                                  </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 103                      orderLevelQualification = true;                                                               </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 104                      break orderQualification;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106              }                                                                                                     </span>
<span class="-3473403760382889072" onmouseenter="enter('-3473403760382889072');" onmouseout="out('-3473403760382889072');" style=""> 107              for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {          </span>
<span class="7357760135902725095" onmouseenter="enter('7357760135902725095');" onmouseout="out('7357760135902725095');" style=""> 108                  if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {                           </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 109                      orderLevelQualification = true;                                                               </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 110                      break orderQualification;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113          }                                                                                                         </span>
<span class="5034616183006708671" onmouseenter="enter('5034616183006708671');" onmouseout="out('5034616183006708671');" style=""> 114          //Item Qualification - new for 1.5!                                                                       </span>
<span class="3708307267894275622" onmouseenter="enter('3708307267894275622');" onmouseout="out('3708307267894275622');" style=""> 115          if (orderLevelQualification) {                                                                            </span>
<span class="4083707686274340956" onmouseenter="enter('4083707686274340956');" onmouseout="out('4083707686274340956');" style=""><abbr title=" 116              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 116              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountablðŸ”µ</abbr></span>
<span class="2629114037035373615" onmouseenter="enter('2629114037035373615');" onmouseout="out('2629114037035373615');" style=""> 117              if (candidates.isMatchedQualifier()) {                                                                </span>
<span class="5830719426865289135" onmouseenter="enter('5830719426865289135');" onmouseout="out('5830719426865289135');" style=""><abbr title=" 118                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 118                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-2643650349584698588" onmouseenter="enter('-2643650349584698588');" onmouseout="out('-2643650349584698588');" style=""> 119                  candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122      }                                                                                                             </span>
<span  style=""> 123                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 124      @Override                                                                                                     </span>
<span class="-6078198317128464464" onmouseenter="enter('-6078198317128464464');" onmouseout="out('-6078198317128464464');" style=""> 125      public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {                         </span>
<span class="6994875763592911045" onmouseenter="enter('6994875763592911045');" onmouseout="out('6994875763592911045');" style=""> 126          return couldOfferApplyToOrder(offer, promotableOrder, null, null);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127      }                                                                                                             </span>
<span  style=""> 128                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 129      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 130       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 131       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 132       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 133       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 134       * @param order                                                                                               </span>
<span class="3239114303692248883" onmouseenter="enter('3239114303692248883');" onmouseout="out('3239114303692248883');" style=""> 135       * @param orderItem                                                                                           </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 136       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 137       */                                                                                                           </span>
<span class="-90678225806082002" onmouseenter="enter('-90678225806082002');" onmouseout="out('-90678225806082002');" style=""><abbr title=" 138      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 138      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem ordðŸ”µ</abbr></span>
<span class="-1630600385205451505" onmouseenter="enter('-1630600385205451505');" onmouseout="out('-1630600385205451505');" style=""> 139          return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140      }                                                                                                             </span>
<span  style=""> 141                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 142      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 143       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 144       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 145       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 146       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 147       * @param order                                                                                               </span>
<span class="-7108679256071712026" onmouseenter="enter('-7108679256071712026');" onmouseout="out('-7108679256071712026');" style=""> 148       * @param fulfillmentGroup                                                                                    </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 149       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 150       */                                                                                                           </span>
<span class="-667507213825504723" onmouseenter="enter('-667507213825504723');" onmouseout="out('-667507213825504723');" style=""><abbr title=" 151      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 151      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGrðŸ”µ</abbr></span>
<span class="-5817125691165623435" onmouseenter="enter('-5817125691165623435');" onmouseout="out('-5817125691165623435');" style=""> 152          return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153      }                                                                                                             </span>
<span  style=""> 154                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 155      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 156       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 157       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 158       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 159       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 160       * @param order                                                                                               </span>
<span class="-4036081007465325177" onmouseenter="enter('-4036081007465325177');" onmouseout="out('-4036081007465325177');" style=""> 161       * @param promotableOrderItem                                                                                 </span>
<span class="-8152129500080290565" onmouseenter="enter('-8152129500080290565');" onmouseout="out('-8152129500080290565');" style=""> 162       * @param promotableFulfillmentGroup                                                                          </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 163       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 164       */                                                                                                           </span>
<span class="-3457716414026742708" onmouseenter="enter('-3457716414026742708');" onmouseout="out('-3457716414026742708');" style=""><abbr title=" 165      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 165      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem proðŸ”µ</abbr></span>
<span class="6012064276783556206" onmouseenter="enter('6012064276783556206');" onmouseout="out('6012064276783556206');" style=""> 166          boolean appliesToItem = false;                                                                            </span>
<span class="2877098389407446108" onmouseenter="enter('2877098389407446108');" onmouseout="out('2877098389407446108');" style=""> 167          String rule = null;                                                                                       </span>
<span class="1562125678824942427" onmouseenter="enter('1562125678824942427');" onmouseout="out('1562125678824942427');" style=""> 168          OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());         </span>
<span class="8836327960017040493" onmouseenter="enter('8836327960017040493');" onmouseout="out('8836327960017040493');" style=""> 169          if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {                                              </span>
<span class="-7963530667142055111" onmouseenter="enter('-7963530667142055111');" onmouseout="out('-7963530667142055111');" style=""> 170              rule = orderRule.getOfferRule().getMatchRule();                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171          }                                                                                                         </span>
<span  style=""> 172                                                                                                                    </span>
<span class="5810732230915198369" onmouseenter="enter('5810732230915198369');" onmouseout="out('5810732230915198369');" style=""> 173          if (rule != null) {                                                                                       </span>
<span  style=""> 174                                                                                                                    </span>
<span class="8884608966566249698" onmouseenter="enter('8884608966566249698');" onmouseout="out('8884608966566249698');" style=""> 175              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();                                         </span>
<span class="1671864453263259632" onmouseenter="enter('1671864453263259632');" onmouseout="out('1671864453263259632');" style=""> 176              promotableOrder.updateRuleVariables(vars);                                                            </span>
<span class="-7784011122993792428" onmouseenter="enter('-7784011122993792428');" onmouseout="out('-7784011122993792428');" style=""> 177              vars.put(&quot;offer&quot;, offer);                                                                             </span>
<span class="8596724536333203596" onmouseenter="enter('8596724536333203596');" onmouseout="out('8596724536333203596');" style=""> 178              if (promotableFulfillmentGroup != null) {                                                             </span>
<span class="4746323176778251021" onmouseenter="enter('4746323176778251021');" onmouseout="out('4746323176778251021');" style=""> 179                  promotableFulfillmentGroup.updateRuleVariables(vars);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180              }                                                                                                     </span>
<span class="-4723719306153838221" onmouseenter="enter('-4723719306153838221');" onmouseout="out('-4723719306153838221');" style=""> 181              if (promotableOrderItem != null) {                                                                    </span>
<span class="-3080150609740522861" onmouseenter="enter('-3080150609740522861');" onmouseout="out('-3080150609740522861');" style=""> 182                  promotableOrderItem.updateRuleVariables(vars);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183              }                                                                                                     </span>
<span class="8856405891316557013" onmouseenter="enter('8856405891316557013');" onmouseout="out('8856405891316557013');" style=""> 184              Boolean expressionOutcome = executeExpression(rule, vars);                                            </span>
<span class="5232502196242835360" onmouseenter="enter('5232502196242835360');" onmouseout="out('5232502196242835360');" style=""> 185              if (expressionOutcome != null &amp;&amp; expressionOutcome) {                                                 </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 186                  appliesToItem = true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187              }                                                                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 188          } else {                                                                                                  </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 189              appliesToItem = true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190          }                                                                                                         </span>
<span  style=""> 191                                                                                                                    </span>
<span class="8141379926235681461" onmouseenter="enter('8141379926235681461');" onmouseout="out('8141379926235681461');" style=""> 192          return appliesToItem;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193      }                                                                                                             </span>
<span  style=""> 194                                                                                                                    </span>
<span class="7829573362373940985" onmouseenter="enter('7829573362373940985');" onmouseout="out('7829573362373940985');" style=""><abbr title=" 195      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 195      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotðŸ”µ</abbr></span>
<span class="306330145608771928" onmouseenter="enter('306330145608771928');" onmouseout="out('306330145608771928');" style=""><abbr title=" 196          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 196          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidðŸ”µ</abbr></span>
<span class="5216830913987868628" onmouseenter="enter('5216830913987868628');" onmouseout="out('5216830913987868628');" style=""> 197          qualifiedOrderOffers.add(promotableCandidateOrderOffer);                                                  </span>
<span  style=""> 198                                                                                                                    </span>
<span class="8900972580850147104" onmouseenter="enter('8900972580850147104');" onmouseout="out('8900972580850147104');" style=""> 199          return promotableCandidateOrderOffer;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200      }                                                                                                             </span>
<span  style=""> 201                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202      @Override                                                                                                     </span>
<span class="5964334254617273825" onmouseenter="enter('5964334254617273825');" onmouseout="out('5964334254617273825');" style=""><abbr title=" 203      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 203      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrdeðŸ”µ</abbr></span>
<span class="3985416668088414845" onmouseenter="enter('3985416668088414845');" onmouseout="out('3985416668088414845');" style=""><abbr title=" 204          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 204          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 205          int offerCount = 0;                                                                                       </span>
<span class="6508259141671549344" onmouseenter="enter('6508259141671549344');" onmouseout="out('6508259141671549344');" style=""> 206          for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {                                    </span>
<span class="8700395077100738449" onmouseenter="enter('8700395077100738449');" onmouseout="out('8700395077100738449');" style=""> 207              if (offerCount == 0) {                                                                                </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 208                  remainingCandidateOffers.add(candidateOffer);                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 209              } else {                                                                                              </span>
<span class="-2676530692785987369" onmouseenter="enter('-2676530692785987369');" onmouseout="out('-2676530692785987369');" style=""> 210                  if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;                                    </span>
<span class="2920776142298371855" onmouseenter="enter('2920776142298371855');" onmouseout="out('2920776142298371855');" style=""> 211                          !candidateOffer.getOffer().isTotalitarianOffer()) {                                       </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 212                      remainingCandidateOffers.add(candidateOffer);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214              }                                                                                                     </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 215              offerCount++;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216          }                                                                                                         </span>
<span class="5367008489542993301" onmouseenter="enter('5367008489542993301');" onmouseout="out('5367008489542993301');" style=""> 217          return remainingCandidateOffers;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218      }                                                                                                             </span>
<span  style=""> 219                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 220      @Override                                                                                                     </span>
<span class="8954636300636023369" onmouseenter="enter('8954636300636023369');" onmouseout="out('8954636300636023369');" style=""><abbr title=" 221      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 221      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrdðŸ”µ</abbr></span>
<span class="-7971504164894226146" onmouseenter="enter('-7971504164894226146');" onmouseout="out('-7971504164894226146');" style=""><abbr title=" 222          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 222          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discountðŸ”µ</abbr></span>
<span class="1108112804447486968" onmouseenter="enter('1108112804447486968');" onmouseout="out('1108112804447486968');" style=""> 223          Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();                      </span>
<span class="3603986812472116533" onmouseenter="enter('3603986812472116533');" onmouseout="out('3603986812472116533');" style=""> 224          while (orderOfferIterator.hasNext()) {                                                                    </span>
<span class="-7865108167409889797" onmouseenter="enter('-7865108167409889797');" onmouseout="out('-7865108167409889797');" style=""> 225              PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();                                 </span>
<span  style=""> 226                                                                                                                    </span>
<span class="-919097363910280710" onmouseenter="enter('-919097363910280710');" onmouseout="out('-919097363910280710');" style=""> 227              if (promotableOrder.canApplyOrderOffer(orderOffer)) {                                                 </span>
<span class="4017990809944563089" onmouseenter="enter('4017990809944563089');" onmouseout="out('4017990809944563089');" style=""><abbr title=" 228                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 228                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalReqðŸ”µ</abbr></span>
<span class="-4210377854282903954" onmouseenter="enter('-4210377854282903954');" onmouseout="out('-4210377854282903954');" style=""> 229                      applyOrderOffer(promotableOrder, orderOffer);                                                 </span>
<span  style=""> 230                                                                                                                    </span>
<span class="5366287165432255586" onmouseenter="enter('5366287165432255586');" onmouseout="out('5366287165432255586');" style=""> 231                      if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {        </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 232                          if (LOG.isTraceEnabled()) {                                                               </span>
<span class="3222834402337240688" onmouseenter="enter('3222834402337240688');" onmouseout="out('3222834402337240688');" style=""><abbr title=" 233                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 233                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for besðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234                          }                                                                                         </span>
<span class="-4644781248556093759" onmouseenter="enter('-4644781248556093759');" onmouseout="out('-4644781248556093759');" style=""> 235                          compareAndAdjustOrderAndItemOffers(promotableOrder);                                      </span>
<span class="-8504589987429997467" onmouseenter="enter('-8504589987429997467');" onmouseout="out('-8504589987429997467');" style=""><abbr title=" 236                          // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 236                          // We continue because this could be the first offer and marked as totalitarian, but not aðŸ”µ</abbr></span>
<span class="-473363534111382515" onmouseenter="enter('-473363534111382515');" onmouseout="out('-473363534111382515');" style=""><abbr title=" 237                          // item offer. There could be other order offers that are not totalitarian that also qualify."> 237                          // item offer. There could be other order offers that are not totalitarian that also qualiðŸ”µ</abbr></span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 238                          continue;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239                      }                                                                                             </span>
<span  style=""> 240                                                                                                                    </span>
<span class="-155427173834895323" onmouseenter="enter('-155427173834895323');" onmouseout="out('-155427173834895323');" style=""> 241                      if (!orderOffer.isCombinable()) {                                                             </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 242                          if (LOG.isTraceEnabled()) {                                                               </span>
<span class="-641512738818000762" onmouseenter="enter('-641512738818000762');" onmouseout="out('-641512738818000762');" style=""><abbr title=" 243                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 243                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getIdðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 244                          }                                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 245                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249          }                                                                                                         </span>
<span class="1071860375321424059" onmouseenter="enter('1071860375321424059');" onmouseout="out('1071860375321424059');" style=""> 250          promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251      }                                                                                                             </span>
<span  style=""> 252                                                                                                                    </span>
<span class="1494850857047655937" onmouseenter="enter('1494850857047655937');" onmouseout="out('1494850857047655937');" style=""><abbr title=" 253      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 253      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffeðŸ”µ</abbr></span>
<span class="-2808877570377534999" onmouseenter="enter('-2808877570377534999');" onmouseout="out('-2808877570377534999');" style=""><abbr title=" 254          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 254          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 255      }                                                                                                             </span>
<span  style=""> 256                                                                                                                    </span>
<span class="-8447973418270990594" onmouseenter="enter('-8447973418270990594');" onmouseout="out('-8447973418270990594');" style=""><abbr title=" 257      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 257      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffðŸ”µ</abbr></span>
<span class="8346114644175432666" onmouseenter="enter('8346114644175432666');" onmouseout="out('8346114644175432666');" style=""> 258          return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259      }                                                                                                             </span>
<span  style=""> 260                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 261      /**                                                                                                           </span>
<span class="7019315089426478439" onmouseenter="enter('7019315089426478439');" onmouseout="out('7019315089426478439');" style=""> 262       * Called when the system must determine whether to apply order or item adjustments.                          </span>
<span class="-8371223817828724637" onmouseenter="enter('-8371223817828724637');" onmouseout="out('-8371223817828724637');" style=""> 263       * @param promotableOrder                                                                                     </span>
<span class="-2490256996948663406" onmouseenter="enter('-2490256996948663406');" onmouseout="out('-2490256996948663406');" style=""> 264       * @param orderOffersApplied                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 265       */                                                                                                           </span>
<span class="7043079218483465061" onmouseenter="enter('7043079218483465061');" onmouseout="out('7043079218483465061');" style=""> 266      protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {                          </span>
<span class="-4146438378303178005" onmouseenter="enter('-4146438378303178005');" onmouseout="out('-4146438378303178005');" style=""> 267          Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();                             </span>
<span class="7927037930311470382" onmouseenter="enter('7927037930311470382');" onmouseout="out('7927037930311470382');" style=""> 268          Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();                               </span>
<span  style=""> 269                                                                                                                    </span>
<span class="-1625160164833054598" onmouseenter="enter('-1625160164833054598');" onmouseout="out('-1625160164833054598');" style=""> 270          if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {                                       </span>
<span class="-7027301438537880380" onmouseenter="enter('-7027301438537880380');" onmouseout="out('-7027301438537880380');" style=""> 271              promotableOrder.removeAllCandidateItemOfferAdjustments();                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 272          } else {                                                                                                  </span>
<span class="6517108348190993777" onmouseenter="enter('6517108348190993777');" onmouseout="out('6517108348190993777');" style=""> 273              promotableOrder.removeAllCandidateOrderOfferAdjustments();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275      }                                                                                                             </span>
<span  style=""> 276                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 277      /**                                                                                                           </span>
<span class="-6223401290020760984" onmouseenter="enter('-6223401290020760984');" onmouseout="out('-6223401290020760984');" style=""> 278       * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer         </span>
<span class="6836988226136200872" onmouseenter="enter('6836988226136200872');" onmouseout="out('6836988226136200872');" style=""> 279       * and associates the OrderAdjustment to the Order.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 280       *                                                                                                            </span>
<span class="6951516900174217638" onmouseenter="enter('6951516900174217638');" onmouseout="out('6951516900174217638');" style=""> 281       * @param orderOffer a CandidateOrderOffer to apply to an Order                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 282       */                                                                                                           </span>
<span class="-1056565336427362312" onmouseenter="enter('-1056565336427362312');" onmouseout="out('-1056565336427362312');" style=""> 283      protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {   </span>
<span class="-3917047491438167754" onmouseenter="enter('-3917047491438167754');" onmouseout="out('-3917047491438167754');" style=""><abbr title=" 284          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 284          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustmenðŸ”µ</abbr></span>
<span class="2459651529956168438" onmouseenter="enter('2459651529956168438');" onmouseout="out('2459651529956168438');" style=""> 285          promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 286      }                                                                                                             </span>
<span  style=""> 287                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 288      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 289      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 290          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291      }                                                                                                             </span>
<span  style=""> 292                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 293      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 294      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 295          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296      }                                                                                                             </span>
<span  style=""> 297                                                                                                                    </span>
<span class="-7694825550100150639" onmouseenter="enter('-7694825550100150639');" onmouseout="out('-7694825550100150639');" style=""><abbr title=" 298      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 298      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrðŸ”µ</abbr></span>
<span class="-2272462204816182006" onmouseenter="enter('-2272462204816182006');" onmouseout="out('-2272462204816182006');" style=""> 299          Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();     </span>
<span class="-7354354578377701904" onmouseenter="enter('-7354354578377701904');" onmouseout="out('-7354354578377701904');" style=""> 300          for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {             </span>
<span class="-7366330237630024028" onmouseenter="enter('-7366330237630024028');" onmouseout="out('-7366330237630024028');" style=""> 301              adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302          }                                                                                                         </span>
<span class="7908136136791584596" onmouseenter="enter('7908136136791584596');" onmouseout="out('7908136136791584596');" style=""> 303          return adjustmentsMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304      }                                                                                                             </span>
<span  style=""> 305                                                                                                                    </span>
<span class="8556164244366976053" onmouseenter="enter('8556164244366976053');" onmouseout="out('8556164244366976053');" style=""> 306      protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {                                 </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 307          Order order = promotableOrder.getOrder();                                                                 </span>
<span  style=""> 308                                                                                                                    </span>
<span class="-6033320157511533636" onmouseenter="enter('-6033320157511533636');" onmouseout="out('-6033320157511533636');" style=""> 309          if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {  </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 310              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311          }                                                                                                         </span>
<span  style=""> 312                                                                                                                    </span>
<span class="-926001645706785786" onmouseenter="enter('-926001645706785786');" onmouseout="out('-926001645706785786');" style=""><abbr title=" 313          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 313          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrdeðŸ”µ</abbr></span>
<span class="3944053196731100643" onmouseenter="enter('3944053196731100643');" onmouseout="out('3944053196731100643');" style=""> 314          Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();                      </span>
<span  style=""> 315                                                                                                                    </span>
<span class="6446254784470090633" onmouseenter="enter('6446254784470090633');" onmouseout="out('6446254784470090633');" style=""> 316          while (orderAdjIterator.hasNext()) {                                                                      </span>
<span class="8379122835997548797" onmouseenter="enter('8379122835997548797');" onmouseout="out('8379122835997548797');" style=""> 317              OrderAdjustment adjustment = orderAdjIterator.next();                                                 </span>
<span class="-4215374844081079628" onmouseenter="enter('-4215374844081079628');" onmouseout="out('-4215374844081079628');" style=""> 318              if (adjustment.getOffer() != null) {                                                                  </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 319                  Long offerId = adjustment.getOffer().getId();                                                     </span>
<span class="5819609577497737127" onmouseenter="enter('5819609577497737127');" onmouseout="out('5819609577497737127');" style=""> 320                  PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);               </span>
<span class="6490885699345008591" onmouseenter="enter('6490885699345008591');" onmouseout="out('6490885699345008591');" style=""> 321                  if (promotableAdjustment != null) {                                                               </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 322 -                    if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {               </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 323 -                        if (LOG.isDebugEnabled()) {                                                               </span>
<span class="7257069809489192732" onmouseenter="enter('7257069809489192732');" onmouseout="out('7257069809489192732');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 324 -                            LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +   </span>
<span class="989054364510106270" onmouseenter="enter('989054364510106270');" onmouseout="out('989054364510106270');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 325 -                                    promotableAdjustment.getAdjustmentValue());                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 326 -                        }                                                                                         </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 327 -                        adjustment.setValue(promotableAdjustment.getAdjustmentValue());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 328 -                    }                                                                                             </span>
<span class="8069062196406007718" onmouseenter="enter('8069062196406007718');" onmouseout="out('8069062196406007718');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +                    updateAdjustmentIfChangesDetected(adjustment, promotableAdjustment);                          </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 330                  } else {                                                                                          </span>
<span class="4531906782810290485" onmouseenter="enter('4531906782810290485');" onmouseout="out('4531906782810290485');" style=""> 331                      // No longer using this order adjustment, remove it.                                          </span>
<span class="-8642473006560883902" onmouseenter="enter('-8642473006560883902');" onmouseout="out('-8642473006560883902');" style=""> 332                      orderAdjIterator.remove();                                                                    </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335          }                                                                                                         </span>
<span  style=""> 336                                                                                                                    </span>
<span class="9053649251777837824" onmouseenter="enter('9053649251777837824');" onmouseout="out('9053649251777837824');" style=""> 337          for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {                  </span>
<span class="8948825633726878072" onmouseenter="enter('8948825633726878072');" onmouseout="out('8948825633726878072');" style=""> 338              // Add the newly introduced adjustments.                                                              </span>
<span class="-1742313644800837850" onmouseenter="enter('-1742313644800837850');" onmouseout="out('-1742313644800837850');" style=""> 339              Offer offer = promotableOrderAdjustment.getOffer();                                                   </span>
<span class="1325997209783346162" onmouseenter="enter('1325997209783346162');" onmouseout="out('1325997209783346162');" style=""> 340              OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();                                   </span>
<span class="-6738057894981368691" onmouseenter="enter('-6738057894981368691');" onmouseout="out('-6738057894981368691');" style=""> 341              orderAdjustment.init(order, offer, offer.getName());                                                  </span>
<span class="-770736347184914897" onmouseenter="enter('-770736347184914897');" onmouseout="out('-770736347184914897');" style=""> 342              orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());                             </span>
<span class="-1853577329694264316" onmouseenter="enter('-1853577329694264316');" onmouseout="out('-1853577329694264316');" style=""> 343              order.getOrderAdjustments().add(orderAdjustment);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 345      }                                                                                                             </span>
<span  style=""> 346                                                                                                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 347 -                                                                                                                  </span>
<span class="7254378221303205454" onmouseenter="enter('7254378221303205454');" onmouseout="out('7254378221303205454');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 348 +    protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotableAdjustment) {"> 348 +    protected void updateAdjustmentIfChangesDetected(OrderAdjustment adjustment, PromotableOrderAdjustment promotaðŸ”µ</abbr></span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        Long offerId = adjustment.getOffer().getId();                                                             </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +        if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {                           </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +            if (LOG.isDebugEnabled()) {                                                                           </span>
<span class="7257069809489192732" onmouseenter="enter('7257069809489192732');" onmouseout="out('7257069809489192732');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +               </span>
<span class="989054364510106270" onmouseenter="enter('989054364510106270');" onmouseout="out('989054364510106270');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                        promotableAdjustment.getAdjustmentValue());                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            }                                                                                                     </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            adjustment.setValue(promotableAdjustment.getAdjustmentValue());                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        }                                                                                                         </span>
<span class="734930962553645377" onmouseenter="enter('734930962553645377');" onmouseout="out('734930962553645377');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        if (!adjustment.isFutureCredit().equals(promotableAdjustment.getOffer().isFutureCredit())) {              </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            if (LOG.isDebugEnabled()) {                                                                           </span>
<span class="1970354127702343135" onmouseenter="enter('1970354127702343135');" onmouseout="out('1970354127702343135');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +                LOG.debug(&quot;Updating isFutureCredit for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +      </span>
<span class="755598418585359348" onmouseenter="enter('755598418585359348');" onmouseout="out('755598418585359348');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                        promotableAdjustment.isFutureCredit());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +            }                                                                                                     </span>
<span class="-1212224207609501002" onmouseenter="enter('-1212224207609501002');" onmouseout="out('-1212224207609501002');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +            adjustment.setFutureCredit(promotableAdjustment.isFutureCredit());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +    }                                                                                                             </span>
<span  style=""> 365                                                                                                                    </span>
<span class="4939686944790593089" onmouseenter="enter('4939686944790593089');" onmouseout="out('4939686944790593089');" style=""> 366      protected void synchronizeOrderItems(PromotableOrder promotableOrder) {                                       </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 367          Order order = promotableOrder.getOrder();                                                                 </span>
<span class="8870411702953196775" onmouseenter="enter('8870411702953196775');" onmouseout="out('8870411702953196775');" style=""><abbr title=" 368          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 368          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promoðŸ”µ</abbr></span>
<span  style=""> 369                                                                                                                    </span>
<span class="45393343966675502" onmouseenter="enter('45393343966675502');" onmouseout="out('45393343966675502');" style=""> 370          List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);                          </span>
<span  style=""> 371                                                                                                                    </span>
<span class="-3971897302215245898" onmouseenter="enter('-3971897302215245898');" onmouseout="out('-3971897302215245898');" style=""> 372          for (OrderItem orderItem : orderItemList) {                                                               </span>
<span class="-3227733123108723187" onmouseenter="enter('-3227733123108723187');" onmouseout="out('-3227733123108723187');" style=""> 373              PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);                                </span>
<span class="-7181450714367096357" onmouseenter="enter('-7181450714367096357');" onmouseout="out('-7181450714367096357');" style=""> 374              if (promotableItem == null) {                                                                         </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 375                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 376              }                                                                                                     </span>
<span class="-4627052923559624390" onmouseenter="enter('-4627052923559624390');" onmouseout="out('-4627052923559624390');" style=""> 377              synchronizeItemPriceDetails(orderItem, promotableItem);                                               </span>
<span class="-6035169113045010952" onmouseenter="enter('-6035169113045010952');" onmouseout="out('-6035169113045010952');" style=""> 378              synchronizeItemQualifiers(orderItem, promotableItem);                                                 </span>
<span  style=""> 379                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 380          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 381      }                                                                                                             </span>
<span  style=""> 382                                                                                                                    </span>
<span class="4641946456273473515" onmouseenter="enter('4641946456273473515');" onmouseout="out('4641946456273473515');" style=""> 383      protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {    </span>
<span class="8574464637260302488" onmouseenter="enter('8574464637260302488');" onmouseout="out('8574464637260302488');" style=""><abbr title=" 384          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 384          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrdðŸ”µ</abbr></span>
<span class="-6342291150701367795" onmouseenter="enter('-6342291150701367795');" onmouseout="out('-6342291150701367795');" style=""> 385          Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();          </span>
<span  style=""> 386                                                                                                                    </span>
<span class="-4767625469055938064" onmouseenter="enter('-4767625469055938064');" onmouseout="out('-4767625469055938064');" style=""> 387          for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {                  </span>
<span class="5353286555635618569" onmouseenter="enter('5353286555635618569');" onmouseout="out('5353286555635618569');" style=""> 388              String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);                                     </span>
<span class="-2878152675586990901" onmouseenter="enter('-2878152675586990901');" onmouseout="out('-2878152675586990901');" style=""> 389              PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);             </span>
<span class="5988062476356282201" onmouseenter="enter('5988062476356282201');" onmouseout="out('5988062476356282201');" style=""> 390              if (promotableDetail != null) {                                                                       </span>
<span class="-2745140720553978382" onmouseenter="enter('-2745140720553978382');" onmouseout="out('-2745140720553978382');" style=""> 391                  processMatchingDetails(orderItemPriceDetail, promotableDetail);                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 392              } else {                                                                                              </span>
<span class="-8641070025229307801" onmouseenter="enter('-8641070025229307801');" onmouseout="out('-8641070025229307801');" style=""> 393                  unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 394              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 395          }                                                                                                         </span>
<span  style=""> 396                                                                                                                    </span>
<span class="-2102992530504048935" onmouseenter="enter('-2102992530504048935');" onmouseout="out('-2102992530504048935');" style=""> 397          Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();        </span>
<span  style=""> 398                                                                                                                    </span>
<span class="3655839919190900579" onmouseenter="enter('3655839919190900579');" onmouseout="out('3655839919190900579');" style=""> 399          for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {                        </span>
<span class="848025138552610797" onmouseenter="enter('848025138552610797');" onmouseout="out('848025138552610797');" style=""> 400              if (unmatchedDetailsIterator.hasNext()) {                                                             </span>
<span class="-1286995204662994700" onmouseenter="enter('-1286995204662994700');" onmouseout="out('-1286995204662994700');" style=""> 401                  // Reuse an existing priceDetail                                                                  </span>
<span class="-6274362249453165217" onmouseenter="enter('-6274362249453165217');" onmouseout="out('-6274362249453165217');" style=""> 402                  OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();                            </span>
<span  style=""> 403                                                                                                                    </span>
<span class="8785556757346701489" onmouseenter="enter('8785556757346701489');" onmouseout="out('8785556757346701489');" style=""> 404                  // Reset use Sale flag to true                                                                    </span>
<span class="-4586757194387339116" onmouseenter="enter('-4586757194387339116');" onmouseout="out('-4586757194387339116');" style=""> 405                  existingDetail.setUseSalePrice(true);                                                             </span>
<span  style=""> 406                                                                                                                    </span>
<span class="7880433973363830475" onmouseenter="enter('7880433973363830475');" onmouseout="out('7880433973363830475');" style=""> 407                  offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);                             </span>
<span class="9163760465604163202" onmouseenter="enter('9163760465604163202');" onmouseout="out('9163760465604163202');" style=""> 408                  unmatchedDetailsIterator.remove();                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 409              } else {                                                                                              </span>
<span class="-3751890412067657497" onmouseenter="enter('-3751890412067657497');" onmouseout="out('-3751890412067657497');" style=""> 410                  // Create a new priceDetail                                                                       </span>
<span class="-1690864448011816688" onmouseenter="enter('-1690864448011816688');" onmouseout="out('-1690864448011816688');" style=""> 411                  OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();                  </span>
<span class="-3940721081423400252" onmouseenter="enter('-3940721081423400252');" onmouseout="out('-3940721081423400252');" style=""> 412                  newPriceDetail.setOrderItem(orderItem);                                                           </span>
<span class="-2358509328501908297" onmouseenter="enter('-2358509328501908297');" onmouseout="out('-2358509328501908297');" style=""> 413                  offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);                             </span>
<span class="7726531521682039639" onmouseenter="enter('7726531521682039639');" onmouseout="out('7726531521682039639');" style=""> 414                  orderItem.getOrderItemPriceDetails().add(newPriceDetail);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416          }                                                                                                         </span>
<span  style=""> 417                                                                                                                    </span>
<span class="5078704746315005492" onmouseenter="enter('5078704746315005492');" onmouseout="out('5078704746315005492');" style=""> 418          // Remove any unmatched details                                                                           </span>
<span class="-596985917041158168" onmouseenter="enter('-596985917041158168');" onmouseout="out('-596985917041158168');" style=""> 419          Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();              </span>
<span class="-2348069803911125145" onmouseenter="enter('-2348069803911125145');" onmouseout="out('-2348069803911125145');" style=""> 420          offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421      }                                                                                                             </span>
<span  style=""> 422                                                                                                                    </span>
<span class="-3359465330409353741" onmouseenter="enter('-3359465330409353741');" onmouseout="out('-3359465330409353741');" style=""> 423      protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {      </span>
<span class="6939567773624847901" onmouseenter="enter('6939567773624847901');" onmouseout="out('6939567773624847901');" style=""> 424          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);          </span>
<span class="-838353671554643485" onmouseenter="enter('-838353671554643485');" onmouseout="out('-838353671554643485');" style=""> 425          Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();           </span>
<span  style=""> 426                                                                                                                    </span>
<span class="6539711029953657105" onmouseenter="enter('6539711029953657105');" onmouseout="out('6539711029953657105');" style=""> 427          for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {                        </span>
<span class="2428508324486494962" onmouseenter="enter('2428508324486494962');" onmouseout="out('2428508324486494962');" style=""> 428              PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId()); </span>
<span class="-4549367717464072284" onmouseenter="enter('-4549367717464072284');" onmouseout="out('-4549367717464072284');" style=""> 429              if (promotableQualifier != null) {                                                                    </span>
<span class="-5773466494614436024" onmouseenter="enter('-5773466494614436024');" onmouseout="out('-5773466494614436024');" style=""> 430                  // Offer was used as a qualifier on previous run.   Update quantity if needed.                    </span>
<span class="-3775165376026668506" onmouseenter="enter('-3775165376026668506');" onmouseout="out('-3775165376026668506');" style=""> 431                  if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {                      </span>
<span class="6319516500536721656" onmouseenter="enter('6319516500536721656');" onmouseout="out('6319516500536721656');" style=""> 432                      orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 434              } else {                                                                                              </span>
<span class="-7107745465096608003" onmouseenter="enter('-7107745465096608003');" onmouseout="out('-7107745465096608003');" style=""> 435                  unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 436              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437          }                                                                                                         </span>
<span  style=""> 438                                                                                                                    </span>
<span class="6412010879861386561" onmouseenter="enter('6412010879861386561');" onmouseout="out('6412010879861386561');" style=""> 439          Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();    </span>
<span  style=""> 440                                                                                                                    </span>
<span class="-5367673967409602220" onmouseenter="enter('-5367673967409602220');" onmouseout="out('-5367673967409602220');" style=""> 441          for (PromotionQualifier qualifier : qualifiersMap.values()) {                                             </span>
<span class="4352951882445574614" onmouseenter="enter('4352951882445574614');" onmouseout="out('4352951882445574614');" style=""> 442              if (unmatchedQualifiersIterator.hasNext()) {                                                          </span>
<span class="916500832219535438" onmouseenter="enter('916500832219535438');" onmouseout="out('916500832219535438');" style=""> 443                  // Reuse an existing qualifier                                                                    </span>
<span class="-457617571898655971" onmouseenter="enter('-457617571898655971');" onmouseout="out('-457617571898655971');" style=""> 444                  OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();                        </span>
<span class="-9191122370911430740" onmouseenter="enter('-9191122370911430740');" onmouseout="out('-9191122370911430740');" style=""> 445                  existingQualifier.setOffer(qualifier.getPromotion());                                             </span>
<span class="-5418424828849751920" onmouseenter="enter('-5418424828849751920');" onmouseout="out('-5418424828849751920');" style=""> 446                  existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                             </span>
<span class="-2784197009200988946" onmouseenter="enter('-2784197009200988946');" onmouseout="out('-2784197009200988946');" style=""> 447                  unmatchedQualifiersIterator.remove();                                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 448              } else {                                                                                              </span>
<span class="-4600119951921754996" onmouseenter="enter('-4600119951921754996');" onmouseout="out('-4600119951921754996');" style=""> 449                  // Create a new qualifier                                                                         </span>
<span class="2495734798245487562" onmouseenter="enter('2495734798245487562');" onmouseout="out('2495734798245487562');" style=""> 450                  OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();                        </span>
<span class="-7776554329531977433" onmouseenter="enter('-7776554329531977433');" onmouseout="out('-7776554329531977433');" style=""> 451                  newQualifier.setOrderItem(orderItem);                                                             </span>
<span class="-7457838790114620282" onmouseenter="enter('-7457838790114620282');" onmouseout="out('-7457838790114620282');" style=""> 452                  newQualifier.setOffer(qualifier.getPromotion());                                                  </span>
<span class="35194467054568730" onmouseenter="enter('35194467054568730');" onmouseout="out('35194467054568730');" style=""> 453                  newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                                  </span>
<span class="-7418439022636140038" onmouseenter="enter('-7418439022636140038');" onmouseout="out('-7418439022636140038');" style=""> 454                  orderItem.getOrderItemQualifiers().add(newQualifier);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456          }                                                                                                         </span>
<span  style=""> 457                                                                                                                    </span>
<span class="5791534705407165022" onmouseenter="enter('5791534705407165022');" onmouseout="out('5791534705407165022');" style=""> 458          // Remove any unmatched qualifiers                                                                        </span>
<span class="-8561007497302660099" onmouseenter="enter('-8561007497302660099');" onmouseout="out('-8561007497302660099');" style=""> 459          Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();                   </span>
<span class="760711543792628805" onmouseenter="enter('760711543792628805');" onmouseout="out('760711543792628805');" style=""> 460          offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461      }                                                                                                             </span>
<span  style=""> 462                                                                                                                    </span>
<span class="6872064960056917626" onmouseenter="enter('6872064960056917626');" onmouseout="out('6872064960056917626');" style=""> 463      protected void processMatchingDetails(OrderItemPriceDetail itemDetail,                                        </span>
<span class="59795375183189524" onmouseenter="enter('59795375183189524');" onmouseout="out('59795375183189524');" style=""> 464              PromotableOrderItemPriceDetail promotableItemDetail) {                                                </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 465          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                             </span>
<span class="7510782226240613992" onmouseenter="enter('7510782226240613992');" onmouseout="out('7510782226240613992');" style=""> 466                  offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);                                   </span>
<span  style=""> 467                                                                                                                    </span>
<span class="-750959101585099141" onmouseenter="enter('-750959101585099141');" onmouseout="out('-750959101585099141');" style=""> 468          if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {                                     </span>
<span class="-3259655613865435165" onmouseenter="enter('-3259655613865435165');" onmouseout="out('-3259655613865435165');" style=""> 469              itemDetail.setQuantity(promotableItemDetail.getQuantity());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 470          }                                                                                                         </span>
<span  style=""> 471                                                                                                                    </span>
<span class="9218754308308575613" onmouseenter="enter('9218754308308575613');" onmouseout="out('9218754308308575613');" style=""><abbr title=" 472          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 472          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustmentðŸ”µ</abbr></span>
<span class="2783281510413095088" onmouseenter="enter('2783281510413095088');" onmouseout="out('2783281510413095088');" style=""> 473              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());       </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 474              if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                             </span>
<span class="-4842011616043597197" onmouseenter="enter('-4842011616043597197');" onmouseout="out('-4842011616043597197');" style=""> 475                  itemAdjustment.setValue(adjustment.getAdjustmentValue());                                         </span>
<span class="-5695031583799398466" onmouseenter="enter('-5695031583799398466');" onmouseout="out('-5695031583799398466');" style=""> 476                  itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479      }                                                                                                             </span>
<span  style=""> 480                                                                                                                    </span>
<span class="4651274540478945566" onmouseenter="enter('4651274540478945566');" onmouseout="out('4651274540478945566');" style=""> 481      protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {                                   </span>
<span class="1883813639191860394" onmouseenter="enter('1883813639191860394');" onmouseout="out('1883813639191860394');" style=""> 482          List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();                                                              </span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""> 483          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {       </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 484              Long offerId = adjustment.getOffer().getId();                                                         </span>
<span class="-11608270007353255" onmouseenter="enter('-11608270007353255');" onmouseout="out('-11608270007353255');" style=""> 485              offerIds.add(offerId);                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486          }                                                                                                         </span>
<span class="-5651075727196406737" onmouseenter="enter('-5651075727196406737');" onmouseout="out('-5651075727196406737');" style=""> 487          Collections.sort(offerIds);                                                                               </span>
<span class="5891357179043449296" onmouseenter="enter('5891357179043449296');" onmouseout="out('5891357179043449296');" style=""> 488          return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489      }                                                                                                             </span>
<span  style=""> 490                                                                                                                    </span>
<span class="-6813037055353877100" onmouseenter="enter('-6813037055353877100');" onmouseout="out('-6813037055353877100');" style=""> 491      protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {   </span>
<span class="-5863956661369186771" onmouseenter="enter('-5863956661369186771');" onmouseout="out('-5863956661369186771');" style=""><abbr title=" 492          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 492          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetaiðŸ”µ</abbr></span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 493          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {                 </span>
<span class="-4172210863560606018" onmouseenter="enter('-4172210863560606018');" onmouseout="out('-4172210863560606018');" style=""> 494              detailsMap.put(detail.buildDetailKey(), detail);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495          }                                                                                                         </span>
<span class="1985757738719514214" onmouseenter="enter('1985757738719514214');" onmouseout="out('1985757738719514214');" style=""> 496          return detailsMap;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497      }                                                                                                             </span>
<span  style=""> 498                                                                                                                    </span>
<span class="-3836724244114507356" onmouseenter="enter('-3836724244114507356');" onmouseout="out('-3836724244114507356');" style=""> 499      protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {              </span>
<span class="-1925492436839506759" onmouseenter="enter('-1925492436839506759');" onmouseout="out('-1925492436839506759');" style=""> 500          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();                    </span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 501          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {                 </span>
<span class="-4593166378473264356" onmouseenter="enter('-4593166378473264356');" onmouseout="out('-4593166378473264356');" style=""> 502              for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {                                </span>
<span class="3842824965672319387" onmouseenter="enter('3842824965672319387');" onmouseout="out('3842824965672319387');" style=""> 503                  PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());       </span>
<span class="-8569849509682320504" onmouseenter="enter('-8569849509682320504');" onmouseout="out('-8569849509682320504');" style=""> 504                  if (existingQualifier != null) {                                                                  </span>
<span class="-4445010116162684270" onmouseenter="enter('-4445010116162684270');" onmouseout="out('-4445010116162684270');" style=""> 505                      existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 506                  } else {                                                                                          </span>
<span class="-8046901564682421602" onmouseenter="enter('-8046901564682421602');" onmouseout="out('-8046901564682421602');" style=""> 507                      qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510          }                                                                                                         </span>
<span class="4699150655190374848" onmouseenter="enter('4699150655190374848');" onmouseout="out('4699150655190374848');" style=""> 511          return qualifiersMap;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512      }                                                                                                             </span>
<span  style=""> 513                                                                                                                    </span>
<span class="6650489462588239331" onmouseenter="enter('6650489462588239331');" onmouseout="out('6650489462588239331');" style=""> 514      protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {                                </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 515          Order order = promotableOrder.getOrder();                                                                 </span>
<span class="6561763597022577240" onmouseenter="enter('6561763597022577240');" onmouseout="out('6561763597022577240');" style=""> 516          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);        </span>
<span  style=""> 517                                                                                                                    </span>
<span class="6990956658692188299" onmouseenter="enter('6990956658692188299');" onmouseout="out('6990956658692188299');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        boolean syncNeededOnTotal = false;                                                                        </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +                                                                                                                  </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 520          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                                </span>
<span class="-439733037564232612" onmouseenter="enter('-439733037564232612');" onmouseout="out('-439733037564232612');" style=""> 521              synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 522 -        }                                                                                                         </span>
<span class="3630381949999328071" onmouseenter="enter('3630381949999328071');" onmouseout="out('3630381949999328071');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 523 +            boolean syncNeeded = fgContainsFutureCreditAdjustment(fg);                                            </span>
<span class="6204032096114591207" onmouseenter="enter('6204032096114591207');" onmouseout="out('6204032096114591207');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +            if (syncNeeded) {                                                                                     </span>
<span class="-6169259820846196761" onmouseenter="enter('-6169259820846196761');" onmouseout="out('-6169259820846196761');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 525 +                syncFulfillmentPrice(fg);                                                                         </span>
<span class="-2299678048386624818" onmouseenter="enter('-2299678048386624818');" onmouseout="out('-2299678048386624818');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +                syncNeededOnTotal = true;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 528 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 529 +                                                                                                                  </span>
<span class="-5450932785890013448" onmouseenter="enter('-5450932785890013448');" onmouseout="out('-5450932785890013448');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 530 +        if (syncNeededOnTotal) {                                                                                  </span>
<span class="-8777873539377505153" onmouseenter="enter('-8777873539377505153');" onmouseout="out('-8777873539377505153');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 531 +            Money syncFulfillmentPrice = Money.ZERO;                                                              </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 532 +                                                                                                                  </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +            for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                            </span>
<span class="-5396558836391507485" onmouseenter="enter('-5396558836391507485');" onmouseout="out('-5396558836391507485');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +                syncFulfillmentPrice = syncFulfillmentPrice.add(fg.getFulfillmentPrice());                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +            }                                                                                                     </span>
<span class="-4866549136483611279" onmouseenter="enter('-4866549136483611279');" onmouseout="out('-4866549136483611279');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 536 +            order.setTotalFulfillmentCharges(syncFulfillmentPrice);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 538 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 539 +                                                                                                                  </span>
<span class="2663354164110279617" onmouseenter="enter('2663354164110279617');" onmouseout="out('2663354164110279617');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 540 +    protected boolean fgContainsFutureCreditAdjustment(FulfillmentGroup fg) {                                     </span>
<span class="-1122908714199440396" onmouseenter="enter('-1122908714199440396');" onmouseout="out('-1122908714199440396');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +        return !fg.getFutureCreditFulfillmentGroupAdjustmentsValue().equals(Money.ZERO);                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 543 +                                                                                                                  </span>
<span class="-1055395477678850539" onmouseenter="enter('-1055395477678850539');" onmouseout="out('-1055395477678850539');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 544 +    protected void syncFulfillmentPrice(FulfillmentGroup fg) {                                                    </span>
<span class="6421033897115001406" onmouseenter="enter('6421033897115001406');" onmouseout="out('6421033897115001406');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 545 +        Money retailPrice = fg.getRetailFulfillmentPrice();                                                       </span>
<span class="2458814602568234661" onmouseenter="enter('2458814602568234661');" onmouseout="out('2458814602568234661');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 546 +        Money orderDiscountFulfillmentGroupAdjustmentsValue = fg.getFulfillmentGroupAdjustmentsValue();           </span>
<span class="-5014608312607866780" onmouseenter="enter('-5014608312607866780');" onmouseout="out('-5014608312607866780');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 547 +        Money fulfillmentPrice = retailPrice.subtract(orderDiscountFulfillmentGroupAdjustmentsValue);             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 548 +                                                                                                                  </span>
<span class="723442610052021445" onmouseenter="enter('723442610052021445');" onmouseout="out('723442610052021445');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +        fg.setFulfillmentPrice(fulfillmentPrice);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550      }                                                                                                             </span>
<span  style=""> 551                                                                                                                    </span>
<span class="-613491293141460653" onmouseenter="enter('-613491293141460653');" onmouseout="out('-613491293141460653');" style=""> 552      protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {   </span>
<span class="-2168953774981447317" onmouseenter="enter('-2168953774981447317');" onmouseout="out('-2168953774981447317');" style=""> 553          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();            </span>
<span class="-1134830134613695083" onmouseenter="enter('-1134830134613695083');" onmouseout="out('-1134830134613695083');" style=""> 554          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {                                      </span>
<span class="-3822470075223000180" onmouseenter="enter('-3822470075223000180');" onmouseout="out('-3822470075223000180');" style=""> 555              fgMap.put(fg.getFulfillmentGroup().getId(), fg);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556          }                                                                                                         </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 557          return fgMap;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558      }                                                                                                             </span>
<span  style=""> 559                                                                                                                    </span>
<span class="6665195593296681168" onmouseenter="enter('6665195593296681168');" onmouseout="out('6665195593296681168');" style=""><abbr title=" 560      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 560      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGrouðŸ”µ</abbr></span>
<span class="-7214313390686800174" onmouseenter="enter('-7214313390686800174');" onmouseout="out('-7214313390686800174');" style=""><abbr title=" 561          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 561          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustðŸ”µ</abbr></span>
<span class="331019091121439684" onmouseenter="enter('331019091121439684');" onmouseout="out('331019091121439684');" style=""> 562          for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {    </span>
<span class="1110980486512930755" onmouseenter="enter('1110980486512930755');" onmouseout="out('1110980486512930755');" style=""> 563              fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 564          }                                                                                                         </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 565          return fgMap;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 566      }                                                                                                             </span>
<span  style=""> 567                                                                                                                    </span>
<span class="-7617178904345879788" onmouseenter="enter('-7617178904345879788');" onmouseout="out('-7617178904345879788');" style=""><abbr title=" 568      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 568      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotabðŸ”µ</abbr></span>
<span class="1705100339866591039" onmouseenter="enter('1705100339866591039');" onmouseout="out('1705100339866591039');" style=""> 569          Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator(); </span>
<span class="6869467232437188017" onmouseenter="enter('6869467232437188017');" onmouseout="out('6869467232437188017');" style=""><abbr title=" 570          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 570          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFGðŸ”µ</abbr></span>
<span  style=""> 571                                                                                                                    </span>
<span class="7622903297016040666" onmouseenter="enter('7622903297016040666');" onmouseout="out('7622903297016040666');" style=""> 572          // First try and update existing adjustment records                                                       </span>
<span class="6593219943708493598" onmouseenter="enter('6593219943708493598');" onmouseout="out('6593219943708493598');" style=""> 573          while (adjustmentIterator.hasNext()) {                                                                    </span>
<span class="5134089875457655542" onmouseenter="enter('5134089875457655542');" onmouseout="out('5134089875457655542');" style=""> 574              FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();                                    </span>
<span class="9090174154450682409" onmouseenter="enter('9090174154450682409');" onmouseout="out('9090174154450682409');" style=""> 575              PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId()); </span>
<span class="7739365516519203047" onmouseenter="enter('7739365516519203047');" onmouseout="out('7739365516519203047');" style=""> 576              if (newAdj != null) {                                                                                 </span>
<span class="5102959516436064847" onmouseenter="enter('5102959516436064847');" onmouseout="out('5102959516436064847');" style=""> 577                  if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {                                 </span>
<span class="-6634291412355259187" onmouseenter="enter('-6634291412355259187');" onmouseout="out('-6634291412355259187');" style=""> 578                      // Update the currentAdj.                                                                     </span>
<span class="-4755037759892167947" onmouseenter="enter('-4755037759892167947');" onmouseout="out('-4755037759892167947');" style=""> 579                      currentAdj.setValue(newAdj.getAdjustmentValue());                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 580                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 581              } else {                                                                                              </span>
<span class="-5437992937664131712" onmouseenter="enter('-5437992937664131712');" onmouseout="out('-5437992937664131712');" style=""> 582                  // Removing no longer valid adjustment                                                            </span>
<span class="-6800144716907845476" onmouseenter="enter('-6800144716907845476');" onmouseout="out('-6800144716907845476');" style=""> 583                  adjustmentIterator.remove();                                                                      </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 584              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585          }                                                                                                         </span>
<span  style=""> 586                                                                                                                    </span>
<span class="4911772249630101500" onmouseenter="enter('4911772249630101500');" onmouseout="out('4911772249630101500');" style=""> 587          // Now add missing adjustments                                                                            </span>
<span class="8170167194272017979" onmouseenter="enter('8170167194272017979');" onmouseout="out('8170167194272017979');" style=""> 588          for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {                           </span>
<span class="-4188265609244912176" onmouseenter="enter('-4188265609244912176');" onmouseout="out('-4188265609244912176');" style=""> 589              FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();                          </span>
<span class="3068706828930127416" onmouseenter="enter('3068706828930127416');" onmouseout="out('3068706828930127416');" style=""> 590              fa.setFulfillmentGroup(fg);                                                                           </span>
<span class="5392928859383582349" onmouseenter="enter('5392928859383582349');" onmouseout="out('5392928859383582349');" style=""> 591              fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);                   </span>
<span class="4727884307924071496" onmouseenter="enter('4727884307924071496');" onmouseout="out('4727884307924071496');" style=""> 592              fa.setValue(newAdj.getAdjustmentValue());                                                             </span>
<span class="-1586043412444283157" onmouseenter="enter('-1586043412444283157');" onmouseout="out('-1586043412444283157');" style=""> 593              fg.getFulfillmentGroupAdjustments().add(fa);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 594          }                                                                                                         </span>
<span  style=""> 595                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 596      }                                                                                                             </span>
<span  style=""> 597                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 598      @Override                                                                                                     </span>
<span class="-4816910989941817274" onmouseenter="enter('-4816910989941817274');" onmouseout="out('-4816910989941817274');" style=""> 599      public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {                                </span>
<span class="-3850751249412137645" onmouseenter="enter('-3850751249412137645');" onmouseout="out('-3850751249412137645');" style=""> 600          synchronizeOrderAdjustments(promotableOrder);                                                             </span>
<span class="4518036952510487894" onmouseenter="enter('4518036952510487894');" onmouseout="out('4518036952510487894');" style=""> 601          synchronizeOrderItems(promotableOrder);                                                                   </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 602          if (extensionManager != null) {                                                                           </span>
<span class="-6179159556176464024" onmouseenter="enter('-6179159556176464024');" onmouseout="out('-6179159556176464024');" style=""> 603              extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 604          }                                                                                                         </span>
<span class="-159866277563841870" onmouseenter="enter('-159866277563841870');" onmouseout="out('-159866277563841870');" style=""> 605          synchronizeFulfillmentGroups(promotableOrder);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 606      }                                                                                                             </span>
<span  style=""> 607                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 608      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 609      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 610          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 611      }                                                                                                             </span>
<span  style=""> 612                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 613      @Override                                                                                                     </span>
<span class="6530687858988053885" onmouseenter="enter('6530687858988053885');" onmouseout="out('6530687858988053885');" style=""> 614      public void setOrderItemDao(OrderItemDao orderItemDao) {                                                      </span>
<span class="-8374754321118159364" onmouseenter="enter('-8374754321118159364');" onmouseout="out('-8374754321118159364');" style=""> 615          this.orderItemDao = orderItemDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616      }                                                                                                             </span>
<span  style=""> 617                                                                                                                    </span>
<span class="-6632247919309783023" onmouseenter="enter('-6632247919309783023');" onmouseout="out('-6632247919309783023');" style=""> 618      public OfferServiceUtilities getOfferServiceUtilities() {                                                     </span>
<span class="-6406517936839827979" onmouseenter="enter('-6406517936839827979');" onmouseout="out('-6406517936839827979');" style=""> 619          return offerServiceUtilities;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 620      }                                                                                                             </span>
<span  style=""> 621                                                                                                                    </span>
<span class="4442139862126007445" onmouseenter="enter('4442139862126007445');" onmouseout="out('4442139862126007445');" style=""> 622      public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {                           </span>
<span class="4552134412879762115" onmouseenter="enter('4552134412879762115');" onmouseout="out('4552134412879762115');" style=""> 623          this.offerServiceUtilities = offerServiceUtilities;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 624      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-4156106492343801428" onmouseenter="enter('-4156106492343801428');" onmouseout="out('-4156106492343801428');" style="">  18  package org.broadleafcommerce.core.offer.service.processor;                                                       </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-274639712180431568" onmouseenter="enter('-274639712180431568');" onmouseout="out('-274639712180431568');" style="">  22  import org.broadleafcommerce.common.money.Money;                                                                  </span>
<span class="-1492144387614747576" onmouseenter="enter('-1492144387614747576');" onmouseout="out('-1492144387614747576');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.broadleafcommerce.common.service.GenericEntityService;                                                 </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  24  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="5599608658353832247" onmouseenter="enter('5599608658353832247');" onmouseout="out('5599608658353832247');" style="">  25  import org.broadleafcommerce.core.offer.domain.FulfillmentGroupAdjustment;                                        </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  26  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="-6494010243902923492" onmouseenter="enter('-6494010243902923492');" onmouseout="out('-6494010243902923492');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  27 -import org.broadleafcommerce.core.offer.domain.OfferItemCriteria;                                                 </span>
<span class="-556809404433666112" onmouseenter="enter('-556809404433666112');" onmouseout="out('-556809404433666112');" style="">  28  import org.broadleafcommerce.core.offer.domain.OfferOfferRuleXref;                                                </span>
<span class="-521081291127015873" onmouseenter="enter('-521081291127015873');" onmouseout="out('-521081291127015873');" style="">  29  import org.broadleafcommerce.core.offer.domain.OrderAdjustment;                                                   </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  30  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="2599349157106653381" onmouseenter="enter('2599349157106653381');" onmouseout="out('2599349157106653381');" style="">  31  import org.broadleafcommerce.core.offer.service.OfferServiceUtilities;                                            </span>
<span class="212527052176527689" onmouseenter="enter('212527052176527689');" onmouseout="out('212527052176527689');" style="">  32  import org.broadleafcommerce.core.offer.service.discount.CandidatePromotionItems;                                 </span>
<span class="180286745313216238" onmouseenter="enter('180286745313216238');" onmouseout="out('180286745313216238');" style="">  33  import org.broadleafcommerce.core.offer.service.discount.PromotionQualifier;                                      </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  34 -import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  35  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="4826353322748911550" onmouseenter="enter('4826353322748911550');" onmouseout="out('4826353322748911550');" style="">  36  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroup;                       </span>
<span class="-6049809183476525616" onmouseenter="enter('-6049809183476525616');" onmouseout="out('-6049809183476525616');" style="">  37  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableFulfillmentGroupAdjustment;             </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  38  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>

<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="9000862227337796749" onmouseenter="enter('9000862227337796749');" onmouseout="out('9000862227337796749');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderAdjustment;                        </span>
<span class="-7733804833771661823" onmouseenter="enter('-7733804833771661823');" onmouseout="out('-7733804833771661823');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItem;                              </span>
<span class="2677462620955414718" onmouseenter="enter('2677462620955414718');" onmouseout="out('2677462620955414718');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetail;                   </span>
<span class="-5097841332942556730" onmouseenter="enter('-5097841332942556730');" onmouseout="out('-5097841332942556730');" style="">  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrderItemPriceDetailAdjustment;         </span>
<span class="-5253725521220244448" onmouseenter="enter('-5253725521220244448');" onmouseout="out('-5253725521220244448');" style="">  44  import org.broadleafcommerce.core.offer.service.type.OfferDiscountType;                                           </span>
<span class="1925170083501964673" onmouseenter="enter('1925170083501964673');" onmouseout="out('1925170083501964673');" style="">  45  import org.broadleafcommerce.core.offer.service.type.OfferRuleType;                                               </span>
<span class="-7012758821456487335" onmouseenter="enter('-7012758821456487335');" onmouseout="out('-7012758821456487335');" style="">  46  import org.broadleafcommerce.core.order.dao.OrderItemDao;                                                         </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  47  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  48  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  49  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  50  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="573363609456981556" onmouseenter="enter('573363609456981556');" onmouseout="out('573363609456981556');" style="">  51  import org.broadleafcommerce.core.order.domain.OrderItemQualifier;                                                </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  52  import org.springframework.stereotype.Service;                                                                    </span>
<span  style="">  53                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  54  import java.util.ArrayList;                                                                                       </span>
<span class="2187055016371707860" onmouseenter="enter('2187055016371707860');" onmouseout="out('2187055016371707860');" style="">  55  import java.util.Collections;                                                                                     </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  56  import java.util.HashMap;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  57  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  58  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  59  import java.util.Map;                                                                                             </span>
<span  style="">  60                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  61  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  62                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  63  /**                                                                                                               </span>
<span class="5097862330762959365" onmouseenter="enter('5097862330762959365');" onmouseout="out('5097862330762959365');" style="">  64   * @author jfischer, bpolster                                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  65   */                                                                                                               </span>
<span class="-2245109148562763451" onmouseenter="enter('-2245109148562763451');" onmouseout="out('-2245109148562763451');" style="">  66  @Service(&quot;blOrderOfferProcessor&quot;)                                                                                 </span>
<span class="-4961554400286801245" onmouseenter="enter('-4961554400286801245');" onmouseout="out('-4961554400286801245');" style="">  67  public class OrderOfferProcessorImpl extends AbstractBaseProcessor implements OrderOfferProcessor {               </span>
<span  style="">  68                                                                                                                    </span>
<span class="-2801860175860773750" onmouseenter="enter('-2801860175860773750');" onmouseout="out('-2801860175860773750');" style="">  69      private static final Log LOG = LogFactory.getLog(OrderOfferProcessorImpl.class);                              </span>
<span  style="">  70                                                                                                                    </span>
<span class="5938907043749528173" onmouseenter="enter('5938907043749528173');" onmouseout="out('5938907043749528173');" style="">  71      @Resource(name = &quot;blPromotableItemFactory&quot;)                                                                   </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  72      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style="">  73                                                                                                                    </span>
<span class="-2264776225690683323" onmouseenter="enter('-2264776225690683323');" onmouseout="out('-2264776225690683323');" style="">  74      @Resource(name = &quot;blOrderItemDao&quot;)                                                                            </span>
<span class="1921252040396799605" onmouseenter="enter('1921252040396799605');" onmouseout="out('1921252040396799605');" style="">  75      protected OrderItemDao orderItemDao;                                                                          </span>
<span  style="">  76                                                                                                                    </span>
<span class="5779429748772127951" onmouseenter="enter('5779429748772127951');" onmouseout="out('5779429748772127951');" style="">  77      @Resource(name = &quot;blOfferDao&quot;)                                                                                </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  78      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  79                                                                                                                    </span>
<span class="2002571695049097079" onmouseenter="enter('2002571695049097079');" onmouseout="out('2002571695049097079');" style="">  80      @Resource(name = &quot;blOfferServiceUtilities&quot;)                                                                   </span>
<span class="-2602045083470320651" onmouseenter="enter('-2602045083470320651');" onmouseout="out('-2602045083470320651');" style="">  81      protected OfferServiceUtilities offerServiceUtilities;                                                        </span>




<span  style="">  82                                                                                                                    </span>
<span class="2258512980686044159" onmouseenter="enter('2258512980686044159');" onmouseout="out('2258512980686044159');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    @Resource(name = &quot;blGenericEntityService&quot;)                                                                    </span>
<span class="5310520372352255538" onmouseenter="enter('5310520372352255538');" onmouseout="out('5310520372352255538');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    protected GenericEntityService entityService;                                                                 </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  86      @Override                                                                                                     </span>
<span class="8191629067464325977" onmouseenter="enter('8191629067464325977');" onmouseout="out('8191629067464325977');" style=""><abbr title="  87      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {">  87      public void filterOrderLevelOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiðŸ”µ</abbr></span>
<span class="-6690931251258113559" onmouseenter="enter('-6690931251258113559');" onmouseout="out('-6690931251258113559');" style="">  88          if (offer.getDiscountType().getType().equals(OfferDiscountType.FIX_PRICE.getType())) {                    </span>
<span class="2381861258987592021" onmouseenter="enter('2381861258987592021');" onmouseout="out('2381861258987592021');" style=""><abbr title="  89              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot; + offer.getName() + &quot;)&quot;);">  89              LOG.warn(&quot;Offers of type ORDER may not have a discount type of FIX_PRICE. Ignoring order offer (name=&quot;ðŸ”µ</abbr></span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style="">  90              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  91          }                                                                                                         </span>
<span class="-1909487068460560279" onmouseenter="enter('-1909487068460560279');" onmouseout="out('-1909487068460560279');" style="">  92          boolean orderLevelQualification = false;                                                                  </span>
<span class="-826538299394729423" onmouseenter="enter('-826538299394729423');" onmouseout="out('-826538299394729423');" style="">  93          //Order Qualification                                                                                     </span>
<span class="-5521254225981685482" onmouseenter="enter('-5521254225981685482');" onmouseout="out('-5521254225981685482');" style="">  94          orderQualification:                                                                                       </span>
<span class="5677081435180812955" onmouseenter="enter('5677081435180812955');" onmouseout="out('5677081435180812955');" style="">  95          {                                                                                                         </span>
<span class="-7608560305899310529" onmouseenter="enter('-7608560305899310529');" onmouseout="out('-7608560305899310529');" style="">  96              if (couldOfferApplyToOrder(offer, promotableOrder)) {                                                 </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style="">  97                  orderLevelQualification = true;                                                                   </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style="">  98                  break orderQualification;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99              }                                                                                                     </span>
<span class="7444608498293955145" onmouseenter="enter('7444608498293955145');" onmouseout="out('7444608498293955145');" style=""><abbr title=" 100              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {"> 100              for (PromotableOrderItem orderItem : promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountTðŸ”µ</abbr></span>
<span class="5211303022284930113" onmouseenter="enter('5211303022284930113');" onmouseout="out('5211303022284930113');" style=""> 101                  if (couldOfferApplyToOrder(offer, promotableOrder, orderItem)) {                                  </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 102                      orderLevelQualification = true;                                                               </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 103                      break orderQualification;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105              }                                                                                                     </span>
<span class="-3473403760382889072" onmouseenter="enter('-3473403760382889072');" onmouseout="out('-3473403760382889072');" style=""> 106              for (PromotableFulfillmentGroup fulfillmentGroup : promotableOrder.getFulfillmentGroups()) {          </span>
<span class="7357760135902725095" onmouseenter="enter('7357760135902725095');" onmouseout="out('7357760135902725095');" style=""> 107                  if (couldOfferApplyToOrder(offer, promotableOrder, fulfillmentGroup)) {                           </span>
<span class="8014573359920704091" onmouseenter="enter('8014573359920704091');" onmouseout="out('8014573359920704091');" style=""> 108                      orderLevelQualification = true;                                                               </span>
<span class="6927683855924721569" onmouseenter="enter('6927683855924721569');" onmouseout="out('6927683855924721569');" style=""> 109                      break orderQualification;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 110                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112          }                                                                                                         </span>
<span class="5034616183006708671" onmouseenter="enter('5034616183006708671');" onmouseout="out('5034616183006708671');" style=""> 113          //Item Qualification - new for 1.5!                                                                       </span>
<span class="3708307267894275622" onmouseenter="enter('3708307267894275622');" onmouseout="out('3708307267894275622');" style=""> 114          if (orderLevelQualification) {                                                                            </span>
<span class="4083707686274340956" onmouseenter="enter('4083707686274340956');" onmouseout="out('4083707686274340956');" style=""><abbr title=" 115              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));"> 115              CandidatePromotionItems candidates = couldOfferApplyToOrderItems(offer, promotableOrder.getDiscountablðŸ”µ</abbr></span>
<span class="2629114037035373615" onmouseenter="enter('2629114037035373615');" onmouseout="out('2629114037035373615');" style=""> 116              if (candidates.isMatchedQualifier()) {                                                                </span>
<span class="5830719426865289135" onmouseenter="enter('5830719426865289135');" onmouseout="out('5830719426865289135');" style=""><abbr title=" 117                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifiedOrderOffers, offer);"> 117                  PromotableCandidateOrderOffer candidateOffer = createCandidateOrderOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-2643650349584698588" onmouseenter="enter('-2643650349584698588');" onmouseout="out('-2643650349584698588');" style=""> 118                  candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 119              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121      }                                                                                                             </span>
<span  style=""> 122                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 123      @Override                                                                                                     </span>
<span class="-6078198317128464464" onmouseenter="enter('-6078198317128464464');" onmouseout="out('-6078198317128464464');" style=""> 124      public boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder) {                         </span>
<span class="6994875763592911045" onmouseenter="enter('6994875763592911045');" onmouseout="out('6994875763592911045');" style=""> 125          return couldOfferApplyToOrder(offer, promotableOrder, null, null);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126      }                                                                                                             </span>
<span  style=""> 127                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 128      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 129       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 130       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 131       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 132       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 133       * @param order                                                                                               </span>
<span class="3239114303692248883" onmouseenter="enter('3239114303692248883');" onmouseout="out('3239114303692248883');" style=""> 134       * @param orderItem                                                                                           </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 135       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 136       */                                                                                                           </span>
<span class="-90678225806082002" onmouseenter="enter('-90678225806082002');" onmouseout="out('-90678225806082002');" style=""><abbr title=" 137      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem orderItem) {"> 137      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem ordðŸ”µ</abbr></span>
<span class="-1630600385205451505" onmouseenter="enter('-1630600385205451505');" onmouseout="out('-1630600385205451505');" style=""> 138          return couldOfferApplyToOrder(offer, promotableOrder, orderItem, null);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139      }                                                                                                             </span>
<span  style=""> 140                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 141      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 142       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 143       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 144       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 145       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 146       * @param order                                                                                               </span>
<span class="-7108679256071712026" onmouseenter="enter('-7108679256071712026');" onmouseout="out('-7108679256071712026');" style=""> 147       * @param fulfillmentGroup                                                                                    </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 148       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 149       */                                                                                                           </span>
<span class="-667507213825504723" onmouseenter="enter('-667507213825504723');" onmouseout="out('-667507213825504723');" style=""><abbr title=" 150      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGroup fulfillmentGroup) {"> 150      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableFulfillmentGrðŸ”µ</abbr></span>
<span class="-5817125691165623435" onmouseenter="enter('-5817125691165623435');" onmouseout="out('-5817125691165623435');" style=""> 151          return couldOfferApplyToOrder(offer, promotableOrder, null, fulfillmentGroup);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152      }                                                                                                             </span>
<span  style=""> 153                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 154      /**                                                                                                           </span>
<span class="-5627000049795404697" onmouseenter="enter('-5627000049795404697');" onmouseout="out('-5627000049795404697');" style=""> 155       * Private method which executes the appliesToOrderRules in the Offer to determine if this offer              </span>
<span class="5571396584287068712" onmouseenter="enter('5571396584287068712');" onmouseout="out('5571396584287068712');" style=""> 156       * can be applied to the Order, OrderItem, or FulfillmentGroup.                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 157       *                                                                                                            </span>
<span class="8798115888025442647" onmouseenter="enter('8798115888025442647');" onmouseout="out('8798115888025442647');" style=""> 158       * @param offer                                                                                               </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 159       * @param order                                                                                               </span>
<span class="-4036081007465325177" onmouseenter="enter('-4036081007465325177');" onmouseout="out('-4036081007465325177');" style=""> 160       * @param promotableOrderItem                                                                                 </span>
<span class="-8152129500080290565" onmouseenter="enter('-8152129500080290565');" onmouseout="out('-8152129500080290565');" style=""> 161       * @param promotableFulfillmentGroup                                                                          </span>
<span class="1301330867707988004" onmouseenter="enter('1301330867707988004');" onmouseout="out('1301330867707988004');" style=""> 162       * @return true if offer can be applied, otherwise false                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 163       */                                                                                                           </span>
<span class="-3457716414026742708" onmouseenter="enter('-3457716414026742708');" onmouseout="out('-3457716414026742708');" style=""><abbr title=" 164      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem promotableOrderItem, PromotableFulfillmentGroup promotableFulfillmentGroup) {"> 164      protected boolean couldOfferApplyToOrder(Offer offer, PromotableOrder promotableOrder, PromotableOrderItem proðŸ”µ</abbr></span>
<span class="6012064276783556206" onmouseenter="enter('6012064276783556206');" onmouseout="out('6012064276783556206');" style=""> 165          boolean appliesToItem = false;                                                                            </span>
<span class="2877098389407446108" onmouseenter="enter('2877098389407446108');" onmouseout="out('2877098389407446108');" style=""> 166          String rule = null;                                                                                       </span>
<span class="1562125678824942427" onmouseenter="enter('1562125678824942427');" onmouseout="out('1562125678824942427');" style=""> 167          OfferOfferRuleXref orderRule = offer.getOfferMatchRulesXref().get(OfferRuleType.ORDER.getType());         </span>
<span class="8836327960017040493" onmouseenter="enter('8836327960017040493');" onmouseout="out('8836327960017040493');" style=""> 168          if (orderRule != null &amp;&amp; orderRule.getOfferRule() != null) {                                              </span>
<span class="-7963530667142055111" onmouseenter="enter('-7963530667142055111');" onmouseout="out('-7963530667142055111');" style=""> 169              rule = orderRule.getOfferRule().getMatchRule();                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170          }                                                                                                         </span>
<span  style=""> 171                                                                                                                    </span>
<span class="5810732230915198369" onmouseenter="enter('5810732230915198369');" onmouseout="out('5810732230915198369');" style=""> 172          if (rule != null) {                                                                                       </span>
<span  style=""> 173                                                                                                                    </span>
<span class="8884608966566249698" onmouseenter="enter('8884608966566249698');" onmouseout="out('8884608966566249698');" style=""> 174              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();                                         </span>
<span class="1671864453263259632" onmouseenter="enter('1671864453263259632');" onmouseout="out('1671864453263259632');" style=""> 175              promotableOrder.updateRuleVariables(vars);                                                            </span>
<span class="-7784011122993792428" onmouseenter="enter('-7784011122993792428');" onmouseout="out('-7784011122993792428');" style=""> 176              vars.put(&quot;offer&quot;, offer);                                                                             </span>
<span class="8596724536333203596" onmouseenter="enter('8596724536333203596');" onmouseout="out('8596724536333203596');" style=""> 177              if (promotableFulfillmentGroup != null) {                                                             </span>
<span class="4746323176778251021" onmouseenter="enter('4746323176778251021');" onmouseout="out('4746323176778251021');" style=""> 178                  promotableFulfillmentGroup.updateRuleVariables(vars);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179              }                                                                                                     </span>
<span class="-4723719306153838221" onmouseenter="enter('-4723719306153838221');" onmouseout="out('-4723719306153838221');" style=""> 180              if (promotableOrderItem != null) {                                                                    </span>
<span class="-3080150609740522861" onmouseenter="enter('-3080150609740522861');" onmouseout="out('-3080150609740522861');" style=""> 181                  promotableOrderItem.updateRuleVariables(vars);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182              }                                                                                                     </span>
<span class="8856405891316557013" onmouseenter="enter('8856405891316557013');" onmouseout="out('8856405891316557013');" style=""> 183              Boolean expressionOutcome = executeExpression(rule, vars);                                            </span>
<span class="5232502196242835360" onmouseenter="enter('5232502196242835360');" onmouseout="out('5232502196242835360');" style=""> 184              if (expressionOutcome != null &amp;&amp; expressionOutcome) {                                                 </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 185                  appliesToItem = true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 186              }                                                                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 187          } else {                                                                                                  </span>
<span class="-1847817716832982125" onmouseenter="enter('-1847817716832982125');" onmouseout="out('-1847817716832982125');" style=""> 188              appliesToItem = true;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189          }                                                                                                         </span>
<span  style=""> 190                                                                                                                    </span>
<span class="8141379926235681461" onmouseenter="enter('8141379926235681461');" onmouseout="out('8141379926235681461');" style=""> 191          return appliesToItem;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192      }                                                                                                             </span>
<span  style=""> 193                                                                                                                    </span>
<span class="7829573362373940985" onmouseenter="enter('7829573362373940985');" onmouseout="out('7829573362373940985');" style=""><abbr title=" 194      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers, Offer offer) {"> 194      protected PromotableCandidateOrderOffer createCandidateOrderOffer(PromotableOrder promotableOrder, List&lt;PromotðŸ”µ</abbr></span>
<span class="306330145608771928" onmouseenter="enter('306330145608771928');" onmouseout="out('306330145608771928');" style=""><abbr title=" 195          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidateOrderOffer(promotableOrder, offer);"> 195          PromotableCandidateOrderOffer promotableCandidateOrderOffer = promotableItemFactory.createPromotableCandidðŸ”µ</abbr></span>
<span class="5216830913987868628" onmouseenter="enter('5216830913987868628');" onmouseout="out('5216830913987868628');" style=""> 196          qualifiedOrderOffers.add(promotableCandidateOrderOffer);                                                  </span>
<span  style=""> 197                                                                                                                    </span>
<span class="8900972580850147104" onmouseenter="enter('8900972580850147104');" onmouseout="out('8900972580850147104');" style=""> 198          return promotableCandidateOrderOffer;                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199      }                                                                                                             </span>
<span  style=""> 200                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 201      @Override                                                                                                     </span>
<span class="5964334254617273825" onmouseenter="enter('5964334254617273825');" onmouseout="out('5964334254617273825');" style=""><abbr title=" 202      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; candidateOffers) {"> 202      public List&lt;PromotableCandidateOrderOffer&gt; removeTrailingNotCombinableOrderOffers(List&lt;PromotableCandidateOrdeðŸ”µ</abbr></span>
<span class="3985416668088414845" onmouseenter="enter('3985416668088414845');" onmouseout="out('3985416668088414845');" style=""><abbr title=" 203          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 203          List&lt;PromotableCandidateOrderOffer&gt; remainingCandidateOffers = new ArrayList&lt;PromotableCandidateOrderOfferðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 204          int offerCount = 0;                                                                                       </span>
<span class="6508259141671549344" onmouseenter="enter('6508259141671549344');" onmouseout="out('6508259141671549344');" style=""> 205          for (PromotableCandidateOrderOffer candidateOffer : candidateOffers) {                                    </span>
<span class="8700395077100738449" onmouseenter="enter('8700395077100738449');" onmouseout="out('8700395077100738449');" style=""> 206              if (offerCount == 0) {                                                                                </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 207                  remainingCandidateOffers.add(candidateOffer);                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 208              } else {                                                                                              </span>
<span class="-2676530692785987369" onmouseenter="enter('-2676530692785987369');" onmouseout="out('-2676530692785987369');" style=""> 209                  if (candidateOffer.getOffer().isCombinableWithOtherOffers() &amp;&amp;                                    </span>
<span class="2920776142298371855" onmouseenter="enter('2920776142298371855');" onmouseout="out('2920776142298371855');" style=""> 210                          !candidateOffer.getOffer().isTotalitarianOffer()) {                                       </span>
<span class="-3940424460947753903" onmouseenter="enter('-3940424460947753903');" onmouseout="out('-3940424460947753903');" style=""> 211                      remainingCandidateOffers.add(candidateOffer);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213              }                                                                                                     </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 214              offerCount++;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215          }                                                                                                         </span>
<span class="5367008489542993301" onmouseenter="enter('5367008489542993301');" onmouseout="out('5367008489542993301');" style=""> 216          return remainingCandidateOffers;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217      }                                                                                                             </span>
<span  style=""> 218                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 219      @Override                                                                                                     </span>
<span class="8954636300636023369" onmouseenter="enter('8954636300636023369');" onmouseout="out('8954636300636023369');" style=""><abbr title=" 220      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrder) {"> 220      public void applyAllOrderOffers(List&lt;PromotableCandidateOrderOffer&gt; orderOffers, PromotableOrder promotableOrdðŸ”µ</abbr></span>
<span class="-7971504164894226146" onmouseenter="enter('-7971504164894226146');" onmouseout="out('-7971504164894226146');" style=""><abbr title=" 221          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discount total vs this offer&#x27;s total"> 221          // If order offer is not combinable, first verify order adjustment is zero, if zero, compare item discountðŸ”µ</abbr></span>
<span class="1108112804447486968" onmouseenter="enter('1108112804447486968');" onmouseout="out('1108112804447486968');" style=""> 222          Iterator&lt;PromotableCandidateOrderOffer&gt; orderOfferIterator = orderOffers.iterator();                      </span>
<span class="3603986812472116533" onmouseenter="enter('3603986812472116533');" onmouseout="out('3603986812472116533');" style=""> 223          while (orderOfferIterator.hasNext()) {                                                                    </span>
<span class="-7865108167409889797" onmouseenter="enter('-7865108167409889797');" onmouseout="out('-7865108167409889797');" style=""> 224              PromotableCandidateOrderOffer orderOffer = orderOfferIterator.next();                                 </span>
<span  style=""> 225                                                                                                                    </span>
<span class="-919097363910280710" onmouseenter="enter('-919097363910280710');" onmouseout="out('-919097363910280710');" style=""> 226              if (promotableOrder.canApplyOrderOffer(orderOffer)) {                                                 </span>
<span class="4017990809944563089" onmouseenter="enter('4017990809944563089');" onmouseout="out('4017990809944563089');" style=""><abbr title=" 227                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalRequirements(promotableOrder, orderOffer)) {"> 227                  if (orderMeetsQualifyingSubtotalRequirements(promotableOrder, orderOffer) &amp;&amp; orderMeetsSubtotalReqðŸ”µ</abbr></span>
<span class="-4210377854282903954" onmouseenter="enter('-4210377854282903954');" onmouseout="out('-4210377854282903954');" style=""> 228                      applyOrderOffer(promotableOrder, orderOffer);                                                 </span>
<span  style=""> 229                                                                                                                    </span>
<span class="5366287165432255586" onmouseenter="enter('5366287165432255586');" onmouseout="out('5366287165432255586');" style=""> 230                      if (orderOffer.isTotalitarian() || promotableOrder.isTotalitarianItemOfferApplied()) {        </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 231                          if (LOG.isTraceEnabled()) {                                                               </span>
<span class="3222834402337240688" onmouseenter="enter('3222834402337240688');" onmouseout="out('3222834402337240688');" style=""><abbr title=" 232                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for best outcome.&quot;);"> 232                              LOG.trace(&quot;Totalitarian Order Offer Applied.   Comparing order and item offers for besðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233                          }                                                                                         </span>
<span class="-4644781248556093759" onmouseenter="enter('-4644781248556093759');" onmouseout="out('-4644781248556093759');" style=""> 234                          compareAndAdjustOrderAndItemOffers(promotableOrder);                                      </span>
<span class="-8504589987429997467" onmouseenter="enter('-8504589987429997467');" onmouseout="out('-8504589987429997467');" style=""><abbr title=" 235                          // We continue because this could be the first offer and marked as totalitarian, but not as good as an"> 235                          // We continue because this could be the first offer and marked as totalitarian, but not aðŸ”µ</abbr></span>
<span class="-473363534111382515" onmouseenter="enter('-473363534111382515');" onmouseout="out('-473363534111382515');" style=""><abbr title=" 236                          // item offer. There could be other order offers that are not totalitarian that also qualify."> 236                          // item offer. There could be other order offers that are not totalitarian that also qualiðŸ”µ</abbr></span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 237                          continue;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238                      }                                                                                             </span>
<span  style=""> 239                                                                                                                    </span>
<span class="-155427173834895323" onmouseenter="enter('-155427173834895323');" onmouseout="out('-155427173834895323');" style=""> 240                      if (!orderOffer.isCombinable()) {                                                             </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 241                          if (LOG.isTraceEnabled()) {                                                               </span>
<span class="-641512738818000762" onmouseenter="enter('-641512738818000762');" onmouseout="out('-641512738818000762');" style=""><abbr title=" 242                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getId() + &quot;].  No other order offers can be applied&quot;);"> 242                              LOG.trace(&quot;Non-Combinable Order Offer Applied with id=[&quot; + orderOffer.getOffer().getIdðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243                          }                                                                                         </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 244                          break;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248          }                                                                                                         </span>
<span class="1071860375321424059" onmouseenter="enter('1071860375321424059');" onmouseout="out('1071860375321424059');" style=""> 249          promotableOrder.getOrder().setSubTotal(promotableOrder.calculateSubtotalWithAdjustments());               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250      }                                                                                                             </span>
<span  style=""> 251                                                                                                                    </span>
<span class="1494850857047655937" onmouseenter="enter('1494850857047655937');" onmouseout="out('1494850857047655937');" style=""><abbr title=" 252      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 252      protected boolean orderMeetsQualifyingSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffeðŸ”µ</abbr></span>
<span class="-2808877570377534999" onmouseenter="enter('-2808877570377534999');" onmouseout="out('-2808877570377534999');" style=""><abbr title=" 253          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOffer.getCandidateQualifiersMap());"> 253          return offerServiceUtilities.orderMeetsQualifyingSubtotalRequirements(order, orderOffer.getOffer(), orderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 254      }                                                                                                             </span>
<span  style=""> 255                                                                                                                    </span>
<span class="-8447973418270990594" onmouseenter="enter('-8447973418270990594');" onmouseout="out('-8447973418270990594');" style=""><abbr title=" 256      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffer) {"> 256      protected boolean orderMeetsSubtotalRequirements(PromotableOrder order, PromotableCandidateOrderOffer orderOffðŸ”µ</abbr></span>
<span class="8346114644175432666" onmouseenter="enter('8346114644175432666');" onmouseout="out('8346114644175432666');" style=""> 257          return offerServiceUtilities.orderMeetsSubtotalRequirements(order, orderOffer.getOffer());                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258      }                                                                                                             </span>
<span  style=""> 259                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 260      /**                                                                                                           </span>
<span class="7019315089426478439" onmouseenter="enter('7019315089426478439');" onmouseout="out('7019315089426478439');" style=""> 261       * Called when the system must determine whether to apply order or item adjustments.                          </span>
<span class="-8371223817828724637" onmouseenter="enter('-8371223817828724637');" onmouseout="out('-8371223817828724637');" style=""> 262       * @param promotableOrder                                                                                     </span>
<span class="-2490256996948663406" onmouseenter="enter('-2490256996948663406');" onmouseout="out('-2490256996948663406');" style=""> 263       * @param orderOffersApplied                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 264       */                                                                                                           </span>
<span class="7043079218483465061" onmouseenter="enter('7043079218483465061');" onmouseout="out('7043079218483465061');" style=""> 265      protected void compareAndAdjustOrderAndItemOffers(PromotableOrder promotableOrder) {                          </span>
<span class="-4146438378303178005" onmouseenter="enter('-4146438378303178005');" onmouseout="out('-4146438378303178005');" style=""> 266          Money orderAdjustmentTotal = promotableOrder.calculateOrderAdjustmentTotal();                             </span>
<span class="7927037930311470382" onmouseenter="enter('7927037930311470382');" onmouseout="out('7927037930311470382');" style=""> 267          Money itemAdjustmentTotal = promotableOrder.calculateItemAdjustmentTotal();                               </span>
<span  style=""> 268                                                                                                                    </span>
<span class="-1625160164833054598" onmouseenter="enter('-1625160164833054598');" onmouseout="out('-1625160164833054598');" style=""> 269          if (orderAdjustmentTotal.greaterThanOrEqual(itemAdjustmentTotal)) {                                       </span>
<span class="-7027301438537880380" onmouseenter="enter('-7027301438537880380');" onmouseout="out('-7027301438537880380');" style=""> 270              promotableOrder.removeAllCandidateItemOfferAdjustments();                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 271          } else {                                                                                                  </span>
<span class="6517108348190993777" onmouseenter="enter('6517108348190993777');" onmouseout="out('6517108348190993777');" style=""> 272              promotableOrder.removeAllCandidateOrderOfferAdjustments();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 273          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274      }                                                                                                             </span>
<span  style=""> 275                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 276      /**                                                                                                           </span>
<span class="-6223401290020760984" onmouseenter="enter('-6223401290020760984');" onmouseout="out('-6223401290020760984');" style=""> 277       * Private method used by applyAllOrderOffers to create an OrderAdjustment from a CandidateOrderOffer         </span>
<span class="6836988226136200872" onmouseenter="enter('6836988226136200872');" onmouseout="out('6836988226136200872');" style=""> 278       * and associates the OrderAdjustment to the Order.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 279       *                                                                                                            </span>
<span class="6951516900174217638" onmouseenter="enter('6951516900174217638');" onmouseout="out('6951516900174217638');" style=""> 280       * @param orderOffer a CandidateOrderOffer to apply to an Order                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 281       */                                                                                                           </span>
<span class="-1056565336427362312" onmouseenter="enter('-1056565336427362312');" onmouseout="out('-1056565336427362312');" style=""> 282      protected void applyOrderOffer(PromotableOrder promotableOrder, PromotableCandidateOrderOffer orderOffer) {   </span>
<span class="-3917047491438167754" onmouseenter="enter('-3917047491438167754');" onmouseout="out('-3917047491438167754');" style=""><abbr title=" 283          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustment(orderOffer, promotableOrder);"> 283          PromotableOrderAdjustment promotableOrderAdjustment = promotableItemFactory.createPromotableOrderAdjustmenðŸ”µ</abbr></span>
<span class="2459651529956168438" onmouseenter="enter('2459651529956168438');" onmouseout="out('2459651529956168438');" style=""> 284          promotableOrder.addCandidateOrderAdjustment(promotableOrderAdjustment);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285      }                                                                                                             </span>
<span  style=""> 286                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 287      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 288      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 289          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290      }                                                                                                             </span>
<span  style=""> 291                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 292      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 293      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 294          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 295      }                                                                                                             </span>
<span  style=""> 296                                                                                                                    </span>
<span class="-7694825550100150639" onmouseenter="enter('-7694825550100150639');" onmouseout="out('-7694825550100150639');" style=""><abbr title=" 297      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrder) {"> 297      protected Map&lt;Long, PromotableOrderAdjustment&gt; buildPromotableOrderAdjustmentsMap(PromotableOrder promotableOrðŸ”µ</abbr></span>
<span class="-2272462204816182006" onmouseenter="enter('-2272462204816182006');" onmouseout="out('-2272462204816182006');" style=""> 298          Map&lt;Long, PromotableOrderAdjustment&gt; adjustmentsMap = new HashMap&lt;Long, PromotableOrderAdjustment&gt;();     </span>
<span class="-7354354578377701904" onmouseenter="enter('-7354354578377701904');" onmouseout="out('-7354354578377701904');" style=""> 299          for (PromotableOrderAdjustment adjustment : promotableOrder.getCandidateOrderAdjustments()) {             </span>
<span class="-7366330237630024028" onmouseenter="enter('-7366330237630024028');" onmouseout="out('-7366330237630024028');" style=""> 300              adjustmentsMap.put(adjustment.getOffer().getId(), adjustment);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 301          }                                                                                                         </span>
<span class="7908136136791584596" onmouseenter="enter('7908136136791584596');" onmouseout="out('7908136136791584596');" style=""> 302          return adjustmentsMap;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303      }                                                                                                             </span>
<span  style=""> 304                                                                                                                    </span>
<span class="8556164244366976053" onmouseenter="enter('8556164244366976053');" onmouseout="out('8556164244366976053');" style=""> 305      protected void synchronizeOrderAdjustments(PromotableOrder promotableOrder) {                                 </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 306          Order order = promotableOrder.getOrder();                                                                 </span>
<span  style=""> 307                                                                                                                    </span>
<span class="-6033320157511533636" onmouseenter="enter('-6033320157511533636');" onmouseout="out('-6033320157511533636');" style=""> 308          if (order.getOrderAdjustments().isEmpty() &amp;&amp; promotableOrder.getCandidateOrderAdjustments().isEmpty()) {  </span>
<span class="4043029072030362567" onmouseenter="enter('4043029072030362567');" onmouseout="out('4043029072030362567');" style=""> 309              return;                                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 310          }                                                                                                         </span>
<span  style=""> 311                                                                                                                    </span>
<span class="-926001645706785786" onmouseenter="enter('-926001645706785786');" onmouseout="out('-926001645706785786');" style=""><abbr title=" 312          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrder);"> 312          Map&lt;Long, PromotableOrderAdjustment&gt; newAdjustmentsMap = buildPromotableOrderAdjustmentsMap(promotableOrdeðŸ”µ</abbr></span>
<span class="3944053196731100643" onmouseenter="enter('3944053196731100643');" onmouseout="out('3944053196731100643');" style=""> 313          Iterator&lt;OrderAdjustment&gt; orderAdjIterator = order.getOrderAdjustments().iterator();                      </span>
<span  style=""> 314                                                                                                                    </span>
<span class="6446254784470090633" onmouseenter="enter('6446254784470090633');" onmouseout="out('6446254784470090633');" style=""> 315          while (orderAdjIterator.hasNext()) {                                                                      </span>
<span class="8379122835997548797" onmouseenter="enter('8379122835997548797');" onmouseout="out('8379122835997548797');" style=""> 316              OrderAdjustment adjustment = orderAdjIterator.next();                                                 </span>
<span class="-4215374844081079628" onmouseenter="enter('-4215374844081079628');" onmouseout="out('-4215374844081079628');" style=""> 317              if (adjustment.getOffer() != null) {                                                                  </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 318                  Long offerId = adjustment.getOffer().getId();                                                     </span>
<span class="5819609577497737127" onmouseenter="enter('5819609577497737127');" onmouseout="out('5819609577497737127');" style=""> 319                  PromotableOrderAdjustment promotableAdjustment = newAdjustmentsMap.remove(offerId);               </span>
<span class="6490885699345008591" onmouseenter="enter('6490885699345008591');" onmouseout="out('6490885699345008591');" style=""> 320                  if (promotableAdjustment != null) {                                                               </span>
<span class="8306255688592160531" onmouseenter="enter('8306255688592160531');" onmouseout="out('8306255688592160531');" style=""> 321                      if (!adjustment.getValue().equals(promotableAdjustment.getAdjustmentValue())) {               </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 322                          if (LOG.isDebugEnabled()) {                                                               </span>
<span class="7257069809489192732" onmouseenter="enter('7257069809489192732');" onmouseout="out('7257069809489192732');" style=""> 323                              LOG.debug(&quot;Updating value for order adjustment with offer Id &quot; + offerId + &quot; to &quot; +   </span>
<span class="989054364510106270" onmouseenter="enter('989054364510106270');" onmouseout="out('989054364510106270');" style=""> 324                                      promotableAdjustment.getAdjustmentValue());                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 325                          }                                                                                         </span>
<span class="-7933602054076632299" onmouseenter="enter('-7933602054076632299');" onmouseout="out('-7933602054076632299');" style=""> 326                          adjustment.setValue(promotableAdjustment.getAdjustmentValue());                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327                      }                                                                                             </span>

<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 328                  } else {                                                                                          </span>
<span class="4531906782810290485" onmouseenter="enter('4531906782810290485');" onmouseout="out('4531906782810290485');" style=""> 329                      // No longer using this order adjustment, remove it.                                          </span>
<span class="-8642473006560883902" onmouseenter="enter('-8642473006560883902');" onmouseout="out('-8642473006560883902');" style=""> 330                      orderAdjIterator.remove();                                                                    </span>
<span class="808032765038092054" onmouseenter="enter('808032765038092054');" onmouseout="out('808032765038092054');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +                    entityService.remove(adjustment);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334          }                                                                                                         </span>
<span  style=""> 335                                                                                                                    </span>
<span class="9053649251777837824" onmouseenter="enter('9053649251777837824');" onmouseout="out('9053649251777837824');" style=""> 336          for (PromotableOrderAdjustment promotableOrderAdjustment : newAdjustmentsMap.values()) {                  </span>
<span class="8948825633726878072" onmouseenter="enter('8948825633726878072');" onmouseout="out('8948825633726878072');" style=""> 337              // Add the newly introduced adjustments.                                                              </span>
<span class="-1742313644800837850" onmouseenter="enter('-1742313644800837850');" onmouseout="out('-1742313644800837850');" style=""> 338              Offer offer = promotableOrderAdjustment.getOffer();                                                   </span>
<span class="1325997209783346162" onmouseenter="enter('1325997209783346162');" onmouseout="out('1325997209783346162');" style=""> 339              OrderAdjustment orderAdjustment = offerDao.createOrderAdjustment();                                   </span>
<span class="-6738057894981368691" onmouseenter="enter('-6738057894981368691');" onmouseout="out('-6738057894981368691');" style=""> 340              orderAdjustment.init(order, offer, offer.getName());                                                  </span>
<span class="-770736347184914897" onmouseenter="enter('-770736347184914897');" onmouseout="out('-770736347184914897');" style=""> 341              orderAdjustment.setValue(promotableOrderAdjustment.getAdjustmentValue());                             </span>
<span class="-1853577329694264316" onmouseenter="enter('-1853577329694264316');" onmouseout="out('-1853577329694264316');" style=""> 342              order.getOrderAdjustments().add(orderAdjustment);                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344      }                                                                                                             </span>
<span  style=""> 345                                                                                                                    </span>
<span  style=""> 346                                                                                                                    </span>

















<span  style=""> 347                                                                                                                    </span>
<span class="4939686944790593089" onmouseenter="enter('4939686944790593089');" onmouseout="out('4939686944790593089');" style=""> 348      protected void synchronizeOrderItems(PromotableOrder promotableOrder) {                                       </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 349          Order order = promotableOrder.getOrder();                                                                 </span>
<span class="8870411702953196775" onmouseenter="enter('8870411702953196775');" onmouseout="out('8870411702953196775');" style=""><abbr title=" 350          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promotableOrder);"> 350          Map&lt;OrderItem, PromotableOrderItem&gt; promotableItemMap = offerServiceUtilities.buildPromotableItemMap(promoðŸ”µ</abbr></span>
<span  style=""> 351                                                                                                                    </span>
<span class="45393343966675502" onmouseenter="enter('45393343966675502');" onmouseout="out('45393343966675502');" style=""> 352          List&lt;OrderItem&gt; orderItemList = offerServiceUtilities.buildOrderItemList(order);                          </span>
<span  style=""> 353                                                                                                                    </span>
<span class="-3971897302215245898" onmouseenter="enter('-3971897302215245898');" onmouseout="out('-3971897302215245898');" style=""> 354          for (OrderItem orderItem : orderItemList) {                                                               </span>
<span class="-3227733123108723187" onmouseenter="enter('-3227733123108723187');" onmouseout="out('-3227733123108723187');" style=""> 355              PromotableOrderItem promotableItem = promotableItemMap.get(orderItem);                                </span>
<span class="-7181450714367096357" onmouseenter="enter('-7181450714367096357');" onmouseout="out('-7181450714367096357');" style=""> 356              if (promotableItem == null) {                                                                         </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 357                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 358              }                                                                                                     </span>
<span class="-4627052923559624390" onmouseenter="enter('-4627052923559624390');" onmouseout="out('-4627052923559624390');" style=""> 359              synchronizeItemPriceDetails(orderItem, promotableItem);                                               </span>
<span class="-6035169113045010952" onmouseenter="enter('-6035169113045010952');" onmouseout="out('-6035169113045010952');" style=""> 360              synchronizeItemQualifiers(orderItem, promotableItem);                                                 </span>
<span  style=""> 361                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 363      }                                                                                                             </span>
<span  style=""> 364                                                                                                                    </span>
<span class="4641946456273473515" onmouseenter="enter('4641946456273473515');" onmouseout="out('4641946456273473515');" style=""> 365      protected void synchronizeItemPriceDetails(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {    </span>
<span class="8574464637260302488" onmouseenter="enter('8574464637260302488');" onmouseout="out('8574464637260302488');" style=""><abbr title=" 366          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrderItem);"> 366          Map&lt;String, PromotableOrderItemPriceDetail&gt; promotableDetailsMap = buildPromotableDetailsMap(promotableOrdðŸ”µ</abbr></span>
<span class="-6342291150701367795" onmouseenter="enter('-6342291150701367795');" onmouseout="out('-6342291150701367795');" style=""> 367          Map&lt;Long, OrderItemPriceDetail&gt; unmatchedDetailsMap = new HashMap&lt;Long, OrderItemPriceDetail&gt;();          </span>
<span  style=""> 368                                                                                                                    </span>
<span class="-4767625469055938064" onmouseenter="enter('-4767625469055938064');" onmouseout="out('-4767625469055938064');" style=""> 369          for (OrderItemPriceDetail orderItemPriceDetail : orderItem.getOrderItemPriceDetails()) {                  </span>
<span class="5353286555635618569" onmouseenter="enter('5353286555635618569');" onmouseout="out('5353286555635618569');" style=""> 370              String detailKey = buildItemPriceDetailKey(orderItemPriceDetail);                                     </span>
<span class="-2878152675586990901" onmouseenter="enter('-2878152675586990901');" onmouseout="out('-2878152675586990901');" style=""> 371              PromotableOrderItemPriceDetail promotableDetail = promotableDetailsMap.remove(detailKey);             </span>
<span class="5988062476356282201" onmouseenter="enter('5988062476356282201');" onmouseout="out('5988062476356282201');" style=""> 372              if (promotableDetail != null) {                                                                       </span>
<span class="-2745140720553978382" onmouseenter="enter('-2745140720553978382');" onmouseout="out('-2745140720553978382');" style=""> 373                  processMatchingDetails(orderItemPriceDetail, promotableDetail);                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 374              } else {                                                                                              </span>
<span class="-8641070025229307801" onmouseenter="enter('-8641070025229307801');" onmouseout="out('-8641070025229307801');" style=""> 375                  unmatchedDetailsMap.put(orderItemPriceDetail.getId(), orderItemPriceDetail);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 376              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377          }                                                                                                         </span>
<span  style=""> 378                                                                                                                    </span>
<span class="-2102992530504048935" onmouseenter="enter('-2102992530504048935');" onmouseout="out('-2102992530504048935');" style=""> 379          Iterator&lt;OrderItemPriceDetail&gt; unmatchedDetailsIterator = unmatchedDetailsMap.values().iterator();        </span>
<span  style=""> 380                                                                                                                    </span>
<span class="3655839919190900579" onmouseenter="enter('3655839919190900579');" onmouseout="out('3655839919190900579');" style=""> 381          for (PromotableOrderItemPriceDetail priceDetail : promotableDetailsMap.values()) {                        </span>
<span class="848025138552610797" onmouseenter="enter('848025138552610797');" onmouseout="out('848025138552610797');" style=""> 382              if (unmatchedDetailsIterator.hasNext()) {                                                             </span>
<span class="-1286995204662994700" onmouseenter="enter('-1286995204662994700');" onmouseout="out('-1286995204662994700');" style=""> 383                  // Reuse an existing priceDetail                                                                  </span>
<span class="-6274362249453165217" onmouseenter="enter('-6274362249453165217');" onmouseout="out('-6274362249453165217');" style=""> 384                  OrderItemPriceDetail existingDetail = unmatchedDetailsIterator.next();                            </span>
<span  style=""> 385                                                                                                                    </span>
<span class="8785556757346701489" onmouseenter="enter('8785556757346701489');" onmouseout="out('8785556757346701489');" style=""> 386                  // Reset use Sale flag to true                                                                    </span>
<span class="-4586757194387339116" onmouseenter="enter('-4586757194387339116');" onmouseout="out('-4586757194387339116');" style=""> 387                  existingDetail.setUseSalePrice(true);                                                             </span>
<span  style=""> 388                                                                                                                    </span>
<span class="7880433973363830475" onmouseenter="enter('7880433973363830475');" onmouseout="out('7880433973363830475');" style=""> 389                  offerServiceUtilities.updatePriceDetail(existingDetail, priceDetail);                             </span>
<span class="9163760465604163202" onmouseenter="enter('9163760465604163202');" onmouseout="out('9163760465604163202');" style=""> 390                  unmatchedDetailsIterator.remove();                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 391              } else {                                                                                              </span>
<span class="-3751890412067657497" onmouseenter="enter('-3751890412067657497');" onmouseout="out('-3751890412067657497');" style=""> 392                  // Create a new priceDetail                                                                       </span>
<span class="-1690864448011816688" onmouseenter="enter('-1690864448011816688');" onmouseout="out('-1690864448011816688');" style=""> 393                  OrderItemPriceDetail newPriceDetail = orderItemDao.createOrderItemPriceDetail();                  </span>
<span class="-3940721081423400252" onmouseenter="enter('-3940721081423400252');" onmouseout="out('-3940721081423400252');" style=""> 394                  newPriceDetail.setOrderItem(orderItem);                                                           </span>
<span class="-2358509328501908297" onmouseenter="enter('-2358509328501908297');" onmouseout="out('-2358509328501908297');" style=""> 395                  offerServiceUtilities.updatePriceDetail(newPriceDetail, priceDetail);                             </span>
<span class="7726531521682039639" onmouseenter="enter('7726531521682039639');" onmouseout="out('7726531521682039639');" style=""> 396                  orderItem.getOrderItemPriceDetails().add(newPriceDetail);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 397              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 398          }                                                                                                         </span>
<span  style=""> 399                                                                                                                    </span>
<span class="5078704746315005492" onmouseenter="enter('5078704746315005492');" onmouseout="out('5078704746315005492');" style=""> 400          // Remove any unmatched details                                                                           </span>
<span class="-596985917041158168" onmouseenter="enter('-596985917041158168');" onmouseout="out('-596985917041158168');" style=""> 401          Iterator&lt;OrderItemPriceDetail&gt; pdIterator = orderItem.getOrderItemPriceDetails().iterator();              </span>
<span class="-2348069803911125145" onmouseenter="enter('-2348069803911125145');" onmouseout="out('-2348069803911125145');" style=""> 402          offerServiceUtilities.removeUnmatchedPriceDetails(unmatchedDetailsMap, pdIterator);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403      }                                                                                                             </span>
<span  style=""> 404                                                                                                                    </span>
<span class="-3359465330409353741" onmouseenter="enter('-3359465330409353741');" onmouseout="out('-3359465330409353741');" style=""> 405      protected void synchronizeItemQualifiers(OrderItem orderItem, PromotableOrderItem promotableOrderItem) {      </span>
<span class="6939567773624847901" onmouseenter="enter('6939567773624847901');" onmouseout="out('6939567773624847901');" style=""> 406          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = buildPromotableQualifiersMap(promotableOrderItem);          </span>
<span class="-838353671554643485" onmouseenter="enter('-838353671554643485');" onmouseout="out('-838353671554643485');" style=""> 407          Map&lt;Long, OrderItemQualifier&gt; unmatchedQualifiersMap = new HashMap&lt;Long, OrderItemQualifier&gt;();           </span>
<span  style=""> 408                                                                                                                    </span>
<span class="6539711029953657105" onmouseenter="enter('6539711029953657105');" onmouseout="out('6539711029953657105');" style=""> 409          for (OrderItemQualifier orderItemQualifier : orderItem.getOrderItemQualifiers()) {                        </span>
<span class="2428508324486494962" onmouseenter="enter('2428508324486494962');" onmouseout="out('2428508324486494962');" style=""> 410              PromotionQualifier promotableQualifier = qualifiersMap.remove(orderItemQualifier.getOffer().getId()); </span>
<span class="-4549367717464072284" onmouseenter="enter('-4549367717464072284');" onmouseout="out('-4549367717464072284');" style=""> 411              if (promotableQualifier != null) {                                                                    </span>
<span class="-5773466494614436024" onmouseenter="enter('-5773466494614436024');" onmouseout="out('-5773466494614436024');" style=""> 412                  // Offer was used as a qualifier on previous run.   Update quantity if needed.                    </span>
<span class="-3775165376026668506" onmouseenter="enter('-3775165376026668506');" onmouseout="out('-3775165376026668506');" style=""> 413                  if (orderItemQualifier.getQuantity() != promotableQualifier.getQuantity()) {                      </span>
<span class="6319516500536721656" onmouseenter="enter('6319516500536721656');" onmouseout="out('6319516500536721656');" style=""> 414                      orderItemQualifier.setQuantity(new Long(promotableQualifier.getQuantity()));                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 416              } else {                                                                                              </span>
<span class="-7107745465096608003" onmouseenter="enter('-7107745465096608003');" onmouseout="out('-7107745465096608003');" style=""> 417                  unmatchedQualifiersMap.put(orderItemQualifier.getId(), orderItemQualifier);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419          }                                                                                                         </span>
<span  style=""> 420                                                                                                                    </span>
<span class="6412010879861386561" onmouseenter="enter('6412010879861386561');" onmouseout="out('6412010879861386561');" style=""> 421          Iterator&lt;OrderItemQualifier&gt; unmatchedQualifiersIterator = unmatchedQualifiersMap.values().iterator();    </span>
<span  style=""> 422                                                                                                                    </span>
<span class="-5367673967409602220" onmouseenter="enter('-5367673967409602220');" onmouseout="out('-5367673967409602220');" style=""> 423          for (PromotionQualifier qualifier : qualifiersMap.values()) {                                             </span>
<span class="4352951882445574614" onmouseenter="enter('4352951882445574614');" onmouseout="out('4352951882445574614');" style=""> 424              if (unmatchedQualifiersIterator.hasNext()) {                                                          </span>
<span class="916500832219535438" onmouseenter="enter('916500832219535438');" onmouseout="out('916500832219535438');" style=""> 425                  // Reuse an existing qualifier                                                                    </span>
<span class="-457617571898655971" onmouseenter="enter('-457617571898655971');" onmouseout="out('-457617571898655971');" style=""> 426                  OrderItemQualifier existingQualifier = unmatchedQualifiersIterator.next();                        </span>
<span class="-9191122370911430740" onmouseenter="enter('-9191122370911430740');" onmouseout="out('-9191122370911430740');" style=""> 427                  existingQualifier.setOffer(qualifier.getPromotion());                                             </span>
<span class="-5418424828849751920" onmouseenter="enter('-5418424828849751920');" onmouseout="out('-5418424828849751920');" style=""> 428                  existingQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                             </span>
<span class="-2784197009200988946" onmouseenter="enter('-2784197009200988946');" onmouseout="out('-2784197009200988946');" style=""> 429                  unmatchedQualifiersIterator.remove();                                                             </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 430              } else {                                                                                              </span>
<span class="-4600119951921754996" onmouseenter="enter('-4600119951921754996');" onmouseout="out('-4600119951921754996');" style=""> 431                  // Create a new qualifier                                                                         </span>
<span class="2495734798245487562" onmouseenter="enter('2495734798245487562');" onmouseout="out('2495734798245487562');" style=""> 432                  OrderItemQualifier newQualifier = orderItemDao.createOrderItemQualifier();                        </span>
<span class="-7776554329531977433" onmouseenter="enter('-7776554329531977433');" onmouseout="out('-7776554329531977433');" style=""> 433                  newQualifier.setOrderItem(orderItem);                                                             </span>
<span class="-7457838790114620282" onmouseenter="enter('-7457838790114620282');" onmouseout="out('-7457838790114620282');" style=""> 434                  newQualifier.setOffer(qualifier.getPromotion());                                                  </span>
<span class="35194467054568730" onmouseenter="enter('35194467054568730');" onmouseout="out('35194467054568730');" style=""> 435                  newQualifier.setQuantity(Long.valueOf(qualifier.getQuantity()));                                  </span>
<span class="-7418439022636140038" onmouseenter="enter('-7418439022636140038');" onmouseout="out('-7418439022636140038');" style=""> 436                  orderItem.getOrderItemQualifiers().add(newQualifier);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438          }                                                                                                         </span>
<span  style=""> 439                                                                                                                    </span>
<span class="5791534705407165022" onmouseenter="enter('5791534705407165022');" onmouseout="out('5791534705407165022');" style=""> 440          // Remove any unmatched qualifiers                                                                        </span>
<span class="-8561007497302660099" onmouseenter="enter('-8561007497302660099');" onmouseout="out('-8561007497302660099');" style=""> 441          Iterator&lt;OrderItemQualifier&gt; qIterator = orderItem.getOrderItemQualifiers().iterator();                   </span>
<span class="760711543792628805" onmouseenter="enter('760711543792628805');" onmouseout="out('760711543792628805');" style=""> 442          offerServiceUtilities.removeUnmatchedQualifiers(unmatchedQualifiersMap, qIterator);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443      }                                                                                                             </span>
<span  style=""> 444                                                                                                                    </span>
<span class="6872064960056917626" onmouseenter="enter('6872064960056917626');" onmouseout="out('6872064960056917626');" style=""> 445      protected void processMatchingDetails(OrderItemPriceDetail itemDetail,                                        </span>
<span class="59795375183189524" onmouseenter="enter('59795375183189524');" onmouseout="out('59795375183189524');" style=""> 446              PromotableOrderItemPriceDetail promotableItemDetail) {                                                </span>
<span class="3894635813711687840" onmouseenter="enter('3894635813711687840');" onmouseout="out('3894635813711687840');" style=""> 447          Map&lt;Long, OrderItemPriceDetailAdjustment&gt; itemAdjustmentMap =                                             </span>
<span class="7510782226240613992" onmouseenter="enter('7510782226240613992');" onmouseout="out('7510782226240613992');" style=""> 448                  offerServiceUtilities.buildItemDetailAdjustmentMap(itemDetail);                                   </span>
<span  style=""> 449                                                                                                                    </span>
<span class="-750959101585099141" onmouseenter="enter('-750959101585099141');" onmouseout="out('-750959101585099141');" style=""> 450          if (itemDetail.getQuantity() != promotableItemDetail.getQuantity()) {                                     </span>
<span class="-3259655613865435165" onmouseenter="enter('-3259655613865435165');" onmouseout="out('-3259655613865435165');" style=""> 451              itemDetail.setQuantity(promotableItemDetail.getQuantity());                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 452          }                                                                                                         </span>
<span  style=""> 453                                                                                                                    </span>
<span class="9218754308308575613" onmouseenter="enter('9218754308308575613');" onmouseout="out('9218754308308575613');" style=""><abbr title=" 454          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustments()) {"> 454          for (PromotableOrderItemPriceDetailAdjustment adjustment : promotableItemDetail.getCandidateItemAdjustmentðŸ”µ</abbr></span>
<span class="2783281510413095088" onmouseenter="enter('2783281510413095088');" onmouseout="out('2783281510413095088');" style=""> 455              OrderItemPriceDetailAdjustment itemAdjustment = itemAdjustmentMap.get(adjustment.getOfferId());       </span>
<span class="4997906471413856597" onmouseenter="enter('4997906471413856597');" onmouseout="out('4997906471413856597');" style=""> 456              if (!itemAdjustment.getValue().equals(adjustment.getAdjustmentValue())) {                             </span>
<span class="-4842011616043597197" onmouseenter="enter('-4842011616043597197');" onmouseout="out('-4842011616043597197');" style=""> 457                  itemAdjustment.setValue(adjustment.getAdjustmentValue());                                         </span>
<span class="-5695031583799398466" onmouseenter="enter('-5695031583799398466');" onmouseout="out('-5695031583799398466');" style=""> 458                  itemAdjustment.setAppliedToSalePrice(adjustment.isAppliedToSalePrice());                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461      }                                                                                                             </span>
<span  style=""> 462                                                                                                                    </span>
<span class="4651274540478945566" onmouseenter="enter('4651274540478945566');" onmouseout="out('4651274540478945566');" style=""> 463      protected String buildItemPriceDetailKey(OrderItemPriceDetail itemDetail) {                                   </span>
<span class="1883813639191860394" onmouseenter="enter('1883813639191860394');" onmouseout="out('1883813639191860394');" style=""> 464          List&lt;Long&gt; offerIds = new ArrayList&lt;Long&gt;();                                                              </span>
<span class="-1371106512285082048" onmouseenter="enter('-1371106512285082048');" onmouseout="out('-1371106512285082048');" style=""> 465          for (OrderItemPriceDetailAdjustment adjustment : itemDetail.getOrderItemPriceDetailAdjustments()) {       </span>
<span class="6593948543670513211" onmouseenter="enter('6593948543670513211');" onmouseout="out('6593948543670513211');" style=""> 466              Long offerId = adjustment.getOffer().getId();                                                         </span>
<span class="-11608270007353255" onmouseenter="enter('-11608270007353255');" onmouseout="out('-11608270007353255');" style=""> 467              offerIds.add(offerId);                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468          }                                                                                                         </span>
<span class="-5651075727196406737" onmouseenter="enter('-5651075727196406737');" onmouseout="out('-5651075727196406737');" style=""> 469          Collections.sort(offerIds);                                                                               </span>
<span class="5891357179043449296" onmouseenter="enter('5891357179043449296');" onmouseout="out('5891357179043449296');" style=""> 470          return itemDetail.getOrderItem().toString() + offerIds.toString() + itemDetail.getUseSalePrice();         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471      }                                                                                                             </span>
<span  style=""> 472                                                                                                                    </span>
<span class="-6813037055353877100" onmouseenter="enter('-6813037055353877100');" onmouseout="out('-6813037055353877100');" style=""> 473      protected Map&lt;String, PromotableOrderItemPriceDetail&gt; buildPromotableDetailsMap(PromotableOrderItem item) {   </span>
<span class="-5863956661369186771" onmouseenter="enter('-5863956661369186771');" onmouseout="out('-5863956661369186771');" style=""><abbr title=" 474          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetail&gt;();"> 474          Map&lt;String, PromotableOrderItemPriceDetail&gt; detailsMap = new HashMap&lt;String, PromotableOrderItemPriceDetaiðŸ”µ</abbr></span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 475          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {                 </span>
<span class="-4172210863560606018" onmouseenter="enter('-4172210863560606018');" onmouseout="out('-4172210863560606018');" style=""> 476              detailsMap.put(detail.buildDetailKey(), detail);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477          }                                                                                                         </span>
<span class="1985757738719514214" onmouseenter="enter('1985757738719514214');" onmouseout="out('1985757738719514214');" style=""> 478          return detailsMap;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479      }                                                                                                             </span>
<span  style=""> 480                                                                                                                    </span>
<span class="-3836724244114507356" onmouseenter="enter('-3836724244114507356');" onmouseout="out('-3836724244114507356');" style=""> 481      protected Map&lt;Long, PromotionQualifier&gt; buildPromotableQualifiersMap(PromotableOrderItem item) {              </span>
<span class="-1925492436839506759" onmouseenter="enter('-1925492436839506759');" onmouseout="out('-1925492436839506759');" style=""> 482          Map&lt;Long, PromotionQualifier&gt; qualifiersMap = new HashMap&lt;Long, PromotionQualifier&gt;();                    </span>
<span class="7774457354827349025" onmouseenter="enter('7774457354827349025');" onmouseout="out('7774457354827349025');" style=""> 483          for (PromotableOrderItemPriceDetail detail : item.getPromotableOrderItemPriceDetails()) {                 </span>
<span class="-4593166378473264356" onmouseenter="enter('-4593166378473264356');" onmouseout="out('-4593166378473264356');" style=""> 484              for (PromotionQualifier qualifier : detail.getPromotionQualifiers()) {                                </span>
<span class="3842824965672319387" onmouseenter="enter('3842824965672319387');" onmouseout="out('3842824965672319387');" style=""> 485                  PromotionQualifier existingQualifier = qualifiersMap.get(qualifier.getPromotion().getId());       </span>
<span class="-8569849509682320504" onmouseenter="enter('-8569849509682320504');" onmouseout="out('-8569849509682320504');" style=""> 486                  if (existingQualifier != null) {                                                                  </span>
<span class="-4445010116162684270" onmouseenter="enter('-4445010116162684270');" onmouseout="out('-4445010116162684270');" style=""> 487                      existingQualifier.setQuantity(existingQualifier.getQuantity() + qualifier.getQuantity());     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 488                  } else {                                                                                          </span>
<span class="-8046901564682421602" onmouseenter="enter('-8046901564682421602');" onmouseout="out('-8046901564682421602');" style=""> 489                      qualifiersMap.put(qualifier.getPromotion().getId(), qualifier);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 491              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 492          }                                                                                                         </span>
<span class="4699150655190374848" onmouseenter="enter('4699150655190374848');" onmouseout="out('4699150655190374848');" style=""> 493          return qualifiersMap;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494      }                                                                                                             </span>
<span  style=""> 495                                                                                                                    </span>
<span class="6650489462588239331" onmouseenter="enter('6650489462588239331');" onmouseout="out('6650489462588239331');" style=""> 496      protected void synchronizeFulfillmentGroups(PromotableOrder promotableOrder) {                                </span>
<span class="-396343315567854895" onmouseenter="enter('-396343315567854895');" onmouseout="out('-396343315567854895');" style=""> 497          Order order = promotableOrder.getOrder();                                                                 </span>
<span class="6561763597022577240" onmouseenter="enter('6561763597022577240');" onmouseout="out('6561763597022577240');" style=""> 498          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = buildPromotableFulfillmentGroupMap(promotableOrder);        </span>
<span  style=""> 499                                                                                                                    </span>


<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 500          for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                                </span>
<span class="-439733037564232612" onmouseenter="enter('-439733037564232612');" onmouseout="out('-439733037564232612');" style=""> 501              synchronizeFulfillmentGroupAdjustments(fg, fgMap.get(fg.getId()));                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 502          }                                                                                                         </span>



























<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503      }                                                                                                             </span>
<span  style=""> 504                                                                                                                    </span>
<span class="-613491293141460653" onmouseenter="enter('-613491293141460653');" onmouseout="out('-613491293141460653');" style=""> 505      protected Map&lt;Long, PromotableFulfillmentGroup&gt; buildPromotableFulfillmentGroupMap(PromotableOrder order) {   </span>
<span class="-2168953774981447317" onmouseenter="enter('-2168953774981447317');" onmouseout="out('-2168953774981447317');" style=""> 506          Map&lt;Long, PromotableFulfillmentGroup&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroup&gt;();            </span>
<span class="-1134830134613695083" onmouseenter="enter('-1134830134613695083');" onmouseout="out('-1134830134613695083');" style=""> 507          for (PromotableFulfillmentGroup fg : order.getFulfillmentGroups()) {                                      </span>
<span class="-3822470075223000180" onmouseenter="enter('-3822470075223000180');" onmouseout="out('-3822470075223000180');" style=""> 508              fgMap.put(fg.getFulfillmentGroup().getId(), fg);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509          }                                                                                                         </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 510          return fgMap;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511      }                                                                                                             </span>
<span  style=""> 512                                                                                                                    </span>
<span class="6665195593296681168" onmouseenter="enter('6665195593296681168');" onmouseout="out('6665195593296681168');" style=""><abbr title=" 513      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGroup fg) {"> 513      protected Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; buildPromFulfillmentAdjMap(PromotableFulfillmentGrouðŸ”µ</abbr></span>
<span class="-7214313390686800174" onmouseenter="enter('-7214313390686800174');" onmouseout="out('-7214313390686800174');" style=""><abbr title=" 514          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustment&gt;();"> 514          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; fgMap = new HashMap&lt;Long, PromotableFulfillmentGroupAdjustðŸ”µ</abbr></span>
<span class="331019091121439684" onmouseenter="enter('331019091121439684');" onmouseout="out('331019091121439684');" style=""> 515          for (PromotableFulfillmentGroupAdjustment adjustment : fg.getCandidateFulfillmentGroupAdjustments()) {    </span>
<span class="1110980486512930755" onmouseenter="enter('1110980486512930755');" onmouseout="out('1110980486512930755');" style=""> 516              fgMap.put(adjustment.getPromotableCandidateFulfillmentGroupOffer().getOffer().getId(), adjustment);   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517          }                                                                                                         </span>
<span class="-1972754828117710078" onmouseenter="enter('-1972754828117710078');" onmouseout="out('-1972754828117710078');" style=""> 518          return fgMap;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 519      }                                                                                                             </span>
<span  style=""> 520                                                                                                                    </span>
<span class="-7617178904345879788" onmouseenter="enter('-7617178904345879788');" onmouseout="out('-7617178904345879788');" style=""><abbr title=" 521      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotableFG) {"> 521      protected void synchronizeFulfillmentGroupAdjustments(FulfillmentGroup fg, PromotableFulfillmentGroup promotabðŸ”µ</abbr></span>
<span class="1705100339866591039" onmouseenter="enter('1705100339866591039');" onmouseout="out('1705100339866591039');" style=""> 522          Iterator&lt;FulfillmentGroupAdjustment&gt; adjustmentIterator = fg.getFulfillmentGroupAdjustments().iterator(); </span>
<span class="6869467232437188017" onmouseenter="enter('6869467232437188017');" onmouseout="out('6869467232437188017');" style=""><abbr title=" 523          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFG);"> 523          Map&lt;Long, PromotableFulfillmentGroupAdjustment&gt; promotableAdjMap = buildPromFulfillmentAdjMap(promotableFGðŸ”µ</abbr></span>
<span  style=""> 524                                                                                                                    </span>
<span class="7622903297016040666" onmouseenter="enter('7622903297016040666');" onmouseout="out('7622903297016040666');" style=""> 525          // First try and update existing adjustment records                                                       </span>
<span class="6593219943708493598" onmouseenter="enter('6593219943708493598');" onmouseout="out('6593219943708493598');" style=""> 526          while (adjustmentIterator.hasNext()) {                                                                    </span>
<span class="5134089875457655542" onmouseenter="enter('5134089875457655542');" onmouseout="out('5134089875457655542');" style=""> 527              FulfillmentGroupAdjustment currentAdj = adjustmentIterator.next();                                    </span>
<span class="9090174154450682409" onmouseenter="enter('9090174154450682409');" onmouseout="out('9090174154450682409');" style=""> 528              PromotableFulfillmentGroupAdjustment newAdj = promotableAdjMap.remove(currentAdj.getOffer().getId()); </span>
<span class="7739365516519203047" onmouseenter="enter('7739365516519203047');" onmouseout="out('7739365516519203047');" style=""> 529              if (newAdj != null) {                                                                                 </span>
<span class="5102959516436064847" onmouseenter="enter('5102959516436064847');" onmouseout="out('5102959516436064847');" style=""> 530                  if (!currentAdj.getValue().equals(newAdj.getAdjustmentValue())) {                                 </span>
<span class="-6634291412355259187" onmouseenter="enter('-6634291412355259187');" onmouseout="out('-6634291412355259187');" style=""> 531                      // Update the currentAdj.                                                                     </span>
<span class="-4755037759892167947" onmouseenter="enter('-4755037759892167947');" onmouseout="out('-4755037759892167947');" style=""> 532                      currentAdj.setValue(newAdj.getAdjustmentValue());                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 533                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 534              } else {                                                                                              </span>
<span class="-5437992937664131712" onmouseenter="enter('-5437992937664131712');" onmouseout="out('-5437992937664131712');" style=""> 535                  // Removing no longer valid adjustment                                                            </span>
<span class="-6800144716907845476" onmouseenter="enter('-6800144716907845476');" onmouseout="out('-6800144716907845476');" style=""> 536                  adjustmentIterator.remove();                                                                      </span>
<span class="855814523852624000" onmouseenter="enter('855814523852624000');" onmouseout="out('855814523852624000');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +                entityService.remove(currentAdj);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 539          }                                                                                                         </span>
<span  style=""> 540                                                                                                                    </span>
<span class="4911772249630101500" onmouseenter="enter('4911772249630101500');" onmouseout="out('4911772249630101500');" style=""> 541          // Now add missing adjustments                                                                            </span>
<span class="8170167194272017979" onmouseenter="enter('8170167194272017979');" onmouseout="out('8170167194272017979');" style=""> 542          for (PromotableFulfillmentGroupAdjustment newAdj : promotableAdjMap.values()) {                           </span>
<span class="-4188265609244912176" onmouseenter="enter('-4188265609244912176');" onmouseout="out('-4188265609244912176');" style=""> 543              FulfillmentGroupAdjustment fa = offerDao.createFulfillmentGroupAdjustment();                          </span>
<span class="3068706828930127416" onmouseenter="enter('3068706828930127416');" onmouseout="out('3068706828930127416');" style=""> 544              fa.setFulfillmentGroup(fg);                                                                           </span>
<span class="5392928859383582349" onmouseenter="enter('5392928859383582349');" onmouseout="out('5392928859383582349');" style=""> 545              fa.init(fg, newAdj.getPromotableCandidateFulfillmentGroupOffer().getOffer(), null);                   </span>
<span class="4727884307924071496" onmouseenter="enter('4727884307924071496');" onmouseout="out('4727884307924071496');" style=""> 546              fa.setValue(newAdj.getAdjustmentValue());                                                             </span>
<span class="-1586043412444283157" onmouseenter="enter('-1586043412444283157');" onmouseout="out('-1586043412444283157');" style=""> 547              fg.getFulfillmentGroupAdjustments().add(fa);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548          }                                                                                                         </span>
<span  style=""> 549                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550      }                                                                                                             </span>
<span  style=""> 551                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 552      @Override                                                                                                     </span>
<span class="-4816910989941817274" onmouseenter="enter('-4816910989941817274');" onmouseout="out('-4816910989941817274');" style=""> 553      public void synchronizeAdjustmentsAndPrices(PromotableOrder promotableOrder) {                                </span>
<span class="-3850751249412137645" onmouseenter="enter('-3850751249412137645');" onmouseout="out('-3850751249412137645');" style=""> 554          synchronizeOrderAdjustments(promotableOrder);                                                             </span>
<span class="4518036952510487894" onmouseenter="enter('4518036952510487894');" onmouseout="out('4518036952510487894');" style=""> 555          synchronizeOrderItems(promotableOrder);                                                                   </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 556          if (extensionManager != null) {                                                                           </span>
<span class="-6179159556176464024" onmouseenter="enter('-6179159556176464024');" onmouseout="out('-6179159556176464024');" style=""> 557              extensionManager.getProxy().synchronizeAdjustmentsAndPrices(promotableOrder);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558          }                                                                                                         </span>
<span class="-159866277563841870" onmouseenter="enter('-159866277563841870');" onmouseout="out('-159866277563841870');" style=""> 559          synchronizeFulfillmentGroups(promotableOrder);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560      }                                                                                                             </span>
<span  style=""> 561                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 562      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 563      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 564          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 565      }                                                                                                             </span>
<span  style=""> 566                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 567      @Override                                                                                                     </span>
<span class="6530687858988053885" onmouseenter="enter('6530687858988053885');" onmouseout="out('6530687858988053885');" style=""> 568      public void setOrderItemDao(OrderItemDao orderItemDao) {                                                      </span>
<span class="-8374754321118159364" onmouseenter="enter('-8374754321118159364');" onmouseout="out('-8374754321118159364');" style=""> 569          this.orderItemDao = orderItemDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 570      }                                                                                                             </span>
<span  style=""> 571                                                                                                                    </span>
<span class="-6632247919309783023" onmouseenter="enter('-6632247919309783023');" onmouseout="out('-6632247919309783023');" style=""> 572      public OfferServiceUtilities getOfferServiceUtilities() {                                                     </span>
<span class="-6406517936839827979" onmouseenter="enter('-6406517936839827979');" onmouseout="out('-6406517936839827979');" style=""> 573          return offerServiceUtilities;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 574      }                                                                                                             </span>
<span  style=""> 575                                                                                                                    </span>
<span class="4442139862126007445" onmouseenter="enter('4442139862126007445');" onmouseout="out('4442139862126007445');" style=""> 576      public void setOfferServiceUtilities(OfferServiceUtilities offerServiceUtilities) {                           </span>
<span class="4552134412879762115" onmouseenter="enter('4552134412879762115');" onmouseout="out('4552134412879762115');" style=""> 577          this.offerServiceUtilities = offerServiceUtilities;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 578      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            