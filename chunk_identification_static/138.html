<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>138</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    138
                    <a href="137.html">prev</a>
                    <a href="139.html">next</a>
                    <a href="138_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_847cc65342fcbd44235ea5a83f1a08b103b6ddab_Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;847cc65342fcbd44235ea5a83f1a08b103b6ddab:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;847cc65342fcbd44235ea5a83f1a08b103b6ddab^1:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;847cc65342fcbd44235ea5a83f1a08b103b6ddab^2:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;ce7aec49945699c066e58c1e519ba95d78c8bce4:Simplenote/src/main/java/com/automattic/simplenote/NoteMarkdownFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 
  15 import androidx.annotation.NonNull;
  16 import androidx.core.view.MenuCompat;
  17 import androidx.fragment.app.Fragment;
  18 import androidx.fragment.app.FragmentActivity;
  19 
  20 import com.automattic.simplenote.models.Note;
  21 import com.automattic.simplenote.utils.AppLog;
  22 import com.automattic.simplenote.utils.AppLog.Type;
  23 import com.automattic.simplenote.utils.BrowserUtils;
  24 import com.automattic.simplenote.utils.ContextUtils;
  25 import com.automattic.simplenote.utils.DrawableUtils;
  26 import com.automattic.simplenote.utils.NetworkUtils;
  27 import com.automattic.simplenote.utils.NoteUtils;
  28 import com.automattic.simplenote.utils.SimplenoteLinkify;
  29 import com.automattic.simplenote.utils.ThemeUtils;
  30 import com.commonsware.cwac.anddown.AndDown;
  31 import com.google.android.material.snackbar.Snackbar;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.BucketObjectMissingException;
  34 
  35 import java.lang.ref.SoftReference;
  36 
  37 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  38 
  39 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  40     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  41 
  42     private Bucket&lt;Note&gt; mNotesBucket;
  43     private Note mNote;
  44     private String mCss;
  45     private WebView mMarkdown;
  46     private boolean mIsLoadingNote;
  47 
  48     @Override
  49     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  50         inflater.inflate(R.menu.note_markdown, menu);
  51         MenuCompat.setGroupDividerEnabled(menu, true);
  52 
  53         DrawableUtils.tintMenuWithAttribute(
  54             requireContext(),
  55             menu,
  56             R.attr.toolbarIconColor
  57         );
  58 
  59         for (int i = 0; i &lt; menu.size(); i++) {
  60             MenuItem item = menu.getItem(i);
  61             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  62         }
  63 
  64         if (mNote != null) {
  65             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  66             viewPublishedNoteItem.setVisible(true);
  67             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  68 
  69             if (mNote.isDeleted()) {
  70                 trashItem.setTitle(R.string.restore);
  71             } else {
  72                 trashItem.setTitle(R.string.trash);
  73             }
  74 
  75             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  76         }
  77 
  78         super.onCreateOptionsMenu(menu, inflater);
  79     }
  80 
  81     @Override
<abbr title="  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  83         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  84         mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  85 
  86         // Load note if we were passed an ID.
  87         Bundle arguments = getArguments();
  88 
  89         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90             String key = arguments.getString(ARG_ITEM_ID);
  91             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92         }
  93 
  94         setHasOptionsMenu(true);
  95 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         mCss = ContextUtils.readCssFile(requireContext(), ThemeUtils.getCssFromStyle(requireContext()));</span>
  97 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                 ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                 : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         mMarkdown = layout.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         return layout;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104     }</span>
 105 =======
 106 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 107         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
 108         mMarkdown = layout.findViewById(R.id.markdown);
 109         mMarkdown.setWebViewClient(
 110             new WebViewClient() {
 111                 @Override
 112                 public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){
 113                     String url = request.getUrl().toString();
 114 
 115                     if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){
<abbr title=" 116                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 116                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX,ðŸ”µ</abbr>
 117                     } else {
 118                         BrowserUtils.launchBrowserOrShowError(requireContext(), url);
 119                     }
 120 
 121                     return true;
 122                 }
 123             }
 124         );
 125         mCss = ThemeUtils.isLightTheme(requireContext())
 126             ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)
 127             : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);
 128         return layout;
 129     }
 130 
 131     @Override
 132     public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 133         switch (item.getItemId()) {
 134             case android.R.id.home:
 135                 if (!isAdded()) {
 136                     return false;
 137                 }
 138 
 139                 requireActivity().finish();
 140                 return true;
 141             case R.id.menu_trash:
 142                 if (!isAdded()) {
 143                     return false;
 144                 }
 145 
 146                 deleteNote();
 147                 return true;
 148             case R.id.menu_copy_internal:
 149                 if (!isAdded()) {
 150                     return false;
 151                 }
 152 
<abbr title=" 153                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 153                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 154                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 155                 } else {
 156                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 157                 }
 158 
 159                 return true;
 160             default:
 161                 return super.onOptionsItemSelected(item);
 162         }
 163     }
 164 
 165     private void deleteNote() {
 166         NoteUtils.deleteNote(mNote, getActivity());
 167         requireActivity().finish();
 168     }
 169 
 170     @Override
 171     public void onPrepareOptionsMenu(@NonNull Menu menu) {
 172         // Disable share and delete actions until note is loaded.
 173         if (mIsLoadingNote) {
 174             menu.findItem(R.id.menu_trash).setEnabled(false);
 175         } else {
 176             menu.findItem(R.id.menu_trash).setEnabled(true);
 177         }
 178 
 179         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 180         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 181         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 182         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 183         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 184 
 185         if (mNote != null) {
 186             pinItem.setChecked(mNote.isPinned());
 187             publishItem.setChecked(mNote.isPublished());
 188             markdownItem.setChecked(mNote.isMarkdownEnabled());
 189         }
 190 
 191         pinItem.setEnabled(false);
 192         publishItem.setEnabled(false);
 193         copyLinkItem.setEnabled(false);
 194         markdownItem.setEnabled(false);
 195         copyLinkInternalItem.setEnabled(true);
 196 
 197         super.onPrepareOptionsMenu(menu);
 198     }
 199 
 200     @Override
 201     public void onDestroy() {
 202         super.onDestroy();
 203         mNotesBucket.removeListener(this);
 204         mNotesBucket.stop();
 205         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 206         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 207     }
 208 
 209     @Override
 210     public void onResume() {
 211         super.onResume();
 212         mNotesBucket.start();
 213         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 214         mNotesBucket.addListener(this);
 215         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 216         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 217     }
 218 
 219     @Override
 220     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 221     }
 222 
 223     @Override
 224     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 225     }
 226 
 227     @Override
 228     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 229     }
 230 
 231     @Override
 232     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 233         if (note.equals(mNote)) {
 234             mNote = note;
 235             requireActivity().invalidateOptionsMenu();
 236         }
 237 
 238         AppLog.add(
 239             Type.SYNC,
 240             &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 241                 &quot; / Title: &quot; + note.getTitle() +
 242                 &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 243                 &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 244         );
 245     }
 246 
 247     public void updateMarkdown(String text) {
<abbr title=" 248         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 248         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 249     }
 250 
 251     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 252         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 253                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 254                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 255 
 256         String parsedMarkdown = new AndDown().markdownToHtml(
 257                 sourceContent,
 258                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 259                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 260                 AndDown.HOEDOWN_HTML_ESCAPE
 261         );
 262 
 263         // Set auto alignment for lists, tables, and quotes based on language of start.
 264         parsedMarkdown = parsedMarkdown
 265                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 266                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 267                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 268                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 269 
 270         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 271                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 272     }
 273 
 274     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 275         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 276 
 277         private LoadNoteTask(NoteMarkdownFragment context) {
 278             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 279         }
 280 
 281         @Override
 282         protected void onPreExecute() {
 283             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 284             fragment.mIsLoadingNote = true;
 285         }
 286 
 287         @Override
 288         protected Void doInBackground(String... args) {
 289             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 290             FragmentActivity activity = fragment.getActivity();
 291 
 292             if (activity == null) {
 293                 return null;
 294             }
 295 
 296             String noteID = args[0];
 297             Simplenote application = (Simplenote) activity.getApplication();
 298             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 299 
 300             try {
 301                 fragment.mNote = notesBucket.get(noteID);
 302             } catch (BucketObjectMissingException exception) {
 303                 // TODO: Handle a missing note
 304             }
 305 
 306             return null;
 307         }
 308 
 309         @Override
 310         protected void onPostExecute(Void nada) {
 311             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 312             fragment.mIsLoadingNote = false;
 313             fragment.requireActivity().invalidateOptionsMenu();
 314         }
 315     }
 316 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 
  15 import androidx.annotation.NonNull;
  16 import androidx.core.view.MenuCompat;
  17 import androidx.fragment.app.Fragment;
  18 import androidx.fragment.app.FragmentActivity;
  19 
  20 import com.automattic.simplenote.models.Note;
  21 import com.automattic.simplenote.utils.AppLog;
  22 import com.automattic.simplenote.utils.AppLog.Type;
  23 import com.automattic.simplenote.utils.BrowserUtils;
  24 import com.automattic.simplenote.utils.ContextUtils;
  25 import com.automattic.simplenote.utils.DrawableUtils;
  26 import com.automattic.simplenote.utils.NetworkUtils;
  27 import com.automattic.simplenote.utils.NoteUtils;
  28 import com.automattic.simplenote.utils.SimplenoteLinkify;
  29 import com.automattic.simplenote.utils.ThemeUtils;
  30 import com.commonsware.cwac.anddown.AndDown;
  31 import com.google.android.material.snackbar.Snackbar;
  32 import com.simperium.client.Bucket;
  33 import com.simperium.client.BucketObjectMissingException;
  34 
  35 import java.lang.ref.SoftReference;
  36 
  37 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  38 
  39 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  40     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  41 
  42     private Bucket&lt;Note&gt; mNotesBucket;
  43     private Note mNote;
  44     private String mCss;
  45     private WebView mMarkdown;
  46     private boolean mIsLoadingNote;
  47 
  48     @Override
  49     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  50         inflater.inflate(R.menu.note_markdown, menu);
  51         MenuCompat.setGroupDividerEnabled(menu, true);
  52 
  53         DrawableUtils.tintMenuWithAttribute(
  54             requireContext(),
  55             menu,
  56             R.attr.toolbarIconColor
  57         );
  58 
  59         for (int i = 0; i &lt; menu.size(); i++) {
  60             MenuItem item = menu.getItem(i);
  61             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  62         }
  63 
  64         if (mNote != null) {
  65             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  66             viewPublishedNoteItem.setVisible(true);
  67             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  68 
  69             if (mNote.isDeleted()) {
  70                 trashItem.setTitle(R.string.restore);
  71             } else {
  72                 trashItem.setTitle(R.string.trash);
  73             }
  74 
  75             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  76         }
  77 
  78         super.onCreateOptionsMenu(menu, inflater);
  79     }
  80 
  81     @Override
<abbr title="  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  82     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  83         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  84         mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  85 
  86         // Load note if we were passed an ID.
  87         Bundle arguments = getArguments();
  88 
  89         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90             String key = arguments.getString(ARG_ITEM_ID);
  91             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92         }
  93 
  94         setHasOptionsMenu(true);
  95 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         mCss = ContextUtils.readCssFile(requireContext(), ThemeUtils.getCssFromStyle(requireContext()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         mMarkdown = layout.findViewById(R.id.markdown);</span>
  99 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                 ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                 : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         mMarkdown = layout.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         return layout;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106     }</span>
 107 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109         mMarkdown = layout.findViewById(R.id.markdown);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         mMarkdown.setWebViewClient(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111             new WebViewClient() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113                 public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114                     String url = request.getUrl().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116                     if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 117                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 117                         SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118                     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119                         BrowserUtils.launchBrowserOrShowError(requireContext(), url);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122                     return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127             ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
 129 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 130         return layout;
 131     }
 132 
 133     @Override
 134     public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 135         switch (item.getItemId()) {
 136             case android.R.id.home:
 137                 if (!isAdded()) {
 138                     return false;
 139                 }
 140 
 141                 requireActivity().finish();
 142                 return true;
 143             case R.id.menu_trash:
 144                 if (!isAdded()) {
 145                     return false;
 146                 }
 147 
 148                 deleteNote();
 149                 return true;
 150             case R.id.menu_copy_internal:
 151                 if (!isAdded()) {
 152                     return false;
 153                 }
 154 
<abbr title=" 155                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 155                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 156                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 157                 } else {
 158                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 159                 }
 160 
 161                 return true;
 162             default:
 163                 return super.onOptionsItemSelected(item);
 164         }
 165     }
 166 
 167     private void deleteNote() {
 168         NoteUtils.deleteNote(mNote, getActivity());
 169         requireActivity().finish();
 170     }
 171 
 172     @Override
 173     public void onPrepareOptionsMenu(@NonNull Menu menu) {
 174         // Disable share and delete actions until note is loaded.
 175         if (mIsLoadingNote) {
 176             menu.findItem(R.id.menu_trash).setEnabled(false);
 177         } else {
 178             menu.findItem(R.id.menu_trash).setEnabled(true);
 179         }
 180 
 181         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 182         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 183         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 184         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 185         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 186 
 187         if (mNote != null) {
 188             pinItem.setChecked(mNote.isPinned());
 189             publishItem.setChecked(mNote.isPublished());
 190             markdownItem.setChecked(mNote.isMarkdownEnabled());
 191         }
 192 
 193         pinItem.setEnabled(false);
 194         publishItem.setEnabled(false);
 195         copyLinkItem.setEnabled(false);
 196         markdownItem.setEnabled(false);
 197         copyLinkInternalItem.setEnabled(true);
 198 
 199         super.onPrepareOptionsMenu(menu);
 200     }
 201 
 202     @Override
 203     public void onDestroy() {
 204         super.onDestroy();
 205         mNotesBucket.removeListener(this);
 206         mNotesBucket.stop();
 207         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 208         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 209     }
 210 
 211     @Override
 212     public void onResume() {
 213         super.onResume();
 214         mNotesBucket.start();
 215         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 216         mNotesBucket.addListener(this);
 217         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 218         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 219     }
 220 
 221     @Override
 222     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 223     }
 224 
 225     @Override
 226     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 227     }
 228 
 229     @Override
 230     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 231     }
 232 
 233     @Override
 234     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 235         if (note.equals(mNote)) {
 236             mNote = note;
 237             requireActivity().invalidateOptionsMenu();
 238         }
 239 
 240         AppLog.add(
 241             Type.SYNC,
 242             &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 243                 &quot; / Title: &quot; + note.getTitle() +
 244                 &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 245                 &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 246         );
 247     }
 248 
 249     public void updateMarkdown(String text) {
<abbr title=" 250         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 250         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 251     }
 252 
 253     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 254         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 255                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 256                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 257 
 258         String parsedMarkdown = new AndDown().markdownToHtml(
 259                 sourceContent,
 260                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 261                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 262                 AndDown.HOEDOWN_HTML_ESCAPE
 263         );
 264 
 265         // Set auto alignment for lists, tables, and quotes based on language of start.
 266         parsedMarkdown = parsedMarkdown
 267                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 268                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 269                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 270                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 271 
 272         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 273                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 274     }
 275 
 276     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 277         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 278 
 279         private LoadNoteTask(NoteMarkdownFragment context) {
 280             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 281         }
 282 
 283         @Override
 284         protected void onPreExecute() {
 285             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 286             fragment.mIsLoadingNote = true;
 287         }
 288 
 289         @Override
 290         protected Void doInBackground(String... args) {
 291             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 292             FragmentActivity activity = fragment.getActivity();
 293 
 294             if (activity == null) {
 295                 return null;
 296             }
 297 
 298             String noteID = args[0];
 299             Simplenote application = (Simplenote) activity.getApplication();
 300             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 301 
 302             try {
 303                 fragment.mNote = notesBucket.get(noteID);
 304             } catch (BucketObjectMissingException exception) {
 305                 // TODO: Handle a missing note
 306             }
 307 
 308             return null;
 309         }
 310 
 311         @Override
 312         protected void onPostExecute(Void nada) {
 313             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 314             fragment.mIsLoadingNote = false;
 315             fragment.requireActivity().invalidateOptionsMenu();
 316         }
 317     }
 318 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.os.AsyncTask;
   4 import android.os.Bundle;
   5 import android.view.LayoutInflater;
   6 import android.view.Menu;
   7 import android.view.MenuInflater;
   8 import android.view.MenuItem;
   9 import android.view.View;
  10 import android.view.ViewGroup;
  11 import android.webkit.WebResourceRequest;
  12 import android.webkit.WebView;
  13 import android.webkit.WebViewClient;
  14 import androidx.annotation.NonNull;
  15 import androidx.core.view.MenuCompat;
  16 import androidx.fragment.app.Fragment;
  17 import androidx.fragment.app.FragmentActivity;
  18 import com.automattic.simplenote.models.Note;
  19 import com.automattic.simplenote.utils.AppLog.Type;
  20 import com.automattic.simplenote.utils.AppLog;
  21 import com.automattic.simplenote.utils.BrowserUtils;
  22 import com.automattic.simplenote.utils.ContextUtils;
  23 import com.automattic.simplenote.utils.DrawableUtils;
  24 import com.automattic.simplenote.utils.NetworkUtils;
  25 import com.automattic.simplenote.utils.NoteUtils;
  26 import com.automattic.simplenote.utils.SimplenoteLinkify;
  27 import com.automattic.simplenote.utils.ThemeUtils;
  28 import com.commonsware.cwac.anddown.AndDown;
  29 import com.google.android.material.snackbar.Snackbar;
  30 import com.simperium.client.Bucket;
  31 import com.simperium.client.BucketObjectMissingException;
  32 import java.lang.ref.SoftReference;
  33 import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;
  34 
  35 
  36 public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  37     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  38 
  39     private Bucket&lt;Note&gt; mNotesBucket;
  40 
  41     private Note mNote;
  42 
  43     private String mCss;
  44 
  45     private WebView mMarkdown;
  46 
  47     private boolean mIsLoadingNote;
  48 
  49     @Override
  50     public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  51         inflater.inflate(R.menu.note_markdown, menu);
  52         MenuCompat.setGroupDividerEnabled(menu, true);
  53 
  54         DrawableUtils.tintMenuWithAttribute(
  55             requireContext(),
  56             menu,
  57             R.attr.toolbarIconColor
  58         );
  59 
  60         for (int i = 0; i &lt; menu.size(); i++) {
  61             MenuItem item = menu.getItem(i);
  62             DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  63         }
  64 
  65         if (mNote != null) {
  66             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  67             viewPublishedNoteItem.setVisible(true);
  68             MenuItem trashItem = menu.findItem(R.id.menu_trash);
  69 
  70             if (mNote.isDeleted()) {
  71                 trashItem.setTitle(R.string.restore);
  72             } else {
  73                 trashItem.setTitle(R.string.trash);
  74             }
  75 
  76             DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  77         }
  78 
  79         super.onCreateOptionsMenu(menu, inflater);
  80     }
  81 
  82     @Override
  83     public View onCreateView(@NonNull
  84     LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  85         AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  86         mNotesBucket = ((Simplenote) (requireActivity().getApplication())).getNotesBucket();
  87         // Load note if we were passed an ID.
  88         Bundle arguments = getArguments();
  89         if ((arguments != null) &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90             String key = arguments.getString(ARG_ITEM_ID);
  91             new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92         }
  93         setHasOptionsMenu(true);
  94         View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  95         mMarkdown = layout.findViewById(R.id.markdown);
  96         mMarkdown.setWebViewClient(new WebViewClient() {
  97             @Override
  98             public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
  99                 String url = request.getUrl().toString();
 100                 if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)) {
<abbr title=" 101                     SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));"> 101                     SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;)ðŸ”µ</abbr>
 102                 } else {
 103                     BrowserUtils.launchBrowserOrShowError(requireContext(), url);
 104                 }
 105                 return true;
 106             }
 107         });
 108         mCss = ContextUtils.readCssFile(requireContext(), ThemeUtils.getCssFromStyle(requireContext()));
 109         return layout;
 110     }
 111 
 112     @Override
 113     public boolean onOptionsItemSelected(@NonNull
 114     MenuItem item) {
 115         switch (item.getItemId()) {
 116             case android.R.id.home :
 117                 if (!isAdded()) {
 118                     return false;
 119                 }
 120                 requireActivity().finish();
 121                 return true;
 122             case R.id.menu_trash :
 123                 if (!isAdded()) {
 124                     return false;
 125                 }
 126                 deleteNote();
 127                 return true;
 128             case R.id.menu_copy_internal :
 129                 if (!isAdded()) {
 130                     return false;
 131                 }
<abbr title=" 132                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 132                 if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitleðŸ”µ</abbr>
 133                     Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();
 134                 } else {
 135                     Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();
 136                 }
 137                 return true;
 138             default :
 139                 return super.onOptionsItemSelected(item);
 140         }
 141     }
 142 
 143     private void deleteNote() {
 144         NoteUtils.deleteNote(mNote, getActivity());
 145         requireActivity().finish();
 146     }
 147 
 148     @Override
 149     public void onPrepareOptionsMenu(@NonNull
 150     Menu menu) {
 151         // Disable share and delete actions until note is loaded.
 152         if (mIsLoadingNote) {
 153             menu.findItem(R.id.menu_trash).setEnabled(false);
 154         } else {
 155             menu.findItem(R.id.menu_trash).setEnabled(true);
 156         }
 157         MenuItem pinItem = menu.findItem(R.id.menu_pin);
 158         MenuItem publishItem = menu.findItem(R.id.menu_publish);
 159         MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 160         MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
 161         MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);
 162         if (mNote != null) {
 163             pinItem.setChecked(mNote.isPinned());
 164             publishItem.setChecked(mNote.isPublished());
 165             markdownItem.setChecked(mNote.isMarkdownEnabled());
 166         }
 167         pinItem.setEnabled(false);
 168         publishItem.setEnabled(false);
 169         copyLinkItem.setEnabled(false);
 170         markdownItem.setEnabled(false);
 171         copyLinkInternalItem.setEnabled(true);
 172         super.onPrepareOptionsMenu(menu);
 173     }
 174 
 175     @Override
 176     public void onDestroy() {
 177         super.onDestroy();
 178         mNotesBucket.removeListener(this);
 179         mNotesBucket.stop();
 180         AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 181         AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 182     }
 183 
 184     @Override
 185     public void onResume() {
 186         super.onResume();
 187         mNotesBucket.start();
 188         AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 189         mNotesBucket.addListener(this);
 190         AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 191         AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 192     }
 193 
 194     @Override
 195     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 196     }
 197 
 198     @Override
 199     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 200     }
 201 
 202     @Override
 203     public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 204     }
 205 
 206     @Override
 207     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 208         if (note.equals(mNote)) {
 209             mNote = note;
 210             requireActivity().invalidateOptionsMenu();
 211         }
 212 
 213         AppLog.add(
 214             Type.SYNC,
 215             &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 216                 &quot; / Title: &quot; + note.getTitle() +
 217                 &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 218                 &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 219         );
 220     }
 221 
 222     public void updateMarkdown(String text) {
<abbr title=" 223         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);"> 223         mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;ðŸ”µ</abbr>
 224     }
 225 
 226     public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 227         String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 228                 &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 229                 cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 230 
 231         String parsedMarkdown = new AndDown().markdownToHtml(
 232                 sourceContent,
 233                 AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 234                         AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 235                 AndDown.HOEDOWN_HTML_ESCAPE
 236         );
 237 
 238         // Set auto alignment for lists, tables, and quotes based on language of start.
 239         parsedMarkdown = parsedMarkdown
 240                 .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 241                 .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 242                 .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 243                 .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 244 
 245         return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 246                 &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 247     }
 248 
 249     private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 250         private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 251 
 252         private LoadNoteTask(NoteMarkdownFragment context) {
 253             mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 254         }
 255 
 256         @Override
 257         protected void onPreExecute() {
 258             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 259             fragment.mIsLoadingNote = true;
 260         }
 261 
 262         @Override
 263         protected Void doInBackground(String... args) {
 264             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 265             FragmentActivity activity = fragment.getActivity();
 266             if (activity == null) {
 267                 return null;
 268             }
 269             String noteID = args[0];
 270             Simplenote application = ((Simplenote) (activity.getApplication()));
 271             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 272             try {
 273                 fragment.mNote = notesBucket.get(noteID);
 274             } catch (BucketObjectMissingException exception) {
 275                 // TODO: Handle a missing note
 276             }
 277             return null;
 278         }
 279 
 280         @Override
 281         protected void onPostExecute(Void nada) {
 282             NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 283             fragment.mIsLoadingNote = false;
 284             fragment.requireActivity().invalidateOptionsMenu();
 285         }
 286     }
 287 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.os.AsyncTask;
   4  import android.os.Bundle;
   5  import android.view.LayoutInflater;
   6  import android.view.Menu;
   7  import android.view.MenuInflater;
   8  import android.view.MenuItem;
   9  import android.view.View;
  10  import android.view.ViewGroup;

  11  import android.webkit.WebView;

  12  
  13  import androidx.annotation.NonNull;
  14  import androidx.core.view.MenuCompat;
  15  import androidx.fragment.app.Fragment;
  16  import androidx.fragment.app.FragmentActivity;
  17  
  18  import com.automattic.simplenote.models.Note;
  19  import com.automattic.simplenote.utils.AppLog;
  20  import com.automattic.simplenote.utils.AppLog.Type;

  21  import com.automattic.simplenote.utils.ContextUtils;
  22  import com.automattic.simplenote.utils.DrawableUtils;
  23  import com.automattic.simplenote.utils.NetworkUtils;
  24  import com.automattic.simplenote.utils.NoteUtils;

  25  import com.automattic.simplenote.utils.ThemeUtils;
  26  import com.commonsware.cwac.anddown.AndDown;

  27  import com.simperium.client.Bucket;
  28  import com.simperium.client.BucketObjectMissingException;
  29  
  30  import java.lang.ref.SoftReference;


  31  
  32  public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  33      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  34  
  35      private Bucket&lt;Note&gt; mNotesBucket;
  36      private Note mNote;
  37      private String mCss;
  38      private WebView mMarkdown;
  39      private boolean mIsLoadingNote;
  40  
  41      @Override
  42      public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  43          inflater.inflate(R.menu.note_markdown, menu);
  44          MenuCompat.setGroupDividerEnabled(menu, true);
  45  
  46          DrawableUtils.tintMenuWithAttribute(
  47              requireContext(),
  48              menu,
  49              R.attr.toolbarIconColor
  50          );
  51  
  52          for (int i = 0; i &lt; menu.size(); i++) {
  53              MenuItem item = menu.getItem(i);
  54              DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  55          }
  56  
  57          if (mNote != null) {
  58              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  59              viewPublishedNoteItem.setVisible(true);
  60              MenuItem trashItem = menu.findItem(R.id.menu_trash);
  61  
  62              if (mNote.isDeleted()) {
  63                  trashItem.setTitle(R.string.restore);
  64              } else {
  65                  trashItem.setTitle(R.string.trash);
  66              }
  67  
  68              DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  69          }
  70  
  71          super.onCreateOptionsMenu(menu, inflater);
  72      }
  73  
  74      @Override
  75      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  76          AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  77          mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  78  
  79          // Load note if we were passed an ID.
  80          Bundle arguments = getArguments();
  81  
  82          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  83              String key = arguments.getString(ARG_ITEM_ID);
  84              new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  85          }
  86  
  87          setHasOptionsMenu(true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -                ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -                : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        mCss = ContextUtils.readCssFile(requireContext(), ThemeUtils.getCssFromStyle(requireContext()));</span>
  92          View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  93          mMarkdown = layout.findViewById(R.id.markdown);



















  94          return layout;
  95      }
  96  
  97      @Override
  98      public boolean onOptionsItemSelected(@NonNull MenuItem item) {
  99          switch (item.getItemId()) {







 100              case R.id.menu_trash:
 101                  if (!isAdded()) {
 102                      return false;
 103                  }
 104  
 105                  deleteNote();
 106                  return true;
 107              case android.R.id.home:

 108                  if (!isAdded()) {
 109                      return false;
 110                  }
 111  
 112                  requireActivity().finish();






 113                  return true;
 114              default:
 115                  return super.onOptionsItemSelected(item);
 116          }
 117      }
 118  
 119      private void deleteNote() {
 120          NoteUtils.deleteNote(mNote, getActivity());
 121          requireActivity().finish();
 122      }
 123  
 124      @Override
 125      public void onPrepareOptionsMenu(@NonNull Menu menu) {
 126          // Disable share and delete actions until note is loaded.
 127          if (mIsLoadingNote) {
 128              menu.findItem(R.id.menu_trash).setEnabled(false);
 129          } else {
 130              menu.findItem(R.id.menu_trash).setEnabled(true);
 131          }
 132  
 133          MenuItem pinItem = menu.findItem(R.id.menu_pin);
 134          MenuItem publishItem = menu.findItem(R.id.menu_publish);
 135          MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 136          MenuItem markdownItem = menu.findItem(R.id.menu_markdown);

 137  
 138          if (mNote != null) {
 139              pinItem.setChecked(mNote.isPinned());
 140              publishItem.setChecked(mNote.isPublished());
 141              markdownItem.setChecked(mNote.isMarkdownEnabled());
 142          }
 143  
 144          pinItem.setEnabled(false);
 145          publishItem.setEnabled(false);
 146          copyLinkItem.setEnabled(false);
 147          markdownItem.setEnabled(false);

 148  
 149          super.onPrepareOptionsMenu(menu);
 150      }
 151  
 152      @Override
 153      public void onDestroy() {
 154          super.onDestroy();
 155          mNotesBucket.removeListener(this);
 156          mNotesBucket.stop();
 157          AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 158          AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 159      }
 160  
 161      @Override
 162      public void onResume() {
 163          super.onResume();
 164          mNotesBucket.start();
 165          AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 166          mNotesBucket.addListener(this);
 167          AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 168          AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 169      }
 170  
 171      @Override
 172      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 173      }
 174  
 175      @Override
 176      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 177      }
 178  
 179      @Override
 180      public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 181      }
 182  
 183      @Override
 184      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 185          if (note.equals(mNote)) {
 186              mNote = note;
 187              requireActivity().invalidateOptionsMenu();
 188          }
 189  
 190          AppLog.add(
 191              Type.SYNC,
 192              &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 193                  &quot; / Title: &quot; + note.getTitle() +
 194                  &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 195                  &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 196          );
 197      }
 198  
 199      public void updateMarkdown(String text) {
 200          mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 201      }
 202  
 203      public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 204          String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 205                  &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 206                  cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 207  
 208          String parsedMarkdown = new AndDown().markdownToHtml(
 209                  sourceContent,
 210                  AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 211                          AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 212                  AndDown.HOEDOWN_HTML_ESCAPE
 213          );
 214  
 215          // Set auto alignment for lists, tables, and quotes based on language of start.
 216          parsedMarkdown = parsedMarkdown
 217                  .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 218                  .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 219                  .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 220                  .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 221  
 222          return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 223                  &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 224      }
 225  
 226      private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 227          private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 228  
 229          private LoadNoteTask(NoteMarkdownFragment context) {
 230              mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 231          }
 232  
 233          @Override
 234          protected void onPreExecute() {
 235              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 236              fragment.mIsLoadingNote = true;
 237          }
 238  
 239          @Override
 240          protected Void doInBackground(String... args) {
 241              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 242              FragmentActivity activity = fragment.getActivity();
 243  
 244              if (activity == null) {
 245                  return null;
 246              }
 247  
 248              String noteID = args[0];
 249              Simplenote application = (Simplenote) activity.getApplication();
 250              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 251  
 252              try {
 253                  fragment.mNote = notesBucket.get(noteID);
 254              } catch (BucketObjectMissingException exception) {
 255                  // TODO: Handle a missing note
 256              }
 257  
 258              return null;
 259          }
 260  
 261          @Override
 262          protected void onPostExecute(Void nada) {
 263              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 264              fragment.mIsLoadingNote = false;
 265              fragment.requireActivity().invalidateOptionsMenu();
 266          }
 267      }
 268  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.os.AsyncTask;
   4  import android.os.Bundle;
   5  import android.view.LayoutInflater;
   6  import android.view.Menu;
   7  import android.view.MenuInflater;
   8  import android.view.MenuItem;
   9  import android.view.View;
  10  import android.view.ViewGroup;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import android.webkit.WebResourceRequest;</span>
  12  import android.webkit.WebView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import android.webkit.WebViewClient;</span>
  14  
  15  import androidx.annotation.NonNull;
  16  import androidx.core.view.MenuCompat;
  17  import androidx.fragment.app.Fragment;
  18  import androidx.fragment.app.FragmentActivity;
  19  
  20  import com.automattic.simplenote.models.Note;
  21  import com.automattic.simplenote.utils.AppLog;
  22  import com.automattic.simplenote.utils.AppLog.Type;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.automattic.simplenote.utils.BrowserUtils;</span>
  24  import com.automattic.simplenote.utils.ContextUtils;
  25  import com.automattic.simplenote.utils.DrawableUtils;
  26  import com.automattic.simplenote.utils.NetworkUtils;
  27  import com.automattic.simplenote.utils.NoteUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.automattic.simplenote.utils.SimplenoteLinkify;</span>
  29  import com.automattic.simplenote.utils.ThemeUtils;
  30  import com.commonsware.cwac.anddown.AndDown;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import com.google.android.material.snackbar.Snackbar;</span>
  32  import com.simperium.client.Bucket;
  33  import com.simperium.client.BucketObjectMissingException;
  34  
  35  import java.lang.ref.SoftReference;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import static com.automattic.simplenote.utils.SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX;</span>
  38  
  39  public class NoteMarkdownFragment extends Fragment implements Bucket.Listener&lt;Note&gt; {
  40      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  41  
  42      private Bucket&lt;Note&gt; mNotesBucket;
  43      private Note mNote;
  44      private String mCss;
  45      private WebView mMarkdown;
  46      private boolean mIsLoadingNote;
  47  
  48      @Override
  49      public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {
  50          inflater.inflate(R.menu.note_markdown, menu);
  51          MenuCompat.setGroupDividerEnabled(menu, true);
  52  
  53          DrawableUtils.tintMenuWithAttribute(
  54              requireContext(),
  55              menu,
  56              R.attr.toolbarIconColor
  57          );
  58  
  59          for (int i = 0; i &lt; menu.size(); i++) {
  60              MenuItem item = menu.getItem(i);
  61              DrawableUtils.setMenuItemAlpha(item, 0.3);  // 0.3 is 30% opacity.
  62          }
  63  
  64          if (mNote != null) {
  65              MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_info);
  66              viewPublishedNoteItem.setVisible(true);
  67              MenuItem trashItem = menu.findItem(R.id.menu_trash);
  68  
  69              if (mNote.isDeleted()) {
  70                  trashItem.setTitle(R.string.restore);
  71              } else {
  72                  trashItem.setTitle(R.string.trash);
  73              }
  74  
  75              DrawableUtils.tintMenuItemWithAttribute(getActivity(), trashItem, R.attr.toolbarIconColor);
  76          }
  77  
  78          super.onCreateOptionsMenu(menu, inflater);
  79      }
  80  
  81      @Override
  82      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  83          AppLog.add(Type.SCREEN, &quot;Created (NoteMarkdownFragment)&quot;);
  84          mNotesBucket = ((Simplenote) requireActivity().getApplication()).getNotesBucket();
  85  
  86          // Load note if we were passed an ID.
  87          Bundle arguments = getArguments();
  88  
  89          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
  90              String key = arguments.getString(ARG_ITEM_ID);
  91              new LoadNoteTask(this).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
  92          }
  93  
  94          setHasOptionsMenu(true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -                ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -                : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>

  98          View layout = inflater.inflate(R.layout.fragment_note_markdown, container, false);
  99          mMarkdown = layout.findViewById(R.id.markdown);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        mMarkdown.setWebViewClient(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +            new WebViewClient() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                    String url = request.getUrl().toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                    if (url.startsWith(SimplenoteLinkify.SIMPLENOTE_LINK_PREFIX)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                        SimplenoteLinkify.openNote(requireActivity(), url.replace(SIMPLENOTE_LINK_PREFIX, &quot;&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                        BrowserUtils.launchBrowserOrShowError(requireContext(), url);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                    return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        mCss = ThemeUtils.isLightTheme(requireContext())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +            ? ContextUtils.readCssFile(requireContext(), &quot;light.css&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +            : ContextUtils.readCssFile(requireContext(), &quot;dark.css&quot;);</span>
 119          return layout;
 120      }
 121  
 122      @Override
 123      public boolean onOptionsItemSelected(@NonNull MenuItem item) {
 124          switch (item.getItemId()) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            case android.R.id.home:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                if (!isAdded()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                    return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                requireActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                return true;</span>
 132              case R.id.menu_trash:
 133                  if (!isAdded()) {
 134                      return false;
 135                  }
 136  
 137                  deleteNote();
 138                  return true;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            case android.R.id.home:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            case R.id.menu_copy_internal:</span>
 141                  if (!isAdded()) {
 142                      return false;
 143                  }
 144  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                requireActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 146 +                if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.getTitle(), mNote.getSimperiumKey()))) {"> 146 +                if (BrowserUtils.copyToClipboard(requireContext(), SimplenoteLinkify.getNoteLinkWithTitle(mNote.geðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                    Snackbar.make(mMarkdown, R.string.link_copied, Snackbar.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                    Snackbar.make(mMarkdown, R.string.link_copied_failure, Snackbar.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +</span>
 152                  return true;
 153              default:
 154                  return super.onOptionsItemSelected(item);
 155          }
 156      }
 157  
 158      private void deleteNote() {
 159          NoteUtils.deleteNote(mNote, getActivity());
 160          requireActivity().finish();
 161      }
 162  
 163      @Override
 164      public void onPrepareOptionsMenu(@NonNull Menu menu) {
 165          // Disable share and delete actions until note is loaded.
 166          if (mIsLoadingNote) {
 167              menu.findItem(R.id.menu_trash).setEnabled(false);
 168          } else {
 169              menu.findItem(R.id.menu_trash).setEnabled(true);
 170          }
 171  
 172          MenuItem pinItem = menu.findItem(R.id.menu_pin);
 173          MenuItem publishItem = menu.findItem(R.id.menu_publish);
 174          MenuItem copyLinkItem = menu.findItem(R.id.menu_copy);
 175          MenuItem markdownItem = menu.findItem(R.id.menu_markdown);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +        MenuItem copyLinkInternalItem = menu.findItem(R.id.menu_copy_internal);</span>
 177  
 178          if (mNote != null) {
 179              pinItem.setChecked(mNote.isPinned());
 180              publishItem.setChecked(mNote.isPublished());
 181              markdownItem.setChecked(mNote.isMarkdownEnabled());
 182          }
 183  
 184          pinItem.setEnabled(false);
 185          publishItem.setEnabled(false);
 186          copyLinkItem.setEnabled(false);
 187          markdownItem.setEnabled(false);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +        copyLinkInternalItem.setEnabled(true);</span>
 189  
 190          super.onPrepareOptionsMenu(menu);
 191      }
 192  
 193      @Override
 194      public void onDestroy() {
 195          super.onDestroy();
 196          mNotesBucket.removeListener(this);
 197          mNotesBucket.stop();
 198          AppLog.add(Type.SYNC, &quot;Stopped note bucket (NoteMarkdownFragment)&quot;);
 199          AppLog.add(Type.SCREEN, &quot;Destroyed (NoteMarkdownFragment)&quot;);
 200      }
 201  
 202      @Override
 203      public void onResume() {
 204          super.onResume();
 205          mNotesBucket.start();
 206          AppLog.add(Type.SYNC, &quot;Started note bucket (NoteMarkdownFragment)&quot;);
 207          mNotesBucket.addListener(this);
 208          AppLog.add(Type.NETWORK, NetworkUtils.getNetworkInfo(requireContext()));
 209          AppLog.add(Type.SCREEN, &quot;Resumed (NoteMarkdownFragment)&quot;);
 210      }
 211  
 212      @Override
 213      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 214      }
 215  
 216      @Override
 217      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note note) {
 218      }
 219  
 220      @Override
 221      public void onNetworkChange(Bucket&lt;Note&gt; bucket, Bucket.ChangeType type, String key) {
 222      }
 223  
 224      @Override
 225      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note note) {
 226          if (note.equals(mNote)) {
 227              mNote = note;
 228              requireActivity().invalidateOptionsMenu();
 229          }
 230  
 231          AppLog.add(
 232              Type.SYNC,
 233              &quot;Saved note callback in NoteMarkdownFragment (ID: &quot; + note.getSimperiumKey() +
 234                  &quot; / Title: &quot; + note.getTitle() +
 235                  &quot; / Characters: &quot; + NoteUtils.getCharactersCount(note.getContent()) +
 236                  &quot; / Words: &quot; + NoteUtils.getWordCount(note.getContent()) + &quot;)&quot;
 237          );
 238      }
 239  
 240      public void updateMarkdown(String text) {
 241          mMarkdown.loadDataWithBaseURL(null, getMarkdownFormattedContent(mCss, text), &quot;text/html&quot;, &quot;utf-8&quot;, null);
 242      }
 243  
 244      public static String getMarkdownFormattedContent(String cssContent, String sourceContent) {
 245          String header = &quot;&lt;html&gt;&lt;head&gt;&quot; +
 246                  &quot;&lt;link href=\&quot;https://fonts.googleapis.com/css?family=Noto+Serif\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot; +
 247                  cssContent + &quot;&lt;/head&gt;&lt;body&gt;&quot;;
 248  
 249          String parsedMarkdown = new AndDown().markdownToHtml(
 250                  sourceContent,
 251                  AndDown.HOEDOWN_EXT_STRIKETHROUGH | AndDown.HOEDOWN_EXT_FENCED_CODE |
 252                          AndDown.HOEDOWN_EXT_QUOTE | AndDown.HOEDOWN_EXT_TABLES,
 253                  AndDown.HOEDOWN_HTML_ESCAPE
 254          );
 255  
 256          // Set auto alignment for lists, tables, and quotes based on language of start.
 257          parsedMarkdown = parsedMarkdown
 258                  .replaceAll(&quot;&lt;ol&gt;&quot;, &quot;&lt;ol dir=\&quot;auto\&quot;&gt;&quot;)
 259                  .replaceAll(&quot;&lt;ul&gt;&quot;, &quot;&lt;ul dir=\&quot;auto\&quot;&gt;&quot;)
 260                  .replaceAll(&quot;&lt;table&gt;&quot;, &quot;&lt;table dir=\&quot;auto\&quot;&gt;&quot;)
 261                  .replaceAll(&quot;&lt;blockquote&gt;&quot;, &quot;&lt;blockquote dir=\&quot;auto\&quot;&gt;&quot;);
 262  
 263          return header + &quot;&lt;div class=\&quot;note-detail-markdown\&quot;&gt;&quot; + parsedMarkdown +
 264                  &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
 265      }
 266  
 267      private static class LoadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 268          private SoftReference&lt;NoteMarkdownFragment&gt; mNoteMarkdownFragmentReference;
 269  
 270          private LoadNoteTask(NoteMarkdownFragment context) {
 271              mNoteMarkdownFragmentReference = new SoftReference&lt;&gt;(context);
 272          }
 273  
 274          @Override
 275          protected void onPreExecute() {
 276              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 277              fragment.mIsLoadingNote = true;
 278          }
 279  
 280          @Override
 281          protected Void doInBackground(String... args) {
 282              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 283              FragmentActivity activity = fragment.getActivity();
 284  
 285              if (activity == null) {
 286                  return null;
 287              }
 288  
 289              String noteID = args[0];
 290              Simplenote application = (Simplenote) activity.getApplication();
 291              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 292  
 293              try {
 294                  fragment.mNote = notesBucket.get(noteID);
 295              } catch (BucketObjectMissingException exception) {
 296                  // TODO: Handle a missing note
 297              }
 298  
 299              return null;
 300          }
 301  
 302          @Override
 303          protected void onPostExecute(Void nada) {
 304              NoteMarkdownFragment fragment = mNoteMarkdownFragmentReference.get();
 305              fragment.mIsLoadingNote = false;
 306              fragment.requireActivity().invalidateOptionsMenu();
 307          }
 308      }
 309  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            