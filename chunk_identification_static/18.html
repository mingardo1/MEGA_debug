<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>18</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    18
                    <a href="17.html">prev</a>
                    <a href="19.html">next</a>
                    <a href="18_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_651db90b99455d330ec1889f5728cc2d0742d9f9_app/src/main/java/com/arialyy/simple/core/download/m3u8/M3U8VodDLoadActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;651db90b99455d330ec1889f5728cc2d0742d9f9:app/src/main/java/com/arialyy/simple/core/download/m3u8/M3U8VodDLoadActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;651db90b99455d330ec1889f5728cc2d0742d9f9^1:app/src/main/java/com/arialyy/simple/core/download/m3u8/M3U8VodDLoadActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;651db90b99455d330ec1889f5728cc2d0742d9f9^2:app/src/main/java/com/arialyy/simple/core/download/m3u8/M3U8VodDLoadActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;fdb607e10faf4051fac8bac66cb5751ec828ae36:app/src/main/java/com/arialyy/simple/core/download/m3u8/M3U8VodDLoadActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s], [s]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.simple.core.download.m3u8;
  18 
  19 import android.arch.lifecycle.Observer;
  20 import android.arch.lifecycle.ViewModelProviders;
  21 import android.os.Bundle;
  22 import android.support.annotation.Nullable;
  23 import android.support.v4.app.FragmentTransaction;
  24 import android.util.Log;
  25 import android.view.Menu;
  26 import android.view.MenuItem;
  27 import android.view.View;
  28 import android.widget.Toast;
  29 import com.arialyy.annotations.Download;
  30 import com.arialyy.annotations.M3U8;
  31 import com.arialyy.aria.core.Aria;
  32 import com.arialyy.aria.core.common.controller.ControllerType;
  33 import com.arialyy.aria.core.common.controller.StartController;
  34 import com.arialyy.aria.core.download.DownloadEntity;
  35 import com.arialyy.aria.core.download.DownloadTask;
  36 import com.arialyy.aria.core.download.m3u8.IBandWidthUrlConverter;
  37 import com.arialyy.aria.core.download.m3u8.ITsMergeHandler;
  38 import com.arialyy.aria.core.download.m3u8.IVodTsUrlConverter;
  39 import com.arialyy.aria.core.download.m3u8.M3U8KeyInfo;
  40 import com.arialyy.aria.core.inf.IEntity;
  41 import com.arialyy.aria.util.ALog;
  42 import com.arialyy.aria.util.CommonUtil;
  43 import com.arialyy.frame.util.show.T;
  44 import com.arialyy.simple.R;
  45 import com.arialyy.simple.base.BaseActivity;
  46 import com.arialyy.simple.common.ModifyPathDialog;
  47 import com.arialyy.simple.common.ModifyUrlDialog;
  48 import com.arialyy.simple.databinding.ActivityM3u8VodBinding;
  49 import com.arialyy.simple.to.PeerIndex;
  50 import com.arialyy.simple.util.AppUtil;
  51 import java.io.File;
  52 import java.util.ArrayList;
  53 import java.util.List;
  54 import org.greenrobot.eventbus.EventBus;
  55 import org.greenrobot.eventbus.Subscribe;
  56 import org.greenrobot.eventbus.ThreadMode;
  57 
  58 public class M3U8VodDLoadActivity extends BaseActivity&lt;ActivityM3u8VodBinding&gt; {
  59 
  60   private String mUrl;
  61   private String mFilePath;
  62   private M3U8VodModule mModule;
  63   private VideoPlayerFragment mVideoFragment;
  64   private DownloadEntity mEntity;
  65 
  66   @Override
  67   protected void init(Bundle savedInstanceState) {
  68     super.init(savedInstanceState);
  69     setTitle(getString(R.string.m3u8_file));
  70     Aria.download(this).register();
  71     mModule = ViewModelProviders.of(this).get(M3U8VodModule.class);
  72     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  73 
  74       @Override public void onChanged(@Nullable DownloadEntity entity) {
  75         if (entity == null) {
  76           return;
  77         }
  78         mEntity = entity;
  79         if (mEntity.getState() == IEntity.STATE_STOP) {
  80           getBinding().setStateStr(getString(R.string.resume));
  81         } else if (mEntity.getState() == IEntity.STATE_RUNNING) {
  82           getBinding().setStateStr(getString(R.string.stop));
  83         }
  84 
  85         if (entity.getFileSize() != 0) {
  86           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
  87         }
  88         getBinding().setProgress(entity.getPercent());
  89         getBinding().setUrl(entity.getUrl());
  90         getBinding().setFilePath(entity.getFilePath());
  91         mUrl = entity.getUrl();
  92         mFilePath = entity.getFilePath();
  93         mVideoFragment = new VideoPlayerFragment(0, entity);
  94         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
  95         ft.add(R.id.video_content, mVideoFragment);
  96         ft.commit();
  97       }
  98     });
  99     getBinding().setViewModel(this);
 100   }
 101 
 102   public void chooseUrl() {
 103     ModifyUrlDialog dialog =
 104         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 105     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 106   }
 107 
 108   public void chooseFilePath() {
 109     ModifyPathDialog dialog =
 110         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 111     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 112   }
 113 
 114   @Override protected void onStart() {
 115     super.onStart();
 116     EventBus.getDefault().register(this);
 117   }
 118 
 119   @Override protected void onStop() {
 120     super.onStop();
 121     EventBus.getDefault().unregister(this);
 122   }
 123 
 124   @Subscribe(threadMode = ThreadMode.MAIN)
 125   public void jumpIndex(PeerIndex index) {
 126     Aria.download(this).load(mUrl).asM3U8().asVod().jumPeerIndex(index.index);
 127   }
 128 
 129   @Override
 130   public boolean onCreateOptionsMenu(Menu menu) {
 131     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 132     return super.onCreateOptionsMenu(menu);
 133   }
 134 
 135   @Override
 136   public boolean onMenuItemClick(MenuItem item) {
 137     int speed = -1;
 138     String msg = &quot;&quot;;
 139     switch (item.getItemId()) {
 140       case R.id.help:
 141         msg = &quot;一些小知识点：\n&quot;
 142             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 143             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 144             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 145         showMsgDialog(&quot;tip&quot;, msg);
 146         break;
 147       case R.id.speed_0:
 148         speed = 0;
 149         break;
 150       case R.id.speed_128:
 151         speed = 128;
 152         break;
 153       case R.id.speed_256:
 154         speed = 256;
 155         break;
 156       case R.id.speed_512:
 157         speed = 512;
 158         break;
 159       case R.id.speed_1m:
 160         speed = 1024;
 161         break;
 162     }
 163     if (speed &gt; -1) {
 164       msg = item.getTitle().toString();
 165       Aria.download(this).setMaxSpeed(speed);
 166       T.showShort(this, msg);
 167     }
 168     return true;
 169   }
 170 
 171   @M3U8.onPeerStart
 172   void onPeerStart(String m3u8Url, String peerPath, int peerIndex) {
 173     //ALog.d(TAG, &quot;peer start, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 174   }
 175 
 176   @M3U8.onPeerComplete
 177   void onPeerComplete(String m3u8Url, String peerPath, int peerIndex) {
 178     //ALog.d(TAG, &quot;peer complete, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 179     mVideoFragment.addPlayer(peerIndex, peerPath);
 180   }
 181 
 182   @M3U8.onPeerFail
 183   void onPeerFail(String m3u8Url, String peerPath, int peerIndex) {
 184     //ALog.d(TAG, &quot;peer fail, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 185   }
 186 
 187   @Download.onWait
 188   void onWait(DownloadTask task) {
 189     if (task.getKey().equals(mUrl)) {
 190       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 191     }
 192   }
 193 
 194   @Download.onPre
 195   protected void onPre(DownloadTask task) {
 196     if (task.getKey().equals(mUrl)) {
 197       getBinding().setStateStr(getString(R.string.stop));
 198     }
 199   }
 200 
 201   @Download.onTaskStart
 202   void taskStart(DownloadTask task) {
 203     if (task.getKey().equals(mUrl)) {
 204       getBinding().setFileSize(task.getConvertFileSize());
 205       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 206     }
 207   }
 208 
 209   @Download.onTaskRunning
 210   protected void running(DownloadTask task) {
 211     if (task.getKey().equals(mUrl)) {
 212       //ALog.d(TAG, &quot;isRunning&quot;);
 213       getBinding().setProgress(task.getPercent());
 214       getBinding().setSpeed(task.getConvertSpeed());
 215     }
 216   }
 217 
 218   @Download.onTaskResume
 219   void taskResume(DownloadTask task) {
 220     if (task.getKey().equals(mUrl)) {
 221       getBinding().setStateStr(getString(R.string.stop));
 222     }
 223   }
 224 
 225   @Download.onTaskStop
 226   void taskStop(DownloadTask task) {
 227     if (task.getKey().equals(mUrl)) {
 228       getBinding().setStateStr(getString(R.string.resume));
 229       getBinding().setSpeed(&quot;&quot;);
 230     }
 231   }
 232 
 233   @Download.onTaskCancel
 234   void taskCancel(DownloadTask task) {
 235     if (task.getKey().equals(mUrl)) {
 236       getBinding().setProgress(0);
 237       getBinding().setStateStr(getString(R.string.start));
 238       getBinding().setSpeed(&quot;&quot;);
 239       Log.d(TAG, &quot;cancel&quot;);
 240     }
 241   }
 242 
 243   @Download.onTaskFail
 244   void taskFail(DownloadTask task, Exception e) {
 245     if (task.getKey().equals(mUrl)) {
 246       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_fail),
 247           Toast.LENGTH_SHORT)
 248           .show();
 249       getBinding().setStateStr(getString(R.string.start));
 250       getBinding().setSpeed(&quot;&quot;);
 251       Log.d(TAG, &quot;fail&quot;);
 252     }
 253   }
 254 
 255   @Download.onTaskComplete
 256   void taskComplete(DownloadTask task) {
 257     if (task.getKey().equals(mUrl)) {
 258       getBinding().setProgress(100);
 259       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_success),
 260           Toast.LENGTH_SHORT).show();
 261       getBinding().setStateStr(getString(R.string.re_start));
 262       getBinding().setSpeed(&quot;&quot;);
 263       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));
 264     }
 265   }
 266 
 267   @Override
 268   protected int setLayoutId() {
 269     return R.layout.activity_m3u8_vod;
 270   }
 271 
 272   public void onClick(View view) {
 273     switch (view.getId()) {
 274       case R.id.start:
 275         if (!AppUtil.chekEntityValid(mEntity)) {
 276           startD();
 277           break;
 278         }
 279         if (Aria.download(this).load(mEntity.getId()).isRunning()) {
 280           Aria.download(this).load(mEntity.getId()).stop();
 281         } else {
 282           Aria.download(this).load(mEntity.getId()).resume();
 283         }
 284         break;
 285       case R.id.cancel:
 286         if (AppUtil.chekEntityValid(mEntity)) {
 287           Aria.download(this).load(mEntity.getId()).cancel(true);
 288         }
 289         break;
 290     }
 291   }
 292 
 293   private void startD() {
 294     Aria.download(M3U8VodDLoadActivity.this)
 295         .load(mUrl)
 296         .useServerFileName(true)
 297         .setFilePath(mFilePath, true)
 298         .asM3U8()
 299         .setBandWidthUrlConverter(new IBandWidthUrlConverter() {
 300           @Override public String convert(String bandWidthUrl) {
 301             int index = mUrl.lastIndexOf(&quot;/&quot;);
 302             return mUrl.substring(0, index + 1) + bandWidthUrl;
 303           }
 304         })
 305         .setTsUrlConvert(new IVodTsUrlConverter() {
 306           @Override public List&lt;String&gt; convert(String m3u8Url, List&lt;String&gt; tsUrls) {
 307             int index = m3u8Url.lastIndexOf(&quot;/&quot;);
 308             String parentUrl = m3u8Url.substring(0, index + 1);
 309             List&lt;String&gt; newUrls = new ArrayList&lt;&gt;();
 310             for (String url : tsUrls) {
 311               newUrls.add(parentUrl + url);
 312             }
 313 
 314             return newUrls;
 315           }
 316         })
 317         .setMergeHandler(new ITsMergeHandler() {
 318           @Override public boolean merge(@Nullable M3U8KeyInfo keyInfo, List&lt;String&gt; tsPath) {
 319             ALog.d(TAG, &quot;合并TS....&quot;);
 320             return false;
 321           }
 322         })
 323 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324         .controller(ControllerType.START_CONTROLLER)</span>
 325 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         .start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329   @Override protected void dataCallback(int result, Object data) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     super.dataCallback(result, data);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332       mModule.uploadUrl(this, String.valueOf(data));</span>
 333 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334         .merge(true)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335         //.asVod().setPeerIndex(50)</span>
 336 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 337         .start();
 338     //.start();
 339     //.asVod().setPeerIndex(50)
 340     //.start();
 341   }
 342 
 343   private Class&lt;StartController&gt; c = StartController.class;
 344 
 345   @Override protected void dataCallback(int result, Object data) {
 346     super.dataCallback(result, data);
 347     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 348       mModule.uploadUrl(this, String.valueOf(data));
 349     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 350       mModule.updateFilePath(this, String.valueOf(data));
 351     }
 352   }
 353 }
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.simple.core.download.m3u8;
  18 
  19 import android.arch.lifecycle.Observer;
  20 import android.arch.lifecycle.ViewModelProviders;
  21 import android.os.Bundle;
  22 import android.support.annotation.Nullable;
  23 import android.support.v4.app.FragmentTransaction;
  24 import android.util.Log;
  25 import android.view.Menu;
  26 import android.view.MenuItem;
  27 import android.view.View;
  28 import android.widget.Toast;
  29 import com.arialyy.annotations.Download;
  30 import com.arialyy.annotations.M3U8;
  31 import com.arialyy.aria.core.Aria;
  32 import com.arialyy.aria.core.common.controller.ControllerType;
  33 import com.arialyy.aria.core.common.controller.StartController;
  34 import com.arialyy.aria.core.download.DownloadEntity;
  35 import com.arialyy.aria.core.download.DownloadTask;
  36 import com.arialyy.aria.core.download.m3u8.IBandWidthUrlConverter;
  37 import com.arialyy.aria.core.download.m3u8.ITsMergeHandler;
  38 import com.arialyy.aria.core.download.m3u8.IVodTsUrlConverter;
  39 import com.arialyy.aria.core.download.m3u8.M3U8KeyInfo;
  40 import com.arialyy.aria.core.inf.IEntity;
  41 import com.arialyy.aria.util.ALog;
  42 import com.arialyy.aria.util.CommonUtil;
  43 import com.arialyy.frame.util.show.T;
  44 import com.arialyy.simple.R;
  45 import com.arialyy.simple.base.BaseActivity;
  46 import com.arialyy.simple.common.ModifyPathDialog;
  47 import com.arialyy.simple.common.ModifyUrlDialog;
  48 import com.arialyy.simple.databinding.ActivityM3u8VodBinding;
  49 import com.arialyy.simple.to.PeerIndex;
  50 import com.arialyy.simple.util.AppUtil;
  51 import java.io.File;
  52 import java.util.ArrayList;
  53 import java.util.List;
  54 import org.greenrobot.eventbus.EventBus;
  55 import org.greenrobot.eventbus.Subscribe;
  56 import org.greenrobot.eventbus.ThreadMode;
  57 
  58 public class M3U8VodDLoadActivity extends BaseActivity&lt;ActivityM3u8VodBinding&gt; {
  59 
  60   private String mUrl;
  61   private String mFilePath;
  62   private M3U8VodModule mModule;
  63   private VideoPlayerFragment mVideoFragment;
  64   private DownloadEntity mEntity;
  65 
  66   @Override
  67   protected void init(Bundle savedInstanceState) {
  68     super.init(savedInstanceState);
  69     setTitle(getString(R.string.m3u8_file));
  70     Aria.download(this).register();
  71     mModule = ViewModelProviders.of(this).get(M3U8VodModule.class);
  72     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  73 
  74       @Override public void onChanged(@Nullable DownloadEntity entity) {
  75         if (entity == null) {
  76           return;
  77         }
  78         mEntity = entity;
  79         if (mEntity.getState() == IEntity.STATE_STOP) {
  80           getBinding().setStateStr(getString(R.string.resume));
  81         } else if (mEntity.getState() == IEntity.STATE_RUNNING) {
  82           getBinding().setStateStr(getString(R.string.stop));
  83         }
  84 
  85         if (entity.getFileSize() != 0) {
  86           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
  87         }
  88         getBinding().setProgress(entity.getPercent());
  89         getBinding().setUrl(entity.getUrl());
  90         getBinding().setFilePath(entity.getFilePath());
  91         mUrl = entity.getUrl();
  92         mFilePath = entity.getFilePath();
  93         mVideoFragment = new VideoPlayerFragment(0, entity);
  94         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
  95         ft.add(R.id.video_content, mVideoFragment);
  96         ft.commit();
  97       }
  98     });
  99     getBinding().setViewModel(this);
 100   }
 101 
 102   public void chooseUrl() {
 103     ModifyUrlDialog dialog =
 104         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 105     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 106   }
 107 
 108   public void chooseFilePath() {
 109     ModifyPathDialog dialog =
 110         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 111     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 112   }
 113 
 114   @Override protected void onStart() {
 115     super.onStart();
 116     EventBus.getDefault().register(this);
 117   }
 118 
 119   @Override protected void onStop() {
 120     super.onStop();
 121     EventBus.getDefault().unregister(this);
 122   }
 123 
 124   @Subscribe(threadMode = ThreadMode.MAIN)
 125   public void jumpIndex(PeerIndex index) {
 126     Aria.download(this).load(mUrl).asM3U8().asVod().jumPeerIndex(index.index);
 127   }
 128 
 129   @Override
 130   public boolean onCreateOptionsMenu(Menu menu) {
 131     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 132     return super.onCreateOptionsMenu(menu);
 133   }
 134 
 135   @Override
 136   public boolean onMenuItemClick(MenuItem item) {
 137     int speed = -1;
 138     String msg = &quot;&quot;;
 139     switch (item.getItemId()) {
 140       case R.id.help:
 141         msg = &quot;一些小知识点：\n&quot;
 142             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 143             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 144             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 145         showMsgDialog(&quot;tip&quot;, msg);
 146         break;
 147       case R.id.speed_0:
 148         speed = 0;
 149         break;
 150       case R.id.speed_128:
 151         speed = 128;
 152         break;
 153       case R.id.speed_256:
 154         speed = 256;
 155         break;
 156       case R.id.speed_512:
 157         speed = 512;
 158         break;
 159       case R.id.speed_1m:
 160         speed = 1024;
 161         break;
 162     }
 163     if (speed &gt; -1) {
 164       msg = item.getTitle().toString();
 165       Aria.download(this).setMaxSpeed(speed);
 166       T.showShort(this, msg);
 167     }
 168     return true;
 169   }
 170 
 171   @M3U8.onPeerStart
 172   void onPeerStart(String m3u8Url, String peerPath, int peerIndex) {
 173     //ALog.d(TAG, &quot;peer start, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 174   }
 175 
 176   @M3U8.onPeerComplete
 177   void onPeerComplete(String m3u8Url, String peerPath, int peerIndex) {
 178     //ALog.d(TAG, &quot;peer complete, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 179     mVideoFragment.addPlayer(peerIndex, peerPath);
 180   }
 181 
 182   @M3U8.onPeerFail
 183   void onPeerFail(String m3u8Url, String peerPath, int peerIndex) {
 184     //ALog.d(TAG, &quot;peer fail, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 185   }
 186 
 187   @Download.onWait
 188   void onWait(DownloadTask task) {
 189     if (task.getKey().equals(mUrl)) {
 190       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 191     }
 192   }
 193 
 194   @Download.onPre
 195   protected void onPre(DownloadTask task) {
 196     if (task.getKey().equals(mUrl)) {
 197       getBinding().setStateStr(getString(R.string.stop));
 198     }
 199   }
 200 
 201   @Download.onTaskStart
 202   void taskStart(DownloadTask task) {
 203     if (task.getKey().equals(mUrl)) {
 204       getBinding().setFileSize(task.getConvertFileSize());
 205       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 206     }
 207   }
 208 
 209   @Download.onTaskRunning
 210   protected void running(DownloadTask task) {
 211     if (task.getKey().equals(mUrl)) {
 212       //ALog.d(TAG, &quot;isRunning&quot;);
 213       getBinding().setProgress(task.getPercent());
 214       getBinding().setSpeed(task.getConvertSpeed());
 215     }
 216   }
 217 
 218   @Download.onTaskResume
 219   void taskResume(DownloadTask task) {
 220     if (task.getKey().equals(mUrl)) {
 221       getBinding().setStateStr(getString(R.string.stop));
 222     }
 223   }
 224 
 225   @Download.onTaskStop
 226   void taskStop(DownloadTask task) {
 227     if (task.getKey().equals(mUrl)) {
 228       getBinding().setStateStr(getString(R.string.resume));
 229       getBinding().setSpeed(&quot;&quot;);
 230     }
 231   }
 232 
 233   @Download.onTaskCancel
 234   void taskCancel(DownloadTask task) {
 235     if (task.getKey().equals(mUrl)) {
 236       getBinding().setProgress(0);
 237       getBinding().setStateStr(getString(R.string.start));
 238       getBinding().setSpeed(&quot;&quot;);
 239       Log.d(TAG, &quot;cancel&quot;);
 240     }
 241   }
 242 
 243   @Download.onTaskFail
 244   void taskFail(DownloadTask task, Exception e) {
 245     if (task.getKey().equals(mUrl)) {
 246       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_fail),
 247           Toast.LENGTH_SHORT)
 248           .show();
 249       getBinding().setStateStr(getString(R.string.start));
 250       getBinding().setSpeed(&quot;&quot;);
 251       Log.d(TAG, &quot;fail&quot;);
 252     }
 253   }
 254 
 255   @Download.onTaskComplete
 256   void taskComplete(DownloadTask task) {
 257     if (task.getKey().equals(mUrl)) {
 258       getBinding().setProgress(100);
 259       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_success),
 260           Toast.LENGTH_SHORT).show();
 261       getBinding().setStateStr(getString(R.string.re_start));
 262       getBinding().setSpeed(&quot;&quot;);
 263       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));
 264     }
 265   }
 266 
 267   @Override
 268   protected int setLayoutId() {
 269     return R.layout.activity_m3u8_vod;
 270   }
 271 
 272   public void onClick(View view) {
 273     switch (view.getId()) {
 274       case R.id.start:
 275         if (!AppUtil.chekEntityValid(mEntity)) {
 276           startD();
 277           break;
 278         }
 279         if (Aria.download(this).load(mEntity.getId()).isRunning()) {
 280           Aria.download(this).load(mEntity.getId()).stop();
 281         } else {
 282           Aria.download(this).load(mEntity.getId()).resume();
 283         }
 284         break;
 285       case R.id.cancel:
 286         if (AppUtil.chekEntityValid(mEntity)) {
 287           Aria.download(this).load(mEntity.getId()).cancel(true);
 288         }
 289         break;
 290     }
 291   }
 292 
 293   private void startD() {
 294     Aria.download(M3U8VodDLoadActivity.this)
 295         .load(mUrl)
 296         .useServerFileName(true)
 297         .setFilePath(mFilePath, true)
 298         .asM3U8()
 299         .setBandWidthUrlConverter(new IBandWidthUrlConverter() {
 300           @Override public String convert(String bandWidthUrl) {
 301             int index = mUrl.lastIndexOf(&quot;/&quot;);
 302             return mUrl.substring(0, index + 1) + bandWidthUrl;
 303           }
 304         })
 305         .setTsUrlConvert(new IVodTsUrlConverter() {
 306           @Override public List&lt;String&gt; convert(String m3u8Url, List&lt;String&gt; tsUrls) {
 307             int index = m3u8Url.lastIndexOf(&quot;/&quot;);
 308             String parentUrl = m3u8Url.substring(0, index + 1);
 309             List&lt;String&gt; newUrls = new ArrayList&lt;&gt;();
 310             for (String url : tsUrls) {
 311               newUrls.add(parentUrl + url);
 312             }
 313 
 314             return newUrls;
 315           }
 316         })
 317         .setMergeHandler(new ITsMergeHandler() {
 318           @Override public boolean merge(@Nullable M3U8KeyInfo keyInfo, List&lt;String&gt; tsPath) {
 319             ALog.d(TAG, &quot;合并TS....&quot;);
 320             return false;
 321           }
 322         })
 323 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324         .controller(ControllerType.START_CONTROLLER)</span>
 325 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         //.asVod().setPeerIndex(50)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327         .start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328   }</span>
 329 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330         .merge(true)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331         //.asVod().setPeerIndex(50)</span>
 332 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 333         .start();
 334     //.start();
 335     //.asVod().setPeerIndex(50)
 336     //.start();
 337   }
 338 
 339   private Class&lt;StartController&gt; c = StartController.class;
 340 
 341   @Override protected void dataCallback(int result, Object data) {
 342     super.dataCallback(result, data);
 343     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 344       mModule.uploadUrl(this, String.valueOf(data));
 345     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 346       mModule.updateFilePath(this, String.valueOf(data));
 347     }
 348   }
 349 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.simple.core.download.m3u8;
  17 
  18 import android.arch.lifecycle.Observer;
  19 import android.arch.lifecycle.ViewModelProviders;
  20 import android.os.Bundle;
  21 import android.support.annotation.Nullable;
  22 import android.support.v4.app.FragmentTransaction;
  23 import android.util.Log;
  24 import android.view.Menu;
  25 import android.view.MenuItem;
  26 import android.view.View;
  27 import android.widget.Toast;
  28 import com.arialyy.annotations.Download;
  29 import com.arialyy.annotations.M3U8;
  30 import com.arialyy.aria.core.Aria;
  31 import com.arialyy.aria.core.common.controller.ControllerType;
  32 import com.arialyy.aria.core.common.controller.StartController;
  33 import com.arialyy.aria.core.download.DownloadEntity;
  34 import com.arialyy.aria.core.download.DownloadTask;
  35 import com.arialyy.aria.core.download.m3u8.IBandWidthUrlConverter;
  36 import com.arialyy.aria.core.download.m3u8.ITsMergeHandler;
  37 import com.arialyy.aria.core.download.m3u8.IVodTsUrlConverter;
  38 import com.arialyy.aria.core.download.m3u8.M3U8KeyInfo;
  39 import com.arialyy.aria.core.inf.IEntity;
  40 import com.arialyy.aria.util.ALog;
  41 import com.arialyy.aria.util.CommonUtil;
  42 import com.arialyy.frame.util.show.T;
  43 import com.arialyy.simple.R;
  44 import com.arialyy.simple.base.BaseActivity;
  45 import com.arialyy.simple.common.ModifyPathDialog;
  46 import com.arialyy.simple.common.ModifyUrlDialog;
  47 import com.arialyy.simple.databinding.ActivityM3u8VodBinding;
  48 import com.arialyy.simple.to.PeerIndex;
  49 import com.arialyy.simple.util.AppUtil;
  50 import java.io.File;
  51 import java.util.ArrayList;
  52 import java.util.List;
  53 import org.greenrobot.eventbus.EventBus;
  54 import org.greenrobot.eventbus.Subscribe;
  55 import org.greenrobot.eventbus.ThreadMode;
  56 
  57 
  58 public class M3U8VodDLoadActivity extends BaseActivity&lt;ActivityM3u8VodBinding&gt; {
  59   private String mUrl;
  60 
  61   private String mFilePath;
  62 
  63   private M3U8VodModule mModule;
  64 
  65   private VideoPlayerFragment mVideoFragment;
  66 
  67   private DownloadEntity mEntity;
  68 
  69   @Override
  70   protected void init(Bundle savedInstanceState) {
  71     super.init(savedInstanceState);
  72     setTitle(getString(R.string.m3u8_file));
  73     Aria.download(this).register();
  74     mModule = ViewModelProviders.of(this).get(M3U8VodModule.class);
  75     mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  76       @Override
  77       public void onChanged(@Nullable
  78       DownloadEntity entity) {
  79         if (entity == null) {
  80           return;
  81         }
  82         mEntity = entity;
  83         if (mEntity.getState() == IEntity.STATE_STOP) {
  84           getBinding().setStateStr(getString(R.string.resume));
  85         } else if (mEntity.getState() == IEntity.STATE_RUNNING) {
  86           getBinding().setStateStr(getString(R.string.stop));
  87         }
  88         if (entity.getFileSize() != 0) {
  89           getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
  90         }
  91         getBinding().setProgress(entity.getPercent());
  92         getBinding().setUrl(entity.getUrl());
  93         getBinding().setFilePath(entity.getFilePath());
  94         mUrl = entity.getUrl();
  95         mFilePath = entity.getFilePath();
  96         mVideoFragment = new VideoPlayerFragment(0, entity);
  97         FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
  98         ft.add(R.id.video_content, mVideoFragment);
  99         ft.commit();
 100       }
 101     });
 102     getBinding().setViewModel(this);
 103   }
 104 
 105   public void chooseUrl() {
 106     ModifyUrlDialog dialog =
 107         new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 108     dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 109   }
 110 
 111   public void chooseFilePath() {
 112     ModifyPathDialog dialog =
 113         new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 114     dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 115   }
 116 
 117   @Override protected void onStart() {
 118     super.onStart();
 119     EventBus.getDefault().register(this);
 120   }
 121 
 122   @Override protected void onStop() {
 123     super.onStop();
 124     EventBus.getDefault().unregister(this);
 125   }
 126 
 127   @Subscribe(threadMode = ThreadMode.MAIN)
 128   public void jumpIndex(PeerIndex index) {
 129     Aria.download(this).load(mUrl).asM3U8().asVod().jumPeerIndex(index.index);
 130   }
 131 
 132   @Override
 133   public boolean onCreateOptionsMenu(Menu menu) {
 134     getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 135     return super.onCreateOptionsMenu(menu);
 136   }
 137 
 138   @Override
 139   public boolean onMenuItemClick(MenuItem item) {
 140     int speed = -1;
 141     String msg = &quot;&quot;;
 142     switch (item.getItemId()) {
 143       case R.id.help:
 144         msg = &quot;一些小知识点：\n&quot;
 145             + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 146             + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 147             + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 148         showMsgDialog(&quot;tip&quot;, msg);
 149         break;
 150       case R.id.speed_0:
 151         speed = 0;
 152         break;
 153       case R.id.speed_128:
 154         speed = 128;
 155         break;
 156       case R.id.speed_256:
 157         speed = 256;
 158         break;
 159       case R.id.speed_512:
 160         speed = 512;
 161         break;
 162       case R.id.speed_1m:
 163         speed = 1024;
 164         break;
 165     }
 166     if (speed &gt; -1) {
 167       msg = item.getTitle().toString();
 168       Aria.download(this).setMaxSpeed(speed);
 169       T.showShort(this, msg);
 170     }
 171     return true;
 172   }
 173 
 174   @M3U8.onPeerStart
 175   void onPeerStart(String m3u8Url, String peerPath, int peerIndex) {
 176     //ALog.d(TAG, &quot;peer start, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 177   }
 178 
 179   @M3U8.onPeerComplete
 180   void onPeerComplete(String m3u8Url, String peerPath, int peerIndex) {
 181     //ALog.d(TAG, &quot;peer complete, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 182     mVideoFragment.addPlayer(peerIndex, peerPath);
 183   }
 184 
 185   @M3U8.onPeerFail
 186   void onPeerFail(String m3u8Url, String peerPath, int peerIndex) {
 187     //ALog.d(TAG, &quot;peer fail, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 188   }
 189 
 190   @Download.onWait
 191   void onWait(DownloadTask task) {
 192     if (task.getKey().equals(mUrl)) {
 193       Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 194     }
 195   }
 196 
 197   @Download.onPre
 198   protected void onPre(DownloadTask task) {
 199     if (task.getKey().equals(mUrl)) {
 200       getBinding().setStateStr(getString(R.string.stop));
 201     }
 202   }
 203 
 204   @Download.onTaskStart
 205   void taskStart(DownloadTask task) {
 206     if (task.getKey().equals(mUrl)) {
 207       getBinding().setFileSize(task.getConvertFileSize());
 208       ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 209     }
 210   }
 211 
 212   @Download.onTaskRunning
 213   protected void running(DownloadTask task) {
 214     if (task.getKey().equals(mUrl)) {
 215       //ALog.d(TAG, &quot;isRunning&quot;);
 216       getBinding().setProgress(task.getPercent());
 217       getBinding().setSpeed(task.getConvertSpeed());
 218     }
 219   }
 220 
 221   @Download.onTaskResume
 222   void taskResume(DownloadTask task) {
 223     if (task.getKey().equals(mUrl)) {
 224       getBinding().setStateStr(getString(R.string.stop));
 225     }
 226   }
 227 
 228   @Download.onTaskStop
 229   void taskStop(DownloadTask task) {
 230     if (task.getKey().equals(mUrl)) {
 231       getBinding().setStateStr(getString(R.string.resume));
 232       getBinding().setSpeed(&quot;&quot;);
 233     }
 234   }
 235 
 236   @Download.onTaskCancel
 237   void taskCancel(DownloadTask task) {
 238     if (task.getKey().equals(mUrl)) {
 239       getBinding().setProgress(0);
 240       getBinding().setStateStr(getString(R.string.start));
 241       getBinding().setSpeed(&quot;&quot;);
 242       Log.d(TAG, &quot;cancel&quot;);
 243     }
 244   }
 245 
 246   @Download.onTaskFail
 247   void taskFail(DownloadTask task, Exception e) {
 248     if (task.getKey().equals(mUrl)) {
 249       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_fail),
 250           Toast.LENGTH_SHORT)
 251           .show();
 252       getBinding().setStateStr(getString(R.string.start));
 253       getBinding().setSpeed(&quot;&quot;);
 254       Log.d(TAG, &quot;fail&quot;);
 255     }
 256   }
 257 
 258   @Download.onTaskComplete
 259   void taskComplete(DownloadTask task) {
 260     if (task.getKey().equals(mUrl)) {
 261       getBinding().setProgress(100);
 262       Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_success),
 263           Toast.LENGTH_SHORT).show();
 264       getBinding().setStateStr(getString(R.string.re_start));
 265       getBinding().setSpeed(&quot;&quot;);
 266       ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));
 267     }
 268   }
 269 
 270   @Override
 271   protected int setLayoutId() {
 272     return R.layout.activity_m3u8_vod;
 273   }
 274 
 275   public void onClick(View view) {
 276     switch (view.getId()) {
 277       case R.id.start :
 278         if (!AppUtil.chekEntityValid(mEntity)) {
 279           startD();
 280           break;
 281         }
 282         if (Aria.download(this).load(mEntity.getId()).isRunning()) {
 283           Aria.download(this).load(mEntity.getId()).stop();
 284         } else {
 285           Aria.download(this).load(mEntity.getId()).resume();
 286         }
 287         break;
 288       case R.id.cancel :
 289         if (AppUtil.chekEntityValid(mEntity)) {
 290           Aria.download(this).load(mEntity.getId()).cancel(true);
 291         }
 292         break;
 293     }
 294   }
 295 
 296   private void startD() {
 297         //.asVod().setPeerIndex(50)
<abbr title=" 298     Aria.download(this).load(mUrl).useServerFileName(true).setFilePath(mFilePath, true).asM3U8().setBandWidthUrlConverter(new IBandWidthUrlConverter() {"> 298     Aria.download(this).load(mUrl).useServerFileName(true).setFilePath(mFilePath, true).asM3U8().setBandW🔵</abbr>
 299       @Override
 300       public String convert(String bandWidthUrl) {
 301         int index = mUrl.lastIndexOf(&quot;/&quot;);
 302         return mUrl.substring(0, index + 1) + bandWidthUrl;
 303       }
 304     }).setTsUrlConvert(new IVodTsUrlConverter() {
 305       @Override
 306       public List&lt;String&gt; convert(String m3u8Url, List&lt;String&gt; tsUrls) {
 307         int index = m3u8Url.lastIndexOf(&quot;/&quot;);
 308         String parentUrl = m3u8Url.substring(0, index + 1);
 309         List&lt;String&gt; newUrls = new ArrayList&lt;&gt;();
 310         for (String url : tsUrls) {
 311           newUrls.add(parentUrl + url);
 312         }
 313         return newUrls;
 314       }
 315     }).setMergeHandler(new ITsMergeHandler() {
 316       @Override
 317       public boolean merge(@Nullable
 318       M3U8KeyInfo keyInfo, List&lt;String&gt; tsPath) {
 319         ALog.d(TAG, &quot;合并TS....&quot;);
 320         return false;
 321       }
 322     }).
 323 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324 controller</span>
 325 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 326 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 326 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 327 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 merge</span>
 330 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 331     (
 332 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333 ControllerType.START_CONTROLLER</span>
 334 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 335 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 335 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 336 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 true</span>
 339 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 340     ).start();
 341     //.start();
 342     //.asVod().setPeerIndex(50)
 343     //.start();
 344   }
 345 
 346   private Class&lt;StartController&gt; c = StartController.class;
 347 
 348   @Override protected void dataCallback(int result, Object data) {
 349     super.dataCallback(result, data);
 350     if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 351       mModule.uploadUrl(this, String.valueOf(data));
 352     } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 353       mModule.updateFilePath(this, String.valueOf(data));
 354     }
 355   }
 356 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.simple.core.download.m3u8;
  18  
  19  import android.arch.lifecycle.Observer;
  20  import android.arch.lifecycle.ViewModelProviders;
  21  import android.os.Bundle;
  22  import android.support.annotation.Nullable;
  23  import android.support.v4.app.FragmentTransaction;
  24  import android.util.Log;
  25  import android.view.Menu;
  26  import android.view.MenuItem;
  27  import android.view.View;
  28  import android.widget.Toast;
  29  import com.arialyy.annotations.Download;
  30  import com.arialyy.annotations.M3U8;
  31  import com.arialyy.aria.core.Aria;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.arialyy.aria.core.common.controller.ControllerType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.arialyy.aria.core.common.controller.StartController;</span>
  34  import com.arialyy.aria.core.download.DownloadEntity;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.arialyy.aria.core.download.DownloadTarget;</span>
  36  import com.arialyy.aria.core.download.DownloadTask;
  37  import com.arialyy.aria.core.download.m3u8.IBandWidthUrlConverter;
  38  import com.arialyy.aria.core.download.m3u8.ITsMergeHandler;
  39  import com.arialyy.aria.core.download.m3u8.IVodTsUrlConverter;
  40  import com.arialyy.aria.core.download.m3u8.M3U8KeyInfo;
  41  import com.arialyy.aria.core.inf.IEntity;
  42  import com.arialyy.aria.util.ALog;
  43  import com.arialyy.aria.util.CommonUtil;
  44  import com.arialyy.frame.util.show.T;
  45  import com.arialyy.simple.R;
  46  import com.arialyy.simple.base.BaseActivity;
  47  import com.arialyy.simple.common.ModifyPathDialog;
  48  import com.arialyy.simple.common.ModifyUrlDialog;
  49  import com.arialyy.simple.databinding.ActivityM3u8VodBinding;
  50  import com.arialyy.simple.to.PeerIndex;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import com.arialyy.simple.util.AppUtil;</span>
  52  import java.io.File;
  53  import java.util.ArrayList;
  54  import java.util.List;
  55  import org.greenrobot.eventbus.EventBus;
  56  import org.greenrobot.eventbus.Subscribe;
  57  import org.greenrobot.eventbus.ThreadMode;
  58  
  59  public class M3U8VodDLoadActivity extends BaseActivity&lt;ActivityM3u8VodBinding&gt; {
  60  
  61    private String mUrl;
  62    private String mFilePath;
  63    private M3U8VodModule mModule;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -  private DownloadTarget mTarget;</span>
  65    private VideoPlayerFragment mVideoFragment;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +  private DownloadEntity mEntity;</span>
  67  
  68    @Override
  69    protected void init(Bundle savedInstanceState) {
  70      super.init(savedInstanceState);
  71      setTitle(getString(R.string.m3u8_file));
  72      Aria.download(this).register();
  73      mModule = ViewModelProviders.of(this).get(M3U8VodModule.class);
  74      mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  75  
  76        @Override public void onChanged(@Nullable DownloadEntity entity) {
  77          if (entity == null) {
  78            return;
  79          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        mTarget = Aria.download(M3U8VodDLoadActivity.this).load(entity.getUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        if (mTarget.getTaskState() == IEntity.STATE_STOP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +        mEntity = entity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        if (mEntity.getState() == IEntity.STATE_STOP) {</span>
  84            getBinding().setStateStr(getString(R.string.resume));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -        } else if (mTarget.isRunning()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        } else if (mEntity.getState() == IEntity.STATE_RUNNING) {</span>
  87            getBinding().setStateStr(getString(R.string.stop));
  88          }
  89  
  90          if (entity.getFileSize() != 0) {
  91            getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
  92          }
  93          getBinding().setProgress(entity.getPercent());
  94          getBinding().setUrl(entity.getUrl());
  95          getBinding().setFilePath(entity.getFilePath());
  96          mUrl = entity.getUrl();
  97          mFilePath = entity.getFilePath();
  98          mVideoFragment = new VideoPlayerFragment(0, entity);
  99          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
 100          ft.add(R.id.video_content, mVideoFragment);
 101          ft.commit();
 102        }
 103      });
 104      getBinding().setViewModel(this);
 105    }
 106  
 107    public void chooseUrl() {
 108      ModifyUrlDialog dialog =
 109          new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 110      dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 111    }
 112  
 113    public void chooseFilePath() {
 114      ModifyPathDialog dialog =
 115          new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 116      dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 117    }
 118  
 119    @Override protected void onStart() {
 120      super.onStart();
 121      EventBus.getDefault().register(this);
 122    }
 123  
 124    @Override protected void onStop() {
 125      super.onStop();
 126      EventBus.getDefault().unregister(this);
 127    }
 128  
 129    @Subscribe(threadMode = ThreadMode.MAIN)
 130    public void jumpIndex(PeerIndex index) {
 131      Aria.download(this).load(mUrl).asM3U8().asVod().jumPeerIndex(index.index);
 132    }
 133  
 134    @Override
 135    public boolean onCreateOptionsMenu(Menu menu) {
 136      getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 137      return super.onCreateOptionsMenu(menu);
 138    }
 139  
 140    @Override
 141    public boolean onMenuItemClick(MenuItem item) {
 142      int speed = -1;
 143      String msg = &quot;&quot;;
 144      switch (item.getItemId()) {
 145        case R.id.help:
 146          msg = &quot;一些小知识点：\n&quot;
 147              + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 148              + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 149              + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 150          showMsgDialog(&quot;tip&quot;, msg);
 151          break;
 152        case R.id.speed_0:
 153          speed = 0;
 154          break;
 155        case R.id.speed_128:
 156          speed = 128;
 157          break;
 158        case R.id.speed_256:
 159          speed = 256;
 160          break;
 161        case R.id.speed_512:
 162          speed = 512;
 163          break;
 164        case R.id.speed_1m:
 165          speed = 1024;
 166          break;
 167      }
 168      if (speed &gt; -1) {
 169        msg = item.getTitle().toString();
 170        Aria.download(this).setMaxSpeed(speed);
 171        T.showShort(this, msg);
 172      }
 173      return true;
 174    }
 175  
 176    @M3U8.onPeerStart
 177    void onPeerStart(String m3u8Url, String peerPath, int peerIndex) {
 178      //ALog.d(TAG, &quot;peer start, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 179    }
 180  
 181    @M3U8.onPeerComplete
 182    void onPeerComplete(String m3u8Url, String peerPath, int peerIndex) {
 183      //ALog.d(TAG, &quot;peer complete, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 184      mVideoFragment.addPlayer(peerIndex, peerPath);
 185    }
 186  
 187    @M3U8.onPeerFail
 188    void onPeerFail(String m3u8Url, String peerPath, int peerIndex) {
 189      //ALog.d(TAG, &quot;peer fail, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 190    }
 191  
 192    @Download.onWait
 193    void onWait(DownloadTask task) {
 194      if (task.getKey().equals(mUrl)) {
 195        Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 196      }
 197    }
 198  
 199    @Download.onPre
 200    protected void onPre(DownloadTask task) {
 201      if (task.getKey().equals(mUrl)) {
 202        getBinding().setStateStr(getString(R.string.stop));
 203      }
 204    }
 205  
 206    @Download.onTaskStart
 207    void taskStart(DownloadTask task) {
 208      if (task.getKey().equals(mUrl)) {
 209        getBinding().setFileSize(task.getConvertFileSize());
 210        ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 211      }
 212    }
 213  
 214    @Download.onTaskRunning
 215    protected void running(DownloadTask task) {
 216      if (task.getKey().equals(mUrl)) {
 217        //ALog.d(TAG, &quot;isRunning&quot;);
 218        getBinding().setProgress(task.getPercent());
 219        getBinding().setSpeed(task.getConvertSpeed());
 220      }
 221    }
 222  
 223    @Download.onTaskResume
 224    void taskResume(DownloadTask task) {
 225      if (task.getKey().equals(mUrl)) {
 226        getBinding().setStateStr(getString(R.string.stop));
 227      }
 228    }
 229  
 230    @Download.onTaskStop
 231    void taskStop(DownloadTask task) {
 232      if (task.getKey().equals(mUrl)) {
 233        getBinding().setStateStr(getString(R.string.resume));
 234        getBinding().setSpeed(&quot;&quot;);
 235      }
 236    }
 237  
 238    @Download.onTaskCancel
 239    void taskCancel(DownloadTask task) {
 240      if (task.getKey().equals(mUrl)) {
 241        getBinding().setProgress(0);
 242        getBinding().setStateStr(getString(R.string.start));
 243        getBinding().setSpeed(&quot;&quot;);
 244        Log.d(TAG, &quot;cancel&quot;);
 245      }
 246    }
 247  
 248    @Download.onTaskFail
 249    void taskFail(DownloadTask task, Exception e) {
 250      if (task.getKey().equals(mUrl)) {
 251        Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_fail),
 252            Toast.LENGTH_SHORT)
 253            .show();
 254        getBinding().setStateStr(getString(R.string.start));
 255        getBinding().setSpeed(&quot;&quot;);
 256        Log.d(TAG, &quot;fail&quot;);
 257      }
 258    }
 259  
 260    @Download.onTaskComplete
 261    void taskComplete(DownloadTask task) {
 262      if (task.getKey().equals(mUrl)) {
 263        getBinding().setProgress(100);
 264        Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_success),
 265            Toast.LENGTH_SHORT).show();
 266        getBinding().setStateStr(getString(R.string.re_start));
 267        getBinding().setSpeed(&quot;&quot;);
 268        ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));
 269      }
 270    }
 271  
 272    @Override
 273    protected int setLayoutId() {
 274      return R.layout.activity_m3u8_vod;
 275    }
 276  
 277    public void onClick(View view) {
 278      switch (view.getId()) {
 279        case R.id.start:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        ALog.d(TAG, &quot;isRunning = &quot; + mTarget.isRunning());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        if (mTarget.isRunning()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -          Aria.download(this).load(mUrl).stop();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        if (!AppUtil.chekEntityValid(mEntity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +          startD();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +          break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +        if (Aria.download(this).load(mEntity.getId()).isRunning()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +          Aria.download(this).load(mEntity.getId()).stop();</span>
 289          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -          startD();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +          Aria.download(this).load(mEntity.getId()).resume();</span>
 292          }
 293          break;
 294        case R.id.cancel:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        Aria.download(this).load(mUrl).cancel(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +        if (AppUtil.chekEntityValid(mEntity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +          Aria.download(this).load(mEntity.getId()).cancel(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +        }</span>
 299          break;
 300      }
 301    }
 302  
 303    private void startD() {
 304      Aria.download(M3U8VodDLoadActivity.this)
 305          .load(mUrl)
 306          .useServerFileName(true)
 307          .setFilePath(mFilePath, true)
 308          .asM3U8()
 309          .setBandWidthUrlConverter(new IBandWidthUrlConverter() {
 310            @Override public String convert(String bandWidthUrl) {
 311              int index = mUrl.lastIndexOf(&quot;/&quot;);
 312              return mUrl.substring(0, index + 1) + bandWidthUrl;
 313            }
 314          })
 315          .setTsUrlConvert(new IVodTsUrlConverter() {
 316            @Override public List&lt;String&gt; convert(String m3u8Url, List&lt;String&gt; tsUrls) {
 317              int index = m3u8Url.lastIndexOf(&quot;/&quot;);
 318              String parentUrl = m3u8Url.substring(0, index + 1);
 319              List&lt;String&gt; newUrls = new ArrayList&lt;&gt;();
 320              for (String url : tsUrls) {
 321                newUrls.add(parentUrl + url);
 322              }
 323  
 324              return newUrls;
 325            }
 326          })
 327          .setMergeHandler(new ITsMergeHandler() {
 328            @Override public boolean merge(@Nullable M3U8KeyInfo keyInfo, List&lt;String&gt; tsPath) {

 329              return false;
 330            }
 331          })

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -        //.asVod().setPeerIndex(50)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +        .controller(ControllerType.START_CONTROLLER)</span>
 334          .start();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +    //.start();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +    //.asVod().setPeerIndex(50)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +    //.start();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +  private Class&lt;StartController&gt; c = StartController.class;</span>
 342  
 343    @Override protected void dataCallback(int result, Object data) {
 344      super.dataCallback(result, data);
 345      if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 346        mModule.uploadUrl(this, String.valueOf(data));
 347      } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 348        mModule.updateFilePath(this, String.valueOf(data));
 349      }
 350    }
 351  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.simple.core.download.m3u8;
  18  
  19  import android.arch.lifecycle.Observer;
  20  import android.arch.lifecycle.ViewModelProviders;
  21  import android.os.Bundle;
  22  import android.support.annotation.Nullable;
  23  import android.support.v4.app.FragmentTransaction;
  24  import android.util.Log;
  25  import android.view.Menu;
  26  import android.view.MenuItem;
  27  import android.view.View;
  28  import android.widget.Toast;
  29  import com.arialyy.annotations.Download;
  30  import com.arialyy.annotations.M3U8;
  31  import com.arialyy.aria.core.Aria;


  32  import com.arialyy.aria.core.download.DownloadEntity;
  33  import com.arialyy.aria.core.download.DownloadTarget;
  34  import com.arialyy.aria.core.download.DownloadTask;
  35  import com.arialyy.aria.core.download.m3u8.IBandWidthUrlConverter;
  36  import com.arialyy.aria.core.download.m3u8.ITsMergeHandler;
  37  import com.arialyy.aria.core.download.m3u8.IVodTsUrlConverter;
  38  import com.arialyy.aria.core.download.m3u8.M3U8KeyInfo;
  39  import com.arialyy.aria.core.inf.IEntity;
  40  import com.arialyy.aria.util.ALog;
  41  import com.arialyy.aria.util.CommonUtil;
  42  import com.arialyy.frame.util.show.T;
  43  import com.arialyy.simple.R;
  44  import com.arialyy.simple.base.BaseActivity;
  45  import com.arialyy.simple.common.ModifyPathDialog;
  46  import com.arialyy.simple.common.ModifyUrlDialog;
  47  import com.arialyy.simple.databinding.ActivityM3u8VodBinding;
  48  import com.arialyy.simple.to.PeerIndex;

  49  import java.io.File;
  50  import java.util.ArrayList;
  51  import java.util.List;
  52  import org.greenrobot.eventbus.EventBus;
  53  import org.greenrobot.eventbus.Subscribe;
  54  import org.greenrobot.eventbus.ThreadMode;
  55  
  56  public class M3U8VodDLoadActivity extends BaseActivity&lt;ActivityM3u8VodBinding&gt; {
  57  
  58    private String mUrl;
  59    private String mFilePath;
  60    private M3U8VodModule mModule;
  61    private DownloadTarget mTarget;
  62    private VideoPlayerFragment mVideoFragment;

  63  
  64    @Override
  65    protected void init(Bundle savedInstanceState) {
  66      super.init(savedInstanceState);
  67      setTitle(getString(R.string.m3u8_file));
  68      Aria.download(this).register();
  69      mModule = ViewModelProviders.of(this).get(M3U8VodModule.class);
  70      mModule.getHttpDownloadInfo(this).observe(this, new Observer&lt;DownloadEntity&gt;() {
  71  
  72        @Override public void onChanged(@Nullable DownloadEntity entity) {
  73          if (entity == null) {
  74            return;
  75          }
  76          mTarget = Aria.download(M3U8VodDLoadActivity.this).load(entity.getUrl());
  77          if (mTarget.getTaskState() == IEntity.STATE_STOP) {


  78            getBinding().setStateStr(getString(R.string.resume));
  79          } else if (mTarget.isRunning()) {

  80            getBinding().setStateStr(getString(R.string.stop));
  81          }
  82  
  83          if (entity.getFileSize() != 0) {
  84            getBinding().setFileSize(CommonUtil.formatFileSize(entity.getFileSize()));
  85          }
  86          getBinding().setProgress(entity.getPercent());
  87          getBinding().setUrl(entity.getUrl());
  88          getBinding().setFilePath(entity.getFilePath());
  89          mUrl = entity.getUrl();
  90          mFilePath = entity.getFilePath();
  91          mVideoFragment = new VideoPlayerFragment(0, entity);
  92          FragmentTransaction ft = getSupportFragmentManager().beginTransaction();
  93          ft.add(R.id.video_content, mVideoFragment);
  94          ft.commit();
  95        }
  96      });
  97      getBinding().setViewModel(this);
  98    }
  99  
 100    public void chooseUrl() {
 101      ModifyUrlDialog dialog =
 102          new ModifyUrlDialog(this, getString(R.string.modify_url_dialog_title), mUrl);
 103      dialog.show(getSupportFragmentManager(), &quot;ModifyUrlDialog&quot;);
 104    }
 105  
 106    public void chooseFilePath() {
 107      ModifyPathDialog dialog =
 108          new ModifyPathDialog(this, getString(R.string.modify_file_path), mFilePath);
 109      dialog.show(getSupportFragmentManager(), &quot;ModifyPathDialog&quot;);
 110    }
 111  
 112    @Override protected void onStart() {
 113      super.onStart();
 114      EventBus.getDefault().register(this);
 115    }
 116  
 117    @Override protected void onStop() {
 118      super.onStop();
 119      EventBus.getDefault().unregister(this);
 120    }
 121  
 122    @Subscribe(threadMode = ThreadMode.MAIN)
 123    public void jumpIndex(PeerIndex index) {
 124      Aria.download(this).load(mUrl).asM3U8().asVod().jumPeerIndex(index.index);
 125    }
 126  
 127    @Override
 128    public boolean onCreateOptionsMenu(Menu menu) {
 129      getMenuInflater().inflate(R.menu.menu_single_task_activity, menu);
 130      return super.onCreateOptionsMenu(menu);
 131    }
 132  
 133    @Override
 134    public boolean onMenuItemClick(MenuItem item) {
 135      int speed = -1;
 136      String msg = &quot;&quot;;
 137      switch (item.getItemId()) {
 138        case R.id.help:
 139          msg = &quot;一些小知识点：\n&quot;
 140              + &quot;1、你可以在注解中增加链接，用于指定被注解的方法只能被特定的下载任务回调，以防止progress乱跳\n&quot;
 141              + &quot;2、当遇到网络慢的情况时，你可以先使用onPre()更新UI界面，待连接成功时，再在onTaskPre()获取完整的task数据，然后给UI界面设置正确的数据\n&quot;
 142              + &quot;3、你可以在界面初始化时通过Aria.download(this).load(URL).getPercent()等方法快速获取相关任务的一些数据&quot;;
 143          showMsgDialog(&quot;tip&quot;, msg);
 144          break;
 145        case R.id.speed_0:
 146          speed = 0;
 147          break;
 148        case R.id.speed_128:
 149          speed = 128;
 150          break;
 151        case R.id.speed_256:
 152          speed = 256;
 153          break;
 154        case R.id.speed_512:
 155          speed = 512;
 156          break;
 157        case R.id.speed_1m:
 158          speed = 1024;
 159          break;
 160      }
 161      if (speed &gt; -1) {
 162        msg = item.getTitle().toString();
 163        Aria.download(this).setMaxSpeed(speed);
 164        T.showShort(this, msg);
 165      }
 166      return true;
 167    }
 168  
 169    @M3U8.onPeerStart
 170    void onPeerStart(String m3u8Url, String peerPath, int peerIndex) {
 171      //ALog.d(TAG, &quot;peer start, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 172    }
 173  
 174    @M3U8.onPeerComplete
 175    void onPeerComplete(String m3u8Url, String peerPath, int peerIndex) {
 176      //ALog.d(TAG, &quot;peer complete, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 177      mVideoFragment.addPlayer(peerIndex, peerPath);
 178    }
 179  
 180    @M3U8.onPeerFail
 181    void onPeerFail(String m3u8Url, String peerPath, int peerIndex) {
 182      //ALog.d(TAG, &quot;peer fail, path: &quot; + peerPath + &quot;, index: &quot; + peerIndex);
 183    }
 184  
 185    @Download.onWait
 186    void onWait(DownloadTask task) {
 187      if (task.getKey().equals(mUrl)) {
 188        Log.d(TAG, &quot;wait ==&gt; &quot; + task.getDownloadEntity().getFileName());
 189      }
 190    }
 191  
 192    @Download.onPre
 193    protected void onPre(DownloadTask task) {
 194      if (task.getKey().equals(mUrl)) {
 195        getBinding().setStateStr(getString(R.string.stop));
 196      }
 197    }
 198  
 199    @Download.onTaskStart
 200    void taskStart(DownloadTask task) {
 201      if (task.getKey().equals(mUrl)) {
 202        getBinding().setFileSize(task.getConvertFileSize());
 203        ALog.d(TAG, &quot;isComplete = &quot; + task.isComplete() + &quot;, state = &quot; + task.getState());
 204      }
 205    }
 206  
 207    @Download.onTaskRunning
 208    protected void running(DownloadTask task) {
 209      if (task.getKey().equals(mUrl)) {
 210        //ALog.d(TAG, &quot;isRunning&quot;);
 211        getBinding().setProgress(task.getPercent());
 212        getBinding().setSpeed(task.getConvertSpeed());
 213      }
 214    }
 215  
 216    @Download.onTaskResume
 217    void taskResume(DownloadTask task) {
 218      if (task.getKey().equals(mUrl)) {
 219        getBinding().setStateStr(getString(R.string.stop));
 220      }
 221    }
 222  
 223    @Download.onTaskStop
 224    void taskStop(DownloadTask task) {
 225      if (task.getKey().equals(mUrl)) {
 226        getBinding().setStateStr(getString(R.string.resume));
 227        getBinding().setSpeed(&quot;&quot;);
 228      }
 229    }
 230  
 231    @Download.onTaskCancel
 232    void taskCancel(DownloadTask task) {
 233      if (task.getKey().equals(mUrl)) {
 234        getBinding().setProgress(0);
 235        getBinding().setStateStr(getString(R.string.start));
 236        getBinding().setSpeed(&quot;&quot;);
 237        Log.d(TAG, &quot;cancel&quot;);
 238      }
 239    }
 240  
 241    @Download.onTaskFail
 242    void taskFail(DownloadTask task, Exception e) {
 243      if (task.getKey().equals(mUrl)) {
 244        Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_fail),
 245            Toast.LENGTH_SHORT)
 246            .show();
 247        getBinding().setStateStr(getString(R.string.start));
 248        getBinding().setSpeed(&quot;&quot;);
 249        Log.d(TAG, &quot;fail&quot;);
 250      }
 251    }
 252  
 253    @Download.onTaskComplete
 254    void taskComplete(DownloadTask task) {
 255      if (task.getKey().equals(mUrl)) {
 256        getBinding().setProgress(100);
 257        Toast.makeText(M3U8VodDLoadActivity.this, getString(R.string.download_success),
 258            Toast.LENGTH_SHORT).show();
 259        getBinding().setStateStr(getString(R.string.re_start));
 260        getBinding().setSpeed(&quot;&quot;);
 261        ALog.d(TAG, &quot;md5: &quot; + CommonUtil.getFileMD5(new File(task.getDownloadPath())));
 262      }
 263    }
 264  
 265    @Override
 266    protected int setLayoutId() {
 267      return R.layout.activity_m3u8_vod;
 268    }
 269  
 270    public void onClick(View view) {
 271      switch (view.getId()) {
 272        case R.id.start:
 273          ALog.d(TAG, &quot;isRunning = &quot; + mTarget.isRunning());
 274          if (mTarget.isRunning()) {
 275            Aria.download(this).load(mUrl).stop();






 276          } else {
 277            startD();

 278          }
 279          break;
 280        case R.id.cancel:
 281          Aria.download(this).load(mUrl).cancel(true);



 282          break;
 283      }
 284    }
 285  
 286    private void startD() {
 287      Aria.download(M3U8VodDLoadActivity.this)
 288          .load(mUrl)
 289          .useServerFileName(true)
 290          .setFilePath(mFilePath, true)
 291          .asM3U8()
 292          .setBandWidthUrlConverter(new IBandWidthUrlConverter() {
 293            @Override public String convert(String bandWidthUrl) {
 294              int index = mUrl.lastIndexOf(&quot;/&quot;);
 295              return mUrl.substring(0, index + 1) + bandWidthUrl;
 296            }
 297          })
 298          .setTsUrlConvert(new IVodTsUrlConverter() {
 299            @Override public List&lt;String&gt; convert(String m3u8Url, List&lt;String&gt; tsUrls) {
 300              int index = m3u8Url.lastIndexOf(&quot;/&quot;);
 301              String parentUrl = m3u8Url.substring(0, index + 1);
 302              List&lt;String&gt; newUrls = new ArrayList&lt;&gt;();
 303              for (String url : tsUrls) {
 304                newUrls.add(parentUrl + url);
 305              }
 306  
 307              return newUrls;
 308            }
 309          })
 310          .setMergeHandler(new ITsMergeHandler() {
 311            @Override public boolean merge(@Nullable M3U8KeyInfo keyInfo, List&lt;String&gt; tsPath) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +            ALog.d(TAG, &quot;合并TS....&quot;);</span>
 313              return false;
 314            }
 315          })
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        .merge(true)</span>
 317          //.asVod().setPeerIndex(50)

 318          .start();
 319    }






 320  
 321    @Override protected void dataCallback(int result, Object data) {
 322      super.dataCallback(result, data);
 323      if (result == ModifyUrlDialog.MODIFY_URL_DIALOG_RESULT) {
 324        mModule.uploadUrl(this, String.valueOf(data));
 325      } else if (result == ModifyPathDialog.MODIFY_PATH_RESULT) {
 326        mModule.updateFilePath(this, String.valueOf(data));
 327      }
 328    }
 329  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            