<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>439</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    439
                    <a href="438.html">prev</a>
                    <a href="440.html">next</a>
                    <a href="439_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_5553ee5c6410a412ab4ed61d9499805adee8995a_hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a^1:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;5553ee5c6410a412ab4ed61d9499805adee8995a^2:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e0a10435dcb243a911c0405daebc6aa667d5119d:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19  
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  27 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  28 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  31 import com.dtstack.flink.sql.factory.DTThreadFactory;
  32 import com.dtstack.flink.sql.side.hbase.utils.HbaseConfigUtils;
  33 import com.stumbleupon.async.Deferred;
  34 import org.apache.flink.api.java.tuple.Tuple2;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.configuration.Configuration;
  38 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  39 import org.apache.flink.table.dataformat.BaseRow;
  40 import org.apache.flink.types.Row;
  41 import org.apache.hadoop.security.authentication.util.KerberosName;
  42 import org.hbase.async.Config;
  43 import org.hbase.async.HBaseClient;
  44 import org.slf4j.Logger;
  45 import org.slf4j.LoggerFactory;
  46 import sun.security.krb5.KrbException;
  47 
  48 import java.sql.Timestamp;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.TimeZone;
  52 import java.util.concurrent.ExecutorService;
  53 import java.util.concurrent.LinkedBlockingQueue;
  54 import java.util.concurrent.ThreadPoolExecutor;
  55 import java.util.concurrent.TimeUnit;
  56 
  57 /**
  58  * Date: 2018/8/21
  59  * Company: www.dtstack.com
  60  * @author xuchao
  61  */
  62 
  63 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  64 
  65     private static final long serialVersionUID = 2098635104857937717L;
  66 
  67     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  68 
  69     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  70 
  71     //match to the rule of netty3
  72     private static final int DEFAULT_BOSS_THREADS = 1;
  73 
  74     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  75 
  76     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  77 
  78     private transient HBaseClient hBaseClient;
  79 
  80     private transient AbstractRowKeyModeDealer rowKeyMode;
  81 
  82     private String tableName;
  83 
  84     private String[] colNames;
  85 
<abbr title="  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  87         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  88 
  89         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  90         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  91     }
  92 
  93 
  94     @Override
  95     public void open(Configuration parameters) throws Exception {
  96         super.open(parameters);
  97         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  98         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  99         Map&lt;String, Object&gt; hbaseConfig = hbaseSideTableInfo.getHbaseConfig();
 100 
 101         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 102                 0L, TimeUnit.MILLISECONDS,
 103                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 104 
 105         Config config = new Config();
 106         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, hbaseSideTableInfo.getHost());
<abbr title=" 107         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getParent());"> 107         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getPaüîµ</abbr>
 108         HbaseConfigUtils.loadKrb5Conf(hbaseConfig);
 109         hbaseConfig.entrySet().forEach(entity -&gt; {
 110             config.overrideConfig(entity.getKey(), (String) entity.getValue());
 111         });
 112 
 113         if (HbaseConfigUtils.asyncOpenKerberos(hbaseConfig)) {
 114             String jaasStr = HbaseConfigUtils.buildJaasStr(hbaseConfig);
 115             String jaasFilePath = HbaseConfigUtils.creatJassFile(jaasStr);
 116             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 117             config.overrideConfig(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 118             refreshConfig();
 119         }
 120         hBaseClient = new HBaseClient(config, executorService);
 121 
 122         try {
 123             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 124                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 124                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSüîµ</abbr>
 125 
 126             CheckResult result = (CheckResult) deferred.join();
 127             if(!result.isConnect()){
 128                 throw new RuntimeException(result.getExceptionMsg());
 129             }
 130 
 131         } catch (Exception e) {
 132             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 133         }
 134 
 135         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 136         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 137             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 137             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasüîµ</abbr>
 138                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 139                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 140         }else{
<abbr title=" 141             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 141             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliüîµ</abbr>
 142                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 143                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 144         }
 145     }
 146 
 147     private void refreshConfig() throws KrbException {
 148         sun.security.krb5.Config.refresh();
 149         KerberosName.resetDefaultRealm();
 150         //reload java.security.auth.login.config
 151         javax.security.auth.login.Configuration.setConfiguration(null);
 152     }
 153 
 154     @Override
<abbr title=" 155     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 155     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
<abbr title=" 156         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 156         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSüîµ</abbr>
 157     }
 158 
 159     @Override
 160     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 161         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 162     }
 163 
 164     @Override
 165     public Row fillData(Row input, Object sideInput){
 166         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 167         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 168         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 169             Object obj = input.getField(entry.getValue());
 170 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 172 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 obj = ((Timestamp)obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             if(sideInputList == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             }else{</span>
 186 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 187             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 187             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                 //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 191                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 191                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())üîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 </span>
 194 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 195             row.setField(entry.getKey(), obj);
 196         }
 197 
 198         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 199             if(sideInputList == null){
 200                 row.setField(entry.getKey(), null);
 201             }else{
 202                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 203             }
 204         }
 205 
 206         return row;
 207     }
 208 
 209     @Override
 210     public void close() throws Exception {
 211         super.close();
 212         hBaseClient.shutdown();
 213     }
 214 
 215     class CheckResult{
 216 
 217         private boolean connect;
 218 
 219         private String exceptionMsg;
 220 
 221         CheckResult(boolean connect, String msg){
 222             this.connect = connect;
 223             this.exceptionMsg = msg;
 224         }
 225 
 226         public boolean isConnect() {
 227             return connect;
 228         }
 229 
 230         public void setConnect(boolean connect) {
 231             this.connect = connect;
 232         }
 233 
 234         public String getExceptionMsg() {
 235             return exceptionMsg;
 236         }
 237 
 238         public void setExceptionMsg(String exceptionMsg) {
 239             this.exceptionMsg = exceptionMsg;
 240         }
 241     }
 242 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  27 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  28 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  31 import com.dtstack.flink.sql.factory.DTThreadFactory;
  32 import com.dtstack.flink.sql.side.hbase.utils.HbaseConfigUtils;
  33 import com.stumbleupon.async.Deferred;
  34 import org.apache.flink.api.java.tuple.Tuple2;
  35 import org.apache.commons.lang3.StringUtils;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.configuration.Configuration;
  38 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  39 import org.apache.flink.table.dataformat.BaseRow;
  40 import org.apache.flink.types.Row;
  41 import org.apache.hadoop.security.authentication.util.KerberosName;
  42 import org.hbase.async.Config;
  43 import org.hbase.async.HBaseClient;
  44 import org.slf4j.Logger;
  45 import org.slf4j.LoggerFactory;
  46 import sun.security.krb5.KrbException;
  47 
  48 import java.sql.Timestamp;
  49 import java.util.List;
  50 import java.util.Map;
  51 import java.util.TimeZone;
  52 import java.util.concurrent.ExecutorService;
  53 import java.util.concurrent.LinkedBlockingQueue;
  54 import java.util.concurrent.ThreadPoolExecutor;
  55 import java.util.concurrent.TimeUnit;
  56 
  57 /**
  58  * Date: 2018/8/21
  59  * Company: www.dtstack.com
  60  * @author xuchao
  61  */
  62 
  63 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  64 
  65     private static final long serialVersionUID = 2098635104857937717L;
  66 
  67     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  68 
  69     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  70 
  71     //match to the rule of netty3
  72     private static final int DEFAULT_BOSS_THREADS = 1;
  73 
  74     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  75 
  76     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  77 
  78     private transient HBaseClient hBaseClient;
  79 
  80     private transient AbstractRowKeyModeDealer rowKeyMode;
  81 
  82     private String tableName;
  83 
  84     private String[] colNames;
  85 
<abbr title="  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  87         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  88 
  89         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  90         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  91     }
  92 
  93 
  94     @Override
  95     public void open(Configuration parameters) throws Exception {
  96         super.open(parameters);
  97         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  98         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  99         Map&lt;String, Object&gt; hbaseConfig = hbaseSideTableInfo.getHbaseConfig();
 100 
 101         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 102                 0L, TimeUnit.MILLISECONDS,
 103                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 104 
 105         Config config = new Config();
 106         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, hbaseSideTableInfo.getHost());
<abbr title=" 107         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getParent());"> 107         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getPaüîµ</abbr>
 108         HbaseConfigUtils.loadKrb5Conf(hbaseConfig);
 109         hbaseConfig.entrySet().forEach(entity -&gt; {
 110             config.overrideConfig(entity.getKey(), (String) entity.getValue());
 111         });
 112 
 113         if (HbaseConfigUtils.asyncOpenKerberos(hbaseConfig)) {
 114             String jaasStr = HbaseConfigUtils.buildJaasStr(hbaseConfig);
 115             String jaasFilePath = HbaseConfigUtils.creatJassFile(jaasStr);
 116             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 117             config.overrideConfig(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 118             refreshConfig();
 119         }
 120         hBaseClient = new HBaseClient(config, executorService);
 121 
 122         try {
 123             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 124                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 124                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSüîµ</abbr>
 125 
 126             CheckResult result = (CheckResult) deferred.join();
 127             if(!result.isConnect()){
 128                 throw new RuntimeException(result.getExceptionMsg());
 129             }
 130 
 131         } catch (Exception e) {
 132             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 133         }
 134 
 135         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 136         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 137             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 137             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasüîµ</abbr>
 138                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 139                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 140         }else{
<abbr title=" 141             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 141             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliüîµ</abbr>
 142                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 143                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 144         }
 145     }
 146 
 147     @Override
<abbr title=" 148     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 148     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
<abbr title=" 149         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 149         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSüîµ</abbr>
 150     }
 151 
 152     private void refreshConfig() throws KrbException {
 153         sun.security.krb5.Config.refresh();
 154         KerberosName.resetDefaultRealm();
 155         //reload java.security.auth.login.config
 156         javax.security.auth.login.Configuration.setConfiguration(null);
 157     }
 158 
 159     @Override
 160     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 161         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 162     }
 163 
 164     @Override
 165     public Row fillData(Row input, Object sideInput){
 166         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 167         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 168         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 169             Object obj = input.getField(entry.getValue());
 170 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 172 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 173             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 obj = ((Timestamp)obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             row.setField(entry.getKey(), obj);</span>
 180 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 181             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 181             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoüîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183             if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184                 //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 185                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());"> 185                 obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime())üîµ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 </span>
 188 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 189             row.setField(entry.getKey(), obj);
 190         }
 191 
 192         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 193             if(sideInputList == null){
 194                 row.setField(entry.getKey(), null);
 195             }else{
 196                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 197             }
 198         }
 199 
 200         return row;
 201     }
 202 
 203     @Override
 204     public void close() throws Exception {
 205         super.close();
 206         hBaseClient.shutdown();
 207     }
 208 
 209     class CheckResult{
 210 
 211         private boolean connect;
 212 
 213         private String exceptionMsg;
 214 
 215         CheckResult(boolean connect, String msg){
 216             this.connect = connect;
 217             this.exceptionMsg = msg;
 218         }
 219 
 220         public boolean isConnect() {
 221             return connect;
 222         }
 223 
 224         public void setConnect(boolean connect) {
 225             this.connect = connect;
 226         }
 227 
 228         public String getExceptionMsg() {
 229             return exceptionMsg;
 230         }
 231 
 232         public void setExceptionMsg(String exceptionMsg) {
 233             this.exceptionMsg = exceptionMsg;
 234         }
 235     }
 236 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.hbase;
  19 
  20 import com.dtstack.flink.sql.factory.DTThreadFactory;
  21 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.FieldInfo;
  24 import com.dtstack.flink.sql.side.JoinInfo;
  25 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  26 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  27 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  28 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  29 import com.dtstack.flink.sql.side.hbase.utils.HbaseConfigUtils;
  30 import com.stumbleupon.async.Deferred;
  31 import java.sql.Timestamp;
  32 import java.util.List;
  33 import java.util.Map;
  34 import java.util.TimeZone;
  35 import java.util.concurrent.ExecutorService;
  36 import java.util.concurrent.LinkedBlockingQueue;
  37 import java.util.concurrent.ThreadPoolExecutor;
  38 import java.util.concurrent.TimeUnit;
  39 import org.apache.commons.lang3.StringUtils;
  40 import org.apache.flink.api.java.tuple.Tuple2;
  41 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  42 import org.apache.flink.configuration.Configuration;
  43 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  44 import org.apache.flink.table.dataformat.BaseRow;
  45 import org.apache.flink.types.Row;
  46 import org.apache.hadoop.security.authentication.util.KerberosName;
  47 import org.hbase.async.Config;
  48 import org.hbase.async.HBaseClient;
  49 import org.slf4j.Logger;
  50 import org.slf4j.LoggerFactory;
  51 import sun.security.krb5.KrbException;
  52 
  53 
  54 /**
  55  * Date: 2018/8/21
  56  * Company: www.dtstack.com
  57  * @author xuchao
  58  */
  59 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  60     private static final long serialVersionUID = 2098635104857937717L;
  61 
  62     private static final TimeZone LOCAL_TZ = TimeZone.getDefault();
  63 
  64     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  65 
  66     //match to the rule of netty3
  67     //match to the rule of netty3
  68     private static final int DEFAULT_BOSS_THREADS = 1;
  69 
  70     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  71 
  72     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  73 
  74     private transient HBaseClient hBaseClient;
  75 
  76     private transient AbstractRowKeyModeDealer rowKeyMode;
  77 
  78     private String tableName;
  79 
  80     private String[] colNames;
  81 
<abbr title="  82     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  82     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,üîµ</abbr>
  83         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  84         tableName = ((HbaseSideTableInfo) (sideTableInfo)).getTableName();
  85         colNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  86     }
  87 
  88     @Override
  89     public void open(Configuration parameters) throws Exception {
  90         super.open(parameters);
  91         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  92         HbaseSideTableInfo hbaseSideTableInfo = ((HbaseSideTableInfo) (sideTableInfo));
  93         Map&lt;String, Object&gt; hbaseConfig = hbaseSideTableInfo.getHbaseConfig();
<abbr title="  94         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));">  94         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0Lüîµ</abbr>
  95         Config config = new Config();
  96         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, hbaseSideTableInfo.getHost());
<abbr title="  97         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getParent());">  97         config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getPaüîµ</abbr>
  98         HbaseConfigUtils.loadKrb5Conf(hbaseConfig);
  99         hbaseConfig.entrySet().forEach(( entity) -&gt; {
 100             config.overrideConfig(entity.getKey(), ((String) (entity.getValue())));
 101         });
 102         if (HbaseConfigUtils.asyncOpenKerberos(hbaseConfig)) {
 103             String jaasStr = HbaseConfigUtils.buildJaasStr(hbaseConfig);
 104             String jaasFilePath = HbaseConfigUtils.creatJassFile(jaasStr);
 105             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 106             config.overrideConfig(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 107             refreshConfig();
 108         }
 109         hBaseClient = new HBaseClient(config, executorService);
 110         try {
<abbr title=" 111             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new CheckResult(true, &quot;&quot;), ( arg) -&gt; new CheckResult(false, arg.toString()));"> 111             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new Checküîµ</abbr>
 112             CheckResult result = ((CheckResult) (deferred.join()));
 113             if (!result.isConnect()) {
 114                 throw new RuntimeException(result.getExceptionMsg());
 115             }
 116         } catch (java.lang.Exception e) {
 117             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 118         }
 119         HbaseAsyncSideInfo hbaseAsyncSideInfo = ((HbaseAsyncSideInfo) (sideInfo));
 120         if (hbaseSideTableInfo.isPreRowKey()) {
<abbr title=" 121             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 121             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasüîµ</abbr>
 122         } else {
<abbr title=" 123             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 123             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliüîµ</abbr>
 124         }
 125     }
 126 
 127     private void refreshConfig() throws KrbException {
 128         sun.security.krb5.Config.refresh();
 129         KerberosName.resetDefaultRealm();
 130         //reload java.security.auth.login.config
 131         javax.security.auth.login.Configuration.setConfiguration(null);
 132     }
 133 
 134     @Override
<abbr title=" 135     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 135     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resulüîµ</abbr>
<abbr title=" 136         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 136         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSüîµ</abbr>
 137     }
 138 
 139     @Override
 140     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 141         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 142     }
 143 
 144     @Override
 145     public Row fillData(Row input, Object sideInput) {
 146         List&lt;Object&gt; sideInputList = ((List&lt;Object&gt;) (sideInput));
 147         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 148         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 149             Object obj = input.getField(entry.getValue());
 150             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 151             row.setField(entry.getKey(), obj);
 152         }
 153         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 154             if (sideInputList == null) {
 155                 row.setField(entry.getKey(), null);
 156             } else {
 157                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 158             }
 159         }
 160         return row;
 161     }
 162 
 163     @Override
 164     public void close() throws Exception {
 165         super.close();
 166         hBaseClient.shutdown();
 167     }
 168 
 169     class CheckResult {
 170         private boolean connect;
 171 
 172         private String exceptionMsg;
 173 
 174         CheckResult(boolean connect, String msg) {
 175             this.connect = connect;
 176             this.exceptionMsg = msg;
 177         }
 178 
 179         public boolean isConnect() {
 180             return connect;
 181         }
 182 
 183         public void setConnect(boolean connect) {
 184             this.connect = connect;
 185         }
 186 
 187         public String getExceptionMsg() {
 188             return exceptionMsg;
 189         }
 190 
 191         public void setExceptionMsg(String exceptionMsg) {
 192             this.exceptionMsg = exceptionMsg;
 193         }
 194     }
 195 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.ECacheContentType;
  24  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28  import com.dtstack.flink.sql.side.cache.CacheObj;
  29  import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33  import com.dtstack.flink.sql.factory.DTThreadFactory;
  34  import com.dtstack.flink.sql.side.hbase.utils.HbaseConfigUtils;
  35  import com.dtstack.flink.sql.util.AuthUtil;
  36  import com.google.common.collect.Maps;
  37  import com.stumbleupon.async.Deferred;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  39  import org.apache.commons.lang3.StringUtils;
  40  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  41  import org.apache.flink.configuration.Configuration;
  42  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.apache.flink.table.dataformat.BaseRow;</span>
  46  import org.apache.flink.types.Row;

  47  import org.hbase.async.Config;
  48  import org.hbase.async.HBaseClient;
  49  import org.slf4j.Logger;
  50  import org.slf4j.LoggerFactory;
  51  
  52  import java.io.File;
  53  import java.io.IOException;


  54  import java.sql.Timestamp;
  55  import java.util.Collections;
  56  import java.util.List;
  57  import java.util.Map;

  58  import java.util.concurrent.ExecutorService;
  59  import java.util.concurrent.LinkedBlockingQueue;
  60  import java.util.concurrent.ThreadPoolExecutor;
  61  import java.util.concurrent.TimeUnit;
  62  
  63  /**
  64   * Date: 2018/8/21
  65   * Company: www.dtstack.com
  66   * @author xuchao
  67   */
  68  
  69  public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  70  
  71      private static final long serialVersionUID = 2098635104857937717L;


  72  
  73      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  74  
  75      //match to the rule of netty3
  76      private static final int DEFAULT_BOSS_THREADS = 1;
  77  
  78      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  79  
  80      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  81  
  82      private transient HBaseClient hBaseClient;
  83  
  84      private transient AbstractRowKeyModeDealer rowKeyMode;
  85  
  86      private String tableName;
  87  
  88      private String[] colNames;
  89  
<abbr title="  90      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  90      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  91          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  92  
  93          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  94          colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  95      }
  96  
  97  
  98      @Override
  99      public void open(Configuration parameters) throws Exception {
 100          super.open(parameters);
 101          AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
 102          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
 103          Map&lt;String, Object&gt; hbaseConfig = hbaseSideTableInfo.getHbaseConfig();
 104  
 105          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 106                  0L, TimeUnit.MILLISECONDS,
 107                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 108  
 109          Config config = new Config();
 110          config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, hbaseSideTableInfo.getHost());
 111          config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getParent());
 112          HbaseConfigUtils.loadKrb5Conf(hbaseConfig);
 113          hbaseConfig.entrySet().forEach(entity -&gt; {
 114              config.overrideConfig(entity.getKey(), (String) entity.getValue());
 115          });
 116  
 117          if (HbaseConfigUtils.asyncOpenKerberos(hbaseConfig)) {
 118              String jaasStr = HbaseConfigUtils.buildJaasStr(hbaseConfig);
 119              String jaasFilePath = HbaseConfigUtils.creatJassFile(jaasStr);

 120              config.overrideConfig(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
 121          }
 122  


 123          hBaseClient = new HBaseClient(config, executorService);
 124  
 125          try {
 126              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 127                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 127                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))üîµ</abbr>
 128  
 129              CheckResult result = (CheckResult) deferred.join();
 130              if(!result.isConnect()){
 131                  throw new RuntimeException(result.getExceptionMsg());
 132              }
 133  
 134          } catch (Exception e) {
 135              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 136          }
 137  
 138          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 139          if(hbaseSideTableInfo.isPreRowKey()){
 140              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 141                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 142                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 143          }else{
 144              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 145                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 146                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 147          }
 148      }
 149  







 150      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 151 -    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 151 -    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 152 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) throws Exception {"> 152 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Row input, ResultFuture&lt;BaseRow&gt; resultFuture) üîµ</abbr></span>
<abbr title=" 153          rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 153          rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache(üîµ</abbr>
 154      }
 155  
 156      @Override
 157      public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 158          return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 159      }
 160  
 161      @Override
 162      public Row fillData(Row input, Object sideInput){
 163          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 164          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 165          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 166              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 167 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 167 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -            if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                obj = ((Timestamp)obj).getTime();</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 174              row.setField(entry.getKey(), obj);
 175          }
 176  
 177          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 178              if(sideInputList == null){
 179                  row.setField(entry.getKey(), null);
 180              }else{
 181                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 182              }
 183          }
 184  
 185          return row;
 186      }
 187  
 188      @Override
 189      public void close() throws Exception {
 190          super.close();
 191          hBaseClient.shutdown();
 192      }
 193  
 194      class CheckResult{
 195  
 196          private boolean connect;
 197  
 198          private String exceptionMsg;
 199  
 200          CheckResult(boolean connect, String msg){
 201              this.connect = connect;
 202              this.exceptionMsg = msg;
 203          }
 204  
 205          public boolean isConnect() {
 206              return connect;
 207          }
 208  
 209          public void setConnect(boolean connect) {
 210              this.connect = connect;
 211          }
 212  
 213          public String getExceptionMsg() {
 214              return exceptionMsg;
 215          }
 216  
 217          public void setExceptionMsg(String exceptionMsg) {
 218              this.exceptionMsg = exceptionMsg;
 219          }
 220      }
 221  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.enums.ECacheContentType;</span>
  24  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.side.cache.CacheObj;</span>
  29  import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33  import com.dtstack.flink.sql.factory.DTThreadFactory;
  34  import com.dtstack.flink.sql.side.hbase.utils.HbaseConfigUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.util.AuthUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.google.common.collect.Maps;</span>
  37  import com.stumbleupon.async.Deferred;

  38  import org.apache.commons.lang3.StringUtils;
  39  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  40  import org.apache.flink.configuration.Configuration;
  41  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  42  import org.apache.flink.table.runtime.types.CRow;
  43  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;

  44  import org.apache.flink.types.Row;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +import org.apache.hadoop.security.authentication.util.KerberosName;</span>
  46  import org.hbase.async.Config;
  47  import org.hbase.async.HBaseClient;
  48  import org.slf4j.Logger;
  49  import org.slf4j.LoggerFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.io.IOException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import sun.security.krb5.KrbException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +</span>
  55  import java.sql.Timestamp;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import java.util.Collections;</span>
  57  import java.util.List;
  58  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +import java.util.TimeZone;</span>
  60  import java.util.concurrent.ExecutorService;
  61  import java.util.concurrent.LinkedBlockingQueue;
  62  import java.util.concurrent.ThreadPoolExecutor;
  63  import java.util.concurrent.TimeUnit;
  64  
  65  /**
  66   * Date: 2018/8/21
  67   * Company: www.dtstack.com
  68   * @author xuchao
  69   */
  70  
  71  public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  72  
  73      private static final long serialVersionUID = 2098635104857937717L;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    private static final TimeZone LOCAL_TZ = TimeZone.getDefault();</span>
  76  
  77      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  78  
  79      //match to the rule of netty3
  80      private static final int DEFAULT_BOSS_THREADS = 1;
  81  
  82      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  83  
  84      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  85  
  86      private transient HBaseClient hBaseClient;
  87  
  88      private transient AbstractRowKeyModeDealer rowKeyMode;
  89  
  90      private String tableName;
  91  
  92      private String[] colNames;
  93  
<abbr title="  94      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  94      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, Abstractüîµ</abbr>
  95          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  96  
  97          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  98          colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  99      }
 100  
 101  
 102      @Override
 103      public void open(Configuration parameters) throws Exception {
 104          super.open(parameters);
 105          AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
 106          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
 107          Map&lt;String, Object&gt; hbaseConfig = hbaseSideTableInfo.getHbaseConfig();
 108  
 109          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 110                  0L, TimeUnit.MILLISECONDS,
 111                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 112  
 113          Config config = new Config();
 114          config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, hbaseSideTableInfo.getHost());
 115          config.overrideConfig(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, hbaseSideTableInfo.getParent());
 116          HbaseConfigUtils.loadKrb5Conf(hbaseConfig);
 117          hbaseConfig.entrySet().forEach(entity -&gt; {
 118              config.overrideConfig(entity.getKey(), (String) entity.getValue());
 119          });
 120  
 121          if (HbaseConfigUtils.asyncOpenKerberos(hbaseConfig)) {
 122              String jaasStr = HbaseConfigUtils.buildJaasStr(hbaseConfig);
 123              String jaasFilePath = HbaseConfigUtils.creatJassFile(jaasStr);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +            System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);</span>
 125              config.overrideConfig(HbaseConfigUtils.KEY_JAVA_SECURITY_AUTH_LOGIN_CONF, jaasFilePath);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +            refreshConfig();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        }</span>
 130          hBaseClient = new HBaseClient(config, executorService);
 131  
 132          try {
 133              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 134                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 134                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))üîµ</abbr>
 135  
 136              CheckResult result = (CheckResult) deferred.join();
 137              if(!result.isConnect()){
 138                  throw new RuntimeException(result.getExceptionMsg());
 139              }
 140  
 141          } catch (Exception e) {
 142              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 143          }
 144  
 145          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 146          if(hbaseSideTableInfo.isPreRowKey()){
 147              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 148                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 149                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 150          }else{
 151              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 152                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 153                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 154          }
 155      }
 156  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    private void refreshConfig() throws KrbException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        sun.security.krb5.Config.refresh();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +        KerberosName.resetDefaultRealm();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +        //reload java.security.auth.login.config</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        javax.security.auth.login.Configuration.setConfiguration(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +</span>
 164      @Override
<abbr title=" 165      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 165      public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thüîµ</abbr>

<abbr title=" 166          rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 166          rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache(üîµ</abbr>
 167      }
 168  
 169      @Override
 170      public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 171          return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 172      }
 173  
 174      @Override
 175      public Row fillData(Row input, Object sideInput){
 176          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 177          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 178          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 179              Object obj = input.getField(entry.getValue());
<abbr title=" 180              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 180              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoüîµ</abbr>
 181  
 182              if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                obj = ((Timestamp)obj).getTime();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +                //ÂéªÈô§‰∏ä‰∏ÄÂ±ÇOutputRowtimeProcessFunction Ë∞ÉÁî®Êó∂Âå∫ÂØºËá¥ÁöÑÂΩ±Âìç</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                obj = ((Timestamp) obj).getTime() + (long)LOCAL_TZ.getOffset(((Timestamp) obj).getTime());</span>
 186              }
 187  

 188              row.setField(entry.getKey(), obj);
 189          }
 190  
 191          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 192              if(sideInputList == null){
 193                  row.setField(entry.getKey(), null);
 194              }else{
 195                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 196              }
 197          }
 198  
 199          return row;
 200      }
 201  
 202      @Override
 203      public void close() throws Exception {
 204          super.close();
 205          hBaseClient.shutdown();
 206      }
 207  
 208      class CheckResult{
 209  
 210          private boolean connect;
 211  
 212          private String exceptionMsg;
 213  
 214          CheckResult(boolean connect, String msg){
 215              this.connect = connect;
 216              this.exceptionMsg = msg;
 217          }
 218  
 219          public boolean isConnect() {
 220              return connect;
 221          }
 222  
 223          public void setConnect(boolean connect) {
 224              this.connect = connect;
 225          }
 226  
 227          public String getExceptionMsg() {
 228              return exceptionMsg;
 229          }
 230  
 231          public void setExceptionMsg(String exceptionMsg) {
 232              this.exceptionMsg = exceptionMsg;
 233          }
 234      }
 235  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            