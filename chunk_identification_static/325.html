<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>325</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    325
                    <a href="324.html">prev</a>
                    <a href="326.html">next</a>
                    <a href="325_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Cybereason/Logout4Shell_969bef5503f5d0eb1b06dd4291dee9bf3f664635_src/main/java/Log4jRCE.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;969bef5503f5d0eb1b06dd4291dee9bf3f664635:src/main/java/Log4jRCE.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;969bef5503f5d0eb1b06dd4291dee9bf3f664635^1:src/main/java/Log4jRCE.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;969bef5503f5d0eb1b06dd4291dee9bf3f664635^2:src/main/java/Log4jRCE.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Cybereason\Logout4Shell show &quot;b79af3a14a98f3b5e13d3dc347e9a921192f0b27:src/main/java/Log4jRCE.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [j], [j], [s]], subset: [[b], [sbj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 import org.apache.logging.log4j.LogManager;
   2 import org.apache.logging.log4j.core.LoggerContext;
   3 import org.apache.logging.log4j.core.config.Configuration;
   4 import org.apache.logging.log4j.core.config.Configurator;
   5 import org.apache.logging.log4j.core.lookup.Interpolator;
   6 import org.apache.logging.log4j.core.lookup.StrLookup;
   7 import org.apache.logging.log4j.core.selector.ContextSelector;
   8 
   9 import java.io.File;
  10 import java.io.FileInputStream;
  11 import java.io.FileOutputStream;
  12 import java.lang.reflect.Field;
  13 import java.lang.reflect.Constructor;
  14 import java.lang.reflect.Method;
  15 import java.lang.reflect.Modifier;
  16 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 import java.util.Base64;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 import java.util.zip.ZipEntry;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import java.util.zip.ZipInputStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import java.util.zip.ZipOutputStream;</span>
  22 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  24             Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  24             Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.logðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25             Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  26             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  26             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + ConstðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27             setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 </span>
  29 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import java.util.Map;</span>
  32 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  33 
  34 public class Log4jRCE {
  35     static {
  36         Class&lt;?&gt; c = null;
  37         try {
  38 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39             System.out.println(&quot;Patching&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40             </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  41             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  41             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.uðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42             Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  43             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  43             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + ConstðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44             setFinalStatic(field, Boolean.TRUE);</span>
  45 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46             reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48             System.err.println(&quot;Exception &quot; + e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     static void setFinalStatic(Field field, Object newValue) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53         field.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);</span>
  55 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56             try { // Try for versions of Log4j &gt;= 2.10</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  57               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  57               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.lðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58               Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59               System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60               setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  61             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable">  61             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  62                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  62                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64             }</span>
  65 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  66 
  67             //reconfiguring log4j
  68             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
  69 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70             Class&lt;?&gt; aClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71             Method reconfigure = aClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72             reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73         } catch (Throwable e) {</span>
  74 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         modifiersField.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         field.set(null, newValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 }</span>
  80 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  81             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  81             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83                 Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85             } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86                 Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  89                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  89                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91                 Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94                     ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                         Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101                         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 107                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);"> 107                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                         lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         } catch (Exception e) {</span>
 113 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 114             System.err.println(&quot;Exception &quot; + e);
 115             e.printStackTrace();
 116         }
 117         
 118         // modify the log4j jar to fix the vuln
 119         if(c != null)
 120             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());
 121     }
 122     
 123     private static void fullyVaccinate(URL jarfile) {
 124         String path = jarfile.getFile();
 125         File jar = new File(path);
 126         if(path.endsWith(&quot;.jar&quot;)) {
 127             try {
 128                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 129                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 130                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 131                 ZipEntry entry;
 132                 while ((entry = in.getNextEntry()) != null) {
 133                     out.putNextEntry(new ZipEntry(entry.getName()));
 134                     if(entry.getName().equals(&quot;org/apache/logging/log4j/core/util/Constants.class&quot;)) {
<abbr title=" 135                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 135                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to deðŸ”µ</abbr>
 136                         // base64 is more compact than a byte array in source code.
 137                         byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +
<abbr title=" 138                                                                      &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +"> 138                                                                      &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9ðŸ”µ</abbr>
<abbr title=" 139                                                                      &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +"> 139                                                                      &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEðŸ”µ</abbr>
<abbr title=" 140                                                                      &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +"> 140                                                                      &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1NðŸ”µ</abbr>
<abbr title=" 141                                                                      &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +"> 141                                                                      &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IðŸ”µ</abbr>
<abbr title=" 142                                                                      &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +"> 142                                                                      &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAðŸ”µ</abbr>
<abbr title=" 143                                                                      &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +"> 143                                                                      &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29ðŸ”µ</abbr>
<abbr title=" 144                                                                      &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +"> 144                                                                      &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gðŸ”µ</abbr>
<abbr title=" 145                                                                      &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +"> 145                                                                      &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFðŸ”µ</abbr>
<abbr title=" 146                                                                      &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +"> 146                                                                      &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEðŸ”µ</abbr>
<abbr title=" 147                                                                      &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +"> 147                                                                      &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEðŸ”µ</abbr>
<abbr title=" 148                                                                      &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +"> 148                                                                      &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhðŸ”µ</abbr>
<abbr title=" 149                                                                      &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +"> 149                                                                      &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEðŸ”µ</abbr>
<abbr title=" 150                                                                      &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +"> 150                                                                      &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwðŸ”µ</abbr>
<abbr title=" 151                                                                      &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +"> 151                                                                      &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5ðŸ”µ</abbr>
<abbr title=" 152                                                                      &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +"> 152                                                                      &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJðŸ”µ</abbr>
<abbr title=" 153                                                                      &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +"> 153                                                                      &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hðŸ”µ</abbr>
<abbr title=" 154                                                                      &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +"> 154                                                                      &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZðŸ”µ</abbr>
<abbr title=" 155                                                                      &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +"> 155                                                                      &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJðŸ”µ</abbr>
<abbr title=" 156                                                                      &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +"> 156                                                                      &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAAðŸ”µ</abbr>
<abbr title=" 157                                                                      &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +"> 157                                                                      &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwðŸ”µ</abbr>
<abbr title=" 158                                                                      &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +"> 158                                                                      &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29ðŸ”µ</abbr>
<abbr title=" 159                                                                      &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +"> 159                                                                      &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoðŸ”µ</abbr>
<abbr title=" 160                                                                      &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +"> 160                                                                      &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxðŸ”µ</abbr>
<abbr title=" 161                                                                      &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +"> 161                                                                      &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIðŸ”µ</abbr>
<abbr title=" 162                                                                      &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +"> 162                                                                      &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5ðŸ”µ</abbr>
<abbr title=" 163                                                                      &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +"> 163                                                                      &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU29ðŸ”µ</abbr>
<abbr title=" 164                                                                      &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +"> 164                                                                      &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwAðŸ”µ</abbr>
<abbr title=" 165                                                                      &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +"> 165                                                                      &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAðŸ”µ</abbr>
<abbr title=" 166                                                                      &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +"> 166                                                                      &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAAðŸ”µ</abbr>
<abbr title=" 167                                                                      &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +"> 167                                                                      &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAðŸ”µ</abbr>
<abbr title=" 168                                                                      &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +"> 168                                                                      &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSqðŸ”µ</abbr>
<abbr title=" 169                                                                      &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +"> 169                                                                      &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQAðŸ”µ</abbr>
<abbr title=" 170                                                                      &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +"> 170                                                                      &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0ðŸ”µ</abbr>
<abbr title=" 171                                                                      &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +"> 171                                                                      &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAðŸ”µ</abbr>
 172                                                                      &quot;UQCIAAEAYwAAAAIABQ==&quot;);
 173                         out.write(newClass);
 174                     }
 175                     else {
 176                         byte[] buf = new byte[4096];
 177                         int i;
 178                         while ((i = in.read(buf)) &gt; 0) {
 179                             out.write(buf, 0, i);
 180                         }
 181                     }
 182                     out.closeEntry();
 183                     in.closeEntry();
 184                 }
 185                 in.close();
 186                 out.close();
 187                 if (!jar.delete() || !fixedjar.renameTo(jar)) {
 188                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 189                 }
 190             }
 191             catch (Exception e) {
 192                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 193                 e.printStackTrace();
 194             }
 195         }
 196     }
 197     
 198     static void setFinalStatic(Field field, Object newValue) throws Exception {
 199         setAccess(field);
 200         field.set(null, newValue);
 201     }
 202 
 203     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 204         field.setAccessible(true);
 205         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 206         modifiersField.setAccessible(true);
 207         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 208     }
 209 }</pre></td>
                            <td><pre>   1 import org.apache.logging.log4j.LogManager;
   2 import org.apache.logging.log4j.core.LoggerContext;
   3 import org.apache.logging.log4j.core.config.Configuration;
   4 import org.apache.logging.log4j.core.config.Configurator;
   5 import org.apache.logging.log4j.core.lookup.Interpolator;
   6 import org.apache.logging.log4j.core.lookup.StrLookup;
   7 import org.apache.logging.log4j.core.selector.ContextSelector;
   8 import java.lang.reflect.Field;
   9 import java.lang.reflect.Constructor;
  10 import java.lang.reflect.Method;
  11 import java.lang.reflect.Modifier;
  12 import java.net.URL;
  13 import java.util.Base64;
  14 import java.util.zip.ZipEntry;
  15 import java.util.zip.ZipInputStream;
  16 import java.util.zip.ZipOutputStream;
  17 import java.util.HashMap;
  18 import java.util.Map;
  19 
  20 import java.io.File;
  21 import java.io.FileInputStream;
  22 import java.io.FileOutputStream;
  23 
  24 public class Log4jRCE {
  25     static {
  26         Class&lt;?&gt; c = null;
  27         try {
  28 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29             System.out.println(&quot;Patching&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  31             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  31             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.uðŸ”µ</abbr></span>
  32 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  33             Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  33             Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.logðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34             Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  35             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  35             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + ConstðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36             setFinalStatic(field, Boolean.TRUE);</span>
  37 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38             try { // Try for versions of Log4j &gt;= 2.10</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  39               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  39               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.lðŸ”µ</abbr></span>
  40 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  41             Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
  42               System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);
  43             setFinalStatic(field, Boolean.TRUE);
<abbr title="  44             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable">  44             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instaðŸ”µ</abbr>
<abbr title="  45                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  45                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr>
  46                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);
  47             }
  48 
  49             //reconfiguring log4j
  50             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
<abbr title="  51             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  51             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr>
  52             try {
  53                 Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);
  54             reconfigure.invoke(null);
  55 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56         } catch (Throwable e) {</span>
  57 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     }</span>
  59 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60             } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61                 Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  64                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  64                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66                 Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69                     ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75                         Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76                         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  82                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);">  82                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83                         lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87         } catch (Exception e) {</span>
  88 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  89             System.err.println(&quot;Exception &quot; + e);
  90             e.printStackTrace();
  91         }
  92 
  93         // modify the log4j jar to fix the vuln
  94         if(c != null)
  95             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());
  96     }
  97 
  98     private static void fullyVaccinate(URL jarfile) {
  99         String path = jarfile.getFile();
 100         File jar = new File(path);
 101         if(path.endsWith(&quot;.jar&quot;)) {
 102             try {
 103                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 104                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 105                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 106                 ZipEntry entry;
 107                 while ((entry = in.getNextEntry()) != null) {
 108                     out.putNextEntry(new ZipEntry(entry.getName()));
 109                     if(entry.getName().equals(&quot;org/apache/logging/log4j/core/util/Constants.class&quot;)) {
<abbr title=" 110                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 110                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to deðŸ”µ</abbr>
 111                         // base64 is more compact than a byte array in source code.
 112                         byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +
<abbr title=" 113                                                                      &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +"> 113                                                                      &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9ðŸ”µ</abbr>
<abbr title=" 114                                                                      &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +"> 114                                                                      &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEðŸ”µ</abbr>
<abbr title=" 115                                                                      &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +"> 115                                                                      &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1NðŸ”µ</abbr>
<abbr title=" 116                                                                      &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +"> 116                                                                      &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IðŸ”µ</abbr>
<abbr title=" 117                                                                      &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +"> 117                                                                      &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAðŸ”µ</abbr>
<abbr title=" 118                                                                      &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +"> 118                                                                      &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29ðŸ”µ</abbr>
<abbr title=" 119                                                                      &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +"> 119                                                                      &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gðŸ”µ</abbr>
<abbr title=" 120                                                                      &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +"> 120                                                                      &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFðŸ”µ</abbr>
<abbr title=" 121                                                                      &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +"> 121                                                                      &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEðŸ”µ</abbr>
<abbr title=" 122                                                                      &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +"> 122                                                                      &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEðŸ”µ</abbr>
<abbr title=" 123                                                                      &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +"> 123                                                                      &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhðŸ”µ</abbr>
<abbr title=" 124                                                                      &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +"> 124                                                                      &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEðŸ”µ</abbr>
<abbr title=" 125                                                                      &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +"> 125                                                                      &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwðŸ”µ</abbr>
<abbr title=" 126                                                                      &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +"> 126                                                                      &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5ðŸ”µ</abbr>
<abbr title=" 127                                                                      &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +"> 127                                                                      &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJðŸ”µ</abbr>
<abbr title=" 128                                                                      &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +"> 128                                                                      &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hðŸ”µ</abbr>
<abbr title=" 129                                                                      &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +"> 129                                                                      &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZðŸ”µ</abbr>
<abbr title=" 130                                                                      &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +"> 130                                                                      &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJðŸ”µ</abbr>
<abbr title=" 131                                                                      &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +"> 131                                                                      &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAAðŸ”µ</abbr>
<abbr title=" 132                                                                      &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +"> 132                                                                      &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwðŸ”µ</abbr>
<abbr title=" 133                                                                      &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +"> 133                                                                      &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29ðŸ”µ</abbr>
<abbr title=" 134                                                                      &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +"> 134                                                                      &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoðŸ”µ</abbr>
<abbr title=" 135                                                                      &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +"> 135                                                                      &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxðŸ”µ</abbr>
<abbr title=" 136                                                                      &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +"> 136                                                                      &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIðŸ”µ</abbr>
<abbr title=" 137                                                                      &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +"> 137                                                                      &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5ðŸ”µ</abbr>
<abbr title=" 138                                                                      &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +"> 138                                                                      &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU29ðŸ”µ</abbr>
<abbr title=" 139                                                                      &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +"> 139                                                                      &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwAðŸ”µ</abbr>
<abbr title=" 140                                                                      &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +"> 140                                                                      &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAðŸ”µ</abbr>
<abbr title=" 141                                                                      &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +"> 141                                                                      &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAAðŸ”µ</abbr>
<abbr title=" 142                                                                      &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +"> 142                                                                      &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAðŸ”µ</abbr>
<abbr title=" 143                                                                      &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +"> 143                                                                      &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSqðŸ”µ</abbr>
<abbr title=" 144                                                                      &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +"> 144                                                                      &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQAðŸ”µ</abbr>
<abbr title=" 145                                                                      &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +"> 145                                                                      &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0ðŸ”µ</abbr>
<abbr title=" 146                                                                      &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +"> 146                                                                      &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAðŸ”µ</abbr>
 147                                                                      &quot;UQCIAAEAYwAAAAIABQ==&quot;);
 148                         out.write(newClass);
 149                     }
 150                     else {
 151                         byte[] buf = new byte[4096];
 152                         int i;
 153                         while ((i = in.read(buf)) &gt; 0) {
 154                             out.write(buf, 0, i);
 155                         }
 156                     }
 157                     out.closeEntry();
 158                     in.closeEntry();
 159                 }
 160                 in.close();
 161                 out.close();
 162                 if (!jar.delete() || !fixedjar.renameTo(jar)) {
 163                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 164                 }
 165             }
 166             catch (Exception e) {
 167                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 168                 e.printStackTrace();
 169             }
 170         }
 171     }
 172 
 173     static void setFinalStatic(Field field, Object newValue) throws Exception {
 174         setAccess(field);
 175         field.set(null, newValue);
 176     }
 177 
 178     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 179         field.setAccessible(true);
 180         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 181         modifiersField.setAccessible(true);
 182         modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 183     }
 184 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 import java.io.File;
   2 import java.io.FileInputStream;
   3 import java.io.FileOutputStream;
   4 import java.lang.reflect.Constructor;
   5 import java.lang.reflect.Field;
   6 import java.lang.reflect.Method;
   7 import java.lang.reflect.Modifier;
   8 import java.net.URL;
   9 import java.util.Base64;
  10 import java.util.HashMap;
  11 import java.util.Map;
  12 import java.util.zip.ZipEntry;
  13 import java.util.zip.ZipInputStream;
  14 import java.util.zip.ZipOutputStream;
  15 import org.apache.logging.log4j.LogManager;
  16 import org.apache.logging.log4j.core.LoggerContext;
  17 import org.apache.logging.log4j.core.config.Configuration;
  18 import org.apache.logging.log4j.core.config.Configurator;
  19 import org.apache.logging.log4j.core.lookup.Interpolator;
  20 import org.apache.logging.log4j.core.lookup.StrLookup;
  21 import org.apache.logging.log4j.core.selector.ContextSelector;
  22 
  23 
  24 public class Log4jRCE {
  25     static {
  26 
  27 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28         Class&lt;?&gt; c = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30             System.out.println(&quot;Patching&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  32             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  32             c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.uðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33             Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  34             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  34             System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + ConstðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35             setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37             //reconfiguring log4j</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39             Class&lt;?&gt; aClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40             Method reconfigure = aClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41             reconfigure.invoke(null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42         } catch (Throwable e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43             System.err.println(&quot;Exception &quot; + e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46         // modify the log4j jar to fix the vuln</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47         if(c != null)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48             fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());</span>
  49 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  50 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  50 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
  51 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54             try { // Try for versions of Log4j &gt;= 2.10</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  55               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  55               Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.lðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56               Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57               System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58               setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  59             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable">  59             } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  60                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);">  60                 System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61                 System.err.println(&quot;Will attempt to modify the configuration directly&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64             //reconfiguring log4j</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  66             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  66             Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.ConfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68                 Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69                 reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70             } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71                 Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72                 getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73                 Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  74                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  74                 Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75                 Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76                 Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77                 ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78                 for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79                     ctx.reconfigure();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80                     System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81                     Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82                     StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83                     if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84                         System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85                         Field lookups = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86                         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87                             lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88                         } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89                             lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91                         lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  92                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);">  92                         Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93                         lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98             System.err.println(&quot;Exception &quot; + e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         }</span>
 101 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 102 
 103     }
 104 
 105     private static void fullyVaccinate(URL jarfile) {
 106         String path = jarfile.getFile();
 107         File jar = new File(path);
 108         if (path.endsWith(&quot;.jar&quot;)) {
 109             try {
 110                 File fixedjar = new File(&quot;log4j.jar.tmp&quot;);
 111                 ZipInputStream in = new ZipInputStream(new FileInputStream(path));
 112                 ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));
 113                 ZipEntry entry;
 114                 while ((entry = in.getNextEntry()) != null) {
 115                     out.putNextEntry(new ZipEntry(entry.getName()));
 116                     if (entry.getName().equals(&quot;org/apache/logging/log4j/core/util/Constants.class&quot;)) {
<abbr title=" 117                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)"> 117                         // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to deðŸ”µ</abbr>
 118                         // base64 is more compact than a byte array in source code.
<abbr title=" 119                         byte[] newClass = Base64.getDecoder().decode(&quot;&quot; + ((((((((((((((((((((((((((((((((((&quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; + &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot;) + &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot;) + &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot;) + &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot;) + &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot;) + &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot;) + &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot;) + &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot;) + &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot;) + &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot;) + &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot;) + &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot;) + &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot;) + &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot;) + &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot;) + &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot;) + &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot;) + &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot;) + &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot;) + &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot;) + &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot;) + &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot;) + &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot;) + &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot;) + &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot;) + &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot;) + &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot;) + &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot;) + &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot;) + &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot;) + &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot;) + &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot;) + &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot;) + &quot;UQCIAAEAYwAAAAIABQ==&quot;));"> 119                         byte[] newClass = Base64.getDecoder().decode(&quot;&quot; + (((((((((((((((((((((((((((((((ðŸ”µ</abbr>
 120                         out.write(newClass);
 121                     } else {
 122                         byte[] buf = new byte[4096];
 123                         int i;
 124                         while ((i = in.read(buf)) &gt; 0) {
 125                             out.write(buf, 0, i);
 126                         }
 127                     }
 128                     out.closeEntry();
 129                     in.closeEntry();
 130                 }
 131                 in.close();
 132                 out.close();
 133                 if ((!jar.delete()) || (!fixedjar.renameTo(jar))) {
 134                     System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 135                 }
 136             } catch (java.lang.Exception e) {
 137                 System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);
 138                 e.printStackTrace();
 139             }
 140         }
 141     }
 142 
 143     static void setFinalStatic(Field field, Object newValue) throws Exception {
 144         setAccess(field);
 145         field.set(null, newValue);
 146     }
 147 
 148     private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {
 149         field.setAccessible(true);
 150         Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 151         modifiersField.setAccessible(true);
 152         modifiersField.setInt(field, field.getModifiers() &amp; (~Modifier.FINAL));
 153     }
 154 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  import org.apache.logging.log4j.core.util.Constants;







   2  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import java.io.FileInputStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import java.io.FileOutputStream;</span>
   6  import java.lang.reflect.Field;

   7  import java.lang.reflect.Method;
   8  import java.lang.reflect.Modifier;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 +import java.net.URL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 +import java.util.Base64;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import java.util.zip.ZipEntry;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 +import java.util.zip.ZipInputStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import java.util.zip.ZipOutputStream;</span>
  14  
  15  public class Log4jRCE {
  16      static {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +        Class&lt;?&gt; c = null;</span>
  18          try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  19 -            Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  19 -            Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.uðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +            System.out.println(&quot;Patching&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  22 +            c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  22 +            c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.ConstðŸ”µ</abbr></span>
  23              Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);
<abbr title="  24              System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  24              System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMðŸ”µ</abbr>
  25              setFinalStatic(field, Boolean.TRUE);









  26  
  27              //reconfiguring log4j
  28              ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
  29              Class&lt;?&gt; aClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);
  30              Method reconfigure = aClass.getMethod(&quot;reconfigure&quot;);
  31              reconfigure.invoke(null);































<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +        } catch (Throwable e) {</span>
  34              System.err.println(&quot;Exception &quot; + e);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +        // modify the log4j jar to fix the vuln</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +        if(c != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +            fullyVaccinate(c.getProtectionDomain().getCodeSource().getLocation());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +    private static void fullyVaccinate(URL jarfile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +        String path = jarfile.getFile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +        File jar = new File(path);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +        if(path.endsWith(&quot;.jar&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +                File fixedjar = new File(&quot;log4j.jar.tmp&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +                ZipInputStream in = new ZipInputStream(new FileInputStream(path));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +                ZipOutputStream out = new ZipOutputStream(new FileOutputStream(fixedjar));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +                ZipEntry entry;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +                while ((entry = in.getNextEntry()) != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +                    out.putNextEntry(new ZipEntry(entry.getName()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +                    if(entry.getName().equals(&quot;org/apache/logging/log4j/core/util/Constants.class&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  54 +                        // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default false)">  54 +                        // base64 of the patched class (FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS set to default falðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +                        // base64 is more compact than a byte array in source code.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +                        byte[] newClass = Base64.getDecoder().decode(&quot;&quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  57 +                                                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sb2c0ai9jb3JlL3V0aWwvQ29uc3RhbnRz&quot; +">  57 +                                                                     &quot;yv66vgAAADQAZAEALG9yZy9hcGFjaGUvbG9nZ2luZy9sðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  58 +                                                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0YW50cy5qYXZhAQAXTE9HNEpfTE9HX0VW&quot; +">  58 +                                                                     &quot;BwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEADkNvbnN0ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  59 +                                                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBABRMb2c0akxvZ0V2ZW50RmFjdG9yeQgA&quot; +">  59 +                                                                     &quot;RU5UX0ZBQ1RPUlkBABJMamF2YS9sYW5nL1N0cmluZzsBðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  60 +                                                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0akNvbnRleHRTZWxlY3RvcggACwEAGkxP&quot; +">  60 +                                                                     &quot;CAEAFkxPRzRKX0NPTlRFWFRfU0VMRUNUT1IBABRMb2c0ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  61 +                                                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEZWZhdWx0U3RhdHVzTGV2ZWwIAA4BABFK&quot; +">  61 +                                                                     &quot;RzRKX0RFRkFVTFRfU1RBVFVTX0xFVkVMAQAXTG9nNGpEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  62 +                                                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvbG9nNGovY29udGV4dC1uYW1lCAARAQAR&quot; +">  62 +                                                                     &quot;TkRJX0NPTlRFWFRfTkFNRQEAIGphdmE6Y29tcC9lbnYvðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  63 +                                                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNQVRfTUVTU0FHRVNfSU5fQkFDS0dST1VO&quot; +">  63 +                                                                     &quot;TUlMTElTX0lOX1NFQ09ORFMBAAFJAwAAA+gBAB1GT1JNðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  64 +                                                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9ESVNBQkxFX0xPT0tVUFMBAApJU19XRUJf&quot; +">  64 +                                                                     &quot;RAEAAVoBACdGT1JNQVRfTUVTU0FHRVNfUEFUVEVSTl9EðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  65 +                                                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMRV9ESVJFQ1RfRU5DT0RFUlMBAB1JTklU&quot; +">  65 +                                                                     &quot;QVBQAQATRU5BQkxFX1RIUkVBRExPQ0FMUwEAFkVOQUJMðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  66 +                                                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SRVVTQUJMRV9NRVNTQUdFX1NJWkUBABhF&quot; +">  66 +                                                                     &quot;SUFMX1JFVVNBQkxFX01FU1NBR0VfU0laRQEAGU1BWF9SðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  67 +                                                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSX0JZVEVfQlVGRkVSX1NJWkUBAARzaXpl&quot; +">  67 +                                                                     &quot;TkNPREVSX0NIQVJfQlVGRkVSX1NJWkUBABhFTkNPREVSðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  68 +                                                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlcnR5AQAMZGVmYXVsdFZhbHVlAQAsb3Jn&quot; +">  68 +                                                                     &quot;AQAWKExqYXZhL2xhbmcvU3RyaW5nO0kpSQEACHByb3BlðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  69 +                                                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWwHACQBAA1nZXRQcm9wZXJ0&quot; +">  69 +                                                                     &quot;L2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  70 +                                                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqL3V0aWwvUHJvcGVydGllc1V0aWw7DAAm&quot; +">  70 +                                                                     &quot;aWVzAQAwKClMb3JnL2FwYWNoZS9sb2dnaW5nL2xvZzRqðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  71 +                                                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhCgAlACsBAAY8aW5pdD4BAAMoKVYMAC0A&quot; +">  71 +                                                                     &quot;ACcKACUAKAEAEmdldEludGVnZXJQcm9wZXJ0eQwAKgAhðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  72 +                                                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpbmcvbG9nNGovY29yZS91dGlsL0NvbnN0&quot; +">  72 +                                                                     &quot;LgoABAAvAQAEdGhpcwEALkxvcmcvYXBhY2hlL2xvZ2dpðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  73 +                                                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tc2cuYXN5bmMIADQBABJnZXRCb29sZWFu&quot; +">  73 +                                                                     &quot;YW50czsBAAg8Y2xpbml0PgEAFmxvZzRqLmZvcm1hdC5tðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  74 +                                                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaDAA2ADcKACUAOAwAFgAXCQACADoBABls&quot; +">  74 +                                                                     &quot;UHJvcGVydHkBABYoTGphdmEvbGFuZy9TdHJpbmc7WilaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  75 +                                                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJAAIAPgEAJ29yZy9hcGFjaGUvbG9nZ2lu&quot; +">  75 +                                                                     &quot;b2c0ajIuZm9ybWF0TXNnTm9Mb29rdXBzCAA8DAAYABcJðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  76 +                                                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBAEIJAAIAQgwAGgAXCQBBAEUJAAIARQEA&quot; +">  76 +                                                                     &quot;Zy9sb2c0ai91dGlsL0NvbnN0YW50cwcAQAwAGQAXCQBBðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  77 +                                                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIDAAbABcJAAIASgEAHGxvZzRqLmluaXRp&quot; +">  77 +                                                                     &quot;HWxvZzRqMi5lbmFibGUuZGlyZWN0LmVuY29kZXJzCABIðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  78 +                                                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcABQJAAIAUAEAGGxvZzRqLm1heFJldXNh&quot; +">  78 +                                                                     &quot;YWxSZXVzYWJsZU1zZ1NpemUIAEwMACAAIQoAAgBODAAcðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  79 +                                                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lbmNvZGVyLmNoYXJCdWZmZXJTaXplCABW&quot; +">  79 +                                                                     &quot;YmxlTXNnU2l6ZQgAUgwAHQAUCQACAFQBABxsb2c0ai5lðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  80 +                                                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ZmZlclNpemUIAFoMAB8AFAkAAgBcAQAN&quot; +">  80 +                                                                     &quot;DAAeABQJAAIAWAEAHGxvZzRqLmVuY29kZXIuYnl0ZUJ1ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  81 +                                                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFi&quot; +">  81 +                                                                     &quot;Q29uc3RhbnRWYWx1ZQEABENvZGUBAA9MaW5lTnVtYmVyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  82 +                                                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQAxAAIABAAAAA4AGQAGAAcAAQBeAAAA&quot; +">  82 +                                                                     &quot;bGUBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  83 +                                                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACAA8AGQAQAAcAAQBeAAAAAgASABkAEwAU&quot; +">  83 +                                                                     &quot;AgAJABkACgAHAAEAXgAAAAIADAAZAA0ABwABAF4AAAACðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  84 +                                                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAAAAZABoAFwAAABkAGwAXAAAAGQAcABQA&quot; +">  84 +                                                                     &quot;AAEAXgAAAAIAFQAZABYAFwAAABkAGAAXAAAAGQAZABcAðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  85 +                                                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhAAIAXwAAAD0AAwACAAAACbgAKSobtgAs&quot; +">  85 +                                                                     &quot;AAAZAB0AFAAAABkAHgAUAAAAGQAfABQAAAADAAoAIAAhðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  86 +                                                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHAAAAAAAJACMAFAABAGIAAAAJAgAiABAA&quot; +">  86 +                                                                     &quot;rAAAAAIAYAAAAAYAAQAAAIwAYQAAABYAAgAAAAkAIgAHðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  87 +                                                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAAgBgAAAACgACAAAAkgAEAJMAYQAAAAwA&quot; +">  87 +                                                                     &quot;IwAQAAIALQAuAAEAXwAAADMAAQABAAAABSq3ADCxAAAAðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  88 +                                                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABduAApEjUDtgA5swA7uAApEj0EtgA5swA/&quot; +">  88 +                                                                     &quot;AQAAAAUAMQAyAAAACAAzAC4AAQBfAAAAlQADAAAAAABdðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  89 +                                                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zAFESUxECBrgAT7MAVRJXEQgAuABPswBZ&quot; +">  89 +                                                                     &quot;sgBDswBEsgBGswBHuAApEkkEtgA5swBLEk0RAIC4AE+zðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  90 +                                                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AGABHAB4AUQAkAF4AMABqADsAdQBGAH4A&quot; +">  90 +                                                                     &quot;ElsRIAC4AE+zAF2xAAAAAQBgAAAAJgAJAAAANgAMAD8AðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +                                                                     &quot;UQCIAAEAYwAAAAIABQ==&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                        out.write(newClass);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                    else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +                        byte[] buf = new byte[4096];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +                        int i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                        while ((i = in.read(buf)) &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                            out.write(buf, 0, i);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                    out.closeEntry();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                    in.closeEntry();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                in.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                out.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                if (!jar.delete() || !fixedjar.renameTo(jar)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                    System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +                System.err.println(&quot;Couldn&#x27;t patch jar.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                e.printStackTrace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            }</span>
 114          }
 115      }
 116  
 117      static void setFinalStatic(Field field, Object newValue) throws Exception {





 118          field.setAccessible(true);
 119          Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
 120          modifiersField.setAccessible(true);
 121          modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
 122          field.set(null, newValue);
 123      }
 124  }</pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -import org.apache.logging.log4j.core.util.Constants;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +import org.apache.logging.log4j.LogManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import org.apache.logging.log4j.core.LoggerContext;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import org.apache.logging.log4j.core.config.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import org.apache.logging.log4j.core.config.Configurator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 +import org.apache.logging.log4j.core.lookup.Interpolator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 +import org.apache.logging.log4j.core.lookup.StrLookup;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +import org.apache.logging.log4j.core.selector.ContextSelector;</span>
   9  



  10  import java.lang.reflect.Field;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 +import java.lang.reflect.Constructor;</span>
  12  import java.lang.reflect.Method;
  13  import java.lang.reflect.Modifier;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import java.util.HashMap;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import java.util.Map;</span>



  16  
  17  public class Log4jRCE {
  18      static {

  19          try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  20 -            Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  20 -            Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.uðŸ”µ</abbr></span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -            Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  22 -            System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS + &quot;\n&quot;);">  22 -            System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True, current value is &quot; + Constants.FORMðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -            setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +            try { // Try for versions of Log4j &gt;= 2.10</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  25 +              Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.core.util.Constants&quot;);">  25 +              Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(&quot;org.apache.logging.log4j.coreðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +              Field field = c.getField(&quot;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +              System.out.println(&quot;Setting &quot; + field.getName() + &quot; value to True&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +              setFinalStatic(field, Boolean.TRUE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +            } catch (NoSuchFieldException e) { // Fall back to older versions. Try to make JNDI non instantiable</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +                System.err.println(&quot;No field FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS - version &lt;= 2.9.0&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +                System.err.println(&quot;Will attempt to modify the configuration directly&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +            }</span>
  33  
  34              //reconfiguring log4j
  35              ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -            Class&lt;?&gt; aClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -            Method reconfigure = aClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -            reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  39 +            Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;);">  39 +            Class&lt;?&gt; configuratorClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.config.Configurator&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +                Method reconfigure = configuratorClass.getMethod(&quot;reconfigure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +                reconfigure.invoke(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +            } catch (Exception ex) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +                Method getFactoryMethod = configuratorClass.getDeclaredMethod(&quot;getFactory&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +                getFactoryMethod.setAccessible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +                Object factory = getFactoryMethod.invoke(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  47 +                Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;);">  47 +                Class&lt;?&gt; log4jContextFactoryClass = classLoader.loadClass(&quot;org.apache.logging.log4j.core.impl.Log4ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +                Method getSelector = log4jContextFactoryClass.getMethod(&quot;getSelector&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +                Object contextSelector = getSelector.invoke(factory, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +                ContextSelector ctxSelector = (ContextSelector) contextSelector;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +                for (LoggerContext ctx: ctxSelector.getLoggerContexts()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +                    ctx.reconfigure();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +                    System.err.println(&quot;Reconfiguring context&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +                    Configuration config = ctx.getConfiguration();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +                    StrLookup resolver = config.getStrSubstitutor().getVariableResolver();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +                    if (resolver instanceof Interpolator) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +                        System.err.println(&quot;Lookup is an Interpolator - attempting to remove JNDI&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +                        Field lookups = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +                        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +                            lookups = Interpolator.class.getDeclaredField(&quot;lookups&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +                        } catch (NoSuchFieldException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +                            lookups = Interpolator.class.getDeclaredField(&quot;strLookupMap&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +                        lookups.setAccessible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +                        Map&lt;String, StrLookup&gt; lookupMap = (Map&lt;String, StrLookup&gt;) lookups.get(resolver);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                        lookupMap.remove(&quot;jndi&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +            }</span>
  70          } catch (Exception e) {

  71              System.err.println(&quot;Exception &quot; + e);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +            e.printStackTrace();</span>














































































  73          }
  74      }
  75  
  76      static void setFinalStatic(Field field, Object newValue) throws Exception {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +        setAccess(field);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        field.set(null, newValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +    private static void setAccess(Field field) throws NoSuchFieldException, IllegalAccessException {</span>
  82          field.setAccessible(true);
  83          Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);
  84          modifiersField.setAccessible(true);
  85          modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        field.set(null, newValue);</span>
  87      }
  88  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            