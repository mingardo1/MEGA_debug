<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>480</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    480
                    <a href="479.html">prev</a>
                    <a href="481.html">next</a>
                    <a href="480_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:elasticsearch6/elasticsearch6-side/elasticsearch6-async-side/src/main/java/com/dtstack/flink/sql/side/elasticsearch6/Elasticsearch6AsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [b], [j]], subset: [[b], [bj], [b], [b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.elasticsearch6;
  20 
  21 import org.apache.flink.api.java.tuple.Tuple2;
  22 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  23 import org.apache.flink.configuration.Configuration;
  24 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  25 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.dtstack.flink.sql.enums.ECacheContentType;
  29 import com.dtstack.flink.sql.side.*;
  30 import com.dtstack.flink.sql.side.cache.CacheObj;
  31 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  32 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  33 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  34 import com.dtstack.flink.sql.util.ParseUtils;
  35 import com.google.common.collect.Lists;
  36 import org.apache.calcite.sql.SqlNode;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.elasticsearch.action.ActionListener;
  39 import org.elasticsearch.action.search.SearchRequest;
  40 import org.elasticsearch.action.search.SearchResponse;
  41 import org.elasticsearch.client.RequestOptions;
  42 import org.elasticsearch.client.RestHighLevelClient;
  43 import org.elasticsearch.index.query.BoolQueryBuilder;
  44 import org.elasticsearch.search.SearchHit;
  45 import org.elasticsearch.search.builder.SearchSourceBuilder;
  46 import org.elasticsearch.search.sort.SortOrder;
  47 import org.slf4j.Logger;
  48 import org.slf4j.LoggerFactory;
  49 
  50 import java.io.IOException;
  51 import java.io.Serializable;
  52 import java.sql.Timestamp;
  53 import java.util.List;
  54 import java.util.Map;
  55 
  56 /**
  57  * @author yinxi
  58  * @date 2020/2/13 - 13:10
  59  */
  60 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  61 
  62     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  63     private transient RestHighLevelClient rhlClient;
  64     private SearchRequest searchRequest;
  65     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  66 
<abbr title="  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  68         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  69         SqlNode conditionNode = joinInfo.getCondition();
  70         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  71     }
  72 
  73     @Override
  74     public void open(Configuration parameters) throws Exception {
  75         super.open(parameters);
<abbr title="  76         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();">  76         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo()🔵</abbr>
<abbr title="  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  78         searchRequest = Es6Util.setSearchRequest(sideInfo);
  79 
  80     }
  81 
  82 
  83     @Override
  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  85     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  85     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) th🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89             Object equalObj = copyInput.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91                 dealMissKey(copyInput, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96 </span>
  97 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                 dealMissKey(copyCrow, resultFuture);</span>
 110 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 111     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 111     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultF🔵</abbr></span>
 112 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 113         String key = buildCacheKey(inputParams);
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119                     dealMissKey(copyInput, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 123                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());"> 123                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getConten🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                         dealFillDataError(resultFuture, e, copyInput);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 129                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 129                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134 </span>
 135 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 161                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 161                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr></span>
 162 =======
 163 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 164         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 165         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 166         SearchSourceBuilder searchSourceBuilder = initConfiguration();
 167         searchSourceBuilder.query(boolQueryBuilder);
 168         searchRequest.source(searchSourceBuilder);
 169 
 170         // 异步查询数据
<abbr title=" 171         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 171         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
 172 
 173             //成功响应时
 174             @Override
 175             public void onResponse(SearchResponse searchResponse) {
 176 
 177                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
 178                 List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();
 179                 SearchHit[] searchHits = searchResponse.getHits().getHits();
 180                 if (searchHits.length &gt; 0) {
 181                     Elasticsearch6SideTableInfo tableInfo = null;
 182                     RestHighLevelClient tmpRhlClient = null;
 183                     try {
 184                         while (true) {
 185 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                             loadDataToCache(searchHits, rowList, cacheContent, copyInput);</span>
 187 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 192                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 192                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200         SearchSourceBuilder searchSourceBuilder = initConfiguration();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         searchSourceBuilder.query(boolQueryBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         // 异步查询数据</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 205         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 205         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             //成功响应时</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209             public void onResponse(SearchResponse searchResponse) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 List&lt;Object&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 SearchHit[] searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                 if (searchHits.length &gt; 0) {</span>
 215 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216                             loadDataToCache(searchHits, rowList, cacheContent, input);</span>
 217 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 218                             // determine if all results haven been ferched
 219                             if (searchHits.length &lt; getFetchSize()) {
 220                                 break;
 221                             }
 222                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 223                                 // create new connection to fetch data
 224                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 225                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 225                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 226                             }
<abbr title=" 227                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 227                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 228                             searchSourceBuilder.searchAfter(searchAfterParameter);
 229                             searchRequest.source(searchSourceBuilder);
 230                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 231                             searchHits = searchResponse.getHits().getHits();
 232                         }
<abbr title=" 233                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 233                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 234                         resultFuture.complete(rowList);
 235                     } catch (Exception e) {
 236 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237                         dealFillDataError(resultFuture, e, copyInput);</span>
 238 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239             //成功响应时</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241             public void onResponse(SearchResponse searchResponse) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                 List&lt;Object&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                 List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                 SearchHit[] searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246                 if (searchHits.length &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247                     Elasticsearch6SideTableInfo tableInfo = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248                     RestHighLevelClient tmpRhlClient = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                         while (true) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                             loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                             // determine if all results haven been ferched</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                             if (searchHits.length &lt; getFetchSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                                 // create new connection to fetch data</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 259                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 259                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 261                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 261                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                             searchSourceBuilder.searchAfter(searchAfterParameter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                             searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                             searchHits = searchResponse.getHits().getHits();</span>
 266 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                         dealFillDataError(input, resultFuture, e);</span>
 268 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 269                     } finally {
 270                         if (tmpRhlClient != null) {
 271                             try {
 272                                 tmpRhlClient.close();
 273                             } catch (IOException e) {
 274                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 275                             }
 276                         }
 277                     }
 278                 } else {
 279 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280                     dealMissKey(copyInput, resultFuture);</span>
 281 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282                         while (true) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                             loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                             // determine if all results haven been ferched</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                             if (searchHits.length &lt; getFetchSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                                 // create new connection to fetch data</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 291                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 291                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 293                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 293                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294                             searchSourceBuilder.searchAfter(searchAfterParameter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                             searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297                             searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 299                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 299                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                     } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                         if (tmpRhlClient != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306                                 tmpRhlClient.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307                             } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);</span>
 309 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                     dealMissKey(input, resultFuture);</span>
 311 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 312                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 313                 }
 314             }
 315 
 316             // 响应失败处理
 317             @Override
 318             public void onFailure(Exception e) {
 319                 LOG.error(&quot;&quot; + e);
 320                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 321             }
 322         });
 323     }
 324 
 325     @Override
 326     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 327         StringBuilder sb = new StringBuilder();
 328         for (Object ele : inputParams.values()) {
 329             sb.append(ele.toString())
 330                     .append(&quot;_&quot;);
 331         }
 332 
 333         return sb.toString();
 334     }
 335 
<abbr title=" 336     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 336     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; 🔵</abbr>
 337         List&lt;Object&gt; results = Lists.newArrayList();
 338         for (SearchHit searchHit : searchHits) {
 339             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 340             results.add(object);
 341         }
 342         rowList.addAll(getRows(copyCrow, cacheContent, results));
 343     }
 344 
<abbr title=" 345     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 345     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 346         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 347         for (Object line : results) {
 348             Row row = fillData(inputRow.f1, line);
 349             if (null != cacheContent &amp;&amp; openCache()) {
 350                 cacheContent.add(line);
 351             }
 352             rowList.add(Tuple2.of(inputRow.f0, row));
 353         }
 354         return rowList;
 355     }
 356 
 357     @Override
 358     public Row fillData(Row input, Object line) {
 359 
 360         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 361         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 362         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 363         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 364             Object obj = input.getField(entry.getValue());
<abbr title=" 365             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 365             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 366             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 367                 obj = ((Timestamp) obj).getTime();
 368             }
 369 
 370             row.setField(entry.getKey(), obj);
 371         }
 372 
 373         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 374             if (cacheInfo == null) {
 375                 row.setField(entry.getKey(), null);
 376             } else {
<abbr title=" 377                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 377                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 378                 row.setField(entry.getKey(), object);
 379             }
 380         }
 381 
 382         return row;
 383     }
 384 
 385     @Override
 386     public void close() throws Exception {
 387         super.close();
 388         if (rhlClient != null) {
 389             rhlClient.close();
 390         }
 391 
 392     }
 393 
 394     private SearchSourceBuilder initConfiguration() {
 395         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 396         searchSourceBuilder.size(getFetchSize());
 397         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 398         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 399         searchSourceBuilder.fetchSource(sideFieldNames, null);
 400 
 401         return searchSourceBuilder;
 402     }
 403 
<abbr title=" 404     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 404     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBu🔵</abbr>
 405         if (boolQueryBuilder == null) {
 406             boolQueryBuilder = new BoolQueryBuilder();
 407         }
 408 
 409         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 410             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 411             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 411             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 412             String condition = String.valueOf(inputParams.get(fieldName));
<abbr title=" 413             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 413             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 414         }
 415 
 416         return boolQueryBuilder;
 417     }
 418 
 419     public int getFetchSize() {
 420         return 1000;
 421     }
 422 }
 423 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.side.elasticsearch6;
  20 
  21 import org.apache.flink.api.java.tuple.Tuple2;
  22 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  23 import org.apache.flink.configuration.Configuration;
  24 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  25 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  26 import org.apache.flink.types.Row;
  27 
  28 import com.dtstack.flink.sql.enums.ECacheContentType;
  29 import com.dtstack.flink.sql.side.*;
  30 import com.dtstack.flink.sql.side.cache.CacheObj;
  31 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  32 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  33 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  34 import com.dtstack.flink.sql.util.ParseUtils;
  35 import com.google.common.collect.Lists;
  36 import org.apache.calcite.sql.SqlNode;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.elasticsearch.action.ActionListener;
  39 import org.elasticsearch.action.search.SearchRequest;
  40 import org.elasticsearch.action.search.SearchResponse;
  41 import org.elasticsearch.client.RequestOptions;
  42 import org.elasticsearch.client.RestHighLevelClient;
  43 import org.elasticsearch.index.query.BoolQueryBuilder;
  44 import org.elasticsearch.search.SearchHit;
  45 import org.elasticsearch.search.builder.SearchSourceBuilder;
  46 import org.elasticsearch.search.sort.SortOrder;
  47 import org.slf4j.Logger;
  48 import org.slf4j.LoggerFactory;
  49 
  50 import java.io.IOException;
  51 import java.io.Serializable;
  52 import java.sql.Timestamp;
  53 import java.util.List;
  54 import java.util.Map;
  55 
  56 /**
  57  * @author yinxi
  58  * @date 2020/2/13 - 13:10
  59  */
  60 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  61 
  62     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  63     private transient RestHighLevelClient rhlClient;
  64     private SearchRequest searchRequest;
  65     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  66 
<abbr title="  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  68         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  69         SqlNode conditionNode = joinInfo.getCondition();
  70         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  71     }
  72 
  73     @Override
  74     public void open(Configuration parameters) throws Exception {
  75         super.open(parameters);
<abbr title="  76         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();">  76         Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo()🔵</abbr>
<abbr title="  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  78         searchRequest = Es6Util.setSearchRequest(sideInfo);
  79 
  80     }
  81 
  82 
  83 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  85     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  85     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) th🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89             Object equalObj = copyInput.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91                 dealMissKey(copyInput, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102                     dealMissKey(copyInput, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 106                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());"> 106                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getConten🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                         dealFillDataError(resultFuture, e, copyInput);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 112                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 112                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         SearchSourceBuilder searchSourceBuilder = initConfiguration();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121         searchSourceBuilder.query(boolQueryBuilder);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122         searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         // 异步查询数据</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 125         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 125         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             //成功响应时</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129             public void onResponse(SearchResponse searchResponse) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 List&lt;Object&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                 List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133                 SearchHit[] searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 if (searchHits.length &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                     Elasticsearch6SideTableInfo tableInfo = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136                     RestHighLevelClient tmpRhlClient = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                         while (true) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                             loadDataToCache(searchHits, rowList, cacheContent, copyInput);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                             // determine if all results haven been ferched</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                             if (searchHits.length &lt; getFetchSize()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                                 break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145                                 // create new connection to fetch data</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 147                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 147                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 149                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 149                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                             searchSourceBuilder.searchAfter(searchAfterParameter);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                             searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                             searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 155                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 155                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                         dealFillDataError(resultFuture, e, copyInput);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                     } finally {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                         if (tmpRhlClient != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                             try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                                 tmpRhlClient.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                             } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                     dealMissKey(copyInput, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174             // 响应失败处理</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175             @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176             public void onFailure(Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                 LOG.error(&quot;&quot; + e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180         });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182     }</span>
 183 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 212                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 212                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         SearchSourceBuilder searchSourceBuilder = initConfiguration();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221         searchSourceBuilder.query(boolQueryBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222         searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         // 异步查询数据</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 225         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 225         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227             //成功响应时</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229             public void onResponse(SearchResponse searchResponse) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                 List&lt;Object&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                 List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                 SearchHit[] searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                 if (searchHits.length &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235                     Elasticsearch6SideTableInfo tableInfo = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                     RestHighLevelClient tmpRhlClient = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                         while (true) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                             loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                             // determine if all results haven been ferched</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                             if (searchHits.length &lt; getFetchSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                                 // create new connection to fetch data</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 247                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 247                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 249                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 249                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                             searchSourceBuilder.searchAfter(searchAfterParameter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                             searchRequest.source(searchSourceBuilder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                             searchHits = searchResponse.getHits().getHits();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 255                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 255                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259                     } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                         if (tmpRhlClient != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                                 tmpRhlClient.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                             } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274             // 响应失败处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276             public void onFailure(Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                 LOG.error(&quot;&quot; + e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282     }</span>
 283 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284 </span>
 285 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 286 
<abbr title=" 287     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 287     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; 🔵</abbr>
 288         List&lt;Object&gt; results = Lists.newArrayList();
 289         for (SearchHit searchHit : searchHits) {
 290             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 291             results.add(object);
 292         }
 293         rowList.addAll(getRows(copyCrow, cacheContent, results));
 294     }
 295 
<abbr title=" 296     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 296     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 297         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 298         for (Object line : results) {
 299             Row row = fillData(inputRow.f1, line);
 300             if (null != cacheContent &amp;&amp; openCache()) {
 301                 cacheContent.add(line);
 302             }
 303             rowList.add(Tuple2.of(inputRow.f0, row));
 304         }
 305         return rowList;
 306     }
 307 
 308 
 309     @Override
<abbr title=" 310     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 310     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultF🔵</abbr>
 311         String key = buildCacheKey(inputParams);
 312         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 313         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 314         SearchSourceBuilder searchSourceBuilder = initConfiguration();
 315         searchSourceBuilder.query(boolQueryBuilder);
 316         searchRequest.source(searchSourceBuilder);
 317 
 318         // 异步查询数据
<abbr title=" 319         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {"> 319         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
 320 
 321             //成功响应时
 322             @Override
 323             public void onResponse(SearchResponse searchResponse) {
 324 
 325                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
 326                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 327                 SearchHit[] searchHits = searchResponse.getHits().getHits();
 328                 if (searchHits.length &gt; 0) {
 329                     Elasticsearch6SideTableInfo tableInfo = null;
 330                     RestHighLevelClient tmpRhlClient = null;
 331                     try {
 332                         while (true) {
 333                             loadDataToCache(searchHits, rowList, cacheContent, input);
 334                             // determine if all results haven been ferched
 335                             if (searchHits.length &lt; getFetchSize()) {
 336                                 break;
 337                             }
 338                             if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 339                                 // create new connection to fetch data
 340                                 tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 341                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 341                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 342                             }
<abbr title=" 343                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 343                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 344                             searchSourceBuilder.searchAfter(searchAfterParameter);
 345                             searchRequest.source(searchSourceBuilder);
 346                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 347                             searchHits = searchResponse.getHits().getHits();
 348                         }
<abbr title=" 349                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 349                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 350                         resultFuture.complete(rowList);
 351                     } catch (Exception e) {
 352                         dealFillDataError(input, resultFuture, e);
 353                     } finally {
 354                         if (tmpRhlClient != null) {
 355                             try {
 356                                 tmpRhlClient.close();
 357                             } catch (IOException e) {
 358                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 359                             }
 360                         }
 361                     }
 362                 } else {
 363                     dealMissKey(input, resultFuture);
 364                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 365                 }
 366             }
 367 
 368             // 响应失败处理
 369             @Override
 370             public void onFailure(Exception e) {
 371                 LOG.error(&quot;&quot; + e);
 372                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 373             }
 374         });
 375     }
 376 
 377     @Override
 378     public Row fillData(Row input, Object line) {
 379 
 380         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 381         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 382         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 383         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 384             Object obj = input.getField(entry.getValue());
<abbr title=" 385             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 385             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 386             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 387                 obj = ((Timestamp) obj).getTime();
 388             }
 389 
 390             row.setField(entry.getKey(), obj);
 391         }
 392 
 393         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 394             if (cacheInfo == null) {
 395                 row.setField(entry.getKey(), null);
 396             } else {
<abbr title=" 397                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 397                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 398                 row.setField(entry.getKey(), object);
 399             }
 400         }
 401 
 402         return row;
 403     }
 404 
 405     @Override
 406     public void close() throws Exception {
 407         super.close();
 408         if (rhlClient != null) {
 409             rhlClient.close();
 410         }
 411 
 412     }
 413 
 414     @Override
 415     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 416         StringBuilder sb = new StringBuilder();
 417         for (Object ele : inputParams.values()) {
 418             sb.append(ele.toString())
 419                     .append(&quot;_&quot;);
 420         }
 421 
 422         return sb.toString();
 423     }
 424 
 425     private SearchSourceBuilder initConfiguration() {
 426         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 427         searchSourceBuilder.size(getFetchSize());
 428         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 429         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 430         searchSourceBuilder.fetchSource(sideFieldNames, null);
 431 
 432         return searchSourceBuilder;
 433     }
 434 
<abbr title=" 435     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 435     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBu🔵</abbr>
 436         if (boolQueryBuilder == null) {
 437             boolQueryBuilder = new BoolQueryBuilder();
 438         }
 439 
 440         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 441             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 442             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 442             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 443             String condition = String.valueOf(inputParams.get(fieldName));
<abbr title=" 444             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 444             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 445         }
 446 
 447         return boolQueryBuilder;
 448     }
 449 
 450     public int getFetchSize() {
 451         return 1000;
 452     }
 453 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.elasticsearch6;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.side.*;
  22 import com.dtstack.flink.sql.side.cache.CacheObj;
  23 import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  24 import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  25 import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  26 import com.dtstack.flink.sql.util.ParseUtils;
  27 import com.google.common.collect.Lists;
  28 import java.io.IOException;
  29 import java.io.Serializable;
  30 import java.sql.Timestamp;
  31 import java.util.List;
  32 import java.util.Map;
  33 import org.apache.calcite.sql.SqlNode;
  34 import org.apache.commons.lang3.StringUtils;
  35 import org.apache.flink.api.java.tuple.Tuple2;
  36 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  37 import org.apache.flink.configuration.Configuration;
  38 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  39 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  40 import org.apache.flink.types.Row;
  41 import org.elasticsearch.action.ActionListener;
  42 import org.elasticsearch.action.search.SearchRequest;
  43 import org.elasticsearch.action.search.SearchResponse;
  44 import org.elasticsearch.client.RequestOptions;
  45 import org.elasticsearch.client.RestHighLevelClient;
  46 import org.elasticsearch.index.query.BoolQueryBuilder;
  47 import org.elasticsearch.search.SearchHit;
  48 import org.elasticsearch.search.builder.SearchSourceBuilder;
  49 import org.elasticsearch.search.sort.SortOrder;
  50 import org.slf4j.Logger;
  51 import org.slf4j.LoggerFactory;
  52 
  53 
  54 /**
  55  * @author yinxi
  56  * @date 2020/2/13 - 13:10
  57  */
  58 public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  59     private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  60 
  61     private transient RestHighLevelClient rhlClient;
  62 
  63     private SearchRequest searchRequest;
  64 
  65     private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  66 
<abbr title="  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  67     public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outField🔵</abbr>
  68         super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  69         SqlNode conditionNode = joinInfo.getCondition();
  70         ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  71     }
  72 
  73     @Override
  74     public void open(Configuration parameters) throws Exception {
  75         super.open(parameters);
<abbr title="  76         Elasticsearch6SideTableInfo tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()));">  76         Elasticsearch6SideTableInfo tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo🔵</abbr>
<abbr title="  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  77         rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserNa🔵</abbr>
  78         searchRequest = Es6Util.setSearchRequest(sideInfo);
  79     }
  80 
  81     @Override
<abbr title="  82     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) throws Exception {">  82     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFutu🔵</abbr>
  83         String key = buildCacheKey(inputParams);
  84         BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
  85         boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
  86         SearchSourceBuilder searchSourceBuilder = initConfiguration();
  87         searchSourceBuilder.query(boolQueryBuilder);
  88         searchRequest.source(searchSourceBuilder);
  89         // 异步查询数据
<abbr title="  90         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {">  90         rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;()🔵</abbr>
  91             //成功响应时
  92             @Override
  93             public void onResponse(SearchResponse searchResponse) {
  94                 List&lt;Object&gt; cacheContent = Lists.newArrayList();
  95                 List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
  96                 SearchHit[] searchHits = searchResponse.getHits().getHits();
  97                 if (searchHits.length &gt; 0) {
  98                     Elasticsearch6SideTableInfo tableInfo = null;
  99                     RestHighLevelClient tmpRhlClient = null;
 100                     try {
 101                         while (true) {
 102                             loadDataToCache(searchHits, rowList, cacheContent, input);
 103                             // determine if all results haven been ferched
 104                             if (searchHits.length &lt; getFetchSize()) {
 105                                 break;
 106                             }
 107                             if ((tableInfo == null) &amp;&amp; (tmpRhlClient == null)) {
 108                                 // create new connection to fetch data
<abbr title=" 109                                 tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()));"> 109                                 tableInfo = ((Elasticsearch6SideTableInfo) (sideInfo.getSideTableInfo()))🔵</abbr>
<abbr title=" 110                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 110                                 tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuth🔵</abbr>
 111                             }
<abbr title=" 112                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();"> 112                             Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValu🔵</abbr>
 113                             searchSourceBuilder.searchAfter(searchAfterParameter);
 114                             searchRequest.source(searchSourceBuilder);
 115                             searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 116                             searchHits = searchResponse.getHits().getHits();
 117                         }
<abbr title=" 118                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 118                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConte🔵</abbr>
 119                         resultFuture.complete(rowList);
 120                     } catch (java.lang.Exception e) {
 121                         dealFillDataError(input, resultFuture, e);
 122                     } finally {
 123                         if (tmpRhlClient != null) {
 124                             try {
 125                                 tmpRhlClient.close();
 126                             } catch (IOException e) {
 127                                 LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 128                             }
 129                         }
 130                     }
 131                 } else {
 132                     dealMissKey(input, resultFuture);
 133                     dealCacheData(key, CacheMissVal.getMissKeyObj());
 134                 }
 135             }
 136 
 137             // 响应失败处理
 138             @Override
 139             public void onFailure(Exception e) {
 140                 LOG.error(&quot;&quot; + e);
 141                 resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 142             }
 143         });
 144     }
 145 
 146     @Override
 147     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 148         StringBuilder sb = new StringBuilder();
 149         for (Object ele : inputParams.values()) {
 150             sb.append(ele.toString()).append(&quot;_&quot;);
 151         }
 152         return sb.toString();
 153     }
 154 
<abbr title=" 155     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean, Row&gt; copyCrow) {"> 155     private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList, List&lt;Object&gt;🔵</abbr>
 156         List&lt;Object&gt; results = Lists.newArrayList();
 157         for (SearchHit searchHit : searchHits) {
 158             Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 159             results.add(object);
 160         }
 161         rowList.addAll(getRows(copyCrow, cacheContent, results));
 162     }
 163 
<abbr title=" 164     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 164     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent🔵</abbr>
 165         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 166         for (Object line : results) {
 167             Row row = fillData(inputRow.f1, line);
 168             if ((null != cacheContent) &amp;&amp; openCache()) {
 169                 cacheContent.add(line);
 170             }
 171             rowList.add(Tuple2.of(inputRow.f0, row));
 172         }
 173         return rowList;
 174     }
 175 
 176     @Override
 177     public Row fillData(Row input, Object line) {
 178         Map&lt;String, Object&gt; cacheInfo = ((Map&lt;String, Object&gt;) (line));
 179         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 180         String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 181         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 182             Object obj = input.getField(entry.getValue());
<abbr title=" 183             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 183             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRo🔵</abbr>
 184             if ((obj instanceof Timestamp) &amp;&amp; isTimeIndicatorTypeInfo) {
 185                 obj = ((Timestamp) (obj)).getTime();
 186             }
 187             row.setField(entry.getKey(), obj);
 188         }
 189         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 190             if (cacheInfo == null) {
 191                 row.setField(entry.getKey(), null);
 192             } else {
<abbr title=" 193                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 193                 Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(e🔵</abbr>
 194                 row.setField(entry.getKey(), object);
 195             }
 196         }
 197         return row;
 198     }
 199 
 200     @Override
 201     public void close() throws Exception {
 202         super.close();
 203         if (rhlClient != null) {
 204             rhlClient.close();
 205         }
 206     }
 207 
 208     private SearchSourceBuilder initConfiguration() {
 209         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 210         searchSourceBuilder.size(getFetchSize());
 211         searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 212         String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 213         searchSourceBuilder.fetchSource(sideFieldNames, null);
 214         return searchSourceBuilder;
 215     }
 216 
<abbr title=" 217     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {"> 217     private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBu🔵</abbr>
 218         if (boolQueryBuilder == null) {
 219             boolQueryBuilder = new BoolQueryBuilder();
 220         }
 221         for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 222             String fieldName = sideInfo.getEqualFieldList().get(i);
<abbr title=" 223             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));"> 223             String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldNam🔵</abbr>
 224             String condition = String.valueOf(inputParams.get(fieldName));
<abbr title=" 225             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 225             boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, ope🔵</abbr>
 226         }
 227         return boolQueryBuilder;
 228     }
 229 
 230     public int getFetchSize() {
 231         return 1000;
 232     }
 233 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.elasticsearch6;
  20  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.side.AbstractSideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.side.BaseAsyncReqRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.side.CacheMissVal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.side.FieldInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.side.JoinInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.dtstack.flink.sql.side.PredicateInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  28  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.table.runtime.types.CRow;</span>
  32  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  33  import org.apache.flink.types.Row;
  34  
  35  import com.dtstack.flink.sql.enums.ECacheContentType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import com.dtstack.flink.sql.side.*;</span>
  37  import com.dtstack.flink.sql.side.cache.CacheObj;
  38  import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  39  import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  40  import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  41  import com.dtstack.flink.sql.util.ParseUtils;
  42  import com.google.common.collect.Lists;
  43  import org.apache.calcite.sql.SqlNode;
  44  import org.apache.commons.lang3.StringUtils;
  45  import org.elasticsearch.action.ActionListener;
  46  import org.elasticsearch.action.search.SearchRequest;
  47  import org.elasticsearch.action.search.SearchResponse;
  48  import org.elasticsearch.client.RequestOptions;
  49  import org.elasticsearch.client.RestHighLevelClient;
  50  import org.elasticsearch.index.query.BoolQueryBuilder;
  51  import org.elasticsearch.search.SearchHit;
  52  import org.elasticsearch.search.builder.SearchSourceBuilder;
  53  import org.elasticsearch.search.sort.SortOrder;
  54  import org.slf4j.Logger;
  55  import org.slf4j.LoggerFactory;
  56  
  57  import java.io.IOException;
  58  import java.io.Serializable;
  59  import java.sql.Timestamp;
  60  import java.util.List;
  61  import java.util.Map;
  62  
  63  /**
  64   * @author yinxi
  65   * @date 2020/2/13 - 13:10
  66   */
  67  public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  68  
  69      private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  70      private transient RestHighLevelClient rhlClient;
  71      private SearchRequest searchRequest;
  72      private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  73  
<abbr title="  74      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  74      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,🔵</abbr>
  75          super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  76          SqlNode conditionNode = joinInfo.getCondition();
  77          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  78      }
  79  
  80      @Override
  81      public void open(Configuration parameters) throws Exception {
  82          super.open(parameters);
  83          Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title="  84          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  84          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tab🔵</abbr>
  85          searchRequest = Es6Util.setSearchRequest(sideInfo);
  86  
  87      }
  88  
  89  
  90      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  93 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {">  93 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exce🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        Tuple2&lt;Boolean,Row&gt; copyInput= Tuple2.of(input.f0,input.f1);</span>
  95          List&lt;Object&gt; inputParams = Lists.newArrayList();
  96          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +            Object equalObj = copyInput.f1.getField(conValIndex);</span>
  99              if (equalObj == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -                dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                dealMissKey(copyInput, resultFuture);</span>
 102                  return;
 103              }
 104              inputParams.add(equalObj);
 105          }
 106  

 107          String key = buildCacheKey(inputParams);
 108          if (openCache()) {
 109              CacheObj val = getFromCache(key);
 110              if (val != null) {
 111                  if (ECacheContentType.MissVal == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                    dealMissKey(copyInput, resultFuture);</span>
 114                      return;
 115                  } else if (ECacheContentType.MultiLine == val.getType()) {
 116                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(copyInput, null, (List) val.getContent());</span>
 119                          resultFuture.complete(rowList);
 120                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                        dealFillDataError(resultFuture, e, copyInput);</span>
 123                      }
 124                  } else {
<abbr title=" 125                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 125                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.ge🔵</abbr>
 126                  }
 127                  return;
 128              }
 129          }
 130  
 131          BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 132          boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 133          SearchSourceBuilder searchSourceBuilder = initConfiguration();
 134          searchSourceBuilder.query(boolQueryBuilder);
 135          searchRequest.source(searchSourceBuilder);
 136  
 137          // 异步查询数据
 138          rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {
 139  
 140              //成功响应时
 141              @Override
 142              public void onResponse(SearchResponse searchResponse) {
 143  
 144                  List&lt;Object&gt; cacheContent = Lists.newArrayList();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = Lists.newArrayList();</span>
 147                  SearchHit[] searchHits = searchResponse.getHits().getHits();
 148                  if (searchHits.length &gt; 0) {
 149                      Elasticsearch6SideTableInfo tableInfo = null;
 150                      RestHighLevelClient tmpRhlClient = null;
 151                      try {
 152                          while (true) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                            loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                            loadDataToCache(searchHits, rowList, cacheContent, copyInput);</span>
 155                              // determine if all results haven been ferched
 156                              if (searchHits.length &lt; getFetchSize()) {
 157                                  break;
 158                              }
 159                              if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 160                                  // create new connection to fetch data
 161                                  tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 162                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 162                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), t🔵</abbr>
 163                              }
 164                              Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();
 165                              searchSourceBuilder.searchAfter(searchAfterParameter);
 166                              searchRequest.source(searchSourceBuilder);
 167                              searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 168                              searchHits = searchResponse.getHits().getHits();
 169                          }
 170                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 171                          resultFuture.complete(rowList);
 172                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                        dealFillDataError(resultFuture, e, copyInput);</span>
 175                      } finally {
 176                          if (tmpRhlClient != null) {
 177                              try {
 178                                  tmpRhlClient.close();
 179                              } catch (IOException e) {
 180                                  LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 181                              }
 182                          }
 183                      }
 184                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                    dealMissKey(copyInput, resultFuture);</span>
 187                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 188                  }
 189              }
 190  
 191              // 响应失败处理
 192              @Override
 193              public void onFailure(Exception e) {
 194                  LOG.error(&quot;&quot; + e);
 195                  resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 196              }
 197          });
 198  











 199      }
 200  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 201 -    private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyCrow) {"> 201 -    private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyC🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 202 +    private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheContent, Tuple2&lt;Boolean,Row&gt; copyCrow) {"> 202 +    private void loadDataToCache(SearchHit[] searchHits, List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList, List&lt;Object&gt; cacheCont🔵</abbr></span>
 203          List&lt;Object&gt; results = Lists.newArrayList();
 204          for (SearchHit searchHit : searchHits) {
 205              Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 206              results.add(object);
 207          }
 208          rowList.addAll(getRows(copyCrow, cacheContent, results));
 209      }
 210  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 213 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {"> 213 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;Object&gt; cacheContent, List&lt;Ob🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +        List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
 215          for (Object line : results) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            Row row = fillData(inputRow.f1, line);</span>
 218              if (null != cacheContent &amp;&amp; openCache()) {
 219                  cacheContent.add(line);
 220              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -            rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            rowList.add(Tuple2.of(inputRow.f0, row));</span>
 223          }
 224          return rowList;
 225      }
 226  
 227      @Override
 228      public Row fillData(Row input, Object line) {
 229  
 230          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 231          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 232          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 233          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 234              Object obj = input.getField(entry.getValue());
<abbr title=" 235              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 235              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr>
 236              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 237                  obj = ((Timestamp) obj).getTime();
 238              }
 239  
 240              row.setField(entry.getKey(), obj);
 241          }
 242  
 243          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 244              if (cacheInfo == null) {
 245                  row.setField(entry.getKey(), null);
 246              } else {
<abbr title=" 247                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 247                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getK🔵</abbr>
 248                  row.setField(entry.getKey(), object);
 249              }
 250          }
 251  
 252          return row;
 253      }
 254  
 255      @Override
 256      public void close() throws Exception {
 257          super.close();
 258          if (rhlClient != null) {
 259              rhlClient.close();
 260          }
 261  
 262      }
 263  
 264      public String buildCacheKey(List equalValList) {
 265          StringBuilder sb = new StringBuilder();
 266          for (Object ele : equalValList) {
 267              sb.append(ele.toString())
 268                      .append(&quot;_&quot;);
 269          }
 270  
 271          return sb.toString();
 272      }
 273  
 274      private SearchSourceBuilder initConfiguration() {
 275          SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 276          searchSourceBuilder.size(getFetchSize());
 277          searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 278          String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 279          searchSourceBuilder.fetchSource(sideFieldNames, null);
 280  
 281          return searchSourceBuilder;
 282      }
 283  
 284      private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {

 285          if (boolQueryBuilder == null) {
 286              boolQueryBuilder = new BoolQueryBuilder();
 287          }
 288  
 289          for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 290              String fieldName = sideInfo.getEqualFieldList().get(i);
 291              String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));
 292              String condition = String.valueOf(inputParams.get(i));

<abbr title=" 293              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 293              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind🔵</abbr>
 294          }
 295  
 296          return boolQueryBuilder;
 297      }
 298  
 299      public int getFetchSize() {
 300          return 1000;
 301      }
 302  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.elasticsearch6;
  20  
  21  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  22  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23  import com.dtstack.flink.sql.side.CacheMissVal;
  24  import com.dtstack.flink.sql.side.FieldInfo;
  25  import com.dtstack.flink.sql.side.JoinInfo;
  26  import com.dtstack.flink.sql.side.PredicateInfo;

  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.configuration.Configuration;
  29  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  30  import org.apache.flink.table.runtime.types.CRow;
  31  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  32  import org.apache.flink.types.Row;
  33  
  34  import com.dtstack.flink.sql.enums.ECacheContentType;

  35  import com.dtstack.flink.sql.side.cache.CacheObj;
  36  import com.dtstack.flink.sql.side.elasticsearch6.table.Elasticsearch6SideTableInfo;
  37  import com.dtstack.flink.sql.side.elasticsearch6.util.Es6Util;
  38  import com.dtstack.flink.sql.side.elasticsearch6.util.SwitchUtil;
  39  import com.dtstack.flink.sql.util.ParseUtils;
  40  import com.google.common.collect.Lists;
  41  import org.apache.calcite.sql.SqlNode;
  42  import org.apache.commons.lang3.StringUtils;
  43  import org.elasticsearch.action.ActionListener;
  44  import org.elasticsearch.action.search.SearchRequest;
  45  import org.elasticsearch.action.search.SearchResponse;
  46  import org.elasticsearch.client.RequestOptions;
  47  import org.elasticsearch.client.RestHighLevelClient;
  48  import org.elasticsearch.index.query.BoolQueryBuilder;
  49  import org.elasticsearch.search.SearchHit;
  50  import org.elasticsearch.search.builder.SearchSourceBuilder;
  51  import org.elasticsearch.search.sort.SortOrder;
  52  import org.slf4j.Logger;
  53  import org.slf4j.LoggerFactory;
  54  
  55  import java.io.IOException;
  56  import java.io.Serializable;
  57  import java.sql.Timestamp;
  58  import java.util.List;
  59  import java.util.Map;
  60  
  61  /**
  62   * @author yinxi
  63   * @date 2020/2/13 - 13:10
  64   */
  65  public class Elasticsearch6AsyncReqRow extends BaseAsyncReqRow implements Serializable {
  66  
  67      private static final Logger LOG = LoggerFactory.getLogger(Elasticsearch6AsyncReqRow.class);
  68      private transient RestHighLevelClient rhlClient;
  69      private SearchRequest searchRequest;
  70      private List&lt;String&gt; sqlJoinCompareOperate = Lists.newArrayList();
  71  
<abbr title="  72      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  72      public Elasticsearch6AsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,🔵</abbr>
  73          super(new Elasticsearch6AsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  74          SqlNode conditionNode = joinInfo.getCondition();
  75          ParseUtils.parseJoinCompareOperate(conditionNode, sqlJoinCompareOperate);
  76      }
  77  
  78      @Override
  79      public void open(Configuration parameters) throws Exception {
  80          super.open(parameters);
  81          Elasticsearch6SideTableInfo tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title="  82          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());">  82          rhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tab🔵</abbr>
  83          searchRequest = Es6Util.setSearchRequest(sideInfo);
  84  
  85      }
  86  
  87  
  88      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        CRow copyCrow = new CRow(input.row(), input.change());</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -                dealMissKey(copyCrow, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -            inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 101 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 101 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) th🔵</abbr></span>
 102          String key = buildCacheKey(inputParams);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                    dealMissKey(copyCrow, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -                        resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -                        dealFillDataError(resultFuture, e, copyCrow);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 117 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 117 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.ge🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
 123          BoolQueryBuilder boolQueryBuilder = Es6Util.setPredicateclause(sideInfo);
 124          boolQueryBuilder = setInputParams(inputParams, boolQueryBuilder);
 125          SearchSourceBuilder searchSourceBuilder = initConfiguration();
 126          searchSourceBuilder.query(boolQueryBuilder);
 127          searchRequest.source(searchSourceBuilder);
 128  
 129          // 异步查询数据
 130          rhlClient.searchAsync(searchRequest, RequestOptions.DEFAULT, new ActionListener&lt;SearchResponse&gt;() {
 131  
 132              //成功响应时
 133              @Override
 134              public void onResponse(SearchResponse searchResponse) {
 135  
 136                  List&lt;Object&gt; cacheContent = Lists.newArrayList();
 137                  List&lt;CRow&gt; rowList = Lists.newArrayList();

 138                  SearchHit[] searchHits = searchResponse.getHits().getHits();
 139                  if (searchHits.length &gt; 0) {
 140                      Elasticsearch6SideTableInfo tableInfo = null;
 141                      RestHighLevelClient tmpRhlClient = null;
 142                      try {
 143                          while (true) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                            loadDataToCache(searchHits, rowList, cacheContent, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                            loadDataToCache(searchHits, rowList, cacheContent, input);</span>
 146                              // determine if all results haven been ferched
 147                              if (searchHits.length &lt; getFetchSize()) {
 148                                  break;
 149                              }
 150                              if (tableInfo == null &amp;&amp; tmpRhlClient == null) {
 151                                  // create new connection to fetch data
 152                                  tableInfo = (Elasticsearch6SideTableInfo) sideInfo.getSideTableInfo();
<abbr title=" 153                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), tableInfo.getUserName(), tableInfo.getPassword());"> 153                                  tmpRhlClient = Es6Util.getClient(tableInfo.getAddress(), tableInfo.isAuthMesh(), t🔵</abbr>
 154                              }
 155                              Object[] searchAfterParameter = searchHits[searchHits.length - 1].getSortValues();
 156                              searchSourceBuilder.searchAfter(searchAfterParameter);
 157                              searchRequest.source(searchSourceBuilder);
 158                              searchResponse = tmpRhlClient.search(searchRequest, RequestOptions.DEFAULT);
 159                              searchHits = searchResponse.getHits().getHits();
 160                          }
 161                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 162                          resultFuture.complete(rowList);
 163                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                        dealFillDataError(input, resultFuture, e);</span>
 166                      } finally {
 167                          if (tmpRhlClient != null) {
 168                              try {
 169                                  tmpRhlClient.close();
 170                              } catch (IOException e) {
 171                                  LOG.warn(&quot;Failed to shut down tmpRhlClient.&quot;, e);
 172                              }
 173                          }
 174                      }
 175                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                    dealMissKey(input, resultFuture);</span>
 178                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 179                  }
 180              }
 181  
 182              // 响应失败处理
 183              @Override
 184              public void onFailure(Exception e) {
 185                  LOG.error(&quot;&quot; + e);
 186                  resultFuture.completeExceptionally(new RuntimeException(&quot;Response failed!&quot;));
 187              }
 188          });
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +        for (Object ele : inputParams.values()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +            sb.append(ele.toString())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +        return sb.toString();</span>
 201      }
 202  
<abbr title=" 203      private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyCrow) {"> 203      private void loadDataToCache(SearchHit[] searchHits, List&lt;CRow&gt; rowList, List&lt;Object&gt; cacheContent, CRow copyC🔵</abbr>

 204          List&lt;Object&gt; results = Lists.newArrayList();
 205          for (SearchHit searchHit : searchHits) {
 206              Map&lt;String, Object&gt; object = searchHit.getSourceAsMap();
 207              results.add(object);
 208          }
 209          rowList.addAll(getRows(copyCrow, cacheContent, results));
 210      }
 211  
 212      protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;Object&gt; cacheContent, List&lt;Object&gt; results) {
 213          List&lt;CRow&gt; rowList = Lists.newArrayList();


 214          for (Object line : results) {
 215              Row row = fillData(inputRow.row(), line);

 216              if (null != cacheContent &amp;&amp; openCache()) {
 217                  cacheContent.add(line);
 218              }
 219              rowList.add(new CRow(row, inputRow.change()));

 220          }
 221          return rowList;
 222      }
 223  
 224      @Override
 225      public Row fillData(Row input, Object line) {
 226  
 227          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) line;
 228          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 229          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 230          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 231              Object obj = input.getField(entry.getValue());
<abbr title=" 232              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 232              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo🔵</abbr>
 233              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 234                  obj = ((Timestamp) obj).getTime();
 235              }
 236  
 237              row.setField(entry.getKey(), obj);
 238          }
 239  
 240          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 241              if (cacheInfo == null) {
 242                  row.setField(entry.getKey(), null);
 243              } else {
<abbr title=" 244                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getKey())), fields[entry.getValue()]);"> 244                  Object object = SwitchUtil.getTarget(cacheInfo.get(sideInfo.getSideFieldNameIndex().get(entry.getK🔵</abbr>
 245                  row.setField(entry.getKey(), object);
 246              }
 247          }
 248  
 249          return row;
 250      }
 251  
 252      @Override
 253      public void close() throws Exception {
 254          super.close();
 255          if (rhlClient != null) {
 256              rhlClient.close();
 257          }
 258  
 259      }
 260  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -    public String buildCacheKey(List equalValList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -        for (Object ele : equalValList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -            sb.append(ele.toString())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -</span>
 271      private SearchSourceBuilder initConfiguration() {
 272          SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
 273          searchSourceBuilder.size(getFetchSize());
 274          searchSourceBuilder.sort(&quot;_id&quot;, SortOrder.DESC);
 275          String[] sideFieldNames = StringUtils.split(sideInfo.getSideSelectFields().trim(), &quot;,&quot;);
 276          searchSourceBuilder.fetchSource(sideFieldNames, null);
 277  
 278          return searchSourceBuilder;
 279      }
 280  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -    private BoolQueryBuilder setInputParams(List&lt;Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +    private BoolQueryBuilder setInputParams(Map&lt;String, Object&gt; inputParams, BoolQueryBuilder boolQueryBuilder) {</span>
 283          if (boolQueryBuilder == null) {
 284              boolQueryBuilder = new BoolQueryBuilder();
 285          }
 286  
 287          for (int i = 0; i &lt; sqlJoinCompareOperate.size(); i++) {
 288              String fieldName = sideInfo.getEqualFieldList().get(i);
 289              String operatorKind = sqlJoinCompareOperate.get(sideInfo.getEqualFieldList().indexOf(fieldName));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -            String condition = String.valueOf(inputParams.get(i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +            String condition = String.valueOf(inputParams.get(fieldName));</span>
<abbr title=" 292              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind, null, fieldName, condition), sideInfo);"> 292              boolQueryBuilder = Es6Util.buildFilterCondition(boolQueryBuilder, new PredicateInfo(null, operatorKind🔵</abbr>
 293          }
 294  
 295          return boolQueryBuilder;
 296      }
 297  
 298      public int getFetchSize() {
 299          return 1000;
 300      }
 301  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            