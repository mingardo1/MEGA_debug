<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>477</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    477
                    <a href="476.html">prev</a>
                    <a href="478.html">next</a>
                    <a href="477_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_cb68efb9e51ba697e771581059b9c11c3fe66ccb_launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cb68efb9e51ba697e771581059b9c11c3fe66ccb:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cb68efb9e51ba697e771581059b9c11c3fe66ccb^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cb68efb9e51ba697e771581059b9c11c3fe66ccb^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;828062ef514a8028632086b1c19ef248140da519:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  68     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  68     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  85     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  85     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  88         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  89         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 132         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 132         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 133         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 133         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 142         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 142         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 143         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 }</span>
 164 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 231     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 231     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 248     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 248     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249             throws MalformedURLException, UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 251         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 251         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 252         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 252         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286         // add  user customized file to shipfile</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         if (!StringUtils.isBlank(launcherOptions.getAddShipfile())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288             List&lt;String&gt; paths = ConfigParseUtil.parsePathFromStr(launcherOptions.getAddShipfile());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289             paths.forEach(path -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 shipFiles.add(new File(path));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291             });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 304         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 304         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 305         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 305         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 314         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 314         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 315         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 }</span>
 336 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  69     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  69     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  86     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  86     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  89         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  89         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  90         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  90         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 133         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 133         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 134         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 143         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 144         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 }</span>
 165 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 232     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 232     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 249     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 249     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250             throws MalformedURLException, UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 252         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 252         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 253         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 253         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         // add  user customized file to shipfile</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         if (!StringUtils.isBlank(launcherOptions.getAddShipfile())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289             List&lt;String&gt; paths = ConfigParseUtil.parsePathFromStr(launcherOptions.getAddShipfile());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290             paths.forEach(path -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291                 shipFiles.add(new File(path));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292             });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 305         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 305         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 306         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 306         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 315         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 316         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 316         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 }</span>
 337 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import java.io.UnsupportedEncodingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  72     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  72     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  89     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  89     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90             throws MalformedURLException, UnsupportedEncodingException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  92         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  92         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  93         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  93         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         // add  user customized file to shipfile</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         if (!StringUtils.isBlank(launcherOptions.getAddShipfile())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129             List&lt;String&gt; paths = ConfigParseUtil.parsePathFromStr(launcherOptions.getAddShipfile());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130             paths.forEach(path -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131                 shipFiles.add(new File(path));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 146         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 146         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 155         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 155         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 156         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 156         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176 }</span>
 177 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.io.File;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 - * Reason:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 - * Date: 2018/11/16</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 - * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 - * @author xuchao</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -    private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -    private YarnClient yarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -    private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -    private Configuration flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -        if(Strings.isNullOrEmpty(yarnConfDir)) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -            throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        yarnClient.start();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        Log.info(&quot;----init yarn success ----&quot;);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  84 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  84 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -            throws MalformedURLException {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  87 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  87 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -            if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -                throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        if (flinkJarPath != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -            File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -            for (File file : jars) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -                if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -                    clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -                    shipFiles.add(file);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -            throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        }</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -            fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -            throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                    + &quot; Currently only classpath and shipfile are supported.&quot;);</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        return clusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -                jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -    private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        return shipFiles;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            Configuration configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -            YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            String configurationDirectory) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                configurationDirectory,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                yarnClient,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -}</span></pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * &lt;p&gt;</span>
  11   * http://www.apache.org/licenses/LICENSE-2.0
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * &lt;p&gt;</span>
  14   * Unless required by applicable law or agreed to in writing, software
  15   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  16   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  17   * See the License for the specific language governing permissions and
  18   * limitations under the License.
  19   */
  20  
  21  package com.dtstack.flink.sql.launcher.perjob;
  22  
  23  import com.dtstack.flink.sql.enums.EPluginLoadMode;
  24  import com.dtstack.flink.sql.launcher.YarnConfLoader;
  25  import com.dtstack.flink.sql.option.Options;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.esotericsoftware.minlog.Log;</span>
  27  import org.apache.commons.lang3.StringUtils;
  28  import org.apache.flink.api.common.cache.DistributedCache;
  29  import org.apache.flink.configuration.Configuration;
  30  import com.google.common.base.Strings;
  31  import org.apache.flink.runtime.jobgraph.JobGraph;
  32  import org.apache.flink.runtime.security.SecurityConfiguration;
  33  import org.apache.flink.runtime.security.SecurityUtils;
  34  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  35  import org.apache.flink.yarn.YarnClusterDescriptor;
  36  import org.apache.hadoop.fs.Path;
  37  import org.apache.hadoop.yarn.client.api.YarnClient;
  38  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  39  import org.slf4j.Logger;
  40  import org.slf4j.LoggerFactory;
  41  
  42  import java.io.File;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import java.io.UnsupportedEncodingException;</span>
  44  import java.net.MalformedURLException;
  45  import java.net.URL;
  46  import java.util.ArrayList;
  47  import java.util.List;
  48  import java.util.Map;
  49  import java.util.Properties;
  50  
  51  /**
  52   * Reason:
  53   * Date: 2018/11/16
  54   * Company: www.dtstack.com
  55   * @author xuchao
  56   */
  57  
  58  public class PerJobClusterClientBuilder {
  59  
  60      private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);
  61  
  62      private static final String DEFAULT_CONF_DIR = &quot;./&quot;;
  63  
  64      private YarnClient yarnClient;
  65  
  66      private YarnConfiguration yarnConf;
  67  
  68      private Configuration flinkConfig;
  69  
  70      public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {
  71  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -        if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +        if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
  74              throw new RuntimeException(&quot;parameters of yarn is required&quot;);
  75          }
  76          userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));
  77          this.flinkConfig = flinkConfig;
  78          SecurityUtils.install(new SecurityConfiguration(flinkConfig));
  79  
  80          yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  81          yarnClient = YarnClient.createYarnClient();
  82          yarnClient.init(yarnConf);
  83          yarnClient.start();
  84  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -        Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        LOG.info(&quot;----init yarn success ----&quot;);</span>
  87      }
  88  
<abbr title="  89      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  89      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -            throws MalformedURLException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +            throws MalformedURLException, UnsupportedEncodingException {</span>
  92  
<abbr title="  93          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  93          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr>
  94          AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);
  95  
  96          if (StringUtils.isNotBlank(flinkJarPath)) {
  97              if (!new File(flinkJarPath).exists()) {
  98                  throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);
  99              }
 100          }
 101  
 102          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 103          if (flinkJarPath != null) {
 104              File[] jars = new File(flinkJarPath).listFiles();
 105              for (File file : jars) {
 106                  if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {
 107                      clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));
 108                  } else {
 109                      shipFiles.add(file);
 110                  }
 111              }
 112          } else {
 113              throw new RuntimeException(&quot;The Flink jar path is null&quot;);
 114          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
 116          // classpath , all node need contain plugin jar
 117          String pluginLoadMode = launcherOptions.getPluginLoadMode();
 118          if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {
 119              fillJobGraphClassPath(jobGraph);
 120          } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {
 121              List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);
 122              shipFiles.addAll(pluginPaths);
 123          } else {
 124              throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode
 125                      + &quot; Currently only classpath and shipfile are supported.&quot;);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        // add  user customized file to shipfile</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        if (!StringUtils.isBlank(launcherOptions.getAddShipfile())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            List&lt;String&gt; paths = ConfigParseUtil.parsePathFromStr(launcherOptions.getAddShipfile());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            paths.forEach(path -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                shipFiles.add(new File(path));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +            });</span>
 134          }
 135  
 136          clusterDescriptor.addShipFiles(shipFiles);
 137          clusterDescriptor.setName(launcherOptions.getName());
 138          String queue = launcherOptions.getQueue();
 139          if (!Strings.isNullOrEmpty(queue)) {
 140              clusterDescriptor.setQueue(queue);
 141          }
 142          return clusterDescriptor;
 143      }
 144  
 145      private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {
 146          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
 151                  jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));
 152              }
 153          }
 154      }
 155  
 156      private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {
 157          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 158          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +            if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
 163                  shipFiles.add(new File(tmp.getValue().filePath));
 164              }
 165          }
 166          return shipFiles;
 167      }
 168  
 169      private AbstractYarnClusterDescriptor getClusterDescriptor(
 170              Configuration configuration,
 171              YarnConfiguration yarnConfiguration,
 172              String configurationDirectory) {
 173          return new YarnClusterDescriptor(
 174                  configuration,
 175                  yarnConfiguration,
 176                  configurationDirectory,
 177                  yarnClient,
 178                  false);
 179      }
 180  
 181  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            