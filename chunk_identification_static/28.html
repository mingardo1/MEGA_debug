<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>28</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    28
                    <a href="27.html">prev</a>
                    <a href="29.html">next</a>
                    <a href="28_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_1469ca1ceaae9c691eee7790de89a3ee1f571403_Aria/src/main/java/com/arialyy/aria/core/common/AbsFileer.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403:Aria/src/main/java/com/arialyy/aria/core/common/AbsFileer.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^1:Aria/src/main/java/com/arialyy/aria/core/common/AbsFileer.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^2:Aria/src/main/java/com/arialyy/aria/core/common/AbsFileer.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;39a43c836d3309cbbf82de6d51309fe71fc25292:Aria/src/main/java/com/arialyy/aria/core/common/AbsFileer.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [bs], [bs], [bs], [bs], [sbj], [sbj], [sbj], [sbj], [bs], [bs], [bs], [j], [j], [j], [j], [j], [j]], subset: [[b], [b], [b], [bs], [bs], [sbj], [sbj], [sbj], [sbj], [sbj], [bs], [sbj], [sbj], [j], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.content.Context;
  19 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  20 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.util.SparseArray;</span>
  22 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 import android.os.Handler;</span>
  24 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  25 import android.os.Looper;
  26 import android.util.SparseArray;
  27 import com.arialyy.aria.core.AriaManager;
  28 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  29 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.arialyy.aria.core.download.DTaskWrapper;</span>
  32 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.arialyy.aria.core.download.BaseDListener;</span>
  34 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  35 import com.arialyy.aria.core.inf.AbsNormalEntity;
  36 import com.arialyy.aria.core.inf.AbsTaskWrapper;
  37 import com.arialyy.aria.core.inf.IEventListener;
  38 import com.arialyy.aria.core.manager.ThreadTaskManager;
  39 import com.arialyy.aria.util.ALog;
  40 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import com.arialyy.aria.util.CommonUtil;</span>
  42 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import com.arialyy.aria.core.manager.ThreadTaskManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import com.arialyy.aria.core.upload.UploadEntity;</span>
  45 =======
  46 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  47 import java.io.File;
  48 import java.util.concurrent.ScheduledThreadPoolExecutor;
  49 import java.util.concurrent.TimeUnit;
  50 
  51 /**
  52  * Created by AriaL on 2017/7/1.
  53  * æ§åˆ¶çº¿ç¨‹ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚ï¼šå¼€å§‹ï¼Œåœæ­¢ï¼Œå–æ¶ˆï¼Œé‡è¯•
  54  */
<abbr title="  55 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITY&gt;&gt;">  55 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITğŸ”µ</abbr>
  56     implements Runnable {
  57 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58   protected final String TAG;</span>
  59 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import java.util.Set;</span>
  61 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62   private final String TAG = &quot;AbsFileer&quot;;</span>
  63 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  64   protected IEventListener mListener;
  65   protected TASK_WRAPPER mTaskWrapper;
  66   protected ENTITY mEntity;
  67   protected Context mContext;
  68   protected File mTempFile; //æ–‡ä»¶
  69 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  70 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71  */</span>
  72 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73   protected int mTotalThreadNum; //æ€»çº¿ç¨‹æ•°</span>
  74 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  75 
  76   private SparseArray&lt;AbsThreadTask&gt; mTask = new SparseArray&lt;&gt;();
  77   private ScheduledThreadPoolExecutor mTimer;
  78 
  79   /**
  80    * è¿›åº¦åˆ·æ–°é—´éš”
  81    */
  82   private long mUpdateInterval = 1000;
  83   protected TaskRecord mRecord;
  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85   private IThreadState mStateManager;</span>
  86 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88    * å°äº1mçš„æ–‡ä»¶ä¸å¯ç”¨å¤šçº¿ç¨‹</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89    */</span>
  90 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91   private ThreadStateManager mStateManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92   private Handler mStateHandler;</span>
  93 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  94   private boolean isCancel = false, isStop = false;
  95 
  96   protected AbsFileer(IEventListener listener, TASK_WRAPPER wrapper) {
  97     mListener = listener;
  98     mTaskWrapper = wrapper;
  99     mEntity = mTaskWrapper.getEntity();
 100     mContext = AriaManager.APP;
 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     TAG = CommonUtil.getClassName(getClass());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105   protected abstract IThreadState getStateManager(Looper looper);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108    * å¤„ç†ä»»åŠ¡</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110   protected abstract void handleTask();</span>
 111 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112   protected IEventListener mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113   protected TASK_WRAPPER mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114   protected ENTITY mEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115   protected Context mContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116   protected File mTempFile; //æ–‡ä»¶</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117   protected StateConstance mConstance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118   //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119   protected int mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120   //å·²å®Œæˆçš„çº¿ç¨‹æ•°</span>
 121 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122   }</span>
 123 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 124 
 125   public String getKey() {
 126     return mTaskWrapper.getKey();
 127   }
 128 
 129   public ENTITY getEntity() {
 130     return mEntity;
 131   }
 132 
 133   public SparseArray&lt;AbsThreadTask&gt; getTaskList() {
 134     return mTask;
 135   }
 136 
 137   /**
 138    * é‡ç½®ä»»åŠ¡çŠ¶æ€
 139    */
 140   private void resetState() {
 141     closeTimer();
 142 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 143 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145   protected abstract int getType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147   public void setNewTask(boolean newTask) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148     mTaskWrapper.setNewTask(newTask);</span>
 149 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150     mTotalThreadNum = 0;</span>
 151 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 152     if (mTask != null &amp;&amp; mTask.size() != 0) {
 153       for (int i = 0; i &lt; mTask.size(); i++) {
 154         AbsThreadTask task = mTask.get(i);
 155         if (task != null) {
 156           task.breakTask();
 157         }
 158       }
 159       mTask.clear();
 160     }
 161   }
 162 
 163   /**
 164    * å¼€å§‹æµç¨‹
 165    */
 166   private void startFlow() {
 167     if (isBreak()) {
 168       return;
 169     }
 170     resetState();
 171     mRecord = new RecordHandler(mTaskWrapper).getRecord();
 172 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173     Looper.prepare();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175     mStateManager = getStateManager(looper);</span>
 176 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177   public void setMaxSpeed(int maxSpeed) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179       AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         task.setMaxSpeed(maxSpeed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186   /**</span>
 187 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188     mTotalThreadNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189     Looper.prepare();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     mStateManager = new ThreadStateManager(looper, mRecord, mListener);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192     mStateHandler = new Handler(looper, mStateManager);</span>
 193 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 194     onPostPre();
 195 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 196 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         task.setMaxSpeed(maxSpeed);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203    * é‡ç½®ä»»åŠ¡çŠ¶æ€</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205   private void resetState() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207     mCompleteThreadNum = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208     mTotalThreadNum = 0;</span>
 209 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210     if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211       handleNoSupportBP();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213       handleBreakpoint();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214     }</span>
 215 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 216     startTimer();
 217 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218     handleTask();</span>
 219 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225    * é‡ç½®ä»»åŠ¡çŠ¶æ€</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227   private void resetState() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229     mCompleteThreadNum = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230     mTotalThreadNum = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231     if (mTask != null &amp;&amp; mTask.size() != 0) {</span>
 232 =======
 233 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 234     Looper.loop();
 235   }
 236 
 237   @Override public void run() {
 238     if (isRunning()) {
 239       return;
 240     }
 241     startFlow();
 242   }
 243 
 244   /**
 245    * é¢„å¤„ç†å®Œæˆ
 246    */
 247   protected void onPostPre() {
 248 
 249   }
 250 
 251   /**
 252 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253    * å»¶è¿Ÿå¯åŠ¨å®šæ—¶å™¨</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255   protected long delayTimer() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256     return 1000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259   /**</span>
 260 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265    * å¼€å§‹æµç¨‹</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267   private void startFlow() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268     if (isBreak()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271     resetState();</span>
 272 =======
 273 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 274    * å¯åŠ¨è¿›åº¦è·å–å®šæ—¶å™¨
 275    */
 276   private synchronized void startTimer() {
 277     ALog.d(TAG, &quot;å¯åŠ¨å®šæ—¶å™¨&quot;);
 278     mTimer = new ScheduledThreadPoolExecutor(1);
 279     mTimer.scheduleWithFixedDelay(new Runnable() {
 280       @Override public void run() {
 281         if (mStateManager.isComplete()
 282             || mStateManager.isStop()
 283             || mStateManager.isCancel()
 284             || mStateManager.isFail()
 285             || !isRunning()) {
 286           if (mStateManager.isComplete() || mStateManager.isFail()) {
 287             ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 288           }
 289           closeTimer();
 290         } else if (mStateManager.getCurrentProgress() &gt;= 0) {
 291           mListener.onProgress(mStateManager.getCurrentProgress());
 292         }
 293       }
 294     }, delayTimer(), mUpdateInterval, TimeUnit.MILLISECONDS);
 295   }
 296 
 297   public synchronized void closeTimer() {
 298     ALog.d(TAG, &quot;å…³é—­å®šæ—¶å™¨&quot;);
 299     if (mTimer != null &amp;&amp; !mTimer.isShutdown()) {
 300       mTimer.shutdown();
 301     }
 302   }
 303 
 304   /**
 305    * è®¾ç½®å®šæ—¶å™¨æ›´æ–°é—´éš”
 306    *
 307    * @param interval å•ä½æ¯«ç§’ï¼Œä¸èƒ½å°äº0
 308    */
 309   protected void setUpdateInterval(long interval) {
 310     if (interval &lt; 0) {
 311       ALog.w(TAG, &quot;æ›´æ–°é—´éš”ä¸èƒ½å°äº0ï¼Œé»˜è®¤ä¸º1000æ¯«ç§’&quot;);
 312       return;
 313     }
 314     mUpdateInterval = interval;
 315   }
 316 
 317   public long getFileSize() {
 318     return mEntity.getFileSize();
 319   }
 320 
 321   /**
 322    * è·å–å½“å‰ä»»åŠ¡ä½ç½®
 323    */
 324   public long getCurrentLocation() {
 325     return mStateManager.getCurrentProgress();
 326   }
 327 
 328   public synchronized boolean isRunning() {
 329     boolean b = ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());
 330     //ALog.d(TAG, &quot;isRunning = &quot; + b);
 331     return b;
 332   }
 333 
 334   public synchronized void cancel() {
 335     if (isCancel) {
 336       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 337       return;
 338     }
 339     closeTimer();
 340     isCancel = true;
 341     for (int i = 0; i &lt; mTask.size(); i++) {
 342       AbsThreadTask task = mTask.get(i);
 343       if (task != null) {
 344         task.cancel();
 345       }
 346     }
 347     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 348   }
 349 
 350   public synchronized void stop() {
 351     if (isStop) {
 352       return;
 353     }
 354     closeTimer();
 355     isStop = true;
 356     if (mStateManager.isComplete()) return;
 357     for (int i = 0; i &lt; mTask.size(); i++) {
 358       AbsThreadTask task = mTask.get(i);
 359       if (task != null &amp;&amp; !task.isThreadComplete()) {
 360         task.stop();
 361       }
 362     }
 363     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 364   }
 365 
 366   /**
 367    * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ
 368    */
 369   public synchronized void start() {
 370     if (isRunning()) {
 371       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 372       return;
 373     }
 374     new Thread(this).start();
 375   }
 376 
 377   public void resume() {
 378     start();
 379   }
 380 
 381   /**
 382 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 383 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387    * è·å–å½“å‰ä»»åŠ¡ä½ç½®</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389   public long getCurrentLocation() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393   public synchronized boolean isRunning() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394     return ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397   public synchronized void cancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398     ALog.d(TAG, &quot;constance hash: &quot; + mConstance.hashCode());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404     mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406       AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408         task.cancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414   public synchronized void stop() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415     if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419     mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420     if (mConstance.isComplete()) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422       AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423       if (task != null &amp;&amp; !task.isThreadComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424         task.stop();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431    * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433   public synchronized void start() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434     if (isRunning()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438     new Thread(this).start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441   public void resume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442     start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446    * æ£€æŸ¥è®°å½• å¯¹äºåˆ†å—ä»»åŠ¡ï¼š å­åˆ†å—ä¸å­˜åœ¨æˆ–è¢«åˆ é™¤ï¼Œå­çº¿ç¨‹å°†é‡æ–°ä¸‹è½½ å¯¹äºæ™®é€šä»»åŠ¡ï¼š é¢„ä¸‹è½½æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»»åŠ¡ä»»åŠ¡å‘—åˆ é™¤</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448   private void checkRecord() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451       convertDb();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454       if (mRecord == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458           initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459         } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460           handleBlockRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462           handleNormalRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469    * å¤„ç†æ™®é€šä»»åŠ¡çš„è®°å½•</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471   private void handleNormalRecord() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     if (!file.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474       ALog.w(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œä»»åŠ¡å°†é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475       mRecord.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476       initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477       return;</span>
 478 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479    * å¯åŠ¨æ–­ç‚¹ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºå•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481    * @param record çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482    * @param startNum å¯åŠ¨çš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484   private AbsThreadTask createSingThreadTask(ThreadRecord record, int startNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485     SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486     config.url = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487     config.tempFile =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488         mRecord.isBlock ? new File(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489             String.format(RecordHandler.SUB_PATH, mTempFile.getPath(), record.threadId))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490             : mTempFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491     config.isBlock = mRecord.isBlock;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     config.isOpenDynamicFile = mRecord.isOpenDynamicFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     config.startThreadNum = startNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     config.taskWrapper = mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     config.record = record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     config.stateHandler = mStateHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497     return selectThreadTask(config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500   private void handleBreakpoint() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501     long fileLength = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502     long blockSize = fileLength / mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503     long currentProgress = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     mRecord.fileLength = fileLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506     if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     int startNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512       if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         startNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519       ThreadRecord tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521       if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         currentProgress += endL - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523         ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524         mStateHandler.obtainMessage(ThreadStateManager.STATE_COMPLETE).sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525         if (mStateManager.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526           mRecord.deleteData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528           return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530         continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533       //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534       long r = tr.startLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535       //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536       if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537         currentProgress += r - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541       AbsThreadTask task = createSingThreadTask(tr, startNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542       if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543       mTask.put(tr.threadId, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545     if (currentProgress != 0 &amp;&amp; currentProgress != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546       ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, currentProgress));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547       mEntity.setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549     mStateHandler.obtainMessage(ThreadStateManager.STATE_UPDATE_PROGRESS, currentProgress)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550         .sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551     startThreadTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555    * å¯åŠ¨å•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557   private void startThreadTask() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558     if (isBreak()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561     if (mStateManager.getCurrentProgress() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562       mListener.onResume(mStateManager.getCurrentProgress());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564       mListener.onStart(mStateManager.getCurrentProgress());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567       ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571   /**</span>
 572 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 573    * é‡è¯•ä»»åŠ¡
 574    */
 575   public void retryTask() {
 576     ALog.w(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å¼€å§‹é‡è¯•&quot;, mEntity.getFileName()));
 577     startFlow();
 578   }
 579 
 580   /**
 581 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 582 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584   public synchronized boolean isRunning() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585     return ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 587 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588   public synchronized void cancel() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589     ALog.d(TAG, &quot;constance hash: &quot; + mConstance.hashCode());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590     if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 591       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 592       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595     mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597       AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599         task.cancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605   public synchronized void stop() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606     if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609     closeTimer();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610     mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611     if (mConstance.isComplete()) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613       AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614       if (task != null &amp;&amp; !task.isThreadComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615         task.stop();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622    * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624   public synchronized void start() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625     if (isRunning()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629     new Thread(this).start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632   public void resume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633     start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637    * æ£€æŸ¥è®°å½• å¯¹äºåˆ†å—ä»»åŠ¡ï¼š å­åˆ†å—ä¸å­˜åœ¨æˆ–è¢«åˆ é™¤ï¼Œå­çº¿ç¨‹å°†é‡æ–°ä¸‹è½½ å¯¹äºæ™®é€šä»»åŠ¡ï¼š é¢„ä¸‹è½½æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»»åŠ¡ä»»åŠ¡å‘—åˆ é™¤</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639   private void checkRecord() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640     mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641     if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642       convertDb();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644       mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645       if (mRecord == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646         initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648         if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649           initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650         } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651           handleBlockRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653           handleNormalRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 657   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 658 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660    * å¤„ç†æ™®é€šä»»åŠ¡çš„è®°å½•</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 661    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 662   private void handleNormalRecord() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663     File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664     if (!file.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665       ALog.w(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œä»»åŠ¡å°†é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666       mRecord.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667       initRecord(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671     if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 672       ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673       if (tr == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674         ALog.d(TAG, &quot;çº¿ç¨‹è®°å½•ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675         mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676         mTotalThreadNum = 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677         return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679       if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680         ALog.i(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘é”™è¯¯ï¼Œä»»åŠ¡é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681         file.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682         tr.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683         tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684         tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685       } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686         tr.isComplete = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687         mCompleteThreadNum++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689         if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690           ALog.i(TAG, String.format(&quot;ä¿®æ­£ã€%sã€‘çš„è¿›åº¦è®°å½•ä¸ºï¼š%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 691           tr.startLocation = file.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692           tr.isComplete = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 696       for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697         if (tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698           mCompleteThreadNum++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702     mTotalThreadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703     mTaskWrapper.setNewTask(false);</span>
 704 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705    * å¤„ç†æ–°ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707    * @return {@code true}åˆ›å»ºæ–°ä»»åŠ¡å¤±è´¥</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709   protected abstract boolean handleNewTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712    * å¤„ç†ä¸æ”¯æŒæ–­ç‚¹çš„ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714   private void handleNoSupportBP() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715     if (mListener instanceof BaseDListener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716       ((BaseDListener) mListener).supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719     AbsThreadTask task = createSingThreadTask(mRecord.threadRecords.get(0), 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720     if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721     mTask.put(0, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722     ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723     mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727    * é€‰æ‹©å•ä»»åŠ¡çº¿ç¨‹çš„ç±»å‹</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729   protected abstract AbsThreadTask selectThreadTask(SubThreadConfig&lt;TASK_WRAPPER&gt; config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731   /**</span>
 732 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 733    * ä»»åŠ¡æ˜¯å¦å·²ç»ä¸­æ–­
 734    *
 735    * @return {@code true}ä¸­æ–­
 736    */
 737   public boolean isBreak() {
 738     if (isCancel || isStop) {
 739       closeTimer();
 740       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å·²åœæ­¢æˆ–å–æ¶ˆäº†&quot;, mEntity.getFileName()));
 741       return true;
 742     }
 743     return false;
 744   }
 745 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.content.Context;
  19 import android.os.Handler;
  20 import android.os.Looper;
  21 import android.util.SparseArray;
  22 import com.arialyy.aria.core.AriaManager;
  23 import com.arialyy.aria.core.inf.AbsNormalEntity;
  24 import com.arialyy.aria.core.inf.AbsTaskWrapper;
  25 import com.arialyy.aria.core.inf.IEventListener;
  26 import com.arialyy.aria.core.manager.ThreadTaskManager;
  27 import com.arialyy.aria.util.ALog;
  28 import java.io.File;
  29 import java.util.concurrent.ScheduledThreadPoolExecutor;
  30 import java.util.concurrent.TimeUnit;
  31 
  32 /**
  33  * Created by AriaL on 2017/7/1.
  34  * æ§åˆ¶çº¿ç¨‹ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚ï¼šå¼€å§‹ï¼Œåœæ­¢ï¼Œå–æ¶ˆï¼Œé‡è¯•
  35  */
<abbr title="  36 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITY&gt;&gt;">  36 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITğŸ”µ</abbr>
  37     implements Runnable {
  38   protected final String TAG;
  39   protected IEventListener mListener;
  40   protected TASK_WRAPPER mTaskWrapper;
  41   protected ENTITY mEntity;
  42   protected Context mContext;
  43   protected File mTempFile;
  44 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  45 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47   //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
  49 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50  //æ–‡ä»¶</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 </span>
  52 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  53 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54  //æ–‡ä»¶</span>
  55 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
  57 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58  //æ€»çº¿ç¨‹æ•°</span>
  59 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  60 
  61   private SparseArray&lt;AbsThreadTask&gt; mTask = new SparseArray&lt;&gt;();
  62   private ScheduledThreadPoolExecutor mTimer;
  63 
  64   /**
  65    * è¿›åº¦åˆ·æ–°é—´éš”
  66    */
  67   private long mUpdateInterval = 1000;
  68   protected TaskRecord mRecord;
  69 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70 private IThreadState mStateManager;</span>
  71 ||||||| BASE
  72 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 private ThreadStateManager mStateManager;</span>
  74 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  75 
  76   private Handler mStateHandler;
  77   private boolean isCancel = false, isStop = false;
  78 
  79   protected AbsFileer(IEventListener listener, TASK_WRAPPER wrapper) {
  80     mListener = listener;
  81     mTaskWrapper = wrapper;
  82     mEntity = mTaskWrapper.getEntity();
  83     mContext = AriaManager.APP;
  84 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85     TAG = CommonUtil.getClassName(getClass());</span>
  86 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87     mConstance = new StateConstance();</span>
  88 =======
  89 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  90   }
  91 
  92   protected abstract IThreadState getStateManager(Looper looper);
  93 
  94   /**
  95    * å¤„ç†ä»»åŠ¡
  96    */
  97   protected abstract void handleTask();
  98 
  99   public ENTITY getEntity() {
 100     return mEntity;
 101   }
 102 
 103   public SparseArray&lt;AbsThreadTask&gt; getTaskList() {
 104     return mTask;
 105   }
 106 
 107   /**
 108    * é‡ç½®ä»»åŠ¡çŠ¶æ€
 109    */
 110   private void resetState() {
 111     closeTimer();
 112 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 113 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114     mCompleteThreadNum = 0;</span>
 115 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116     mTotalThreadNum = 0;</span>
 117 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 118     if (mTask != null &amp;&amp; mTask.size() != 0) {
 119       for (int i = 0; i &lt; mTask.size(); i++) {
 120         AbsThreadTask task = mTask.get(i);
 121         if (task != null) {
 122           task.breakTask();
 123         }
 124       }
 125       mTask.clear();
 126     }
 127   }
 128 
 129   /**
 130    * å¼€å§‹æµç¨‹
 131    */
 132   private void startFlow() {
 133     if (isBreak()) {
 134       return;
 135     }
 136     resetState();
 137     mRecord = new RecordHandler(mTaskWrapper).getRecord();
 138 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     Looper.prepare();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     mStateManager = getStateManager(looper);</span>
 142 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     ALog.d(TAG, &quot;path: &quot; + getFilePath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     checkRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     mConstance.TASK_RECORD = mRecord;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147       mTotalThreadNum = 1;</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149     mTotalThreadNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150     Looper.prepare();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152     mStateManager = new ThreadStateManager(looper, mRecord, mListener);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153     mStateHandler = new Handler(looper, mStateManager);</span>
 154 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 155     onPostPre();
 156 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 157 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158       mTotalThreadNum = 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160       mTotalThreadNum =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161           mTaskWrapper.isNewTask() ? setNewTaskThreadNum() : mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     mConstance.START_THREAD_NUM = mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
 165 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167       handleNoSupportBP();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169       handleBreakpoint();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170     }</span>
 171 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 172     startTimer();
 173 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     handleTask();</span>
 175 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177       mTotalThreadNum =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178           mTaskWrapper.isNewTask() ? setNewTaskThreadNum() : mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     mConstance.START_THREAD_NUM = mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     // å¤„ç†åˆ†å—å’ŒåŠ¨æ€æ–‡ä»¶å‚æ•°</span>
 183 =======
 184 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 185     Looper.loop();
 186   }
 187 
 188   @Override public void run() {
 189     if (isRunning()) {
 190       return;
 191     }
 192     startFlow();
 193   }
 194 
 195   /**
 196    * é¢„å¤„ç†å®Œæˆ
 197    */
 198   protected void onPostPre() {
 199 
 200   }
 201 
 202   /**
 203    * å»¶è¿Ÿå¯åŠ¨å®šæ—¶å™¨
 204    */
 205   protected long delayTimer() {
 206     return 1000;
 207   }
 208 
 209   /**
 210    * å¯åŠ¨è¿›åº¦è·å–å®šæ—¶å™¨
 211    */
 212   private synchronized void startTimer() {
 213     ALog.d(TAG, &quot;å¯åŠ¨å®šæ—¶å™¨&quot;);
 214     mTimer = new ScheduledThreadPoolExecutor(1);
 215     mTimer.scheduleWithFixedDelay(new Runnable() {
 216       @Override public void run() {
 217         if (mStateManager.isComplete()
 218             || mStateManager.isStop()
 219             || mStateManager.isCancel()
 220             || mStateManager.isFail()
 221             || !isRunning()) {
 222           if (mStateManager.isComplete() || mStateManager.isFail()) {
 223             ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 224           }
 225           closeTimer();
 226         } else if (mStateManager.getCurrentProgress() &gt;= 0) {
 227           mListener.onProgress(mStateManager.getCurrentProgress());
 228         }
 229       }
 230     }, delayTimer(), mUpdateInterval, TimeUnit.MILLISECONDS);
 231   }
 232 
 233   public synchronized void closeTimer() {
 234     ALog.d(TAG, &quot;å…³é—­å®šæ—¶å™¨&quot;);
 235     if (mTimer != null &amp;&amp; !mTimer.isShutdown()) {
 236       mTimer.shutdown();
 237     }
 238   }
 239 
 240   /**
 241    * è®¾ç½®å®šæ—¶å™¨æ›´æ–°é—´éš”
 242    *
 243    * @param interval å•ä½æ¯«ç§’ï¼Œä¸èƒ½å°äº0
 244    */
 245   protected void setUpdateInterval(long interval) {
 246     if (interval &lt; 0) {
 247       ALog.w(TAG, &quot;æ›´æ–°é—´éš”ä¸èƒ½å°äº0ï¼Œé»˜è®¤ä¸º1000æ¯«ç§’&quot;);
 248       return;
 249     }
 250     mUpdateInterval = interval;
 251   }
 252 
 253   public long getFileSize() {
 254     return mEntity.getFileSize();
 255   }
 256 
 257   /**
 258    * è·å–å½“å‰ä»»åŠ¡ä½ç½®
 259    */
 260   public long getCurrentLocation() {
 261     return mStateManager.getCurrentProgress();
 262   }
 263 
 264   public synchronized boolean isRunning() {
 265     boolean b = ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());
 266     //ALog.d(TAG, &quot;isRunning = &quot; + b);
 267     return b;
 268   }
 269 
 270   public synchronized void cancel() {
 271     if (isCancel) {
 272       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 273       return;
 274     }
 275     closeTimer();
 276     isCancel = true;
 277     for (int i = 0; i &lt; mTask.size(); i++) {
 278       AbsThreadTask task = mTask.get(i);
 279       if (task != null) {
 280         task.cancel();
 281       }
 282     }
 283     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 284   }
 285 
 286   public synchronized void stop() {
 287     if (isStop) {
 288       return;
 289     }
 290     closeTimer();
 291     isStop = true;
 292     if (mStateManager.isComplete()) return;
 293     for (int i = 0; i &lt; mTask.size(); i++) {
 294       AbsThreadTask task = mTask.get(i);
 295       if (task != null &amp;&amp; !task.isThreadComplete()) {
 296         task.stop();
 297       }
 298     }
 299     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 300   }
 301 
 302   /**
 303    * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ
 304    */
 305   public synchronized void start() {
 306     if (isRunning()) {
 307       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 308       return;
 309     }
 310     new Thread(this).start();
 311   }
 312 
 313   public void resume() {
 314     start();
 315   }
 316 
 317   /**
 318    * å¯åŠ¨æ–­ç‚¹ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºå•çº¿ç¨‹ä»»åŠ¡
 319    *
 320    * @param record çº¿ç¨‹è®°å½•
 321    * @param startNum å¯åŠ¨çš„çº¿ç¨‹æ•°
 322    */
 323   private AbsThreadTask createSingThreadTask(ThreadRecord record, int startNum) {
 324     SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();
 325     config.url = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();
 326     config.tempFile =
 327         mRecord.isBlock ? new File(
 328             String.format(RecordHandler.SUB_PATH, mTempFile.getPath(), record.threadId))
 329             : mTempFile;
 330     config.isBlock = mRecord.isBlock;
 331     config.isOpenDynamicFile = mRecord.isOpenDynamicFile;
 332     config.startThreadNum = startNum;
 333     config.taskWrapper = mTaskWrapper;
 334     config.record = record;
 335     config.stateHandler = mStateHandler;
 336     return selectThreadTask(config);
 337   }
 338 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 339 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 private void handleBreakpoint() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     long fileLength = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342     long blockSize = fileLength / mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343     Set&lt;Integer&gt; threads = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344     //// å¦‚æœæ˜¯æ–°ä»»åŠ¡ï¼Œæ£€æŸ¥ä¸‹å†å²è®°å½•ï¼Œå¦‚æœæœ‰é—ç•™çš„è®°å½•ï¼Œåˆ é™¤å¹¶åˆ é™¤åˆ†å—æ–‡ä»¶</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345     //if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346     //  CommonUtil.delTaskRecord(getFilePath(), 1, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347     //}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349     mRecord.fileLength = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350     if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353     for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355       ThreadRecord tr;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356       boolean isNewTr = false;  // æ˜¯å¦æ˜¯æ–°çš„çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357       if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358         tr = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360         tr.threadId = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361         isNewTr = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363         tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366       if (tr.blockLen == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367         tr.blockLen = CommonUtil.getBlockLen(fileLength, i, mTotalThreadNum);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370       if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         if (resumeRecordLocation(i, startL, endL)) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372         continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375       //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376       if (tr.startLocation &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377         long r = tr.startLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378         //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380           mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381           startL = r;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383         ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385         tr.startLocation = startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387       //æœ€åä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸä½ç½®å³ä¸ºæ–‡ä»¶çš„æ€»é•¿åº¦</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388       if (i == (mTotalThreadNum - 1)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         endL = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391       if (tr.endLocation &lt;= 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392         tr.endLocation = endL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394       if (isNewTr) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397       //ALog.d(TAG, String.format(&quot;åˆ›å»ºä»»åŠ¡çº¿ç¨‹ï¼š%sï¼Œçº¿ç¨‹æ€»æ•°ï¼š%s&quot;, i, mTotalThreadNum));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398       AbsThreadTask task = createSingThreadTask(i, startL, endL, fileLength, tr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399       if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400       mTask.put(i, task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401       threads.add(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403     if (mConstance.CURRENT_LOCATION != 0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404         &amp;&amp; mConstance.CURRENT_LOCATION != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405       ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, mConstance.CURRENT_LOCATION));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406       mEntity.setCurrentProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408     saveRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409     startThreadTask(threads);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410   }</span>
 411 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 private void handleBreakpoint() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413     long fileLength = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414     long blockSize = fileLength / mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415     long currentProgress = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417     mRecord.fileLength = fileLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418     if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422     int startNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424       if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         startNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429     for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431       ThreadRecord tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433       if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434         currentProgress += endL - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435         ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436         mStateHandler.obtainMessage(ThreadStateManager.STATE_COMPLETE).sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437         if (mStateManager.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438           mRecord.deleteData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440           return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442         continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445       //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446       long r = tr.startLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447       //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448       if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449         currentProgress += r - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453       AbsThreadTask task = createSingThreadTask(tr, startNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454       if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455       mTask.put(tr.threadId, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457     if (currentProgress != 0 &amp;&amp; currentProgress != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458       ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, currentProgress));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459       mEntity.setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461     mStateHandler.obtainMessage(ThreadStateManager.STATE_UPDATE_PROGRESS, currentProgress)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462         .sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463     startThreadTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464   }</span>
 465 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 466 
 467 
 468   /**
 469    * å¯åŠ¨å•çº¿ç¨‹ä»»åŠ¡
 470    */
 471   private void startThreadTask() {
 472     if (isBreak()) {
 473       return;
 474     }
 475     if (mStateManager.getCurrentProgress() &gt; 0) {
 476       mListener.onResume(mStateManager.getCurrentProgress());
 477     } else {
 478       mListener.onStart(mStateManager.getCurrentProgress());
 479     }
 480     for (int i = 0; i &lt; mTask.size(); i++) {
 481       ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(i));
 482     }
 483   }
 484 
 485   /**
 486    * é‡è¯•ä»»åŠ¡
 487    */
 488   public void retryTask() {
 489     ALog.w(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å¼€å§‹é‡è¯•&quot;, mEntity.getFileName()));
 490     startFlow();
 491   }
 492 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 493 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494 private void handleNoSupportBP() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495     if (mListener instanceof BaseDListener) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496       ((BaseDListener) mListener).supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499     config.TOTAL_FILE_SIZE = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     config.URL = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501     config.TEMP_FILE = mTempFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502     config.THREAD_ID = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503     config.START_LOCATION = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504     config.END_LOCATION = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     config.SUPPORT_BP = mTaskWrapper.isSupportBP();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506     config.TASK_WRAPPER = mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507     ThreadRecord record = DbEntity.findFirst(ThreadRecord.class, &quot;key=?&quot;, mRecord.filePath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508     if (record != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509       record.deleteData();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511     record = new ThreadRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512     record.startLocation = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513     record.endLocation = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514     record.key = mTempFile.getPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515     mRecord.threadRecords.add(record);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516     config.THREAD_RECORD = record;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517     AbsThreadTask task = selectThreadTask(config);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518     if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519     mTask.put(0, task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520     saveRecord();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521     ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522     mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523   }</span>
 524 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 private void handleNoSupportBP() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526     if (mListener instanceof BaseDListener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527       ((BaseDListener) mListener).supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530     AbsThreadTask task = createSingThreadTask(mRecord.threadRecords.get(0), 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531     if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532     mTask.put(0, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534     mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535   }</span>
 536 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 537 
 538 
 539   /**
 540    * ä»»åŠ¡æ˜¯å¦å·²ç»ä¸­æ–­
 541    *
 542    * @return {@code true}ä¸­æ–­
 543    */
 544   public boolean isBreak() {
 545     if (isCancel || isStop) {
 546       closeTimer();
 547       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å·²åœæ­¢æˆ–å–æ¶ˆäº†&quot;, mEntity.getFileName()));
 548       return true;
 549     }
 550     return false;
 551   }
 552 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.content.Context;
  19 import android.os.Handler;
  20 import android.os.Looper;
  21 import android.util.SparseArray;
  22 import com.arialyy.aria.core.AriaManager;
  23 import com.arialyy.aria.core.inf.AbsNormalEntity;
  24 import com.arialyy.aria.core.inf.AbsTaskWrapper;
  25 import com.arialyy.aria.core.inf.IEventListener;
  26 import com.arialyy.aria.core.manager.ThreadTaskManager;
  27 import com.arialyy.aria.util.ALog;
  28 import java.io.File;
  29 import java.util.concurrent.ScheduledThreadPoolExecutor;
  30 import java.util.concurrent.TimeUnit;
  31 
  32 
  33 /**
  34  * Created by AriaL on 2017/7/1.
  35  * æ§åˆ¶çº¿ç¨‹ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚ï¼šå¼€å§‹ï¼Œåœæ­¢ï¼Œå–æ¶ˆï¼Œé‡è¯•
  36  */
<abbr title="  37 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITY&gt;&gt;">  37 public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITğŸ”µ</abbr>
  38     implements Runnable {
  39 
  40 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   protected final String TAG;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 </span>
  43 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  44 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  44 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
  45 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47   private final String TAG = &quot;AbsFileer&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 </span>
  49 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  50   protected IEventListener mListener;
  51   protected TASK_WRAPPER mTaskWrapper;
  52   protected ENTITY mEntity;
  53   protected Context mContext;
  54   protected File mTempFile; //æ–‡ä»¶
  55 
  56 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
  58 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  59 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  59 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
  60 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62   protected int mTotalThreadNum; //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
  64 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  65 
  66   private SparseArray&lt;AbsThreadTask&gt; mTask = new SparseArray&lt;&gt;();
  67   private ScheduledThreadPoolExecutor mTimer;
  68 
  69   /**
  70    * è¿›åº¦åˆ·æ–°é—´éš”
  71    */
  72   private long mUpdateInterval = 1000;
  73   protected TaskRecord mRecord;
  74 
  75 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76   private IThreadState mStateManager;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77 </span>
  78 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  79 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  79 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
  80 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82   private ThreadStateManager mStateManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83   private Handler mStateHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
  85 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
  86   private boolean isCancel = false, isStop = false;
  87 
  88   protected AbsFileer(IEventListener listener, TASK_WRAPPER wrapper) {
  89     mListener = listener;
  90     mTaskWrapper = wrapper;
  91     mEntity = mTaskWrapper.getEntity();
  92     mContext = AriaManager.APP;
  93 
  94 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95     TAG = CommonUtil.getClassName(getClass());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98   protected abstract IThreadState getStateManager(Looper looper);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101    * å¤„ç†ä»»åŠ¡</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103   protected abstract void handleTask();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
 105 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 106 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 106 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 107 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110 </span>
 111 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 112 
 113   public String getKey() {
 114     return mTaskWrapper.getKey();
 115   }
 116 
 117   public ENTITY getEntity() {
 118     return mEntity;
 119   }
 120 
 121   public SparseArray&lt;AbsThreadTask&gt; getTaskList() {
 122     return mTask;
 123   }
 124 
 125   /**
 126    * é‡ç½®ä»»åŠ¡çŠ¶æ€
 127    */
 128   private void resetState() {
 129     closeTimer();
 130 
 131 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132 </span>
 133 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 134 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 135 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     mTotalThreadNum = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
 139 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 140     if (mTask != null &amp;&amp; mTask.size() != 0) {
 141       for (int i = 0; i &lt; mTask.size(); i++) {
 142         AbsThreadTask task = mTask.get(i);
 143         if (task != null) {
 144           task.breakTask();
 145         }
 146       }
 147       mTask.clear();
 148     }
 149   }
 150 
 151   /**
 152    * å¼€å§‹æµç¨‹
 153    */
 154   private void startFlow() {
 155     if (isBreak()) {
 156       return;
 157     }
 158     resetState();
 159     mRecord = new RecordHandler(mTaskWrapper).getRecord();
 160 
 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     Looper.prepare();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     mStateManager = getStateManager(looper);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165 </span>
 166 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 167 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 167 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 168 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170     mTotalThreadNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     Looper.prepare();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172     Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     mStateManager = new ThreadStateManager(looper, mRecord, mListener);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     mStateHandler = new Handler(looper, mStateManager);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 </span>
 176 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 177     onPostPre();
 178 
 179 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
 181 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 182 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 182 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 183 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185     if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186       handleNoSupportBP();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188       handleBreakpoint();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 </span>
 191 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 192     startTimer();
 193 
 194 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     handleTask();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196 </span>
 197 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 198 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 198 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 199 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 </span>
 202 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 203     Looper.loop();
 204   }
 205 
 206   @Override public void run() {
 207     if (isRunning()) {
 208       return;
 209     }
 210     startFlow();
 211   }
 212 
 213   /**
 214    * é¢„å¤„ç†å®Œæˆ
 215    */
 216   protected void onPostPre() {
 217 
 218   }
 219 
 220   /**
 221 
 222 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223    * å»¶è¿Ÿå¯åŠ¨å®šæ—¶å™¨</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225   protected long delayTimer() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226     return 1000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230 </span>
 231 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 232 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 232 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 233 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 </span>
 236 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 237    * å¯åŠ¨è¿›åº¦è·å–å®šæ—¶å™¨
 238    */
 239   private synchronized void startTimer() {
 240     ALog.d(TAG, &quot;å¯åŠ¨å®šæ—¶å™¨&quot;);
 241     mTimer = new ScheduledThreadPoolExecutor(1);
 242     mTimer.scheduleWithFixedDelay(new Runnable() {
 243       @Override public void run() {
 244         if (mStateManager.isComplete()
 245             || mStateManager.isStop()
 246             || mStateManager.isCancel()
 247             || mStateManager.isFail()
 248             || !isRunning()) {
 249           if (mStateManager.isComplete() || mStateManager.isFail()) {
 250             ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 251           }
 252           closeTimer();
 253         } else if (mStateManager.getCurrentProgress() &gt;= 0) {
 254           mListener.onProgress(mStateManager.getCurrentProgress());
 255         }
 256       }
 257     }, delayTimer(), mUpdateInterval, TimeUnit.MILLISECONDS);
 258   }
 259 
 260   public synchronized void closeTimer() {
 261     ALog.d(TAG, &quot;å…³é—­å®šæ—¶å™¨&quot;);
 262     if (mTimer != null &amp;&amp; !mTimer.isShutdown()) {
 263       mTimer.shutdown();
 264     }
 265   }
 266 
 267   /**
 268    * è®¾ç½®å®šæ—¶å™¨æ›´æ–°é—´éš”
 269    *
 270    * @param interval å•ä½æ¯«ç§’ï¼Œä¸èƒ½å°äº0
 271    */
 272   protected void setUpdateInterval(long interval) {
 273     if (interval &lt; 0) {
 274       ALog.w(TAG, &quot;æ›´æ–°é—´éš”ä¸èƒ½å°äº0ï¼Œé»˜è®¤ä¸º1000æ¯«ç§’&quot;);
 275       return;
 276     }
 277     mUpdateInterval = interval;
 278   }
 279 
 280   public long getFileSize() {
 281     return mEntity.getFileSize();
 282   }
 283 
 284   /**
 285    * è·å–å½“å‰ä»»åŠ¡ä½ç½®
 286    */
 287   public long getCurrentLocation() {
 288     return mStateManager.getCurrentProgress();
 289   }
 290 
 291   public synchronized boolean isRunning() {
 292     boolean b = ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());
 293     //ALog.d(TAG, &quot;isRunning = &quot; + b);
 294     return b;
 295   }
 296 
 297   public synchronized void cancel() {
 298     if (isCancel) {
 299       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 300       return;
 301     }
 302     closeTimer();
 303     isCancel = true;
 304     for (int i = 0; i &lt; mTask.size(); i++) {
 305       AbsThreadTask task = mTask.get(i);
 306       if (task != null) {
 307         task.cancel();
 308       }
 309     }
 310     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 311   }
 312 
 313   public synchronized void stop() {
 314     if (isStop) {
 315       return;
 316     }
 317     closeTimer();
 318     isStop = true;
 319     if (mStateManager.isComplete()) return;
 320     for (int i = 0; i &lt; mTask.size(); i++) {
 321       AbsThreadTask task = mTask.get(i);
 322       if (task != null &amp;&amp; !task.isThreadComplete()) {
 323         task.stop();
 324       }
 325     }
 326     ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 327   }
 328 
 329   /**
 330    * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ
 331    */
 332   public synchronized void start() {
 333     if (isRunning()) {
 334       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 335       return;
 336     }
 337     new Thread(this).start();
 338   }
 339 
 340   public void resume() {
 341     start();
 342   }
 343 
 344   /**
 345 
 346 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347 </span>
 348 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 349 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 349 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 350 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352    * å¯åŠ¨æ–­ç‚¹ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºå•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354    * @param record çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355    * @param startNum å¯åŠ¨çš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357   private AbsThreadTask createSingThreadTask(ThreadRecord record, int startNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358     SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359     config.url = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360     config.tempFile =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361         mRecord.isBlock ? new File(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362             String.format(RecordHandler.SUB_PATH, mTempFile.getPath(), record.threadId))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363             : mTempFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364     config.isBlock = mRecord.isBlock;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365     config.isOpenDynamicFile = mRecord.isOpenDynamicFile;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366     config.startThreadNum = startNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367     config.taskWrapper = mTaskWrapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     config.record = record;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369     config.stateHandler = mStateHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     return selectThreadTask(config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373   private void handleBreakpoint() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374     long fileLength = mEntity.getFileSize();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     long blockSize = fileLength / mTotalThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376     long currentProgress = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378     mRecord.fileLength = fileLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379     if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383     int startNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384     for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385       if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         startNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390     for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392       ThreadRecord tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394       if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395         currentProgress += endL - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397         mStateHandler.obtainMessage(ThreadStateManager.STATE_COMPLETE).sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398         if (mStateManager.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399           mRecord.deleteData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401           return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403         continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406       //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407       long r = tr.startLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408       //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409       if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410         currentProgress += r - startL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414       AbsThreadTask task = createSingThreadTask(tr, startNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415       if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416       mTask.put(tr.threadId, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418     if (currentProgress != 0 &amp;&amp; currentProgress != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419       ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, currentProgress));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420       mEntity.setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422     mStateHandler.obtainMessage(ThreadStateManager.STATE_UPDATE_PROGRESS, currentProgress)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423         .sendToTarget();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424     startThreadTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428    * å¯åŠ¨å•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430   private void startThreadTask() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431     if (isBreak()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432       return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434     if (mStateManager.getCurrentProgress() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435       mListener.onResume(mStateManager.getCurrentProgress());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436     } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437       mListener.onStart(mStateManager.getCurrentProgress());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439     for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440       ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(i));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 </span>
 446 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 447    * é‡è¯•ä»»åŠ¡
 448    */
 449   public void retryTask() {
 450     ALog.w(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å¼€å§‹é‡è¯•&quot;, mEntity.getFileName()));
 451     startFlow();
 452   }
 453 
 454   /**
 455 
 456 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 457 </span>
 458 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 459 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 459 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwğŸ”µ</abbr></span>
 460 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462    * å¤„ç†æ–°ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464    * @return {@code true}åˆ›å»ºæ–°ä»»åŠ¡å¤±è´¥</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466   protected abstract boolean handleNewTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469    * å¤„ç†ä¸æ”¯æŒæ–­ç‚¹çš„ä»»åŠ¡</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471   private void handleNoSupportBP() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472     if (mListener instanceof BaseDListener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473       ((BaseDListener) mListener).supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476     AbsThreadTask task = createSingThreadTask(mRecord.threadRecords.get(0), 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477     if (task == null) return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478     mTask.put(0, task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479     ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480     mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484    * é€‰æ‹©å•ä»»åŠ¡çº¿ç¨‹çš„ç±»å‹</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486   protected abstract AbsThreadTask selectThreadTask(SubThreadConfig&lt;TASK_WRAPPER&gt; config);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489 </span>
 490 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 491    * ä»»åŠ¡æ˜¯å¦å·²ç»ä¸­æ–­
 492    *
 493    * @return {@code true}ä¸­æ–­
 494    */
 495   public boolean isBreak() {
 496     if (isCancel || isStop) {
 497       closeTimer();
 498       ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å·²åœæ­¢æˆ–å–æ¶ˆäº†&quot;, mEntity.getFileName()));
 499       return true;
 500     }
 501     return false;
 502   }
 503 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core.common;
  17  
  18  import android.content.Context;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.os.Looper;</span>

  20  import android.util.SparseArray;
  21  import com.arialyy.aria.core.AriaManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.arialyy.aria.core.download.BaseDListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.download.DTaskWrapper;</span>
  25  import com.arialyy.aria.core.inf.AbsNormalEntity;
  26  import com.arialyy.aria.core.inf.AbsTaskWrapper;
  27  import com.arialyy.aria.core.inf.IEventListener;
  28  import com.arialyy.aria.core.manager.ThreadTaskManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.arialyy.aria.orm.DbEntity;</span>
  31  import com.arialyy.aria.util.ALog;
  32  import com.arialyy.aria.util.CommonUtil;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.arialyy.aria.util.DbDataHelper;</span>
  34  import java.io.File;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import java.util.HashSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.util.Set;</span>
  40  import java.util.concurrent.ScheduledThreadPoolExecutor;
  41  import java.util.concurrent.TimeUnit;
  42  
  43  /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 - * Created by AriaL on 2017/7/1. ä»»åŠ¡å¤„ç†å™¨</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 + * Created by AriaL on 2017/7/1.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 + * æ§åˆ¶çº¿ç¨‹ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚ï¼šå¼€å§‹ï¼Œåœæ­¢ï¼Œå–æ¶ˆï¼Œé‡è¯•</span>
  47   */
  48  public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITY&gt;&gt;
  49      implements Runnable {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -  private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -  private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -   * åˆ†å—æ–‡ä»¶è·¯å¾„</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -  public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -   * å°äº1mçš„æ–‡ä»¶ä¸å¯ç”¨å¤šçº¿ç¨‹</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -  protected static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -  protected static final int DOWNLOAD = 0x1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  protected static final int UPLOAD = 0x2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -  private final String TAG = &quot;AbsFileer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +  protected final String TAG;</span>
  65    protected IEventListener mListener;
  66    protected TASK_WRAPPER mTaskWrapper;
  67    protected ENTITY mEntity;
  68    protected Context mContext;
  69    protected File mTempFile; //æ–‡ä»¶
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -  protected StateConstance mConstance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -  //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -  protected int mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -  //å·²å®Œæˆçš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -  private int mCompleteThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>

  76    private SparseArray&lt;AbsThreadTask&gt; mTask = new SparseArray&lt;&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
  78    private ScheduledThreadPoolExecutor mTimer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -  @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +</span>
  81    /**
  82     * è¿›åº¦åˆ·æ–°é—´éš”
  83     */
  84    private long mUpdateInterval = 1000;
  85    protected TaskRecord mRecord;



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -  protected AbsFileer(IEventListener listener, TASK_WRAPPER taskEntity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +  private IThreadState mStateManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +  private boolean isCancel = false, isStop = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +  protected AbsFileer(IEventListener listener, TASK_WRAPPER wrapper) {</span>
  92      mListener = listener;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -    mTaskWrapper = taskEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +    mTaskWrapper = wrapper;</span>
  95      mEntity = mTaskWrapper.getEntity();
  96      mContext = AriaManager.APP;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    mConstance = new StateConstance();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -  protected abstract int getType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -  public void setNewTask(boolean newTask) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    mTaskWrapper.setNewTask(newTask);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    TAG = CommonUtil.getClassName(getClass());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +  protected abstract IThreadState getStateManager(Looper looper);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +   * å¤„ç†ä»»åŠ¡</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +  protected abstract void handleTask();</span>
 114  
 115    public String getKey() {
 116      return mTaskWrapper.getKey();
 117    }
 118  
 119    public ENTITY getEntity() {
 120      return mEntity;
 121    }
 122  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -   * è®¾ç½®æœ€å¤§ä¸‹è½½/ä¸Šä¼ é€Ÿåº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -   * @param maxSpeed å•ä½ä¸ºï¼škb</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -  public void setMaxSpeed(int maxSpeed) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -    for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -      AbsThreadTask task = mTask.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -      if (task != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        task.setMaxSpeed(maxSpeed);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +  public SparseArray&lt;AbsThreadTask&gt; getTaskList() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +    return mTask;</span>
 137    }
 138  
 139    /**
 140     * é‡ç½®ä»»åŠ¡çŠ¶æ€
 141     */
 142    private void resetState() {
 143      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -    mCompleteThreadNum = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -    mTotalThreadNum = 0;</span>
 146      if (mTask != null &amp;&amp; mTask.size() != 0) {
 147        for (int i = 0; i &lt; mTask.size(); i++) {
 148          AbsThreadTask task = mTask.get(i);
 149          if (task != null) {
 150            task.breakTask();
 151          }
 152        }
 153        mTask.clear();
 154      }
 155    }
 156  
 157    /**
 158     * å¼€å§‹æµç¨‹
 159     */
 160    private void startFlow() {
 161      if (isBreak()) {
 162        return;
 163      }
 164      resetState();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    mConstance.resetState();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -    ALog.d(TAG, &quot;path: &quot; + getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -    checkRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -    mConstance.TASK_RECORD = mRecord;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -      mTotalThreadNum = 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -      mTotalThreadNum =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -          mTaskWrapper.isNewTask() ? setNewTaskThreadNum() : mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -    mConstance.START_THREAD_NUM = mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -    // å¤„ç†åˆ†å—å’ŒåŠ¨æ€æ–‡ä»¶å‚æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -    if (mTaskWrapper.isNewTask() &amp;&amp; mTaskWrapper instanceof DTaskWrapper) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -      AriaManager manager = AriaManager.getInstance(AriaManager.APP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -      mRecord.isBlock = mTotalThreadNum &gt; 1 &amp;&amp; manager.getDownloadConfig().isUseBlock();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -      // çº¿ç¨‹æ•°ä¸ç­‰1å¹¶ä¸”æ²¡æœ‰ä½¿ç”¨å—ä¸‹è½½ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰ä½¿ç”¨åŠ¨æ€æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -      mRecord.isOpenDynamicFile = mTotalThreadNum == 1 || mRecord.isBlock;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -    /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -     * mTaskWrapper.getEntity().getFileSize() != mTempFile.length()ä¸ºå…¼å®¹ä»¥å‰è€ç‰ˆæœ¬ä»£ç </span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -     * åŠ¨æ€é•¿åº¦æ¡ä»¶ï¼š</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -     * 1ã€æ€»çº¿ç¨‹æ•°ä¸º1ï¼Œå¹¶ä¸”æ˜¯æ–°ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -     * 2ã€æ€»çº¿ç¨‹æ•°ä¸º1ï¼Œä¸æ˜¯æ–°ä»»åŠ¡ï¼Œä½†æ˜¯é•¿åº¦ä¸æ˜¯æ–‡ä»¶å…¨é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    if (mTotalThreadNum == 1 &amp;&amp; (mTaskWrapper.getEntity().getFileSize() != mTempFile.length())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -      mRecord.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +    mRecord = new RecordHandler(mTaskWrapper).getRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +    Looper.prepare();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +    Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +    mStateManager = getStateManager(looper);</span>


 199      onPostPre();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -    if (!mTaskWrapper.isSupportBP()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -      handleNoSupportBP();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -      handleBreakpoint();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -    }</span>
 206      startTimer();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +    handleTask();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +    Looper.loop();</span>
 209    }
 210  
 211    @Override public void run() {
 212      if (isRunning()) {
 213        return;
 214      }
 215      startFlow();
 216    }
 217  
 218    /**
 219     * é¢„å¤„ç†å®Œæˆ
 220     */
 221    protected void onPostPre() {
 222  
 223    }
 224  
 225    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -   * è®¾ç½®æ–°ä»»åŠ¡çš„æœ€å¤§çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -  protected abstract int setNewTaskThreadNum();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +   * å»¶è¿Ÿå¯åŠ¨å®šæ—¶å™¨</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +  protected long delayTimer() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +    return 1000;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +  }</span>
 234  
 235    /**
 236     * å¯åŠ¨è¿›åº¦è·å–å®šæ—¶å™¨
 237     */
 238    private synchronized void startTimer() {
 239      ALog.d(TAG, &quot;å¯åŠ¨å®šæ—¶å™¨&quot;);
 240      mTimer = new ScheduledThreadPoolExecutor(1);
 241      mTimer.scheduleWithFixedDelay(new Runnable() {
 242        @Override public void run() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -        if (mConstance.isComplete()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -            || mConstance.isStop()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -            || mConstance.isCancel()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -            || mConstance.isFail()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        if (mStateManager.isComplete()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +            || mStateManager.isStop()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            || mStateManager.isCancel()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +            || mStateManager.isFail()</span>
 251              || !isRunning()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -          if (mConstance.isComplete() || mConstance.isFail()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +          if (mStateManager.isComplete() || mStateManager.isFail()) {</span>
 254              ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 255            }
 256            closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -        } else if (mConstance.CURRENT_LOCATION &gt;= 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -          mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        } else if (mStateManager.getCurrentProgress() &gt;= 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +          mListener.onProgress(mStateManager.getCurrentProgress());</span>
 261          }
 262        }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -    }, 0, mUpdateInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +    }, delayTimer(), mUpdateInterval, TimeUnit.MILLISECONDS);</span>
 265    }
 266  
 267    public synchronized void closeTimer() {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +    ALog.d(TAG, &quot;å…³é—­å®šæ—¶å™¨&quot;);</span>
 269      if (mTimer != null &amp;&amp; !mTimer.isShutdown()) {
 270        mTimer.shutdown();
 271      }
 272    }
 273  
 274    /**
 275     * è®¾ç½®å®šæ—¶å™¨æ›´æ–°é—´éš”
 276     *
 277     * @param interval å•ä½æ¯«ç§’ï¼Œä¸èƒ½å°äº0
 278     */
 279    protected void setUpdateInterval(long interval) {
 280      if (interval &lt; 0) {
 281        ALog.w(TAG, &quot;æ›´æ–°é—´éš”ä¸èƒ½å°äº0ï¼Œé»˜è®¤ä¸º1000æ¯«ç§’&quot;);
 282        return;
 283      }
 284      mUpdateInterval = interval;
 285    }
 286  
 287    public long getFileSize() {
 288      return mEntity.getFileSize();
 289    }
 290  
 291    /**
 292     * è·å–å½“å‰ä»»åŠ¡ä½ç½®
 293     */
 294    public long getCurrentLocation() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -    return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +    return mStateManager.getCurrentProgress();</span>
 297    }
 298  
 299    public synchronized boolean isRunning() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -    return ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +    boolean b = ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +    //ALog.d(TAG, &quot;isRunning = &quot; + b);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +    return b;</span>
 304    }
 305  
 306    public synchronized void cancel() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -    ALog.d(TAG, &quot;constance hash: &quot; + mConstance.hashCode());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -    if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +    if (isCancel) {</span>
 310        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 311        return;
 312      }
 313      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -    mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +    isCancel = true;</span>
 316      for (int i = 0; i &lt; mTask.size(); i++) {
 317        AbsThreadTask task = mTask.get(i);
 318        if (task != null) {
 319          task.cancel();
 320        }
 321      }
 322      ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 323    }
 324  
 325    public synchronized void stop() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -    if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +    if (isStop) {</span>
 328        return;
 329      }
 330      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -    mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -    if (mConstance.isComplete()) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +    isStop = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +    if (mStateManager.isComplete()) return;</span>
 335      for (int i = 0; i &lt; mTask.size(); i++) {
 336        AbsThreadTask task = mTask.get(i);
 337        if (task != null &amp;&amp; !task.isThreadComplete()) {
 338          task.stop();
 339        }
 340      }
 341      ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 342    }
 343  
 344    /**
 345     * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ
 346     */
 347    public synchronized void start() {
 348      if (isRunning()) {
 349        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 350        return;
 351      }
 352      new Thread(this).start();
 353    }
 354  
 355    public void resume() {
 356      start();
 357    }
 358  
 359    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -   * æ£€æŸ¥è®°å½• å¯¹äºåˆ†å—ä»»åŠ¡ï¼š å­åˆ†å—ä¸å­˜åœ¨æˆ–è¢«åˆ é™¤ï¼Œå­çº¿ç¨‹å°†é‡æ–°ä¸‹è½½ å¯¹äºæ™®é€šä»»åŠ¡ï¼š é¢„ä¸‹è½½æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»»åŠ¡ä»»åŠ¡å‘—åˆ é™¤</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -  private void checkRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -    mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -    if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -      convertDb();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -      mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -      if (mRecord == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -        if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -          initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -        } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -          handleBlockRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -          handleNormalRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -   * å¤„ç†æ™®é€šä»»åŠ¡çš„è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -  private void handleNormalRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -    File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -    if (!file.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -      ALog.w(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œä»»åŠ¡å°†é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -      mRecord.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -      initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -    if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -      ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -      if (tr == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        ALog.d(TAG, &quot;çº¿ç¨‹è®°å½•ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -        mTotalThreadNum = 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -      if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -        ALog.i(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘é”™è¯¯ï¼Œä»»åŠ¡é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -        file.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -        tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -        tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -        tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -      } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -        tr.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -          ALog.i(TAG, String.format(&quot;ä¿®æ­£ã€%sã€‘çš„è¿›åº¦è®°å½•ä¸ºï¼š%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -          tr.startLocation = file.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -          tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -      for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -        if (tr.isComplete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -    mTotalThreadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -   * å¤„ç†åˆ†å—ä»»åŠ¡çš„è®°å½•ï¼Œåˆ†å—æ–‡ä»¶ï¼ˆblockFileLenï¼‰é•¿åº¦å¿…é¡»éœ€è¦å°äºç­‰äºçº¿ç¨‹åŒºé—´ï¼ˆthreadRectLenï¼‰çš„é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -  private void handleBlockRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -    // é»˜è®¤çº¿ç¨‹åˆ†å—é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -    long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -    for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -      long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -      File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -      if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -        ALog.i(TAG, String.format(&quot;åˆ†å—æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œè¯¥åˆ†å—å°†é‡æ–°å¼€å§‹&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -        tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -        tr.startLocation = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -        if (tr.isComplete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -          ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -              &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -              tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -          long blockFileLen = temp.length(); // ç£ç›˜ä¸­çš„åˆ†å—æ–‡ä»¶é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -          /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -           * æ£€æŸ¥ç£ç›˜ä¸­çš„åˆ†å—æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -           */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -          if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -            ALog.i(TAG, String.format(&quot;åˆ†å—ã€%sã€‘é”™è¯¯ï¼Œåˆ†å—é•¿åº¦ã€%sã€‘ &gt; çº¿ç¨‹åŒºé—´é•¿åº¦ã€%sã€‘ï¼Œå°†é‡æ–°å¼€å§‹è¯¥åˆ†å—&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -                tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -            temp.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -            tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -            continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -          long realLocation =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -              tr.threadId * normalRectLen + blockFileLen; //æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹çš„startLocationçš„ä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -          /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -           * æ£€æŸ¥è®°å½•æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -           */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -          if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -            ALog.i(TAG, String.format(&quot;åˆ†å—ã€%sã€‘å·²å®Œæˆï¼Œæ›´æ–°è®°å½•&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -            tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -            tr.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -            mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -          } else if (tr.startLocation != realLocation) { // å¤„ç†è®°å½•å°äºåˆ†å—æ–‡ä»¶é•¿åº¦çš„æƒ…å†µ</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -            ALog.i(TAG, String.format(&quot;ä¿®æ­£åˆ†å—ã€%sã€‘çš„è¿›åº¦è®°å½•ä¸ºï¼š%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -            tr.startLocation = realLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -    mTotalThreadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -   * convertDb æ˜¯å…¼å®¹æ€§ä»£ç  ä»3.4.1å¼€å§‹ï¼Œçº¿ç¨‹é…ç½®ä¿¡æ¯å°†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ å°†é…ç½®æ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶åˆ é™¤</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -  private void convertDb() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -    List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -        DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -            getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -    if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -      Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -      if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -        ALog.d(TAG, &quot;è€ç‰ˆæœ¬çš„çº¿ç¨‹è®°å½•ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -      initRecord(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -      Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -      // è€ç‰ˆæœ¬è®°å½•æ˜¯5så­˜ä¸€æ¬¡ï¼Œä½†æ˜¯5sä¸­å†…ï¼Œå¦‚æœçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œrecordè®°å½•æ˜¯æ²¡æœ‰çš„ï¼Œåªæœ‰stateè®°å½•...</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -      // ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯record å’Œ stateå»é‡å–æ­£ç¡®çš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -      Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -      for (Object key : keys) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -        String str = String.valueOf(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -        int i = Integer.parseInt(str.substring(str.length() - 1, str.length()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -        set.add(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -      int threadNum = set.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -      if (threadNum == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -        ALog.d(TAG, &quot;çº¿ç¨‹æ•°ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -      mRecord.threadNum = threadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -      mTotalThreadNum = threadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -      for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -        ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -        tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -        Object state = pro.getProperty(mTempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -        Object record = pro.getProperty(mTempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -        if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -          tRecord.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -          continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -        if (record != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -          long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -          tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -          tRecord.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 532 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 533 -        mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 534 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 535 -      mConfigFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 536 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 537 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 538 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 539 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 540 -   * åˆå§‹åŒ–è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 541 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 542 -  private void initRecord(boolean isNewTask) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 543 -    mRecord = new TaskRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 544 -    mRecord.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 545 -    mRecord.filePath = getFilePath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 546 -    mRecord.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 547 -    mRecord.isGroupRecord = mTaskWrapper.getEntity().isGroupChild();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -    if (mRecord.isGroupRecord) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -      if (mTaskWrapper.getEntity() instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -        mRecord.dGroupHash = ((DownloadEntity) mTaskWrapper.getEntity()).getGroupHash();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -    ALog.d(TAG, String.format(&quot;åˆå§‹åŒ–è®°å½•ï¼Œä»»åŠ¡ä¸º%sä»»åŠ¡&quot;, isNewTask ? &quot;æ–°&quot; : &quot;æ—§&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -    mTaskWrapper.setNewTask(isNewTask);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -  private String getFilePath() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -    if (getType() == DOWNLOAD) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -      return ((DownloadEntity) mTaskWrapper.getEntity()).getDownloadPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -      return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -   * ä¿å­˜ä»»åŠ¡è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -  private void saveRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -    mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -    mRecord.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -    ALog.d(TAG, String.format(&quot;ä¿å­˜è®°å½•ï¼Œçº¿ç¨‹è®°å½•æ•°ï¼š%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -    DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -   * æ¢å¤è®°å½•åœ°å€</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 577 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -   * @return {@code true}ä»»åŠ¡å·²å®Œæˆ</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -  private boolean resumeRecordLocation(int i, long startL, long endL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -    mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -    ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -    mConstance.COMPLETE_THREAD_NUM = mCompleteThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -    mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -    mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -    if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -      mRecord.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -      mListener.onComplete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -      return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -    return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -   * å¯åŠ¨æ–­ç‚¹ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºå•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 596 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 597 -   * @param i çº¿ç¨‹id</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 598 -   * @param startL è¯¥ä»»åŠ¡èµ·å§‹ä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 599 -   * @param endL è¯¥ä»»åŠ¡ç»“æŸä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 600 -   * @param fileLength è¯¥ä»»åŠ¡éœ€è¦å¤„ç†çš„æ–‡ä»¶é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 601 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 602 -  private AbsThreadTask createSingThreadTask(int i, long startL, long endL, long fileLength,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 603 -      ThreadRecord record) {</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 604 -    SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 605 -    config.TOTAL_FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 606 -    config.URL = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 607 -    config.TEMP_FILE =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 608 -        mRecord.isBlock ? new File(String.format(SUB_PATH, mTempFile.getPath(), i)) : mTempFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 609 -    config.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 610 -    config.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 611 -    config.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 612 -    config.SUPPORT_BP = mTaskWrapper.isSupportBP();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -    config.TASK_WRAPPER = mTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -    config.THREAD_RECORD = record;</span>











<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -    return selectThreadTask(config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -  private void handleBreakpoint() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 619 -    long fileLength = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 620 -    long blockSize = fileLength / mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 621 -    Set&lt;Integer&gt; threads = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 622 -    //// å¦‚æœæ˜¯æ–°ä»»åŠ¡ï¼Œæ£€æŸ¥ä¸‹å†å²è®°å½•ï¼Œå¦‚æœæœ‰é—ç•™çš„è®°å½•ï¼Œåˆ é™¤å¹¶åˆ é™¤åˆ†å—æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 623 -    //if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 624 -    //  CommonUtil.delTaskRecord(getFilePath(), 1, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 625 -    //}</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 626 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 627 -    mRecord.fileLength = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 628 -    if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 629 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 630 -    }</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 631 -    for (int i = 0; i &lt; mTotalThreadNum; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -      long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -      ThreadRecord tr;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -      boolean isNewTr = false;  // æ˜¯å¦æ˜¯æ–°çš„çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -      if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 636 -        tr = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -        tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 638 -        tr.threadId = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -        isNewTr = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -        tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -      if (tr.blockLen == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -        tr.blockLen = CommonUtil.getBlockLen(fileLength, i, mTotalThreadNum);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -      }</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -      if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -        if (resumeRecordLocation(i, startL, endL)) return;</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -        continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -      //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -      if (tr.startLocation &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -        long r = tr.startLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -        //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -        if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -          mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -          startL = r;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 660 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 661 -        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 662 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 663 -        tr.startLocation = startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -      //æœ€åä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸä½ç½®å³ä¸ºæ–‡ä»¶çš„æ€»é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -      if (i == (mTotalThreadNum - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 667 -        endL = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 668 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 669 -      if (tr.endLocation &lt;= 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 670 -        tr.endLocation = endL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 671 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 672 -      if (isNewTr) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 673 -        mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 674 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 675 -      //ALog.d(TAG, String.format(&quot;åˆ›å»ºä»»åŠ¡çº¿ç¨‹ï¼š%sï¼Œçº¿ç¨‹æ€»æ•°ï¼š%s&quot;, i, mTotalThreadNum));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 676 -      AbsThreadTask task = createSingThreadTask(i, startL, endL, fileLength, tr);</span>








<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 677 -      if (task == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 678 -      mTask.put(i, task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 679 -      threads.add(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 680 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 681 -    if (mConstance.CURRENT_LOCATION != 0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 682 -        &amp;&amp; mConstance.CURRENT_LOCATION != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -      ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, mConstance.CURRENT_LOCATION));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 684 -      mEntity.setCurrentProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 685 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 686 -    saveRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 687 -    startThreadTask(threads);</span>









<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 688 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 689 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 690 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 691 -   * å¯åŠ¨å•çº¿ç¨‹ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 692 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 693 -  private void startThreadTask(Set&lt;Integer&gt; recordL) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 694 -    if (isBreak()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 695 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 696 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 697 -    if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 698 -      mListener.onResume(mConstance.CURRENT_LOCATION);</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 699 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 700 -      mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 701 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 702 -    for (int l : recordL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 703 -      if (l == -1) continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 704 -      ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(l));</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 705 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 706 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 707 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 708 -  /**</span>
 709     * é‡è¯•ä»»åŠ¡
 710     */
 711    public void retryTask() {
 712      ALog.w(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å¼€å§‹é‡è¯•&quot;, mEntity.getFileName()));
 713      startFlow();
 714    }
 715  
 716    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 717 -   * å¤„ç†æ–°ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 718 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 719 -   * @return {@code true}åˆ›å»ºæ–°ä»»åŠ¡å¤±è´¥</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 720 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 721 -  protected abstract boolean handleNewTask();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 722 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 723 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 724 -   * å¤„ç†ä¸æ”¯æŒæ–­ç‚¹çš„ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 725 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 726 -  private void handleNoSupportBP() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 727 -    if (mListener instanceof BaseDListener) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 728 -      ((BaseDListener) mListener).supportBreakpoint(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 729 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -    SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 731 -    config.TOTAL_FILE_SIZE = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 732 -    config.URL = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 733 -    config.TEMP_FILE = mTempFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 734 -    config.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 735 -    config.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 736 -    config.END_LOCATION = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 737 -    config.SUPPORT_BP = mTaskWrapper.isSupportBP();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 738 -    config.TASK_WRAPPER = mTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 739 -    ThreadRecord record = DbEntity.findFirst(ThreadRecord.class, &quot;key=?&quot;, mRecord.filePath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 740 -    if (record != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 741 -      record.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 742 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 743 -    record = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 744 -    record.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 745 -    record.endLocation = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -    record.key = mTempFile.getPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 747 -    mRecord.threadRecords.add(record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 748 -    config.THREAD_RECORD = record;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 749 -    AbsThreadTask task = selectThreadTask(config);</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 750 -    if (task == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 751 -    mTask.put(0, task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 752 -    saveRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 753 -    ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 754 -    mListener.onStart(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 755 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 756 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 758 -   * é€‰æ‹©å•ä»»åŠ¡çº¿ç¨‹çš„ç±»å‹</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 759 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 760 -  protected abstract AbsThreadTask selectThreadTask(SubThreadConfig&lt;TASK_WRAPPER&gt; config);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 761 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 762 -  /**</span>
 763     * ä»»åŠ¡æ˜¯å¦å·²ç»ä¸­æ–­
 764     *
 765     * @return {@code true}ä¸­æ–­
 766     */
 767    public boolean isBreak() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -    if (mConstance.isCancel || mConstance.isStop) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 769 +    if (isCancel || isStop) {</span>
 770        closeTimer();
 771        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å·²åœæ­¢æˆ–å–æ¶ˆäº†&quot;, mEntity.getFileName()));
 772        return true;
 773      }
 774      return false;
 775    }
 776  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  package com.arialyy.aria.core.common;
  17  
  18  import android.content.Context;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.os.Handler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import android.os.Looper;</span>
  21  import android.util.SparseArray;
  22  import com.arialyy.aria.core.AriaManager;
  23  import com.arialyy.aria.core.download.BaseDListener;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.arialyy.aria.core.download.DTaskWrapper;</span>
  26  import com.arialyy.aria.core.inf.AbsNormalEntity;
  27  import com.arialyy.aria.core.inf.AbsTaskWrapper;
  28  import com.arialyy.aria.core.inf.IEventListener;
  29  import com.arialyy.aria.core.manager.ThreadTaskManager;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.arialyy.aria.core.upload.UploadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.arialyy.aria.orm.DbEntity;</span>
  32  import com.arialyy.aria.util.ALog;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.arialyy.aria.util.DbDataHelper;</span>
  35  import java.io.File;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import java.util.HashSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.util.Set;</span>
  41  import java.util.concurrent.ScheduledThreadPoolExecutor;
  42  import java.util.concurrent.TimeUnit;
  43  
  44  /**
  45   * Created by AriaL on 2017/7/1. ä»»åŠ¡å¤„ç†å™¨


  46   */
  47  public abstract class AbsFileer&lt;ENTITY extends AbsNormalEntity, TASK_WRAPPER extends AbsTaskWrapper&lt;ENTITY&gt;&gt;
  48      implements Runnable {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -  private static final String STATE = &quot;_state_&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -  private static final String RECORD = &quot;_record_&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -   * åˆ†å—æ–‡ä»¶è·¯å¾„</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -  public static final String SUB_PATH = &quot;%s.%s.part&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -   * å°äº1mçš„æ–‡ä»¶ä¸å¯ç”¨å¤šçº¿ç¨‹</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -  protected static final long SUB_LEN = 1024 * 1024;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -  protected static final int DOWNLOAD = 0x1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -  protected static final int UPLOAD = 0x2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -</span>
  62    private final String TAG = &quot;AbsFileer&quot;;

  63    protected IEventListener mListener;
  64    protected TASK_WRAPPER mTaskWrapper;
  65    protected ENTITY mEntity;
  66    protected Context mContext;
  67    protected File mTempFile; //æ–‡ä»¶
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -  protected StateConstance mConstance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -  //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -  protected int mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -  //å·²å®Œæˆçš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -  private int mCompleteThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +  protected int mTotalThreadNum; //æ€»çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
  75    private SparseArray&lt;AbsThreadTask&gt; mTask = new SparseArray&lt;&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
  77    private ScheduledThreadPoolExecutor mTimer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -  @Deprecated private File mConfigFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +</span>
  80    /**
  81     * è¿›åº¦åˆ·æ–°é—´éš”
  82     */
  83    private long mUpdateInterval = 1000;
  84    protected TaskRecord mRecord;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +  private ThreadStateManager mStateManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +  private Handler mStateHandler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +  private boolean isCancel = false, isStop = false;</span>
  88  
  89    protected AbsFileer(IEventListener listener, TASK_WRAPPER taskEntity) {




  90      mListener = listener;
  91      mTaskWrapper = taskEntity;

  92      mEntity = mTaskWrapper.getEntity();
  93      mContext = AriaManager.APP;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    mConstance = new StateConstance();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -  protected abstract int getType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -  public void setNewTask(boolean newTask) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -    mTaskWrapper.setNewTask(newTask);</span>
 101    }









 102  
 103    public String getKey() {
 104      return mTaskWrapper.getKey();
 105    }
 106  
 107    public ENTITY getEntity() {
 108      return mEntity;
 109    }
 110  
 111    /**
 112     * è®¾ç½®æœ€å¤§ä¸‹è½½/ä¸Šä¼ é€Ÿåº¦
 113     *
 114     * @param maxSpeed å•ä½ä¸ºï¼škb
 115     */
 116    public void setMaxSpeed(int maxSpeed) {
 117      for (int i = 0; i &lt; mTotalThreadNum; i++) {
 118        AbsThreadTask task = mTask.get(i);
 119        if (task != null) {
 120          task.setMaxSpeed(maxSpeed);
 121        }
 122      }


 123    }
 124  
 125    /**
 126     * é‡ç½®ä»»åŠ¡çŠ¶æ€
 127     */
 128    private void resetState() {
 129      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    mCompleteThreadNum = 0;</span>
 131      mTotalThreadNum = 0;
 132      if (mTask != null &amp;&amp; mTask.size() != 0) {
 133        for (int i = 0; i &lt; mTask.size(); i++) {
 134          AbsThreadTask task = mTask.get(i);
 135          if (task != null) {
 136            task.breakTask();
 137          }
 138        }
 139        mTask.clear();
 140      }
 141    }
 142  
 143    /**
 144     * å¼€å§‹æµç¨‹
 145     */
 146    private void startFlow() {
 147      if (isBreak()) {
 148        return;
 149      }
 150      resetState();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -    mConstance.resetState();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -    ALog.d(TAG, &quot;path: &quot; + getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -    checkRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -    mConstance.TASK_RECORD = mRecord;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -    if (!mTaskWrapper.isSupportBP() || mTaskWrapper.asHttp().isChunked()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -      mTotalThreadNum = 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -      mTotalThreadNum =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -          mTaskWrapper.isNewTask() ? setNewTaskThreadNum() : mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -    mConstance.START_THREAD_NUM = mTotalThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -    // å¤„ç†åˆ†å—å’ŒåŠ¨æ€æ–‡ä»¶å‚æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -    if (mTaskWrapper.isNewTask() &amp;&amp; mTaskWrapper instanceof DTaskWrapper) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -      AriaManager manager = AriaManager.getInstance(AriaManager.APP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -      mRecord.isBlock = mTotalThreadNum &gt; 1 &amp;&amp; manager.getDownloadConfig().isUseBlock();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -      // çº¿ç¨‹æ•°ä¸ç­‰1å¹¶ä¸”æ²¡æœ‰ä½¿ç”¨å—ä¸‹è½½ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰ä½¿ç”¨åŠ¨æ€æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -      mRecord.isOpenDynamicFile = mTotalThreadNum == 1 || mRecord.isBlock;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -     * mTaskWrapper.getEntity().getFileSize() != mTempFile.length()ä¸ºå…¼å®¹ä»¥å‰è€ç‰ˆæœ¬ä»£ç </span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -     * åŠ¨æ€é•¿åº¦æ¡ä»¶ï¼š</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -     * 1ã€æ€»çº¿ç¨‹æ•°ä¸º1ï¼Œå¹¶ä¸”æ˜¯æ–°ä»»åŠ¡</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -     * 2ã€æ€»çº¿ç¨‹æ•°ä¸º1ï¼Œä¸æ˜¯æ–°ä»»åŠ¡ï¼Œä½†æ˜¯é•¿åº¦ä¸æ˜¯æ–‡ä»¶å…¨é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -    if (mTotalThreadNum == 1 &amp;&amp; (mTaskWrapper.getEntity().getFileSize() != mTempFile.length())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -      mRecord.isOpenDynamicFile = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +    mRecord = new RecordHandler(mTaskWrapper).getRecord();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +    mTotalThreadNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +    Looper.prepare();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    Looper looper = Looper.myLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +    mStateManager = new ThreadStateManager(looper, mRecord, mListener);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    mStateHandler = new Handler(looper, mStateManager);</span>
 187      onPostPre();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -</span>
 189      if (!mTaskWrapper.isSupportBP()) {
 190        handleNoSupportBP();
 191      } else {
 192        handleBreakpoint();
 193      }
 194      startTimer();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +    Looper.loop();</span>

 196    }
 197  
 198    @Override public void run() {
 199      if (isRunning()) {
 200        return;
 201      }
 202      startFlow();
 203    }
 204  
 205    /**
 206     * é¢„å¤„ç†å®Œæˆ
 207     */
 208    protected void onPostPre() {
 209  
 210    }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -   * è®¾ç½®æ–°ä»»åŠ¡çš„æœ€å¤§çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -  protected abstract int setNewTaskThreadNum();</span>





 216  
 217    /**
 218     * å¯åŠ¨è¿›åº¦è·å–å®šæ—¶å™¨
 219     */
 220    private synchronized void startTimer() {
 221      ALog.d(TAG, &quot;å¯åŠ¨å®šæ—¶å™¨&quot;);
 222      mTimer = new ScheduledThreadPoolExecutor(1);
 223      mTimer.scheduleWithFixedDelay(new Runnable() {
 224        @Override public void run() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -        if (mConstance.isComplete()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -            || mConstance.isStop()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -            || mConstance.isCancel()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -            || mConstance.isFail()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        if (mStateManager.isComplete()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            || mStateManager.isStop()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +            || mStateManager.isCancel()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +            || mStateManager.isFail()</span>
 233              || !isRunning()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -          if (mConstance.isComplete() || mConstance.isFail()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +          if (mStateManager.isComplete() || mStateManager.isFail()) {</span>
 236              ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 237            }
 238            closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -        } else if (mConstance.CURRENT_LOCATION &gt;= 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -          mListener.onProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        } else if (mStateManager.getCurrentProgress() &gt;= 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +          mListener.onProgress(mStateManager.getCurrentProgress());</span>
 243          }
 244        }
 245      }, 0, mUpdateInterval, TimeUnit.MILLISECONDS);

 246    }
 247  
 248    public synchronized void closeTimer() {

 249      if (mTimer != null &amp;&amp; !mTimer.isShutdown()) {
 250        mTimer.shutdown();
 251      }
 252    }
 253  
 254    /**
 255     * è®¾ç½®å®šæ—¶å™¨æ›´æ–°é—´éš”
 256     *
 257     * @param interval å•ä½æ¯«ç§’ï¼Œä¸èƒ½å°äº0
 258     */
 259    protected void setUpdateInterval(long interval) {
 260      if (interval &lt; 0) {
 261        ALog.w(TAG, &quot;æ›´æ–°é—´éš”ä¸èƒ½å°äº0ï¼Œé»˜è®¤ä¸º1000æ¯«ç§’&quot;);
 262        return;
 263      }
 264      mUpdateInterval = interval;
 265    }
 266  
 267    public long getFileSize() {
 268      return mEntity.getFileSize();
 269    }
 270  
 271    /**
 272     * è·å–å½“å‰ä»»åŠ¡ä½ç½®
 273     */
 274    public long getCurrentLocation() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -    return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +    return mStateManager.getCurrentProgress();</span>
 277    }
 278  
 279    public synchronized boolean isRunning() {
 280      return ThreadTaskManager.getInstance().taskIsRunning(mTaskWrapper.getKey());



 281    }
 282  
 283    public synchronized void cancel() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -    ALog.d(TAG, &quot;constance hash: &quot; + mConstance.hashCode());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -    if (mConstance.isCancel) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +    if (isCancel) {</span>
 287        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨åˆ é™¤ï¼Œåˆ é™¤ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 288        return;
 289      }
 290      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -    mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +    isCancel = true;</span>
 293      for (int i = 0; i &lt; mTask.size(); i++) {
 294        AbsThreadTask task = mTask.get(i);
 295        if (task != null) {
 296          task.cancel();
 297        }
 298      }
 299      ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 300    }
 301  
 302    public synchronized void stop() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -    if (mConstance.isStop) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +    if (isStop) {</span>
 305        return;
 306      }
 307      closeTimer();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -    mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -    if (mConstance.isComplete()) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +    isStop = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +    if (mStateManager.isComplete()) return;</span>
 312      for (int i = 0; i &lt; mTask.size(); i++) {
 313        AbsThreadTask task = mTask.get(i);
 314        if (task != null &amp;&amp; !task.isThreadComplete()) {
 315          task.stop();
 316        }
 317      }
 318      ThreadTaskManager.getInstance().removeTaskThread(mTaskWrapper.getKey());
 319    }
 320  
 321    /**
 322     * ç›´æ¥è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ
 323     */
 324    public synchronized void start() {
 325      if (isRunning()) {
 326        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œå¯åŠ¨ä»»åŠ¡å¤±è´¥&quot;, mTaskWrapper.getKey()));
 327        return;
 328      }
 329      new Thread(this).start();
 330    }
 331  
 332    public void resume() {
 333      start();
 334    }
 335  
 336    /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -   * æ£€æŸ¥è®°å½• å¯¹äºåˆ†å—ä»»åŠ¡ï¼š å­åˆ†å—ä¸å­˜åœ¨æˆ–è¢«åˆ é™¤ï¼Œå­çº¿ç¨‹å°†é‡æ–°ä¸‹è½½ å¯¹äºæ™®é€šä»»åŠ¡ï¼š é¢„ä¸‹è½½æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»»åŠ¡ä»»åŠ¡å‘—åˆ é™¤</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -  private void checkRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -    mConfigFile = new File(CommonUtil.getFileConfigPath(false, mEntity.getFileName()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -    if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -      convertDb();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -      mRecord = DbDataHelper.getTaskRecord(getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -      if (mRecord == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -        initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -        if (mRecord.threadRecords == null || mRecord.threadRecords.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -          initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -        } else if (mRecord.isBlock) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -          handleBlockRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -          handleNormalRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -   * å¤„ç†æ™®é€šä»»åŠ¡çš„è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -  private void handleNormalRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -    File file = new File(mRecord.filePath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -    if (!file.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -      ALog.w(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œä»»åŠ¡å°†é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -      mRecord.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -      initRecord(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -    if (mRecord.isOpenDynamicFile) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -      ThreadRecord tr = mRecord.threadRecords.get(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -      if (tr == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -        ALog.d(TAG, &quot;çº¿ç¨‹è®°å½•ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -        mTotalThreadNum = 1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -      if (file.length() &gt; mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -        ALog.i(TAG, String.format(&quot;æ–‡ä»¶ã€%sã€‘é”™è¯¯ï¼Œä»»åŠ¡é‡æ–°å¼€å§‹&quot;, file.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -        file.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -        tr.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -        tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -        tr.endLocation = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -      } else if (file.length() == mEntity.getFileSize()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -        tr.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -        mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -        if (file.length() != tr.startLocation) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -          ALog.i(TAG, String.format(&quot;ä¿®æ­£ã€%sã€‘çš„è¿›åº¦è®°å½•ä¸ºï¼š%s&quot;, file.getPath(), file.length()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -          tr.startLocation = file.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -          tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -      for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        if (tr.isComplete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -    mTotalThreadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -   * å¤„ç†åˆ†å—ä»»åŠ¡çš„è®°å½•ï¼Œåˆ†å—æ–‡ä»¶ï¼ˆblockFileLenï¼‰é•¿åº¦å¿…é¡»éœ€è¦å°äºç­‰äºçº¿ç¨‹åŒºé—´ï¼ˆthreadRectLenï¼‰çš„é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -  private void handleBlockRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -    // é»˜è®¤çº¿ç¨‹åˆ†å—é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -    long normalRectLen = mEntity.getFileSize() / mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -    for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -      long threadRect = tr.blockLen;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -      File temp = new File(String.format(SUB_PATH, mRecord.filePath, tr.threadId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -      if (!temp.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -        ALog.i(TAG, String.format(&quot;åˆ†å—æ–‡ä»¶ã€%sã€‘ä¸å­˜åœ¨ï¼Œè¯¥åˆ†å—å°†é‡æ–°å¼€å§‹&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -        tr.isComplete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -        tr.startLocation = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -        if (tr.isComplete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -          ALog.i(TAG, String.format(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -              &quot;startLocation = %s; endLocation = %s; block = %s; tempLen = %s; threadId = %s&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -              tr.startLocation, tr.endLocation, threadRect, temp.length(), tr.threadId));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -          long blockFileLen = temp.length(); // ç£ç›˜ä¸­çš„åˆ†å—æ–‡ä»¶é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -          /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -           * æ£€æŸ¥ç£ç›˜ä¸­çš„åˆ†å—æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -           */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -          if (blockFileLen &gt; threadRect) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -            ALog.i(TAG, String.format(&quot;åˆ†å—ã€%sã€‘é”™è¯¯ï¼Œåˆ†å—é•¿åº¦ã€%sã€‘ &gt; çº¿ç¨‹åŒºé—´é•¿åº¦ã€%sã€‘ï¼Œå°†é‡æ–°å¼€å§‹è¯¥åˆ†å—&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -                tr.threadId, blockFileLen, threadRect));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -            temp.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -            tr.startLocation = tr.threadId * threadRect;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -            continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -          long realLocation =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -              tr.threadId * normalRectLen + blockFileLen; //æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹çš„startLocationçš„ä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -          /*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -           * æ£€æŸ¥è®°å½•æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -           */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -          if (blockFileLen == threadRect) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -            ALog.i(TAG, String.format(&quot;åˆ†å—ã€%sã€‘å·²å®Œæˆï¼Œæ›´æ–°è®°å½•&quot;, temp.getPath()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -            tr.startLocation = blockFileLen;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -            tr.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -            mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -          } else if (tr.startLocation != realLocation) { // å¤„ç†è®°å½•å°äºåˆ†å—æ–‡ä»¶é•¿åº¦çš„æƒ…å†µ</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -            ALog.i(TAG, String.format(&quot;ä¿®æ­£åˆ†å—ã€%sã€‘çš„è¿›åº¦è®°å½•ä¸ºï¼š%s&quot;, temp.getPath(), realLocation));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            tr.startLocation = realLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -    mTotalThreadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -    mTaskWrapper.setNewTask(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -   * convertDb æ˜¯å…¼å®¹æ€§ä»£ç  ä»3.4.1å¼€å§‹ï¼Œçº¿ç¨‹é…ç½®ä¿¡æ¯å°†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ å°†é…ç½®æ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶åˆ é™¤</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -  private void convertDb() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -    List&lt;RecordWrapper&gt; records =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -        DbEntity.findRelationData(RecordWrapper.class, &quot;TaskRecord.filePath=?&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -            getFilePath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -    if (records == null || records.size() == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -      Properties pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -      if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -        ALog.d(TAG, &quot;è€ç‰ˆæœ¬çš„çº¿ç¨‹è®°å½•ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -      initRecord(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -      Set&lt;Object&gt; keys = pro.keySet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -      // è€ç‰ˆæœ¬è®°å½•æ˜¯5så­˜ä¸€æ¬¡ï¼Œä½†æ˜¯5sä¸­å†…ï¼Œå¦‚æœçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œrecordè®°å½•æ˜¯æ²¡æœ‰çš„ï¼Œåªæœ‰stateè®°å½•...</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -      // ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯record å’Œ stateå»é‡å–æ­£ç¡®çš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -      Set&lt;Integer&gt; set = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -      for (Object key : keys) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -        String str = String.valueOf(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -        int i = Integer.parseInt(str.substring(str.length() - 1, str.length()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -        set.add(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -      int threadNum = set.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -      if (threadNum == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -        ALog.d(TAG, &quot;çº¿ç¨‹æ•°ä¸ºç©ºï¼Œä»»åŠ¡ä¸ºæ–°ä»»åŠ¡&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -        mTaskWrapper.setNewTask(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -        return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -      mRecord.threadNum = threadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -      mTotalThreadNum = threadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -      for (int i = 0; i &lt; threadNum; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -        ThreadRecord tRecord = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -        tRecord.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -        Object state = pro.getProperty(mTempFile.getName() + STATE + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -        Object record = pro.getProperty(mTempFile.getName() + RECORD + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -        if (state != null &amp;&amp; Integer.parseInt(String.valueOf(state)) == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -          mCompleteThreadNum++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -          tRecord.isComplete = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -          continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -        if (record != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -          long temp = Long.parseLong(String.valueOf(record));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -          tRecord.startLocation = temp &gt; 0 ? temp : 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -          tRecord.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -        mRecord.threadRecords.add(tRecord);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -      mConfigFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -   * åˆå§‹åŒ–è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -  private void initRecord(boolean isNewTask) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -    mRecord = new TaskRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -    mRecord.fileName = mEntity.getFileName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -    mRecord.filePath = getFilePath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -    mRecord.threadRecords = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -    mRecord.isGroupRecord = mTaskWrapper.getEntity().isGroupChild();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -    if (mRecord.isGroupRecord) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -      if (mTaskWrapper.getEntity() instanceof DownloadEntity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -        mRecord.dGroupHash = ((DownloadEntity) mTaskWrapper.getEntity()).getGroupHash();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -    ALog.d(TAG, String.format(&quot;åˆå§‹åŒ–è®°å½•ï¼Œä»»åŠ¡ä¸º%sä»»åŠ¡&quot;, isNewTask ? &quot;æ–°&quot; : &quot;æ—§&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -    mTaskWrapper.setNewTask(isNewTask);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 532 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 533 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 534 -  private String getFilePath() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 535 -    if (getType() == DOWNLOAD) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 536 -      return ((DownloadEntity) mTaskWrapper.getEntity()).getDownloadPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 537 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 538 -      return ((UploadEntity) mTaskWrapper.getEntity()).getFilePath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 539 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 540 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 541 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 542 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 543 -   * ä¿å­˜ä»»åŠ¡è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 544 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 545 -  private void saveRecord() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 546 -    mRecord.threadNum = mRecord.threadRecords.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 547 -    mRecord.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -    ALog.d(TAG, String.format(&quot;ä¿å­˜è®°å½•ï¼Œçº¿ç¨‹è®°å½•æ•°ï¼š%s&quot;, mRecord.threadRecords.size()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -    DbEntity.saveAll(mRecord.threadRecords);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -   * æ¢å¤è®°å½•åœ°å€</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -   * @return {@code true}ä»»åŠ¡å·²å®Œæˆ</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -  private boolean resumeRecordLocation(int i, long startL, long endL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -    mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -    ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -    mConstance.COMPLETE_THREAD_NUM = mCompleteThreadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -    mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -    mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -    if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -      mRecord.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -      mListener.onComplete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -      return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -    return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -  /**</span>
 572     * å¯åŠ¨æ–­ç‚¹ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºå•çº¿ç¨‹ä»»åŠ¡
 573     *
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -   * @param i çº¿ç¨‹id</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -   * @param startL è¯¥ä»»åŠ¡èµ·å§‹ä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -   * @param endL è¯¥ä»»åŠ¡ç»“æŸä½ç½®</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 577 -   * @param fileLength è¯¥ä»»åŠ¡éœ€è¦å¤„ç†çš„æ–‡ä»¶é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -  private AbsThreadTask createSingThreadTask(int i, long startL, long endL, long fileLength,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -      ThreadRecord record) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +   * @param record çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 582 +   * @param startNum å¯åŠ¨çš„çº¿ç¨‹æ•°</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 583 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 584 +  private AbsThreadTask createSingThreadTask(ThreadRecord record, int startNum) {</span>
 585      SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -    config.TOTAL_FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -    config.URL = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -    config.TEMP_FILE =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -        mRecord.isBlock ? new File(String.format(SUB_PATH, mTempFile.getPath(), i)) : mTempFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -    config.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -    config.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -    config.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -    config.SUPPORT_BP = mTaskWrapper.isSupportBP();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -    config.TASK_WRAPPER = mTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -    config.THREAD_RECORD = record;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +    config.url = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 597 +    config.tempFile =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +        mRecord.isBlock ? new File(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +            String.format(RecordHandler.SUB_PATH, mTempFile.getPath(), record.threadId))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +            : mTempFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +    config.isBlock = mRecord.isBlock;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +    config.isOpenDynamicFile = mRecord.isOpenDynamicFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 603 +    config.startThreadNum = startNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 604 +    config.taskWrapper = mTaskWrapper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +    config.record = record;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 606 +    config.stateHandler = mStateHandler;</span>
 607      return selectThreadTask(config);
 608    }
 609  
 610    private void handleBreakpoint() {
 611      long fileLength = mEntity.getFileSize();
 612      long blockSize = fileLength / mTotalThreadNum;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -    Set&lt;Integer&gt; threads = new HashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -    //// å¦‚æœæ˜¯æ–°ä»»åŠ¡ï¼Œæ£€æŸ¥ä¸‹å†å²è®°å½•ï¼Œå¦‚æœæœ‰é—ç•™çš„è®°å½•ï¼Œåˆ é™¤å¹¶åˆ é™¤åˆ†å—æ–‡ä»¶</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -    //if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -    //  CommonUtil.delTaskRecord(getFilePath(), 1, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -    //}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +    long currentProgress = 0;</span>
 619  
 620      mRecord.fileLength = fileLength;
 621      if (mTaskWrapper.isNewTask() &amp;&amp; !handleNewTask()) {
 622        return;
 623      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +    int startNum = mRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 626 +    for (ThreadRecord tr : mRecord.threadRecords) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +      if (!tr.isComplete) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +        startNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 630 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 631 +</span>
 632      for (int i = 0; i &lt; mTotalThreadNum; i++) {
 633        long startL = i * blockSize, endL = (i + 1) * blockSize;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -      ThreadRecord tr;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -      boolean isNewTr = false;  // æ˜¯å¦æ˜¯æ–°çš„çº¿ç¨‹è®°å½•</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 636 -      if (mTaskWrapper.isNewTask()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -        tr = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 638 -        tr.key = mRecord.filePath;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -        tr.threadId = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -        isNewTr = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -        tr = mRecord.threadRecords.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -      if (tr.blockLen == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -        tr.blockLen = CommonUtil.getBlockLen(fileLength, i, mTotalThreadNum);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 648 +      ThreadRecord tr = mRecord.threadRecords.get(i);</span>
 649  
 650        if (tr.isComplete) {//è¯¥çº¿ç¨‹å·²ç»å®Œæˆ
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -        if (resumeRecordLocation(i, startL, endL)) return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 652 +        currentProgress += endL - startL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 653 +        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__å·²å®Œæˆ&quot;, mTaskWrapper.getEntity().getFileName(), i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 654 +        mStateHandler.obtainMessage(ThreadStateManager.STATE_COMPLETE).sendToTarget();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 655 +        if (mStateManager.isComplete()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +          mRecord.deleteData();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +          mListener.onComplete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +          return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +        }</span>
 660          continue;
 661        }
 662  
 663        //å¦‚æœæœ‰è®°å½•ï¼Œåˆ™æ¢å¤ä»»åŠ¡
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -      if (tr.startLocation &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -        long r = tr.startLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -        //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 667 -        if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 668 -          mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 669 -          startL = r;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 670 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 671 -        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 672 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 673 -        tr.startLocation = startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 674 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 675 -      //æœ€åä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸä½ç½®å³ä¸ºæ–‡ä»¶çš„æ€»é•¿åº¦</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 676 -      if (i == (mTotalThreadNum - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 677 -        endL = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 678 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 679 -      if (tr.endLocation &lt;= 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 680 -        tr.endLocation = endL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 681 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 682 -      if (isNewTr) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -        mRecord.threadRecords.add(tr);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 684 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 685 -      //ALog.d(TAG, String.format(&quot;åˆ›å»ºä»»åŠ¡çº¿ç¨‹ï¼š%sï¼Œçº¿ç¨‹æ€»æ•°ï¼š%s&quot;, i, mTotalThreadNum));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 686 -      AbsThreadTask task = createSingThreadTask(i, startL, endL, fileLength, tr);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 687 +      long r = tr.startLocation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 688 +      //è®°å½•çš„ä½ç½®éœ€è¦åœ¨çº¿ç¨‹åŒºé—´ä¸­</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 689 +      if (startL &lt; r &amp;&amp; r &lt;= (i == (mTotalThreadNum - 1) ? fileLength : endL)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 690 +        currentProgress += r - startL;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 691 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 692 +      ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘çº¿ç¨‹__%s__æ¢å¤ä»»åŠ¡&quot;, mEntity.getFileName(), i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 694 +      AbsThreadTask task = createSingThreadTask(tr, startNum);</span>
 695        if (task == null) return;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 696 -      mTask.put(i, task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 697 -      threads.add(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 698 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 699 -    if (mConstance.CURRENT_LOCATION != 0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 700 -        &amp;&amp; mConstance.CURRENT_LOCATION != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 701 -      ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, mConstance.CURRENT_LOCATION));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 702 -      mEntity.setCurrentProgress(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 703 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 704 -    saveRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 705 -    startThreadTask(threads);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 706 +      mTask.put(tr.threadId, task);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 707 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 708 +    if (currentProgress != 0 &amp;&amp; currentProgress != mEntity.getCurrentProgress()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 709 +      ALog.d(TAG, String.format(&quot;è¿›åº¦ä¿®æ­£ï¼Œå½“å‰è¿›åº¦ï¼š%s&quot;, currentProgress));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 710 +      mEntity.setCurrentProgress(currentProgress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 711 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 712 +    mStateHandler.obtainMessage(ThreadStateManager.STATE_UPDATE_PROGRESS, currentProgress)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 713 +        .sendToTarget();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 714 +    startThreadTask();</span>
 715    }
 716  
 717    /**
 718     * å¯åŠ¨å•çº¿ç¨‹ä»»åŠ¡
 719     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 720 -  private void startThreadTask(Set&lt;Integer&gt; recordL) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 721 +  private void startThreadTask() {</span>
 722      if (isBreak()) {
 723        return;
 724      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 725 -    if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 726 -      mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 727 +    if (mStateManager.getCurrentProgress() &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 728 +      mListener.onResume(mStateManager.getCurrentProgress());</span>
 729      } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -      mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 731 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 732 -    for (int l : recordL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 733 -      if (l == -1) continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 734 -      ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(l));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 735 +      mListener.onStart(mStateManager.getCurrentProgress());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 736 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 737 +    for (int i = 0; i &lt; mTask.size(); i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 738 +      ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), mTask.get(i));</span>
 739      }
 740    }
 741  
 742    /**
 743     * é‡è¯•ä»»åŠ¡
 744     */
 745    public void retryTask() {
 746      ALog.w(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å¼€å§‹é‡è¯•&quot;, mEntity.getFileName()));
 747      startFlow();
 748    }
 749  
 750    /**
 751     * å¤„ç†æ–°ä»»åŠ¡
 752     *
 753     * @return {@code true}åˆ›å»ºæ–°ä»»åŠ¡å¤±è´¥
 754     */
 755    protected abstract boolean handleNewTask();
 756  
 757    /**
 758     * å¤„ç†ä¸æ”¯æŒæ–­ç‚¹çš„ä»»åŠ¡
 759     */
 760    private void handleNoSupportBP() {
 761      if (mListener instanceof BaseDListener) {
 762        ((BaseDListener) mListener).supportBreakpoint(false);
 763      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 764 -    SubThreadConfig&lt;TASK_WRAPPER&gt; config = new SubThreadConfig&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 765 -    config.TOTAL_FILE_SIZE = mEntity.getFileSize();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 766 -    config.URL = mEntity.isRedirect() ? mEntity.getRedirectUrl() : mEntity.getUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 767 -    config.TEMP_FILE = mTempFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -    config.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 769 -    config.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -    config.END_LOCATION = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -    config.SUPPORT_BP = mTaskWrapper.isSupportBP();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -    config.TASK_WRAPPER = mTaskWrapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -    ThreadRecord record = DbEntity.findFirst(ThreadRecord.class, &quot;key=?&quot;, mRecord.filePath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 774 -    if (record != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 775 -      record.deleteData();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -    record = new ThreadRecord();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -    record.startLocation = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -    record.endLocation = config.TOTAL_FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -    record.key = mTempFile.getPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -    mRecord.threadRecords.add(record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -    config.THREAD_RECORD = record;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 783 -    AbsThreadTask task = selectThreadTask(config);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 784 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +    AbsThreadTask task = createSingThreadTask(mRecord.threadRecords.get(0), 1);</span>
 786      if (task == null) return;
 787      mTask.put(0, task);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 788 -    saveRecord();</span>
 789      ThreadTaskManager.getInstance().startThread(mTaskWrapper.getKey(), task);
 790      mListener.onStart(0);
 791    }
 792  
 793    /**
 794     * é€‰æ‹©å•ä»»åŠ¡çº¿ç¨‹çš„ç±»å‹
 795     */
 796    protected abstract AbsThreadTask selectThreadTask(SubThreadConfig&lt;TASK_WRAPPER&gt; config);
 797  
 798    /**
 799     * ä»»åŠ¡æ˜¯å¦å·²ç»ä¸­æ–­
 800     *
 801     * @return {@code true}ä¸­æ–­
 802     */
 803    public boolean isBreak() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 804 -    if (mConstance.isCancel || mConstance.isStop) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 805 +    if (isCancel || isStop) {</span>
 806        closeTimer();
 807        ALog.d(TAG, String.format(&quot;ä»»åŠ¡ã€%sã€‘å·²åœæ­¢æˆ–å–æ¶ˆäº†&quot;, mEntity.getFileName()));
 808        return true;
 809      }
 810      return false;
 811    }
 812  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            