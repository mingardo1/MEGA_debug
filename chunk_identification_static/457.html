<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>457</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    457
                    <a href="456.html">prev</a>
                    <a href="458.html">next</a>
                    <a href="457_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_658a6401f4f487101aa34499ee28925ef80ffac3_oracle/oracle-sink/src/main/java/com/dtstack/flink/sql/sink/oracle/OracleSink.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;658a6401f4f487101aa34499ee28925ef80ffac3:oracle/oracle-sink/src/main/java/com/dtstack/flink/sql/sink/oracle/OracleSink.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;658a6401f4f487101aa34499ee28925ef80ffac3^1:oracle/oracle-sink/src/main/java/com/dtstack/flink/sql/sink/oracle/OracleSink.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;658a6401f4f487101aa34499ee28925ef80ffac3^2:oracle/oracle-sink/src/main/java/com/dtstack/flink/sql/sink/oracle/OracleSink.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;0e612c38ef73e0fe86c07e0b47c41fb3ae2d0f0b:oracle/oracle-sink/src/main/java/com/dtstack/flink/sql/sink/oracle/OracleSink.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [j]], subset: [[b], [b], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.oracle;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.rdb.JDBCOptions;
  22 import com.dtstack.flink.sql.sink.rdb.RdbSink;
  23 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;</span>
  25 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.dtstack.flink.sql.sink.rdb.format.ExtendOutputFormat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import com.dtstack.flink.sql.sink.rdb.format.RetractJDBCOutputFormat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38  * Reason:</span>
  39 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import com.dtstack.flink.sql.sink.rdb.format.ExtendOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import com.dtstack.flink.sql.sink.rdb.format.RetractJDBCOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.util.stream.Collectors;</span>
  53 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  54 
  55 /**
  56  * Reason:
  57  * Date: 2018/11/27
  58  * Company: www.dtstack.com
  59  *
  60  * @author maqi
  61  */
  62 public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {
  63 
  64 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     public OracleSink() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66         super(new OracleDialect());</span>
  67 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69  * Date: 2018/11/27</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72  * @author maqi</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75     private static final String ORACLE_DRIVER = &quot;oracle.jdbc.driver.OracleDriver&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78     public String getDriverName() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         return ORACLE_DRIVER;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83     public RetractJDBCOutputFormat getOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         return new ExtendOutputFormat();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 </span>
  87 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88     private final String SQL_DEFAULT_PLACEHOLDER = &quot; ? &quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     private final String DEAL_CHAR_KEY = &quot;char&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90     private String RPAD_FORMAT = &quot; rpad(?, %d, &#x27; &#x27;) &quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93     public String getDriverName() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         return ORACLE_DRIVER;</span>
  95 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  96     }
  97 
  98     @Override
  99     public JDBCUpsertOutputFormat getOutputFormat() {
 100         JDBCOptions jdbcOptions = JDBCOptions.builder()
 101                 .setDBUrl(dbURL)
 102                 .setDialect(jdbcDialect)
 103                 .setUsername(userName)
 104                 .setPassword(password)
 105                 .setTableName(tableName)
 106                 .setSchema(schema)
 107                 .build();
 108 
 109         return JDBCUpsertOutputFormat.builder()
 110                 .setOptions(jdbcOptions)
 111                 .setFieldNames(fieldNames)
 112                 .setFlushMaxSize(batchNum)
 113                 .setFlushIntervalMills(batchWaitInterval)
 114                 .setFieldTypes(sqlTypes)
 115                 .setKeyFields(primaryKeys)
 116                 .setAllReplace(allReplace)
 117                 .setUpdateMode(updateMode)
 118                 .build();
 119     }
 120 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 121 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         tableName = DtStringUtil.getTableFullPath(scheam,tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         String sqlTmp = &quot;insert into &quot; + tableName + &quot; (${fields}) values (${placeholder})&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         List&lt;String&gt; adaptFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         fields.forEach(field -&gt; adaptFields.add(DtStringUtil.addQuoteForStr(field)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         String fieldsStr = StringUtils.join(adaptFields, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         String placeholder = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133         for (String fieldName : fields) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134             placeholder += &quot;,?&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         placeholder = placeholder.replaceFirst(&quot;,&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         sqlTmp = sqlTmp.replace(&quot;${fields}&quot;, fieldsStr).replace(&quot;${placeholder}&quot;, placeholder);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         this.sql = sqlTmp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142      *   use MERGE INTO build oracle replace into sql</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143      * @param tableName</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144      * @param fieldNames   create table contained  column columns</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145      * @param realIndexes  &lt;key: indexName, value: index contains columns &gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146      * @param fullField    real columns , query from db</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 150     public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String&gt;&gt; realIndexes, List&lt;String&gt; fullField) {"> 150     public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, Li🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         tableName = DtStringUtil.getTableFullPath(scheam, tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         sb.append(&quot;MERGE INTO &quot; + tableName + &quot; T1 USING &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 + &quot;(&quot; + makeValues(fieldNames) + &quot;) T2 ON (&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157                 + updateKeySql(realIndexes) + &quot;) &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160         String updateSql = getUpdateSql(fieldNames, fullField, &quot;T1&quot;, &quot;T2&quot;, keyColList(realIndexes));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         if (StringUtils.isNotEmpty(updateSql)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             sb.append(&quot; WHEN MATCHED THEN UPDATE SET &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             sb.append(updateSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         sb.append(&quot; WHEN NOT MATCHED THEN &quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168                 + &quot;INSERT (&quot; + quoteColumns(fieldNames) + &quot;) VALUES (&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                 + quoteColumns(fieldNames, &quot;T2&quot;) + &quot;)&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     public String quoteColumns(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         return quoteColumns(column, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179     public String quoteColumns(List&lt;String&gt; column, String table) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         String prefix = StringUtils.isBlank(table) ? &quot;&quot; : DtStringUtil.addQuoteForStr(table) + &quot;.&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         for (String col : column) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             list.add(prefix + DtStringUtil.addQuoteForStr(col));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189      *  extract all distinct index column</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190      * @param realIndexes</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193     protected List&lt;String&gt; keyColList(Map&lt;String, List&lt;String&gt;&gt; realIndexes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         List&lt;String&gt; keyCols = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : realIndexes.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             List&lt;String&gt; list = entry.getValue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197             for (String col : list) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                 if (!containsIgnoreCase(keyCols,col)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                     keyCols.add(col);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         return keyCols;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207      *  build update sql , such as UPDATE SET &quot;T1&quot;.A=&quot;T2&quot;.A</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208      * @param updateColumn       create table contained  column columns</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209      * @param fullColumn   real columns , query from db</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210      * @param leftTable    alias</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211      * @param rightTable   alias</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212      * @param indexCols   index column</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 215     public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightTable, List&lt;String&gt; indexCols) {"> 215     public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, Stri🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 216         String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) + &quot;.&quot;;"> 216         String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 217         String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTable) + &quot;.&quot;;"> 217         String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         for (String col : fullColumn) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220             // filter index column</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             if (indexCols == null || indexCols.size() == 0 || containsIgnoreCase(indexCols,col)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             if (containsIgnoreCase(updateColumn,col)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 225                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuoteForStr(col));"> 225                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235      *  build connect sql by index column, such as    T1.&quot;A&quot;=T2.&quot;A&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236      * @param updateKey</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239     public String updateKeySql(Map&lt;String, List&lt;String&gt;&gt; updateKey) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240         List&lt;String&gt; exprList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241         for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : updateKey.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242             List&lt;String&gt; colList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243             for (String col : entry.getValue()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 244                 colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForStr(col));"> 244                 colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246             exprList.add(StringUtils.join(colList, &quot; AND &quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         return StringUtils.join(exprList, &quot; OR &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252      *   build select sql , such as (SELECT ? &quot;A&quot;,? &quot;B&quot; FROM DUAL)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254      * @param column   destination column</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257     public String makeValues(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         for (int i = 0; i &lt; column.size(); ++i) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260             if (i != 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                 sb.append(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263             sb.append(&quot;? &quot; + DtStringUtil.addQuoteForStr(column.get(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         sb.append(&quot; FROM DUAL&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269     public boolean containsIgnoreCase(List&lt;String&gt; l, String s) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         Iterator&lt;String&gt; it = l.iterator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         while (it.hasNext()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272             if (it.next().equalsIgnoreCase(s))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273                 return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 }</span>
 281 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     public void buildSql(String scheam, String tableName, List&lt;String&gt; fields) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         buildInsertSql(scheam, tableName, fields);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     private void buildInsertSql(String scheam, String tableName, List&lt;String&gt; fields) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         tableName = DtStringUtil.getTableFullPath(scheam,tableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         String sqlTmp = &quot;insert into &quot; + tableName + &quot; (${fields}) values (${placeholder})&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         List&lt;String&gt; adaptFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         fields.forEach(field -&gt; adaptFields.add(DtStringUtil.addQuoteForStr(field)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297         String fieldsStr = StringUtils.join(adaptFields, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         String placeholder = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         for (String fieldName : fields) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             placeholder += &quot;,?&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303         placeholder = placeholder.replaceFirst(&quot;,&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304         sqlTmp = sqlTmp.replace(&quot;${fields}&quot;, fieldsStr).replace(&quot;${placeholder}&quot;, placeholder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         this.sql = sqlTmp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309      *   use MERGE INTO build oracle replace into sql</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310      * @param tableName</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311      * @param fieldNames   create table contained  column columns</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312      * @param realIndexes  &lt;key: indexName, value: index contains columns &gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313      * @param fullField    real columns , query from db</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 317     public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String&gt;&gt; realIndexes, List&lt;String&gt; fullField) {"> 317     public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, Li🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         tableName = DtStringUtil.getTableFullPath(scheam, tableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         sb.append(&quot;MERGE INTO &quot; + tableName + &quot; T1 USING &quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 + &quot;(&quot; + makeValues(fieldNames) + &quot;) T2 ON (&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                 + updateKeySql(realIndexes) + &quot;) &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327         String updateSql = getUpdateSql(fieldNames, fullField, &quot;T1&quot;, &quot;T2&quot;, keyColList(realIndexes));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         if (StringUtils.isNotEmpty(updateSql)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330             sb.append(&quot; WHEN MATCHED THEN UPDATE SET &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             sb.append(updateSql);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334         sb.append(&quot; WHEN NOT MATCHED THEN &quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335                 + &quot;INSERT (&quot; + quoteColumns(fieldNames) + &quot;) VALUES (&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336                 + quoteColumns(fieldNames, &quot;T2&quot;) + &quot;)&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342     public String quoteColumns(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343         return quoteColumns(column, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346     public String quoteColumns(List&lt;String&gt; column, String table) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347         String prefix = StringUtils.isBlank(table) ? &quot;&quot; : DtStringUtil.addQuoteForStr(table) + &quot;.&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348         List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349         for (String col : column) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350             list.add(prefix + DtStringUtil.addQuoteForStr(col));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352         return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356      *  extract all distinct index column</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357      * @param realIndexes</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360     protected List&lt;String&gt; keyColList(Map&lt;String, List&lt;String&gt;&gt; realIndexes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361         List&lt;String&gt; keyCols = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362         for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : realIndexes.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363             List&lt;String&gt; list = entry.getValue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364             for (String col : list) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365                 if (!containsIgnoreCase(keyCols,col)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366                     keyCols.add(col);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370         return keyCols;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374      *  build update sql , such as UPDATE SET &quot;T1&quot;.A=&quot;T2&quot;.A</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375      * @param updateColumn       create table contained  column columns</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376      * @param fullColumn   real columns , query from db</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377      * @param leftTable    alias</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378      * @param rightTable   alias</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379      * @param indexCols   index column</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 382     public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightTable, List&lt;String&gt; indexCols) {"> 382     public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, Stri🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 383         String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) + &quot;.&quot;;"> 383         String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 384         String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTable) + &quot;.&quot;;"> 384         String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385         List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         for (String col : fullColumn) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387             // filter index column</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388             if (indexCols == null || indexCols.size() == 0 || containsIgnoreCase(indexCols,col)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391             if (containsIgnoreCase(updateColumn,col)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 392                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuoteForStr(col));"> 392                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394                 list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397         return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402      *  build connect sql by index column, such as    T1.&quot;A&quot;=T2.&quot;A&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403      * @param updateKey</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406     public String updateKeySql(Map&lt;String, List&lt;String&gt;&gt; updateKey) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407         List&lt;String&gt; exprList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408         for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : updateKey.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409             List&lt;String&gt; colList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410             for (String col : entry.getValue()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 411                 colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForStr(col));"> 411                 colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413             exprList.add(StringUtils.join(colList, &quot; AND &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415         return StringUtils.join(exprList, &quot; OR &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419      *   build select sql , such as (SELECT ? &quot;A&quot;,? &quot;B&quot; FROM DUAL)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421      * @param column   destination column</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424     public String makeValues(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426         String collect = column.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427                 .map(col -&gt; wrapperPlaceholder(col) + DtStringUtil.addQuoteForStr(col))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428                 .collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430         sb.append(collect).append(&quot; FROM DUAL&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435      *  char type is wrapped with rpad</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436      * @param fieldName</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437      * @return</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439     public String wrapperPlaceholder(String fieldName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440         int pos = rdbTableInfo.getFieldList().indexOf(fieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441         String type = rdbTableInfo.getFieldTypeList().get(pos);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443         if (StringUtils.contains(type.toLowerCase(), DEAL_CHAR_KEY)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444             TableInfo.FieldExtraInfo fieldExtraInfo = rdbTableInfo.getFieldExtraInfoList().get(pos);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445             int charLength = fieldExtraInfo == null ? 0 : fieldExtraInfo.getLength();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446             if (charLength &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447                 return String.format(RPAD_FORMAT, charLength);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450         return SQL_DEFAULT_PLACEHOLDER;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455     public boolean containsIgnoreCase(List&lt;String&gt; l, String s) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456         Iterator&lt;String&gt; it = l.iterator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457         while (it.hasNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458             if (it.next().equalsIgnoreCase(s))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459                 return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461         return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 </span>
 466 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 467 }</pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.oracle;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.rdb.JDBCOptions;
  22 import com.dtstack.flink.sql.sink.rdb.RdbSink;
  23 import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;
  24 import com.dtstack.flink.sql.table.TableInfo;
  25 import java.util.Arrays;
  26 import java.util.stream.Collectors;
  27 
  28 /**
  29  * Reason:
  30  * Date: 2018/11/27
  31  * Company: www.dtstack.com
  32  *
  33  * @author maqi
  34  */
  35 public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {
  36 
  37     public OracleSink() {
  38         super(new OracleDialect());
  39     }
  40 
  41     private final String SQL_DEFAULT_PLACEHOLDER = &quot; ? &quot;;
  42     private final String DEAL_CHAR_KEY = &quot;char&quot;;
  43     private String RPAD_FORMAT = &quot; rpad(?, %d, &#x27; &#x27;) &quot;;
  44 
  45     @Override
  46     public JDBCUpsertOutputFormat getOutputFormat() {
  47         JDBCOptions jdbcOptions = JDBCOptions.builder()
  48                 .setDBUrl(dbURL)
  49                 .setDialect(jdbcDialect)
  50                 .setUsername(userName)
  51                 .setPassword(password)
  52                 .setTableName(tableName)
  53                 .setSchema(schema)
  54                 .build();
  55 
  56         return JDBCUpsertOutputFormat.builder()
  57                 .setOptions(jdbcOptions)
  58                 .setFieldNames(fieldNames)
  59                 .setFlushMaxSize(batchNum)
  60                 .setFlushIntervalMills(batchWaitInterval)
  61                 .setFieldTypes(sqlTypes)
  62                 .setKeyFields(primaryKeys)
  63                 .setAllReplace(allReplace)
  64                 .setUpdateMode(updateMode)
  65                 .build();
  66     }
  67 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  68 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 public String makeValues(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70         StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         for (int i = 0; i &lt; column.size(); ++i) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72             if (i != 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73                 sb.append(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75             sb.append(&quot;? &quot; + DtStringUtil.addQuoteForStr(column.get(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         sb.append(&quot; FROM DUAL&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79     }</span>
  80 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 public String makeValues(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         String collect = column.stream()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84                 .map(col -&gt; wrapperPlaceholder(col) + DtStringUtil.addQuoteForStr(col))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85                 .collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87         sb.append(collect).append(&quot; FROM DUAL&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     }</span>
  90 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  91 
  92 
  93     /**
  94      *  char type is wrapped with rpad
  95      * @param fieldName
  96      * @return
  97      */
  98     public String wrapperPlaceholder(String fieldName) {
  99         int pos = rdbTableInfo.getFieldList().indexOf(fieldName);
 100         String type = rdbTableInfo.getFieldTypeList().get(pos);
 101 
 102         if (StringUtils.contains(type.toLowerCase(), DEAL_CHAR_KEY)) {
 103             TableInfo.FieldExtraInfo fieldExtraInfo = rdbTableInfo.getFieldExtraInfoList().get(pos);
 104             int charLength = fieldExtraInfo == null ? 0 : fieldExtraInfo.getLength();
 105             if (charLength &gt; 0) {
 106                 return String.format(RPAD_FORMAT, charLength);
 107             }
 108         }
 109         return SQL_DEFAULT_PLACEHOLDER;
 110     }
 111 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  * &lt;p&gt;
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  * &lt;p&gt;
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.oracle;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.rdb.JDBCOptions;
  22 import com.dtstack.flink.sql.sink.rdb.RdbSink;
  23 import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;
  24 import com.dtstack.flink.sql.table.TableInfo;
  25 import java.util.Arrays;
  26 import java.util.stream.Collectors;
  27 
  28 
  29 /**
  30  * Reason:
  31  * Date: 2018/11/27
  32  * Company: www.dtstack.com
  33  *
  34  * @author maqi
  35  */
  36 public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {
  37     public OracleSink() {
  38         super(new OracleDialect());
  39     }
  40 
  41     @Override
  42     public JDBCUpsertOutputFormat getOutputFormat() {
<abbr title="  43         JDBCOptions jdbcOptions = JDBCOptions.builder().setDBUrl(dbURL).setDialect(jdbcDialect).setUsername(userName).setPassword(password).setTableName(tableName).setSchema(schema).build();">  43         JDBCOptions jdbcOptions = JDBCOptions.builder().setDBUrl(dbURL).setDialect(jdbcDialect).setUserna🔵</abbr>
<abbr title="  44         return JDBCUpsertOutputFormat.builder().setOptions(jdbcOptions).setFieldNames(fieldNames).setFlushMaxSize(batchNum).setFlushIntervalMills(batchWaitInterval).setFieldTypes(sqlTypes).setKeyFields(primaryKeys).setAllReplace(allReplace).setUpdateMode(updateMode).build();">  44         return JDBCUpsertOutputFormat.builder().setOptions(jdbcOptions).setFieldNames(fieldNames).setFlus🔵</abbr>
  45     }
  46 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   * &lt;p&gt;
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   * &lt;p&gt;
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  package com.dtstack.flink.sql.sink.oracle;
  19  
  20  import com.dtstack.flink.sql.sink.IStreamSinkGener;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.dtstack.flink.sql.sink.rdb.JDBCOptions;</span>
  22  import com.dtstack.flink.sql.sink.rdb.RdbSink;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.sink.rdb.format.ExtendOutputFormat;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.sink.rdb.format.RetractJDBCOutputFormat;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import java.util.ArrayList;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import java.util.Iterator;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import java.util.Map;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.dtstack.flink.sql.sink.rdb.format.JDBCUpsertOutputFormat;</span>
  34  
  35  /**
  36   * Reason:
  37   * Date: 2018/11/27
  38   * Company: www.dtstack.com
  39   *
  40   * @author maqi
  41   */
  42  public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -    private static final String ORACLE_DRIVER = &quot;oracle.jdbc.driver.OracleDriver&quot;;</span>
  44  




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -    public String getDriverName() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -        return ORACLE_DRIVER;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +    public OracleSink() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +        super(new OracleDialect());</span>
  50      }
  51  
  52      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -    public RetractJDBCOutputFormat getOutputFormat() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -        return new ExtendOutputFormat();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    public JDBCUpsertOutputFormat getOutputFormat() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +        JDBCOptions jdbcOptions = JDBCOptions.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +                .setDBUrl(dbURL)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +                .setDialect(jdbcDialect)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +                .setUsername(userName)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +                .setPassword(password)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +                .setTableName(tableName)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +                .setSchema(schema)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +                .build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +        return JDBCUpsertOutputFormat.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                .setOptions(jdbcOptions)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +                .setFieldNames(fieldNames)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +                .setFlushMaxSize(batchNum)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +                .setFlushIntervalMills(batchWaitInterval)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +                .setFieldTypes(sqlTypes)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +                .setKeyFields(primaryKeys)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +                .setAllReplace(allReplace)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +                .setUpdateMode(updateMode)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +                .build();</span>
  75      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    public void buildSql(String scheam, String tableName, List&lt;String&gt; fields) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        buildInsertSql(scheam, tableName, fields);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -    private void buildInsertSql(String scheam, String tableName, List&lt;String&gt; fields) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -        tableName = DtStringUtil.getTableFullPath(scheam,tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        String sqlTmp = &quot;insert into &quot; + tableName + &quot; (${fields}) values (${placeholder})&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        List&lt;String&gt; adaptFields = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        fields.forEach(field -&gt; adaptFields.add(DtStringUtil.addQuoteForStr(field)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        String fieldsStr = StringUtils.join(adaptFields, &quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        String placeholder = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        for (String fieldName : fields) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            placeholder += &quot;,?&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        placeholder = placeholder.replaceFirst(&quot;,&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        sqlTmp = sqlTmp.replace(&quot;${fields}&quot;, fieldsStr).replace(&quot;${placeholder}&quot;, placeholder);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        this.sql = sqlTmp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -     *   use MERGE INTO build oracle replace into sql</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -     * @param tableName</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -     * @param fieldNames   create table contained  column columns</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -     * @param realIndexes  &lt;key: indexName, value: index contains columns &gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -     * @param fullField    real columns , query from db</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 111 -    public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String&gt;&gt; realIndexes, List&lt;String&gt; fullField) {"> 111 -    public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        tableName = DtStringUtil.getTableFullPath(scheam, tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        sb.append(&quot;MERGE INTO &quot; + tableName + &quot; T1 USING &quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -                + &quot;(&quot; + makeValues(fieldNames) + &quot;) T2 ON (&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                + updateKeySql(realIndexes) + &quot;) &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        String updateSql = getUpdateSql(fieldNames, fullField, &quot;T1&quot;, &quot;T2&quot;, keyColList(realIndexes));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        if (StringUtils.isNotEmpty(updateSql)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            sb.append(&quot; WHEN MATCHED THEN UPDATE SET &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            sb.append(updateSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        sb.append(&quot; WHEN NOT MATCHED THEN &quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                + &quot;INSERT (&quot; + quoteColumns(fieldNames) + &quot;) VALUES (&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -                + quoteColumns(fieldNames, &quot;T2&quot;) + &quot;)&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    public String quoteColumns(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        return quoteColumns(column, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -    public String quoteColumns(List&lt;String&gt; column, String table) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        String prefix = StringUtils.isBlank(table) ? &quot;&quot; : DtStringUtil.addQuoteForStr(table) + &quot;.&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        for (String col : column) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -            list.add(prefix + DtStringUtil.addQuoteForStr(col));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -     *  extract all distinct index column</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -     * @param realIndexes</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -    protected List&lt;String&gt; keyColList(Map&lt;String, List&lt;String&gt;&gt; realIndexes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        List&lt;String&gt; keyCols = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : realIndexes.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -            List&lt;String&gt; list = entry.getValue();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            for (String col : list) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                if (!containsIgnoreCase(keyCols,col)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                    keyCols.add(col);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        return keyCols;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -     *  build update sql , such as UPDATE SET &quot;T1&quot;.A=&quot;T2&quot;.A</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -     * @param updateColumn       create table contained  column columns</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -     * @param fullColumn   real columns , query from db</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -     * @param leftTable    alias</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -     * @param rightTable   alias</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -     * @param indexCols   index column</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 176 -    public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightTable, List&lt;String&gt; indexCols) {"> 176 -    public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightT🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) + &quot;.&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -        String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTable) + &quot;.&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -        for (String col : fullColumn) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -            // filter index column</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -            if (indexCols == null || indexCols.size() == 0 || containsIgnoreCase(indexCols,col)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -            if (containsIgnoreCase(updateColumn,col)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 186 -                list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuoteForStr(col));"> 186 -                list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuote🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -        return StringUtils.join(list, &quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -     *  build connect sql by index column, such as    T1.&quot;A&quot;=T2.&quot;A&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -     * @param updateKey</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -    public String updateKeySql(Map&lt;String, List&lt;String&gt;&gt; updateKey) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -        List&lt;String&gt; exprList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : updateKey.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -            List&lt;String&gt; colList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -            for (String col : entry.getValue()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForStr(col));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            exprList.add(StringUtils.join(colList, &quot; AND &quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        return StringUtils.join(exprList, &quot; OR &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -     *   build select sql , such as (SELECT ? &quot;A&quot;,? &quot;B&quot; FROM DUAL)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -     * @param column   destination column</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -    public String makeValues(List&lt;String&gt; column) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -        StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -        for (int i = 0; i &lt; column.size(); ++i) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -            if (i != 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -                sb.append(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -            sb.append(&quot;? &quot; + DtStringUtil.addQuoteForStr(column.get(i)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -        sb.append(&quot; FROM DUAL&quot;);</span>





<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -    }</span>





















<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -    public boolean containsIgnoreCase(List&lt;String&gt; l, String s) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -        Iterator&lt;String&gt; it = l.iterator();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        while (it.hasNext()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -            if (it.next().equalsIgnoreCase(s))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -                return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -</span>
 241  }</pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   * &lt;p&gt;
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   * &lt;p&gt;
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  package com.dtstack.flink.sql.sink.oracle;
  19  
  20  import com.dtstack.flink.sql.sink.IStreamSinkGener;

  21  import com.dtstack.flink.sql.sink.rdb.RdbSink;
  22  import com.dtstack.flink.sql.sink.rdb.format.ExtendOutputFormat;
  23  import com.dtstack.flink.sql.sink.rdb.format.RetractJDBCOutputFormat;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.dtstack.flink.sql.table.TableInfo;</span>
  25  import com.dtstack.flink.sql.util.DtStringUtil;
  26  import org.apache.commons.lang3.StringUtils;
  27  import com.google.common.collect.Lists;
  28  
  29  import java.util.ArrayList;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import java.util.Arrays;</span>
  31  import java.util.Iterator;
  32  import java.util.List;
  33  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import java.util.stream.Collectors;</span>
  35  
  36  /**
  37   * Reason:
  38   * Date: 2018/11/27
  39   * Company: www.dtstack.com
  40   *
  41   * @author maqi
  42   */
  43  public class OracleSink extends RdbSink implements IStreamSinkGener&lt;RdbSink&gt; {
  44      private static final String ORACLE_DRIVER = &quot;oracle.jdbc.driver.OracleDriver&quot;;
  45  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +    private final String SQL_DEFAULT_PLACEHOLDER = &quot; ? &quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +    private final String DEAL_CHAR_KEY = &quot;char&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +    private String RPAD_FORMAT = &quot; rpad(?, %d, &#x27; &#x27;) &quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +</span>
  50      @Override
  51      public String getDriverName() {
  52          return ORACLE_DRIVER;


  53      }
  54  
  55      @Override
  56      public RetractJDBCOutputFormat getOutputFormat() {
  57          return new ExtendOutputFormat();




















  58      }
  59  
  60      @Override
  61      public void buildSql(String scheam, String tableName, List&lt;String&gt; fields) {
  62          buildInsertSql(scheam, tableName, fields);
  63      }
  64  
  65      private void buildInsertSql(String scheam, String tableName, List&lt;String&gt; fields) {
  66  
  67          tableName = DtStringUtil.getTableFullPath(scheam,tableName);
  68  
  69          String sqlTmp = &quot;insert into &quot; + tableName + &quot; (${fields}) values (${placeholder})&quot;;
  70  
  71          List&lt;String&gt; adaptFields = Lists.newArrayList();
  72          fields.forEach(field -&gt; adaptFields.add(DtStringUtil.addQuoteForStr(field)));
  73  
  74          String fieldsStr = StringUtils.join(adaptFields, &quot;,&quot;);
  75          String placeholder = &quot;&quot;;
  76  
  77          for (String fieldName : fields) {
  78              placeholder += &quot;,?&quot;;
  79          }
  80          placeholder = placeholder.replaceFirst(&quot;,&quot;, &quot;&quot;);
  81          sqlTmp = sqlTmp.replace(&quot;${fields}&quot;, fieldsStr).replace(&quot;${placeholder}&quot;, placeholder);
  82          this.sql = sqlTmp;
  83      }
  84  
  85      /**
  86       *   use MERGE INTO build oracle replace into sql
  87       * @param tableName
  88       * @param fieldNames   create table contained  column columns
  89       * @param realIndexes  &lt;key: indexName, value: index contains columns &gt;
  90       * @param fullField    real columns , query from db
  91       * @return
  92       */
  93      @Override
<abbr title="  94      public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String&gt;&gt; realIndexes, List&lt;String&gt; fullField) {">  94      public String buildUpdateSql(String scheam, String tableName, List&lt;String&gt; fieldNames, Map&lt;String, List&lt;String🔵</abbr>
  95          tableName = DtStringUtil.getTableFullPath(scheam, tableName);
  96  
  97          StringBuilder sb = new StringBuilder();
  98  
  99          sb.append(&quot;MERGE INTO &quot; + tableName + &quot; T1 USING &quot;
 100                  + &quot;(&quot; + makeValues(fieldNames) + &quot;) T2 ON (&quot;
 101                  + updateKeySql(realIndexes) + &quot;) &quot;);
 102  
 103  
 104          String updateSql = getUpdateSql(fieldNames, fullField, &quot;T1&quot;, &quot;T2&quot;, keyColList(realIndexes));
 105  
 106          if (StringUtils.isNotEmpty(updateSql)) {
 107              sb.append(&quot; WHEN MATCHED THEN UPDATE SET &quot;);
 108              sb.append(updateSql);
 109          }
 110  
 111          sb.append(&quot; WHEN NOT MATCHED THEN &quot;
 112                  + &quot;INSERT (&quot; + quoteColumns(fieldNames) + &quot;) VALUES (&quot;
 113                  + quoteColumns(fieldNames, &quot;T2&quot;) + &quot;)&quot;);
 114  
 115          return sb.toString();
 116      }
 117  
 118  
 119      public String quoteColumns(List&lt;String&gt; column) {
 120          return quoteColumns(column, null);
 121      }
 122  
 123      public String quoteColumns(List&lt;String&gt; column, String table) {
 124          String prefix = StringUtils.isBlank(table) ? &quot;&quot; : DtStringUtil.addQuoteForStr(table) + &quot;.&quot;;
 125          List&lt;String&gt; list = new ArrayList&lt;&gt;();
 126          for (String col : column) {
 127              list.add(prefix + DtStringUtil.addQuoteForStr(col));
 128          }
 129          return StringUtils.join(list, &quot;,&quot;);
 130      }
 131  
 132      /**
 133       *  extract all distinct index column
 134       * @param realIndexes
 135       * @return
 136       */
 137      protected List&lt;String&gt; keyColList(Map&lt;String, List&lt;String&gt;&gt; realIndexes) {
 138          List&lt;String&gt; keyCols = new ArrayList&lt;&gt;();
 139          for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : realIndexes.entrySet()) {
 140              List&lt;String&gt; list = entry.getValue();
 141              for (String col : list) {
 142                  if (!containsIgnoreCase(keyCols,col)) {
 143                      keyCols.add(col);
 144                  }
 145              }
 146          }
 147          return keyCols;
 148      }
 149  
 150      /**
 151       *  build update sql , such as UPDATE SET &quot;T1&quot;.A=&quot;T2&quot;.A
 152       * @param updateColumn       create table contained  column columns
 153       * @param fullColumn   real columns , query from db
 154       * @param leftTable    alias
 155       * @param rightTable   alias
 156       * @param indexCols   index column
 157       * @return
 158       */
<abbr title=" 159      public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightTable, List&lt;String&gt; indexCols) {"> 159      public String getUpdateSql(List&lt;String&gt; updateColumn, List&lt;String&gt; fullColumn, String leftTable, String rightT🔵</abbr>
 160          String prefixLeft = StringUtils.isBlank(leftTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(leftTable) + &quot;.&quot;;
 161          String prefixRight = StringUtils.isBlank(rightTable) ? &quot;&quot; : DtStringUtil.addQuoteForStr(rightTable) + &quot;.&quot;;
 162          List&lt;String&gt; list = new ArrayList&lt;&gt;();
 163          for (String col : fullColumn) {
 164              // filter index column
 165              if (indexCols == null || indexCols.size() == 0 || containsIgnoreCase(indexCols,col)) {
 166                  continue;
 167              }
 168              if (containsIgnoreCase(updateColumn,col)) {
<abbr title=" 169                  list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuoteForStr(col));"> 169                  list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=&quot; + prefixRight + DtStringUtil.addQuote🔵</abbr>
 170              } else {
 171                  list.add(prefixLeft + DtStringUtil.addQuoteForStr(col) + &quot;=null&quot;);
 172              }
 173          }
 174          return StringUtils.join(list, &quot;,&quot;);
 175      }
 176  
 177  
 178      /**
 179       *  build connect sql by index column, such as    T1.&quot;A&quot;=T2.&quot;A&quot;
 180       * @param updateKey
 181       * @return
 182       */
 183      public String updateKeySql(Map&lt;String, List&lt;String&gt;&gt; updateKey) {
 184          List&lt;String&gt; exprList = new ArrayList&lt;&gt;();
 185          for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : updateKey.entrySet()) {
 186              List&lt;String&gt; colList = new ArrayList&lt;&gt;();
 187              for (String col : entry.getValue()) {
 188                  colList.add(&quot;T1.&quot; + DtStringUtil.addQuoteForStr(col) + &quot;=T2.&quot; + DtStringUtil.addQuoteForStr(col));
 189              }
 190              exprList.add(StringUtils.join(colList, &quot; AND &quot;));
 191          }
 192          return StringUtils.join(exprList, &quot; OR &quot;);
 193      }
 194  
 195      /**
 196       *   build select sql , such as (SELECT ? &quot;A&quot;,? &quot;B&quot; FROM DUAL)
 197       *
 198       * @param column   destination column
 199       * @return
 200       */
 201      public String makeValues(List&lt;String&gt; column) {
 202          StringBuilder sb = new StringBuilder(&quot;SELECT &quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        for (int i = 0; i &lt; column.size(); ++i) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -            if (i != 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                sb.append(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            sb.append(&quot;? &quot; + DtStringUtil.addQuoteForStr(column.get(i)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -        sb.append(&quot; FROM DUAL&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +        String collect = column.stream()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                .map(col -&gt; wrapperPlaceholder(col) + DtStringUtil.addQuoteForStr(col))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                .collect(Collectors.joining(&quot;, &quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +        sb.append(collect).append(&quot; FROM DUAL&quot;);</span>
 215          return sb.toString();
 216      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +     *  char type is wrapped with rpad</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +     * @param fieldName</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +     * @return</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +    public String wrapperPlaceholder(String fieldName) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +        int pos = rdbTableInfo.getFieldList().indexOf(fieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        String type = rdbTableInfo.getFieldTypeList().get(pos);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        if (StringUtils.contains(type.toLowerCase(), DEAL_CHAR_KEY)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +            TableInfo.FieldExtraInfo fieldExtraInfo = rdbTableInfo.getFieldExtraInfoList().get(pos);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +            int charLength = fieldExtraInfo == null ? 0 : fieldExtraInfo.getLength();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            if (charLength &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                return String.format(RPAD_FORMAT, charLength);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        return SQL_DEFAULT_PLACEHOLDER;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +</span>
 238  
 239      public boolean containsIgnoreCase(List&lt;String&gt; l, String s) {
 240          Iterator&lt;String&gt; it = l.iterator();
 241          while (it.hasNext()) {
 242              if (it.next().equalsIgnoreCase(s))
 243                  return true;
 244          }
 245          return false;
 246      }
 247  
 248  
 249  
 250  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            