<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>108</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    108
                    <a href="107.html">prev</a>
                    <a href="109.html">next</a>
                    <a href="108_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_4c906659b12b21ea55fd99e9e59d22de6a0133ad_common/src/main/java/org/broadleafcommerce/common/cache/engine/HydratedCacheManagerImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;4c906659b12b21ea55fd99e9e59d22de6a0133ad:common/src/main/java/org/broadleafcommerce/common/cache/engine/HydratedCacheManagerImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;4c906659b12b21ea55fd99e9e59d22de6a0133ad^1:common/src/main/java/org/broadleafcommerce/common/cache/engine/HydratedCacheManagerImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;4c906659b12b21ea55fd99e9e59d22de6a0133ad^2:common/src/main/java/org/broadleafcommerce/common/cache/engine/HydratedCacheManagerImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;45c0b30829d70c32661f9bc4b75c7dcb1a7b56a5:common/src/main/java/org/broadleafcommerce/common/cache/engine/HydratedCacheManagerImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import java.util.Hashtable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36  * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37  * @author jfischer</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  41 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {">  41 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44     private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46     public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47         return MANAGER;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  52     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);">  52     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  53     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);">  53     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56         hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65             HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66             addHydratedCache(cache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         scanner.init();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85         Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86         if (mutators.size() != 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  87             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);">  87             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entitieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89         Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93             cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         return descriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104             myClass = superClass;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105             superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         return myClass;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 111     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 111     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         Object response = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (element != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 122     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKeyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         if (element == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             element = new HydratedCacheElement();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     public void dispose() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         String cacheName = cacheRegion;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 143             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 144             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             cacheName = keyPieces[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             key = keyPieces[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150             HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 154                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164                 LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         //do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191     public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196     public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         removeAll(arg0.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201     public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 }</span>
 206 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211  * Copyright (C) 2009 - 2023 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  * </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 220  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 220  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 221  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 221  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 import java.util.Hashtable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240  * </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241  * @author jfischer</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 245 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {"> 245 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         return MANAGER;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254     private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 256     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);"> 256     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 257     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);"> 257     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259     public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269             HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270             addHydratedCache(cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275     public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280     public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286         HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         scanner.init();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         if (mutators.size() != 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 291             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);"> 291             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entitieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297             cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299         descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301         return descriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307         while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             myClass = superClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311         return myClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 315     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         Object response = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         if (element != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320             response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         return response;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 326     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 326     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKeyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         if (element == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330             element = new HydratedCacheElement();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337     public void dispose() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339             LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341         hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345         String cacheName = cacheRegion;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346         if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 347             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 347             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 348             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 348             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349             String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350             cacheName = keyPieces[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351             key = keyPieces[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353         if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354             HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355             String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356             if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 358                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 358                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360                 cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365     private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366         if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368                 LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370             hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385     public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390     public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395     public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400     public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401         removeAll(arg0.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405     public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 }</span>
 410 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import java.util.Hashtable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37  * @author jfischer</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  41 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {">  41 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44     private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46     public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47         return MANAGER;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  52     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);">  52     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  53     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);">  53     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56         hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65             HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66             addHydratedCache(cache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         scanner.init();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84         descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85         Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86         if (mutators.size() != 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  87             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);">  87             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entitieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89         Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93             cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         return descriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104             myClass = superClass;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105             superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         return myClass;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 111     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 111     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         Object response = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (element != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 122     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKeyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         if (element == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             element = new HydratedCacheElement();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     public void dispose() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         String cacheName = cacheRegion;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 143             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 144             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 144             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145             String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146             cacheName = keyPieces[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             key = keyPieces[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150             HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 154                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164                 LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166             hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         //do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186     public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191     public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196     public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197         removeAll(arg0.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201     public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 }</span>
 206 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211  * Copyright (C) 2009 - 2023 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 220  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 220  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 221  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 221  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 import java.util.Hashtable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241  * @author jfischer</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 245 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {"> 245 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         return MANAGER;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254     private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 256     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);"> 256     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 257     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);"> 257     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259     public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269             HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270             addHydratedCache(cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275     public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280     public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286         HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         scanner.init();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         if (mutators.size() != 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 291             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);"> 291             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entitieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297             cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299         descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301         return descriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307         while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             myClass = superClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311         return myClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 315     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         Object response = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         if (element != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320             response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         return response;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 326     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 326     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKeyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         if (element == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330             element = new HydratedCacheElement();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337     public void dispose() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339             LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341         hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345         String cacheName = cacheRegion;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346         if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 347             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 347             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 348             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 348             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349             String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350             cacheName = keyPieces[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351             key = keyPieces[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353         if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354             HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355             String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356             if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 358                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 358                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360                 cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365     private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366         if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368                 LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370             hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385     public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390     public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395     public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400     public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401         removeAll(arg0.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405     public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 }</span>
 410 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * Copyright (C) 2009 - 2023 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import java.lang.reflect.Method;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import java.util.Hashtable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40  * @author jfischer</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  44 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {">  44 public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46     private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47     private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49     public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50         return MANAGER;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53     private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  55     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);">  55     private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  56     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);">  56     private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58     public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59         hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63         return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67         if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68             HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69             addHydratedCache(cache);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71         return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74     public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75         return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79     public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81             return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84         Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86         scanner.init();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87         descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88         Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89         if (mutators.size() != 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  90             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);">  90             throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entitieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92         Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93         descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95         if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96             cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98         descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99         hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         return descriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103     public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104         Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105         Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106         while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107             myClass = superClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108             superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         return myClass;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 114     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 114     public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115         Object response = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         if (element != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119             response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121         return response;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 125     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 125     public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKeyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         if (element == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129             element = new HydratedCacheElement();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130             hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132         element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136     public void dispose() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138             LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143     private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         String cacheName = cacheRegion;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 146             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 146             // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 147             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 147             // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s cðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148             String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             cacheName = keyPieces[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150             key = keyPieces[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152         if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153             HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154             String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155             if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 157                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 157                     LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName +ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159                 cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165         if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167                 LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169             hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179     public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185         //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189     public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195         removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199     public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200         removeAll(arg0.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204     public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205         return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 }</span>
 209 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * #%L</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * shall apply.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * #L%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -package org.broadleafcommerce.common.cache.engine;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import java.io.Serializable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import java.lang.reflect.Method;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import java.util.Hashtable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import net.sf.ehcache.CacheException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import net.sf.ehcache.Ehcache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import net.sf.ehcache.Element;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import net.sf.ehcache.event.CacheEventListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 - * @author jfischer</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -@Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  39 -public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {">  39 -public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManagðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -    private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -    private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -    public static HydratedCacheManagerImpl getInstance() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -        return MANAGER;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -    private HydratedCacheManagerImpl()  {}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -    private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  51 -    private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);">  51 -    private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -    public void addHydratedCache(final HydratedCache cache) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -        hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -    public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -        return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -    public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -        if (!containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -            HydratedCache cache = new HydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -            addHydratedCache(cache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -        return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    public boolean containsCache(String cacheRegion, String cacheName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -        return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    public HydrationDescriptor getHydrationDescriptor(Object entity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        if (hydrationDescriptors.containsKey(entity.getClass().getName())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -            return hydrationDescriptors.get(entity.getClass().getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        HydrationDescriptor descriptor = new HydrationDescriptor();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        scanner.init();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        descriptor.setHydratedMutators(scanner.getCacheMutators());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -        if (mutators.size() != 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  85 -            throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);">  85 -            throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        Method[] singleMutators = mutators.values().iterator().next();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        descriptor.setIdMutators(singleMutators);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        String cacheRegion = scanner.getCacheRegion();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -            cacheRegion = topEntityClass.getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        descriptor.setCacheRegion(cacheRegion);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        hydrationDescriptors.put(entity.getClass().getName(), descriptor);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        return descriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    public Class&lt;?&gt; getTopEntityClass(Object entity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        Class&lt;?&gt; myClass = entity.getClass();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        Class&lt;?&gt; superClass = entity.getClass().getSuperclass();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            myClass = superClass;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -            superClass = superClass.getSuperclass();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        return myClass;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 109 -    public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 109 -    public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, StrinðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        Object response = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        if (element != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            response = element.getCacheElementItem(elementItemName, elementKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        return response;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 120 -    public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 120 -    public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        if (element == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            element = new HydratedCacheElement();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        element.putCacheElementItem(elementItemName, elementKey, elementValue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -    public void dispose() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            LOG.info(&quot;Disposing of all hydrated cache members&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        hydratedCacheContainer.clear();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    private void removeCache(String cacheRegion, Serializable key) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        String cacheName = cacheRegion;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 141 -            // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 141 -            // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 142 -            // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 142 -            // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -            String[] keyPieces = key.toString().split(&quot;#&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -            cacheName = keyPieces[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            key = keyPieces[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        if (containsCache(cacheRegion, cacheName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            if (cache.containsKey(myKey)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 152 -                    LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 152 -                    LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + keðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                cache.removeCacheElement(cacheRegion, cacheName, key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -    private void removeAll(String cacheName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        if (hydratedCacheContainer.containsKey(cacheName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            hydratedCacheContainer.remove(cacheName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    public void notifyElementEvicted(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -    public void notifyElementExpired(Ehcache arg0, Element arg1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -    public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -        //do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -    public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -        removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -    public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        removeCache(arg0.getName(), arg1.getKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -    public void notifyRemoveAll(Ehcache arg0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -        removeAll(arg0.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -    public Object clone() throws CloneNotSupportedException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -}</span></pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +/*-</span>
   3   * #%L
   4   * BroadleafCommerce Common Libraries
   5   * %%
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Copyright (C) 2009 - 2023 Broadleaf Commerce</span>
   8   * %%
   9   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  10   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  11   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  12   * the Broadleaf End User License Agreement (EULA), Version 1.1
  13   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  14   * shall apply.
  15   *
<abbr title="  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  17   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  18   * #L%
  19   */
  20  package org.broadleafcommerce.common.cache.engine;
  21  
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  
  25  import java.io.Serializable;
  26  import java.lang.reflect.Method;
  27  import java.util.Hashtable;
  28  import java.util.Map;
  29  
  30  import net.sf.ehcache.CacheException;
  31  import net.sf.ehcache.Ehcache;
  32  import net.sf.ehcache.Element;
  33  import net.sf.ehcache.event.CacheEventListener;
  34  
  35  /**
  36   *
  37   * @author jfischer
  38   *
  39   */
  40  @Deprecated
<abbr title="  41  public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManager {">  41  public class HydratedCacheManagerImpl implements CacheEventListener, HydratedCacheManager, HydratedAnnotationManagðŸ”µ</abbr>
  42  
  43      private static final Log LOG = LogFactory.getLog(HydratedCacheManagerImpl.class);
  44      private static final HydratedCacheManagerImpl MANAGER = new HydratedCacheManagerImpl();
  45  
  46      public static HydratedCacheManagerImpl getInstance() {
  47          return MANAGER;
  48      }
  49  
  50      private HydratedCacheManagerImpl()  {}
  51  
  52      private Map&lt;String, HydratedCache&gt; hydratedCacheContainer = new Hashtable&lt;String, HydratedCache&gt;(100);
<abbr title="  53      private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100);">  53      private Map&lt;String, HydrationDescriptor&gt; hydrationDescriptors = new Hashtable&lt;String, HydrationDescriptor&gt;(100ðŸ”µ</abbr>
  54  
  55      public void addHydratedCache(final HydratedCache cache) {
  56          hydratedCacheContainer.put(cache.getCacheRegion() + &quot;_&quot; + cache.getCacheName(), cache);
  57      }
  58  
  59      public HydratedCache removeHydratedCache(final String cacheRegion, final String cacheName) {
  60          return hydratedCacheContainer.remove(cacheRegion + &quot;_&quot; + cacheName);
  61      }
  62  
  63      public  HydratedCache getHydratedCache(final String cacheRegion, final String cacheName) {
  64          if (!containsCache(cacheRegion, cacheName)) {
  65              HydratedCache cache = new HydratedCache(cacheRegion, cacheName);
  66              addHydratedCache(cache);
  67          }
  68          return hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);
  69      }
  70  
  71      public boolean containsCache(String cacheRegion, String cacheName) {
  72          return hydratedCacheContainer.containsKey(cacheRegion + &quot;_&quot; + cacheName);
  73      }
  74  
  75      @Override
  76      public HydrationDescriptor getHydrationDescriptor(Object entity) {
  77          if (hydrationDescriptors.containsKey(entity.getClass().getName())) {
  78              return hydrationDescriptors.get(entity.getClass().getName());
  79          }
  80          HydrationDescriptor descriptor = new HydrationDescriptor();
  81          Class&lt;?&gt; topEntityClass = getTopEntityClass(entity);
  82          HydrationScanner scanner = new HydrationScanner(topEntityClass, entity.getClass());
  83          scanner.init();
  84          descriptor.setHydratedMutators(scanner.getCacheMutators());
  85          Map&lt;String, Method[]&gt; mutators = scanner.getIdMutators();
  86          if (mutators.size() != 1) {
<abbr title="  87              throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a single @Id annotation.&quot;);">  87              throw new RuntimeException(&quot;Broadleaf Commerce Hydrated Cache currently only supports entities with a ðŸ”µ</abbr>
  88          }
  89          Method[] singleMutators = mutators.values().iterator().next();
  90          descriptor.setIdMutators(singleMutators);
  91          String cacheRegion = scanner.getCacheRegion();
  92          if (cacheRegion == null || &quot;&quot;.equals(cacheRegion)) {
  93              cacheRegion = topEntityClass.getName();
  94          }
  95          descriptor.setCacheRegion(cacheRegion);
  96          hydrationDescriptors.put(entity.getClass().getName(), descriptor);
  97          return descriptor;
  98      }
  99  
 100      public Class&lt;?&gt; getTopEntityClass(Object entity) {
 101          Class&lt;?&gt; myClass = entity.getClass();
 102          Class&lt;?&gt; superClass = entity.getClass().getSuperclass();
 103          while (superClass != null &amp;&amp; superClass.getName().startsWith(&quot;org.broadleaf&quot;)) {
 104              myClass = superClass;
 105              superClass = superClass.getSuperclass();
 106          }
 107          return myClass;
 108      }
 109  
 110      @Override
<abbr title=" 111      public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName) {"> 111      public Object getHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, StrinðŸ”µ</abbr>
 112          Object response = null;
 113          HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);
 114          HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);
 115          if (element != null) {
 116              response = element.getCacheElementItem(elementItemName, elementKey);
 117          }
 118          return response;
 119      }
 120  
 121      @Override
<abbr title=" 122      public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String elementItemName, Object elementValue) {"> 122      public void addHydratedCacheElementItem(String cacheRegion, String cacheName, Serializable elementKey, String ðŸ”µ</abbr>
 123          HydratedCache hydratedCache = getHydratedCache(cacheRegion, cacheName);
 124          HydratedCacheElement element = hydratedCache.getCacheElement(cacheRegion, cacheName, elementKey);
 125          if (element == null) {
 126              element = new HydratedCacheElement();
 127              hydratedCache.addCacheElement(cacheRegion, cacheName, elementKey, element);
 128          }
 129          element.putCacheElementItem(elementItemName, elementKey, elementValue);
 130      }
 131  
 132      @Override
 133      public void dispose() {
 134          if (LOG.isInfoEnabled()) {
 135              LOG.info(&quot;Disposing of all hydrated cache members&quot;);
 136          }
 137          hydratedCacheContainer.clear();
 138      }
 139  
 140      private void removeCache(String cacheRegion, Serializable key) {
 141          String cacheName = cacheRegion;
 142          if (key.getClass().getName().equals(&quot;org.hibernate.cache.internal.CacheKeyImplementation&quot;)) {
<abbr title=" 143              // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoleName property"> 143              // Since CacheKeyImplementation is a protected Class we can&#x27;t cast it nor can we access the entityOrRoðŸ”µ</abbr>
<abbr title=" 144              // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised of the fields we need"> 144              // therefore, to match how this worked in pre Hibernate 5, we split the toString since it&#x27;s comprised ðŸ”µ</abbr>
 145              String[] keyPieces = key.toString().split(&quot;#&quot;);
 146              cacheName = keyPieces[0];
 147              key = keyPieces[1];
 148          }
 149          if (containsCache(cacheRegion, cacheName)) {
 150              HydratedCache cache = hydratedCacheContainer.get(cacheRegion + &quot;_&quot; + cacheName);
 151              String myKey = cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key;
 152              if (cache.containsKey(myKey)) {
 153                  if (LOG.isInfoEnabled()) {
<abbr title=" 154                      LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + key);"> 154                      LOG.info(&quot;Clearing hydrated cache for cache name: &quot; + cacheRegion + &quot;_&quot; + cacheName + &quot;_&quot; + keðŸ”µ</abbr>
 155                  }
 156                  cache.removeCacheElement(cacheRegion, cacheName, key);
 157              }
 158          }
 159      }
 160  
 161      private void removeAll(String cacheName) {
 162          if (hydratedCacheContainer.containsKey(cacheName)) {
 163              if (LOG.isInfoEnabled()) {
 164                  LOG.info(&quot;Clearing all hydrated caches for cache name: &quot; + cacheName);
 165              }
 166              hydratedCacheContainer.remove(cacheName);
 167          }
 168      }
 169  
 170      @Override
 171      public void notifyElementEvicted(Ehcache arg0, Element arg1) {
 172          removeCache(arg0.getName(), arg1.getKey());
 173      }
 174  
 175      @Override
 176      public void notifyElementExpired(Ehcache arg0, Element arg1) {
 177          removeCache(arg0.getName(), arg1.getKey());
 178      }
 179  
 180      @Override
 181      public void notifyElementPut(Ehcache arg0, Element arg1) throws CacheException {
 182          //do nothing
 183      }
 184  
 185      @Override
 186      public void notifyElementRemoved(Ehcache arg0, Element arg1) throws CacheException {
 187          removeCache(arg0.getName(), arg1.getKey());
 188      }
 189  
 190      @Override
 191      public void notifyElementUpdated(Ehcache arg0, Element arg1) throws CacheException {
 192          removeCache(arg0.getName(), arg1.getKey());
 193      }
 194  
 195      @Override
 196      public void notifyRemoveAll(Ehcache arg0) {
 197          removeAll(arg0.getName());
 198      }
 199  
 200      @Override
 201      public Object clone() throws CloneNotSupportedException {
 202          return this;
 203      }
 204  
 205  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            