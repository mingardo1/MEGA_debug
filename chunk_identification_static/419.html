<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>419</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    419
                    <a href="418.html">prev</a>
                    <a href="420.html">next</a>
                    <a href="419_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b43aec0679d705647015fd4416ad6dc326ea7890_core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b43aec0679d705647015fd4416ad6dc326ea7890:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b43aec0679d705647015fd4416ad6dc326ea7890^1:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b43aec0679d705647015fd4416ad6dc326ea7890^2:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6159bb9bb9904f950c489b50fb7dcbe399c3d327:core/src/main/java/com/dtstack/flink/sql/side/SideSqlExec.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [sbj], [b], [b], [b], [b], [j], [j], [j], [j], [j]], subset: [[bj], [sbj], [bj], [bj], [bj], [bj], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side;
  22 
  23 import org.apache.flink.api.common.typeinfo.TypeInformation;
  24 import org.apache.flink.api.java.tuple.Tuple2;
  25 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  26 import org.apache.flink.streaming.api.datastream.DataStream;
  27 import org.apache.flink.table.api.StreamQueryConfig;
  28 import org.apache.flink.table.api.Table;
  29 import org.apache.flink.table.api.TableSchema;
  30 import org.apache.flink.table.api.java.StreamTableEnvironment;
  31 import org.apache.flink.table.runtime.CRowKeySelector;
  32 import org.apache.flink.table.runtime.types.CRow;
  33 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  34 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  35 import org.apache.flink.types.Row;
  36 
  37 import com.dtstack.flink.sql.enums.ECacheType;
  38 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  39 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  40 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  41 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  42 import com.dtstack.flink.sql.util.ClassUtil;
  43 import com.dtstack.flink.sql.util.ParseUtils;
  44 import com.dtstack.flink.sql.util.TableUtils;
  45 import com.google.common.base.Preconditions;
  46 import com.google.common.collect.*;
  47 import org.apache.calcite.sql.SqlAsOperator;
  48 import org.apache.calcite.sql.SqlBasicCall;
  49 import org.apache.calcite.sql.SqlDataTypeSpec;
  50 import org.apache.calcite.sql.SqlIdentifier;
  51 import org.apache.calcite.sql.SqlInsert;
  52 import org.apache.calcite.sql.SqlJoin;
  53 import org.apache.calcite.sql.SqlKind;
  54 import org.apache.calcite.sql.SqlLiteral;
  55 import org.apache.calcite.sql.SqlNode;
  56 import org.apache.calcite.sql.SqlNodeList;
  57 import org.apache.calcite.sql.SqlOperator;
  58 import org.apache.calcite.sql.SqlOrderBy;
  59 import org.apache.calcite.sql.SqlSelect;
  60 import org.apache.calcite.sql.SqlWithItem;
  61 import org.apache.calcite.sql.fun.SqlCase;
  62 import org.apache.calcite.sql.parser.SqlParseException;
  63 import org.apache.calcite.sql.parser.SqlParserPos;
  64 import org.apache.commons.collections.CollectionUtils;
  65 import org.apache.commons.lang3.StringUtils;
  66 import org.slf4j.Logger;
  67 import org.slf4j.LoggerFactory;
  68 
  69 import java.sql.Timestamp;
  70 import java.util.Arrays;
  71 import java.util.Collection;
  72 import java.util.LinkedList;
  73 import java.util.List;
  74 import java.util.Map;
  75 import java.util.Queue;
  76 import java.util.Set;
  77 
  78 import static org.apache.calcite.sql.SqlKind.*;
  79 
  80 /**
  81  * Reason:
  82  * Date: 2018/7/24
  83  * Company: www.dtstack.com
  84  * @author xuchao
  85  */
  86 
  87 public class SideSqlExec {
  88 
  89     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  90 
  91     private String localSqlPluginPath = null;
  92 
  93     private String tmpFields = null;
  94 
  95     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  96 
  97     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  98 
  99 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     public void exec(String sql,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101                      Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102                      StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                      StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                      CreateTmpTableParser.SqlParserResult createView) throws Exception {</span>
 106 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 110     public void exec(String sql, Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 110     public void exec(String sql, Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 111                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 111                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.S🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         if(localSqlPluginPath == null){</span>
 113 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 114     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 114     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 115                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 115                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.S🔵</abbr></span>
 116 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 117         if(localSqlPluginPath == null){
 118             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 119         }
 120 
 121         localTableCache.putAll(tableCache);
 122         try {
 123             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 124         } catch (Exception e) {
 125             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 126         }
 127 
 128         if(createView != null){
 129             LOG.warn(&quot;create view info\n&quot;);
 130             LOG.warn(createView.getExecSql());
 131             LOG.warn(&quot;-----------------&quot;);
 132         }
 133 
 134         SideSQLParser sideSQLParser = new SideSQLParser();
 135         sideSQLParser.setLocalTableCache(localTableCache);
 136         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());
 137         Object pollObj = null;
 138 
 139         while((pollObj = exeQueue.poll()) != null){
 140 
 141             if(pollObj instanceof SqlNode){
 142                 SqlNode pollSqlNode = (SqlNode) pollObj;
 143 
 144 
 145                 if(pollSqlNode.getKind() == INSERT){
 146                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);
 147                     if(LOG.isInfoEnabled()){
 148                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 149                     }
 150 
 151                 }else if(pollSqlNode.getKind() == AS){
 152                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);
 153 
 154                 } else if (pollSqlNode.getKind() == WITH_ITEM) {
 155                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 156                     String TableAlias = sqlWithItem.name.toString();
 157                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 158                     tableEnv.registerTable(TableAlias, table);
 159 
 160                 } else if (pollSqlNode.getKind() == SELECT){
<abbr title=" 161                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 161                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr>
 162                     Table table = tableEnv.sqlQuery(pollObj.toString());
 163 
 164                     if (createView.getFieldsInfoStr() == null){
 165                         tableEnv.registerTable(createView.getTableName(), table);
 166                     } else {
 167                         if (checkFieldsInfo(createView, table)){
 168                             table = table.as(tmpFields);
 169                             tableEnv.registerTable(createView.getTableName(), table);
 170                         } else {
 171                             throw new RuntimeException(&quot;Fields mismatch&quot;);
 172                         }
 173                     }
 174 
 175                     localTableCache.put(createView.getTableName(), table);
 176                 }
 177 
 178             }else if (pollObj instanceof JoinInfo){
 179 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                 System.out.println(&quot;----------exec join info----------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                 System.out.println(pollObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
 183 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                         if (checkFieldsInfo(createView, table)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                             table = table.as(tmpFields);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                             tableEnv.registerTable(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                             throw new RuntimeException(&quot;Fields mismatch&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     localTableCache.put(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195             }else if (pollObj instanceof JoinInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 System.out.println(&quot;----------exec join info----------&quot;);</span>
 197 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                 preIsSideJoin = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
 201 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 202             }
 203         }
 204 
 205     }
 206 
 207 
 208     /**
 209      * 解析出as查询的表和字段的关系
 210      * @param asSqlNode
 211      * @param tableCache
 212      * @return
 213      */
 214     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 215         SqlNode info = asSqlNode.getOperands()[0];
 216         SqlNode alias = asSqlNode.getOperands()[1];
 217 
 218         SqlKind infoKind = info.getKind();
 219         if(infoKind != SELECT){
 220             return null;
 221         }
 222 
 223         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 224 
 225         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 226         for (FieldInfo fieldInfo : extractFieldList) {
 227             String tableName = fieldInfo.getTable();
 228             String fieldName = fieldInfo.getFieldName();
 229             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 230             mappingTable.put(tableName, fieldName, mappingFieldName);
 231         }
 232 
 233         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 234         replaceInfo.setMappingTable(mappingTable);
 235         replaceInfo.setTargetTableName(alias.toString());
 236         replaceInfo.setTargetTableAlias(alias.toString());
 237         return replaceInfo;
 238     }
 239 
 240 
 241 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242     public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {</span>
 243 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244             String fieldName = fieldInfo.getFieldName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246             mappingTable.put(tableName, fieldName, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         replaceInfo.setMappingTable(mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         replaceInfo.setTargetTableName(alias.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252         replaceInfo.setTargetTableAlias(alias.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         return replaceInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258      * 添加字段别名</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259      * @param pollSqlNode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260      * @param fieldList</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261      * @param mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 263     private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 263     private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264         SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266             case INSERT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267                 SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268                 addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 271                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);"> 271                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTab🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274                 SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275                 selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281                         // save real field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282                         String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 283                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 283                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                             fieldList.add(fieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                 for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290                     SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294                             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                         String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297                         // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 298                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 298                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299                             SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                             SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 302                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 302                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.l🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                             SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                             sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                             sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 306                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);"> 306                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                             selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 </span>
 317 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319      * 添加字段别名</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320      * @param pollSqlNode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321      * @param fieldList</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322      * @param mappingTable</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 324     private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 324     private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325         SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327             case INSERT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328                 SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329                 addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             case AS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 332                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);"> 332                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTab🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334             case SELECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335                 SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336                 selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340                             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                         // save real field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                         String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 344                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 344                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345                             fieldList.add(fieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349                 });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350                 for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351                     SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355                             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357                         String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358                         // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 359                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 359                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360                             SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361                             SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 363                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 363                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.l🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364                             SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365                             sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366                             sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 367                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);"> 367                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369                             selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {</span>
 381 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 382         SqlKind sqlKind = sqlNode.getKind();
 383         if(sqlKind != AS){
 384             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 385         }
 386 
 387         SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 388         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 389 
 390         AliasInfo aliasInfo = new AliasInfo();
 391         aliasInfo.setName(info.toString());
 392         aliasInfo.setAlias(alias.toString());
 393 
 394         return aliasInfo;
 395     }
 396 
 397     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,
 398                                            HashBasedTable&lt;String, String, String&gt; mappingTable) {
 399         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 400         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 401         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 402             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 403             String tableName = fieldInfo.getTable();
 404             String fieldName = fieldInfo.getFieldName();
 405 
 406             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 407             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 407             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 408 
 409             sideOutTypes[i] = fieldInfo.getTypeInformation();
 410             sideOutNames[i] = mappingFieldName;
 411         }
 412         return new RowTypeInfo(sideOutTypes, sideOutNames);
 413     }
 414 
 415 
 416 
 417     /**
 418      *  对时间类型进行类型转换
 419      * @param leftTypeInfo
 420      * @return
 421      */
 422     private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 423         TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 424         TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 425         for (int i = 0; i &lt; sideOutTypes.length; i++) {
 426             sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 427         }
 428         RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 429         return rowTypeInfo;
 430     }
 431 
 432     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 433         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 434             return TypeInformation.of(Timestamp.class);
 435         }
 436         return typeInformation;
 437     }
 438 
 439 
 440 
 441 
 442 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 443 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444                             sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 445                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);"> 445                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                             selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456     public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         if(sqlKind != AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465         AliasInfo aliasInfo = new AliasInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466         aliasInfo.setName(info.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467         aliasInfo.setAlias(alias.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469         return aliasInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 472     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 472     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, Stri🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         String[] sideOutNames = new String[sideJoinFieldInfo.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477             String tableName = fieldInfo.getTable();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478             String fieldName = fieldInfo.getFieldName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480             mappingTable.put(tableName, fieldName, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             sideOutTypes[i] = fieldInfo.getTypeInformation();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483             sideOutNames[i] = mappingFieldName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485         return new RowTypeInfo(sideOutTypes, sideOutNames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491      *  对时间类型进行类型转换</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492      * @param leftTypeInfo</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495     private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496         TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497         TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498         for (int i = 0; i &lt; sideOutTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499             sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501         RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502         return rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506         if (typeInformation instanceof TimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507             return TypeInformation.of(Timestamp.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509         return typeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512     //需要考虑更多的情况</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513     private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516             case INSERT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517                 SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518                 replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521                 SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522                 replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 525                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 525                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTarget🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526                 if(sqlSelect == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530                 SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531                 if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532                     String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533                     if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534                         SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535                         SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536                         SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538                         //TODO 暂时不处理having</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539                         SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541                         List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 545                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){"> 545                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 546                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 546                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 560                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 560                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563                         //where</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 573                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 574                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 575                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 576                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 577                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 578                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 579                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 580                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 581                     //TODO</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 582                     System.out.println(sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 587             case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 591                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 592 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 599                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 599                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 634             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 634             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 657         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 658         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 661                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 661                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 662                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 662                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 672                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688         return null;</span>
 689 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690                         List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 694                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){"> 694                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 695                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 695                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697                                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702                                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 709                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 709                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712                         //where</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734             case UNION:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 746                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 746                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770             return orderNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 781             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 781             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798             return groupNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 804         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 805         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 806             case SELECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 807                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 808                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 808                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 809                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 809                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 810                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811                     }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812                         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817             case AS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820             case JOIN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 823                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 824                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 825 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 826                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 827                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 828                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 829                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 830                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 831                     return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 832                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 833             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 834                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 835         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 836 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 837         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 838     }</span>
 839 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 840 
 841 
 842     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 843         this.localSqlPluginPath = localSqlPluginPath;
 844     }
 845 
<abbr title=" 846     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 846     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 847         Table table = localTableCache.get(tableAlias);
 848         if(table == null){
 849             table = localTableCache.get(tableName);
 850         }
 851 
 852         if(table == null){
 853             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 854         }
 855 
 856         return table;
 857     }
 858 
 859 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 860 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 861         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 862 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 863         AliasInfo aliasInfo = new AliasInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 864         aliasInfo.setName(info.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 865         aliasInfo.setAlias(alias.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 866 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 867         return aliasInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 868     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 869 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 870     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 870     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, Stri🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 871         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 872         String[] sideOutNames = new String[sideJoinFieldInfo.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 873         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 874             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 875             String tableName = fieldInfo.getTable();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 876             String fieldName = fieldInfo.getFieldName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 877             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 878             mappingTable.put(tableName, fieldName, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 879 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 880             sideOutTypes[i] = fieldInfo.getTypeInformation();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 881             sideOutNames[i] = mappingFieldName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 882         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 883         return new RowTypeInfo(sideOutTypes, sideOutNames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 884     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 885 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 886 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 887 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 888     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 889      *  对时间类型进行类型转换</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 890      * @param leftTypeInfo</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 891      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 892      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 893     private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 894         TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 895         TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 896         for (int i = 0; i &lt; sideOutTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 897             sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 898         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 899         RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 900         return rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 901     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 902 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 903     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 904         if (typeInformation instanceof TimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 905             return TypeInformation.of(Timestamp.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 906         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 907         return typeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 908     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 909 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 910     //需要考虑更多的情况</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 911     private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 912         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 913         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 914             case INSERT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 915                 SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 916                 replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 917                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 918             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 919                 SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 920                 replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 921                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 922             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 923                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 923                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTarget🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 924                 if(sqlSelect == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 925                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 926                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 927 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 928                 SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 929                 if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 930                     String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 931                     if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 932                         SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 933                         SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 934                         SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 935 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 936                         //TODO 暂时不处理having</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 937                         SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 938 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 939                         List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 940                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 941                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 942                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 943                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){"> 943                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 944                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 944                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 945                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 946                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 947                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 948 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 949                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 950                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 951                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 952                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 953 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 954                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 955                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 956                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 957 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 958                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 958                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 959                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 960 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 961                         //where</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 962                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 963                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 964                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 965                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 966                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 967                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 968                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 969                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 970                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 971                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 972                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 973                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 974                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 975                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 976                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 977                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 978                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 979                     //TODO</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 980                     System.out.println(sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 981                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 982                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 983 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 984                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 985             case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 986                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 987                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 988                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 989                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 990 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 991                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 992             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 993                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 994                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 995                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 996                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 997                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 997                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 998                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 999                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1000 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1001             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1002                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1003         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1004     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1005 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1006     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1007         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1008             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1009             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1010                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1011             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1012             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1013         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1014             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1015             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1016                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1017                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1018             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1019             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1020         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1021             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1022         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1023     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1024 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1025     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1026         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1027             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1028             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1029                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1030             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1031 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1032             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1032             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1033             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1034                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1035             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1036 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1037             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1038             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1039         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1040             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1041             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1042                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1043                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1044                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1045             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1046 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1047             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1048         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1049             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1050         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1051     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1052 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1053     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1054 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1055         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1056         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1057             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1058                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1059                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){">1059                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1060                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){">1060                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1061                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1062                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1063                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1064                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1065                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1066                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1067                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1068             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1069                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1070                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1071             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1072                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1073                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1074                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1075                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1076 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1077                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1078                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1079                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1080                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1081                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1082                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1083                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1084         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1085 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1086         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1087     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1088 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1089 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1090     public void setLocalSqlPluginPath(String localSqlPluginPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1091         this.localSqlPluginPath = localSqlPluginPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1092     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1093 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1094     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){">1094     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095         Table table = localTableCache.get(tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097             table = localTableCache.get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1099 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1100         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1101             throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1102         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1104         return table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1105     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1107     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1108         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1109         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1110         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1111             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1112             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1113             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1114                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1115             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1116                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1117             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1119             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1120                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1128             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1129         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1130             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1131         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1134     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1135         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1136             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1137             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1138             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1139                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1140             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1141 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1142             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1143         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1144             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1146             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1147                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1148             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1149 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1150             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1151             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1151             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1152             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1153                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1154             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1156             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1157             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1158             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1159         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1160             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1161         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1162                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1163                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1164                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1165                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1166                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1167                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1168                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1169                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1170                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1171                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1172                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1173                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1174                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1175                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1176                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1177                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1178                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1179                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1180                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1181                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1182                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1183                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1184                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1185                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1186                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1187                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1188                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1189                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1190 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1191                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1192             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1193             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1194                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1195                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1196                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1197                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1198 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1199                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1200                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1201                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1202 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1203                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1204                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1205                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1206                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1208                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1209             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1210 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1211             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1212         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1213             System.out.println(&quot;selectNode&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1214             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1215             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1216             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1217             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1219             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1220                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1221                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1222                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1223                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1224                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1225             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1227             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1228                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1229                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1230                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1231                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1232                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1233             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1234 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1235             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1236             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1237         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1238             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1239             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1240         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1241             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));">1241             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
1242 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1243     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1244         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1245         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1246         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1247             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1248             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1249             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1250                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1251             }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1252                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1253             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1255             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1256                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1257                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1258                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1259                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1260                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1261                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1262             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1264             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1265         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1266             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1267         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1268     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1269 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1270     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1271         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1272             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1273             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1274             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1275                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1276             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1277 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1278             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1279         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1280             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1281 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1282             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1283                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1284             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1285 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1286             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1287             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1287             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1288             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1289                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1290             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1291 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1292             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1293             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1294             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1295         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1296             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1297         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1298                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1299                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1300                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1301                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1302                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1303                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1304                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1305                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1306                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1307                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1308                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1309                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1310                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1311                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1312                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1313                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1314                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1315                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1316                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1317                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1318                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1319                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1320                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1321                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1322                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1323                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1324                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1325                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1326 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1327                 ){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1328             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1329             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1330                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1331                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1332                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1333                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1334 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1335                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1336                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1337                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1338 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1339                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1340                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1341                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1342                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1343 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1344                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1345             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1346 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1347             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1348         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1349             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1350             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1351             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1352             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1353 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1354             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1355                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1356                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1357                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1358                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1359                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1360             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1361 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1362             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1363                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1364                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1365                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1366                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1367                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1368             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1369 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1370             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1371             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1372         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1373             //不处理</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1374             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1375         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1376             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));">1376             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1377         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1378     }</span>
1379 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1380 
1381     /**
<abbr title="1382      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition">1382      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
1383      *
1384      * @return
1385      */
<abbr title="1386     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {">1386     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
1387         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
1388         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
1389             return true;
1390         }
1391         return false;
1392     }
1393 
1394     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
1395         List&lt;String&gt; res = Lists.newArrayList();
1396         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
1397             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
1398         });
1399         return res;
1400     }
1401 
<abbr title="1402     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){">1402     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
1403         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
1404         ParseUtils.parseAnd(conditionNode, sqlNodeList);
1405         List&lt;String&gt; conditionFields = Lists.newArrayList();
1406         for(SqlNode sqlNode : sqlNodeList){
1407             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
1408                 throw new RuntimeException(&quot;not compare operator.&quot;);
1409             }
1410 
1411             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
1412             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
1413 
1414             String leftTableName = left.getComponent(0).getSimple();
1415             String rightTableName = right.getComponent(0).getSimple();
1416 
1417             String tableCol = &quot;&quot;;
1418             if(leftTableName.equalsIgnoreCase(specifyTableName)){
1419                 tableCol = left.getComponent(1).getSimple();
1420             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
1421                 tableCol = right.getComponent(1).getSimple();
1422             }else{
<abbr title="1423                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));">1423                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
1424             }
1425             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
1426             conditionFields.add(tableCol);
1427         }
1428 
1429         return conditionFields;
1430     }
1431 
1432     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
1433                                      SqlNode pollSqlNode,
1434                                      Map&lt;String, Table&gt; tableCache) throws SqlParseException {
1435 
1436         AliasInfo aliasInfo = parseAsNode(pollSqlNode);
1437         if (localTableCache.containsKey(aliasInfo.getName())) {
1438             return;
1439         }
1440 
1441         Table table = tableEnv.sqlQuery(aliasInfo.getName());
1442         tableEnv.registerTable(aliasInfo.getAlias(), table);
1443         localTableCache.put(aliasInfo.getAlias(), table);
1444 
1445         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
1446 
1447         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
1448         if(fieldReplaceInfo == null){
1449            return;
1450         }
1451 
1452         //as 的源表
1453         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
1454         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
1455         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
1456 
1457     }
1458 
1459 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1460     private void joinFun(Object pollObj,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1461                          Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1462                          Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1463                          StreamTableEnvironment tableEnv) throws Exception{</span>
1464 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1465                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1466                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1467                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1468                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){">1468                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1469                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);">1469                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1470                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1471                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1472                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1473 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1474                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1475                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1476                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1477                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1478 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1479                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1480                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1481                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1482 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1483                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());">1483                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1484                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1485 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1486                         //where</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1487                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1488                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1489                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1490                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1491                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1492                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1493                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1494                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1495                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1496                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1497                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1498                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1499                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1500                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1501                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1502                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1503                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1504                     //TODO</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1505                     System.out.println(sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1506                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1507                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1508 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1509                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1510             case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1511                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1512                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1513                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1514                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1515 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1516                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1517             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1518                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1519                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1520                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1521                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1522                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());">1522                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1523                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1524                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1525 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1526             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1527                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1528         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1529     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1530 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1531     private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1532         if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1533             SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1534             if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1535                 return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1536             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1537             return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1538         } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1539             SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1540             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1541                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1542                 sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1543             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1544             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1545         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1546             return orderNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1547         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1548     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1549 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1550     private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1551         if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1552             SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1553             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1554                 return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1555             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1556 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1557             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1557             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1558             if(mappingFieldName == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1559                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1560             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1561 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1562             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1563             return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1564         }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1565             SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1566             for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1567                 SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1568                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1569                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1570             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1571 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1572             return sqlBasicCall;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1573         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1574             return groupNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1575         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1576     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1577 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1578     public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1579 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1580         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1581         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1582             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1583                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1584                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){">1584                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1585                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){">1585                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1586                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1587                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1588                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1589                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1590                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1591                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1592                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1593             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1594                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1595                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1596             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1597                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1598                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1599                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1600                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1601 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1602                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1603                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1604                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1605                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1606                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1607                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1608                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1609         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1610 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1611         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1612     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1613 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1614 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1615     public void setLocalSqlPluginPath(String localSqlPluginPath) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1616         this.localSqlPluginPath = localSqlPluginPath;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1617     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1618 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1619     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){">1619     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1620         Table table = localTableCache.get(tableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1621         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1622             table = localTableCache.get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1623         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1624 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1625         if(table == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1626             throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1627         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1628 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1629         return table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1630     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1631 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1632     private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1633         SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1634         List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1635         if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1636             int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1637             Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1638             if(identifierSize == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1639                 columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1640             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1641                 columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1642             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1643 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1644             for(String colAlias : columns){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1645                 SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1646                 List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1647                 columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1648                 columnInfo.add(colAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1649                 SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1650                 sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1651             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1652 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1653             return sqlNodes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1654         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1655             throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1656         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1657     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1658 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1659     private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1660         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1661             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1662             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1663             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1664                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1665             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1666 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1667             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1668         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1669             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1670 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1671             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1672                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1673             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1674 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1675             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1676             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());">1676             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1677             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1678                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1679             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1680 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1681             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1682             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1683             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1684         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1685             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1686         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1687                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1688                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1689                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1690                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1691                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1692                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1693                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1694                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1695                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1696                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1697                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1698                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1699                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1700                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1701                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1702                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1703                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1704                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1705                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1706                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1707                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1708                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1709                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1710                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1711                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1712                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1713                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1714                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1715 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1716                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1717             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1718             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1719                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1720                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1721                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1722                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1723 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1724                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1725                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1726                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1727 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1728                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1729                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1730                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1731                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1732 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1733                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1734             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1735 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1736             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1737         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1738             System.out.println(&quot;selectNode&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1739             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1740             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1741             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1742             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1743 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1744             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1745                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1746                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1747                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1748                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1749                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1750             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1751 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1752             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1753                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1754                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1755                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1756                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1757                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1758             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1759 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1760             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1761             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1762         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1763             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1764             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1765         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1766             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));">1766             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1767         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1768     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1769 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1770     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1771      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition">1771      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1772      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1773      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1774      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1775     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTableInfo) {">1775     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1776         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1777         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1778             return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1779         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1780         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1781     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1782 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1783     private List&lt;String&gt; convertPrimaryAlias(SideTableInfo sideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1784         List&lt;String&gt; res = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1785         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1786             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1787         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1788         return res;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1789     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1790 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1791     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo sideTableInfo){">1791     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1792         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1793         ParseUtils.parseAnd(conditionNode, sqlNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1794         List&lt;String&gt; conditionFields = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1795         for(SqlNode sqlNode : sqlNodeList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1796             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1797                 throw new RuntimeException(&quot;not compare operator.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1798             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1799 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1800             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1801             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1802 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1803             String leftTableName = left.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1804             String rightTableName = right.getComponent(0).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1805 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1806             String tableCol = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1807             if(leftTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1808                 tableCol = left.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1809             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1810                 tableCol = right.getComponent(1).getSimple();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1811             }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1812                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));">1812                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1813             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1814             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1815             conditionFields.add(tableCol);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1816         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1817 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1818         return conditionFields;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1819     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1820 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1821     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1822                                      SqlNode pollSqlNode,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1823                                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1824                                      List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1825 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1826         AliasInfo aliasInfo = parseASNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1827         if (localTableCache.containsKey(aliasInfo.getName())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1828             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1829         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1830 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1831         Table table = tableEnv.sqlQuery(aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1832         tableEnv.registerTable(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1833         localTableCache.put(aliasInfo.getAlias(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1834 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1835         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1836 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1837         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1838         if(fieldReplaceInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1839            return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1840         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1841 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1842         //as 的源表</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1843         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1844         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1845         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1846         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1847             if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1848                     || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1849                 fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1850                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1851             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1852         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1853         replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1854     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1855 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1856     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
1857 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1858     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1859                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">1859                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1860                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
1861 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1862         JoinInfo joinInfo = (JoinInfo) pollObj;
1863 
1864         JoinScope joinScope = new JoinScope();
1865         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
1866         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
1867         leftScopeChild.setTableName(joinInfo.getLeftTableName());
1868 
<abbr title="1869         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1869         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr>
<abbr title="1870         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1870         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr>
1871         leftScopeChild.setRowTypeInfo(leftTypeInfo);
1872 
1873         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
1874         rightScopeChild.setAlias(joinInfo.getRightTableAlias());
1875         rightScopeChild.setTableName(joinInfo.getRightTableName());
1876         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
1877         if(sideTableInfo == null){
1878             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
1879         }
1880 
1881         if(sideTableInfo == null){
1882             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
1883         }
1884 
1885 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){
1886 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);
1887 //        }
1888 
1889         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
1890 
1891         joinScope.addScope(leftScopeChild);
1892         joinScope.addScope(rightScopeChild);
1893 
1894         HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();
1895 
1896         //获取两个表的所有字段
<abbr title="1897         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1897         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr>
1898         //通过join的查询字段信息过滤出需要的字段信息
<abbr title="1899         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);">1899         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo🔵</abbr>
1900 
1901         String leftTableAlias = joinInfo.getLeftTableAlias();
1902         Table targetTable = localTableCache.get(leftTableAlias);
1903         if(targetTable == null){
1904             targetTable = localTableCache.get(joinInfo.getLeftTableName());
1905         }
1906 
<abbr title="1907         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1907         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr>
1908 
<abbr title="1909         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1909         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr>
1910                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {
1911                     return new CRow(tp2.f1, tp2.f0);
1912                 }).returns(CRow.class);
1913 
1914 
1915         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
1916         if (sideTableInfo.isPartitionedJoin()) {
<abbr title="1917             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);">1917             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr>
1918             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
1919             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title="1920             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));">1920             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr>
1921         }
1922 
1923         DataStream&lt;CRow&gt; dsOut = null;
1924         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title="1925             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1925             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr>
1926         }else{
<abbr title="1927             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1927             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr>
1928         }
1929 
1930         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
1931 
1932         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);
1933         dsOut.getTransformation().setOutputType(cRowTypeInfo);
1934 
1935         String targetTableName = joinInfo.getNewTableName();
1936         String targetTableAlias = joinInfo.getNewTableAlias();
1937 
1938         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
1939         replaceInfo.setMappingTable(mappingTable);
1940         replaceInfo.setTargetTableName(targetTableName);
1941         replaceInfo.setTargetTableAlias(targetTableAlias);
1942 
1943         if (!tableEnv.isRegistered(joinInfo.getNewTableName())){
1944             Table joinTable = tableEnv.fromDataStream(dsOut);
1945             tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);
1946             localTableCache.put(joinInfo.getNewTableName(), joinTable);
1947         }
1948     }
1949 
1950     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
1951         String[] fieldNames = schema.getFieldNames();
1952         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
1953 
<abbr title="1954         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);">1954         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::ne🔵</abbr>
<abbr title="1955         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);">1955         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(Typ🔵</abbr>
1956         return new RowTypeInfo(projectedTypes, projectedNames);
1957     }
1958 
1959 
1960     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
1961         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
1962         String fieldsInfo = result.getFieldsInfoStr();
1963         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
1964         for (int i = 0; i &lt; fields.length; i++) {
1965             String[] filed = fields[i].split(&quot;\\s&quot;);
1966             if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){
1967                 return false;
1968             } else {
1969                 String[] filedNameArr = new String[filed.length - 1];
1970                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
1971                 String fieldName = String.join(&quot; &quot;, filedNameArr);
1972                 fieldNames.add(fieldName);
1973                 String fieldType = filed[filed.length - 1 ].trim();
1974                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
1975                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
1976                 if (fieldClass == tableField){
1977                     continue;
1978                 } else {
1979                     return false;
1980                 }
1981             }
1982         }
1983         tmpFields = String.join(&quot;,&quot;, fieldNames);
1984         return true;
1985     }
1986 
1987 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side;
  22 
  23 import org.apache.flink.api.common.typeinfo.TypeInformation;
  24 import org.apache.flink.api.java.tuple.Tuple2;
  25 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  26 import org.apache.flink.streaming.api.datastream.DataStream;
  27 import org.apache.flink.table.api.StreamQueryConfig;
  28 import org.apache.flink.table.api.Table;
  29 import org.apache.flink.table.api.TableSchema;
  30 import org.apache.flink.table.api.java.StreamTableEnvironment;
  31 import org.apache.flink.table.runtime.CRowKeySelector;
  32 import org.apache.flink.table.runtime.types.CRow;
  33 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  34 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  35 import org.apache.flink.types.Row;
  36 
  37 import com.dtstack.flink.sql.enums.ECacheType;
  38 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  39 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  40 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  41 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  42 import com.dtstack.flink.sql.util.ClassUtil;
  43 import com.dtstack.flink.sql.util.ParseUtils;
  44 import com.dtstack.flink.sql.util.TableUtils;
  45 import com.google.common.base.Preconditions;
  46 import com.google.common.collect.*;
  47 import org.apache.calcite.sql.SqlAsOperator;
  48 import org.apache.calcite.sql.SqlBasicCall;
  49 import org.apache.calcite.sql.SqlDataTypeSpec;
  50 import org.apache.calcite.sql.SqlIdentifier;
  51 import org.apache.calcite.sql.SqlInsert;
  52 import org.apache.calcite.sql.SqlJoin;
  53 import org.apache.calcite.sql.SqlKind;
  54 import org.apache.calcite.sql.SqlLiteral;
  55 import org.apache.calcite.sql.SqlNode;
  56 import org.apache.calcite.sql.SqlNodeList;
  57 import org.apache.calcite.sql.SqlOperator;
  58 import org.apache.calcite.sql.SqlOrderBy;
  59 import org.apache.calcite.sql.SqlSelect;
  60 import org.apache.calcite.sql.SqlWithItem;
  61 import org.apache.calcite.sql.fun.SqlCase;
  62 import org.apache.calcite.sql.parser.SqlParseException;
  63 import org.apache.calcite.sql.parser.SqlParserPos;
  64 import org.apache.commons.collections.CollectionUtils;
  65 import org.apache.commons.lang3.StringUtils;
  66 import org.slf4j.Logger;
  67 import org.slf4j.LoggerFactory;
  68 
  69 import java.sql.Timestamp;
  70 import java.util.Arrays;
  71 import java.util.Collection;
  72 import java.util.LinkedList;
  73 import java.util.List;
  74 import java.util.Map;
  75 import java.util.Queue;
  76 import java.util.Set;
  77 
  78 import static org.apache.calcite.sql.SqlKind.*;
  79 
  80 /**
  81  * Reason:
  82  * Date: 2018/7/24
  83  * Company: www.dtstack.com
  84  * @author xuchao
  85  */
  86 
  87 public class SideSqlExec {
  88 
  89     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  90 
  91     private String localSqlPluginPath = null;
  92 
  93     private String tmpFields = null;
  94 
  95     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  96 
  97     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  98 
  99 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100 public void exec(String sql,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101                      Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102                      StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                      Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104                      StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105                      CreateTmpTableParser.SqlParserResult createView) throws Exception {</span>
 106 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 public void exec(String sql, Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 108                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 108                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.S🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         if(localSqlPluginPath == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 </span>
 113 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 114 public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,"> 114 public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 115                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 115                      Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.S🔵</abbr></span>
 116 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 117         if(localSqlPluginPath == null){
 118             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 119         }
 120 
 121         localTableCache.putAll(tableCache);
 122         try {
 123             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 124         } catch (Exception e) {
 125             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 126         }
 127 
 128         if(createView != null){
 129             LOG.warn(&quot;create view info\n&quot;);
 130             LOG.warn(createView.getExecSql());
 131             LOG.warn(&quot;-----------------&quot;);
 132         }
 133 
 134         SideSQLParser sideSQLParser = new SideSQLParser();
 135         sideSQLParser.setLocalTableCache(localTableCache);
 136         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());
 137         Object pollObj = null;
 138 
 139         while((pollObj = exeQueue.poll()) != null){
 140 
 141             if(pollObj instanceof SqlNode){
 142                 SqlNode pollSqlNode = (SqlNode) pollObj;
 143 
 144 
 145                 if(pollSqlNode.getKind() == INSERT){
 146                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);
 147                     if(LOG.isInfoEnabled()){
 148                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 149                     }
 150 
 151                 }else if(pollSqlNode.getKind() == AS){
 152                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);
 153 
 154                 } else if (pollSqlNode.getKind() == WITH_ITEM) {
 155                     SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 156                     String TableAlias = sqlWithItem.name.toString();
 157                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 158                     tableEnv.registerTable(TableAlias, table);
 159 
 160                 } else if (pollSqlNode.getKind() == SELECT){
<abbr title=" 161                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 161                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr>
 162                     Table table = tableEnv.sqlQuery(pollObj.toString());
 163 
 164                     if (createView.getFieldsInfoStr() == null){
 165                         tableEnv.registerTable(createView.getTableName(), table);
 166                     } else {
 167                         if (checkFieldsInfo(createView, table)){
 168                             table = table.as(tmpFields);
 169                             tableEnv.registerTable(createView.getTableName(), table);
 170                         } else {
 171                             throw new RuntimeException(&quot;Fields mismatch&quot;);
 172                         }
 173                     }
 174 
 175                     localTableCache.put(createView.getTableName(), table);
 176                 }
 177 
 178             }else if (pollObj instanceof JoinInfo){
 179 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                 System.out.println(&quot;----------exec join info----------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                 System.out.println(pollObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
 183 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                             throw new RuntimeException(&quot;Fields mismatch&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                     localTableCache.put(createView.getTableName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             }else if (pollObj instanceof JoinInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 System.out.println(&quot;----------exec join info----------&quot;);</span>
 194 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                 preIsSideJoin = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
 198 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 199             }
 200         }
 201 
 202     }
 203 
 204 
 205     /**
 206      * 解析出as查询的表和字段的关系
 207      * @param asSqlNode
 208      * @param tableCache
 209      * @return
 210      */
 211     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 212         SqlNode info = asSqlNode.getOperands()[0];
 213         SqlNode alias = asSqlNode.getOperands()[1];
 214 
 215         SqlKind infoKind = info.getKind();
 216         if(infoKind != SELECT){
 217             return null;
 218         }
 219 
 220         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 221 
 222         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 223         for (FieldInfo fieldInfo : extractFieldList) {
 224             String tableName = fieldInfo.getTable();
 225             String fieldName = fieldInfo.getFieldName();
 226             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 227             mappingTable.put(tableName, fieldName, mappingFieldName);
 228         }
 229 
 230         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 231         replaceInfo.setMappingTable(mappingTable);
 232         replaceInfo.setTargetTableName(alias.toString());
 233         replaceInfo.setTargetTableAlias(alias.toString());
 234         return replaceInfo;
 235     }
 236 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 237 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 238 private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 238 private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, Str🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241             case INSERT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                 SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                 addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 246                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);"> 246                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTab🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                 SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                 selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                         // save real field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                         String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 258                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 258                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259                             fieldList.add(fieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                 for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                     SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269                             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                         String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272                         // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 273                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 273                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274                             SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275                             SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 277                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 277                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.l🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                             SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                             sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                             sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 281                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);"> 281                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                             selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289     }</span>
 290 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 291 private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 291 private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, Str🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294             case INSERT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295                 SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296                 addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298             case AS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 299                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);"> 299                 addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTab🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             case SELECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                 SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                 selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                         // save real field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                         String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 311                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 311                         if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312                             fieldList.add(fieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316                 });</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317                 for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318                     SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319                     if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                         SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                         if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                         String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325                         // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 326                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 326                         if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327                             SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328                             SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 330                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 330                             SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.l🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331                             SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332                             sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333                             sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 334                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);"> 334                             SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336                             selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     }</span>
 345 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 346 
 347 
 348 
 349     public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {
 350         SqlKind sqlKind = sqlNode.getKind();
 351         if(sqlKind != AS){
 352             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 353         }
 354 
 355         SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 356         SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 357 
 358         AliasInfo aliasInfo = new AliasInfo();
 359         aliasInfo.setName(info.toString());
 360         aliasInfo.setAlias(alias.toString());
 361 
 362         return aliasInfo;
 363     }
 364 
 365     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,
 366                                            HashBasedTable&lt;String, String, String&gt; mappingTable) {
 367         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 368         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 369         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 370             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 371             String tableName = fieldInfo.getTable();
 372             String fieldName = fieldInfo.getFieldName();
 373 
 374             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 375             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 375             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 376 
 377             sideOutTypes[i] = fieldInfo.getTypeInformation();
 378             sideOutNames[i] = mappingFieldName;
 379         }
 380         return new RowTypeInfo(sideOutTypes, sideOutNames);
 381     }
 382 
 383 
 384 
 385     /**
 386      *  对时间类型进行类型转换
 387      * @param leftTypeInfo
 388      * @return
 389      */
 390     private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 391         TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 392         TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 393         for (int i = 0; i &lt; sideOutTypes.length; i++) {
 394             sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 395         }
 396         RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 397         return rowTypeInfo;
 398     }
 399 
 400     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 401         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 402             return TypeInformation.of(Timestamp.class);
 403         }
 404         return typeInformation;
 405     }
 406 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 407 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408 private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411             case INSERT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412                 SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413                 replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416                 SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417                 replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 420                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 420                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTarget🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421                 if(sqlSelect == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425                 SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426                 if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427                     String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428                     if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429                         SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430                         SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431                         SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433                         //TODO 暂时不处理having</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434                         SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436                         List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 440                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){"> 440                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 441                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 441                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448                                 continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 455                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 455                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458                         //where</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472                             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476                     //TODO</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477                     System.out.println(sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482             case UNION:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 494                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 494                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498             default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501     }</span>
 502 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505         switch (sqlKind) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506             case INSERT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507                 SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508                 replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510             case AS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511                 SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512                 replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514             case SELECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 515                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 515                 SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTarget🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516                 if(sqlSelect == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517                     return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520                 SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521                 if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522                     String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523                     if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524                         SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525                         SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526                         SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528                         //TODO 暂时不处理having</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529                         SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531                         List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532                         for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533                             SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534                             //特殊处理 isStar的标识</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 535                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){"> 535                             if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 536                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 536                                 List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, re🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537                                 newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538                                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541                             SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542                             if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543                                 continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546                             //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547                             newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 550                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 550                         SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551                         sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553                         //where</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554                         if(whereNode != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555                             SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556                             for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557                                 SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558                                 SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559                                 sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562                         if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563                             for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564                                 SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565                                 SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566                                 sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567                             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571                     throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575             case UNION:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576                 SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577                 SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578                 replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579                 replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582             case ORDER_BY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583                 SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584                 replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585                 SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586                 for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 587                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 587                     SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getT🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588                     orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594     }</span>
 595 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 596 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 597 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598 public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602             case SELECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 604                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 604                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 605                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 605                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608                         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613             case AS:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616             case JOIN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626                 }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627                     return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632     }</span>
 633 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634 public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636         SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637         switch (sqlKind){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638             case SELECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639                 SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 640                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){"> 640                 if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDE🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 641                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){"> 641                     if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableN🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642                         return sqlNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643                     }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644                         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647                     return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649             case AS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650                 SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651                 return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652             case JOIN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653                 SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655                 SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656                 SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658                 if(leftReturnNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659                     return leftReturnNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660                 }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661                     return rightReturnNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662                 }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663                     return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670     }</span>
 671 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 672 
 673 
 674 
 675 
 676 
 677 
 678 
 679     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 680         this.localSqlPluginPath = localSqlPluginPath;
 681     }
 682 
<abbr title=" 683     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){"> 683     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 684         Table table = localTableCache.get(tableAlias);
 685         if(table == null){
 686             table = localTableCache.get(tableName);
 687         }
 688 
 689         if(table == null){
 690             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 691         }
 692 
 693         return table;
 694     }
 695 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 696 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697 private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 714             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 714             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 754                 ){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 755             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 756             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 757                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 758                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 759                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 760                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 761 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 762                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 763                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 764                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 765 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 766                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 767                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 768                     continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 769                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 770 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 771                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 772             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 773 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 774             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 775         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 776             System.out.println(&quot;selectNode&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 777             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 778             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 779             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 780             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 781 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 782             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 783                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 784                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 785                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 786                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 787                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 788             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 789 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 790             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 791                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 792                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 793                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 794                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 795                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 796             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 797 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 798             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 799             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 800         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 801             //不处理</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 802             return selectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 803         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 804             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 804             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 805         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 806     }</span>
 807 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 808 private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 809         if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 810             SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811             SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812             if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813                 ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817         }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818             SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820             if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821                 return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 823 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 824             //Same level mappingTable</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 825             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 825             String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSim🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 826             if (mappingFieldName == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 827                 throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 828             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 829 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 830             sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 831             sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 832             return sqlIdentifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 833         }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 834             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 835         }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 836                 || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 837                 || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 838                 || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 839                 || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 840                 || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 841                 || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 842                 || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 843                 || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 844                 || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 845                 || selectNode.getKind() == OR</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 846                 || selectNode.getKind() == AND</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 847                 || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 848                 || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 849                 || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 850                 || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 851                 || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 852                 || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 853                 || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 854                 || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 855                 || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 856                 || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 857                 || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 858                 || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 859                 || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 860                 || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 861                 || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 862                 || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 863                 || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 864 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 865                 ){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 866             SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 867             for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 868                 SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 869                 if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 870                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 871                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 872 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 873                 if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 874                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 875                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 876 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 877                 SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 878                 if(replaceNode == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 879                     continue;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 880                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 881 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 882                 sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 883             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 884 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 885             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 886         }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 887             SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 888             SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 889             SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 890             SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 891 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 892             for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 893                 SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 894                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 895                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 896                     whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 897                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 898             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 899 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 900             for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 901                 SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 902                 SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 903                 if (replaceNode != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 904                     thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 905                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 906             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 907 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 908             ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 909             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 910         }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 911             //不处理</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 912             return selectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 913         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 914             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 914             throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 915         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 916     }</span>
 917 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 918 
 919 
 920 
 921     /**
<abbr title=" 922      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 922      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
 923      *
 924      * @return
 925      */
<abbr title=" 926     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 926     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
 927         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 928         if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 929             return true;
 930         }
 931         return false;
 932     }
 933 
 934     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 935         List&lt;String&gt; res = Lists.newArrayList();
 936         sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 937             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 938         });
 939         return res;
 940     }
 941 
<abbr title=" 942     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 942     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
 943         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 944         ParseUtils.parseAnd(conditionNode, sqlNodeList);
 945         List&lt;String&gt; conditionFields = Lists.newArrayList();
 946         for(SqlNode sqlNode : sqlNodeList){
 947             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 948                 throw new RuntimeException(&quot;not compare operator.&quot;);
 949             }
 950 
 951             SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 952             SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 953 
 954             String leftTableName = left.getComponent(0).getSimple();
 955             String rightTableName = right.getComponent(0).getSimple();
 956 
 957             String tableCol = &quot;&quot;;
 958             if(leftTableName.equalsIgnoreCase(specifyTableName)){
 959                 tableCol = left.getComponent(1).getSimple();
 960             }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 961                 tableCol = right.getComponent(1).getSimple();
 962             }else{
<abbr title=" 963                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 963                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
 964             }
 965             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 966             conditionFields.add(tableCol);
 967         }
 968 
 969         return conditionFields;
 970     }
 971 
 972     protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 973                                      SqlNode pollSqlNode,
 974                                      Map&lt;String, Table&gt; tableCache) throws SqlParseException {
 975 
 976         AliasInfo aliasInfo = parseAsNode(pollSqlNode);
 977         if (localTableCache.containsKey(aliasInfo.getName())) {
 978             return;
 979         }
 980 
 981         Table table = tableEnv.sqlQuery(aliasInfo.getName());
 982         tableEnv.registerTable(aliasInfo.getAlias(), table);
 983         localTableCache.put(aliasInfo.getAlias(), table);
 984 
 985         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 986 
 987         FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 988         if(fieldReplaceInfo == null){
 989            return;
 990         }
 991 
 992         //as 的源表
 993         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 994         SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 995         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 996 
 997     }
 998 
 999 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1000     private void joinFun(Object pollObj,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1001                          Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1002                          Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1003                          StreamTableEnvironment tableEnv) throws Exception{</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1004         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1005 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1006         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1007         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1008         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1009         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1010 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1011         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1011         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1012         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1012         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1013         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1014 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1015         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1016         rightScopeChild.setAlias(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1017         rightScopeChild.setTableName(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1018         SideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1019         if(sideTableInfo == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1020             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1021         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1022 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1023         if(sideTableInfo == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1024             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1025         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1026 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1027 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1028 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1029 //        }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1030 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1031         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1032 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1033         joinScope.addScope(leftScopeChild);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1034         joinScope.addScope(rightScopeChild);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1035 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1036         HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1037 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1038         //获取两个表的所有字段</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1039         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1039         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1040         //通过join的查询字段信息过滤出需要的字段信息</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1041         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);">1041         sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1042 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1043         String leftTableAlias = joinInfo.getLeftTableAlias();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1044         Table targetTable = localTableCache.get(leftTableAlias);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1045         if(targetTable == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1046             targetTable = localTableCache.get(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1047         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1048 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1049         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1049         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1050 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1051         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1051         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1052                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1053                     return new CRow(tp2.f1, tp2.f0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1054                 }).returns(CRow.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1055 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1056 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1057         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1058         if (sideTableInfo.isPartitionedJoin()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1059             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);">1059             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1060             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1061             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1062             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));">1062             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1063         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1064 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1065         DataStream&lt;CRow&gt; dsOut = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1066         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1067             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1067             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1068         }else{</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="1069             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1069             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1070         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1071 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1072         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1073 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1074         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1075         dsOut.getTransformation().setOutputType(cRowTypeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1076 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1077         String targetTableName = joinInfo.getNewTableName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1078         String targetTableAlias = joinInfo.getNewTableAlias();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1079 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1080         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1081         replaceInfo.setMappingTable(mappingTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1082         replaceInfo.setTargetTableName(targetTableName);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1083         replaceInfo.setTargetTableAlias(targetTableAlias);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1084 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1085         if (!tableEnv.isRegistered(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1086             Table joinTable = tableEnv.fromDataStream(dsOut);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1087             tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1088             localTableCache.put(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1089         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1090     }</span>
1091 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1092     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1093                          Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1094                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1099         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1100         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1101 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1102         SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1103         if(sqlKind == AS){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1104             dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1105         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1107         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1107         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1108         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1108         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1109         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1111         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1112         rightScopeChild.setAlias(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1113         rightScopeChild.setTableName(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1114         SideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1115         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1116             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1117         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1119         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1120             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125 //        }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1128 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1129         joinScope.addScope(leftScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1130         joinScope.addScope(rightScopeChild);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1131 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1132         //获取两个表的所有字段</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1133         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1133         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1135         String leftTableAlias = joinInfo.getLeftTableAlias();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1136         Table targetTable = localTableCache.get(leftTableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1137         if(targetTable == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1138             targetTable = localTableCache.get(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1139         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1141         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1141         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1143         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1143         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1144                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1145                     return new CRow(tp2.f1, tp2.f0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1146                 }).returns(CRow.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1147 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1149         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1150         if (sideTableInfo.isPartitionedJoin()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1151             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);">1151             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1152             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1153             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1154             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));">1154             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1155         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1156 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1157         DataStream&lt;CRow&gt; dsOut = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1158         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1159             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1159             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1160         }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="1161             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1161             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1162         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1163 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1164         // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1165         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1166         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1167 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1168         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1169         dsOut.getTransformation().setOutputType(cRowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1171         String targetTableName = joinInfo.getNewTableName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1172         String targetTableAlias = joinInfo.getNewTableAlias();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1173 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1174         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1175         replaceInfo.setMappingTable(mappingTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1176         replaceInfo.setTargetTableName(targetTableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1177         replaceInfo.setTargetTableAlias(targetTableAlias);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1179         //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1180         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1181             if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1182             ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1183                 replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1184                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1185             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1186         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1187 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1188         replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1190         if (!tableEnv.isRegistered(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1191             Table joinTable = tableEnv.fromDataStream(dsOut);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1192             tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1193             localTableCache.put(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1194         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1195     }</span>
1196 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1197     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1198                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,">1198                          Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1199                          List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1200         JoinInfo joinInfo = (JoinInfo) pollObj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1201 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1202         JoinScope joinScope = new JoinScope();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1203         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1204         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1205         leftScopeChild.setTableName(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1206 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1207         SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1208         if(sqlKind == AS){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1209             dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1210         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1212         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());">1212         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1213         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());">1213         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1214         leftScopeChild.setRowTypeInfo(leftTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1216         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1217         rightScopeChild.setAlias(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1218         rightScopeChild.setTableName(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1219         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1220         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1221             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1222         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1224         if(sideTableInfo == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1225             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1226         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1227 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1228 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1229 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1230 //        }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1231 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1232         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1234         joinScope.addScope(leftScopeChild);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1235         joinScope.addScope(rightScopeChild);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1236 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1237         //获取两个表的所有字段</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1238         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);">1238         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1239 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1240         String leftTableAlias = joinInfo.getLeftTableAlias();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1241         Table targetTable = localTableCache.get(leftTableAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1242         if(targetTable == null){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1243             targetTable = localTableCache.get(joinInfo.getLeftTableName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1244         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1245 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1246         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());">1246         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1248         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)">1248         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.c🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1249                 .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1250                     return new CRow(tp2.f1, tp2.f0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1251                 }).returns(CRow.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1252 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1254         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1255         if (sideTableInfo.isPartitionedJoin()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1256             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);">1256             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1257             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1258             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1259             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));">1259             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1260         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1261 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1262         DataStream&lt;CRow&gt; dsOut = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1263         if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1264             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1264             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1265         }else{</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="1266             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);">1266             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1267         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1268 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1269         // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1270         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1271         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1273         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1274         dsOut.getTransformation().setOutputType(cRowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1275 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1276         String targetTableName = joinInfo.getNewTableName();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1277         String targetTableAlias = joinInfo.getNewTableAlias();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1278 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1279         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1280         replaceInfo.setMappingTable(mappingTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1281         replaceInfo.setTargetTableName(targetTableName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1282         replaceInfo.setTargetTableAlias(targetTableAlias);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1283 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1284         //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1285         for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1286             if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1287             ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1288                 replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1289                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1290             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1291         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1292 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1293         replaceInfoList.add(replaceInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1294 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1295         if (!tableEnv.isRegistered(joinInfo.getNewTableName())){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1296             Table joinTable = tableEnv.fromDataStream(dsOut);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1297             tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1298             localTableCache.put(joinInfo.getNewTableName(), joinTable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1299         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1300     }</span>
1301 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
1302 
1303     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
1304         String[] fieldNames = schema.getFieldNames();
1305         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
1306 
<abbr title="1307         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);">1307         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::ne🔵</abbr>
<abbr title="1308         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);">1308         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(Typ🔵</abbr>
1309         return new RowTypeInfo(projectedTypes, projectedNames);
1310     }
1311 
1312 
1313     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
1314         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
1315         String fieldsInfo = result.getFieldsInfoStr();
1316         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
1317         for (int i = 0; i &lt; fields.length; i++) {
1318             String[] filed = fields[i].split(&quot;\\s&quot;);
1319             if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){
1320                 return false;
1321             } else {
1322                 String[] filedNameArr = new String[filed.length - 1];
1323                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
1324                 String fieldName = String.join(&quot; &quot;, filedNameArr);
1325                 fieldNames.add(fieldName);
1326                 String fieldType = filed[filed.length - 1 ].trim();
1327                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
1328                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
1329                 if (fieldClass == tableField){
1330                     continue;
1331                 } else {
1332                     return false;
1333                 }
1334             }
1335         }
1336         tmpFields = String.join(&quot;,&quot;, fieldNames);
1337         return true;
1338     }
1339 
1340 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheType;
  21 import com.dtstack.flink.sql.exec.FlinkSQLExec;
  22 import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  23 import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  24 import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  25 import com.dtstack.flink.sql.util.ClassUtil;
  26 import com.dtstack.flink.sql.util.ParseUtils;
  27 import com.dtstack.flink.sql.util.TableUtils;
  28 import com.google.common.base.Preconditions;
  29 import com.google.common.collect.*;
  30 import java.sql.Timestamp;
  31 import java.util.Arrays;
  32 import java.util.Collection;
  33 import java.util.LinkedList;
  34 import java.util.List;
  35 import java.util.Map;
  36 import java.util.Queue;
  37 import java.util.Set;
  38 import org.apache.calcite.sql.SqlAsOperator;
  39 import org.apache.calcite.sql.SqlBasicCall;
  40 import org.apache.calcite.sql.SqlDataTypeSpec;
  41 import org.apache.calcite.sql.SqlIdentifier;
  42 import org.apache.calcite.sql.SqlInsert;
  43 import org.apache.calcite.sql.SqlJoin;
  44 import org.apache.calcite.sql.SqlKind;
  45 import org.apache.calcite.sql.SqlLiteral;
  46 import org.apache.calcite.sql.SqlNode;
  47 import org.apache.calcite.sql.SqlNodeList;
  48 import org.apache.calcite.sql.SqlOperator;
  49 import org.apache.calcite.sql.SqlOrderBy;
  50 import org.apache.calcite.sql.SqlSelect;
  51 import org.apache.calcite.sql.SqlWithItem;
  52 import org.apache.calcite.sql.fun.SqlCase;
  53 import org.apache.calcite.sql.parser.SqlParseException;
  54 import org.apache.calcite.sql.parser.SqlParserPos;
  55 import org.apache.commons.collections.CollectionUtils;
  56 import org.apache.commons.lang3.StringUtils;
  57 import org.apache.flink.api.common.typeinfo.TypeInformation;
  58 import org.apache.flink.api.java.tuple.Tuple2;
  59 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  60 import org.apache.flink.streaming.api.datastream.DataStream;
  61 import org.apache.flink.table.api.StreamQueryConfig;
  62 import org.apache.flink.table.api.Table;
  63 import org.apache.flink.table.api.TableSchema;
  64 import org.apache.flink.table.api.java.StreamTableEnvironment;
  65 import org.apache.flink.table.runtime.CRowKeySelector;
  66 import org.apache.flink.table.runtime.types.CRow;
  67 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  68 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  69 import org.apache.flink.types.Row;
  70 import org.slf4j.Logger;
  71 import org.slf4j.LoggerFactory;
  72 import static org.apache.calcite.sql.SqlKind.*;
  73 
  74 
  75 /**
  76  * Reason:
  77  * Date: 2018/7/24
  78  * Company: www.dtstack.com
  79  * @author xuchao
  80  */
  81 public class SideSqlExec {
  82     private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  83 
  84     private String localSqlPluginPath = null;
  85 
  86     private String tmpFields = null;
  87 
  88     private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  89 
  90     private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
  91 
<abbr title="  92     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv, Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {">  92     public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment 🔵</abbr>
  93         if (localSqlPluginPath == null) {
  94             throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
  95         }
  96         localTableCache.putAll(tableCache);
  97         try {
  98             sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
  99         } catch (java.lang.Exception e) {
 100             LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 101         }
 102         if (createView != null) {
 103             LOG.warn(&quot;create view info\n&quot;);
 104             LOG.warn(createView.getExecSql());
 105             LOG.warn(&quot;-----------------&quot;);
 106         }
 107         SideSQLParser sideSQLParser = new SideSQLParser();
 108         sideSQLParser.setLocalTableCache(localTableCache);
 109         Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());
 110         Object pollObj = null;
 111         while ((pollObj = exeQueue.poll()) != null) {
 112             if (pollObj instanceof SqlNode) {
 113                 SqlNode pollSqlNode = ((SqlNode) (pollObj));
 114                 if (pollSqlNode.getKind() == INSERT) {
 115                     FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);
 116                     if (LOG.isInfoEnabled()) {
 117                         LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());
 118                     }
 119                 } else if (pollSqlNode.getKind() == AS) {
 120                     dealAsSourceTable(tableEnv, pollSqlNode, tableCache);
 121                 } else if (pollSqlNode.getKind() == WITH_ITEM) {
 122                     SqlWithItem sqlWithItem = ((SqlWithItem) (pollSqlNode));
 123                     String TableAlias = sqlWithItem.name.toString();
 124                     Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 125                     tableEnv.registerTable(TableAlias, table);
 126                 } else if (pollSqlNode.getKind() == SELECT) {
<abbr title=" 127                     Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);"> 127                     Preconditions.checkState(createView != null, &quot;select sql must included by create view🔵</abbr>
 128                     Table table = tableEnv.sqlQuery(pollObj.toString());
 129                     if (createView.getFieldsInfoStr() == null) {
 130                         tableEnv.registerTable(createView.getTableName(), table);
 131                     } else if (checkFieldsInfo(createView, table)) {
 132                         table = table.as(tmpFields);
 133                         tableEnv.registerTable(createView.getTableName(), table);
 134                     } else {
 135                         throw new RuntimeException(&quot;Fields mismatch&quot;);
 136                     }
 137                     localTableCache.put(createView.getTableName(), table);
 138                 }
 139             } else if (pollObj instanceof JoinInfo) {
 140 
 141 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142                 System.out.println(&quot;----------exec join info----------&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143                 System.out.println(pollObj.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145 </span>
 146 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 147 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 147 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                 LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                 preIsSideJoin = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                 joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 </span>
 154 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 155             }
 156         }
 157     }
 158 
 159     /**
 160      * 解析出as查询的表和字段的关系
 161      * @param asSqlNode
 162      * @param tableCache
 163      * @return
 164      */
 165     private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache) {
 166         SqlNode info = asSqlNode.getOperands()[0];
 167         SqlNode alias = asSqlNode.getOperands()[1];
 168         SqlKind infoKind = info.getKind();
 169         if (infoKind != SELECT) {
 170             return null;
 171         }
<abbr title=" 172         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField(((SqlSelect) (info)), tableCache);"> 172         List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField(((SqlSelect) (info)), tableCache)🔵</abbr>
 173         HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 174         for (FieldInfo fieldInfo : extractFieldList) {
 175             String tableName = fieldInfo.getTable();
 176             String fieldName = fieldInfo.getFieldName();
 177             String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 178             mappingTable.put(tableName, fieldName, mappingFieldName);
 179         }
 180         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 181         replaceInfo.setMappingTable(mappingTable);
 182         replaceInfo.setTargetTableName(alias.toString());
 183         replaceInfo.setTargetTableAlias(alias.toString());
 184         return replaceInfo;
 185     }
 186 
 187     public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {
 188         SqlKind sqlKind = sqlNode.getKind();
 189         if (sqlKind != AS) {
 190             throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 191         }
 192         SqlNode info = ((SqlBasicCall) (sqlNode)).getOperands()[0];
 193         SqlNode alias = ((SqlBasicCall) (sqlNode)).getOperands()[1];
 194         AliasInfo aliasInfo = new AliasInfo();
 195         aliasInfo.setName(info.toString());
 196         aliasInfo.setAlias(alias.toString());
 197         return aliasInfo;
 198     }
 199 
<abbr title=" 200     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 200     public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, Stri🔵</abbr>
 201         TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 202         String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 203         for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 204             FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 205             String tableName = fieldInfo.getTable();
 206             String fieldName = fieldInfo.getFieldName();
 207             String mappingFieldName = mappingTable.get(tableName, fieldName);
<abbr title=" 208             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 208             Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be f🔵</abbr>
 209             sideOutTypes[i] = fieldInfo.getTypeInformation();
 210             sideOutNames[i] = mappingFieldName;
 211         }
 212         return new RowTypeInfo(sideOutTypes, sideOutNames);
 213     }
 214 
 215     /**
 216      *  对时间类型进行类型转换
 217      * @param leftTypeInfo
 218      * @return
 219      */
 220     private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 221         TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 222         TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 223         for (int i = 0; i &lt; sideOutTypes.length; i++) {
 224             sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 225         }
 226         RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 227         return rowTypeInfo;
 228     }
 229 
 230     private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 231         if (typeInformation instanceof TimeIndicatorTypeInfo) {
 232             return TypeInformation.of(Timestamp.class);
 233         }
 234         return typeInformation;
 235     }
 236 
 237     public void setLocalSqlPluginPath(String localSqlPluginPath) {
 238         this.localSqlPluginPath = localSqlPluginPath;
 239     }
 240 
<abbr title=" 241     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName) {"> 241     private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableNa🔵</abbr>
 242         Table table = localTableCache.get(tableAlias);
 243         if (table == null) {
 244             table = localTableCache.get(tableName);
 245         }
 246         if (table == null) {
 247             throw new RuntimeException(&quot;not register table &quot; + tableAlias);
 248         }
 249         return table;
 250     }
 251 
 252     /**
<abbr title=" 253      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 253      * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., d🔵</abbr>
 254      *
 255      * @return
 256      */
<abbr title=" 257     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 257     private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInf🔵</abbr>
 258         List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 259         if (CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))) {
 260             return true;
 261         }
 262         return false;
 263     }
 264 
 265     private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {
 266         List&lt;String&gt; res = Lists.newArrayList();
 267         sideTableInfo.getPrimaryKeys().forEach(( field) -&gt; {
 268             res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 269         });
 270         return res;
 271     }
 272 
<abbr title=" 273     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo) {"> 273     public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTa🔵</abbr>
 274         List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 275         ParseUtils.parseAnd(conditionNode, sqlNodeList);
 276         List&lt;String&gt; conditionFields = Lists.newArrayList();
 277         for (SqlNode sqlNode : sqlNodeList) {
 278             if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 279                 throw new RuntimeException(&quot;not compare operator.&quot;);
 280             }
 281             SqlIdentifier left = ((SqlIdentifier) (((SqlBasicCall) (sqlNode)).getOperands()[0]));
 282             SqlIdentifier right = ((SqlIdentifier) (((SqlBasicCall) (sqlNode)).getOperands()[1]));
 283             String leftTableName = left.getComponent(0).getSimple();
 284             String rightTableName = right.getComponent(0).getSimple();
 285             String tableCol = &quot;&quot;;
 286             if (leftTableName.equalsIgnoreCase(specifyTableName)) {
 287                 tableCol = left.getComponent(1).getSimple();
 288             } else if (rightTableName.equalsIgnoreCase(specifyTableName)) {
 289                 tableCol = right.getComponent(1).getSimple();
 290             } else {
<abbr title=" 291                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 291                 throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specify🔵</abbr>
 292             }
 293             tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 294             conditionFields.add(tableCol);
 295         }
 296         return conditionFields;
 297     }
 298 
<abbr title=" 299     protected void dealAsSourceTable(StreamTableEnvironment tableEnv, SqlNode pollSqlNode, Map&lt;String, Table&gt; tableCache) throws SqlParseException {"> 299     protected void dealAsSourceTable(StreamTableEnvironment tableEnv, SqlNode pollSqlNode, Map&lt;String, Ta🔵</abbr>
 300         AliasInfo aliasInfo = parseAsNode(pollSqlNode);
 301         if (localTableCache.containsKey(aliasInfo.getName())) {
 302             return;
 303         }
 304         Table table = tableEnv.sqlQuery(aliasInfo.getName());
 305         tableEnv.registerTable(aliasInfo.getAlias(), table);
 306         localTableCache.put(aliasInfo.getAlias(), table);
 307         LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 308         FieldReplaceInfo fieldReplaceInfo = parseAsQuery(((SqlBasicCall) (pollSqlNode)), tableCache);
 309         if (fieldReplaceInfo == null) {
 310             return;
 311         }
 312         // as 的源表
 313         Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 314         SqlNode fromNode = ((SqlBasicCall) (pollSqlNode)).getOperands()[0];
 315         TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 316     }
 317 
<abbr title=" 318     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv) throws Exception {"> 318     private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache, Map&lt;String, AbstractSideTabl🔵</abbr>
 319         JoinInfo joinInfo = ((JoinInfo) (pollObj));
 320         JoinScope joinScope = new JoinScope();
 321         JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 322         leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 323         leftScopeChild.setTableName(joinInfo.getLeftTableName());
<abbr title=" 324         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 324         Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLe🔵</abbr>
<abbr title=" 325         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 325         RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema(🔵</abbr>
 326         leftScopeChild.setRowTypeInfo(leftTypeInfo);
 327         JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 328         rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 329         rightScopeChild.setTableName(joinInfo.getRightTableName());
 330         AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());
 331         if (sideTableInfo == null) {
 332             sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 333         }
 334         if (sideTableInfo == null) {
 335             throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 336         }
 337 //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){
 338 //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);
 339 //        }
 340         rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 341         joinScope.addScope(leftScopeChild);
 342         joinScope.addScope(rightScopeChild);
 343         HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) (pollObj)).getTableFieldRef();
 344         // 获取两个表的所有字段
<abbr title=" 345         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 345         List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), join🔵</abbr>
 346         //通过join的查询字段信息过滤出需要的字段信息
<abbr title=" 347         sideJoinFieldInfo.removeIf(( tmpFieldInfo) -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 347         sideJoinFieldInfo.removeIf(( tmpFieldInfo) -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldI🔵</abbr>
 348         String leftTableAlias = joinInfo.getLeftTableAlias();
 349         Table targetTable = localTableCache.get(leftTableAlias);
 350         if (targetTable == null) {
 351             targetTable = localTableCache.get(joinInfo.getLeftTableName());
 352         }
<abbr title=" 353         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());"> 353         RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema(🔵</abbr>
<abbr title=" 354         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class).map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {"> 354         DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, Row.class).map((Tuple2&lt;Boole🔵</abbr>
 355             return new CRow(tp2.f1, tp2.f0);
 356         }).returns(CRow.class);
 357         //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 358         if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 359             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 359             List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTa🔵</abbr>
 360             List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 361             int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 362             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 362             adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, tar🔵</abbr>
 363         }
 364         DataStream&lt;CRow&gt; dsOut = null;
 365         if (ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())) {
<abbr title=" 366             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 366             dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), 🔵</abbr>
 367         } else {
<abbr title=" 368             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 368             dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSq🔵</abbr>
 369         }
 370         RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 371         CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);
 372         dsOut.getTransformation().setOutputType(cRowTypeInfo);
 373         String targetTableName = joinInfo.getNewTableName();
 374         String targetTableAlias = joinInfo.getNewTableAlias();
 375         FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 376         replaceInfo.setMappingTable(mappingTable);
 377         replaceInfo.setTargetTableName(targetTableName);
 378         replaceInfo.setTargetTableAlias(targetTableAlias);
 379         if (!tableEnv.isRegistered(joinInfo.getNewTableName())) {
 380             Table joinTable = tableEnv.fromDataStream(dsOut);
 381             tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);
 382             localTableCache.put(joinInfo.getNewTableName(), joinTable);
 383         }
 384     }
 385 
 386     private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 387         String[] fieldNames = schema.getFieldNames();
 388         TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 389 
<abbr title=" 390         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);"> 390         String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::ne🔵</abbr>
<abbr title=" 391         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 391         TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(Typ🔵</abbr>
 392         return new RowTypeInfo(projectedTypes, projectedNames);
 393     }
 394 
 395     private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 396         List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 397         String fieldsInfo = result.getFieldsInfoStr();
 398         String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 399         for (int i = 0; i &lt; fields.length; i++) {
 400             String[] filed = fields[i].split(&quot;\\s&quot;);
 401             if ((filed.length &lt; 2) || (fields.length != table.getSchema().getColumnNames().length)) {
 402                 return false;
 403             } else {
 404                 String[] filedNameArr = new String[filed.length - 1];
 405                 System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 406                 String fieldName = String.join(&quot; &quot;, filedNameArr);
 407                 fieldNames.add(fieldName);
 408                 String fieldType = filed[filed.length - 1].trim();
 409                 Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 410                 Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 411                 if (fieldClass == tableField) {
 412                     continue;
 413                 } else {
 414                     return false;
 415                 }
 416             }
 417         }
 418         tmpFields = String.join(&quot;,&quot;, fieldNames);
 419         return true;
 420     }
 421 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side;
  22  
  23  import org.apache.flink.api.common.typeinfo.TypeInformation;
  24  import org.apache.flink.api.java.tuple.Tuple2;
  25  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  26  import org.apache.flink.streaming.api.datastream.DataStream;
  27  import org.apache.flink.table.api.StreamQueryConfig;
  28  import org.apache.flink.table.api.Table;
  29  import org.apache.flink.table.api.TableSchema;
  30  import org.apache.flink.table.api.java.StreamTableEnvironment;
  31  import org.apache.flink.table.runtime.CRowKeySelector;
  32  import org.apache.flink.table.runtime.types.CRow;
  33  import org.apache.flink.table.runtime.types.CRowTypeInfo;
  34  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  35  import org.apache.flink.types.Row;
  36  
  37  import com.dtstack.flink.sql.enums.ECacheType;
  38  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  39  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  40  import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  41  import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  42  import com.dtstack.flink.sql.util.ClassUtil;
  43  import com.dtstack.flink.sql.util.ParseUtils;
  44  import com.dtstack.flink.sql.util.TableUtils;
  45  import com.google.common.base.Preconditions;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import com.google.common.collect.HashBasedTable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import com.google.common.collect.*;</span>
  51  import org.apache.calcite.sql.SqlAsOperator;
  52  import org.apache.calcite.sql.SqlBasicCall;
  53  import org.apache.calcite.sql.SqlDataTypeSpec;
  54  import org.apache.calcite.sql.SqlIdentifier;
  55  import org.apache.calcite.sql.SqlInsert;
  56  import org.apache.calcite.sql.SqlJoin;
  57  import org.apache.calcite.sql.SqlKind;
  58  import org.apache.calcite.sql.SqlLiteral;
  59  import org.apache.calcite.sql.SqlNode;
  60  import org.apache.calcite.sql.SqlNodeList;
  61  import org.apache.calcite.sql.SqlOperator;
  62  import org.apache.calcite.sql.SqlOrderBy;
  63  import org.apache.calcite.sql.SqlSelect;
  64  import org.apache.calcite.sql.SqlWithItem;
  65  import org.apache.calcite.sql.fun.SqlCase;
  66  import org.apache.calcite.sql.parser.SqlParseException;
  67  import org.apache.calcite.sql.parser.SqlParserPos;
  68  import org.apache.commons.collections.CollectionUtils;
  69  import org.apache.commons.lang3.StringUtils;
  70  import org.slf4j.Logger;
  71  import org.slf4j.LoggerFactory;
  72  
  73  import java.sql.Timestamp;
  74  import java.util.Arrays;
  75  import java.util.Collection;
  76  import java.util.LinkedList;
  77  import java.util.List;
  78  import java.util.Map;
  79  import java.util.Queue;
  80  import java.util.Set;
  81  
  82  import static org.apache.calcite.sql.SqlKind.*;
  83  
  84  /**
  85   * Reason:
  86   * Date: 2018/7/24
  87   * Company: www.dtstack.com
  88   * @author xuchao
  89   */
  90  
  91  public class SideSqlExec {
  92  
  93      private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  94  
  95      private String localSqlPluginPath = null;
  96  
  97      private String tmpFields = null;
  98  
  99      private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
 100  
 101      private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
 102  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    public void exec(String sql, Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 104 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 104 -                     Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserR🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    public void exec(String sql,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                     Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                     StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                     Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                     StreamQueryConfig queryConfig,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                     CreateTmpTableParser.SqlParserResult createView) throws Exception {</span>
 111          if(localSqlPluginPath == null){
 112              throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 113          }
 114  
 115          localTableCache.putAll(tableCache);
 116          try {
 117              sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 118          } catch (Exception e) {
 119              LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 120          }
 121  
 122          if(createView != null){
 123              LOG.warn(&quot;create view info\n&quot;);
 124              LOG.warn(createView.getExecSql());
 125              LOG.warn(&quot;-----------------&quot;);
 126          }
 127  
 128          SideSQLParser sideSQLParser = new SideSQLParser();
 129          sideSQLParser.setLocalTableCache(localTableCache);
 130          Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());
 131          Object pollObj = null;
 132  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        //need clean</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        boolean preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -</span>
 137          while((pollObj = exeQueue.poll()) != null){
 138  
 139              if(pollObj instanceof SqlNode){
 140                  SqlNode pollSqlNode = (SqlNode) pollObj;
 141  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                if(preIsSideJoin){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                    preIsSideJoin = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                    List&lt;String&gt; fieldNames = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -                    for(FieldReplaceInfo replaceInfo : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                        fieldNames = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                        replaceFieldName(pollSqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                        addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -                }</span>
 151  
 152                  if(pollSqlNode.getKind() == INSERT){
 153                      System.out.println(&quot;----------real exec sql-----------&quot; );
 154                      System.out.println(pollSqlNode.toString());
 155                      FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);
 156                      if(LOG.isInfoEnabled()){
 157                          LOG.info(&quot;exec sql: &quot; + pollSqlNode.toString());

 158                      }
 159  
 160                  }else if(pollSqlNode.getKind() == AS){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                    dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                    dealAsSourceTable(tableEnv, pollSqlNode, tableCache);</span>
 163  
 164                  } else if (pollSqlNode.getKind() == WITH_ITEM) {
 165                      SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 166                      String TableAlias = sqlWithItem.name.toString();
 167                      Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 168                      tableEnv.registerTable(TableAlias, table);
 169  
 170                  } else if (pollSqlNode.getKind() == SELECT){
 171                      Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);
 172                      Table table = tableEnv.sqlQuery(pollObj.toString());
 173  
 174                      if (createView.getFieldsInfoStr() == null){
 175                          tableEnv.registerTable(createView.getTableName(), table);
 176                      } else {
 177                          if (checkFieldsInfo(createView, table)){
 178                              table = table.as(tmpFields);
 179                              tableEnv.registerTable(createView.getTableName(), table);
 180                          } else {
 181                              throw new RuntimeException(&quot;Fields mismatch&quot;);
 182                          }
 183                      }
 184  
 185                      localTableCache.put(createView.getTableName(), table);
 186                  }
 187  
 188              }else if (pollObj instanceof JoinInfo){
 189                  System.out.println(&quot;----------exec join info----------&quot;);
 190                  System.out.println(pollObj.toString());

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                preIsSideJoin = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                joinFun(pollObj, localTableCache, sideTableMap, tableEnv);</span>
 194              }
 195          }
 196  
 197      }
 198  
 199  
 200      /**
 201       * 解析出as查询的表和字段的关系
 202       * @param asSqlNode
 203       * @param tableCache
 204       * @return
 205       */
 206      private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 207          SqlNode info = asSqlNode.getOperands()[0];
 208          SqlNode alias = asSqlNode.getOperands()[1];
 209  
 210          SqlKind infoKind = info.getKind();
 211          if(infoKind != SELECT){
 212              return null;
 213          }
 214  
 215          List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 216  
 217          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 218          for (FieldInfo fieldInfo : extractFieldList) {
 219              String tableName = fieldInfo.getTable();
 220              String fieldName = fieldInfo.getFieldName();
 221              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 222              mappingTable.put(tableName, fieldName, mappingFieldName);
 223          }
 224  
 225          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 226          replaceInfo.setMappingTable(mappingTable);
 227          replaceInfo.setTargetTableName(alias.toString());
 228          replaceInfo.setTargetTableAlias(alias.toString());
 229          return replaceInfo;
 230      }
 231  
 232  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -     * 添加字段别名</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -     * @param pollSqlNode</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -     * @param fieldList</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -     * @param mappingTable</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 239 -    private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 239 -    private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -        SqlKind sqlKind = pollSqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -        switch (sqlKind) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -            case INSERT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                SqlNode source = ((SqlInsert) pollSqlNode).getSource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -                addAliasForFieldNode(source, fieldList, mappingTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                selectList.getList().forEach(node -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                    if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                        if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -                            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -                        // save real field</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                        String fieldName = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 259 -                        if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 259 -                        if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().contai🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                            fieldList.add(fieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                for (int i = 0; i &lt; selectList.getList().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                    SqlNode node = selectList.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                    if (node.getKind() == IDENTIFIER) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                        SqlIdentifier sqlIdentifier = (SqlIdentifier) node;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                        if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                        String name = sqlIdentifier.names.get(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                        // avoid real field pv0 convert pv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 274 -                        if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 274 -                        if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -                            SqlOperator operator = new SqlAsOperator();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -                            SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 278 -                            SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 278 -                            SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() -🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -                            SqlNode[] sqlNodes = new SqlNode[2];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -                            sqlNodes[0] = sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -                            sqlNodes[1] = sqlIdentifierAlias;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -                            SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                            selectList.set(i, sqlBasicCall);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -</span>
 293      public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {







 294          SqlKind sqlKind = sqlNode.getKind();
 295          if(sqlKind != AS){
 296              throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 297          }
 298  
 299          SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 300          SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 301  
 302          AliasInfo aliasInfo = new AliasInfo();
 303          aliasInfo.setName(info.toString());
 304          aliasInfo.setAlias(alias.toString());
 305  
 306          return aliasInfo;
 307      }
 308  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 309 -    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 309 -    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, Strin🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +    public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +                                           HashBasedTable&lt;String, String, String&gt; mappingTable) {</span>
 312          TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 313          String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 314          for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 315              FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 316              String tableName = fieldInfo.getTable();
 317              String fieldName = fieldInfo.getFieldName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -            String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -            mappingTable.put(tableName, fieldName, mappingFieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +            String mappingFieldName = mappingTable.get(tableName, fieldName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 322 +            Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;);"> 322 +            Preconditions.checkNotNull(mappingFieldName, fieldInfo + &quot; not mapping any field! it may be frame bug&quot;🔵</abbr></span>
 323  
 324              sideOutTypes[i] = fieldInfo.getTypeInformation();
 325              sideOutNames[i] = mappingFieldName;
 326          }
 327          return new RowTypeInfo(sideOutTypes, sideOutNames);
 328      }
 329  
 330  
 331  
 332      /**
 333       *  对时间类型进行类型转换
 334       * @param leftTypeInfo
 335       * @return
 336       */
 337      private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 338          TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 339          TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 340          for (int i = 0; i &lt; sideOutTypes.length; i++) {
 341              sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 342          }
 343          RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 344          return rowTypeInfo;
 345      }
 346  
 347      private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 348          if (typeInformation instanceof TimeIndicatorTypeInfo) {
 349              return TypeInformation.of(Timestamp.class);
 350          }
 351          return typeInformation;
 352      }
 353  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -    //需要考虑更多的情况</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -    private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -        SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -        switch (sqlKind) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -            case INSERT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -                SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -                replaceFieldName(sqlSource, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -                SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -                replaceFieldName(asNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 367 -                SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 367 -                SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -                if(sqlSelect == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -                SqlNode sqlSource1 = sqlSelect.getFrom();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -                if(sqlSource1.getKind() == AS){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -                    String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -                    if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -                        SqlNodeList sqlSelectList = sqlSelect.getSelectList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -                        SqlNode whereNode = sqlSelect.getWhere();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -                        SqlNodeList sqlGroup = sqlSelect.getGroup();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -                        //TODO 暂时不处理having</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -                        SqlNode sqlHaving = sqlSelect.getHaving();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -                        List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -                        for( int i=0; i&lt;sqlSelectList.getList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -                            SqlNode selectNode = sqlSelectList.getList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -                            //特殊处理 isStar的标识</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -                            if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 388 -                                List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 388 -                                List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -                                newSelectNodeList.addAll(replaceNodeList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -                                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -                            SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -                            if(replaceNode == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -                                continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -                            //sqlSelectList.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -                            newSelectNodeList.add(replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 402 -                        SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 402 -                        SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosi🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -                        sqlSelect.setSelectList(newSelectList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -                        //where</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -                        if(whereNode != null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -                            SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -                            for(int i =0; i&lt;sqlNodeList.length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -                                SqlNode whereSqlNode = sqlNodeList[i];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -                                SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -                                sqlNodeList[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -                        if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -                            for( int i=0; i&lt;sqlGroup.getList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -                                SqlNode selectNode = sqlGroup.getList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -                                SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -                                sqlGroup.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -                    //TODO</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -                    System.out.println(sqlNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -                    throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -            case UNION:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -                SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -                SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -                replaceFieldName(unionLeft, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -                replaceFieldName(unionRight, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -            case ORDER_BY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -                SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -                replaceFieldName(sqlOrderBy.query, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -                SqlNodeList orderFiledList = sqlOrderBy.orderList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -                for (int i=0 ;i&lt;orderFiledList.size();i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 441 -                    SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 441 -                    SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -                    orderFiledList.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -            default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -    private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -        if(orderNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -            if (sqlIdentifier.names.size() == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -                return orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -            return sqlIdentifier.setName(0, tableAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -        } else if (orderNode instanceof  SqlBasicCall) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -            for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -                SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -                sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -            return sqlBasicCall;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -            return orderNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -    private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -        if(groupNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -            if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -                return sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 476 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 476 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -            if(mappingFieldName == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -                throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -            sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -            return sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -        }else if(groupNode instanceof  SqlBasicCall){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -            for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -                SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -                SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -                sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -            return sqlBasicCall;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -            return groupNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -    public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -        SqlKind sqlKind = sqlNode.getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -        switch (sqlKind){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -            case SELECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -                SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -                if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -                    if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -                        return sqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -                        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -                    return filterNodeWithTargetName(fromNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -            case AS:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -                SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -                return filterNodeWithTargetName(childNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -            case JOIN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -                SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -                SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -                SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -                SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -                if(leftReturnNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -                    return leftReturnNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -                }else if(rightReturnNode != null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -                    return rightReturnNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -                }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -                    return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -                }</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 532 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +</span>
 535  
 536  
 537      public void setLocalSqlPluginPath(String localSqlPluginPath) {
 538          this.localSqlPluginPath = localSqlPluginPath;
 539      }
 540  
 541      private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){
 542          Table table = localTableCache.get(tableAlias);
 543          if(table == null){
 544              table = localTableCache.get(tableName);
 545          }
 546  
 547          if(table == null){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -            throw new RuntimeException(&quot;not register table &quot; + tableName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 549 +            throw new RuntimeException(&quot;not register table &quot; + tableAlias);</span>
 550          }
 551  
 552          return table;
 553      }
 554  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -    private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -        SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -        List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -        if(sqlIdentifier.isStar()){//处理 [* or table.*]</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -            int identifierSize = sqlIdentifier.names.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -            Collection&lt;String&gt; columns = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -            if(identifierSize == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -                columns = replaceInfo.getMappingTable().values();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -            }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -                columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -            for(String colAlias : columns){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -                SqlParserPos sqlParserPos = new SqlParserPos(0, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -                List&lt;String&gt; columnInfo = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -                columnInfo.add(replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -                columnInfo.add(colAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -                SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -                sqlNodes.add(sqlIdentifierAlias);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -            return sqlNodes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 577 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -            throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -    private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -        if (selectNode.getKind() == AS) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -            SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -            SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -            if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -                ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 591 -        }else if(selectNode.getKind() == IDENTIFIER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 592 -            SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 593 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 594 -            if(sqlIdentifier.names.size() == 1){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 595 -                return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 596 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 597 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 598 -            //Same level mappingTable</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 599 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 599 -            String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 600 -            if (mappingFieldName == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 601 -                throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 602 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 603 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 604 -            sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 605 -            sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 606 -            return sqlIdentifier;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 607 -        }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 608 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 609 -        }else if(  AGGREGATE.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 610 -                || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 611 -                || COMPARISON.contains(selectNode.getKind())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 612 -                || selectNode.getKind() == OTHER_FUNCTION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -                || selectNode.getKind() == DIVIDE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -                || selectNode.getKind() == CAST</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -                || selectNode.getKind() == TRIM</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -                || selectNode.getKind() == TIMES</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -                || selectNode.getKind() == PLUS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -                || selectNode.getKind() == NOT_IN</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 619 -                || selectNode.getKind() == OR</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 620 -                || selectNode.getKind() == AND</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 621 -                || selectNode.getKind() == MINUS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 622 -                || selectNode.getKind() == TUMBLE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 623 -                || selectNode.getKind() == TUMBLE_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 624 -                || selectNode.getKind() == TUMBLE_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 625 -                || selectNode.getKind() == SESSION</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 626 -                || selectNode.getKind() == SESSION_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 627 -                || selectNode.getKind() == SESSION_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 628 -                || selectNode.getKind() == HOP</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 629 -                || selectNode.getKind() == HOP_START</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 630 -                || selectNode.getKind() == HOP_END</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 631 -                || selectNode.getKind() == BETWEEN</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 632 -                || selectNode.getKind() == IS_NULL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -                || selectNode.getKind() == IS_NOT_NULL</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -                || selectNode.getKind() == CONTAINS</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -                || selectNode.getKind() == TIMESTAMP_ADD</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 636 -                || selectNode.getKind() == TIMESTAMP_DIFF</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -                || selectNode.getKind() == LIKE</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 638 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -                ){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -            SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -            for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -                SqlNode sqlNode = sqlBasicCall.getOperands()[i];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -                if(sqlNode instanceof SqlLiteral){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -                if(sqlNode instanceof SqlDataTypeSpec){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -                SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -                if(replaceNode == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -                    continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -                sqlBasicCall.getOperands()[i] = replaceNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 660 -        }else if(selectNode.getKind() == CASE){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 661 -            System.out.println(&quot;selectNode&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 662 -            SqlCase sqlCase = (SqlCase) selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 663 -            SqlNodeList whenOperands = sqlCase.getWhenOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -            SqlNodeList thenOperands = sqlCase.getThenOperands();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -            SqlNode elseNode = sqlCase.getElseOperand();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 667 -            for(int i=0; i&lt;whenOperands.size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 668 -                SqlNode oneOperand = whenOperands.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 669 -                SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 670 -                if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 671 -                    whenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 672 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 673 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 674 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 675 -            for(int i=0; i&lt;thenOperands.size(); i++){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 676 -                SqlNode oneOperand = thenOperands.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 677 -                SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 678 -                if (replaceNode != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 679 -                    thenOperands.set(i, replaceNode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 680 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 681 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 682 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -            ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 684 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 685 -        }else if(selectNode.getKind() == OTHER){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 686 -            //不处理</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 687 -            return selectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 688 -        }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 689 -            throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 689 -            throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNod🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 690 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 691 -    }</span>
 692  
 693      /**
<abbr title=" 694       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 694       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension 🔵</abbr>
 695       *
 696       * @return
 697       */
<abbr title=" 698      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTableInfo) {"> 698      private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTableInfo) 🔵</abbr>

 699          List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 700          if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 701              return true;
 702          }
 703          return false;
 704      }
 705  
 706      private List&lt;String&gt; convertPrimaryAlias(SideTableInfo sideTableInfo) {

 707          List&lt;String&gt; res = Lists.newArrayList();
 708          sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 709              res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 710          });
 711          return res;
 712      }
 713  
<abbr title=" 714      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo sideTableInfo){"> 714      public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo sideTable🔵</abbr>

 715          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 716          ParseUtils.parseAnd(conditionNode, sqlNodeList);
 717          List&lt;String&gt; conditionFields = Lists.newArrayList();
 718          for(SqlNode sqlNode : sqlNodeList){
 719              if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 720                  throw new RuntimeException(&quot;not compare operator.&quot;);
 721              }
 722  
 723              SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 724              SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 725  
 726              String leftTableName = left.getComponent(0).getSimple();
 727              String rightTableName = right.getComponent(0).getSimple();
 728  
 729              String tableCol = &quot;&quot;;
 730              if(leftTableName.equalsIgnoreCase(specifyTableName)){
 731                  tableCol = left.getComponent(1).getSimple();
 732              }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 733                  tableCol = right.getComponent(1).getSimple();
 734              }else{
<abbr title=" 735                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 735                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName🔵</abbr>
 736              }
 737              tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 738              conditionFields.add(tableCol);
 739          }
 740  
 741          return conditionFields;
 742      }
 743  
 744      protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 745                                       SqlNode pollSqlNode,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -                                     Map&lt;String, Table&gt; tableCache,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 747 -                                     List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 748 +                                     Map&lt;String, Table&gt; tableCache) throws SqlParseException {</span>
 749  
 750          AliasInfo aliasInfo = parseASNode(pollSqlNode);

 751          if (localTableCache.containsKey(aliasInfo.getName())) {
 752              return;
 753          }
 754  
 755          Table table = tableEnv.sqlQuery(aliasInfo.getName());
 756          tableEnv.registerTable(aliasInfo.getAlias(), table);
 757          localTableCache.put(aliasInfo.getAlias(), table);
 758  
 759          LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 760  
 761          FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 762          if(fieldReplaceInfo == null){
 763             return;
 764          }
 765  
 766          //as 的源表
 767          Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 768          SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 769          TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -        for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -            if(fromTableNameSet.contains(tmp.getTargetTableName())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -                    || fromTableNameSet.contains(tmp.getTargetTableAlias())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -                fieldReplaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 774 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 775 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -        replaceInfoList.add(fieldReplaceInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -    private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -                         Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -                         List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 783 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 784 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 785 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 786 +    private void joinFun(Object pollObj,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 787 +                         Map&lt;String, Table&gt; localTableCache,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 788 +                         Map&lt;String, SideTableInfo&gt; sideTableMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 789 +                         StreamTableEnvironment tableEnv) throws Exception{</span>
 790          JoinInfo joinInfo = (JoinInfo) pollObj;
 791  
 792          JoinScope joinScope = new JoinScope();
 793          JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 794          leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 795          leftScopeChild.setTableName(joinInfo.getLeftTableName());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 796 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 797 -        SqlKind sqlKind = joinInfo.getLeftNode().getKind();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 798 -        if(sqlKind == AS){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 799 -            dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -        }</span>
 801  
<abbr title=" 802          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 802          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableNa🔵</abbr>
<abbr title=" 803          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 803          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColu🔵</abbr>
 804          leftScopeChild.setRowTypeInfo(leftTypeInfo);
 805  
 806          JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 807          rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 808          rightScopeChild.setTableName(joinInfo.getRightTableName());
 809          SideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());

 810          if(sideTableInfo == null){
 811              sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 812          }
 813  
 814          if(sideTableInfo == null){
 815              throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 816          }
 817  
 818  //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){
 819  //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);
 820  //        }
 821  
 822          rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 823  
 824          joinScope.addScope(leftScopeChild);
 825          joinScope.addScope(rightScopeChild);
 826  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 827 +        HashBasedTable&lt;String, String, String&gt; mappingTable = ((JoinInfo) pollObj).getTableFieldRef();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 828 +</span>
 829          //获取两个表的所有字段
<abbr title=" 830          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 830          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, tr🔵</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 831 +        //通过join的查询字段信息过滤出需要的字段信息</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 832 +        sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getFieldName()) == null);"> 832 +        sideJoinFieldInfo.removeIf(tmpFieldInfo -&gt; mappingTable.get(tmpFieldInfo.getTable(), tmpFieldInfo.getField🔵</abbr></span>
 833  
 834          String leftTableAlias = joinInfo.getLeftTableAlias();
 835          Table targetTable = localTableCache.get(leftTableAlias);
 836          if(targetTable == null){
 837              targetTable = localTableCache.get(joinInfo.getLeftTableName());
 838          }
 839  
<abbr title=" 840          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());"> 840          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColu🔵</abbr>
 841  
 842          DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)
 843                  .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {
 844                      return new CRow(tp2.f1, tp2.f0);
 845                  }).returns(CRow.class);
 846  
 847  
 848          //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 849          if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 850              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 850              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(🔵</abbr>
 851              List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 852              int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 853              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 853              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.🔵</abbr>
 854          }
 855  
 856          DataStream&lt;CRow&gt; dsOut = null;
 857          if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 858              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 858              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlP🔵</abbr>
 859          }else{
<abbr title=" 860              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 860              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPa🔵</abbr>
 861          }
 862  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 863 -        // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 864 -        HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();</span>
 865          RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 866  
 867          CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);
 868          dsOut.getTransformation().setOutputType(cRowTypeInfo);
 869  
 870          String targetTableName = joinInfo.getNewTableName();
 871          String targetTableAlias = joinInfo.getNewTableAlias();
 872  
 873          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 874          replaceInfo.setMappingTable(mappingTable);
 875          replaceInfo.setTargetTableName(targetTableName);
 876          replaceInfo.setTargetTableAlias(targetTableAlias);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 877 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 878 -        //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 879 -        for(FieldReplaceInfo tmp : replaceInfoList){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 880 -            if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 881 -            ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 882 -                replaceInfo.setPreNode(tmp);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 883 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 884 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 885 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 886 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 887 -        replaceInfoList.add(replaceInfo);</span>
 888  
 889          if (!tableEnv.isRegistered(joinInfo.getNewTableName())){
 890              Table joinTable = tableEnv.fromDataStream(dsOut);
 891              tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);
 892              localTableCache.put(joinInfo.getNewTableName(), joinTable);
 893          }
 894      }
 895  
 896      private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 897          String[] fieldNames = schema.getFieldNames();
 898          TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 899  
 900          String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);
<abbr title=" 901          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 901          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformat🔵</abbr>
 902          return new RowTypeInfo(projectedTypes, projectedNames);
 903      }
 904  
 905  
 906      private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 907          List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 908          String fieldsInfo = result.getFieldsInfoStr();
 909          String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 910          for (int i = 0; i &lt; fields.length; i++) {
 911              String[] filed = fields[i].split(&quot;\\s&quot;);
 912              if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){
 913                  return false;
 914              } else {
 915                  String[] filedNameArr = new String[filed.length - 1];
 916                  System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 917                  String fieldName = String.join(&quot; &quot;, filedNameArr);
 918                  fieldNames.add(fieldName);
 919                  String fieldType = filed[filed.length - 1 ].trim();
 920                  Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 921                  Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 922                  if (fieldClass == tableField){
 923                      continue;
 924                  } else {
 925                      return false;
 926                  }
 927              }
 928          }
 929          tmpFields = String.join(&quot;,&quot;, fieldNames);
 930          return true;
 931      }
 932  
 933  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side;
  22  
  23  import org.apache.flink.api.common.typeinfo.TypeInformation;
  24  import org.apache.flink.api.java.tuple.Tuple2;
  25  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  26  import org.apache.flink.streaming.api.datastream.DataStream;
  27  import org.apache.flink.table.api.StreamQueryConfig;
  28  import org.apache.flink.table.api.Table;
  29  import org.apache.flink.table.api.TableSchema;
  30  import org.apache.flink.table.api.java.StreamTableEnvironment;
  31  import org.apache.flink.table.runtime.CRowKeySelector;
  32  import org.apache.flink.table.runtime.types.CRow;
  33  import org.apache.flink.table.runtime.types.CRowTypeInfo;
  34  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  35  import org.apache.flink.types.Row;
  36  
  37  import com.dtstack.flink.sql.enums.ECacheType;
  38  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  39  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  40  import com.dtstack.flink.sql.side.operator.SideAsyncOperator;
  41  import com.dtstack.flink.sql.side.operator.SideWithAllCacheOperator;
  42  import com.dtstack.flink.sql.util.ClassUtil;
  43  import com.dtstack.flink.sql.util.ParseUtils;
  44  import com.dtstack.flink.sql.util.TableUtils;
  45  import com.google.common.base.Preconditions;
  46  import com.google.common.collect.HashBasedTable;
  47  import com.google.common.collect.Lists;
  48  import com.google.common.collect.Maps;
  49  import com.google.common.collect.Sets;

  50  import org.apache.calcite.sql.SqlAsOperator;
  51  import org.apache.calcite.sql.SqlBasicCall;
  52  import org.apache.calcite.sql.SqlDataTypeSpec;
  53  import org.apache.calcite.sql.SqlIdentifier;
  54  import org.apache.calcite.sql.SqlInsert;
  55  import org.apache.calcite.sql.SqlJoin;
  56  import org.apache.calcite.sql.SqlKind;
  57  import org.apache.calcite.sql.SqlLiteral;
  58  import org.apache.calcite.sql.SqlNode;
  59  import org.apache.calcite.sql.SqlNodeList;
  60  import org.apache.calcite.sql.SqlOperator;
  61  import org.apache.calcite.sql.SqlOrderBy;
  62  import org.apache.calcite.sql.SqlSelect;
  63  import org.apache.calcite.sql.SqlWithItem;
  64  import org.apache.calcite.sql.fun.SqlCase;
  65  import org.apache.calcite.sql.parser.SqlParseException;
  66  import org.apache.calcite.sql.parser.SqlParserPos;
  67  import org.apache.commons.collections.CollectionUtils;
  68  import org.apache.commons.lang3.StringUtils;
  69  import org.slf4j.Logger;
  70  import org.slf4j.LoggerFactory;
  71  
  72  import java.sql.Timestamp;
  73  import java.util.Arrays;
  74  import java.util.Collection;
  75  import java.util.LinkedList;
  76  import java.util.List;
  77  import java.util.Map;
  78  import java.util.Queue;
  79  import java.util.Set;
  80  
  81  import static org.apache.calcite.sql.SqlKind.*;
  82  
  83  /**
  84   * Reason:
  85   * Date: 2018/7/24
  86   * Company: www.dtstack.com
  87   * @author xuchao
  88   */
  89  
  90  public class SideSqlExec {
  91  
  92      private static final Logger LOG = LoggerFactory.getLogger(SideSqlExec.class);
  93  
  94      private String localSqlPluginPath = null;
  95  
  96      private String tmpFields = null;
  97  
  98      private SidePredicatesParser sidePredicatesParser = new SidePredicatesParser();
  99  
 100      private Map&lt;String, Table&gt; localTableCache = Maps.newHashMap();
 101  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    public void exec(String sql, Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    public void exec(String sql, Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<abbr title=" 104                       Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserResult createView) throws Exception {"> 104                       Map&lt;String, Table&gt; tableCache, StreamQueryConfig queryConfig, CreateTmpTableParser.SqlParserR🔵</abbr>






 105          if(localSqlPluginPath == null){
 106              throw new RuntimeException(&quot;need to set localSqlPluginPath&quot;);
 107          }
 108  
 109          localTableCache.putAll(tableCache);
 110          try {
 111              sidePredicatesParser.fillPredicatesForSideTable(sql, sideTableMap);
 112          } catch (Exception e) {
 113              LOG.error(&quot;fill predicates for sideTable fail &quot;, e);
 114          }
 115  
 116          if(createView != null){
 117              LOG.warn(&quot;create view info\n&quot;);
 118              LOG.warn(createView.getExecSql());
 119              LOG.warn(&quot;-----------------&quot;);
 120          }
 121  
 122          SideSQLParser sideSQLParser = new SideSQLParser();
 123          sideSQLParser.setLocalTableCache(localTableCache);
 124          Queue&lt;Object&gt; exeQueue = sideSQLParser.getExeQueue(sql, sideTableMap.keySet());
 125          Object pollObj = null;
 126  
 127          //need clean
 128          boolean preIsSideJoin = false;
 129          List&lt;FieldReplaceInfo&gt; replaceInfoList = Lists.newArrayList();
 130  
 131          while((pollObj = exeQueue.poll()) != null){
 132  
 133              if(pollObj instanceof SqlNode){
 134                  SqlNode pollSqlNode = (SqlNode) pollObj;
 135  
 136                  if(preIsSideJoin){
 137                      preIsSideJoin = false;
 138                      List&lt;String&gt; fieldNames = null;
 139                      for(FieldReplaceInfo replaceInfo : replaceInfoList){
 140                          fieldNames = Lists.newArrayList();
 141                          replaceFieldName(pollSqlNode, replaceInfo);
 142                          addAliasForFieldNode(pollSqlNode, fieldNames, replaceInfo.getMappingTable());
 143                      }
 144                  }
 145  
 146                  if(pollSqlNode.getKind() == INSERT){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -                    System.out.println(&quot;----------real exec sql-----------&quot; );</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                    System.out.println(pollSqlNode.toString());</span>
 149                      FlinkSQLExec.sqlUpdate(tableEnv, pollSqlNode.toString(), queryConfig);
 150                      if(LOG.isInfoEnabled()){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                        LOG.info(&quot;exec sql: &quot; + pollSqlNode.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                        LOG.info(&quot;----------real exec sql-----------\n{}&quot;, pollSqlNode.toString());</span>
 153                      }
 154  
 155                  }else if(pollSqlNode.getKind() == AS){
 156                      dealAsSourceTable(tableEnv, pollSqlNode, tableCache, replaceInfoList);

 157  
 158                  } else if (pollSqlNode.getKind() == WITH_ITEM) {
 159                      SqlWithItem sqlWithItem = (SqlWithItem) pollSqlNode;
 160                      String TableAlias = sqlWithItem.name.toString();
 161                      Table table = tableEnv.sqlQuery(sqlWithItem.query.toString());
 162                      tableEnv.registerTable(TableAlias, table);
 163  
 164                  } else if (pollSqlNode.getKind() == SELECT){
 165                      Preconditions.checkState(createView != null, &quot;select sql must included by create view&quot;);
 166                      Table table = tableEnv.sqlQuery(pollObj.toString());
 167  
 168                      if (createView.getFieldsInfoStr() == null){
 169                          tableEnv.registerTable(createView.getTableName(), table);
 170                      } else {
 171                          if (checkFieldsInfo(createView, table)){
 172                              table = table.as(tmpFields);
 173                              tableEnv.registerTable(createView.getTableName(), table);
 174                          } else {
 175                              throw new RuntimeException(&quot;Fields mismatch&quot;);
 176                          }
 177                      }
 178  
 179                      localTableCache.put(createView.getTableName(), table);
 180                  }
 181  
 182              }else if (pollObj instanceof JoinInfo){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                System.out.println(&quot;----------exec join info----------&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                System.out.println(pollObj.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +                LOG.info(&quot;----------exec join info----------\n{}&quot;, pollObj.toString());</span>
 186                  preIsSideJoin = true;
 187                  joinFun(pollObj, localTableCache, sideTableMap, tableEnv, replaceInfoList);

 188              }
 189          }
 190  
 191      }
 192  
 193  
 194      /**
 195       * 解析出as查询的表和字段的关系
 196       * @param asSqlNode
 197       * @param tableCache
 198       * @return
 199       */
 200      private FieldReplaceInfo parseAsQuery(SqlBasicCall asSqlNode, Map&lt;String, Table&gt; tableCache){
 201          SqlNode info = asSqlNode.getOperands()[0];
 202          SqlNode alias = asSqlNode.getOperands()[1];
 203  
 204          SqlKind infoKind = info.getKind();
 205          if(infoKind != SELECT){
 206              return null;
 207          }
 208  
 209          List&lt;FieldInfo&gt; extractFieldList = TableUtils.parserSelectField((SqlSelect) info, tableCache);
 210  
 211          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 212          for (FieldInfo fieldInfo : extractFieldList) {
 213              String tableName = fieldInfo.getTable();
 214              String fieldName = fieldInfo.getFieldName();
 215              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 216              mappingTable.put(tableName, fieldName, mappingFieldName);
 217          }
 218  
 219          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 220          replaceInfo.setMappingTable(mappingTable);
 221          replaceInfo.setTargetTableName(alias.toString());
 222          replaceInfo.setTargetTableAlias(alias.toString());
 223          return replaceInfo;
 224      }
 225  
 226  
 227      /**
 228       * 添加字段别名
 229       * @param pollSqlNode
 230       * @param fieldList
 231       * @param mappingTable
 232       */
<abbr title=" 233      private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 233      private void addAliasForFieldNode(SqlNode pollSqlNode, List&lt;String&gt; fieldList, HashBasedTable&lt;String, String, 🔵</abbr>
 234          SqlKind sqlKind = pollSqlNode.getKind();
 235          switch (sqlKind) {
 236              case INSERT:
 237                  SqlNode source = ((SqlInsert) pollSqlNode).getSource();
 238                  addAliasForFieldNode(source, fieldList, mappingTable);
 239                  break;
 240              case AS:
 241                  addAliasForFieldNode(((SqlBasicCall) pollSqlNode).getOperands()[0], fieldList, mappingTable);
 242                  break;
 243              case SELECT:
 244                  SqlNodeList selectList = ((SqlSelect) pollSqlNode).getSelectList();
 245                  selectList.getList().forEach(node -&gt; {
 246                      if (node.getKind() == IDENTIFIER) {
 247                          SqlIdentifier sqlIdentifier = (SqlIdentifier) node;
 248                          if (sqlIdentifier.names.size() == 1) {
 249                              return;
 250                          }
 251                          // save real field
 252                          String fieldName = sqlIdentifier.names.get(1);
<abbr title=" 253                          if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().containsKey(fieldName)) {"> 253                          if (!fieldName.endsWith(&quot;0&quot;) || fieldName.endsWith(&quot;0&quot;) &amp;&amp; mappingTable.columnMap().contai🔵</abbr>
 254                              fieldList.add(fieldName);
 255                          }
 256  
 257                      }
 258                  });
 259                  for (int i = 0; i &lt; selectList.getList().size(); i++) {
 260                      SqlNode node = selectList.get(i);
 261                      if (node.getKind() == IDENTIFIER) {
 262                          SqlIdentifier sqlIdentifier = (SqlIdentifier) node;
 263                          if (sqlIdentifier.names.size() == 1) {
 264                              return;
 265                          }
 266                          String name = sqlIdentifier.names.get(1);
 267                          // avoid real field pv0 convert pv
<abbr title=" 268                          if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring(0, name.length() - 1))) {"> 268                          if (name.endsWith(&quot;0&quot;) &amp;&amp;  !fieldList.contains(name) &amp;&amp; !fieldList.contains(name.substring🔵</abbr>
 269                              SqlOperator operator = new SqlAsOperator();
 270                              SqlParserPos sqlParserPos = new SqlParserPos(0, 0);
 271  
<abbr title=" 272                              SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() - 1), null, sqlParserPos);"> 272                              SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(name.substring(0, name.length() -🔵</abbr>
 273                              SqlNode[] sqlNodes = new SqlNode[2];
 274                              sqlNodes[0] = sqlIdentifier;
 275                              sqlNodes[1] = sqlIdentifierAlias;
 276                              SqlBasicCall sqlBasicCall = new SqlBasicCall(operator, sqlNodes, sqlParserPos);
 277  
 278                              selectList.set(i, sqlBasicCall);
 279                          }
 280                      }
 281                  }
 282                  break;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -    public AliasInfo parseASNode(SqlNode sqlNode) throws SqlParseException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +    public AliasInfo parseAsNode(SqlNode sqlNode) throws SqlParseException {</span>
 295          SqlKind sqlKind = sqlNode.getKind();
 296          if(sqlKind != AS){
 297              throw new RuntimeException(sqlNode + &quot; is not &#x27;as&#x27; operator&quot;);
 298          }
 299  
 300          SqlNode info = ((SqlBasicCall)sqlNode).getOperands()[0];
 301          SqlNode alias = ((SqlBasicCall) sqlNode).getOperands()[1];
 302  
 303          AliasInfo aliasInfo = new AliasInfo();
 304          aliasInfo.setName(info.toString());
 305          aliasInfo.setAlias(alias.toString());
 306  
 307          return aliasInfo;
 308      }
 309  
<abbr title=" 310      public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, String&gt; mappingTable) {"> 310      public RowTypeInfo buildOutRowTypeInfo(List&lt;FieldInfo&gt; sideJoinFieldInfo, HashBasedTable&lt;String, String, Strin🔵</abbr>


 311          TypeInformation[] sideOutTypes = new TypeInformation[sideJoinFieldInfo.size()];
 312          String[] sideOutNames = new String[sideJoinFieldInfo.size()];
 313          for (int i = 0; i &lt; sideJoinFieldInfo.size(); i++) {
 314              FieldInfo fieldInfo = sideJoinFieldInfo.get(i);
 315              String tableName = fieldInfo.getTable();
 316              String fieldName = fieldInfo.getFieldName();
 317              String mappingFieldName = ParseUtils.dealDuplicateFieldName(mappingTable, fieldName);
 318              mappingTable.put(tableName, fieldName, mappingFieldName);



 319  
 320              sideOutTypes[i] = fieldInfo.getTypeInformation();
 321              sideOutNames[i] = mappingFieldName;
 322          }
 323          return new RowTypeInfo(sideOutTypes, sideOutNames);
 324      }
 325  
 326  
 327  
 328      /**
 329       *  对时间类型进行类型转换
 330       * @param leftTypeInfo
 331       * @return
 332       */
 333      private RowTypeInfo buildLeftTableOutType(RowTypeInfo leftTypeInfo) {
 334          TypeInformation[] sideOutTypes = new TypeInformation[leftTypeInfo.getFieldNames().length];
 335          TypeInformation&lt;?&gt;[] fieldTypes = leftTypeInfo.getFieldTypes();
 336          for (int i = 0; i &lt; sideOutTypes.length; i++) {
 337              sideOutTypes[i] = convertTimeAttributeType(fieldTypes[i]);
 338          }
 339          RowTypeInfo rowTypeInfo = new RowTypeInfo(sideOutTypes, leftTypeInfo.getFieldNames());
 340          return rowTypeInfo;
 341      }
 342  
 343      private TypeInformation convertTimeAttributeType(TypeInformation typeInformation) {
 344          if (typeInformation instanceof TimeIndicatorTypeInfo) {
 345              return TypeInformation.of(Timestamp.class);
 346          }
 347          return typeInformation;
 348      }
 349  
 350      //需要考虑更多的情况
 351      private void replaceFieldName(SqlNode sqlNode, FieldReplaceInfo replaceInfo) {
 352          SqlKind sqlKind = sqlNode.getKind();
 353          switch (sqlKind) {
 354              case INSERT:
 355                  SqlNode sqlSource = ((SqlInsert) sqlNode).getSource();
 356                  replaceFieldName(sqlSource, replaceInfo);
 357                  break;
 358              case AS:
 359                  SqlNode asNode = ((SqlBasicCall) sqlNode).getOperands()[0];
 360                  replaceFieldName(asNode, replaceInfo);
 361                  break;
 362              case SELECT:
<abbr title=" 363                  SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName());"> 363                  SqlSelect sqlSelect = (SqlSelect) filterNodeWithTargetName(sqlNode, replaceInfo.getTargetTableName🔵</abbr>
 364                  if(sqlSelect == null){
 365                      return;
 366                  }
 367  
 368                  SqlNode sqlSource1 = sqlSelect.getFrom();
 369                  if(sqlSource1.getKind() == AS){
 370                      String tableName = ((SqlBasicCall)sqlSource1).getOperands()[0].toString();
 371                      if(tableName.equalsIgnoreCase(replaceInfo.getTargetTableName())){
 372                          SqlNodeList sqlSelectList = sqlSelect.getSelectList();
 373                          SqlNode whereNode = sqlSelect.getWhere();
 374                          SqlNodeList sqlGroup = sqlSelect.getGroup();
 375  
 376                          //TODO 暂时不处理having
 377                          SqlNode sqlHaving = sqlSelect.getHaving();
 378  
 379                          List&lt;SqlNode&gt; newSelectNodeList = Lists.newArrayList();
 380                          for( int i=0; i&lt;sqlSelectList.getList().size(); i++){
 381                              SqlNode selectNode = sqlSelectList.getList().get(i);
 382                              //特殊处理 isStar的标识
 383                              if(selectNode.getKind() == IDENTIFIER &amp;&amp; ((SqlIdentifier) selectNode).isStar()){
<abbr title=" 384                                  List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo);"> 384                                  List&lt;SqlNode&gt; replaceNodeList = replaceSelectStarFieldName(selectNode, replaceInfo🔵</abbr>
 385                                  newSelectNodeList.addAll(replaceNodeList);
 386                                  continue;
 387                              }
 388  
 389                              SqlNode replaceNode = replaceSelectFieldName(selectNode, replaceInfo);
 390                              if(replaceNode == null){
 391                                  continue;
 392                              }
 393  
 394                              //sqlSelectList.set(i, replaceNode);
 395                              newSelectNodeList.add(replaceNode);
 396                          }
 397  
<abbr title=" 398                          SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosition());"> 398                          SqlNodeList newSelectList = new SqlNodeList(newSelectNodeList, sqlSelectList.getParserPosi🔵</abbr>
 399                          sqlSelect.setSelectList(newSelectList);
 400  
 401                          //where
 402                          if(whereNode != null){
 403                              SqlNode[] sqlNodeList = ((SqlBasicCall)whereNode).getOperands();
 404                              for(int i =0; i&lt;sqlNodeList.length; i++) {
 405                                  SqlNode whereSqlNode = sqlNodeList[i];
 406                                  SqlNode replaceNode = replaceNodeInfo(whereSqlNode, replaceInfo);
 407                                  sqlNodeList[i] = replaceNode;
 408                              }
 409                          }
 410                          if(sqlGroup != null &amp;&amp; CollectionUtils.isNotEmpty(sqlGroup.getList())){
 411                              for( int i=0; i&lt;sqlGroup.getList().size(); i++){
 412                                  SqlNode selectNode = sqlGroup.getList().get(i);
 413                                  SqlNode replaceNode = replaceNodeInfo(selectNode, replaceInfo);
 414                                  sqlGroup.set(i, replaceNode);
 415                              }
 416                          }
 417                      }
 418                  }else{
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -                    //TODO</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -                    System.out.println(sqlNode);</span>
 421                      throw new RuntimeException(&quot;---not deal type:&quot; + sqlNode);
 422                  }
 423  
 424                  break;
 425              case UNION:
 426                  SqlNode unionLeft = ((SqlBasicCall) sqlNode).getOperands()[0];
 427                  SqlNode unionRight = ((SqlBasicCall) sqlNode).getOperands()[1];
 428                  replaceFieldName(unionLeft, replaceInfo);
 429                  replaceFieldName(unionRight, replaceInfo);
 430  
 431                  break;
 432              case ORDER_BY:
 433                  SqlOrderBy sqlOrderBy  = (SqlOrderBy) sqlNode;
 434                  replaceFieldName(sqlOrderBy.query, replaceInfo);
 435                  SqlNodeList orderFiledList = sqlOrderBy.orderList;
 436                  for (int i=0 ;i&lt;orderFiledList.size();i++) {
<abbr title=" 437                      SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTableAlias());"> 437                      SqlNode replaceNode = replaceOrderByTableName(orderFiledList.get(i), replaceInfo.getTargetTabl🔵</abbr>
 438                      orderFiledList.set(i, replaceNode);
 439                  }
 440  
 441              default:
 442                  break;
 443          }
 444      }
 445  
 446      private SqlNode replaceOrderByTableName(SqlNode orderNode, String tableAlias) {
 447          if(orderNode.getKind() == IDENTIFIER){
 448              SqlIdentifier sqlIdentifier = (SqlIdentifier) orderNode;
 449              if (sqlIdentifier.names.size() == 1) {
 450                  return orderNode;
 451              }
 452              return sqlIdentifier.setName(0, tableAlias);
 453          } else if (orderNode instanceof  SqlBasicCall) {
 454              SqlBasicCall sqlBasicCall = (SqlBasicCall) orderNode;
 455              for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){
 456                  SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);
 457                  sqlBasicCall.getOperands()[i] = replaceOrderByTableName(sqlNode , tableAlias);
 458              }
 459              return sqlBasicCall;
 460          } else {
 461              return orderNode;
 462          }
 463      }
 464  
 465      private SqlNode replaceNodeInfo(SqlNode groupNode, FieldReplaceInfo replaceInfo){
 466          if(groupNode.getKind() == IDENTIFIER){
 467              SqlIdentifier sqlIdentifier = (SqlIdentifier) groupNode;
 468              if(sqlIdentifier.names.size() == 1){
 469                  return sqlIdentifier;
 470              }
 471  
<abbr title=" 472              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 472              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr>
 473              if(mappingFieldName == null){
 474                  throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + sqlIdentifier.toString() );
 475              }
 476  
 477              sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());
 478              return sqlIdentifier.setName(1, mappingFieldName);
 479          }else if(groupNode instanceof  SqlBasicCall){
 480              SqlBasicCall sqlBasicCall = (SqlBasicCall) groupNode;
 481              for(int i=0; i&lt;sqlBasicCall.getOperandList().size(); i++){
 482                  SqlNode sqlNode = sqlBasicCall.getOperandList().get(i);
 483                  SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);
 484                  sqlBasicCall.getOperands()[i] = replaceNode;
 485              }
 486  
 487              return sqlBasicCall;
 488          }else{
 489              return groupNode;
 490          }
 491      }
 492  
 493      public SqlNode filterNodeWithTargetName(SqlNode sqlNode, String targetTableName) {
 494  
 495          SqlKind sqlKind = sqlNode.getKind();
 496          switch (sqlKind){
 497              case SELECT:
 498                  SqlNode fromNode = ((SqlSelect)sqlNode).getFrom();
 499                  if(fromNode.getKind() == AS &amp;&amp; ((SqlBasicCall)fromNode).getOperands()[0].getKind() == IDENTIFIER){
 500                      if(((SqlBasicCall)fromNode).getOperands()[0].toString().equalsIgnoreCase(targetTableName)){
 501                          return sqlNode;
 502                      }else{
 503                          return null;
 504                      }
 505                  }else{
 506                      return filterNodeWithTargetName(fromNode, targetTableName);
 507                  }
 508              case AS:
 509                  SqlNode childNode = ((SqlBasicCall)sqlNode).getOperands()[0];
 510                  return filterNodeWithTargetName(childNode, targetTableName);
 511              case JOIN:
 512                  SqlNode leftNode = ((SqlJoin)sqlNode).getLeft();
 513                  SqlNode rightNode =  ((SqlJoin)sqlNode).getRight();
 514                  SqlNode leftReturnNode = filterNodeWithTargetName(leftNode, targetTableName);
 515                  SqlNode rightReturnNode = filterNodeWithTargetName(rightNode, targetTableName);
 516  
 517                  if(leftReturnNode != null) {
 518                      return leftReturnNode;
 519                  }else if(rightReturnNode != null){
 520                      return rightReturnNode;
 521                  }else{
 522                      return null;
 523                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 524 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 525 +                break;</span>
 526          }
 527  
 528          return null;
 529      }



 530  
 531  
 532      public void setLocalSqlPluginPath(String localSqlPluginPath) {
 533          this.localSqlPluginPath = localSqlPluginPath;
 534      }
 535  
 536      private Table getTableFromCache(Map&lt;String, Table&gt; localTableCache, String tableAlias, String tableName){
 537          Table table = localTableCache.get(tableAlias);
 538          if(table == null){
 539              table = localTableCache.get(tableName);
 540          }
 541  
 542          if(table == null){
 543              throw new RuntimeException(&quot;not register table &quot; + tableName);

 544          }
 545  
 546          return table;
 547      }
 548  
 549      private List&lt;SqlNode&gt; replaceSelectStarFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo){
 550          SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;
 551          List&lt;SqlNode&gt; sqlNodes = Lists.newArrayList();
 552          if(sqlIdentifier.isStar()){//处理 [* or table.*]
 553              int identifierSize = sqlIdentifier.names.size();
 554              Collection&lt;String&gt; columns = null;
 555              if(identifierSize == 1){
 556                  columns = replaceInfo.getMappingTable().values();
 557              }else{
 558                  columns = replaceInfo.getMappingTable().row(sqlIdentifier.names.get(0)).values();
 559              }
 560  
 561              for(String colAlias : columns){
 562                  SqlParserPos sqlParserPos = new SqlParserPos(0, 0);
 563                  List&lt;String&gt; columnInfo = Lists.newArrayList();
 564                  columnInfo.add(replaceInfo.getTargetTableAlias());
 565                  columnInfo.add(colAlias);
 566                  SqlIdentifier sqlIdentifierAlias = new SqlIdentifier(columnInfo, sqlParserPos);
 567                  sqlNodes.add(sqlIdentifierAlias);
 568              }
 569  
 570              return sqlNodes;
 571          }else{
 572              throw new RuntimeException(&quot;is not a star select field.&quot; + selectNode);
 573          }
 574      }
 575  
 576      private SqlNode replaceSelectFieldName(SqlNode selectNode, FieldReplaceInfo replaceInfo) {
 577          if (selectNode.getKind() == AS) {
 578              SqlNode leftNode = ((SqlBasicCall) selectNode).getOperands()[0];
 579              SqlNode replaceNode = replaceSelectFieldName(leftNode, replaceInfo);
 580              if (replaceNode != null) {
 581                  ((SqlBasicCall) selectNode).getOperands()[0] = replaceNode;
 582              }
 583  
 584              return selectNode;
 585          }else if(selectNode.getKind() == IDENTIFIER){
 586              SqlIdentifier sqlIdentifier = (SqlIdentifier) selectNode;
 587  
 588              if(sqlIdentifier.names.size() == 1){
 589                  return selectNode;
 590              }
 591  
 592              //Same level mappingTable
<abbr title=" 593              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sqlIdentifier.getComponent(1).getSimple());"> 593              String mappingFieldName = replaceInfo.getTargetFieldName(sqlIdentifier.getComponent(0).getSimple(), sq🔵</abbr>
 594              if (mappingFieldName == null) {
 595                  throw new RuntimeException(&quot;can&#x27;t find mapping fieldName:&quot; + selectNode.toString() );
 596              }
 597  
 598              sqlIdentifier = sqlIdentifier.setName(0, replaceInfo.getTargetTableAlias());
 599              sqlIdentifier = sqlIdentifier.setName(1, mappingFieldName);
 600              return sqlIdentifier;
 601          }else if(selectNode.getKind() == LITERAL || selectNode.getKind() == LITERAL_CHAIN){//字面含义
 602              return selectNode;
 603          }else if(  AGGREGATE.contains(selectNode.getKind())
 604                  || AVG_AGG_FUNCTIONS.contains(selectNode.getKind())
 605                  || COMPARISON.contains(selectNode.getKind())
 606                  || selectNode.getKind() == OTHER_FUNCTION
 607                  || selectNode.getKind() == DIVIDE
 608                  || selectNode.getKind() == CAST
 609                  || selectNode.getKind() == TRIM
 610                  || selectNode.getKind() == TIMES
 611                  || selectNode.getKind() == PLUS
 612                  || selectNode.getKind() == NOT_IN
 613                  || selectNode.getKind() == OR
 614                  || selectNode.getKind() == AND
 615                  || selectNode.getKind() == MINUS
 616                  || selectNode.getKind() == TUMBLE
 617                  || selectNode.getKind() == TUMBLE_START
 618                  || selectNode.getKind() == TUMBLE_END
 619                  || selectNode.getKind() == SESSION
 620                  || selectNode.getKind() == SESSION_START
 621                  || selectNode.getKind() == SESSION_END
 622                  || selectNode.getKind() == HOP
 623                  || selectNode.getKind() == HOP_START
 624                  || selectNode.getKind() == HOP_END
 625                  || selectNode.getKind() == BETWEEN
 626                  || selectNode.getKind() == IS_NULL
 627                  || selectNode.getKind() == IS_NOT_NULL
 628                  || selectNode.getKind() == CONTAINS
 629                  || selectNode.getKind() == TIMESTAMP_ADD
 630                  || selectNode.getKind() == TIMESTAMP_DIFF
 631                  || selectNode.getKind() == LIKE
 632  
 633                  ){
 634              SqlBasicCall sqlBasicCall = (SqlBasicCall) selectNode;
 635              for(int i=0; i&lt;sqlBasicCall.getOperands().length; i++){
 636                  SqlNode sqlNode = sqlBasicCall.getOperands()[i];
 637                  if(sqlNode instanceof SqlLiteral){
 638                      continue;
 639                  }
 640  
 641                  if(sqlNode instanceof SqlDataTypeSpec){
 642                      continue;
 643                  }
 644  
 645                  SqlNode replaceNode = replaceSelectFieldName(sqlNode, replaceInfo);
 646                  if(replaceNode == null){
 647                      continue;
 648                  }
 649  
 650                  sqlBasicCall.getOperands()[i] = replaceNode;
 651              }
 652  
 653              return selectNode;
 654          }else if(selectNode.getKind() == CASE){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -            System.out.println(&quot;selectNode&quot;);</span>
 656              SqlCase sqlCase = (SqlCase) selectNode;
 657              SqlNodeList whenOperands = sqlCase.getWhenOperands();
 658              SqlNodeList thenOperands = sqlCase.getThenOperands();
 659              SqlNode elseNode = sqlCase.getElseOperand();
 660  
 661              for(int i=0; i&lt;whenOperands.size(); i++){
 662                  SqlNode oneOperand = whenOperands.get(i);
 663                  SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);
 664                  if (replaceNode != null) {
 665                      whenOperands.set(i, replaceNode);
 666                  }
 667              }
 668  
 669              for(int i=0; i&lt;thenOperands.size(); i++){
 670                  SqlNode oneOperand = thenOperands.get(i);
 671                  SqlNode replaceNode = replaceSelectFieldName(oneOperand, replaceInfo);
 672                  if (replaceNode != null) {
 673                      thenOperands.set(i, replaceNode);
 674                  }
 675              }
 676  
 677              ((SqlCase) selectNode).setOperand(3, replaceSelectFieldName(elseNode, replaceInfo));
 678              return selectNode;
 679          }else if(selectNode.getKind() == OTHER){
 680              //不处理
 681              return selectNode;
 682          }else{
<abbr title=" 683              throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNode.getKind()));"> 683              throw new RuntimeException(String.format(&quot;not support node kind of %s to replace name now.&quot;, selectNod🔵</abbr>
 684          }
 685      }
 686  
 687      /**
<abbr title=" 688       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension table is the primary key definition"> 688       * Analyzing conditions are very join the dimension tables include all equivalent conditions (i.e., dimension 🔵</abbr>
 689       *
 690       * @return
 691       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 692 -    private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTableInfo) {"> 692 -    private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, SideTableInfo sideTableInfo) 🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 693 +    private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTableInfo) {"> 693 +    private boolean checkJoinCondition(SqlNode conditionNode, String sideTableAlias, AbstractSideTableInfo sideTab🔵</abbr></span>
 694          List&lt;String&gt; conditionFields = getConditionFields(conditionNode, sideTableAlias, sideTableInfo);
 695          if(CollectionUtils.isEqualCollection(conditionFields, convertPrimaryAlias(sideTableInfo))){
 696              return true;
 697          }
 698          return false;
 699      }
 700  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 701 -    private List&lt;String&gt; convertPrimaryAlias(SideTableInfo sideTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 702 +    private List&lt;String&gt; convertPrimaryAlias(AbstractSideTableInfo sideTableInfo) {</span>
 703          List&lt;String&gt; res = Lists.newArrayList();
 704          sideTableInfo.getPrimaryKeys().forEach(field -&gt; {
 705              res.add(sideTableInfo.getPhysicalFields().getOrDefault(field, field));
 706          });
 707          return res;
 708      }
 709  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 710 -    public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo sideTableInfo){"> 710 -    public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, SideTableInfo sideTable🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 711 +    public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo sideTableInfo){"> 711 +    public List&lt;String&gt; getConditionFields(SqlNode conditionNode, String specifyTableName, AbstractSideTableInfo s🔵</abbr></span>
 712          List&lt;SqlNode&gt; sqlNodeList = Lists.newArrayList();
 713          ParseUtils.parseAnd(conditionNode, sqlNodeList);
 714          List&lt;String&gt; conditionFields = Lists.newArrayList();
 715          for(SqlNode sqlNode : sqlNodeList){
 716              if (!SqlKind.COMPARISON.contains(sqlNode.getKind())) {
 717                  throw new RuntimeException(&quot;not compare operator.&quot;);
 718              }
 719  
 720              SqlIdentifier left = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[0];
 721              SqlIdentifier right = (SqlIdentifier)((SqlBasicCall)sqlNode).getOperands()[1];
 722  
 723              String leftTableName = left.getComponent(0).getSimple();
 724              String rightTableName = right.getComponent(0).getSimple();
 725  
 726              String tableCol = &quot;&quot;;
 727              if(leftTableName.equalsIgnoreCase(specifyTableName)){
 728                  tableCol = left.getComponent(1).getSimple();
 729              }else if(rightTableName.equalsIgnoreCase(specifyTableName)){
 730                  tableCol = right.getComponent(1).getSimple();
 731              }else{
<abbr title=" 732                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName));"> 732                  throw new RuntimeException(String.format(&quot;side table:%s join condition is wrong&quot;, specifyTableName🔵</abbr>
 733              }
 734              tableCol = sideTableInfo.getPhysicalFields().getOrDefault(tableCol, tableCol);
 735              conditionFields.add(tableCol);
 736          }
 737  
 738          return conditionFields;
 739      }
 740  
 741      protected void dealAsSourceTable(StreamTableEnvironment tableEnv,
 742                                       SqlNode pollSqlNode,
 743                                       Map&lt;String, Table&gt; tableCache,
 744                                       List&lt;FieldReplaceInfo&gt; replaceInfoList) throws SqlParseException {

 745  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -        AliasInfo aliasInfo = parseASNode(pollSqlNode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 747 +        AliasInfo aliasInfo = parseAsNode(pollSqlNode);</span>
 748          if (localTableCache.containsKey(aliasInfo.getName())) {
 749              return;
 750          }
 751  
 752          Table table = tableEnv.sqlQuery(aliasInfo.getName());
 753          tableEnv.registerTable(aliasInfo.getAlias(), table);
 754          localTableCache.put(aliasInfo.getAlias(), table);
 755  
 756          LOG.info(&quot;Register Table {} by {}&quot;, aliasInfo.getAlias(), aliasInfo.getName());
 757  
 758          FieldReplaceInfo fieldReplaceInfo = parseAsQuery((SqlBasicCall) pollSqlNode, tableCache);
 759          if(fieldReplaceInfo == null){
 760             return;
 761          }
 762  
 763          //as 的源表
 764          Set&lt;String&gt; fromTableNameSet = Sets.newHashSet();
 765          SqlNode fromNode = ((SqlBasicCall)pollSqlNode).getOperands()[0];
 766          TableUtils.getFromTableInfo(fromNode, fromTableNameSet);
 767          for(FieldReplaceInfo tmp : replaceInfoList){
 768              if(fromTableNameSet.contains(tmp.getTargetTableName())
 769                      || fromTableNameSet.contains(tmp.getTargetTableAlias())){
 770                  fieldReplaceInfo.setPreNode(tmp);
 771                  break;
 772              }
 773          }
 774          replaceInfoList.add(fieldReplaceInfo);
 775      }
 776  
 777      private void joinFun(Object pollObj, Map&lt;String, Table&gt; localTableCache,
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -                         Map&lt;String, SideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 779 +                         Map&lt;String, AbstractSideTableInfo&gt; sideTableMap, StreamTableEnvironment tableEnv,</span>
 780                           List&lt;FieldReplaceInfo&gt; replaceInfoList) throws Exception{







 781          JoinInfo joinInfo = (JoinInfo) pollObj;
 782  
 783          JoinScope joinScope = new JoinScope();
 784          JoinScope.ScopeChild leftScopeChild = new JoinScope.ScopeChild();
 785          leftScopeChild.setAlias(joinInfo.getLeftTableAlias());
 786          leftScopeChild.setTableName(joinInfo.getLeftTableName());
 787  
 788          SqlKind sqlKind = joinInfo.getLeftNode().getKind();
 789          if(sqlKind == AS){
 790              dealAsSourceTable(tableEnv, joinInfo.getLeftNode(), localTableCache, replaceInfoList);
 791          }
 792  
<abbr title=" 793          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableName());"> 793          Table leftTable = getTableFromCache(localTableCache, joinInfo.getLeftTableAlias(), joinInfo.getLeftTableNa🔵</abbr>
<abbr title=" 794          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColumnNames());"> 794          RowTypeInfo leftTypeInfo = new RowTypeInfo(leftTable.getSchema().getTypes(), leftTable.getSchema().getColu🔵</abbr>
 795          leftScopeChild.setRowTypeInfo(leftTypeInfo);
 796  
 797          JoinScope.ScopeChild rightScopeChild = new JoinScope.ScopeChild();
 798          rightScopeChild.setAlias(joinInfo.getRightTableAlias());
 799          rightScopeChild.setTableName(joinInfo.getRightTableName());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -        SideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 801 +        AbstractSideTableInfo sideTableInfo = sideTableMap.get(joinInfo.getRightTableName());</span>
 802          if(sideTableInfo == null){
 803              sideTableInfo = sideTableMap.get(joinInfo.getRightTableAlias());
 804          }
 805  
 806          if(sideTableInfo == null){
 807              throw new RuntimeException(&quot;can&#x27;t not find side table:&quot; + joinInfo.getRightTableName());
 808          }
 809  
 810  //        if(!checkJoinCondition(joinInfo.getCondition(), joinInfo.getRightTableAlias(), sideTableInfo)){
 811  //            throw new RuntimeException(&quot;ON condition must contain all equal fields!!!&quot;);
 812  //        }
 813  
 814          rightScopeChild.setRowTypeInfo(sideTableInfo.getRowTypeInfo());
 815  
 816          joinScope.addScope(leftScopeChild);
 817          joinScope.addScope(rightScopeChild);
 818  


 819          //获取两个表的所有字段
<abbr title=" 820          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, true);"> 820          List&lt;FieldInfo&gt; sideJoinFieldInfo = ParserJoinField.getRowTypeInfo(joinInfo.getSelectNode(), joinScope, tr🔵</abbr>


 821  
 822          String leftTableAlias = joinInfo.getLeftTableAlias();
 823          Table targetTable = localTableCache.get(leftTableAlias);
 824          if(targetTable == null){
 825              targetTable = localTableCache.get(joinInfo.getLeftTableName());
 826          }
 827  
<abbr title=" 828          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColumnNames());"> 828          RowTypeInfo typeInfo = new RowTypeInfo(targetTable.getSchema().getTypes(), targetTable.getSchema().getColu🔵</abbr>
 829  
 830          DataStream&lt;CRow&gt; adaptStream = tableEnv.toRetractStream(targetTable, org.apache.flink.types.Row.class)
 831                  .map((Tuple2&lt;Boolean, Row&gt; tp2) -&gt; {
 832                      return new CRow(tp2.f1, tp2.f0);
 833                  }).returns(CRow.class);
 834  
 835  
 836          //join side table before keyby ===&gt; Reducing the size of each dimension table cache of async
 837          if (sideTableInfo.isPartitionedJoin()) {
<abbr title=" 838              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(), sideTableInfo);"> 838              List&lt;String&gt; leftJoinColList = getConditionFields(joinInfo.getCondition(), joinInfo.getLeftTableAlias(🔵</abbr>
 839              List&lt;String&gt; fieldNames = Arrays.asList(targetTable.getSchema().getFieldNames());
 840              int[] keyIndex = leftJoinColList.stream().mapToInt(fieldNames::indexOf).toArray();
<abbr title=" 841              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.getSchema())));"> 841              adaptStream = adaptStream.keyBy(new CRowKeySelector(keyIndex, projectedTypeInfo(keyIndex, targetTable.🔵</abbr>
 842          }
 843  
 844          DataStream&lt;CRow&gt; dsOut = null;
 845          if(ECacheType.ALL.name().equalsIgnoreCase(sideTableInfo.getCacheType())){
<abbr title=" 846              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 846              dsOut = SideWithAllCacheOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlP🔵</abbr>
 847          }else{
<abbr title=" 848              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPath, typeInfo, joinInfo, sideJoinFieldInfo, sideTableInfo);"> 848              dsOut = SideAsyncOperator.getSideJoinDataStream(adaptStream, sideTableInfo.getType(), localSqlPluginPa🔵</abbr>
 849          }
 850  
 851          // TODO  将嵌套表中的字段传递过去, 去除冗余的ROWtime
 852          HashBasedTable&lt;String, String, String&gt; mappingTable = HashBasedTable.create();
 853          RowTypeInfo sideOutTypeInfo = buildOutRowTypeInfo(sideJoinFieldInfo, mappingTable);
 854  
 855          CRowTypeInfo cRowTypeInfo = new CRowTypeInfo(sideOutTypeInfo);
 856          dsOut.getTransformation().setOutputType(cRowTypeInfo);
 857  
 858          String targetTableName = joinInfo.getNewTableName();
 859          String targetTableAlias = joinInfo.getNewTableAlias();
 860  
 861          FieldReplaceInfo replaceInfo = new FieldReplaceInfo();
 862          replaceInfo.setMappingTable(mappingTable);
 863          replaceInfo.setTargetTableName(targetTableName);
 864          replaceInfo.setTargetTableAlias(targetTableAlias);
 865  
 866          //判断之前是不是被替换过,被替换过则设置之前的替换信息作为上一个节点
 867          for(FieldReplaceInfo tmp : replaceInfoList){
 868              if(tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableName())
 869              ||tmp.getTargetTableName().equalsIgnoreCase(joinInfo.getLeftTableAlias())){
 870                  replaceInfo.setPreNode(tmp);
 871                  break;
 872              }
 873          }
 874  
 875          replaceInfoList.add(replaceInfo);
 876  
 877          if (!tableEnv.isRegistered(joinInfo.getNewTableName())){
 878              Table joinTable = tableEnv.fromDataStream(dsOut);
 879              tableEnv.registerTable(joinInfo.getNewTableName(), joinTable);
 880              localTableCache.put(joinInfo.getNewTableName(), joinTable);
 881          }
 882      }
 883  
 884      private TypeInformation&lt;Row&gt; projectedTypeInfo(int[] fields, TableSchema schema) {
 885          String[] fieldNames = schema.getFieldNames();
 886          TypeInformation&lt;?&gt;[] fieldTypes = schema.getFieldTypes();
 887  
 888          String[] projectedNames = Arrays.stream(fields).mapToObj(i -&gt; fieldNames[i]).toArray(String[]::new);
<abbr title=" 889          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformation[]::new);"> 889          TypeInformation[] projectedTypes = Arrays.stream(fields).mapToObj(i -&gt; fieldTypes[i]).toArray(TypeInformat🔵</abbr>
 890          return new RowTypeInfo(projectedTypes, projectedNames);
 891      }
 892  
 893  
 894      private boolean checkFieldsInfo(CreateTmpTableParser.SqlParserResult result, Table table) {
 895          List&lt;String&gt; fieldNames = new LinkedList&lt;&gt;();
 896          String fieldsInfo = result.getFieldsInfoStr();
 897          String[] fields = StringUtils.split(fieldsInfo, &quot;,&quot;);
 898          for (int i = 0; i &lt; fields.length; i++) {
 899              String[] filed = fields[i].split(&quot;\\s&quot;);
 900              if (filed.length &lt; 2 || fields.length != table.getSchema().getColumnNames().length){
 901                  return false;
 902              } else {
 903                  String[] filedNameArr = new String[filed.length - 1];
 904                  System.arraycopy(filed, 0, filedNameArr, 0, filed.length - 1);
 905                  String fieldName = String.join(&quot; &quot;, filedNameArr);
 906                  fieldNames.add(fieldName);
 907                  String fieldType = filed[filed.length - 1 ].trim();
 908                  Class fieldClass = ClassUtil.stringConvertClass(fieldType);
 909                  Class tableField = table.getSchema().getFieldType(i).get().getTypeClass();
 910                  if (fieldClass == tableField){
 911                      continue;
 912                  } else {
 913                      return false;
 914                  }
 915              }
 916          }
 917          tmpFields = String.join(&quot;,&quot;, fieldNames);
 918          return true;
 919      }
 920  
 921  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            