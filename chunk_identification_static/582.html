<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>582</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    582
                    <a href="581.html">prev</a>
                    <a href="583.html">next</a>
                    <a href="582_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_3f89d1e66187447b56be7b8b76e9b09af9b9850d_rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/all/RdbAllReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/all/RdbAllReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^1:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/all/RdbAllReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^2:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/all/RdbAllReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b2e4085e6d35798d51707eb23aa215e0e694591e:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/all/RdbAllReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.table.api.DataTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import javax.xml.datatype.DatatypeConstants;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import java.sql.Connection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import java.sql.ResultSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 import java.sql.SQLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import java.sql.Statement;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import java.time.LocalDateTime;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 import java.time.ZoneOffset;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import java.util.Calendar;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 import java.util.Map;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51  * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52  * Date: 2018/11/26</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64     private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         super(sideInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83             if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         return row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94     protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101     protected void reloadCache() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105             loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                 out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144             out.collect(fillData(value, one));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149     private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151         for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152             sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161             sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167     public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         Connection connection = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());"> 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                     break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179                 } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                         throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserNðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                     } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                         LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194             //load data from table</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195             String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196             Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197             statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198             ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199             String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200             String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201             while (resultSet.next()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203                 for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204                     Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());"> 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim())ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                     oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                 list.add(oneRow);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         } finally {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             if (connection != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                 connection.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223     public int getFetchSize() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         return 1000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227 }</span>
 228 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 import java.sql.ResultSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 import java.sql.Statement;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274  * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275  * Date: 2018/11/26</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278  * @author maqi</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291     public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292         super(sideInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 301             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 301             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 303             //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long."> 303             //Type information for indicating event or processing time. However, it behaves like a regulaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312             if (cacheInfo == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319         return row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325         cacheRef.set(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         loadData(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     protected void reloadCache() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331         //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334             loadData(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         cacheRef.set(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345     public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351                     Row row = fillData(value, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352                     out.collect(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361         if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362             if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                 Row row = fillData(value, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                 out.collect(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372         for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373             out.collect(fillData(value, one));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378     private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380         for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381             sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         Connection connection = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405                 try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 406                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());"> 406                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407                     break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408                 } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409                     if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410                         throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 413                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 413                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserNðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415                         Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416                     } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417                         LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423             //load data from table</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424             String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425             Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426             statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427             ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428             String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429             String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430             while (resultSet.next()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432                 for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433                     Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 434                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());"> 434                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435                     object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436                     oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 440                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 440                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441                 list.add(oneRow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446             if (connection != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                 connection.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452     public int getFetchSize() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453         return 1000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 }</span>
 457 =======
 458 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.table.api.DataTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import javax.xml.datatype.DatatypeConstants;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import java.sql.Connection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import java.sql.ResultSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 import java.sql.SQLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import java.sql.Statement;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import java.time.LocalDateTime;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 import java.time.ZoneOffset;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import java.util.Calendar;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 import java.util.Map;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51  * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52  * Date: 2018/11/26</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64     private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         super(sideInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83             if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         return row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94     protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101     protected void reloadCache() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105             loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                 out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144             out.collect(fillData(value, one));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149     private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151         for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152             sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161             sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167     public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         Connection connection = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());"> 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                     break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179                 } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                         throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserNðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                     } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                         LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194             //load data from table</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195             String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196             Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197             statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198             ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199             String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200             String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201             while (resultSet.next()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203                 for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204                     Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());"> 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim())ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                     oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                 list.add(oneRow);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         } finally {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             if (connection != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                 connection.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223     public int getFetchSize() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         return 1000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227 }</span>
 228 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 import java.sql.ResultSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 import java.sql.Statement;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 import java.sql.Timestamp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274  * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275  * Date: 2018/11/26</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278  * @author maqi</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287     private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291     public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292         super(sideInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 301             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 301             boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 303             //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long."> 303             //Type information for indicating event or processing time. However, it behaves like a regulaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304             if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                 obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312             if (cacheInfo == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319         return row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325         cacheRef.set(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326         loadData(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330     protected void reloadCache() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331         //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334             loadData(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         cacheRef.set(newCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345     public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351                     Row row = fillData(value, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352                     out.collect(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356             inputParams.add(equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361         if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362             if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                 Row row = fillData(value, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                 out.collect(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372         for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373             out.collect(fillData(value, one));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378     private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380         for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381             sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         return sb.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         Connection connection = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405                 try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 406                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());"> 406                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407                     break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408                 } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409                     if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410                         throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 413                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 413                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserNðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415                         Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416                     } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417                         LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423             //load data from table</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424             String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425             Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426             statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427             ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428             String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429             String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430             while (resultSet.next()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432                 for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433                     Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 434                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());"> 434                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435                     object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436                     oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 440                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 440                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441                 list.add(oneRow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446             if (connection != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447                 connection.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452     public int getFetchSize() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453         return 1000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 }</span>
 457 =======
 458 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.table.api.DataTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import javax.xml.datatype.DatatypeConstants;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import java.sql.Connection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import java.sql.ResultSet;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 import java.sql.SQLException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import java.sql.Statement;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import java.time.LocalDateTime;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 import java.time.ZoneOffset;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import java.util.Calendar;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 import java.util.Map;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51  * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52  * Date: 2018/11/26</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64     private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         super(sideInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73     public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77             Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79             row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83             if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84                 row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86                 row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90         return row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94     protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97         loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101     protected void reloadCache() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105             loadData(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110         cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117         List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                 if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                     Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         String key = buildKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                 out.collect(row);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140             return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144             out.collect(fillData(value, one));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149     private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151         for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152             sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158     private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161             sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         return sb.toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167     public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170     private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         Connection connection = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175             for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                 try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());"> 177                     connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                     break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179                 } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                     if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                         throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 184                         String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserNðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                         LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                     } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                         LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194             //load data from table</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195             String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196             Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197             statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198             ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199             String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200             String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201             while (resultSet.next()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202                 Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203                 for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204                     Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());"> 205                     int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim())ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206                     object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207                     oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210                 String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());"> 211                 List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212                 list.add(oneRow);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215             LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         } finally {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             if (connection != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                 connection.close();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223     public int getFetchSize() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         return 1000;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227 }</span>
 228 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 229 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 229 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 230 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 </span>
 232 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.side.rdb.all;
  20  
  21  import com.dtstack.flink.sql.side.AllReqRow;
  22  import com.dtstack.flink.sql.side.SideInfo;
  23  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  24  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  25  import org.apache.calcite.sql.JoinType;
  26  import org.apache.commons.collections.CollectionUtils;
  27  import com.google.common.collect.Lists;
  28  import com.google.common.collect.Maps;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.apache.flink.table.api.DataTypes;</span>
  30  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  31  import org.apache.flink.types.Row;
  32  import org.apache.flink.util.Collector;
  33  import org.slf4j.Logger;
  34  import org.slf4j.LoggerFactory;
  35  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import javax.xml.datatype.DatatypeConstants;</span>
  37  import java.sql.Connection;
  38  import java.sql.ResultSet;
  39  import java.sql.SQLException;
  40  import java.sql.Statement;
  41  import java.sql.Timestamp;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import java.time.LocalDateTime;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import java.time.ZoneOffset;</span>
  44  import java.util.Calendar;
  45  import java.util.List;
  46  import java.util.Map;
  47  import java.util.concurrent.atomic.AtomicReference;
  48  
  49  /**
  50   * side operator with cache for all(period reload)
  51   * Date: 2018/11/26
  52   * Company: www.dtstack.com
  53   *
  54   * @author maqi
  55   */
  56  
  57  public abstract class RdbAllReqRow extends AllReqRow {
  58  
  59      private static final long serialVersionUID = 2098635140857937718L;
  60  
  61      private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);
  62  
  63      private static final int CONN_RETRY_NUM = 3;
  64  
  65      private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();
  66  
  67      public RdbAllReqRow(SideInfo sideInfo) {
  68          super(sideInfo);
  69      }
  70  
  71      @Override
  72      public Row fillData(Row input, Object sideInput) {
  73          Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;
  74          Row row = new Row(sideInfo.getOutFieldInfoList().size());
  75          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
  76              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  77 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());">  77 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  79 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long.">  79 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
  85              row.setField(entry.getKey(), obj);
  86          }
  87  
  88          for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {
  89              if (cacheInfo == null) {
  90                  row.setField(entry.getKey(), null);
  91              } else {
  92                  row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));
  93              }
  94          }
  95  
  96          return row;
  97      }
  98  
  99      @Override
 100      protected void initCache() throws SQLException {
 101          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 102          cacheRef.set(newCache);
 103          loadData(newCache);
 104      }
 105  
 106      @Override
 107      protected void reloadCache() {
 108          //reload cacheRef and replace to old cacheRef
 109          Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();
 110          try {
 111              loadData(newCache);
 112          } catch (SQLException e) {
 113              LOG.error(&quot;&quot;, e);
 114          }
 115  
 116          cacheRef.set(newCache);
 117          LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());
 118      }
 119  
 120  
 121      @Override
 122      public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {
 123          List&lt;Object&gt; inputParams = Lists.newArrayList();
 124          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
 125              Object equalObj = value.getField(conValIndex);
 126              if (equalObj == null) {
 127                  if (sideInfo.getJoinType() == JoinType.LEFT) {
 128                      Row row = fillData(value, null);
 129                      out.collect(row);
 130                  }
 131                  return;
 132              }
 133              inputParams.add(equalObj);
 134          }
 135  
 136          String key = buildKey(inputParams);
 137          List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);
 138          if (CollectionUtils.isEmpty(cacheList)) {
 139              if (sideInfo.getJoinType() == JoinType.LEFT) {
 140                  Row row = fillData(value, null);
 141                  out.collect(row);
 142              } else {
 143                  return;
 144              }
 145  
 146              return;
 147          }
 148  
 149          for (Map&lt;String, Object&gt; one : cacheList) {
 150              out.collect(fillData(value, one));
 151          }
 152  
 153      }
 154  
 155      private String buildKey(List&lt;Object&gt; equalValList) {
 156          StringBuilder sb = new StringBuilder(&quot;&quot;);
 157          for (Object equalVal : equalValList) {
 158              sb.append(equalVal).append(&quot;_&quot;);
 159          }
 160  
 161          return sb.toString();
 162      }
 163  
 164      private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {
 165          StringBuilder sb = new StringBuilder(&quot;&quot;);
 166          for (String equalField : equalFieldList) {
 167              sb.append(val.get(equalField)).append(&quot;_&quot;);
 168          }
 169  
 170          return sb.toString();
 171      }
 172  
 173      public abstract Connection getConn(String dbURL, String userName, String password);
 174  
 175  
 176      private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {
 177          RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
 178          Connection connection = null;
 179  
 180          try {
 181              for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {
 182                  try {
 183                      connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());
 184                      break;
 185                  } catch (Exception e) {
 186                      if (i == CONN_RETRY_NUM - 1) {
 187                          throw new RuntimeException(&quot;&quot;, e);
 188                      }
 189                      try {
<abbr title=" 190                          String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 190                          String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;ðŸ”µ</abbr>
 191                          LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);
 192                          Thread.sleep(5 * 1000);
 193                      } catch (InterruptedException e1) {
 194                          LOG.error(&quot;&quot;, e1);
 195                      }
 196                  }
 197  
 198              }
 199  
 200              //load data from table
 201              String sql = sideInfo.getSqlCondition();
 202              Statement statement = connection.createStatement();
 203              statement.setFetchSize(getFetchSize());
 204              ResultSet resultSet = statement.executeQuery(sql);
 205              String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);
 206              String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 207              while (resultSet.next()) {
 208                  Map&lt;String, Object&gt; oneRow = Maps.newHashMap();
 209                  for (String fieldName : sideFieldNames) {
 210                      Object object = resultSet.getObject(fieldName.trim());
 211                      int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());
 212                      object = SwitchUtil.getTarget(object, fields[fieldIndex]);
 213                      oneRow.put(fieldName.trim(), object);
 214                  }
 215  
 216                  String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());
 217                  List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());
 218                  list.add(oneRow);
 219              }
 220          } catch (Exception e) {
 221              LOG.error(&quot;&quot;, e);
 222          } finally {
 223              if (connection != null) {
 224                  connection.close();
 225              }
 226          }
 227      }
 228  
 229      public int getFetchSize() {
 230          return 1000;
 231      }
 232  
 233  }</pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.side.rdb.all;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.side.AllReqRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.side.SideInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.calcite.sql.JoinType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.google.common.collect.Maps;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.util.Collector;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import java.sql.Connection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import java.sql.ResultSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import java.sql.SQLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import java.sql.Statement;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.sql.Timestamp;</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.util.Calendar;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.util.concurrent.atomic.AtomicReference;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 - * side operator with cache for all(period reload)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 - * Date: 2018/11/26</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 - * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 - * @author maqi</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -public abstract class RdbAllReqRow extends AllReqRow {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    private static final long serialVersionUID = 2098635140857937718L;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -    private static final Logger LOG = LoggerFactory.getLogger(RdbAllReqRow.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    private static final int CONN_RETRY_NUM = 3;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -    private AtomicReference&lt;Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; cacheRef = new AtomicReference&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -    public RdbAllReqRow(SideInfo sideInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -        super(sideInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    public Row fillData(Row input, Object sideInput) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -        Map&lt;String, Object&gt; cacheInfo = (Map&lt;String, Object&gt;) sideInput;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -        Row row = new Row(sideInfo.getOutFieldInfoList().size());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -            Object obj = input.getField(entry.getValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  73 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());">  73 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  75 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timestamp but is serialized as Long.">  75 -            //Type information for indicating event or processing time. However, it behaves like a regular SQL timðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -            row.setField(entry.getKey(), obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        for (Map.Entry&lt;Integer, String&gt; entry : sideInfo.getSideFieldNameIndex().entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -            if (cacheInfo == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -                row.setField(entry.getKey(), null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -                row.setField(entry.getKey(), cacheInfo.get(entry.getValue()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        return row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    protected void initCache() throws SQLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        loadData(newCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    protected void reloadCache() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        //reload cacheRef and replace to old cacheRef</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; newCache = Maps.newConcurrentMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -            loadData(newCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -            LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        cacheRef.set(newCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        LOG.info(&quot;----- rdb all cacheRef reload end:{}&quot;, Calendar.getInstance());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    public void flatMap(Row value, Collector&lt;Row&gt; out) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        List&lt;Object&gt; inputParams = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -        for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            Object equalObj = value.getField(conValIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -                if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                    Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                    out.collect(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        String key = buildKey(inputParams);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        List&lt;Map&lt;String, Object&gt;&gt; cacheList = cacheRef.get().get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        if (CollectionUtils.isEmpty(cacheList)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            if (sideInfo.getJoinType() == JoinType.LEFT) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                Row row = fillData(value, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                out.collect(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        for (Map&lt;String, Object&gt; one : cacheList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            out.collect(fillData(value, one));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    private String buildKey(List&lt;Object&gt; equalValList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -        for (Object equalVal : equalValList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            sb.append(equalVal).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -    private String buildKey(Map&lt;String, Object&gt; val, List&lt;String&gt; equalFieldList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        for (String equalField : equalFieldList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -            sb.append(val.get(equalField)).append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        return sb.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -    public abstract Connection getConn(String dbURL, String userName, String password);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    private void loadData(Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; tmpCache) throws SQLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        RdbSideTableInfo tableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -        Connection connection = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            for (int i = 0; i &lt; CONN_RETRY_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -                try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -                    connection = getConn(tableInfo.getUrl(), tableInfo.getUserName(), tableInfo.getPassword());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                    break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                    if (i == CONN_RETRY_NUM - 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                        throw new RuntimeException(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 185 -                        String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;,pwd:&quot; + tableInfo.getPassword();"> 185 -                        String connInfo = &quot;url:&quot; + tableInfo.getUrl() + &quot;;userName:&quot; + tableInfo.getUserName() + &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -                        LOG.warn(&quot;get conn fail, wait for 5 sec and try again, connInfo:&quot; + connInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                        Thread.sleep(5 * 1000);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                    } catch (InterruptedException e1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        LOG.error(&quot;&quot;, e1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -            //load data from table</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -            String sql = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            Statement statement = connection.createStatement();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -            statement.setFetchSize(getFetchSize());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -            ResultSet resultSet = statement.executeQuery(sql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -            String[] sideFieldNames = sideInfo.getSideSelectFields().split(&quot;,&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -            String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -            while (resultSet.next()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                Map&lt;String, Object&gt; oneRow = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                for (String fieldName : sideFieldNames) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                    Object object = resultSet.getObject(fieldName.trim());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                    int fieldIndex = sideInfo.getSideTableInfo().getFieldList().indexOf(fieldName.trim());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                    object = SwitchUtil.getTarget(object, fields[fieldIndex]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                    oneRow.put(fieldName.trim(), object);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                String cacheKey = buildKey(oneRow, sideInfo.getEqualFieldList());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                List&lt;Map&lt;String, Object&gt;&gt; list = tmpCache.computeIfAbsent(cacheKey, key -&gt; Lists.newArrayList());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                list.add(oneRow);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -            if (connection != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -                connection.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -    public int getFetchSize() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -        return 1000;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            