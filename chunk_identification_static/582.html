<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>582</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    582
                    <a href="581.html">prev</a>
                    <a href="583.html">next</a>
                    <a href="582_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    GoogleCloudPlatform/bank-of-anthos_2076e8db0ffcad7921bf427257e6f7a4b97eab90_src/balancereader/src/main/java/anthos/samples/financedemo/balancereader/LedgerReader.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;2076e8db0ffcad7921bf427257e6f7a4b97eab90:src/balancereader/src/main/java/anthos/samples/financedemo/balancereader/LedgerReader.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;2076e8db0ffcad7921bf427257e6f7a4b97eab90^1:src/balancereader/src/main/java/anthos/samples/financedemo/balancereader/LedgerReader.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;2076e8db0ffcad7921bf427257e6f7a4b97eab90^2:src/balancereader/src/main/java/anthos/samples/financedemo/balancereader/LedgerReader.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;f3e19d5493c829768435b0ff67359b6b518cfad4:src/balancereader/src/main/java/anthos/samples/financedemo/balancereader/LedgerReader.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bsj]], subset: [[bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">   2 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  */                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18                                                                                                          </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 package anthos.samples.financedemo.balancereader;                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20                                                                                                          </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import java.util.logging.Logger;                                                                         </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22                                                                                                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.springframework.dao.DataAccessResourceFailureException;                                       </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.springframework.stereotype.Component;                                                         </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 /**                                                                                                      </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30  * Defines an interface for reacting to new transactions                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31  *                                                                                                       </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32  * @param accountId    the account associated with the transaction                                       </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33  * @param amount       the amount of change in balance for the account                                   </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34  * @param transaction  the full transaction object                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35  */                                                                                                      </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 interface LedgerReaderCallback {                                                                         </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37     void processTransaction(Transaction transaction);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 }                                                                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 /**                                                                                                      </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41  * LedgerReader listens for and reacts to incoming transactions                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42  */                                                                                                      </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 @Component                                                                                               </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 public final class LedgerReader {                                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46     private static final Logger LOGGER =                                                                 </span>
<span class="-1980718372906221922" onmouseenter="enter('-1980718372906221922');" onmouseout="out('-1980718372906221922');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47             Logger.getLogger(LedgerReader.class.getName());                                              </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49     @Autowired                                                                                           </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     private TransactionRepository dbRepo;                                                                </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51                                                                                                          </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     @Value(&quot;${POLL_MS:100}&quot;)                                                                             </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private Integer pollMs;                                                                              </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54     @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                       </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     private String localRoutingNum;                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56                                                                                                          </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     private Thread backgroundThread;                                                                     </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private LedgerReaderCallback callback;                                                               </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     private long latestId = -1;                                                                          </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     /**                                                                                                  </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62      * LedgerReader setup                                                                                </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63      * Synchronously loads all existing transactions, and then starts                                    </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64      * a background thread to listen for future transactions                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65      *                                                                                                   </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66      * @param callback to process transactions                                                           </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67      * @throws IllegalStateException if callback is null                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68      */                                                                                                  </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     public void startWithCallback(LedgerReaderCallback callback)                                         </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70             throws IllegalStateException {                                                               </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         if (callback == null) {                                                                          </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72             throw new IllegalStateException(&quot;callback is null&quot;);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         }                                                                                                </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         this.callback = callback;                                                                        </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         // get the latest transaction id in ledger                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         try {                                                                                            </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77             this.latestId = dbRepo.latestId();                                                           </span>
<span class="1660469741238238271" onmouseenter="enter('1660469741238238271');" onmouseout="out('1660469741238238271');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             LOGGER.info(String.format(&quot;starting id: %d&quot;, latestId));                                     </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         } catch (ResourceAccessException                                                                 </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80                 | DataAccessResourceFailureException e) {                                                </span>
<span class="7570052869168823836" onmouseenter="enter('7570052869168823836');" onmouseout="out('7570052869168823836');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81             LOGGER.warning(&quot;Could not contact ledger database at init&quot;);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         }                                                                                                </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         this.backgroundThread = new Thread(new Runnable() {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84             @Override                                                                                    </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85             public void run() {                                                                          </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86                 boolean alive = true;                                                                    </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87                 while (alive) {                                                                          </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88                     // sleep between polls                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89                     try {                                                                                </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90                         Thread.sleep(pollMs);                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91                     } catch (InterruptedException e) {                                                   </span>
<span class="-7979913707408184769" onmouseenter="enter('-7979913707408184769');" onmouseout="out('-7979913707408184769');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92                         LOGGER.warning(&quot;LedgerReader sleep interrupted&quot;);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93                     }                                                                                    </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                     // check for new updates in ledger                                                   </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                     Long remoteLatest;                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                     try {                                                                                </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                         remoteLatest = dbRepo.latestId();                                                </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98                     } catch (ResourceAccessException                                                     </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                             | DataAccessResourceFailureException e) {                                    </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                         remoteLatest = latestId;                                                         </span>
<span class="-3173504049391420865" onmouseenter="enter('-3173504049391420865');" onmouseout="out('-3173504049391420865');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                         LOGGER.warning(&quot;Could not reach ledger database&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                     }                                                                                    </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                     // if there are new transactions, poll the database                                  </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                     if (remoteLatest &gt; latestId) {                                                       </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                         latestId = pollTransactions(latestId);                                           </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                     } else if (remoteLatest &lt; latestId) {                                                </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                         // remote database out of sync                                                   </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                         // suspend processing transactions to reset service                              </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                         alive = false;                                                                   </span>
<span class="-5483040177851640680" onmouseenter="enter('-5483040177851640680');" onmouseout="out('-5483040177851640680');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                         LOGGER.severe(&quot;remote transaction id out of sync&quot;);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             }                                                                                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         });                                                                                              </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         LOGGER.info(&quot;Starting background thread.&quot;);                                                      </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         this.backgroundThread.start();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     /**                                                                                                  </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120      * Poll for new transactions                                                                         </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121      * Execute callback for each one                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122      *                                                                                                   </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123      * @param startingId the transaction to start reading after.                                         </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124      *                            -1 = start reading at beginning of the ledger                          </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125      * @return long id of latest transaction processed                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      */                                                                                                  </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     private long pollTransactions(long startingId) {                                                     </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         long latestId = startingId;                                                                      </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130                                                                                                          </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         for (Transaction transaction : transactionList) {                                                </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132             callback.processTransaction(transaction);                                                    </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133             latestId = transaction.getTransactionId();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         }                                                                                                </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         return latestId;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     /**                                                                                                  </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139      * Indicates health of LedgerReader                                                                  </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140      * @return false if background thread dies                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141      */                                                                                                  </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     public boolean isAlive() {                                                                           </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         return backgroundThread == null || backgroundThread.isAlive();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 }                                                                                                        </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 146 =======                                                                                                  </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161  */                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                                                                                                          </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 package anthos.samples.financedemo.balancereader;                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165                                                                                                          </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 import org.springframework.dao.DataAccessResourceFailureException;                                       </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 import org.springframework.stereotype.Component;                                                         </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 /**                                                                                                      </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * Defines an interface for reacting to new transactions                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  *                                                                                                       </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * @param accountId    the account associated with the transaction                                       </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * @param amount       the amount of change in balance for the account                                   </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * @param transaction  the full transaction object                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  */                                                                                                      </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181 interface LedgerReaderCallback {                                                                         </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182     void processTransaction(Transaction transaction);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 }                                                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 /**                                                                                                      </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186  * LedgerReader listens for and reacts to incoming transactions                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187  */                                                                                                      </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 @Component                                                                                               </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 public final class LedgerReader {                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     private static final Logger LOGGER =                                                                 </span>
<span class="1461544845435576115" onmouseenter="enter('1461544845435576115');" onmouseout="out('1461544845435576115');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         LogManager.getLogger(LedgerReader.class);                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     @Autowired                                                                                           </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195     private TransactionRepository dbRepo;                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                                                                                                          </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197     @Value(&quot;${POLL_MS:100}&quot;)                                                                             </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198     private Integer pollMs;                                                                              </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199     @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                       </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200     private String localRoutingNum;                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                                                                                                          </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202     private Thread backgroundThread;                                                                     </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203     private LedgerReaderCallback callback;                                                               </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204     private long latestId = -1;                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     /**                                                                                                  </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207      * LedgerReader setup                                                                                </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208      * Synchronously loads all existing transactions, and then starts                                    </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209      * a background thread to listen for future transactions                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210      *                                                                                                   </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211      * @param callback to process transactions                                                           </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212      * @throws IllegalStateException if callback is null                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213      */                                                                                                  </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214     public void startWithCallback(LedgerReaderCallback callback)                                         </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         throws IllegalStateException {                                                                   </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216         if (callback == null) {                                                                          </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             throw new IllegalStateException(&quot;callback is null&quot;);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         }                                                                                                </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         this.callback = callback;                                                                        </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         // get the latest transaction id in ledger                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         try {                                                                                            </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222             this.latestId = dbRepo.latestId();                                                           </span>
<span class="-4347379741997447063" onmouseenter="enter('-4347379741997447063');" onmouseout="out('-4347379741997447063');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223             LOGGER.debug(String.format(&quot;Transaction starting id: %d&quot;,                                    </span>
<span class="3808341982874512295" onmouseenter="enter('3808341982874512295');" onmouseout="out('3808341982874512295');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                 latestId));                                                                              </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         } catch (ResourceAccessException                                                                 </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226             | DataAccessResourceFailureException e) {                                                    </span>
<span class="-1245751810711562476" onmouseenter="enter('-1245751810711562476');" onmouseout="out('-1245751810711562476');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227             LOGGER.warn(&quot;Could not contact ledger database at init&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         }                                                                                                </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229         this.backgroundThread = new Thread(new Runnable() {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230             @Override                                                                                    </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231             public void run() {                                                                          </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                 boolean alive = true;                                                                    </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                 while (alive) {                                                                          </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                     // sleep between polls                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                     try {                                                                                </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                         Thread.sleep(pollMs);                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                     } catch (InterruptedException e) {                                                   </span>
<span class="7169745236524536729" onmouseenter="enter('7169745236524536729');" onmouseout="out('7169745236524536729');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238                         LOGGER.warn(&quot;LedgerReader sleep interrupted&quot;);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                     }                                                                                    </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                     // check for new updates in ledger                                                   </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                     Long remoteLatest;                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                     try {                                                                                </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                         remoteLatest = dbRepo.latestId();                                                </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                     } catch (ResourceAccessException                                                     </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                         | DataAccessResourceFailureException e) {                                        </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246                         remoteLatest = latestId;                                                         </span>
<span class="-263918513220140264" onmouseenter="enter('-263918513220140264');" onmouseout="out('-263918513220140264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247                         LOGGER.warn(&quot;Could not reach ledger database&quot;);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248                     }                                                                                    </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                     // if there are new transactions, poll the database                                  </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                     if (remoteLatest &gt; latestId) {                                                       </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251                         latestId = pollTransactions(latestId);                                           </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252                     } else if (remoteLatest &lt; latestId) {                                                </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                         // remote database out of sync                                                   </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                         // suspend processing transactions to reset service                              </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                         alive = false;                                                                   </span>
<span class="8268197514905332991" onmouseenter="enter('8268197514905332991');" onmouseout="out('8268197514905332991');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                         LOGGER.error(&quot;Remote transaction id out of sync&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             }                                                                                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         });                                                                                              </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         LOGGER.info(&quot;Starting background thread.&quot;);                                                      </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         this.backgroundThread.start();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     /**                                                                                                  </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266      * Poll for new transactions                                                                         </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267      * Execute callback for each one                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268      *                                                                                                   </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269      * @param startingId the transaction to start reading after.                                         </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270      *                            -1 = start reading at beginning of the ledger                          </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271      * @return long id of latest transaction processed                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272      */                                                                                                  </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     private long pollTransactions(long startingId) {                                                     </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         long latestId = startingId;                                                                      </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                           </span>
<span class="-2145483978985294219" onmouseenter="enter('-2145483978985294219');" onmouseout="out('-2145483978985294219');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         LOGGER.debug(&quot;Polling Transactions&quot;);                                                            </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         for (Transaction transaction : transactionList) {                                                </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             callback.processTransaction(transaction);                                                    </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279             latestId = transaction.getTransactionId();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         }                                                                                                </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         return latestId;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     /**                                                                                                  </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285      * Indicates health of LedgerReader                                                                  </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286      * @return false if background thread dies                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287      */                                                                                                  </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     public boolean isAlive() {                                                                           </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         return backgroundThread == null || backgroundThread.isAlive();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 }                                                                                                        </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 292 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span></pre></td>
                            <td><pre><span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style="">   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">   2 ||||||| BASE                                                                                             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  */                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18                                                                                                          </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 package anthos.samples.financedemo.balancereader;                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20                                                                                                          </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import java.util.logging.Logger;                                                                         </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22                                                                                                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.springframework.dao.DataAccessResourceFailureException;                                       </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.springframework.stereotype.Component;                                                         </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 /**                                                                                                      </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30  * Defines an interface for reacting to new transactions                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31  *                                                                                                       </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32  * @param accountId    the account associated with the transaction                                       </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33  * @param amount       the amount of change in balance for the account                                   </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34  * @param transaction  the full transaction object                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35  */                                                                                                      </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 interface LedgerReaderCallback {                                                                         </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37     void processTransaction(Transaction transaction);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 }                                                                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 /**                                                                                                      </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41  * LedgerReader listens for and reacts to incoming transactions                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42  */                                                                                                      </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 @Component                                                                                               </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 public final class LedgerReader {                                                                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46     private static final Logger LOGGER =                                                                 </span>
<span class="-1980718372906221922" onmouseenter="enter('-1980718372906221922');" onmouseout="out('-1980718372906221922');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47             Logger.getLogger(LedgerReader.class.getName());                                              </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49     @Autowired                                                                                           </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50     private TransactionRepository dbRepo;                                                                </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51                                                                                                          </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     @Value(&quot;${POLL_MS:100}&quot;)                                                                             </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private Integer pollMs;                                                                              </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54     @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                       </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     private String localRoutingNum;                                                                      </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56                                                                                                          </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     private Thread backgroundThread;                                                                     </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private LedgerReaderCallback callback;                                                               </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     private long latestId = -1;                                                                          </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     /**                                                                                                  </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62      * LedgerReader setup                                                                                </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63      * Synchronously loads all existing transactions, and then starts                                    </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64      * a background thread to listen for future transactions                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65      *                                                                                                   </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66      * @param callback to process transactions                                                           </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67      * @throws IllegalStateException if callback is null                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68      */                                                                                                  </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     public void startWithCallback(LedgerReaderCallback callback)                                         </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70             throws IllegalStateException {                                                               </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         if (callback == null) {                                                                          </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72             throw new IllegalStateException(&quot;callback is null&quot;);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         }                                                                                                </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         this.callback = callback;                                                                        </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         // get the latest transaction id in ledger                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         try {                                                                                            </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77             this.latestId = dbRepo.latestId();                                                           </span>
<span class="1660469741238238271" onmouseenter="enter('1660469741238238271');" onmouseout="out('1660469741238238271');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             LOGGER.info(String.format(&quot;starting id: %d&quot;, latestId));                                     </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         } catch (ResourceAccessException                                                                 </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80                 | DataAccessResourceFailureException e) {                                                </span>
<span class="7570052869168823836" onmouseenter="enter('7570052869168823836');" onmouseout="out('7570052869168823836');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81             LOGGER.warning(&quot;Could not contact ledger database at init&quot;);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         }                                                                                                </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         this.backgroundThread = new Thread(new Runnable() {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84             @Override                                                                                    </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85             public void run() {                                                                          </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86                 boolean alive = true;                                                                    </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87                 while (alive) {                                                                          </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88                     // sleep between polls                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89                     try {                                                                                </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90                         Thread.sleep(pollMs);                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91                     } catch (InterruptedException e) {                                                   </span>
<span class="-7979913707408184769" onmouseenter="enter('-7979913707408184769');" onmouseout="out('-7979913707408184769');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92                         LOGGER.warning(&quot;LedgerReader sleep interrupted&quot;);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93                     }                                                                                    </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94                     // check for new updates in ledger                                                   </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95                     Long remoteLatest;                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                     try {                                                                                </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                         remoteLatest = dbRepo.latestId();                                                </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98                     } catch (ResourceAccessException                                                     </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99                             | DataAccessResourceFailureException e) {                                    </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100                         remoteLatest = latestId;                                                         </span>
<span class="-3173504049391420865" onmouseenter="enter('-3173504049391420865');" onmouseout="out('-3173504049391420865');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101                         LOGGER.warning(&quot;Could not reach ledger database&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102                     }                                                                                    </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103                     // if there are new transactions, poll the database                                  </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                     if (remoteLatest &gt; latestId) {                                                       </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                         latestId = pollTransactions(latestId);                                           </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                     } else if (remoteLatest &lt; latestId) {                                                </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                         // remote database out of sync                                                   </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                         // suspend processing transactions to reset service                              </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                         alive = false;                                                                   </span>
<span class="-5483040177851640680" onmouseenter="enter('-5483040177851640680');" onmouseout="out('-5483040177851640680');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                         LOGGER.severe(&quot;remote transaction id out of sync&quot;);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             }                                                                                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         });                                                                                              </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         LOGGER.info(&quot;Starting background thread.&quot;);                                                      </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         this.backgroundThread.start();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     /**                                                                                                  </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120      * Poll for new transactions                                                                         </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121      * Execute callback for each one                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122      *                                                                                                   </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123      * @param startingId the transaction to start reading after.                                         </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124      *                            -1 = start reading at beginning of the ledger                          </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125      * @return long id of latest transaction processed                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      */                                                                                                  </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     private long pollTransactions(long startingId) {                                                     </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         long latestId = startingId;                                                                      </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130                                                                                                          </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         for (Transaction transaction : transactionList) {                                                </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132             callback.processTransaction(transaction);                                                    </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133             latestId = transaction.getTransactionId();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         }                                                                                                </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         return latestId;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     /**                                                                                                  </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139      * Indicates health of LedgerReader                                                                  </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140      * @return false if background thread dies                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141      */                                                                                                  </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     public boolean isAlive() {                                                                           </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         return backgroundThread == null || backgroundThread.isAlive();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 }                                                                                                        </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 146 =======                                                                                                  </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161  */                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                                                                                                          </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 package anthos.samples.financedemo.balancereader;                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165                                                                                                          </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 import org.springframework.dao.DataAccessResourceFailureException;                                       </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 import org.springframework.stereotype.Component;                                                         </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 /**                                                                                                      </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * Defines an interface for reacting to new transactions                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  *                                                                                                       </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * @param accountId    the account associated with the transaction                                       </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * @param amount       the amount of change in balance for the account                                   </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * @param transaction  the full transaction object                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  */                                                                                                      </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181 interface LedgerReaderCallback {                                                                         </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182     void processTransaction(Transaction transaction);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 }                                                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 /**                                                                                                      </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186  * LedgerReader listens for and reacts to incoming transactions                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187  */                                                                                                      </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 @Component                                                                                               </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 public final class LedgerReader {                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     private static final Logger LOGGER =                                                                 </span>
<span class="1461544845435576115" onmouseenter="enter('1461544845435576115');" onmouseout="out('1461544845435576115');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         LogManager.getLogger(LedgerReader.class);                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     @Autowired                                                                                           </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195     private TransactionRepository dbRepo;                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                                                                                                          </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197     @Value(&quot;${POLL_MS:100}&quot;)                                                                             </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198     private Integer pollMs;                                                                              </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199     @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                       </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200     private String localRoutingNum;                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                                                                                                          </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202     private Thread backgroundThread;                                                                     </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203     private LedgerReaderCallback callback;                                                               </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204     private long latestId = -1;                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     /**                                                                                                  </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207      * LedgerReader setup                                                                                </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208      * Synchronously loads all existing transactions, and then starts                                    </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209      * a background thread to listen for future transactions                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210      *                                                                                                   </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211      * @param callback to process transactions                                                           </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212      * @throws IllegalStateException if callback is null                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213      */                                                                                                  </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214     public void startWithCallback(LedgerReaderCallback callback)                                         </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         throws IllegalStateException {                                                                   </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216         if (callback == null) {                                                                          </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             throw new IllegalStateException(&quot;callback is null&quot;);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         }                                                                                                </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         this.callback = callback;                                                                        </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         // get the latest transaction id in ledger                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         try {                                                                                            </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222             this.latestId = dbRepo.latestId();                                                           </span>
<span class="-4347379741997447063" onmouseenter="enter('-4347379741997447063');" onmouseout="out('-4347379741997447063');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223             LOGGER.debug(String.format(&quot;Transaction starting id: %d&quot;,                                    </span>
<span class="3808341982874512295" onmouseenter="enter('3808341982874512295');" onmouseout="out('3808341982874512295');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224                 latestId));                                                                              </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         } catch (ResourceAccessException                                                                 </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226             | DataAccessResourceFailureException e) {                                                    </span>
<span class="-1245751810711562476" onmouseenter="enter('-1245751810711562476');" onmouseout="out('-1245751810711562476');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227             LOGGER.warn(&quot;Could not contact ledger database at init&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         }                                                                                                </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229         this.backgroundThread = new Thread(new Runnable() {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230             @Override                                                                                    </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231             public void run() {                                                                          </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                 boolean alive = true;                                                                    </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                 while (alive) {                                                                          </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                     // sleep between polls                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                     try {                                                                                </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                         Thread.sleep(pollMs);                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                     } catch (InterruptedException e) {                                                   </span>
<span class="7169745236524536729" onmouseenter="enter('7169745236524536729');" onmouseout="out('7169745236524536729');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238                         LOGGER.warn(&quot;LedgerReader sleep interrupted&quot;);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                     }                                                                                    </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                     // check for new updates in ledger                                                   </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                     Long remoteLatest;                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                     try {                                                                                </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                         remoteLatest = dbRepo.latestId();                                                </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                     } catch (ResourceAccessException                                                     </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                         | DataAccessResourceFailureException e) {                                        </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246                         remoteLatest = latestId;                                                         </span>
<span class="-263918513220140264" onmouseenter="enter('-263918513220140264');" onmouseout="out('-263918513220140264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247                         LOGGER.warn(&quot;Could not reach ledger database&quot;);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248                     }                                                                                    </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                     // if there are new transactions, poll the database                                  </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                     if (remoteLatest &gt; latestId) {                                                       </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251                         latestId = pollTransactions(latestId);                                           </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252                     } else if (remoteLatest &lt; latestId) {                                                </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                         // remote database out of sync                                                   </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                         // suspend processing transactions to reset service                              </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                         alive = false;                                                                   </span>
<span class="8268197514905332991" onmouseenter="enter('8268197514905332991');" onmouseout="out('8268197514905332991');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                         LOGGER.error(&quot;Remote transaction id out of sync&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             }                                                                                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         });                                                                                              </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         LOGGER.info(&quot;Starting background thread.&quot;);                                                      </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         this.backgroundThread.start();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     /**                                                                                                  </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266      * Poll for new transactions                                                                         </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267      * Execute callback for each one                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268      *                                                                                                   </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269      * @param startingId the transaction to start reading after.                                         </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270      *                            -1 = start reading at beginning of the ledger                          </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271      * @return long id of latest transaction processed                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272      */                                                                                                  </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273     private long pollTransactions(long startingId) {                                                     </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         long latestId = startingId;                                                                      </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                           </span>
<span class="-2145483978985294219" onmouseenter="enter('-2145483978985294219');" onmouseout="out('-2145483978985294219');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         LOGGER.debug(&quot;Polling Transactions&quot;);                                                            </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         for (Transaction transaction : transactionList) {                                                </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             callback.processTransaction(transaction);                                                    </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279             latestId = transaction.getTransactionId();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         }                                                                                                </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         return latestId;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     /**                                                                                                  </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285      * Indicates health of LedgerReader                                                                  </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286      * @return false if background thread dies                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287      */                                                                                                  </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     public boolean isAlive() {                                                                           </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         return backgroundThread == null || backgroundThread.isAlive();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 }                                                                                                        </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 292 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span></pre></td>
                            <td><pre><span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style="">   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">   2 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">   4 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  */                                                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21                                                                                                          </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22 package anthos.samples.financedemo.balancereader;                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24                                                                                                          </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import org.apache.logging.log4j.LogManager;                                                              </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import org.apache.logging.log4j.Logger;                                                                  </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.springframework.dao.DataAccessResourceFailureException;                                       </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.springframework.stereotype.Component;                                                         </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.springframework.web.client.ResourceAccessException;                                           </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 /**                                                                                                      </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34  * Defines an interface for reacting to new transactions                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35  *                                                                                                       </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36  * @param accountId    the account associated with the transaction                                       </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37  * @param amount       the amount of change in balance for the account                                   </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38  * @param transaction  the full transaction object                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39  */                                                                                                      </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 interface LedgerReaderCallback {                                                                         </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41     void processTransaction(Transaction transaction);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 }                                                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 /**                                                                                                      </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45  * LedgerReader listens for and reacts to incoming transactions                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46  */                                                                                                      </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 @Component                                                                                               </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 public final class LedgerReader {                                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49                                                                                                          </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50     private static final Logger LOGGER =                                                                 </span>
<span class="1461544845435576115" onmouseenter="enter('1461544845435576115');" onmouseout="out('1461544845435576115');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51         LogManager.getLogger(LedgerReader.class);                                                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53     @Autowired                                                                                           </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54     private TransactionRepository dbRepo;                                                                </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55                                                                                                          </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56     @Value(&quot;${POLL_MS:100}&quot;)                                                                             </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57     private Integer pollMs;                                                                              </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58     @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                       </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59     private String localRoutingNum;                                                                      </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60                                                                                                          </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61     private Thread backgroundThread;                                                                     </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     private LedgerReaderCallback callback;                                                               </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63     private long latestId = -1;                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65     /**                                                                                                  </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66      * LedgerReader setup                                                                                </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67      * Synchronously loads all existing transactions, and then starts                                    </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68      * a background thread to listen for future transactions                                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69      *                                                                                                   </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70      * @param callback to process transactions                                                           </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71      * @throws IllegalStateException if callback is null                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72      */                                                                                                  </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73     public void startWithCallback(LedgerReaderCallback callback)                                         </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74         throws IllegalStateException {                                                                   </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75         if (callback == null) {                                                                          </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76             throw new IllegalStateException(&quot;callback is null&quot;);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77         }                                                                                                </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         this.callback = callback;                                                                        </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79         // get the latest transaction id in ledger                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         try {                                                                                            </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81             this.latestId = dbRepo.latestId();                                                           </span>
<span class="-4347379741997447063" onmouseenter="enter('-4347379741997447063');" onmouseout="out('-4347379741997447063');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82             LOGGER.debug(String.format(&quot;Transaction starting id: %d&quot;,                                    </span>
<span class="3808341982874512295" onmouseenter="enter('3808341982874512295');" onmouseout="out('3808341982874512295');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83                 latestId));                                                                              </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84         } catch (ResourceAccessException                                                                 </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85             | DataAccessResourceFailureException e) {                                                    </span>
<span class="-1245751810711562476" onmouseenter="enter('-1245751810711562476');" onmouseout="out('-1245751810711562476');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86             LOGGER.warn(&quot;Could not contact ledger database at init&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87         }                                                                                                </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88         this.backgroundThread = new Thread(new Runnable() {                                              </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89             @Override                                                                                    </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90             public void run() {                                                                          </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91                 boolean alive = true;                                                                    </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92                 while (alive) {                                                                          </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93                     // sleep between polls                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94                     try {                                                                                </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95                         Thread.sleep(pollMs);                                                            </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96                     } catch (InterruptedException e) {                                                   </span>
<span class="7169745236524536729" onmouseenter="enter('7169745236524536729');" onmouseout="out('7169745236524536729');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97                         LOGGER.warn(&quot;LedgerReader sleep interrupted&quot;);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98                     }                                                                                    </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                     // check for new updates in ledger                                                   </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                     Long remoteLatest;                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101                     try {                                                                                </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102                         remoteLatest = dbRepo.latestId();                                                </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103                     } catch (ResourceAccessException                                                     </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104                         | DataAccessResourceFailureException e) {                                        </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105                         remoteLatest = latestId;                                                         </span>
<span class="-263918513220140264" onmouseenter="enter('-263918513220140264');" onmouseout="out('-263918513220140264');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106                         LOGGER.warn(&quot;Could not reach ledger database&quot;);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107                     }                                                                                    </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                     // if there are new transactions, poll the database                                  </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109                     if (remoteLatest &gt; latestId) {                                                       </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110                         latestId = pollTransactions(latestId);                                           </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111                     } else if (remoteLatest &lt; latestId) {                                                </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                         // remote database out of sync                                                   </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113                         // suspend processing transactions to reset service                              </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114                         alive = false;                                                                   </span>
<span class="8268197514905332991" onmouseenter="enter('8268197514905332991');" onmouseout="out('8268197514905332991');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115                         LOGGER.error(&quot;Remote transaction id out of sync&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118             }                                                                                            </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119         });                                                                                              </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         LOGGER.info(&quot;Starting background thread.&quot;);                                                      </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121         this.backgroundThread.start();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124     /**                                                                                                  </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125      * Poll for new transactions                                                                         </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126      * Execute callback for each one                                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127      *                                                                                                   </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128      * @param startingId the transaction to start reading after.                                         </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129      *                            -1 = start reading at beginning of the ledger                          </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130      * @return long id of latest transaction processed                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131      */                                                                                                  </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132     private long pollTransactions(long startingId) {                                                     </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         long latestId = startingId;                                                                      </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134         Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                           </span>
<span class="-2145483978985294219" onmouseenter="enter('-2145483978985294219');" onmouseout="out('-2145483978985294219');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         LOGGER.debug(&quot;Polling Transactions&quot;);                                                            </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         for (Transaction transaction : transactionList) {                                                </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137             callback.processTransaction(transaction);                                                    </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138             latestId = transaction.getTransactionId();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139         }                                                                                                </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         return latestId;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143     /**                                                                                                  </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144      * Indicates health of LedgerReader                                                                  </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145      * @return false if background thread dies                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146      */                                                                                                  </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147     public boolean isAlive() {                                                                           </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         return backgroundThread == null || backgroundThread.isAlive();                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 }                                                                                                        </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 151 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>











































































































































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   1 -/*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   2 - * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   3 - *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   4 - * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   5 - * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   6 - * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   7 - *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   8 - *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">   9 - *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  10 - * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  11 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  12 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  13 - * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  14 - * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  15 - */                                                                                                               </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  16 -                                                                                                                  </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  17 -package anthos.samples.financedemo.balancereader;                                                                 </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  18 -                                                                                                                  </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  19 -import java.util.logging.Logger;                                                                                  </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  20 -                                                                                                                  </span>


<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  21 -import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  22 -import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  23 -import org.springframework.dao.DataAccessResourceFailureException;                                                </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  24 -import org.springframework.stereotype.Component;                                                                  </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  25 -import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  26 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  27 -/**                                                                                                               </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  28 - * Defines an interface for reacting to new transactions                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  29 - *                                                                                                                </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  30 - * @param accountId    the account associated with the transaction                                                </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  31 - * @param amount       the amount of change in balance for the account                                            </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  32 - * @param transaction  the full transaction object                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  33 - */                                                                                                               </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  34 -interface LedgerReaderCallback {                                                                                  </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  35 -    void processTransaction(Transaction transaction);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  36 -}                                                                                                                 </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  37 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  38 -/**                                                                                                               </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  39 - * LedgerReader listens for and reacts to incoming transactions                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  40 - */                                                                                                               </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  41 -@Component                                                                                                        </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  42 -public final class LedgerReader {                                                                                 </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  43 -                                                                                                                  </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  44 -    private static final Logger LOGGER =                                                                          </span>
<span class="-1980718372906221922" onmouseenter="enter('-1980718372906221922');" onmouseout="out('-1980718372906221922');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  45 -            Logger.getLogger(LedgerReader.class.getName());                                                       </span>

<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  46 -                                                                                                                  </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  47 -    @Autowired                                                                                                    </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  48 -    private TransactionRepository dbRepo;                                                                         </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  49 -                                                                                                                  </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  50 -    @Value(&quot;${POLL_MS:100}&quot;)                                                                                      </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  51 -    private Integer pollMs;                                                                                       </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  52 -    @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                                </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  53 -    private String localRoutingNum;                                                                               </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  54 -                                                                                                                  </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  55 -    private Thread backgroundThread;                                                                              </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  56 -    private LedgerReaderCallback callback;                                                                        </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  57 -    private long latestId = -1;                                                                                   </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  58 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  59 -    /**                                                                                                           </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  60 -     * LedgerReader setup                                                                                         </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  61 -     * Synchronously loads all existing transactions, and then starts                                             </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  62 -     * a background thread to listen for future transactions                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  63 -     *                                                                                                            </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  64 -     * @param callback to process transactions                                                                    </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  65 -     * @throws IllegalStateException if callback is null                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  66 -     */                                                                                                           </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  67 -    public void startWithCallback(LedgerReaderCallback callback)                                                  </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  68 -            throws IllegalStateException {                                                                        </span>

<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  69 -        if (callback == null) {                                                                                   </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  70 -            throw new IllegalStateException(&quot;callback is null&quot;);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  71 -        }                                                                                                         </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  72 -        this.callback = callback;                                                                                 </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  73 -        // get the latest transaction id in ledger                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  74 -        try {                                                                                                     </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  75 -            this.latestId = dbRepo.latestId();                                                                    </span>
<span class="1660469741238238271" onmouseenter="enter('1660469741238238271');" onmouseout="out('1660469741238238271');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  76 -            LOGGER.info(String.format(&quot;starting id: %d&quot;, latestId));                                              </span>


<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  77 -        } catch (ResourceAccessException                                                                          </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  78 -                | DataAccessResourceFailureException e) {                                                         </span>
<span class="7570052869168823836" onmouseenter="enter('7570052869168823836');" onmouseout="out('7570052869168823836');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  79 -            LOGGER.warning(&quot;Could not contact ledger database at init&quot;);                                          </span>


<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  80 -        }                                                                                                         </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  81 -        this.backgroundThread = new Thread(new Runnable() {                                                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  82 -            @Override                                                                                             </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  83 -            public void run() {                                                                                   </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  84 -                boolean alive = true;                                                                             </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  85 -                while (alive) {                                                                                   </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  86 -                    // sleep between polls                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  87 -                    try {                                                                                         </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  88 -                        Thread.sleep(pollMs);                                                                     </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  89 -                    } catch (InterruptedException e) {                                                            </span>
<span class="-7979913707408184769" onmouseenter="enter('-7979913707408184769');" onmouseout="out('-7979913707408184769');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  90 -                        LOGGER.warning(&quot;LedgerReader sleep interrupted&quot;);                                         </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  91 -                    }                                                                                             </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  92 -                    // check for new updates in ledger                                                            </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  93 -                    Long remoteLatest;                                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  94 -                    try {                                                                                         </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  95 -                        remoteLatest = dbRepo.latestId();                                                         </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  96 -                    } catch (ResourceAccessException                                                              </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  97 -                            | DataAccessResourceFailureException e) {                                             </span>

<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  98 -                        remoteLatest = latestId;                                                                  </span>
<span class="-3173504049391420865" onmouseenter="enter('-3173504049391420865');" onmouseout="out('-3173504049391420865');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  99 -                        LOGGER.warning(&quot;Could not reach ledger database&quot;);                                        </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 100 -                    }                                                                                             </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 101 -                    // if there are new transactions, poll the database                                           </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 102 -                    if (remoteLatest &gt; latestId) {                                                                </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 103 -                        latestId = pollTransactions(latestId);                                                    </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 104 -                    } else if (remoteLatest &lt; latestId) {                                                         </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 105 -                        // remote database out of sync                                                            </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 106 -                        // suspend processing transactions to reset service                                       </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 107 -                        alive = false;                                                                            </span>
<span class="-5483040177851640680" onmouseenter="enter('-5483040177851640680');" onmouseout="out('-5483040177851640680');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 108 -                        LOGGER.severe(&quot;remote transaction id out of sync&quot;);                                       </span>

<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 109 -                    }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 110 -                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 111 -            }                                                                                                     </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 112 -        });                                                                                                       </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 113 -        LOGGER.info(&quot;Starting background thread.&quot;);                                                               </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 114 -        this.backgroundThread.start();                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 115 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 116 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 117 -    /**                                                                                                           </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 118 -     * Poll for new transactions                                                                                  </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 119 -     * Execute callback for each one                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 120 -     *                                                                                                            </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 121 -     * @param startingId the transaction to start reading after.                                                  </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 122 -     *                            -1 = start reading at beginning of the ledger                                   </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 123 -     * @return long id of latest transaction processed                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 124 -     */                                                                                                           </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 125 -    private long pollTransactions(long startingId) {                                                              </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 126 -        long latestId = startingId;                                                                               </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 127 -        Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 128 -                                                                                                                  </span>

<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 129 -        for (Transaction transaction : transactionList) {                                                         </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 130 -            callback.processTransaction(transaction);                                                             </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 131 -            latestId = transaction.getTransactionId();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 132 -        }                                                                                                         </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 133 -        return latestId;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 134 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 135 -                                                                                                                  </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 136 -    /**                                                                                                           </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 137 -     * Indicates health of LedgerReader                                                                           </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 138 -     * @return false if background thread dies                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 139 -     */                                                                                                           </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 140 -    public boolean isAlive() {                                                                                    </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 141 -        return backgroundThread == null || backgroundThread.isAlive();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 142 -    }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 143 -}                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-8165146281323437225" onmouseenter="enter('-8165146281323437225');" onmouseout="out('-8165146281323437225');" style="">  17  package anthos.samples.financedemo.balancereader;                                                                 </span>
<span  style="">  18                                                                                                                    </span>
<span class="3887843854525453733" onmouseenter="enter('3887843854525453733');" onmouseout="out('3887843854525453733');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  19 -import java.util.logging.Logger;                                                                                  </span>
<span  style="">  20                                                                                                                    </span>
<span class="-538473715904851717" onmouseenter="enter('-538473715904851717');" onmouseout="out('-538473715904851717');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.logging.log4j.LogManager;                                                                       </span>
<span class="2283937394492695819" onmouseenter="enter('2283937394492695819');" onmouseout="out('2283937394492695819');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.logging.log4j.Logger;                                                                           </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  23  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  24  import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="-8269733313621767487" onmouseenter="enter('-8269733313621767487');" onmouseout="out('-8269733313621767487');" style="">  25  import org.springframework.dao.DataAccessResourceFailureException;                                                </span>
<span class="8406454220154166073" onmouseenter="enter('8406454220154166073');" onmouseout="out('8406454220154166073');" style="">  26  import org.springframework.stereotype.Component;                                                                  </span>
<span class="-7374118861510179828" onmouseenter="enter('-7374118861510179828');" onmouseout="out('-7374118861510179828');" style="">  27  import org.springframework.web.client.ResourceAccessException;                                                    </span>
<span  style="">  28                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  29  /**                                                                                                               </span>
<span class="-2603346662541554264" onmouseenter="enter('-2603346662541554264');" onmouseout="out('-2603346662541554264');" style="">  30   * Defines an interface for reacting to new transactions                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  31   *                                                                                                                </span>
<span class="2425667455854750421" onmouseenter="enter('2425667455854750421');" onmouseout="out('2425667455854750421');" style="">  32   * @param accountId    the account associated with the transaction                                                </span>
<span class="-707543607004765472" onmouseenter="enter('-707543607004765472');" onmouseout="out('-707543607004765472');" style="">  33   * @param amount       the amount of change in balance for the account                                            </span>
<span class="-6937630123915461900" onmouseenter="enter('-6937630123915461900');" onmouseout="out('-6937630123915461900');" style="">  34   * @param transaction  the full transaction object                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  35   */                                                                                                               </span>
<span class="-2851342023627625583" onmouseenter="enter('-2851342023627625583');" onmouseout="out('-2851342023627625583');" style="">  36  interface LedgerReaderCallback {                                                                                  </span>
<span class="6070932891626731533" onmouseenter="enter('6070932891626731533');" onmouseout="out('6070932891626731533');" style="">  37      void processTransaction(Transaction transaction);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  38  }                                                                                                                 </span>
<span  style="">  39                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  40  /**                                                                                                               </span>
<span class="-8776808869188731118" onmouseenter="enter('-8776808869188731118');" onmouseout="out('-8776808869188731118');" style="">  41   * LedgerReader listens for and reacts to incoming transactions                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  42   */                                                                                                               </span>
<span class="6551513213321085161" onmouseenter="enter('6551513213321085161');" onmouseout="out('6551513213321085161');" style="">  43  @Component                                                                                                        </span>
<span class="2744825436123015992" onmouseenter="enter('2744825436123015992');" onmouseout="out('2744825436123015992');" style="">  44  public final class LedgerReader {                                                                                 </span>
<span  style="">  45                                                                                                                    </span>
<span class="673777152962679767" onmouseenter="enter('673777152962679767');" onmouseout="out('673777152962679767');" style="">  46      private static final Logger LOGGER =                                                                          </span>
<span class="-1980718372906221922" onmouseenter="enter('-1980718372906221922');" onmouseout="out('-1980718372906221922');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  47 -            Logger.getLogger(LedgerReader.class.getName());                                                       </span>
<span class="1461544845435576115" onmouseenter="enter('1461544845435576115');" onmouseout="out('1461544845435576115');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +        LogManager.getLogger(LedgerReader.class);                                                                 </span>
<span  style="">  49                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  50      @Autowired                                                                                                    </span>
<span class="7972537590121735174" onmouseenter="enter('7972537590121735174');" onmouseout="out('7972537590121735174');" style="">  51      private TransactionRepository dbRepo;                                                                         </span>
<span  style="">  52                                                                                                                    </span>
<span class="3728991387712256572" onmouseenter="enter('3728991387712256572');" onmouseout="out('3728991387712256572');" style="">  53      @Value(&quot;${POLL_MS:100}&quot;)                                                                                      </span>
<span class="4274607802952053709" onmouseenter="enter('4274607802952053709');" onmouseout="out('4274607802952053709');" style="">  54      private Integer pollMs;                                                                                       </span>
<span class="-8844527204765038125" onmouseenter="enter('-8844527204765038125');" onmouseout="out('-8844527204765038125');" style="">  55      @Value(&quot;${LOCAL_ROUTING_NUM}&quot;)                                                                                </span>
<span class="-8636473471686513279" onmouseenter="enter('-8636473471686513279');" onmouseout="out('-8636473471686513279');" style="">  56      private String localRoutingNum;                                                                               </span>
<span  style="">  57                                                                                                                    </span>
<span class="-5815213647854814844" onmouseenter="enter('-5815213647854814844');" onmouseout="out('-5815213647854814844');" style="">  58      private Thread backgroundThread;                                                                              </span>
<span class="5994566690661918495" onmouseenter="enter('5994566690661918495');" onmouseout="out('5994566690661918495');" style="">  59      private LedgerReaderCallback callback;                                                                        </span>
<span class="-6538241208250808836" onmouseenter="enter('-6538241208250808836');" onmouseout="out('-6538241208250808836');" style="">  60      private long latestId = -1;                                                                                   </span>
<span  style="">  61                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  62      /**                                                                                                           </span>
<span class="-1240272976470834027" onmouseenter="enter('-1240272976470834027');" onmouseout="out('-1240272976470834027');" style="">  63       * LedgerReader setup                                                                                         </span>
<span class="9204540339992148112" onmouseenter="enter('9204540339992148112');" onmouseout="out('9204540339992148112');" style="">  64       * Synchronously loads all existing transactions, and then starts                                             </span>
<span class="199241548056452439" onmouseenter="enter('199241548056452439');" onmouseout="out('199241548056452439');" style="">  65       * a background thread to listen for future transactions                                                      </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  66       *                                                                                                            </span>
<span class="3426427719257383059" onmouseenter="enter('3426427719257383059');" onmouseout="out('3426427719257383059');" style="">  67       * @param callback to process transactions                                                                    </span>
<span class="4059462873365204505" onmouseenter="enter('4059462873365204505');" onmouseout="out('4059462873365204505');" style="">  68       * @throws IllegalStateException if callback is null                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  69       */                                                                                                           </span>
<span class="1521640629773492149" onmouseenter="enter('1521640629773492149');" onmouseout="out('1521640629773492149');" style="">  70      public void startWithCallback(LedgerReaderCallback callback)                                                  </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  71 -            throws IllegalStateException {                                                                        </span>
<span class="-7908472916822081543" onmouseenter="enter('-7908472916822081543');" onmouseout="out('-7908472916822081543');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +        throws IllegalStateException {                                                                            </span>
<span class="-5681834850649759939" onmouseenter="enter('-5681834850649759939');" onmouseout="out('-5681834850649759939');" style="">  73          if (callback == null) {                                                                                   </span>
<span class="-4507282332247252408" onmouseenter="enter('-4507282332247252408');" onmouseout="out('-4507282332247252408');" style="">  74              throw new IllegalStateException(&quot;callback is null&quot;);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75          }                                                                                                         </span>
<span class="8916736318098188490" onmouseenter="enter('8916736318098188490');" onmouseout="out('8916736318098188490');" style="">  76          this.callback = callback;                                                                                 </span>
<span class="-4919632368152318821" onmouseenter="enter('-4919632368152318821');" onmouseout="out('-4919632368152318821');" style="">  77          // get the latest transaction id in ledger                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  78          try {                                                                                                     </span>
<span class="5146793824822757972" onmouseenter="enter('5146793824822757972');" onmouseout="out('5146793824822757972');" style="">  79              this.latestId = dbRepo.latestId();                                                                    </span>
<span class="1660469741238238271" onmouseenter="enter('1660469741238238271');" onmouseout="out('1660469741238238271');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  80 -            LOGGER.info(String.format(&quot;starting id: %d&quot;, latestId));                                              </span>
<span class="-4347379741997447063" onmouseenter="enter('-4347379741997447063');" onmouseout="out('-4347379741997447063');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +            LOGGER.debug(String.format(&quot;Transaction starting id: %d&quot;,                                             </span>
<span class="3808341982874512295" onmouseenter="enter('3808341982874512295');" onmouseout="out('3808341982874512295');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                latestId));                                                                                       </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style="">  83          } catch (ResourceAccessException                                                                          </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  84 -                | DataAccessResourceFailureException e) {                                                         </span>
<span class="7570052869168823836" onmouseenter="enter('7570052869168823836');" onmouseout="out('7570052869168823836');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  85 -            LOGGER.warning(&quot;Could not contact ledger database at init&quot;);                                          </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +            | DataAccessResourceFailureException e) {                                                             </span>
<span class="-1245751810711562476" onmouseenter="enter('-1245751810711562476');" onmouseout="out('-1245751810711562476');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            LOGGER.warn(&quot;Could not contact ledger database at init&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88          }                                                                                                         </span>
<span class="-6210149453538801093" onmouseenter="enter('-6210149453538801093');" onmouseout="out('-6210149453538801093');" style="">  89          this.backgroundThread = new Thread(new Runnable() {                                                       </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  90              @Override                                                                                             </span>
<span class="5292860430507443886" onmouseenter="enter('5292860430507443886');" onmouseout="out('5292860430507443886');" style="">  91              public void run() {                                                                                   </span>
<span class="3088931585334794312" onmouseenter="enter('3088931585334794312');" onmouseout="out('3088931585334794312');" style="">  92                  boolean alive = true;                                                                             </span>
<span class="8368784290626202909" onmouseenter="enter('8368784290626202909');" onmouseout="out('8368784290626202909');" style="">  93                  while (alive) {                                                                                   </span>
<span class="-3061013695649792984" onmouseenter="enter('-3061013695649792984');" onmouseout="out('-3061013695649792984');" style="">  94                      // sleep between polls                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  95                      try {                                                                                         </span>
<span class="5081793179279501714" onmouseenter="enter('5081793179279501714');" onmouseout="out('5081793179279501714');" style="">  96                          Thread.sleep(pollMs);                                                                     </span>
<span class="-7528533024404460182" onmouseenter="enter('-7528533024404460182');" onmouseout="out('-7528533024404460182');" style="">  97                      } catch (InterruptedException e) {                                                            </span>
<span class="-7979913707408184769" onmouseenter="enter('-7979913707408184769');" onmouseout="out('-7979913707408184769');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  98 -                        LOGGER.warning(&quot;LedgerReader sleep interrupted&quot;);                                         </span>
<span class="7169745236524536729" onmouseenter="enter('7169745236524536729');" onmouseout="out('7169745236524536729');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                        LOGGER.warn(&quot;LedgerReader sleep interrupted&quot;);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 100                      }                                                                                             </span>
<span class="-5185469349112636885" onmouseenter="enter('-5185469349112636885');" onmouseout="out('-5185469349112636885');" style=""> 101                      // check for new updates in ledger                                                            </span>
<span class="4402907572659446307" onmouseenter="enter('4402907572659446307');" onmouseout="out('4402907572659446307');" style=""> 102                      Long remoteLatest;                                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 103                      try {                                                                                         </span>
<span class="-834667070584649931" onmouseenter="enter('-834667070584649931');" onmouseout="out('-834667070584649931');" style=""> 104                          remoteLatest = dbRepo.latestId();                                                         </span>
<span class="2761749540388092140" onmouseenter="enter('2761749540388092140');" onmouseout="out('2761749540388092140');" style=""> 105                      } catch (ResourceAccessException                                                              </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 106 -                            | DataAccessResourceFailureException e) {                                             </span>
<span class="1865951837517639890" onmouseenter="enter('1865951837517639890');" onmouseout="out('1865951837517639890');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                        | DataAccessResourceFailureException e) {                                                 </span>
<span class="7352999693300391209" onmouseenter="enter('7352999693300391209');" onmouseout="out('7352999693300391209');" style=""> 108                          remoteLatest = latestId;                                                                  </span>
<span class="-3173504049391420865" onmouseenter="enter('-3173504049391420865');" onmouseout="out('-3173504049391420865');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 109 -                        LOGGER.warning(&quot;Could not reach ledger database&quot;);                                        </span>
<span class="-263918513220140264" onmouseenter="enter('-263918513220140264');" onmouseout="out('-263918513220140264');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                        LOGGER.warn(&quot;Could not reach ledger database&quot;);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111                      }                                                                                             </span>
<span class="-9089843503794139479" onmouseenter="enter('-9089843503794139479');" onmouseout="out('-9089843503794139479');" style=""> 112                      // if there are new transactions, poll the database                                           </span>
<span class="-3689816891695122823" onmouseenter="enter('-3689816891695122823');" onmouseout="out('-3689816891695122823');" style=""> 113                      if (remoteLatest &gt; latestId) {                                                                </span>
<span class="8261529784035427384" onmouseenter="enter('8261529784035427384');" onmouseout="out('8261529784035427384');" style=""> 114                          latestId = pollTransactions(latestId);                                                    </span>
<span class="-8577894593275530648" onmouseenter="enter('-8577894593275530648');" onmouseout="out('-8577894593275530648');" style=""> 115                      } else if (remoteLatest &lt; latestId) {                                                         </span>
<span class="4132231130214211156" onmouseenter="enter('4132231130214211156');" onmouseout="out('4132231130214211156');" style=""> 116                          // remote database out of sync                                                            </span>
<span class="-6262910148822029426" onmouseenter="enter('-6262910148822029426');" onmouseout="out('-6262910148822029426');" style=""> 117                          // suspend processing transactions to reset service                                       </span>
<span class="8540394640203863641" onmouseenter="enter('8540394640203863641');" onmouseout="out('8540394640203863641');" style=""> 118                          alive = false;                                                                            </span>
<span class="-5483040177851640680" onmouseenter="enter('-5483040177851640680');" onmouseout="out('-5483040177851640680');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 119 -                        LOGGER.severe(&quot;remote transaction id out of sync&quot;);                                       </span>
<span class="8268197514905332991" onmouseenter="enter('8268197514905332991');" onmouseout="out('8268197514905332991');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +                        LOGGER.error(&quot;Remote transaction id out of sync&quot;);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123              }                                                                                                     </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 124          });                                                                                                       </span>
<span class="-5111098386296201274" onmouseenter="enter('-5111098386296201274');" onmouseout="out('-5111098386296201274');" style=""> 125          LOGGER.info(&quot;Starting background thread.&quot;);                                                               </span>
<span class="6560749549309788351" onmouseenter="enter('6560749549309788351');" onmouseout="out('6560749549309788351');" style=""> 126          this.backgroundThread.start();                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127      }                                                                                                             </span>
<span  style=""> 128                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 129      /**                                                                                                           </span>
<span class="5709447371209257693" onmouseenter="enter('5709447371209257693');" onmouseout="out('5709447371209257693');" style=""> 130       * Poll for new transactions                                                                                  </span>
<span class="-2087085874825339731" onmouseenter="enter('-2087085874825339731');" onmouseout="out('-2087085874825339731');" style=""> 131       * Execute callback for each one                                                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 132       *                                                                                                            </span>
<span class="-6886264012698294485" onmouseenter="enter('-6886264012698294485');" onmouseout="out('-6886264012698294485');" style=""> 133       * @param startingId the transaction to start reading after.                                                  </span>
<span class="-697651323896995327" onmouseenter="enter('-697651323896995327');" onmouseout="out('-697651323896995327');" style=""> 134       *                            -1 = start reading at beginning of the ledger                                   </span>
<span class="3480732742178386196" onmouseenter="enter('3480732742178386196');" onmouseout="out('3480732742178386196');" style=""> 135       * @return long id of latest transaction processed                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 136       */                                                                                                           </span>
<span class="-6153640955522416042" onmouseenter="enter('-6153640955522416042');" onmouseout="out('-6153640955522416042');" style=""> 137      private long pollTransactions(long startingId) {                                                              </span>
<span class="7111116083021548705" onmouseenter="enter('7111116083021548705');" onmouseout="out('7111116083021548705');" style=""> 138          long latestId = startingId;                                                                               </span>
<span class="4072200314605915448" onmouseenter="enter('4072200314605915448');" onmouseout="out('4072200314605915448');" style=""> 139          Iterable&lt;Transaction&gt; transactionList = dbRepo.findLatest(startingId);                                    </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 140 -                                                                                                                  </span>
<span class="-2145483978985294219" onmouseenter="enter('-2145483978985294219');" onmouseout="out('-2145483978985294219');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        LOGGER.debug(&quot;Polling Transactions&quot;);                                                                     </span>
<span class="6901886234625386515" onmouseenter="enter('6901886234625386515');" onmouseout="out('6901886234625386515');" style=""> 142          for (Transaction transaction : transactionList) {                                                         </span>
<span class="-1121412751836749724" onmouseenter="enter('-1121412751836749724');" onmouseout="out('-1121412751836749724');" style=""> 143              callback.processTransaction(transaction);                                                             </span>
<span class="8273124361688274855" onmouseenter="enter('8273124361688274855');" onmouseout="out('8273124361688274855');" style=""> 144              latestId = transaction.getTransactionId();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145          }                                                                                                         </span>
<span class="6295200359214291366" onmouseenter="enter('6295200359214291366');" onmouseout="out('6295200359214291366');" style=""> 146          return latestId;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147      }                                                                                                             </span>
<span  style=""> 148                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 149      /**                                                                                                           </span>
<span class="2061259443330943540" onmouseenter="enter('2061259443330943540');" onmouseout="out('2061259443330943540');" style=""> 150       * Indicates health of LedgerReader                                                                           </span>
<span class="-1038709994995710076" onmouseenter="enter('-1038709994995710076');" onmouseout="out('-1038709994995710076');" style=""> 151       * @return false if background thread dies                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 152       */                                                                                                           </span>
<span class="-5496966650163379927" onmouseenter="enter('-5496966650163379927');" onmouseout="out('-5496966650163379927');" style=""> 153      public boolean isAlive() {                                                                                    </span>
<span class="-6258950245368096635" onmouseenter="enter('-6258950245368096635');" onmouseout="out('-6258950245368096635');" style=""> 154          return backgroundThread == null || backgroundThread.isAlive();                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            