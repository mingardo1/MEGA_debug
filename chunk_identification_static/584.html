<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>584</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    584
                    <a href="583.html">prev</a>
                    <a href="585.html">next</a>
                    <a href="584_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_3f89d1e66187447b56be7b8b76e9b09af9b9850d_core/src/main/java/com/dtstack/flink/sql/Main.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^1:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^2:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b2e4085e6d35798d51707eb23aa215e0e694591e:core/src/main/java/com/dtstack/flink/sql/Main.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [j], [j], [j], [j]], subset: [[b], [b], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 
  22 
  23 
  24 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  25 import com.dtstack.flink.sql.exec.ParamsInfo;
  26 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  27 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import org.apache.flink.table.api.EnvironmentSettings;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.types.Row;</span>
  34 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 import org.apache.flink.types.Row;</span>
  73 =======
  74 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  75 import org.slf4j.Logger;
  76 import org.slf4j.LoggerFactory;
  77 
  78 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83 import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84 import java.util.List;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85 import java.util.Map;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87 import java.util.Set;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90 </span>
  91 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 import com.dtstack.flink.sql.option.Options;</span>
 142 =======
 143 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 144 /**
 145  * Date: 2018/6/26
 146  * Company: www.dtstack.com
 147  * @author xuchao
 148  */
 149 
 150 public class Main {
 151     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
 152 
 153     public static void main(String[] args) throws Exception {
 154 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         String sql = options.getSql();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         String name = options.getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179         StreamTableEnvironment tableEnv = getStreamTableEnv(env, confProperties);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184         //Get External jar to load</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193         //register udf</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195         //register table schema</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 196         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 196         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197         // cache classPathSets</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206         env.execute(name);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 209     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 209     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTre🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220             boolean isSide = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 226                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 226                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229                     sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233                             isSide = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234                             break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237                     if (isSide) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 239                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache);"> 239                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache)🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242                         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 254     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 254     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261             //classloader</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262             if (classLoader == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 263                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);"> 263                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoade🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 265             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 265             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271      * @param sqlTree</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272      * @param env</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273      * @param tableEnv</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274      * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277      * @param sideTableMap</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278      * @param registerTableCache</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279      * @return</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280      * @throws Exception</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 282     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 282     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnv🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 283                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 283                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 291                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 291                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 293                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 293                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 298                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 298                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301                             return f0.f1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302                         })</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303                         .returns(typeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 308                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 308                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 321                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 321                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 324                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 324                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 325                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 325                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 326                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 326                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 328                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 328                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 331                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 331                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 334                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 334                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340         return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344      *   将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345      * @param env</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346      * @param classPathSet</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 348     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 348     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathS🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349         int i = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353             i++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 357     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 357     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMod🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363         return env;</span>
 364 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369 import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372 import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373 import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380 import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381 import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382 import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384 import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385 import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387 import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394 import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396 import java.net.URLClassLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397 import java.net.URLDecoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407  * Date: 2018/6/26</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412 public class Main {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414     private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416     private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418     private static final Logger LOG = LoggerFactory.getLogger(Main.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421     public static void main(String[] args) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 447         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 447         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461         //register udf</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463         //register table schema</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 464         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 464         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 468         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 468         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         env.execute(name);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 477     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 477     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481             sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 494                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 494                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497                     sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 507                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig);"> 507                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 522     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 522     private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironmen🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523             throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524         // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525         ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526         URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527         List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528         for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529             //classloader</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530             if (classLoader == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 531                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);"> 531                 classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoade🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 533             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 533             FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538      *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539      * @param sqlTree</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540      * @param env</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541      * @param tableEnv</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542      * @param localSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543      * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544      * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545      * @param sideTableMap</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546      * @param registerTableCache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548      * @throws Exception</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 550     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 550     private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnv🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 551                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 551                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 559                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 559                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 561                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 561                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 566                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 566                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; { return f0.f1; })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569                         .returns(typeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 573                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 574                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 574                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 575                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 576                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 577                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 578                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 579 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 580                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 581                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 582                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 587                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 587                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 591                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 591                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 592                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 592                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 593                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 593                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 595                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 595                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 598                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 598                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 601                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 601                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607         return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612      * @param env</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613      * @param classPathSet</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 615     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {"> 615     private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616         int i = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617         for (URL url : classPathSet) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618             String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619             env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620             i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 624     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 624     private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMod🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625         StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626                 StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627                 new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629         StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
 630 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632         ExecuteProcessHelper.setLogLevel(paramsInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634         env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 636 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 637     }
 638 
<abbr title=" 639     private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties confProperties) {"> 639     private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties co🔵</abbr>
 640         // use blink and streammode
 641         EnvironmentSettings settings = EnvironmentSettings.newInstance()
 642                 .useBlinkPlanner()
 643                 .inStreamingMode()
 644                 .build();
 645 
 646         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env, settings);
 647         StreamEnvConfigManager.streamTableEnvironmentStateTTLConfig(tableEnv, confProperties);
 648         return tableEnv;
 649     }
 650 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql;
  21 
  22 
  23 
  24 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  25 import com.dtstack.flink.sql.exec.ParamsInfo;
  26 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  27 import org.apache.flink.table.api.EnvironmentSettings;
  28 import org.slf4j.Logger;
  29 import org.slf4j.LoggerFactory;
  30 
  31 /**
  32  * Date: 2018/6/26
  33  * Company: www.dtstack.com
  34  * @author xuchao
  35  */
  36 
  37 public class Main {
  38     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  39 
  40     public static void main(String[] args) throws Exception {
  41 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45         String sql = options.getSql();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46         String name = options.getName();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51         String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66         StreamTableEnvironment tableEnv = getStreamTableEnv(env, confProperties);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         //Get External jar to load</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         //register udf</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         //register table schema</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  83         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);">  83         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         // cache classPathSets</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93         env.execute(name);</span>
  94 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         String sql = options.getSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         String name = options.getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         String deployMode = options.getMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         String confProp = options.getConfProp();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112             addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116         confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119         StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 120         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 120         StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confP🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         //Get External jar to load</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132         Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         //register udf</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         //register table schema</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 137         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 137         Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPlugi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         // cache classPathSets</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 141         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 141         sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQue🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
 147 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         ExecuteProcessHelper.setLogLevel(paramsInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 153 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 154     }
 155 
 156 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 157     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 157     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTre🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161             sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168             boolean isSide = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 174                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 174                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                     sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                             isSide = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                             break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                     if (isSide) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 187                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache);"> 187                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache)🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                         if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199     }</span>
 200 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 201     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 201     private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209             if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                 LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212             boolean isSide = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213             for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                 if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                     CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                     String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 218                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 218                     SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConf🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                     String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                     tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                     sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                     for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                         if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                             isSide = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                     if (isSide) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                         //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 231                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig);"> 231                         sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                     }else{</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                         FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                         if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235                             LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243     }</span>
 244 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 </span>
 246 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 247 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 248 private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 248 private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnviron🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 249                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 249                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 257                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 257                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 259                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 259                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 264                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 264                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267                             return f0.f1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268                         })</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269                         .returns(typeInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 274                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 274                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 287                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 287                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 290                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 290                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 291                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 291                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 292                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 292                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 294                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 294                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 297                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 297                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 300                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 300                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307     }</span>
 308 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 309 private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 309 private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnviron🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 310                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 310                                           String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312         WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313         for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315             if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317                 SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 318                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 318                 Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319                 tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 320                 //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 320                 //Note --- parameter conversion function can not be used inside a function of the type of🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321                 //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322                 String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323                 Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 325                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 325                 RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327                         .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; { return f0.f1; })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328                         .returns(typeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330                 String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332                 if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 333                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);"> 333                     adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTabl🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                     fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                     fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                 Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                 tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341                 if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342                     LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344                 registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 346                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 346                 URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(),🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347                 pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 350                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 350                 TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSq🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 351                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());"> 351                 TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses()🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 352                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);"> 352                 tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableS🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 354                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 354                 URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), T🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355                 pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356             } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 357                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 357                 String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheTy🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358                 sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 360                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 360                 URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperat🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                 pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                 throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366         return pluginClassPatshSets;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367     }</span>
 368 =======
 369 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 370 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373     /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374      *   将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375      * @param env</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376      * @param classPathSet</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377      */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378 </span>
 379 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383      *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384      * @param env</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385      * @param classPathSet</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387 </span>
 388 =======
 389 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 390 
 391 
<abbr title=" 392     private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties confProperties) {"> 392     private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties co🔵</abbr>
 393         // use blink and streammode
 394         EnvironmentSettings settings = EnvironmentSettings.newInstance()
 395                 .useBlinkPlanner()
 396                 .inStreamingMode()
 397                 .build();
 398 
 399         StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env, settings);
 400         StreamEnvConfigManager.streamTableEnvironmentStateTTLConfig(tableEnv, confProperties);
 401         return tableEnv;
 402     }
 403 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql;
  19 
  20 import com.dtstack.flink.sql.exec.ExecuteProcessHelper;
  21 import com.dtstack.flink.sql.exec.ParamsInfo;
  22 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
  23 import org.apache.flink.table.api.EnvironmentSettings;
  24 import org.slf4j.Logger;
  25 import org.slf4j.LoggerFactory;
  26 
  27 
  28 /**
  29  * Date: 2018/6/26
  30  * Company: www.dtstack.com
  31  * @author xuchao
  32  */
  33 public class Main {
  34     private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  35 
  36     public static void main(String[] args) throws Exception {
  37         ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);
  38         ExecuteProcessHelper.setLogLevel(paramsInfo);
  39         StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);
  40         env.execute(paramsInfo.getName());
  41         LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());
  42     }
  43 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
  22  import com.dtstack.flink.sql.config.CalciteConfig;
  23  import com.dtstack.flink.sql.classloader.ClassLoaderManager;
  24  import com.dtstack.flink.sql.enums.ClusterMode;
  25  import com.dtstack.flink.sql.enums.ECacheType;
  26  import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;
  27  import com.dtstack.flink.sql.environment.StreamEnvConfigManager;
  28  import com.dtstack.flink.sql.exec.FlinkSQLExec;
  29  import com.dtstack.flink.sql.option.OptionParser;
  30  import com.dtstack.flink.sql.parser.CreateFuncParser;
  31  import com.dtstack.flink.sql.parser.CreateTmpTableParser;
  32  import com.dtstack.flink.sql.parser.InsertSqlParser;
  33  import com.dtstack.flink.sql.parser.SqlParser;
  34  import com.dtstack.flink.sql.parser.SqlTree;
  35  import com.dtstack.flink.sql.side.SideSqlExec;
  36  import com.dtstack.flink.sql.side.SideTableInfo;
  37  import com.dtstack.flink.sql.table.SourceTableInfo;
  38  import com.dtstack.flink.sql.table.TableInfo;
  39  import com.dtstack.flink.sql.table.TargetTableInfo;
  40  import com.dtstack.flink.sql.sink.StreamSinkFactory;
  41  import com.dtstack.flink.sql.source.StreamSourceFactory;
  42  import com.dtstack.flink.sql.util.DtStringUtil;
  43  import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;
  44  import com.dtstack.flink.sql.function.FunctionManager;
  45  import com.dtstack.flink.sql.util.PluginUtil;
  46  import org.apache.calcite.sql.SqlInsert;
  47  import org.apache.calcite.sql.SqlNode;
  48  import org.apache.commons.io.Charsets;
  49  import org.apache.flink.api.common.typeinfo.TypeInformation;
  50  import org.apache.flink.api.java.tuple.Tuple2;
  51  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  52  import com.google.common.base.Strings;
  53  import com.google.common.collect.Lists;
  54  import com.google.common.collect.Maps;
  55  import com.google.common.collect.Sets;
  56  import com.fasterxml.jackson.databind.ObjectMapper;
  57  import org.apache.flink.streaming.api.datastream.DataStream;




  58  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -import org.apache.flink.table.api.StreamQueryConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import org.apache.flink.table.api.EnvironmentSettings;</span>
  61  import org.apache.flink.table.api.Table;
  62  import org.apache.flink.table.api.TableEnvironment;
  63  import org.apache.flink.table.api.java.StreamTableEnvironment;
  64  import org.apache.flink.table.sinks.TableSink;
  65  import org.apache.flink.types.Row;
  66  import org.slf4j.Logger;
  67  import org.slf4j.LoggerFactory;
  68  
  69  import java.io.File;
  70  import java.lang.reflect.InvocationTargetException;
  71  import java.net.URL;
  72  import java.net.URLClassLoader;
  73  import java.net.URLDecoder;
  74  import java.util.List;
  75  import java.util.Map;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import java.util.Optional;</span>
  77  import java.util.Properties;
  78  import java.util.Set;
  79  
  80  import com.dtstack.flink.sql.option.Options;
  81  
  82  /**
  83   * Date: 2018/6/26
  84   * Company: www.dtstack.com
  85   * @author xuchao
  86   */
  87  
  88  public class Main {
  89  
  90      private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;
  91  
  92      private static final ObjectMapper objMapper = new ObjectMapper();
  93  
  94      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  95  
  96  
  97      public static void main(String[] args) throws Exception {
  98  
  99          OptionParser optionParser = new OptionParser(args);
 100          Options options = optionParser.getOptions();
 101          String sql = options.getSql();
 102          String name = options.getName();
 103          String addJarListStr = options.getAddjar();
 104          String localSqlPluginPath = options.getLocalSqlPluginPath();
 105          String remoteSqlPluginPath = options.getRemoteSqlPluginPath();
 106          String pluginLoadMode = options.getPluginLoadMode();
 107          String deployMode = options.getMode();
 108          String confProp = options.getConfProp();
 109  
 110          sql = URLDecoder.decode(sql, Charsets.UTF_8.name());
 111          SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);
 112  
 113          List&lt;String&gt; addJarFileList = Lists.newArrayList();
 114          if (!Strings.isNullOrEmpty(addJarListStr)) {
 115              addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());
 116              addJarFileList = objMapper.readValue(addJarListStr, List.class);
 117          }
 118  
 119          confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());
 120          Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);
 121          StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 123 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 123 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        StreamTableEnvironment tableEnv = getStreamTableEnv(env, confProperties);</span>
 125  
 126          List&lt;URL&gt; jarURList = Lists.newArrayList();
 127          SqlTree sqlTree = SqlParser.parseSql(sql);
 128  
 129          //Get External jar to load
 130          for (String addJarPath : addJarFileList) {
 131              File tmpFile = new File(addJarPath);
 132              jarURList.add(tmpFile.toURI().toURL());
 133          }
 134  
 135          Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();
 136          Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();
 137  
 138          //register udf
 139          registerUserDefinedFunction(sqlTree, jarURList, tableEnv);
 140          //register table schema
<abbr title=" 141          Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 141          Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr>
 142          // cache classPathSets
 143          registerPluginUrlToCachedFile(env, classPathSets);
 144  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 145 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 145 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache);</span>
 147  
 148          if (env instanceof MyLocalStreamEnvironment) {
 149              ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());
 150          }
 151  
 152          env.execute(name);
 153      }
 154  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 155 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 155 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 156 +    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 156 +    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv, SqlTree sqlTree🔵</abbr></span>
 157          SideSqlExec sideSqlExec = new SideSqlExec();
 158          sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);
 159          for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {
 160              sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);
 161          }
 162  
 163          for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {
 164              if (LOG.isInfoEnabled()) {
 165                  LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());
 166              }
 167              boolean isSide = false;
 168              for (String tableName : result.getTargetTableList()) {
 169                  if (sqlTree.getTmpTableMap().containsKey(tableName)) {
 170                      CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);
 171                      String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);
 172  
<abbr title=" 173                      SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 173                      SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr>
 174                      String tmpSql = ((SqlInsert) sqlNode).getSource().toString();
 175                      tmp.setExecSql(tmpSql);
 176                      sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);
 177                  } else {
 178                      for (String sourceTable : result.getSourceTableList()) {
 179                          if (sideTableMap.containsKey(sourceTable)) {
 180                              isSide = true;
 181                              break;
 182                          }
 183                      }
 184                      if (isSide) {
 185                          //sql-dimensional table contains the dimension table of execution
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig);"> 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        if(LOG.isInfoEnabled()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +                    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +                        if (LOG.isInfoEnabled()) {</span>
 194                              LOG.info(&quot;exec sql: &quot; + result.getExecSql());
 195                          }
 196                      }
 197                  }
 198              }
 199          }
 200  
 201  
 202      }
 203  
 204  
<abbr title=" 205      private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 205      private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr>
 206              throws IllegalAccessException, InvocationTargetException {
 207          // udf和tableEnv须由同一个类加载器加载
 208          ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();
 209          URLClassLoader classLoader = null;
 210          List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();
 211          for (CreateFuncParser.SqlParserResult funcInfo : funcList) {
 212              //classloader
 213              if (classLoader == null) {
 214                  classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);
 215              }
<abbr title=" 216              FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 216              FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr>
 217          }
 218      }
 219  
 220      /**
 221       *    向Flink注册源表和结果表，返回执行时插件包的全路径
 222       * @param sqlTree
 223       * @param env
 224       * @param tableEnv
 225       * @param localSqlPluginPath
 226       * @param remoteSqlPluginPath
 227       * @param pluginLoadMode   插件加载模式 classpath or shipfile
 228       * @param sideTableMap
 229       * @param registerTableCache
 230       * @return
 231       * @throws Exception
 232       */
<abbr title=" 233      private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 233      private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr>
<abbr title=" 234                                            String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 234                                            String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr>
 235          Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();
 236          WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();
 237          for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {
 238  
 239              if (tableInfo instanceof SourceTableInfo) {
 240  
 241                  SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;
<abbr title=" 242                  Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 242                  Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr>
 243                  tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);
<abbr title=" 244                  //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 244                  //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr>
 245                  //Create table in which the function is arranged only need adaptation sql
 246                  String adaptSql = sourceTableInfo.getAdaptSelectSql();
 247                  Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);
 248  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 249 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 249 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 250 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchema().getFieldNames());"> 250 +                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getFieldTypes(), adaptTable.getSchem🔵</abbr></span>
 251                  DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; { return f0.f1; })</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +                            return f0.f1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +                        })</span>
 256                          .returns(typeInfo);
 257  
 258                  String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());
 259  
 260                  if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {
 261                      adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);
 262                      fields += &quot;,ROWTIME.ROWTIME&quot;;
 263                  } else {
 264                      fields += &quot;,PROCTIME.PROCTIME&quot;;
 265                  }
 266  
 267                  Table regTable = tableEnv.fromDataStream(adaptStream, fields);
 268                  tableEnv.registerTable(tableInfo.getName(), regTable);
 269                  if (LOG.isInfoEnabled()) {
 270                      LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());
 271                  }
 272                  registerTableCache.put(tableInfo.getName(), regTable);
 273  
<abbr title=" 274                  URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 274                  URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr>
 275                  pluginClassPatshSets.add(sourceTablePathUrl);
 276              } else if (tableInfo instanceof TargetTableInfo) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -</span>
<abbr title=" 278                  TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 278                  TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr>
 279                  TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());
 280                  tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);
 281  
<abbr title=" 282                  URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 282                  URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr>
 283                  pluginClassPatshSets.add(sinkTablePathUrl);
 284              } else if (tableInfo instanceof SideTableInfo) {
<abbr title=" 285                  String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 285                  String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr>
 286                  sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);
 287  
<abbr title=" 288                  URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 288                  URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr>
 289                  pluginClassPatshSets.add(sideTablePathUrl);
 290              } else {
 291                  throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());
 292              }
 293          }
 294          return pluginClassPatshSets;
 295      }
 296  
 297      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +     *   将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>
 300       * @param env
 301       * @param classPathSet
 302       */
 303      private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {
 304          int i = 0;
 305          for (URL url : classPathSet) {
 306              String classFileName = String.format(CLASS_FILE_NAME_FMT, i);
 307              env.registerCachedFile(url.getPath(), classFileName, true);
 308              i++;
 309          }
 310      }
 311  
<abbr title=" 312      private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 312      private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr>
 313          StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?
 314                  StreamExecutionEnvironment.getExecutionEnvironment() :
 315                  new MyLocalStreamEnvironment();
 316  
 317          StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);
 318          return env;





 319      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 321 +    private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties confProperties) {"> 321 +    private static StreamTableEnvironment getStreamTableEnv(StreamExecutionEnvironment env, Properties confPropert🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +        // use blink and streammode</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +        EnvironmentSettings settings = EnvironmentSettings.newInstance()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +                .useBlinkPlanner()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +                .inStreamingMode()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +                .build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env, settings);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +        StreamEnvConfigManager.streamTableEnvironmentStateTTLConfig(tableEnv, confProperties);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        return tableEnv;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +    }</span>
 332  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql;
  21  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.config.CalciteConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.classloader.ClassLoaderManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.dtstack.flink.sql.enums.ClusterMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.dtstack.flink.sql.enums.ECacheType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.dtstack.flink.sql.environment.MyLocalStreamEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.dtstack.flink.sql.environment.StreamEnvConfigManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.dtstack.flink.sql.exec.FlinkSQLExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.dtstack.flink.sql.option.OptionParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.dtstack.flink.sql.parser.CreateFuncParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.dtstack.flink.sql.parser.CreateTmpTableParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.dtstack.flink.sql.parser.InsertSqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.dtstack.flink.sql.parser.SqlParser;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import com.dtstack.flink.sql.parser.SqlTree;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import com.dtstack.flink.sql.side.SideSqlExec;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import com.dtstack.flink.sql.side.SideTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import com.dtstack.flink.sql.table.SourceTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.dtstack.flink.sql.table.TableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import com.dtstack.flink.sql.table.TargetTableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import com.dtstack.flink.sql.sink.StreamSinkFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import com.dtstack.flink.sql.source.StreamSourceFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import com.dtstack.flink.sql.util.DtStringUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.dtstack.flink.sql.watermarker.WaterMarkerAssigner;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import com.dtstack.flink.sql.function.FunctionManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.dtstack.flink.sql.util.PluginUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import org.apache.calcite.sql.SqlInsert;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.apache.calcite.sql.SqlNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.apache.commons.io.Charsets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -import com.google.common.collect.Sets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +import com.dtstack.flink.sql.exec.ExecuteProcessHelper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import com.dtstack.flink.sql.exec.ParamsInfo;</span>
  62  import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -import org.apache.flink.table.api.StreamQueryConfig;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import org.apache.flink.table.api.Table;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import org.apache.flink.table.api.TableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import org.apache.flink.table.api.java.StreamTableEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -import org.apache.flink.types.Row;</span>
  69  import org.slf4j.Logger;
  70  import org.slf4j.LoggerFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -import java.lang.reflect.InvocationTargetException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -import java.net.URLClassLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -import java.net.URLDecoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -import java.util.Optional;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -import com.dtstack.flink.sql.option.Options;</span>
  84  
  85  /**
  86   * Date: 2018/6/26
  87   * Company: www.dtstack.com
  88   * @author xuchao
  89   */
  90  
  91  public class Main {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -    private static final String CLASS_FILE_NAME_FMT = &quot;class_path_%d&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    private static final ObjectMapper objMapper = new ObjectMapper();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -</span>
  97      private static final Logger LOG = LoggerFactory.getLogger(Main.class);
  98  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -</span>
 100      public static void main(String[] args) throws Exception {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        OptionParser optionParser = new OptionParser(args);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        Options options = optionParser.getOptions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        String sql = options.getSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        String name = options.getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        String addJarListStr = options.getAddjar();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        String localSqlPluginPath = options.getLocalSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        String remoteSqlPluginPath = options.getRemoteSqlPluginPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        String pluginLoadMode = options.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        String deployMode = options.getMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        String confProp = options.getConfProp();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        sql = URLDecoder.decode(sql, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        SqlParser.setLocalSqlPluginRoot(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        List&lt;String&gt; addJarFileList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -        if (!Strings.isNullOrEmpty(addJarListStr)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            addJarListStr = URLDecoder.decode(addJarListStr, Charsets.UTF_8.name());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            addJarFileList = objMapper.readValue(addJarListStr, List.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        confProp = URLDecoder.decode(confProp, Charsets.UTF_8.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        Properties confProperties = PluginUtil.jsonStrToObject(confProp, Properties.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        StreamExecutionEnvironment env = getStreamExeEnv(confProperties, deployMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        StreamTableEnvironment tableEnv =  StreamTableEnvironment.getTableEnvironment(env);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 126 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties);"> 126 -        StreamQueryConfig streamQueryConfig = StreamEnvConfigManager.getStreamQueryConfig(tableEnv, confProperties🔵</abbr></span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        List&lt;URL&gt; jarURList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        SqlTree sqlTree = SqlParser.parseSql(sql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        //Get External jar to load</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        for (String addJarPath : addJarFileList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            File tmpFile = new File(addJarPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            jarURList.add(tmpFile.toURI().toURL());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        Map&lt;String, SideTableInfo&gt; sideTableMap = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        Map&lt;String, Table&gt; registerTableCache = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        //register udf</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        registerUserDefinedFunction(sqlTree, jarURList, tableEnv);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        //register table schema</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 143 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode, sideTableMap, registerTableCache);"> 143 -        Set&lt;URL&gt; classPathSets = registerTable(sqlTree, env, tableEnv, localSqlPluginPath, remoteSqlPluginPath, pl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        // cache classPathSets</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        registerPluginUrlToCachedFile(env, classPathSets);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 147 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig);"> 147 -        sqlTranslation(localSqlPluginPath, tableEnv, sqlTree, sideTableMap, registerTableCache, streamQueryConfig)🔵</abbr></span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        if (env instanceof MyLocalStreamEnvironment) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            ((MyLocalStreamEnvironment) env).setClasspaths(ClassLoaderManager.getClassPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        env.execute(name);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,Map&lt;String, SideTableInfo&gt; sideTableMap,Map&lt;String, Table&gt; registerTableCache, StreamQueryConfig queryConfig) throws Exception {"> 156 -    private static void sqlTranslation(String localSqlPluginPath, StreamTableEnvironment tableEnv,SqlTree sqlTree,🔵</abbr></span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        SideSqlExec sideSqlExec = new SideSqlExec();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        sideSqlExec.setLocalSqlPluginPath(localSqlPluginPath);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        for (CreateTmpTableParser.SqlParserResult result : sqlTree.getTmpSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -            sideSqlExec.registerTmpTable(result, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        for (InsertSqlParser.SqlParseResult result : sqlTree.getExecSqlList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                LOG.info(&quot;exe-sql:\n&quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            boolean isSide = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            for (String tableName : result.getTargetTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -                if (sqlTree.getTmpTableMap().containsKey(tableName)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                    CreateTmpTableParser.SqlParserResult tmp = sqlTree.getTmpTableMap().get(tableName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    String realSql = DtStringUtil.replaceIgnoreQuota(result.getExecSql(), &quot;`&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 173 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_LEX_CONFIG).parseStmt();"> 173 -                    SqlNode sqlNode = org.apache.calcite.sql.parser.SqlParser.create(realSql, CalciteConfig.MYSQL_🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -                    String tmpSql = ((SqlInsert) sqlNode).getSource().toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                    tmp.setExecSql(tmpSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                    sideSqlExec.registerTmpTable(tmp, sideTableMap, tableEnv, registerTableCache);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -                    for (String sourceTable : result.getSourceTableList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -                        if (sideTableMap.containsKey(sourceTable)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -                            isSide = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    if (isSide) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                        //sql-dimensional table contains the dimension table of execution</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryConfig);"> 186 -                        sideSqlExec.exec(result.getExecSql(), sideTableMap, tableEnv, registerTableCache, queryCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                    }else{</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -                        FlinkSQLExec.sqlUpdate(tableEnv, result.getExecSql(), queryConfig);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                        if(LOG.isInfoEnabled()){</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                            LOG.info(&quot;exec sql: &quot; + result.getExecSql());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 201 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEnv)"> 201 -    private static void registerUserDefinedFunction(SqlTree sqlTree, List&lt;URL&gt; jarURList, TableEnvironment tableEn🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -            throws IllegalAccessException, InvocationTargetException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        // udf和tableEnv须由同一个类加载器加载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        ClassLoader levelClassLoader = tableEnv.getClass().getClassLoader();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        URLClassLoader classLoader = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        List&lt;CreateFuncParser.SqlParserResult&gt; funcList = sqlTree.getFunctionList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        for (CreateFuncParser.SqlParserResult funcInfo : funcList) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -            //classloader</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -            if (classLoader == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                classLoader = ClassLoaderManager.loadExtraJar(jarURList, (URLClassLoader) levelClassLoader);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 212 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv, classLoader);"> 212 -            FunctionManager.registerUDF(funcInfo.getType(), funcInfo.getClassName(), funcInfo.getName(), tableEnv,🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -     *    向Flink注册源表和结果表，返回执行时插件包的全路径</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -     * @param sqlTree</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -     * @param tableEnv</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -     * @param localSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -     * @param remoteSqlPluginPath</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -     * @param pluginLoadMode   插件加载模式 classpath or shipfile</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -     * @param sideTableMap</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -     * @param registerTableCache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -     * @throws Exception</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 229 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment tableEnv, String localSqlPluginPath,"> 229 -    private static Set&lt;URL&gt; registerTable(SqlTree sqlTree, StreamExecutionEnvironment env, StreamTableEnvironment 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 230 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTableInfo&gt; sideTableMap, Map&lt;String, Table&gt; registerTableCache) throws Exception {"> 230 -                                          String remoteSqlPluginPath, String pluginLoadMode, Map&lt;String, SideTable🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -        Set&lt;URL&gt; pluginClassPatshSets = Sets.newHashSet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        WaterMarkerAssigner waterMarkerAssigner = new WaterMarkerAssigner();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -        for (TableInfo tableInfo : sqlTree.getTableInfoMap().values()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -            if (tableInfo instanceof SourceTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -                SourceTableInfo sourceTableInfo = (SourceTableInfo) tableInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 238 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPath);"> 238 -                Table table = StreamSourceFactory.getStreamSource(sourceTableInfo, env, tableEnv, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -                tableEnv.registerTable(sourceTableInfo.getAdaptName(), table);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 240 -                //Note --- parameter conversion function can not be used inside a function of the type of polymerization"> 240 -                //Note --- parameter conversion function can not be used inside a function of the type of polymeri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -                //Create table in which the function is arranged only need adaptation sql</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                String adaptSql = sourceTableInfo.getAdaptSelectSql();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                Table adaptTable = adaptSql == null ? table : tableEnv.sqlQuery(adaptSql);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 245 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().getColumnNames());"> 245 -                RowTypeInfo typeInfo = new RowTypeInfo(adaptTable.getSchema().getTypes(), adaptTable.getSchema().g🔵</abbr></span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                DataStream adaptStream = tableEnv.toRetractStream(adaptTable, typeInfo)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                        .map((Tuple2&lt;Boolean, Row&gt; f0) -&gt; { return f0.f1; })</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                        .returns(typeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                String fields = String.join(&quot;,&quot;, typeInfo.getFieldNames());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                if (waterMarkerAssigner.checkNeedAssignWaterMarker(sourceTableInfo)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                    adaptStream = waterMarkerAssigner.assignWaterMarker(adaptStream, typeInfo, sourceTableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                    fields += &quot;,ROWTIME.ROWTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                    fields += &quot;,PROCTIME.PROCTIME&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                Table regTable = tableEnv.fromDataStream(adaptStream, fields);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                tableEnv.registerTable(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                if (LOG.isInfoEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                    LOG.info(&quot;registe table {} success.&quot;, tableInfo.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                registerTableCache.put(tableInfo.getName(), regTable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 266 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTableInfo.SOURCE_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 266 -                URL sourceTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), SourceTa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                pluginClassPatshSets.add(sourceTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -            } else if (tableInfo instanceof TargetTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 270 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPath);"> 270 -                TableSink tableSink = StreamSinkFactory.getTableSink((TargetTableInfo) tableInfo, localSqlPluginPa🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -                TypeInformation[] flinkTypes = FunctionManager.transformTypes(tableInfo.getFieldClasses());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                tableEnv.registerTableSink(tableInfo.getName(), tableInfo.getFields(), flinkTypes, tableSink);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 274 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 274 -                URL sinkTablePathUrl = PluginUtil.buildSourceAndSinkPathByLoadMode(tableInfo.getType(), TargetTabl🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -                pluginClassPatshSets.add(sinkTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -            } else if (tableInfo instanceof SideTableInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 277 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;all&quot; : &quot;async&quot;;"> 277 -                String sideOperator = ECacheType.ALL.name().equals(((SideTableInfo) tableInfo).getCacheType()) ? &quot;🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                sideTableMap.put(tableInfo.getName(), (SideTableInfo) tableInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 280 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideTableInfo.TARGET_SUFFIX, localSqlPluginPath, remoteSqlPluginPath, pluginLoadMode);"> 280 -                URL sideTablePathUrl = PluginUtil.buildSidePathByLoadMode(tableInfo.getType(), sideOperator, SideT🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -                pluginClassPatshSets.add(sideTablePathUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                throw new RuntimeException(&quot;not support table type:&quot; + tableInfo.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        return pluginClassPatshSets;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -     *   perjob模式将job依赖的插件包路径存储到cacheFile，在外围将插件包路径传递给jobgraph</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -     * @param env</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -     * @param classPathSet</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -    private static void registerPluginUrlToCachedFile(StreamExecutionEnvironment env, Set&lt;URL&gt; classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        int i = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -        for (URL url : classPathSet) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -            String classFileName = String.format(CLASS_FILE_NAME_FMT, i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -            env.registerCachedFile(url.getPath(), classFileName, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -            i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 303 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws Exception {"> 303 -    private static StreamExecutionEnvironment getStreamExeEnv(Properties confProperties, String deployMode) throws🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -        StreamExecutionEnvironment env = !ClusterMode.local.name().equals(deployMode) ?</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -                StreamExecutionEnvironment.getExecutionEnvironment() :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -                new MyLocalStreamEnvironment();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -        StreamEnvConfigManager.streamExecutionEnvironmentConfig(env, confProperties);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        return env;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        ParamsInfo paramsInfo = ExecuteProcessHelper.parseParams(args);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +        ExecuteProcessHelper.setLogLevel(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        StreamExecutionEnvironment env = ExecuteProcessHelper.getStreamExecution(paramsInfo);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +        env.execute(paramsInfo.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +        LOG.info(&quot;program {} execution success&quot;, paramsInfo.getName());</span>
 315      }












 316  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            