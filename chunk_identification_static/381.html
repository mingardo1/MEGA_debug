<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>381</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    381
                    <a href="380.html">prev</a>
                    <a href="382.html">next</a>
                    <a href="381_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    ElderDrivers/EdXposedManager_924ba015084b453119f7832b3c573e2ebb16c4d2_app/src/main/java/de/robv/android/xposed/installer/InstallerFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\ElderDrivers\EdXposedManager show &quot;924ba015084b453119f7832b3c573e2ebb16c4d2:app/src/main/java/de/robv/android/xposed/installer/InstallerFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\ElderDrivers\EdXposedManager show &quot;924ba015084b453119f7832b3c573e2ebb16c4d2^1:app/src/main/java/de/robv/android/xposed/installer/InstallerFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\ElderDrivers\EdXposedManager show &quot;924ba015084b453119f7832b3c573e2ebb16c4d2^2:app/src/main/java/de/robv/android/xposed/installer/InstallerFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\ElderDrivers\EdXposedManager show &quot;75f65c1fd73caec3a839dbe82ba397e6260dff42:app/src/main/java/de/robv/android/xposed/installer/InstallerFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package de.robv.android.xposed.installer;
   2 
   3 import static android.content.Context.MODE_PRIVATE;
   4 import static de.robv.android.xposed.installer.XposedApp.WRITE_EXTERNAL_PERMISSION;
   5 import static de.robv.android.xposed.installer.util.XposedZip.Installer;
   6 import static de.robv.android.xposed.installer.util.XposedZip.Uninstaller;
   7 
   8 import android.Manifest;
   9 import android.annotation.TargetApi;
  10 import android.app.Activity;
  11 import android.content.Context;
  12 import android.content.DialogInterface;
  13 import android.content.Intent;
  14 import android.content.SharedPreferences;
  15 import android.content.pm.PackageManager;
  16 import android.net.Uri;
  17 import android.os.AsyncTask;
  18 import android.os.Build;
  19 import android.os.Bundle;
  20 import android.os.Environment;
  21 import android.os.Looper;
  22 import android.os.ParcelFileDescriptor;
  23 import android.support.annotation.NonNull;
  24 import android.support.v4.app.ActivityCompat;
  25 import android.support.v4.app.Fragment;
  26 import android.support.v7.widget.CardView;
  27 import android.system.Os;
  28 import android.text.Html;
  29 import android.text.TextUtils;
  30 import android.util.Log;
  31 import android.view.LayoutInflater;
  32 import android.view.Menu;
  33 import android.view.MenuInflater;
  34 import android.view.MenuItem;
  35 import android.view.View;
  36 import android.view.ViewGroup;
  37 import android.widget.Button;
  38 import android.widget.CheckBox;
  39 import android.widget.ImageView;
  40 import android.widget.ProgressBar;
  41 import android.widget.Spinner;
  42 import android.widget.TextView;
  43 import android.widget.Toast;
  44 
  45 import com.afollestad.materialdialogs.MaterialDialog;
  46 
  47 import java.io.BufferedReader;
  48 import java.io.File;
  49 import java.io.IOException;
  50 import java.io.InputStreamReader;
  51 import java.math.BigInteger;
  52 import java.net.HttpURLConnection;
  53 import java.net.MalformedURLException;
  54 import java.net.URL;
  55 import java.util.ArrayList;
  56 import java.util.LinkedList;
  57 import java.util.List;
  58 import java.util.Locale;
  59 
  60 import org.json.JSONArray;
  61 import org.json.JSONObject;
  62 
  63 import de.robv.android.xposed.installer.util.AssetUtil;
  64 import de.robv.android.xposed.installer.util.DownloadsUtil;
  65 import de.robv.android.xposed.installer.util.NavUtil;
  66 import de.robv.android.xposed.installer.util.NotificationUtil;
  67 import de.robv.android.xposed.installer.util.RootUtil;
  68 import de.robv.android.xposed.installer.util.ThemeUtil;
  69 import de.robv.android.xposed.installer.util.XposedZip;
  70 
  71 public class InstallerFragment extends Fragment
  72 		implements ActivityCompat.OnRequestPermissionsResultCallback,
  73 		DownloadsUtil.DownloadFinishedCallback {
  74 	public static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;
  75 	private static final int INSTALL_MODE_NORMAL = 0;
  76 	private static final int INSTALL_MODE_RECOVERY_AUTO = 1;
  77 	private static final int INSTALL_MODE_RECOVERY_MANUAL = 2;
<abbr title="  78 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposed.json&quot;;">  78 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/materialðŸ”µ</abbr>
  79 	private static List&lt;String&gt; messages = new LinkedList&lt;&gt;();
  80 	private static ArrayList&lt;Installer&gt; installers;
  81 	private static ArrayList&lt;Uninstaller&gt; uninstallers;
  82 	private final LinkedList&lt;String&gt; mCompatibilityErrors = new LinkedList&lt;&gt;();
  83 	private String APP_PROCESS_NAME = null;
  84 	private RootUtil mRootUtil = new RootUtil();
  85 	private boolean mHadSegmentationFault = false;
  86 	private MaterialDialog.Builder dlgProgress;
  87 	private TextView txtInstallError, txtKnownIssue;
  88 	private Button btnInstall, btnUninstall;
  89 	private ProgressBar mInstallersLoading;
  90 	private Spinner mInstallersChooser;
  91 	private ProgressBar mUninstallersLoading;
  92 	private Spinner mUninstallersChooser;
  93 	private ImageView mInfoInstaller, mInfoUninstaller;
  94 	private String newApkVersion = XposedApp.THIS_APK_VERSION;
  95 	private String newApkLink;
  96 	private String newApkChangelog;
  97 	private CardView mUpdateView;
  98 	private Button mUpdateButton;
  99 	private TextView mInstallForbidden;
 100 	private ImageView mInfoUpdate;
 101 
 102 	private static int extractIntPart(String str) {
 103 		int result = 0, length = str.length();
 104 		for (int offset = 0; offset &lt; length; offset++) {
 105 			char c = str.charAt(offset);
 106 			if (&#x27;0&#x27; &lt;= c &amp;&amp; c &lt;= &#x27;9&#x27;)
 107 				result = result * 10 + (c - &#x27;0&#x27;);
 108 			else
 109 				break;
 110 		}
 111 		return result;
 112 	}
 113 
 114 	private static boolean checkClassExists(String className) {
 115 		try {
 116 			Class.forName(className);
 117 			return true;
 118 		} catch (ClassNotFoundException e) {
 119 			return false;
 120 		}
 121 	}
 122 
 123 	public static ArrayList&lt;Installer&gt; getInstallersBySdk(int sdk) {
 124 		ArrayList&lt;Installer&gt; list = new ArrayList&lt;&gt;();
 125 		for (Installer i : installers) {
 126 			if (i.sdk == sdk)
 127 				list.add(i);
 128 		}
 129 
 130 		if (list.size() == 0) {
 131 			list.add(new Installer());
 132 		}
 133 		return list;
 134 	}
 135 
 136 	/*
 137 	 * public static ArrayList&lt;Installer&gt; getInstallersBySdkAndArchitecture( int
 138 	 * sdk, String architecture) { ArrayList&lt;Installer&gt; list = new
 139 	 * ArrayList&lt;&gt;(); ArrayList&lt;Installer&gt; list2 = new ArrayList&lt;&gt;(); for
 140 	 * (Installer i : installers) { if (i.sdk == sdk) list.add(i); } for
 141 	 * (Installer i : list) { if (i.architecture.equals(architecture))
 142 	 * list2.add(i); } return list2; }
 143 	 *
 144 	 * public static ArrayList&lt;Uninstaller&gt; getUninstallersByArchitecture(
 145 	 * String architecture) { ArrayList&lt;Uninstaller&gt; list = new ArrayList&lt;&gt;();
 146 	 * for (Uninstaller u : uninstallers) { if
 147 	 * (u.architecture.equals(architecture)) list.add(u); } return list; }
 148 	 */
 149 
 150 	@Override
 151 	public void onActivityCreated(Bundle savedInstanceState) {
 152 		super.onActivityCreated(savedInstanceState);
 153 		Activity activity = getActivity();
 154 
 155 		dlgProgress = new MaterialDialog.Builder(activity).progress(true, 0);
 156 		setHasOptionsMenu(true);
 157 	}
 158 
 159 	@Override
 160 	public View onCreateView(LayoutInflater inflater, ViewGroup container,
 161 			Bundle savedInstanceState) {
 162 		View v = inflater.inflate(R.layout.tab_installer, container, false);
 163 
 164 		txtInstallError = (TextView) v
 165 				.findViewById(R.id.framework_install_errors);
 166 		txtKnownIssue = (TextView) v.findViewById(R.id.framework_known_issue);
 167 
 168 		btnInstall = (Button) v.findViewById(R.id.btnInstall);
 169 		btnUninstall = (Button) v.findViewById(R.id.btnUninstall);
 170 
 171 		mInstallersLoading = (ProgressBar) v
 172 				.findViewById(R.id.loadingInstallers);
 173 		mUninstallersLoading = (ProgressBar) v
 174 				.findViewById(R.id.loadingUninstallers);
 175 		mInstallersChooser = (Spinner) v.findViewById(R.id.chooserInstallers);
 176 		mUninstallersChooser = (Spinner) v
 177 				.findViewById(R.id.chooserUninstallers);
 178 		mUpdateView = (CardView) v.findViewById(R.id.updateView);
 179 		mUpdateButton = (Button) v.findViewById(R.id.updateButton);
 180 
 181 		mInfoInstaller = (ImageView) v.findViewById(R.id.infoInstaller);
 182 		mInfoUninstaller = (ImageView) v.findViewById(R.id.infoUninstaller);
 183 
 184 		mInstallForbidden = (TextView) v
 185 				.findViewById(R.id.installationForbidden);
 186 		mInfoUpdate = (ImageView) v.findViewById(R.id.infoUpdate);
 187 
 188 		String installedXposedVersion = XposedApp.getXposedProp()
 189 				.get(&quot;version&quot;);
 190 
 191 		if (Build.VERSION.SDK_INT &gt;= 21) {
 192 			if (installedXposedVersion == null) {
 193 				txtInstallError.setText(R.string.installation_lollipop);
 194 				txtInstallError
 195 						.setTextColor(getResources().getColor(R.color.warning));
 196 			} else {
 197 				int installedXposedVersionInt = extractIntPart(
 198 						installedXposedVersion);
 199 				if (installedXposedVersionInt == XposedApp.getXposedVersion()) {
 200 					txtInstallError
 201 							.setText(getString(R.string.installed_lollipop,
 202 									installedXposedVersion));
 203 					txtInstallError.setTextColor(
 204 							getResources().getColor(R.color.darker_green));
 205 				} else {
 206 					txtInstallError.setText(
 207 							getString(R.string.installed_lollipop_inactive,
 208 									installedXposedVersion));
 209 					txtInstallError.setTextColor(
 210 							getResources().getColor(R.color.warning));
 211 				}
 212 			}
 213 		} else {
 214 			if (XposedApp.getXposedVersion() != 0) {
 215 				txtInstallError.setText(getString(R.string.installed_lollipop,
 216 						XposedApp.getXposedVersion()));
 217 				txtInstallError.setTextColor(
 218 						getResources().getColor(R.color.darker_green));
 219 			} else {
 220 				txtInstallError
 221 						.setText(getString(R.string.not_installed_no_lollipop));
 222 				txtInstallError
 223 						.setTextColor(getResources().getColor(R.color.warning));
 224 			}
 225 		}
 226 
 227 		txtInstallError.setVisibility(View.VISIBLE);
 228 
 229 		if (!XposedApp.getPreferences().getBoolean(&quot;hide_install_warning&quot;,
 230 				false)) {
 231 			final View dontShowAgainView = inflater
 232 					.inflate(R.layout.dialog_install_warning, null);
 233 
 234 			new MaterialDialog.Builder(getActivity())
 235 					.title(R.string.install_warning_title)
 236 					.customView(dontShowAgainView, false)
 237 					.positiveText(android.R.string.ok)
 238 					.callback(new MaterialDialog.ButtonCallback() {
 239 						@Override
 240 						public void onPositive(MaterialDialog dialog) {
 241 							super.onPositive(dialog);
 242 							CheckBox checkBox = (CheckBox) dontShowAgainView
 243 									.findViewById(android.R.id.checkbox);
 244 							if (checkBox.isChecked())
 245 								XposedApp.getPreferences().edit().putBoolean(
 246 										&quot;hide_install_warning&quot;, true).apply();
 247 						}
 248 					}).cancelable(false).show();
 249 		}
 250 
 251 		new JSONParser(JSON_LINK).execute();
 252 
 253 		mInfoInstaller.setOnClickListener(new View.OnClickListener() {
 254 			@Override
 255 			public void onClick(View v) {
 256 				Installer selectedInstaller = (Installer) mInstallersChooser
 257 						.getSelectedItem();
 258 				String s = getString(R.string.infoInstaller,
 259 						selectedInstaller.name, selectedInstaller.sdk,
 260 						selectedInstaller.architecture,
 261 						selectedInstaller.version);
 262 
 263 				new MaterialDialog.Builder(getContext()).title(R.string.info)
 264 						.content(s).positiveText(android.R.string.ok).show();
 265 			}
 266 		});
 267 		mInfoUninstaller.setOnClickListener(new View.OnClickListener() {
 268 			@Override
 269 			public void onClick(View v) {
 270 				Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 271 						.getSelectedItem();
 272 				String s = getString(R.string.infoUninstaller,
 273 						selectedUninstaller.name,
 274 						selectedUninstaller.architecture,
 275 						selectedUninstaller.date);
 276 
 277 				new MaterialDialog.Builder(getContext()).title(R.string.info)
 278 						.content(s).positiveText(android.R.string.ok).show();
 279 			}
 280 		});
 281 
 282 		btnInstall.setOnClickListener(new View.OnClickListener() {
 283 			@Override
 284 			public void onClick(View v) {
 285 				if (write())
 286 					return;
 287 
 288 				areYouSure(R.string.warningArchitecture,
 289 						new MaterialDialog.ButtonCallback() {
 290 					@Override
 291 					public void onPositive(MaterialDialog dialog) {
 292 						super.onPositive(dialog);
 293 
 294 						Installer selectedInstaller = (Installer) mInstallersChooser
 295 								.getSelectedItem();
 296 
 297 						DownloadsUtil.add(getContext(), selectedInstaller.name,
 298 								selectedInstaller.link, InstallerFragment.this,
 299 								DownloadsUtil.MIME_TYPES.ZIP, true);
 300 					}
 301 				});
 302 			}
 303 		});
 304 
 305 		btnUninstall.setOnClickListener(new View.OnClickListener() {
 306 			@Override
 307 			public void onClick(View v) {
 308 				if (write())
 309 					return;
 310 				areYouSure(R.string.warningArchitecture,
 311 						new MaterialDialog.ButtonCallback() {
 312 					@Override
 313 					public void onPositive(MaterialDialog dialog) {
 314 						super.onPositive(dialog);
 315 
 316 						Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 317 								.getSelectedItem();
 318 
 319 						DownloadsUtil.add(getContext(),
 320 								selectedUninstaller.name,
 321 								selectedUninstaller.link,
 322 								InstallerFragment.this,
 323 								DownloadsUtil.MIME_TYPES.ZIP, true);
 324 					}
 325 				});
 326 			}
 327 		});
 328 
 329 		return v;
 330 	}
 331 
 332 	@Override
 333 	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 334 		inflater.inflate(R.menu.menu_installer, menu);
 335 	}
 336 
 337 	@Override
 338 	public boolean onOptionsItemSelected(MenuItem item) {
 339 
 340 		switch (item.getItemId()) {
 341 			case R.id.help:
 342 				new MaterialDialog.Builder(getContext()).title(R.string.help)
 343 						.content(R.string.helpChoose)
 344 						.positiveText(android.R.string.ok).show();
 345 				break;
 346 			case R.id.installation_mode:
 347 				Intent intent = new Intent(getActivity(),
 348 						SettingsActivity.class);
 349 				startActivity(intent);
 350 				break;
 351 			case R.id.reboot:
 352 				areYouSure(R.string.reboot,
 353 						new MaterialDialog.ButtonCallback() {
 354 							@Override
 355 							public void onPositive(MaterialDialog dialog) {
 356 								super.onPositive(dialog);
 357 								reboot(null);
 358 							}
 359 						});
 360 				break;
 361 			case R.id.soft_reboot:
 362 				areYouSure(R.string.reboot,
 363 						new MaterialDialog.ButtonCallback() {
 364 							@Override
 365 							public void onPositive(MaterialDialog dialog) {
 366 								super.onPositive(dialog);
 367 								softReboot();
 368 							}
 369 						});
 370 				break;
 371 		}
 372 
 373 		return super.onOptionsItemSelected(item);
 374 	}
 375 
 376 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 377 	public void performFileSearch() {
 378 		Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 379 		intent.addCategory(Intent.CATEGORY_OPENABLE);
 380 		intent.setType(&quot;application/zip&quot;);
 381 		startActivityForResult(intent, 123);
 382 	}
 383 
 384 	@Override
 385 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 386 	public void onActivityResult(int requestCode, int resultCode,
 387 			Intent resultData) {
 388 		if (requestCode == 123 &amp;&amp; resultCode == Activity.RESULT_OK) {
 389 			if (resultData != null) {
 390 				Uri uri = resultData.getData();
 391 				String resolved = null;
 392 				try (ParcelFileDescriptor fd = getActivity()
 393 						.getContentResolver().openFileDescriptor(uri, &quot;r&quot;)) {
 394 					final File procfsFdFile = new File(
 395 							&quot;/proc/self/fd/&quot; + fd.getFd());
 396 
 397 					resolved = Os.readlink(procfsFdFile.getAbsolutePath());
 398 
 399 					if (TextUtils.isEmpty(resolved) || resolved.charAt(0) != &#x27;/&#x27;
 400 							|| resolved.startsWith(&quot;/proc/&quot;)
 401 							|| resolved.startsWith(&quot;/fd/&quot;))
 402 						;
 403 				} catch (Exception errnoe) {
 404 					Log.e(XposedApp.TAG, &quot;ReadError&quot;);
 405 				}
 406 				mRootUtil.execute(&quot;cp &quot; + resolved + &quot; /cache/xposed.zip&quot;,
 407 						messages);
 408 				installXposedZip();
 409 			}
 410 		}
 411 	}
 412 
 413 	private void installXposedZip() {
 414 		mRootUtil.execute(
 415 				&quot;echo &#x27;install /cache/xposed.zip&#x27; &gt;/cache/recovery/openrecoveryscript &quot;,
 416 				messages);
 417 		mRootUtil.execute(&quot;sync&quot;, messages);
 418 		reboot(&quot;recovery&quot;);
 419 	}
 420 
 421 	@Override
 422 	public void onRequestPermissionsResult(int requestCode,
 423 			@NonNull String[] permissions, @NonNull int[] grantResults) {
 424 		if (requestCode == WRITE_EXTERNAL_PERMISSION) {
 425 			if (grantResults.length == 1
 426 					&amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {
 427 				Toast.makeText(getActivity(), R.string.permissionGranted,
 428 						Toast.LENGTH_LONG).show();
 429 			} else {
 430 				Toast.makeText(getActivity(), R.string.permissionNotGranted,
 431 						Toast.LENGTH_LONG).show();
 432 			}
 433 		} else {
 434 			super.onRequestPermissionsResult(requestCode, permissions,
 435 					grantResults);
 436 		}
 437 	}
 438 
 439 	private boolean write() {
 440 		if (ActivityCompat.checkSelfPermission(getContext(),
 441 				Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
 442 
 443 			ActivityCompat.requestPermissions(getActivity(),
 444 					new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE },
 445 					WRITE_EXTERNAL_PERMISSION);
 446 
 447 			return true;
 448 		} else {
 449 			return false;
 450 		}
 451 	}
 452 
 453 	@Override
 454 	public void onResume() {
 455 		super.onResume();
 456 		NotificationUtil.cancel(NotificationUtil.NOTIFICATION_MODULES_UPDATED);
 457 		mHadSegmentationFault = false;
 458 		refreshKnownIssue();
 459 	}
 460 
 461 	@Override
 462 	public void onDestroy() {
 463 		super.onDestroy();
 464 		mRootUtil.dispose();
 465 	}
 466 
 467 	private String versionToText(int version) {
 468 		return (version == 0) ? getString(R.string.none)
 469 				: Integer.toString(version);
 470 	}
 471 
 472 	private void refreshKnownIssue() {
 473 		String issueName = null;
 474 		String issueLink = null;
 475 
 476 		if (new File(&quot;/system/framework/core.jar.jex&quot;).exists()) {
 477 			issueName = &quot;Aliyun OS&quot;;
 478 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52289793&amp;postcount=5&quot;;
 479 
 480 		} else if (new File(&quot;/data/miui/DexspyInstaller.jar&quot;).exists()
 481 				|| checkClassExists(&quot;miui.dexspy.DexspyInstaller&quot;)) {
 482 			issueName = &quot;MIUI/Dexspy&quot;;
 483 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52291098&amp;postcount=6&quot;;
 484 
 485 		} else if (mHadSegmentationFault) {
 486 			issueName = &quot;Segmentation fault&quot;;
 487 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52292102&amp;postcount=7&quot;;
 488 
 489 		} else
 490 			if (checkClassExists(&quot;com.huawei.android.content.res.ResourcesEx&quot;)
 491 					|| checkClassExists(&quot;android.content.res.NubiaResources&quot;)) {
 492 			issueName = &quot;Resources subclass&quot;;
 493 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52801382&amp;postcount=8&quot;;
 494 		}
 495 
 496 		if (issueName != null) {
 497 			final String issueLinkFinal = issueLink;
 498 			txtKnownIssue.setText(
 499 					getString(R.string.install_known_issue, issueName));
 500 			txtKnownIssue.setVisibility(View.VISIBLE);
 501 			txtKnownIssue.setOnClickListener(new View.OnClickListener() {
 502 				@Override
 503 				public void onClick(View v) {
 504 					NavUtil.startURL(getActivity(), issueLinkFinal);
 505 				}
 506 			});
 507 
 508 			txtInstallError.setTextColor(ThemeUtil.getThemeColor(getActivity(),
 509 					android.R.attr.textColorTertiary));
 510 		} else {
 511 			txtKnownIssue.setVisibility(View.GONE);
 512 		}
 513 	}
 514 
 515 	private void showAlert(final String result) {
 516 		if (Looper.myLooper() != Looper.getMainLooper()) {
 517 			getActivity().runOnUiThread(new Runnable() {
 518 				@Override
 519 				public void run() {
 520 					showAlert(result);
 521 				}
 522 			});
 523 			return;
 524 		}
 525 
 526 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 527 				.content(result).positiveText(android.R.string.ok).build();
 528 		dialog.show();
 529 
 530 		TextView txtMessage = (TextView) dialog
 531 				.findViewById(android.R.id.message);
 532 		try {
 533 			txtMessage.setTextSize(14);
 534 		} catch (NullPointerException ignored) {
 535 		}
 536 
 537 		mHadSegmentationFault = result.toLowerCase(Locale.US)
 538 				.contains(&quot;segmentation fault&quot;);
 539 		refreshKnownIssue();
 540 	}
 541 
 542 	private void areYouSure(int messageTextId,
 543 			MaterialDialog.ButtonCallback yesHandler) {
 544 		new MaterialDialog.Builder(getActivity()).title(messageTextId)
 545 				.content(R.string.areyousure)
 546 				.iconAttr(android.R.attr.alertDialogIcon)
 547 				.positiveText(android.R.string.yes)
 548 				.negativeText(android.R.string.no).callback(yesHandler).show();
 549 	}
 550 
 551 	private void showConfirmDialog(final String message,
 552 			final MaterialDialog.ButtonCallback callback) {
 553 		if (Looper.myLooper() != Looper.getMainLooper()) {
 554 			getActivity().runOnUiThread(new Runnable() {
 555 				@Override
 556 				public void run() {
 557 					showConfirmDialog(message, callback);
 558 				}
 559 			});
 560 			return;
 561 		}
 562 
 563 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 564 				.content(message).positiveText(android.R.string.yes)
 565 				.negativeText(android.R.string.no).callback(callback).build();
 566 
 567 		TextView txtMessage = (TextView) dialog
 568 				.findViewById(android.R.id.message);
 569 		txtMessage.setTextSize(14);
 570 
 571 		mHadSegmentationFault = message.toLowerCase(Locale.US)
 572 				.contains(&quot;segmentation fault&quot;);
 573 		refreshKnownIssue();
 574 	}
 575 
 576 	private boolean checkCompatibility() {
 577 		mCompatibilityErrors.clear();
 578 		return checkAppProcessCompatibility();
 579 	}
 580 
 581 	private boolean checkAppProcessCompatibility() {
 582 		try {
 583 			if (APP_PROCESS_NAME == null)
 584 				return false;
 585 
 586 			File testFile = AssetUtil.writeAssetToCacheFile(APP_PROCESS_NAME,
 587 					&quot;app_process&quot;, 00700);
 588 			if (testFile == null) {
 589 				mCompatibilityErrors
 590 						.add(&quot;could not write app_process to cache&quot;);
 591 				return false;
 592 			}
 593 
 594 			Process p = Runtime.getRuntime().exec(new String[] {
 595 					testFile.getAbsolutePath(), &quot;--xposedversion&quot; });
 596 
 597 			BufferedReader stdout = new BufferedReader(
 598 					new InputStreamReader(p.getInputStream()));
 599 			String result = stdout.readLine();
 600 			stdout.close();
 601 
 602 			BufferedReader stderr = new BufferedReader(
 603 					new InputStreamReader(p.getErrorStream()));
 604 			String errorLine;
 605 			while ((errorLine = stderr.readLine()) != null) {
 606 				mCompatibilityErrors.add(errorLine);
 607 			}
 608 			stderr.close();
 609 
 610 			p.destroy();
 611 
 612 			testFile.delete();
 613 			return result != null &amp;&amp; result.startsWith(&quot;Xposed version: &quot;);
 614 		} catch (IOException e) {
 615 			mCompatibilityErrors.add(e.getMessage());
 616 			return false;
 617 		}
 618 	}
 619 
 620 	private boolean startShell() {
 621 		if (mRootUtil.startShell())
 622 			return true;
 623 
 624 		showAlert(getString(R.string.root_failed));
 625 		return false;
 626 	}
 627 
 628 	private int getInstallMode() {
 629 		int mode = XposedApp.getPreferences().getInt(&quot;install_mode&quot;,
 630 				INSTALL_MODE_NORMAL);
 631 		if (mode &lt; INSTALL_MODE_NORMAL || mode &gt; INSTALL_MODE_RECOVERY_MANUAL)
 632 			mode = INSTALL_MODE_NORMAL;
 633 		return mode;
 634 	}
 635 
 636 	private String getInstallModeText() {
 637 		final int installMode = getInstallMode();
 638 		switch (installMode) {
 639 			case INSTALL_MODE_NORMAL:
 640 				return getString(R.string.install_mode_normal);
 641 			case INSTALL_MODE_RECOVERY_AUTO:
 642 				return getString(R.string.install_mode_recovery_auto);
 643 			case INSTALL_MODE_RECOVERY_MANUAL:
 644 				return getString(R.string.install_mode_recovery_manual);
 645 		}
 646 		throw new IllegalStateException(&quot;unknown install mode &quot; + installMode);
 647 	}
 648 
 649 	private boolean prepareAutoFlash(List&lt;String&gt; messages, String file) {
 650 		if (mRootUtil.execute(&quot;ls /cache/recovery&quot;, null) != 0) {
 651 			messages.add(getString(R.string.file_creating_directory,
 652 					&quot;/cache/recovery&quot;));
 653 			if (mRootUtil.executeWithBusybox(&quot;mkdir /cache/recovery&quot;,
 654 					messages) != 0) {
 655 				messages.add(&quot;&quot;);
 656 				messages.add(getString(R.string.file_create_directory_failed,
 657 						&quot;/cache/recovery&quot;));
 658 				return false;
 659 			}
 660 		}
 661 
 662 		messages.add(getString(R.string.file_copying, file));
 663 		File tempFile = AssetUtil.writeAssetToCacheFile(file, 00644);
 664 		if (tempFile == null) {
 665 			messages.add(&quot;&quot;);
 666 			messages.add(getString(R.string.file_extract_failed, file));
 667 			return false;
 668 		}
 669 
 670 		if (mRootUtil.executeWithBusybox(&quot;cp -a &quot; + tempFile.getAbsolutePath()
 671 				+ &quot; /cache/recovery/&quot; + file, messages) != 0) {
 672 			messages.add(&quot;&quot;);
 673 			messages.add(getString(R.string.file_copy_failed, file, &quot;/cache&quot;));
 674 			tempFile.delete();
 675 			return false;
 676 		}
 677 
 678 		tempFile.delete();
 679 
 680 		messages.add(getString(R.string.file_writing_recovery_command));
 681 		if (mRootUtil.execute(
 682 				&quot;echo \&quot;--update_package=/cache/recovery/&quot; + file
 683 						+ &quot;\n--show_text\&quot; &gt; /cache/recovery/command&quot;,
 684 				messages) != 0) {
 685 			messages.add(&quot;&quot;);
 686 			messages.add(
 687 					getString(R.string.file_writing_recovery_command_failed));
 688 			return false;
 689 		}
 690 
 691 		return true;
 692 	}
 693 
 694 	private boolean prepareManualFlash(List&lt;String&gt; messages, String file) {
 695 		messages.add(getString(R.string.file_copying, file));
 696 		if (AssetUtil.writeAssetToSdcardFile(file, 00644) == null) {
 697 			messages.add(&quot;&quot;);
 698 			messages.add(getString(R.string.file_extract_failed, file));
 699 			return false;
 700 		}
 701 
 702 		return true;
 703 	}
 704 
 705 	private void offerReboot(List&lt;String&gt; messages) {
 706 		messages.add(getString(R.string.file_done));
 707 		messages.add(&quot;&quot;);
 708 		messages.add(getString(R.string.reboot_confirmation));
 709 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 710 				new MaterialDialog.ButtonCallback() {
 711 					@Override
 712 					public void onPositive(MaterialDialog dialog) {
 713 						super.onPositive(dialog);
 714 						reboot(null);
 715 					}
 716 				});
 717 	}
 718 
 719 	private void offerRebootToRecovery(List&lt;String&gt; messages, final String file,
 720 			final int installMode) {
 721 		if (installMode == INSTALL_MODE_RECOVERY_AUTO)
 722 			messages.add(getString(R.string.auto_flash_note, file));
 723 		else
 724 			messages.add(getString(R.string.manual_flash_note, file));
 725 
 726 		messages.add(&quot;&quot;);
 727 		messages.add(getString(R.string.reboot_recovery_confirmation));
 728 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 729 				new MaterialDialog.ButtonCallback() {
 730 					@Override
 731 					public void onPositive(MaterialDialog dialog) {
 732 						super.onPositive(dialog);
 733 						reboot(&quot;recovery&quot;);
 734 					}
 735 
 736 					@Override
 737 					public void onNegative(MaterialDialog dialog) {
 738 						super.onNegative(dialog);
 739 						if (installMode == INSTALL_MODE_RECOVERY_AUTO) {
 740 							// clean up to avoid unwanted flashing
 741 							mRootUtil.executeWithBusybox(
 742 									&quot;rm /cache/recovery/command&quot;, null);
 743 							mRootUtil.executeWithBusybox(
 744 									&quot;rm /cache/recovery/&quot; + file, null);
 745 							AssetUtil.removeBusybox();
 746 						}
 747 					}
 748 				}
 749 
 750 		);
 751 	}
 752 
 753 	private void softReboot() {
 754 		if (!startShell())
 755 			return;
 756 
 757 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 758 		if (mRootUtil.execute(
 759 				&quot;setprop ctl.restart surfaceflinger; setprop ctl.restart zygote&quot;,
 760 				messages) != 0) {
 761 			messages.add(&quot;&quot;);
 762 			messages.add(getString(R.string.reboot_failed));
 763 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 764 		}
 765 	}
 766 
 767 	private void reboot(String mode) {
 768 		if (!startShell())
 769 			return;
 770 
 771 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 772 
 773 		String command = &quot;reboot&quot;;
 774 		if (mode != null) {
 775 			command += &quot; &quot; + mode;
 776 			if (mode.equals(&quot;recovery&quot;))
 777 				// create a flag used by some kernels to boot into recovery
 778 				mRootUtil.executeWithBusybox(&quot;touch /cache/recovery/boot&quot;,
 779 						messages);
 780 		}
 781 
 782 		if (mRootUtil.executeWithBusybox(command, messages) != 0) {
 783 			messages.add(&quot;&quot;);
 784 			messages.add(getString(R.string.reboot_failed));
 785 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 786 		}
 787 		AssetUtil.removeBusybox();
 788 	}
 789 
 790 	@Override
 791 	public void onDownloadFinished(final Context context,
 792 			DownloadsUtil.DownloadInfo info) {
 793 		Toast.makeText(context,
 794 				getString(R.string.downloadZipOk, info.localFilename),
 795 				Toast.LENGTH_LONG).show();
 796 
 797 		if (getInstallMode() == INSTALL_MODE_RECOVERY_MANUAL)
 798 			return;
 799 
 800 		areYouSure(R.string.install_warning,
 801 				new MaterialDialog.ButtonCallback() {
 802 					@Override
 803 					public void onPositive(MaterialDialog dialog) {
 804 						super.onPositive(dialog);
 805 						Toast.makeText(context, R.string.selectFile,
 806 								Toast.LENGTH_LONG).show();
 807 
 808 						performFileSearch();
 809 					}
 810 				});
 811 	}
 812 
 813 	private abstract class AsyncClickListener implements View.OnClickListener {
 814 		private final CharSequence mProgressDlgText;
 815 
 816 		public AsyncClickListener(CharSequence progressDlgText) {
 817 			mProgressDlgText = progressDlgText;
 818 		}
 819 
 820 		@Override
 821 		public final void onClick(final View v) {
 822 			if (mProgressDlgText != null) {
 823 				dlgProgress.content(mProgressDlgText);
 824 				dlgProgress.show();
 825 			}
 826 			new Thread() {
 827 				public void run() {
 828 					onAsyncClick(v);
 829 					dlgProgress.build().dismiss();
 830 				}
 831 			}.start();
 832 		}
 833 
 834 		protected abstract void onAsyncClick(View v);
 835 	}
 836 
 837 	private abstract class AsyncDialogClickListener
 838 			implements DialogInterface.OnClickListener {
 839 		private final CharSequence mProgressDlgText;
 840 
 841 		public AsyncDialogClickListener(CharSequence progressDlgText) {
 842 			mProgressDlgText = progressDlgText;
 843 		}
 844 
 845 		@Override
 846 		public void onClick(final DialogInterface dialog, final int which) {
 847 			if (mProgressDlgText != null) {
 848 				dlgProgress.content(mProgressDlgText);
 849 				dlgProgress.show();
 850 			}
 851 			new Thread() {
 852 				public void run() {
 853 					onAsyncClick(dialog, which);
 854 					dlgProgress.build().dismiss();
 855 				}
 856 			}.start();
 857 		}
 858 
 859 		protected abstract void onAsyncClick(DialogInterface dialog, int which);
 860 	}
 861 
 862 	private class JSONParser extends AsyncTask&lt;Void, Void, Boolean&gt; {
 863 		private URL mUrl;
 864 
 865 		public JSONParser(String mUrl) {
 866 			try {
 867 				this.mUrl = new URL(mUrl);
 868 			} catch (MalformedURLException e) {
 869 				e.printStackTrace();
 870 			}
 871 		}
 872 
 873 		@Override
 874 		protected void onPreExecute() {
 875 			super.onPreExecute();
 876 
 877 			mInstallersLoading.setVisibility(View.VISIBLE);
 878 			mUninstallersLoading.setVisibility(View.VISIBLE);
 879 			mInfoInstaller.setVisibility(View.GONE);
 880 			mInfoUninstaller.setVisibility(View.GONE);
 881 		}
 882 
 883 		@Override
 884 		protected Boolean doInBackground(Void... params) {
 885 			try {
 886 				HttpURLConnection c = (HttpURLConnection) mUrl.openConnection();
 887 				c.setRequestMethod(&quot;GET&quot;);
 888 				c.setDoOutput(true);
 889 				c.connect();
 890 
 891 				BufferedReader br = new BufferedReader(
 892 						new InputStreamReader(c.getInputStream()));
 893 				StringBuilder sb = new StringBuilder();
 894 				String line;
 895 				while ((line = br.readLine()) != null) {
 896 					sb.append(line).append(&quot;\n&quot;);
 897 				}
 898 				br.close();
 899 
 900 				JSONObject json = new JSONObject(sb.toString());
 901 				JSONArray installerArray = json.getJSONArray(&quot;installer&quot;);
 902 				JSONArray uninstallerArray = json.getJSONArray(&quot;uninstaller&quot;);
 903 
 904 				installers = new ArrayList&lt;&gt;();
 905 				uninstallers = new ArrayList&lt;&gt;();
 906 
 907 				for (int i = 0; i &lt; installerArray.length(); i++) {
 908 					JSONObject jsonObject = installerArray.getJSONObject(i);
 909 
 910 					String link = jsonObject.getString(&quot;link&quot;);
 911 					String name = jsonObject.getString(&quot;name&quot;);
 912 					String architecture = jsonObject.getString(&quot;architecture&quot;);
 913 					String version = jsonObject.getString(&quot;version&quot;);
 914 					int sdk = jsonObject.getInt(&quot;sdk&quot;);
 915 
 916 					installers.add(new XposedZip.Installer(link, name,
 917 							architecture, sdk, version));
 918 				}
 919 
 920 				if (Build.VERSION.SDK_INT &gt;= 21) {
 921 					for (int i = 0; i &lt; uninstallerArray.length(); i++) {
 922 						JSONObject jsonObject = uninstallerArray
 923 								.getJSONObject(i);
 924 
 925 						String link = jsonObject.getString(&quot;link&quot;);
 926 						String name = jsonObject.getString(&quot;name&quot;);
 927 						String architecture = jsonObject
 928 								.getString(&quot;architecture&quot;);
 929 						String date = jsonObject.getString(&quot;date&quot;);
 930 
 931 						uninstallers.add(new Uninstaller(link, name,
 932 								architecture, date));
 933 					}
 934 				} else {
 935 					uninstallers.add(new Uninstaller());
 936 				}
 937 
 938 				newApkVersion = json.getJSONObject(&quot;apk&quot;).getString(&quot;version&quot;);
 939 				newApkLink = json.getJSONObject(&quot;apk&quot;).getString(&quot;link&quot;);
 940 				newApkChangelog = json.getJSONObject(&quot;apk&quot;)
 941 						.getString(&quot;changelog&quot;);
 942 				return true;
 943 			} catch (Exception e) {
 944 				e.printStackTrace();
 945 				return false;
 946 			}
 947 		}
 948 
 949 		@Override
 950 		protected void onPostExecute(Boolean result) {
 951 			super.onPostExecute(result);
 952 
 953 			btnInstall.setEnabled(result);
 954 			btnUninstall.setEnabled(result);
 955 
 956 			mInstallersLoading.setVisibility(View.GONE);
 957 			mUninstallersLoading.setVisibility(View.GONE);
 958 
 959 			int i = result ? View.VISIBLE : View.GONE;
 960 
 961 			mInstallersChooser.setVisibility(i);
 962 			mUninstallersChooser.setVisibility(i);
 963 
 964 			mInfoInstaller.setVisibility(i);
 965 			mInfoUninstaller.setVisibility(i);
 966 
 967 			if (Build.VERSION.SDK_INT &lt; 21) {
 968 				btnInstall.setEnabled(false);
 969 				btnUninstall.setEnabled(false);
 970 				mInfoInstaller.setEnabled(false);
 971 				mInfoUninstaller.setEnabled(false);
 972 				mInstallersChooser.setEnabled(false);
 973 				mUninstallersChooser.setEnabled(false);
 974 
 975 				mInstallForbidden.setVisibility(View.VISIBLE);
 976 			}
 977 
 978 			try {
 979 
 980 				if (!result) {
 981 					Toast.makeText(getContext(), R.string.loadingError,
 982 							Toast.LENGTH_LONG).show();
 983 					return;
 984 				}
 985 
 986 				mInstallersChooser
 987 						.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(),
 988 								getInstallersBySdk(Build.VERSION.SDK_INT)));
 989 
 990 				mUninstallersChooser.setAdapter(
 991 						new XposedZip.MyAdapter&lt;&gt;(getContext(), uninstallers));
 992 
 993 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 994 			} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 995 			}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 996 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 997 			if (newApkChangelog != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 998 				mInfoUpdate.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 999 					@Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1000 					public void onClick(View v) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1001 						new MaterialDialog.Builder(getContext())</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1002 								.title(R.string.changes)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1003 								.content(Html.fromHtml(newApkChangelog))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1004 								.positiveText(android.R.string.ok).show();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1005 					}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1006 				});</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1007 			} else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1008 				mInfoUpdate.setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1009 			}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1010 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1011 			if (newApkVersion == null)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1012 				return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1013 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1014 			SharedPreferences prefs = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1015 			try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1016 				prefs = getContext().getSharedPreferences(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1017 						getContext().getPackageName() + &quot;_preferences&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1018 						MODE_PRIVATE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1019 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1020 				prefs.edit().putString(&quot;changelog_&quot; + newApkVersion,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1021 						newApkChangelog).apply();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1022 			} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1023 			}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1024 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1025 			BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1026 			BigInteger b = new BigInteger(newApkVersion);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1027 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1028 			if (a.compareTo(b) == -1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1029 				mUpdateView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1030 				mUpdateButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1031 					@Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1032 					public void onClick(View v) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1033 						if (write())</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1034 							return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1035 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1036 						DownloadsUtil.add(getContext(),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1037 								&quot;XposedInstaller_by_dvdandroid&quot;, newApkLink,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1038 								new DownloadsUtil.DownloadFinishedCallback() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1039 							@Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1040 							public void onDownloadFinished(Context context,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1041 									DownloadsUtil.DownloadInfo info) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1042 								Intent intent = new Intent(Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1043 								intent.setDataAndType(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1044 										Uri.fromFile(new File(Environment</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1045 												.getExternalStorageDirectory()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1046 												.getAbsolutePath()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1047 												+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1048 										DownloadsUtil.MIME_TYPE_APK);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1049 								intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1050 								context.startActivity(intent);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1051 							}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1052 						}, DownloadsUtil.MIME_TYPES.APK, true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1053 					}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">1054 				});</span>
1055 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1056 						new XposedZip.MyAdapter&lt;&gt;(getContext(), uninstallers));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1057 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1058 			} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1059 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1060 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1061 			if (newApkChangelog != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1062 				mInfoUpdate.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1063 					@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1064 					public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1065 						new MaterialDialog.Builder(getContext())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1066 								.title(R.string.changes)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1067 								.content(Html.fromHtml(newApkChangelog))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1068 								.positiveText(android.R.string.ok).show();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1069 					}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1070 				});</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1071 			} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1072 				mInfoUpdate.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1073 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1074 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1075 			if (newApkVersion == null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1076 				return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1077 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1078 			SharedPreferences prefs = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1079 			try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1080 				prefs = getContext().getSharedPreferences(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1081 						getContext().getPackageName() + &quot;_preferences&quot;,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1082 						MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1083 			} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1084 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1085 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1086 			BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1087 			BigInteger b = new BigInteger(newApkVersion);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1088 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1089 			if (a.compareTo(b) == -1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1090 				mUpdateView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1091 				mUpdateButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1092 					@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1093 					public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1094 						if (write())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1095 							return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1096 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1097 						DownloadsUtil.add(getContext(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1098 								&quot;XposedInstaller_by_dvdandroid&quot;, newApkLink,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1099 								new DownloadsUtil.DownloadFinishedCallback() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1100 							@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1101 							public void onDownloadFinished(Context context,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1102 									DownloadsUtil.DownloadInfo info) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1103 								Intent intent = new Intent(Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1104 								intent.setDataAndType(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1105 										Uri.fromFile(new File(Environment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1106 												.getExternalStorageDirectory()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1107 												.getAbsolutePath()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1108 												+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1109 										DownloadsUtil.MIME_TYPE_APK);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1110 								intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1111 								context.startActivity(intent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1112 							}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1113 						}, DownloadsUtil.MIME_TYPES.APK, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1114 					}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1115 				});</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1116 			} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1117 				if (prefs != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1118 					prefs.edit()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1119 							.putString(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1120 									&quot;changelog_&quot; + XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1121 									newApkChangelog)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1122 							.apply();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1123 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1124 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1125 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1126 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1127 }</span>
1128 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1129 				if (newApkChangelog != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1130 					mInfoUpdate.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1131 						@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1132 						public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1133 							new MaterialDialog.Builder(getContext())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1134 									.title(R.string.changes)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1135 									.content(Html.fromHtml(newApkChangelog))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1136 									.positiveText(android.R.string.ok).show();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1137 						}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1138 					});</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1139 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1140 					mInfoUpdate.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1141 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1142 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1143 				if (newApkVersion == null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1144 					return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1146 				SharedPreferences prefs = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1147 				try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1148 					prefs = getContext().getSharedPreferences(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1149 							getContext().getPackageName() + &quot;_preferences&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1150 							MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1151 				} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1152 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1153 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1154 				BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1155 				BigInteger b = new BigInteger(newApkVersion);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1157 				if (a.compareTo(b) == -1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1158 					mUpdateView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1159 					mUpdateButton</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1160 							.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1161 								@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1162 								public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1163 									if (write())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1164 										return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1166 									DownloadsUtil.add(getContext(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1167 											&quot;XposedInstaller_by_dvdandroid&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1168 											newApkLink,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1169 											new DownloadsUtil.DownloadFinishedCallback() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1170 										@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1171 										public void onDownloadFinished(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1172 												Context context,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1173 												DownloadsUtil.DownloadInfo info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1174 											Intent intent = new Intent(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1175 													Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1176 											intent.setDataAndType(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1177 													Uri.fromFile(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1178 															new File(Environment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1179 																	.getExternalStorageDirectory()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1180 																	.getAbsolutePath()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1181 																	+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1182 													DownloadsUtil.MIME_TYPE_APK);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1183 											intent.setFlags(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1184 													Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1185 											context.startActivity(intent);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1186 										}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1187 									}, DownloadsUtil.MIME_TYPES.APK, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1188 								}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1189 							});</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1190 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1191 					if (prefs != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1192 						prefs.edit()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1193 								.putString(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1194 										&quot;changelog_&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1195 												+ XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1196 										newApkChangelog)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1197 								.apply();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1198 					}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1199 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1200 			} catch (NullPointerException ignored) {</span>
1201 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1202 			}
1203 		}
1204 	}
1205 }</pre></td>
                            <td><pre>   1 package de.robv.android.xposed.installer;
   2 
   3 import static android.content.Context.MODE_PRIVATE;
   4 import static de.robv.android.xposed.installer.XposedApp.WRITE_EXTERNAL_PERMISSION;
   5 import static de.robv.android.xposed.installer.util.XposedZip.Installer;
   6 import static de.robv.android.xposed.installer.util.XposedZip.Uninstaller;
   7 
   8 import android.Manifest;
   9 import android.annotation.TargetApi;
  10 import android.app.Activity;
  11 import android.content.Context;
  12 import android.content.DialogInterface;
  13 import android.content.Intent;
  14 import android.content.SharedPreferences;
  15 import android.content.pm.PackageManager;
  16 import android.net.Uri;
  17 import android.os.AsyncTask;
  18 import android.os.Build;
  19 import android.os.Bundle;
  20 import android.os.Environment;
  21 import android.os.Looper;
  22 import android.os.ParcelFileDescriptor;
  23 import android.support.annotation.NonNull;
  24 import android.support.v4.app.ActivityCompat;
  25 import android.support.v4.app.Fragment;
  26 import android.support.v7.widget.CardView;
  27 import android.system.Os;
  28 import android.text.Html;
  29 import android.text.TextUtils;
  30 import android.util.Log;
  31 import android.view.LayoutInflater;
  32 import android.view.Menu;
  33 import android.view.MenuInflater;
  34 import android.view.MenuItem;
  35 import android.view.View;
  36 import android.view.ViewGroup;
  37 import android.widget.Button;
  38 import android.widget.CheckBox;
  39 import android.widget.ImageView;
  40 import android.widget.ProgressBar;
  41 import android.widget.Spinner;
  42 import android.widget.TextView;
  43 import android.widget.Toast;
  44 
  45 import com.afollestad.materialdialogs.MaterialDialog;
  46 
  47 import java.io.BufferedReader;
  48 import java.io.File;
  49 import java.io.IOException;
  50 import java.io.InputStreamReader;
  51 import java.math.BigInteger;
  52 import java.net.HttpURLConnection;
  53 import java.net.MalformedURLException;
  54 import java.net.URL;
  55 import java.util.ArrayList;
  56 import java.util.LinkedList;
  57 import java.util.List;
  58 import java.util.Locale;
  59 
  60 import org.json.JSONArray;
  61 import org.json.JSONObject;
  62 
  63 import de.robv.android.xposed.installer.util.AssetUtil;
  64 import de.robv.android.xposed.installer.util.DownloadsUtil;
  65 import de.robv.android.xposed.installer.util.NavUtil;
  66 import de.robv.android.xposed.installer.util.NotificationUtil;
  67 import de.robv.android.xposed.installer.util.RootUtil;
  68 import de.robv.android.xposed.installer.util.ThemeUtil;
  69 import de.robv.android.xposed.installer.util.XposedZip;
  70 
  71 public class InstallerFragment extends Fragment
  72 		implements ActivityCompat.OnRequestPermissionsResultCallback,
  73 		DownloadsUtil.DownloadFinishedCallback {
  74 	public static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;
  75 	private static final int INSTALL_MODE_NORMAL = 0;
  76 	private static final int INSTALL_MODE_RECOVERY_AUTO = 1;
  77 	private static final int INSTALL_MODE_RECOVERY_MANUAL = 2;
<abbr title="  78 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposed.json&quot;;">  78 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/materialðŸ”µ</abbr>
  79 	private static List&lt;String&gt; messages = new LinkedList&lt;&gt;();
  80 	private static ArrayList&lt;Installer&gt; installers;
  81 	private static ArrayList&lt;Uninstaller&gt; uninstallers;
  82 	private final LinkedList&lt;String&gt; mCompatibilityErrors = new LinkedList&lt;&gt;();
  83 	private String APP_PROCESS_NAME = null;
  84 	private RootUtil mRootUtil = new RootUtil();
  85 	private boolean mHadSegmentationFault = false;
  86 	private MaterialDialog.Builder dlgProgress;
  87 	private TextView txtInstallError, txtKnownIssue;
  88 	private Button btnInstall, btnUninstall;
  89 	private ProgressBar mInstallersLoading;
  90 	private Spinner mInstallersChooser;
  91 	private ProgressBar mUninstallersLoading;
  92 	private Spinner mUninstallersChooser;
  93 	private ImageView mInfoInstaller, mInfoUninstaller;
  94 	private String newApkVersion = XposedApp.THIS_APK_VERSION;
  95 	private String newApkLink;
  96 	private String newApkChangelog;
  97 	private CardView mUpdateView;
  98 	private Button mUpdateButton;
  99 	private TextView mInstallForbidden;
 100 	private ImageView mInfoUpdate;
 101 
 102 	private static int extractIntPart(String str) {
 103 		int result = 0, length = str.length();
 104 		for (int offset = 0; offset &lt; length; offset++) {
 105 			char c = str.charAt(offset);
 106 			if (&#x27;0&#x27; &lt;= c &amp;&amp; c &lt;= &#x27;9&#x27;)
 107 				result = result * 10 + (c - &#x27;0&#x27;);
 108 			else
 109 				break;
 110 		}
 111 		return result;
 112 	}
 113 
 114 	private static boolean checkClassExists(String className) {
 115 		try {
 116 			Class.forName(className);
 117 			return true;
 118 		} catch (ClassNotFoundException e) {
 119 			return false;
 120 		}
 121 	}
 122 
 123 	public static ArrayList&lt;Installer&gt; getInstallersBySdk(int sdk) {
 124 		ArrayList&lt;Installer&gt; list = new ArrayList&lt;&gt;();
 125 		for (Installer i : installers) {
 126 			if (i.sdk == sdk)
 127 				list.add(i);
 128 		}
 129 
 130 		if (list.size() == 0) {
 131 			list.add(new Installer());
 132 		}
 133 		return list;
 134 	}
 135 
 136 	/*
 137 	 * public static ArrayList&lt;Installer&gt; getInstallersBySdkAndArchitecture( int
 138 	 * sdk, String architecture) { ArrayList&lt;Installer&gt; list = new
 139 	 * ArrayList&lt;&gt;(); ArrayList&lt;Installer&gt; list2 = new ArrayList&lt;&gt;(); for
 140 	 * (Installer i : installers) { if (i.sdk == sdk) list.add(i); } for
 141 	 * (Installer i : list) { if (i.architecture.equals(architecture))
 142 	 * list2.add(i); } return list2; }
 143 	 *
 144 	 * public static ArrayList&lt;Uninstaller&gt; getUninstallersByArchitecture(
 145 	 * String architecture) { ArrayList&lt;Uninstaller&gt; list = new ArrayList&lt;&gt;();
 146 	 * for (Uninstaller u : uninstallers) { if
 147 	 * (u.architecture.equals(architecture)) list.add(u); } return list; }
 148 	 */
 149 
 150 	@Override
 151 	public void onActivityCreated(Bundle savedInstanceState) {
 152 		super.onActivityCreated(savedInstanceState);
 153 		Activity activity = getActivity();
 154 
 155 		dlgProgress = new MaterialDialog.Builder(activity).progress(true, 0);
 156 		setHasOptionsMenu(true);
 157 	}
 158 
 159 	@Override
 160 	public View onCreateView(LayoutInflater inflater, ViewGroup container,
 161 			Bundle savedInstanceState) {
 162 		View v = inflater.inflate(R.layout.tab_installer, container, false);
 163 
 164 		txtInstallError = (TextView) v
 165 				.findViewById(R.id.framework_install_errors);
 166 		txtKnownIssue = (TextView) v.findViewById(R.id.framework_known_issue);
 167 
 168 		btnInstall = (Button) v.findViewById(R.id.btnInstall);
 169 		btnUninstall = (Button) v.findViewById(R.id.btnUninstall);
 170 
 171 		mInstallersLoading = (ProgressBar) v
 172 				.findViewById(R.id.loadingInstallers);
 173 		mUninstallersLoading = (ProgressBar) v
 174 				.findViewById(R.id.loadingUninstallers);
 175 		mInstallersChooser = (Spinner) v.findViewById(R.id.chooserInstallers);
 176 		mUninstallersChooser = (Spinner) v
 177 				.findViewById(R.id.chooserUninstallers);
 178 		mUpdateView = (CardView) v.findViewById(R.id.updateView);
 179 		mUpdateButton = (Button) v.findViewById(R.id.updateButton);
 180 
 181 		mInfoInstaller = (ImageView) v.findViewById(R.id.infoInstaller);
 182 		mInfoUninstaller = (ImageView) v.findViewById(R.id.infoUninstaller);
 183 
 184 		mInstallForbidden = (TextView) v
 185 				.findViewById(R.id.installationForbidden);
 186 		mInfoUpdate = (ImageView) v.findViewById(R.id.infoUpdate);
 187 
 188 		String installedXposedVersion = XposedApp.getXposedProp()
 189 				.get(&quot;version&quot;);
 190 
 191 		if (Build.VERSION.SDK_INT &gt;= 21) {
 192 			if (installedXposedVersion == null) {
 193 				txtInstallError.setText(R.string.installation_lollipop);
 194 				txtInstallError
 195 						.setTextColor(getResources().getColor(R.color.warning));
 196 			} else {
 197 				int installedXposedVersionInt = extractIntPart(
 198 						installedXposedVersion);
 199 				if (installedXposedVersionInt == XposedApp.getXposedVersion()) {
 200 					txtInstallError
 201 							.setText(getString(R.string.installed_lollipop,
 202 									installedXposedVersion));
 203 					txtInstallError.setTextColor(
 204 							getResources().getColor(R.color.darker_green));
 205 				} else {
 206 					txtInstallError.setText(
 207 							getString(R.string.installed_lollipop_inactive,
 208 									installedXposedVersion));
 209 					txtInstallError.setTextColor(
 210 							getResources().getColor(R.color.warning));
 211 				}
 212 			}
 213 		} else {
 214 			if (XposedApp.getXposedVersion() != 0) {
 215 				txtInstallError.setText(getString(R.string.installed_lollipop,
 216 						XposedApp.getXposedVersion()));
 217 				txtInstallError.setTextColor(
 218 						getResources().getColor(R.color.darker_green));
 219 			} else {
 220 				txtInstallError
 221 						.setText(getString(R.string.not_installed_no_lollipop));
 222 				txtInstallError
 223 						.setTextColor(getResources().getColor(R.color.warning));
 224 			}
 225 		}
 226 
 227 		txtInstallError.setVisibility(View.VISIBLE);
 228 
 229 		if (!XposedApp.getPreferences().getBoolean(&quot;hide_install_warning&quot;,
 230 				false)) {
 231 			final View dontShowAgainView = inflater
 232 					.inflate(R.layout.dialog_install_warning, null);
 233 
 234 			new MaterialDialog.Builder(getActivity())
 235 					.title(R.string.install_warning_title)
 236 					.customView(dontShowAgainView, false)
 237 					.positiveText(android.R.string.ok)
 238 					.callback(new MaterialDialog.ButtonCallback() {
 239 						@Override
 240 						public void onPositive(MaterialDialog dialog) {
 241 							super.onPositive(dialog);
 242 							CheckBox checkBox = (CheckBox) dontShowAgainView
 243 									.findViewById(android.R.id.checkbox);
 244 							if (checkBox.isChecked())
 245 								XposedApp.getPreferences().edit().putBoolean(
 246 										&quot;hide_install_warning&quot;, true).apply();
 247 						}
 248 					}).cancelable(false).show();
 249 		}
 250 
 251 		new JSONParser(JSON_LINK).execute();
 252 
 253 		mInfoInstaller.setOnClickListener(new View.OnClickListener() {
 254 			@Override
 255 			public void onClick(View v) {
 256 				Installer selectedInstaller = (Installer) mInstallersChooser
 257 						.getSelectedItem();
 258 				String s = getString(R.string.infoInstaller,
 259 						selectedInstaller.name, selectedInstaller.sdk,
 260 						selectedInstaller.architecture,
 261 						selectedInstaller.version);
 262 
 263 				new MaterialDialog.Builder(getContext()).title(R.string.info)
 264 						.content(s).positiveText(android.R.string.ok).show();
 265 			}
 266 		});
 267 		mInfoUninstaller.setOnClickListener(new View.OnClickListener() {
 268 			@Override
 269 			public void onClick(View v) {
 270 				Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 271 						.getSelectedItem();
 272 				String s = getString(R.string.infoUninstaller,
 273 						selectedUninstaller.name,
 274 						selectedUninstaller.architecture,
 275 						selectedUninstaller.date);
 276 
 277 				new MaterialDialog.Builder(getContext()).title(R.string.info)
 278 						.content(s).positiveText(android.R.string.ok).show();
 279 			}
 280 		});
 281 
 282 		btnInstall.setOnClickListener(new View.OnClickListener() {
 283 			@Override
 284 			public void onClick(View v) {
 285 				if (write())
 286 					return;
 287 
 288 				areYouSure(R.string.warningArchitecture,
 289 						new MaterialDialog.ButtonCallback() {
 290 					@Override
 291 					public void onPositive(MaterialDialog dialog) {
 292 						super.onPositive(dialog);
 293 
 294 						Installer selectedInstaller = (Installer) mInstallersChooser
 295 								.getSelectedItem();
 296 
 297 						DownloadsUtil.add(getContext(), selectedInstaller.name,
 298 								selectedInstaller.link, InstallerFragment.this,
 299 								DownloadsUtil.MIME_TYPES.ZIP, true);
 300 					}
 301 				});
 302 			}
 303 		});
 304 
 305 		btnUninstall.setOnClickListener(new View.OnClickListener() {
 306 			@Override
 307 			public void onClick(View v) {
 308 				if (write())
 309 					return;
 310 				areYouSure(R.string.warningArchitecture,
 311 						new MaterialDialog.ButtonCallback() {
 312 					@Override
 313 					public void onPositive(MaterialDialog dialog) {
 314 						super.onPositive(dialog);
 315 
 316 						Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 317 								.getSelectedItem();
 318 
 319 						DownloadsUtil.add(getContext(),
 320 								selectedUninstaller.name,
 321 								selectedUninstaller.link,
 322 								InstallerFragment.this,
 323 								DownloadsUtil.MIME_TYPES.ZIP, true);
 324 					}
 325 				});
 326 			}
 327 		});
 328 
 329 		return v;
 330 	}
 331 
 332 	@Override
 333 	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 334 		inflater.inflate(R.menu.menu_installer, menu);
 335 	}
 336 
 337 	@Override
 338 	public boolean onOptionsItemSelected(MenuItem item) {
 339 
 340 		switch (item.getItemId()) {
 341 			case R.id.help:
 342 				new MaterialDialog.Builder(getContext()).title(R.string.help)
 343 						.content(R.string.helpChoose)
 344 						.positiveText(android.R.string.ok).show();
 345 				break;
 346 			case R.id.installation_mode:
 347 				Intent intent = new Intent(getActivity(),
 348 						SettingsActivity.class);
 349 				startActivity(intent);
 350 				break;
 351 			case R.id.reboot:
 352 				areYouSure(R.string.reboot,
 353 						new MaterialDialog.ButtonCallback() {
 354 							@Override
 355 							public void onPositive(MaterialDialog dialog) {
 356 								super.onPositive(dialog);
 357 								reboot(null);
 358 							}
 359 						});
 360 				break;
 361 			case R.id.soft_reboot:
 362 				areYouSure(R.string.reboot,
 363 						new MaterialDialog.ButtonCallback() {
 364 							@Override
 365 							public void onPositive(MaterialDialog dialog) {
 366 								super.onPositive(dialog);
 367 								softReboot();
 368 							}
 369 						});
 370 				break;
 371 		}
 372 
 373 		return super.onOptionsItemSelected(item);
 374 	}
 375 
 376 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 377 	public void performFileSearch() {
 378 		Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 379 		intent.addCategory(Intent.CATEGORY_OPENABLE);
 380 		intent.setType(&quot;application/zip&quot;);
 381 		startActivityForResult(intent, 123);
 382 	}
 383 
 384 	@Override
 385 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 386 	public void onActivityResult(int requestCode, int resultCode,
 387 			Intent resultData) {
 388 		if (requestCode == 123 &amp;&amp; resultCode == Activity.RESULT_OK) {
 389 			if (resultData != null) {
 390 				Uri uri = resultData.getData();
 391 				String resolved = null;
 392 				try (ParcelFileDescriptor fd = getActivity()
 393 						.getContentResolver().openFileDescriptor(uri, &quot;r&quot;)) {
 394 					final File procfsFdFile = new File(
 395 							&quot;/proc/self/fd/&quot; + fd.getFd());
 396 
 397 					resolved = Os.readlink(procfsFdFile.getAbsolutePath());
 398 
 399 					if (TextUtils.isEmpty(resolved) || resolved.charAt(0) != &#x27;/&#x27;
 400 							|| resolved.startsWith(&quot;/proc/&quot;)
 401 							|| resolved.startsWith(&quot;/fd/&quot;))
 402 						;
 403 				} catch (Exception errnoe) {
 404 					Log.e(XposedApp.TAG, &quot;ReadError&quot;);
 405 				}
 406 				mRootUtil.execute(&quot;cp &quot; + resolved + &quot; /cache/xposed.zip&quot;,
 407 						messages);
 408 				installXposedZip();
 409 			}
 410 		}
 411 	}
 412 
 413 	private void installXposedZip() {
 414 		mRootUtil.execute(
 415 				&quot;echo &#x27;install /cache/xposed.zip&#x27; &gt;/cache/recovery/openrecoveryscript &quot;,
 416 				messages);
 417 		mRootUtil.execute(&quot;sync&quot;, messages);
 418 		reboot(&quot;recovery&quot;);
 419 	}
 420 
 421 	@Override
 422 	public void onRequestPermissionsResult(int requestCode,
 423 			@NonNull String[] permissions, @NonNull int[] grantResults) {
 424 		if (requestCode == WRITE_EXTERNAL_PERMISSION) {
 425 			if (grantResults.length == 1
 426 					&amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {
 427 				Toast.makeText(getActivity(), R.string.permissionGranted,
 428 						Toast.LENGTH_LONG).show();
 429 			} else {
 430 				Toast.makeText(getActivity(), R.string.permissionNotGranted,
 431 						Toast.LENGTH_LONG).show();
 432 			}
 433 		} else {
 434 			super.onRequestPermissionsResult(requestCode, permissions,
 435 					grantResults);
 436 		}
 437 	}
 438 
 439 	private boolean write() {
 440 		if (ActivityCompat.checkSelfPermission(getContext(),
 441 				Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
 442 
 443 			ActivityCompat.requestPermissions(getActivity(),
 444 					new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE },
 445 					WRITE_EXTERNAL_PERMISSION);
 446 
 447 			return true;
 448 		} else {
 449 			return false;
 450 		}
 451 	}
 452 
 453 	@Override
 454 	public void onResume() {
 455 		super.onResume();
 456 		NotificationUtil.cancel(NotificationUtil.NOTIFICATION_MODULES_UPDATED);
 457 		mHadSegmentationFault = false;
 458 		refreshKnownIssue();
 459 	}
 460 
 461 	@Override
 462 	public void onDestroy() {
 463 		super.onDestroy();
 464 		mRootUtil.dispose();
 465 	}
 466 
 467 	private String versionToText(int version) {
 468 		return (version == 0) ? getString(R.string.none)
 469 				: Integer.toString(version);
 470 	}
 471 
 472 	private void refreshKnownIssue() {
 473 		String issueName = null;
 474 		String issueLink = null;
 475 
 476 		if (new File(&quot;/system/framework/core.jar.jex&quot;).exists()) {
 477 			issueName = &quot;Aliyun OS&quot;;
 478 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52289793&amp;postcount=5&quot;;
 479 
 480 		} else if (new File(&quot;/data/miui/DexspyInstaller.jar&quot;).exists()
 481 				|| checkClassExists(&quot;miui.dexspy.DexspyInstaller&quot;)) {
 482 			issueName = &quot;MIUI/Dexspy&quot;;
 483 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52291098&amp;postcount=6&quot;;
 484 
 485 		} else if (mHadSegmentationFault) {
 486 			issueName = &quot;Segmentation fault&quot;;
 487 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52292102&amp;postcount=7&quot;;
 488 
 489 		} else
 490 			if (checkClassExists(&quot;com.huawei.android.content.res.ResourcesEx&quot;)
 491 					|| checkClassExists(&quot;android.content.res.NubiaResources&quot;)) {
 492 			issueName = &quot;Resources subclass&quot;;
 493 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52801382&amp;postcount=8&quot;;
 494 		}
 495 
 496 		if (issueName != null) {
 497 			final String issueLinkFinal = issueLink;
 498 			txtKnownIssue.setText(
 499 					getString(R.string.install_known_issue, issueName));
 500 			txtKnownIssue.setVisibility(View.VISIBLE);
 501 			txtKnownIssue.setOnClickListener(new View.OnClickListener() {
 502 				@Override
 503 				public void onClick(View v) {
 504 					NavUtil.startURL(getActivity(), issueLinkFinal);
 505 				}
 506 			});
 507 
 508 			txtInstallError.setTextColor(ThemeUtil.getThemeColor(getActivity(),
 509 					android.R.attr.textColorTertiary));
 510 		} else {
 511 			txtKnownIssue.setVisibility(View.GONE);
 512 		}
 513 	}
 514 
 515 	private void showAlert(final String result) {
 516 		if (Looper.myLooper() != Looper.getMainLooper()) {
 517 			getActivity().runOnUiThread(new Runnable() {
 518 				@Override
 519 				public void run() {
 520 					showAlert(result);
 521 				}
 522 			});
 523 			return;
 524 		}
 525 
 526 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 527 				.content(result).positiveText(android.R.string.ok).build();
 528 		dialog.show();
 529 
 530 		TextView txtMessage = (TextView) dialog
 531 				.findViewById(android.R.id.message);
 532 		try {
 533 			txtMessage.setTextSize(14);
 534 		} catch (NullPointerException ignored) {
 535 		}
 536 
 537 		mHadSegmentationFault = result.toLowerCase(Locale.US)
 538 				.contains(&quot;segmentation fault&quot;);
 539 		refreshKnownIssue();
 540 	}
 541 
 542 	private void areYouSure(int messageTextId,
 543 			MaterialDialog.ButtonCallback yesHandler) {
 544 		new MaterialDialog.Builder(getActivity()).title(messageTextId)
 545 				.content(R.string.areyousure)
 546 				.iconAttr(android.R.attr.alertDialogIcon)
 547 				.positiveText(android.R.string.yes)
 548 				.negativeText(android.R.string.no).callback(yesHandler).show();
 549 	}
 550 
 551 	private void showConfirmDialog(final String message,
 552 			final MaterialDialog.ButtonCallback callback) {
 553 		if (Looper.myLooper() != Looper.getMainLooper()) {
 554 			getActivity().runOnUiThread(new Runnable() {
 555 				@Override
 556 				public void run() {
 557 					showConfirmDialog(message, callback);
 558 				}
 559 			});
 560 			return;
 561 		}
 562 
 563 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 564 				.content(message).positiveText(android.R.string.yes)
 565 				.negativeText(android.R.string.no).callback(callback).build();
 566 
 567 		TextView txtMessage = (TextView) dialog
 568 				.findViewById(android.R.id.message);
 569 		txtMessage.setTextSize(14);
 570 
 571 		mHadSegmentationFault = message.toLowerCase(Locale.US)
 572 				.contains(&quot;segmentation fault&quot;);
 573 		refreshKnownIssue();
 574 	}
 575 
 576 	private boolean checkCompatibility() {
 577 		mCompatibilityErrors.clear();
 578 		return checkAppProcessCompatibility();
 579 	}
 580 
 581 	private boolean checkAppProcessCompatibility() {
 582 		try {
 583 			if (APP_PROCESS_NAME == null)
 584 				return false;
 585 
 586 			File testFile = AssetUtil.writeAssetToCacheFile(APP_PROCESS_NAME,
 587 					&quot;app_process&quot;, 00700);
 588 			if (testFile == null) {
 589 				mCompatibilityErrors
 590 						.add(&quot;could not write app_process to cache&quot;);
 591 				return false;
 592 			}
 593 
 594 			Process p = Runtime.getRuntime().exec(new String[] {
 595 					testFile.getAbsolutePath(), &quot;--xposedversion&quot; });
 596 
 597 			BufferedReader stdout = new BufferedReader(
 598 					new InputStreamReader(p.getInputStream()));
 599 			String result = stdout.readLine();
 600 			stdout.close();
 601 
 602 			BufferedReader stderr = new BufferedReader(
 603 					new InputStreamReader(p.getErrorStream()));
 604 			String errorLine;
 605 			while ((errorLine = stderr.readLine()) != null) {
 606 				mCompatibilityErrors.add(errorLine);
 607 			}
 608 			stderr.close();
 609 
 610 			p.destroy();
 611 
 612 			testFile.delete();
 613 			return result != null &amp;&amp; result.startsWith(&quot;Xposed version: &quot;);
 614 		} catch (IOException e) {
 615 			mCompatibilityErrors.add(e.getMessage());
 616 			return false;
 617 		}
 618 	}
 619 
 620 	private boolean startShell() {
 621 		if (mRootUtil.startShell())
 622 			return true;
 623 
 624 		showAlert(getString(R.string.root_failed));
 625 		return false;
 626 	}
 627 
 628 	private int getInstallMode() {
 629 		int mode = XposedApp.getPreferences().getInt(&quot;install_mode&quot;,
 630 				INSTALL_MODE_NORMAL);
 631 		if (mode &lt; INSTALL_MODE_NORMAL || mode &gt; INSTALL_MODE_RECOVERY_MANUAL)
 632 			mode = INSTALL_MODE_NORMAL;
 633 		return mode;
 634 	}
 635 
 636 	private String getInstallModeText() {
 637 		final int installMode = getInstallMode();
 638 		switch (installMode) {
 639 			case INSTALL_MODE_NORMAL:
 640 				return getString(R.string.install_mode_normal);
 641 			case INSTALL_MODE_RECOVERY_AUTO:
 642 				return getString(R.string.install_mode_recovery_auto);
 643 			case INSTALL_MODE_RECOVERY_MANUAL:
 644 				return getString(R.string.install_mode_recovery_manual);
 645 		}
 646 		throw new IllegalStateException(&quot;unknown install mode &quot; + installMode);
 647 	}
 648 
 649 	private boolean prepareAutoFlash(List&lt;String&gt; messages, String file) {
 650 		if (mRootUtil.execute(&quot;ls /cache/recovery&quot;, null) != 0) {
 651 			messages.add(getString(R.string.file_creating_directory,
 652 					&quot;/cache/recovery&quot;));
 653 			if (mRootUtil.executeWithBusybox(&quot;mkdir /cache/recovery&quot;,
 654 					messages) != 0) {
 655 				messages.add(&quot;&quot;);
 656 				messages.add(getString(R.string.file_create_directory_failed,
 657 						&quot;/cache/recovery&quot;));
 658 				return false;
 659 			}
 660 		}
 661 
 662 		messages.add(getString(R.string.file_copying, file));
 663 		File tempFile = AssetUtil.writeAssetToCacheFile(file, 00644);
 664 		if (tempFile == null) {
 665 			messages.add(&quot;&quot;);
 666 			messages.add(getString(R.string.file_extract_failed, file));
 667 			return false;
 668 		}
 669 
 670 		if (mRootUtil.executeWithBusybox(&quot;cp -a &quot; + tempFile.getAbsolutePath()
 671 				+ &quot; /cache/recovery/&quot; + file, messages) != 0) {
 672 			messages.add(&quot;&quot;);
 673 			messages.add(getString(R.string.file_copy_failed, file, &quot;/cache&quot;));
 674 			tempFile.delete();
 675 			return false;
 676 		}
 677 
 678 		tempFile.delete();
 679 
 680 		messages.add(getString(R.string.file_writing_recovery_command));
 681 		if (mRootUtil.execute(
 682 				&quot;echo \&quot;--update_package=/cache/recovery/&quot; + file
 683 						+ &quot;\n--show_text\&quot; &gt; /cache/recovery/command&quot;,
 684 				messages) != 0) {
 685 			messages.add(&quot;&quot;);
 686 			messages.add(
 687 					getString(R.string.file_writing_recovery_command_failed));
 688 			return false;
 689 		}
 690 
 691 		return true;
 692 	}
 693 
 694 	private boolean prepareManualFlash(List&lt;String&gt; messages, String file) {
 695 		messages.add(getString(R.string.file_copying, file));
 696 		if (AssetUtil.writeAssetToSdcardFile(file, 00644) == null) {
 697 			messages.add(&quot;&quot;);
 698 			messages.add(getString(R.string.file_extract_failed, file));
 699 			return false;
 700 		}
 701 
 702 		return true;
 703 	}
 704 
 705 	private void offerReboot(List&lt;String&gt; messages) {
 706 		messages.add(getString(R.string.file_done));
 707 		messages.add(&quot;&quot;);
 708 		messages.add(getString(R.string.reboot_confirmation));
 709 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 710 				new MaterialDialog.ButtonCallback() {
 711 					@Override
 712 					public void onPositive(MaterialDialog dialog) {
 713 						super.onPositive(dialog);
 714 						reboot(null);
 715 					}
 716 				});
 717 	}
 718 
 719 	private void offerRebootToRecovery(List&lt;String&gt; messages, final String file,
 720 			final int installMode) {
 721 		if (installMode == INSTALL_MODE_RECOVERY_AUTO)
 722 			messages.add(getString(R.string.auto_flash_note, file));
 723 		else
 724 			messages.add(getString(R.string.manual_flash_note, file));
 725 
 726 		messages.add(&quot;&quot;);
 727 		messages.add(getString(R.string.reboot_recovery_confirmation));
 728 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 729 				new MaterialDialog.ButtonCallback() {
 730 					@Override
 731 					public void onPositive(MaterialDialog dialog) {
 732 						super.onPositive(dialog);
 733 						reboot(&quot;recovery&quot;);
 734 					}
 735 
 736 					@Override
 737 					public void onNegative(MaterialDialog dialog) {
 738 						super.onNegative(dialog);
 739 						if (installMode == INSTALL_MODE_RECOVERY_AUTO) {
 740 							// clean up to avoid unwanted flashing
 741 							mRootUtil.executeWithBusybox(
 742 									&quot;rm /cache/recovery/command&quot;, null);
 743 							mRootUtil.executeWithBusybox(
 744 									&quot;rm /cache/recovery/&quot; + file, null);
 745 							AssetUtil.removeBusybox();
 746 						}
 747 					}
 748 				}
 749 
 750 		);
 751 	}
 752 
 753 	private void softReboot() {
 754 		if (!startShell())
 755 			return;
 756 
 757 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 758 		if (mRootUtil.execute(
 759 				&quot;setprop ctl.restart surfaceflinger; setprop ctl.restart zygote&quot;,
 760 				messages) != 0) {
 761 			messages.add(&quot;&quot;);
 762 			messages.add(getString(R.string.reboot_failed));
 763 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 764 		}
 765 	}
 766 
 767 	private void reboot(String mode) {
 768 		if (!startShell())
 769 			return;
 770 
 771 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 772 
 773 		String command = &quot;reboot&quot;;
 774 		if (mode != null) {
 775 			command += &quot; &quot; + mode;
 776 			if (mode.equals(&quot;recovery&quot;))
 777 				// create a flag used by some kernels to boot into recovery
 778 				mRootUtil.executeWithBusybox(&quot;touch /cache/recovery/boot&quot;,
 779 						messages);
 780 		}
 781 
 782 		if (mRootUtil.executeWithBusybox(command, messages) != 0) {
 783 			messages.add(&quot;&quot;);
 784 			messages.add(getString(R.string.reboot_failed));
 785 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 786 		}
 787 		AssetUtil.removeBusybox();
 788 	}
 789 
 790 	@Override
 791 	public void onDownloadFinished(final Context context,
 792 			DownloadsUtil.DownloadInfo info) {
 793 		Toast.makeText(context,
 794 				getString(R.string.downloadZipOk, info.localFilename),
 795 				Toast.LENGTH_LONG).show();
 796 
 797 		if (getInstallMode() == INSTALL_MODE_RECOVERY_MANUAL)
 798 			return;
 799 
 800 		areYouSure(R.string.install_warning,
 801 				new MaterialDialog.ButtonCallback() {
 802 					@Override
 803 					public void onPositive(MaterialDialog dialog) {
 804 						super.onPositive(dialog);
 805 						Toast.makeText(context, R.string.selectFile,
 806 								Toast.LENGTH_LONG).show();
 807 
 808 						performFileSearch();
 809 					}
 810 				});
 811 	}
 812 
 813 	private abstract class AsyncClickListener implements View.OnClickListener {
 814 		private final CharSequence mProgressDlgText;
 815 
 816 		public AsyncClickListener(CharSequence progressDlgText) {
 817 			mProgressDlgText = progressDlgText;
 818 		}
 819 
 820 		@Override
 821 		public final void onClick(final View v) {
 822 			if (mProgressDlgText != null) {
 823 				dlgProgress.content(mProgressDlgText);
 824 				dlgProgress.show();
 825 			}
 826 			new Thread() {
 827 				public void run() {
 828 					onAsyncClick(v);
 829 					dlgProgress.build().dismiss();
 830 				}
 831 			}.start();
 832 		}
 833 
 834 		protected abstract void onAsyncClick(View v);
 835 	}
 836 
 837 	private abstract class AsyncDialogClickListener
 838 			implements DialogInterface.OnClickListener {
 839 		private final CharSequence mProgressDlgText;
 840 
 841 		public AsyncDialogClickListener(CharSequence progressDlgText) {
 842 			mProgressDlgText = progressDlgText;
 843 		}
 844 
 845 		@Override
 846 		public void onClick(final DialogInterface dialog, final int which) {
 847 			if (mProgressDlgText != null) {
 848 				dlgProgress.content(mProgressDlgText);
 849 				dlgProgress.show();
 850 			}
 851 			new Thread() {
 852 				public void run() {
 853 					onAsyncClick(dialog, which);
 854 					dlgProgress.build().dismiss();
 855 				}
 856 			}.start();
 857 		}
 858 
 859 		protected abstract void onAsyncClick(DialogInterface dialog, int which);
 860 	}
 861 
 862 	private class JSONParser extends AsyncTask&lt;Void, Void, Boolean&gt; {
 863 		private URL mUrl;
 864 
 865 		public JSONParser(String mUrl) {
 866 			try {
 867 				this.mUrl = new URL(mUrl);
 868 			} catch (MalformedURLException e) {
 869 				e.printStackTrace();
 870 			}
 871 		}
 872 
 873 		@Override
 874 		protected void onPreExecute() {
 875 			super.onPreExecute();
 876 
 877 			mInstallersLoading.setVisibility(View.VISIBLE);
 878 			mUninstallersLoading.setVisibility(View.VISIBLE);
 879 			mInfoInstaller.setVisibility(View.GONE);
 880 			mInfoUninstaller.setVisibility(View.GONE);
 881 		}
 882 
 883 		@Override
 884 		protected Boolean doInBackground(Void... params) {
 885 			try {
 886 				HttpURLConnection c = (HttpURLConnection) mUrl.openConnection();
 887 				c.setRequestMethod(&quot;GET&quot;);
 888 				c.setDoOutput(true);
 889 				c.connect();
 890 
 891 				BufferedReader br = new BufferedReader(
 892 						new InputStreamReader(c.getInputStream()));
 893 				StringBuilder sb = new StringBuilder();
 894 				String line;
 895 				while ((line = br.readLine()) != null) {
 896 					sb.append(line).append(&quot;\n&quot;);
 897 				}
 898 				br.close();
 899 
 900 				JSONObject json = new JSONObject(sb.toString());
 901 				JSONArray installerArray = json.getJSONArray(&quot;installer&quot;);
 902 				JSONArray uninstallerArray = json.getJSONArray(&quot;uninstaller&quot;);
 903 
 904 				installers = new ArrayList&lt;&gt;();
 905 				uninstallers = new ArrayList&lt;&gt;();
 906 
 907 				for (int i = 0; i &lt; installerArray.length(); i++) {
 908 					JSONObject jsonObject = installerArray.getJSONObject(i);
 909 
 910 					String link = jsonObject.getString(&quot;link&quot;);
 911 					String name = jsonObject.getString(&quot;name&quot;);
 912 					String architecture = jsonObject.getString(&quot;architecture&quot;);
 913 					String version = jsonObject.getString(&quot;version&quot;);
 914 					int sdk = jsonObject.getInt(&quot;sdk&quot;);
 915 
 916 					installers.add(new XposedZip.Installer(link, name,
 917 							architecture, sdk, version));
 918 				}
 919 
 920 				if (Build.VERSION.SDK_INT &gt;= 21) {
 921 					for (int i = 0; i &lt; uninstallerArray.length(); i++) {
 922 						JSONObject jsonObject = uninstallerArray
 923 								.getJSONObject(i);
 924 
 925 						String link = jsonObject.getString(&quot;link&quot;);
 926 						String name = jsonObject.getString(&quot;name&quot;);
 927 						String architecture = jsonObject
 928 								.getString(&quot;architecture&quot;);
 929 						String date = jsonObject.getString(&quot;date&quot;);
 930 
 931 						uninstallers.add(new Uninstaller(link, name,
 932 								architecture, date));
 933 					}
 934 				} else {
 935 					uninstallers.add(new Uninstaller());
 936 				}
 937 
 938 				newApkVersion = json.getJSONObject(&quot;apk&quot;).getString(&quot;version&quot;);
 939 				newApkLink = json.getJSONObject(&quot;apk&quot;).getString(&quot;link&quot;);
 940 				newApkChangelog = json.getJSONObject(&quot;apk&quot;)
 941 						.getString(&quot;changelog&quot;);
 942 				return true;
 943 			} catch (Exception e) {
 944 				e.printStackTrace();
 945 				return false;
 946 			}
 947 		}
 948 
 949 		@Override
 950 		protected void onPostExecute(Boolean result) {
 951 			super.onPostExecute(result);
 952 
 953 			btnInstall.setEnabled(result);
 954 			btnUninstall.setEnabled(result);
 955 
 956 			mInstallersLoading.setVisibility(View.GONE);
 957 			mUninstallersLoading.setVisibility(View.GONE);
 958 
 959 			int i = result ? View.VISIBLE : View.GONE;
 960 
 961 			mInstallersChooser.setVisibility(i);
 962 			mUninstallersChooser.setVisibility(i);
 963 
 964 			mInfoInstaller.setVisibility(i);
 965 			mInfoUninstaller.setVisibility(i);
 966 
 967 			if (Build.VERSION.SDK_INT &lt; 21) {
 968 				btnInstall.setEnabled(false);
 969 				btnUninstall.setEnabled(false);
 970 				mInfoInstaller.setEnabled(false);
 971 				mInfoUninstaller.setEnabled(false);
 972 				mInstallersChooser.setEnabled(false);
 973 				mUninstallersChooser.setEnabled(false);
 974 
 975 				mInstallForbidden.setVisibility(View.VISIBLE);
 976 			}
 977 
 978 			try {
 979 
 980 			if (!result) {
 981 				Toast.makeText(getContext(), R.string.loadingError,
 982 						Toast.LENGTH_LONG).show();
 983 				return;
 984 			}
 985 
 986 				mInstallersChooser
 987 						.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(),
 988 								getInstallersBySdk(Build.VERSION.SDK_INT)));
 989 
 990 				mUninstallersChooser.setAdapter(
 991 						new XposedZip.MyAdapter&lt;&gt;(getContext(), uninstallers));
 992 
 993 			if (newApkChangelog != null) {
 994 				mInfoUpdate.setOnClickListener(new View.OnClickListener() {
 995 					@Override
 996 					public void onClick(View v) {
 997 						new MaterialDialog.Builder(getContext())
 998 								.title(R.string.changes)
 999 								.content(Html.fromHtml(newApkChangelog))
1000 								.positiveText(android.R.string.ok).show();
1001 					}
1002 				});
1003 			} else {
1004 				mInfoUpdate.setVisibility(View.GONE);
1005 			}
1006 
1007 			if (newApkVersion == null)
1008 				return;
1009 
1010 			SharedPreferences prefs = null;
1011 			try {
1012 				prefs = getContext().getSharedPreferences(
1013 						getContext().getPackageName() + &quot;_preferences&quot;,
1014 						MODE_PRIVATE);
1015 
1016 				prefs.edit().putString(&quot;changelog_&quot; + newApkVersion,
1017 						newApkChangelog).apply();
1018 			} catch (NullPointerException ignored) {
1019 			}
1020 
1021 			BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);
1022 			BigInteger b = new BigInteger(newApkVersion);
1023 
1024 			if (a.compareTo(b) == -1) {
1025 				mUpdateView.setVisibility(View.VISIBLE);
1026 					mUpdateButton
1027 							.setOnClickListener(new View.OnClickListener() {
1028 					@Override
1029 					public void onClick(View v) {
1030 						if (write())
1031 							return;
1032 
1033 						DownloadsUtil.add(getContext(),
1034 											&quot;XposedInstaller_by_dvdandroid&quot;,
1035 											newApkLink,
1036 								new DownloadsUtil.DownloadFinishedCallback() {
1037 							@Override
1038 										public void onDownloadFinished(
1039 												Context context,
1040 									DownloadsUtil.DownloadInfo info) {
1041 											Intent intent = new Intent(
1042 													Intent.ACTION_VIEW);
1043 								intent.setDataAndType(
1044 													Uri.fromFile(
1045 															new File(Environment
1046 												.getExternalStorageDirectory()
1047 												.getAbsolutePath()
1048 												+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),
1049 										DownloadsUtil.MIME_TYPE_APK);
1050 											intent.setFlags(
1051 													Intent.FLAG_ACTIVITY_NEW_TASK);
1052 								context.startActivity(intent);
1053 							}
1054 						}, DownloadsUtil.MIME_TYPES.APK, true);
1055 					}
1056 				});
1057 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
1058 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1059 							.putString(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1060 									&quot;changelog_&quot; + XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1061 									newApkChangelog)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1062 							.apply();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1063 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1064 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">1065 		}</span>
1066 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1067 				} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1068 					if (prefs != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1069 						prefs.edit()</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1070 								.putString(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1071 										&quot;changelog_&quot;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1072 												+ XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1073 										newApkChangelog)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1074 								.apply();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1075 					}</span>
1076 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
1077 			}
1078 			} catch (NullPointerException ignored) {
1079 			}
1080 		}
1081 	}
1082 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package de.robv.android.xposed.installer;
   2 
   3 import android.Manifest;
   4 import android.annotation.TargetApi;
   5 import android.app.Activity;
   6 import android.content.Context;
   7 import android.content.DialogInterface;
   8 import android.content.Intent;
   9 import android.content.SharedPreferences;
  10 import android.content.pm.PackageManager;
  11 import android.net.Uri;
  12 import android.os.AsyncTask;
  13 import android.os.Build;
  14 import android.os.Bundle;
  15 import android.os.Environment;
  16 import android.os.Looper;
  17 import android.os.ParcelFileDescriptor;
  18 import android.support.annotation.NonNull;
  19 import android.support.v4.app.ActivityCompat;
  20 import android.support.v4.app.Fragment;
  21 import android.support.v7.widget.CardView;
  22 import android.system.Os;
  23 import android.text.Html;
  24 import android.text.TextUtils;
  25 import android.util.Log;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.widget.Button;
  33 import android.widget.CheckBox;
  34 import android.widget.ImageView;
  35 import android.widget.ProgressBar;
  36 import android.widget.Spinner;
  37 import android.widget.TextView;
  38 import android.widget.Toast;
  39 import com.afollestad.materialdialogs.MaterialDialog;
  40 import de.robv.android.xposed.installer.util.AssetUtil;
  41 import de.robv.android.xposed.installer.util.DownloadsUtil;
  42 import de.robv.android.xposed.installer.util.NavUtil;
  43 import de.robv.android.xposed.installer.util.NotificationUtil;
  44 import de.robv.android.xposed.installer.util.RootUtil;
  45 import de.robv.android.xposed.installer.util.ThemeUtil;
  46 import de.robv.android.xposed.installer.util.XposedZip;
  47 import java.io.BufferedReader;
  48 import java.io.File;
  49 import java.io.IOException;
  50 import java.io.InputStreamReader;
  51 import java.math.BigInteger;
  52 import java.net.HttpURLConnection;
  53 import java.net.MalformedURLException;
  54 import java.net.URL;
  55 import java.util.ArrayList;
  56 import java.util.LinkedList;
  57 import java.util.List;
  58 import java.util.Locale;
  59 import org.json.JSONArray;
  60 import org.json.JSONObject;
  61 import static android.content.Context.MODE_PRIVATE;
  62 import static de.robv.android.xposed.installer.XposedApp.WRITE_EXTERNAL_PERMISSION;
  63 import static de.robv.android.xposed.installer.util.XposedZip.Installer;
  64 import static de.robv.android.xposed.installer.util.XposedZip.Uninstaller;
  65 
  66 
<abbr title="  67 public class InstallerFragment extends Fragment implements ActivityCompat.OnRequestPermissionsResultCallback , DownloadsUtil.DownloadFinishedCallback {">  67 public class InstallerFragment extends Fragment implements ActivityCompat.OnRequestPermissionsResultCallbðŸ”µ</abbr>
  68 	public static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;
  69 
  70 	private static final int INSTALL_MODE_NORMAL = 0;
  71 
  72 	private static final int INSTALL_MODE_RECOVERY_AUTO = 1;
  73 
  74 	private static final int INSTALL_MODE_RECOVERY_MANUAL = 2;
  75 
<abbr title="  76 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposed.json&quot;;">  76 	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/materialðŸ”µ</abbr>
  77 
  78 	private static List&lt;String&gt; messages = new LinkedList&lt;&gt;();
  79 
  80 	private static ArrayList&lt;Installer&gt; installers;
  81 
  82 	private static ArrayList&lt;Uninstaller&gt; uninstallers;
  83 
  84 	private final LinkedList&lt;String&gt; mCompatibilityErrors = new LinkedList&lt;&gt;();
  85 
  86 	private String APP_PROCESS_NAME = null;
  87 
  88 	private RootUtil mRootUtil = new RootUtil();
  89 
  90 	private boolean mHadSegmentationFault = false;
  91 
  92 	private MaterialDialog.Builder dlgProgress;
  93 
  94 	private TextView txtInstallError;
  95 
  96 	private TextView txtKnownIssue;
  97 
  98 	private Button btnInstall;
  99 
 100 	private Button btnUninstall;
 101 
 102 	private ProgressBar mInstallersLoading;
 103 
 104 	private Spinner mInstallersChooser;
 105 
 106 	private ProgressBar mUninstallersLoading;
 107 
 108 	private Spinner mUninstallersChooser;
 109 
 110 	private ImageView mInfoInstaller;
 111 
 112 	private ImageView mInfoUninstaller;
 113 
 114 	private String newApkVersion = XposedApp.THIS_APK_VERSION;
 115 
 116 	private String newApkLink;
 117 
 118 	private String newApkChangelog;
 119 
 120 	private CardView mUpdateView;
 121 
 122 	private Button mUpdateButton;
 123 
 124 	private TextView mInstallForbidden;
 125 
 126 	private ImageView mInfoUpdate;
 127 
 128 	private static int extractIntPart(String str) {
 129 		int result = 0, length = str.length();
 130 		for (int offset = 0; offset &lt; length; offset++) {
 131 			char c = str.charAt(offset);
 132 			if (&#x27;0&#x27; &lt;= c &amp;&amp; c &lt;= &#x27;9&#x27;)
 133 				result = result * 10 + (c - &#x27;0&#x27;);
 134 			else
 135 				break;
 136 		}
 137 		return result;
 138 	}
 139 
 140 	private static boolean checkClassExists(String className) {
 141 		try {
 142 			Class.forName(className);
 143 			return true;
 144 		} catch (ClassNotFoundException e) {
 145 			return false;
 146 		}
 147 	}
 148 
 149 	public static ArrayList&lt;Installer&gt; getInstallersBySdk(int sdk) {
 150 		ArrayList&lt;Installer&gt; list = new ArrayList&lt;&gt;();
 151 		for (Installer i : installers) {
 152 			if (i.sdk == sdk)
 153 				list.add(i);
 154 		}
 155 
 156 		if (list.size() == 0) {
 157 			list.add(new Installer());
 158 		}
 159 		return list;
 160 	}
 161 
 162 	/*
 163 	 * public static ArrayList&lt;Installer&gt; getInstallersBySdkAndArchitecture( int
 164 	 * sdk, String architecture) { ArrayList&lt;Installer&gt; list = new
 165 	 * ArrayList&lt;&gt;(); ArrayList&lt;Installer&gt; list2 = new ArrayList&lt;&gt;(); for
 166 	 * (Installer i : installers) { if (i.sdk == sdk) list.add(i); } for
 167 	 * (Installer i : list) { if (i.architecture.equals(architecture))
 168 	 * list2.add(i); } return list2; }
 169 	 *
 170 	 * public static ArrayList&lt;Uninstaller&gt; getUninstallersByArchitecture(
 171 	 * String architecture) { ArrayList&lt;Uninstaller&gt; list = new ArrayList&lt;&gt;();
 172 	 * for (Uninstaller u : uninstallers) { if
 173 	 * (u.architecture.equals(architecture)) list.add(u); } return list; }
 174 	 */
 175 
 176 	@Override
 177 	public void onActivityCreated(Bundle savedInstanceState) {
 178 		super.onActivityCreated(savedInstanceState);
 179 		Activity activity = getActivity();
 180 
 181 		dlgProgress = new MaterialDialog.Builder(activity).progress(true, 0);
 182 		setHasOptionsMenu(true);
 183 	}
 184 
 185 	@Override
 186 	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 187 		View v = inflater.inflate(R.layout.tab_installer, container, false);
 188 		txtInstallError = ((TextView) (v.findViewById(R.id.framework_install_errors)));
 189 		txtKnownIssue = ((TextView) (v.findViewById(R.id.framework_known_issue)));
 190 		btnInstall = ((Button) (v.findViewById(R.id.btnInstall)));
 191 		btnUninstall = ((Button) (v.findViewById(R.id.btnUninstall)));
 192 		mInstallersLoading = ((ProgressBar) (v.findViewById(R.id.loadingInstallers)));
 193 		mUninstallersLoading = ((ProgressBar) (v.findViewById(R.id.loadingUninstallers)));
 194 		mInstallersChooser = ((Spinner) (v.findViewById(R.id.chooserInstallers)));
 195 		mUninstallersChooser = ((Spinner) (v.findViewById(R.id.chooserUninstallers)));
 196 		mUpdateView = ((CardView) (v.findViewById(R.id.updateView)));
 197 		mUpdateButton = ((Button) (v.findViewById(R.id.updateButton)));
 198 		mInfoInstaller = ((ImageView) (v.findViewById(R.id.infoInstaller)));
 199 		mInfoUninstaller = ((ImageView) (v.findViewById(R.id.infoUninstaller)));
 200 		mInstallForbidden = ((TextView) (v.findViewById(R.id.installationForbidden)));
 201 		mInfoUpdate = ((ImageView) (v.findViewById(R.id.infoUpdate)));
 202 		String installedXposedVersion = XposedApp.getXposedProp().get(&quot;version&quot;);
 203 		if (Build.VERSION.SDK_INT &gt;= 21) {
 204 			if (installedXposedVersion == null) {
 205 				txtInstallError.setText(R.string.installation_lollipop);
 206 				txtInstallError.setTextColor(getResources().getColor(R.color.warning));
 207 			} else {
 208 				int installedXposedVersionInt = extractIntPart(installedXposedVersion);
 209 				if (installedXposedVersionInt == XposedApp.getXposedVersion()) {
 210 					txtInstallError.setText(getString(R.string.installed_lollipop, installedXposedVersion));
 211 					txtInstallError.setTextColor(getResources().getColor(R.color.darker_green));
 212 				} else {
 213 					txtInstallError.setText(getString(R.string.installed_lollipop_inactive, installedXposedVersion));
 214 					txtInstallError.setTextColor(getResources().getColor(R.color.warning));
 215 				}
 216 			}
 217 		} else if (XposedApp.getXposedVersion() != 0) {
 218 			txtInstallError.setText(getString(R.string.installed_lollipop, XposedApp.getXposedVersion()));
 219 			txtInstallError.setTextColor(getResources().getColor(R.color.darker_green));
 220 		} else {
 221 			txtInstallError.setText(getString(R.string.not_installed_no_lollipop));
 222 			txtInstallError.setTextColor(getResources().getColor(R.color.warning));
 223 		}
 224 		txtInstallError.setVisibility(View.VISIBLE);
 225 		if (!XposedApp.getPreferences().getBoolean(&quot;hide_install_warning&quot;, false)) {
 226 			final View dontShowAgainView = inflater.inflate(R.layout.dialog_install_warning, null);
<abbr title=" 227 			new MaterialDialog.Builder(getActivity()).title(R.string.install_warning_title).customView(dontShowAgainView, false).positiveText(android.R.string.ok).callback(new MaterialDialog.ButtonCallback() {"> 227 			new MaterialDialog.Builder(getActivity()).title(R.string.install_warning_title).customView(dontShowAgaðŸ”µ</abbr>
 228 				@Override
 229 				public void onPositive(MaterialDialog dialog) {
 230 					super.onPositive(dialog);
 231 					CheckBox checkBox = ((CheckBox) (dontShowAgainView.findViewById(android.R.id.checkbox)));
 232 					if (checkBox.isChecked()) {
 233 						XposedApp.getPreferences().edit().putBoolean(&quot;hide_install_warning&quot;, true).apply();
 234 					}
 235 				}
 236 			}).cancelable(false).show();
 237 		}
 238 		new JSONParser(JSON_LINK).execute();
 239 		mInfoInstaller.setOnClickListener(new View.OnClickListener() {
 240 			@Override
 241 			public void onClick(View v) {
 242 				Installer selectedInstaller = ((Installer) (mInstallersChooser.getSelectedItem()));
<abbr title=" 243 				String s = getString(R.string.infoInstaller, selectedInstaller.name, selectedInstaller.sdk, selectedInstaller.architecture, selectedInstaller.version);"> 243 				String s = getString(R.string.infoInstaller, selectedInstaller.name, selectedInstaller.sdk, selectedIðŸ”µ</abbr>
<abbr title=" 244 				new MaterialDialog.Builder(getContext()).title(R.string.info).content(s).positiveText(android.R.string.ok).show();"> 244 				new MaterialDialog.Builder(getContext()).title(R.string.info).content(s).positiveText(android.R.strinðŸ”µ</abbr>
 245 			}
 246 		});
 247 		mInfoUninstaller.setOnClickListener(new View.OnClickListener() {
 248 			@Override
 249 			public void onClick(View v) {
 250 				Uninstaller selectedUninstaller = ((Uninstaller) (mUninstallersChooser.getSelectedItem()));
<abbr title=" 251 				String s = getString(R.string.infoUninstaller, selectedUninstaller.name, selectedUninstaller.architecture, selectedUninstaller.date);"> 251 				String s = getString(R.string.infoUninstaller, selectedUninstaller.name, selectedUninstaller.architecðŸ”µ</abbr>
<abbr title=" 252 				new MaterialDialog.Builder(getContext()).title(R.string.info).content(s).positiveText(android.R.string.ok).show();"> 252 				new MaterialDialog.Builder(getContext()).title(R.string.info).content(s).positiveText(android.R.strinðŸ”µ</abbr>
 253 			}
 254 		});
 255 		btnInstall.setOnClickListener(new View.OnClickListener() {
 256 			@Override
 257 			public void onClick(View v) {
 258 				if (write()) {
 259 					return;
 260 				}
 261 				areYouSure(R.string.warningArchitecture, new MaterialDialog.ButtonCallback() {
 262 					@Override
 263 					public void onPositive(MaterialDialog dialog) {
 264 						super.onPositive(dialog);
 265 						Installer selectedInstaller = ((Installer) (mInstallersChooser.getSelectedItem()));
<abbr title=" 266 						DownloadsUtil.add(getContext(), selectedInstaller.name, selectedInstaller.link, InstallerFragment.this, DownloadsUtil.MIME_TYPES.ZIP, true);"> 266 						DownloadsUtil.add(getContext(), selectedInstaller.name, selectedInstaller.link, InstallerFragment.tðŸ”µ</abbr>
 267 					}
 268 				});
 269 			}
 270 		});
 271 		btnUninstall.setOnClickListener(new View.OnClickListener() {
 272 			@Override
 273 			public void onClick(View v) {
 274 				if (write()) {
 275 					return;
 276 				}
 277 				areYouSure(R.string.warningArchitecture, new MaterialDialog.ButtonCallback() {
 278 					@Override
 279 					public void onPositive(MaterialDialog dialog) {
 280 						super.onPositive(dialog);
 281 						Uninstaller selectedUninstaller = ((Uninstaller) (mUninstallersChooser.getSelectedItem()));
<abbr title=" 282 						DownloadsUtil.add(getContext(), selectedUninstaller.name, selectedUninstaller.link, InstallerFragment.this, DownloadsUtil.MIME_TYPES.ZIP, true);"> 282 						DownloadsUtil.add(getContext(), selectedUninstaller.name, selectedUninstaller.link, InstallerFragmeðŸ”µ</abbr>
 283 					}
 284 				});
 285 			}
 286 		});
 287 		return v;
 288 	}
 289 
 290 	@Override
 291 	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 292 		inflater.inflate(R.menu.menu_installer, menu);
 293 	}
 294 
 295 	@Override
 296 	public boolean onOptionsItemSelected(MenuItem item) {
 297 
 298 		switch (item.getItemId()) {
 299 			case R.id.help:
 300 				new MaterialDialog.Builder(getContext()).title(R.string.help)
 301 						.content(R.string.helpChoose)
 302 						.positiveText(android.R.string.ok).show();
 303 				break;
 304 			case R.id.installation_mode:
 305 				Intent intent = new Intent(getActivity(),
 306 						SettingsActivity.class);
 307 				startActivity(intent);
 308 				break;
 309 			case R.id.reboot:
 310 				areYouSure(R.string.reboot,
 311 						new MaterialDialog.ButtonCallback() {
 312 							@Override
 313 							public void onPositive(MaterialDialog dialog) {
 314 								super.onPositive(dialog);
 315 								reboot(null);
 316 							}
 317 						});
 318 				break;
 319 			case R.id.soft_reboot:
 320 				areYouSure(R.string.reboot,
 321 						new MaterialDialog.ButtonCallback() {
 322 							@Override
 323 							public void onPositive(MaterialDialog dialog) {
 324 								super.onPositive(dialog);
 325 								softReboot();
 326 							}
 327 						});
 328 				break;
 329 		}
 330 
 331 		return super.onOptionsItemSelected(item);
 332 	}
 333 
 334 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 335 	public void performFileSearch() {
 336 		Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 337 		intent.addCategory(Intent.CATEGORY_OPENABLE);
 338 		intent.setType(&quot;application/zip&quot;);
 339 		startActivityForResult(intent, 123);
 340 	}
 341 
 342 	@Override
 343 	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 344 	public void onActivityResult(int requestCode, int resultCode,
 345 			Intent resultData) {
 346 		if (requestCode == 123 &amp;&amp; resultCode == Activity.RESULT_OK) {
 347 			if (resultData != null) {
 348 				Uri uri = resultData.getData();
 349 				String resolved = null;
 350 				try (ParcelFileDescriptor fd = getActivity()
 351 						.getContentResolver().openFileDescriptor(uri, &quot;r&quot;)) {
 352 					final File procfsFdFile = new File(
 353 							&quot;/proc/self/fd/&quot; + fd.getFd());
 354 
 355 					resolved = Os.readlink(procfsFdFile.getAbsolutePath());
 356 
 357 					if (TextUtils.isEmpty(resolved) || resolved.charAt(0) != &#x27;/&#x27;
 358 							|| resolved.startsWith(&quot;/proc/&quot;)
 359 							|| resolved.startsWith(&quot;/fd/&quot;))
 360 						;
 361 				} catch (Exception errnoe) {
 362 					Log.e(XposedApp.TAG, &quot;ReadError&quot;);
 363 				}
 364 				mRootUtil.execute(&quot;cp &quot; + resolved + &quot; /cache/xposed.zip&quot;,
 365 						messages);
 366 				installXposedZip();
 367 			}
 368 		}
 369 	}
 370 
 371 	private void installXposedZip() {
 372 		mRootUtil.execute(
 373 				&quot;echo &#x27;install /cache/xposed.zip&#x27; &gt;/cache/recovery/openrecoveryscript &quot;,
 374 				messages);
 375 		mRootUtil.execute(&quot;sync&quot;, messages);
 376 		reboot(&quot;recovery&quot;);
 377 	}
 378 
 379 	@Override
 380 	public void onRequestPermissionsResult(int requestCode,
 381 			@NonNull String[] permissions, @NonNull int[] grantResults) {
 382 		if (requestCode == WRITE_EXTERNAL_PERMISSION) {
 383 			if (grantResults.length == 1
 384 					&amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {
 385 				Toast.makeText(getActivity(), R.string.permissionGranted,
 386 						Toast.LENGTH_LONG).show();
 387 			} else {
 388 				Toast.makeText(getActivity(), R.string.permissionNotGranted,
 389 						Toast.LENGTH_LONG).show();
 390 			}
 391 		} else {
 392 			super.onRequestPermissionsResult(requestCode, permissions,
 393 					grantResults);
 394 		}
 395 	}
 396 
 397 	private boolean write() {
 398 		if (ActivityCompat.checkSelfPermission(getContext(),
 399 				Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
 400 
 401 			ActivityCompat.requestPermissions(getActivity(),
 402 					new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE },
 403 					WRITE_EXTERNAL_PERMISSION);
 404 
 405 			return true;
 406 		} else {
 407 			return false;
 408 		}
 409 	}
 410 
 411 	@Override
 412 	public void onResume() {
 413 		super.onResume();
 414 		NotificationUtil.cancel(NotificationUtil.NOTIFICATION_MODULES_UPDATED);
 415 		mHadSegmentationFault = false;
 416 		refreshKnownIssue();
 417 	}
 418 
 419 	@Override
 420 	public void onDestroy() {
 421 		super.onDestroy();
 422 		mRootUtil.dispose();
 423 	}
 424 
 425 	private String versionToText(int version) {
 426 		return (version == 0) ? getString(R.string.none)
 427 				: Integer.toString(version);
 428 	}
 429 
 430 	private void refreshKnownIssue() {
 431 		String issueName = null;
 432 		String issueLink = null;
 433 
 434 		if (new File(&quot;/system/framework/core.jar.jex&quot;).exists()) {
 435 			issueName = &quot;Aliyun OS&quot;;
 436 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52289793&amp;postcount=5&quot;;
 437 
 438 		} else if (new File(&quot;/data/miui/DexspyInstaller.jar&quot;).exists()
 439 				|| checkClassExists(&quot;miui.dexspy.DexspyInstaller&quot;)) {
 440 			issueName = &quot;MIUI/Dexspy&quot;;
 441 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52291098&amp;postcount=6&quot;;
 442 
 443 		} else if (mHadSegmentationFault) {
 444 			issueName = &quot;Segmentation fault&quot;;
 445 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52292102&amp;postcount=7&quot;;
 446 
 447 		} else
 448 			if (checkClassExists(&quot;com.huawei.android.content.res.ResourcesEx&quot;)
 449 					|| checkClassExists(&quot;android.content.res.NubiaResources&quot;)) {
 450 			issueName = &quot;Resources subclass&quot;;
 451 			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52801382&amp;postcount=8&quot;;
 452 		}
 453 
 454 		if (issueName != null) {
 455 			final String issueLinkFinal = issueLink;
 456 			txtKnownIssue.setText(
 457 					getString(R.string.install_known_issue, issueName));
 458 			txtKnownIssue.setVisibility(View.VISIBLE);
 459 			txtKnownIssue.setOnClickListener(new View.OnClickListener() {
 460 				@Override
 461 				public void onClick(View v) {
 462 					NavUtil.startURL(getActivity(), issueLinkFinal);
 463 				}
 464 			});
 465 
 466 			txtInstallError.setTextColor(ThemeUtil.getThemeColor(getActivity(),
 467 					android.R.attr.textColorTertiary));
 468 		} else {
 469 			txtKnownIssue.setVisibility(View.GONE);
 470 		}
 471 	}
 472 
 473 	private void showAlert(final String result) {
 474 		if (Looper.myLooper() != Looper.getMainLooper()) {
 475 			getActivity().runOnUiThread(new Runnable() {
 476 				@Override
 477 				public void run() {
 478 					showAlert(result);
 479 				}
 480 			});
 481 			return;
 482 		}
 483 
 484 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 485 				.content(result).positiveText(android.R.string.ok).build();
 486 		dialog.show();
 487 
 488 		TextView txtMessage = (TextView) dialog
 489 				.findViewById(android.R.id.message);
 490 		try {
 491 			txtMessage.setTextSize(14);
 492 		} catch (NullPointerException ignored) {
 493 		}
 494 
 495 		mHadSegmentationFault = result.toLowerCase(Locale.US)
 496 				.contains(&quot;segmentation fault&quot;);
 497 		refreshKnownIssue();
 498 	}
 499 
 500 	private void areYouSure(int messageTextId,
 501 			MaterialDialog.ButtonCallback yesHandler) {
 502 		new MaterialDialog.Builder(getActivity()).title(messageTextId)
 503 				.content(R.string.areyousure)
 504 				.iconAttr(android.R.attr.alertDialogIcon)
 505 				.positiveText(android.R.string.yes)
 506 				.negativeText(android.R.string.no).callback(yesHandler).show();
 507 	}
 508 
 509 	private void showConfirmDialog(final String message,
 510 			final MaterialDialog.ButtonCallback callback) {
 511 		if (Looper.myLooper() != Looper.getMainLooper()) {
 512 			getActivity().runOnUiThread(new Runnable() {
 513 				@Override
 514 				public void run() {
 515 					showConfirmDialog(message, callback);
 516 				}
 517 			});
 518 			return;
 519 		}
 520 
 521 		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 522 				.content(message).positiveText(android.R.string.yes)
 523 				.negativeText(android.R.string.no).callback(callback).build();
 524 
 525 		TextView txtMessage = (TextView) dialog
 526 				.findViewById(android.R.id.message);
 527 		txtMessage.setTextSize(14);
 528 
 529 		mHadSegmentationFault = message.toLowerCase(Locale.US)
 530 				.contains(&quot;segmentation fault&quot;);
 531 		refreshKnownIssue();
 532 	}
 533 
 534 	private boolean checkCompatibility() {
 535 		mCompatibilityErrors.clear();
 536 		return checkAppProcessCompatibility();
 537 	}
 538 
 539 	private boolean checkAppProcessCompatibility() {
 540 		try {
 541 			if (APP_PROCESS_NAME == null)
 542 				return false;
 543 
 544 			File testFile = AssetUtil.writeAssetToCacheFile(APP_PROCESS_NAME,
 545 					&quot;app_process&quot;, 00700);
 546 			if (testFile == null) {
 547 				mCompatibilityErrors
 548 						.add(&quot;could not write app_process to cache&quot;);
 549 				return false;
 550 			}
 551 
 552 			Process p = Runtime.getRuntime().exec(new String[] {
 553 					testFile.getAbsolutePath(), &quot;--xposedversion&quot; });
 554 
 555 			BufferedReader stdout = new BufferedReader(
 556 					new InputStreamReader(p.getInputStream()));
 557 			String result = stdout.readLine();
 558 			stdout.close();
 559 
 560 			BufferedReader stderr = new BufferedReader(
 561 					new InputStreamReader(p.getErrorStream()));
 562 			String errorLine;
 563 			while ((errorLine = stderr.readLine()) != null) {
 564 				mCompatibilityErrors.add(errorLine);
 565 			}
 566 			stderr.close();
 567 
 568 			p.destroy();
 569 
 570 			testFile.delete();
 571 			return result != null &amp;&amp; result.startsWith(&quot;Xposed version: &quot;);
 572 		} catch (IOException e) {
 573 			mCompatibilityErrors.add(e.getMessage());
 574 			return false;
 575 		}
 576 	}
 577 
 578 	private boolean startShell() {
 579 		if (mRootUtil.startShell())
 580 			return true;
 581 
 582 		showAlert(getString(R.string.root_failed));
 583 		return false;
 584 	}
 585 
 586 	private int getInstallMode() {
 587 		int mode = XposedApp.getPreferences().getInt(&quot;install_mode&quot;,
 588 				INSTALL_MODE_NORMAL);
 589 		if (mode &lt; INSTALL_MODE_NORMAL || mode &gt; INSTALL_MODE_RECOVERY_MANUAL)
 590 			mode = INSTALL_MODE_NORMAL;
 591 		return mode;
 592 	}
 593 
 594 	private String getInstallModeText() {
 595 		final int installMode = getInstallMode();
 596 		switch (installMode) {
 597 			case INSTALL_MODE_NORMAL:
 598 				return getString(R.string.install_mode_normal);
 599 			case INSTALL_MODE_RECOVERY_AUTO:
 600 				return getString(R.string.install_mode_recovery_auto);
 601 			case INSTALL_MODE_RECOVERY_MANUAL:
 602 				return getString(R.string.install_mode_recovery_manual);
 603 		}
 604 		throw new IllegalStateException(&quot;unknown install mode &quot; + installMode);
 605 	}
 606 
 607 	private boolean prepareAutoFlash(List&lt;String&gt; messages, String file) {
 608 		if (mRootUtil.execute(&quot;ls /cache/recovery&quot;, null) != 0) {
 609 			messages.add(getString(R.string.file_creating_directory,
 610 					&quot;/cache/recovery&quot;));
 611 			if (mRootUtil.executeWithBusybox(&quot;mkdir /cache/recovery&quot;,
 612 					messages) != 0) {
 613 				messages.add(&quot;&quot;);
 614 				messages.add(getString(R.string.file_create_directory_failed,
 615 						&quot;/cache/recovery&quot;));
 616 				return false;
 617 			}
 618 		}
 619 
 620 		messages.add(getString(R.string.file_copying, file));
 621 		File tempFile = AssetUtil.writeAssetToCacheFile(file, 00644);
 622 		if (tempFile == null) {
 623 			messages.add(&quot;&quot;);
 624 			messages.add(getString(R.string.file_extract_failed, file));
 625 			return false;
 626 		}
 627 
 628 		if (mRootUtil.executeWithBusybox(&quot;cp -a &quot; + tempFile.getAbsolutePath()
 629 				+ &quot; /cache/recovery/&quot; + file, messages) != 0) {
 630 			messages.add(&quot;&quot;);
 631 			messages.add(getString(R.string.file_copy_failed, file, &quot;/cache&quot;));
 632 			tempFile.delete();
 633 			return false;
 634 		}
 635 
 636 		tempFile.delete();
 637 
 638 		messages.add(getString(R.string.file_writing_recovery_command));
 639 		if (mRootUtil.execute(
 640 				&quot;echo \&quot;--update_package=/cache/recovery/&quot; + file
 641 						+ &quot;\n--show_text\&quot; &gt; /cache/recovery/command&quot;,
 642 				messages) != 0) {
 643 			messages.add(&quot;&quot;);
 644 			messages.add(
 645 					getString(R.string.file_writing_recovery_command_failed));
 646 			return false;
 647 		}
 648 
 649 		return true;
 650 	}
 651 
 652 	private boolean prepareManualFlash(List&lt;String&gt; messages, String file) {
 653 		messages.add(getString(R.string.file_copying, file));
 654 		if (AssetUtil.writeAssetToSdcardFile(file, 00644) == null) {
 655 			messages.add(&quot;&quot;);
 656 			messages.add(getString(R.string.file_extract_failed, file));
 657 			return false;
 658 		}
 659 
 660 		return true;
 661 	}
 662 
 663 	private void offerReboot(List&lt;String&gt; messages) {
 664 		messages.add(getString(R.string.file_done));
 665 		messages.add(&quot;&quot;);
 666 		messages.add(getString(R.string.reboot_confirmation));
 667 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 668 				new MaterialDialog.ButtonCallback() {
 669 					@Override
 670 					public void onPositive(MaterialDialog dialog) {
 671 						super.onPositive(dialog);
 672 						reboot(null);
 673 					}
 674 				});
 675 	}
 676 
 677 	private void offerRebootToRecovery(List&lt;String&gt; messages, final String file,
 678 			final int installMode) {
 679 		if (installMode == INSTALL_MODE_RECOVERY_AUTO)
 680 			messages.add(getString(R.string.auto_flash_note, file));
 681 		else
 682 			messages.add(getString(R.string.manual_flash_note, file));
 683 
 684 		messages.add(&quot;&quot;);
 685 		messages.add(getString(R.string.reboot_recovery_confirmation));
 686 		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 687 				new MaterialDialog.ButtonCallback() {
 688 					@Override
 689 					public void onPositive(MaterialDialog dialog) {
 690 						super.onPositive(dialog);
 691 						reboot(&quot;recovery&quot;);
 692 					}
 693 
 694 					@Override
 695 					public void onNegative(MaterialDialog dialog) {
 696 						super.onNegative(dialog);
 697 						if (installMode == INSTALL_MODE_RECOVERY_AUTO) {
 698 							// clean up to avoid unwanted flashing
 699 							mRootUtil.executeWithBusybox(
 700 									&quot;rm /cache/recovery/command&quot;, null);
 701 							mRootUtil.executeWithBusybox(
 702 									&quot;rm /cache/recovery/&quot; + file, null);
 703 							AssetUtil.removeBusybox();
 704 						}
 705 					}
 706 				}
 707 
 708 		);
 709 	}
 710 
 711 	private void softReboot() {
 712 		if (!startShell())
 713 			return;
 714 
 715 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 716 		if (mRootUtil.execute(
 717 				&quot;setprop ctl.restart surfaceflinger; setprop ctl.restart zygote&quot;,
 718 				messages) != 0) {
 719 			messages.add(&quot;&quot;);
 720 			messages.add(getString(R.string.reboot_failed));
 721 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 722 		}
 723 	}
 724 
 725 	private void reboot(String mode) {
 726 		if (!startShell())
 727 			return;
 728 
 729 		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 730 
 731 		String command = &quot;reboot&quot;;
 732 		if (mode != null) {
 733 			command += &quot; &quot; + mode;
 734 			if (mode.equals(&quot;recovery&quot;))
 735 				// create a flag used by some kernels to boot into recovery
 736 				mRootUtil.executeWithBusybox(&quot;touch /cache/recovery/boot&quot;,
 737 						messages);
 738 		}
 739 
 740 		if (mRootUtil.executeWithBusybox(command, messages) != 0) {
 741 			messages.add(&quot;&quot;);
 742 			messages.add(getString(R.string.reboot_failed));
 743 			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 744 		}
 745 		AssetUtil.removeBusybox();
 746 	}
 747 
 748 	@Override
 749 	public void onDownloadFinished(final Context context,
 750 			DownloadsUtil.DownloadInfo info) {
 751 		Toast.makeText(context,
 752 				getString(R.string.downloadZipOk, info.localFilename),
 753 				Toast.LENGTH_LONG).show();
 754 
 755 		if (getInstallMode() == INSTALL_MODE_RECOVERY_MANUAL)
 756 			return;
 757 
 758 		areYouSure(R.string.install_warning,
 759 				new MaterialDialog.ButtonCallback() {
 760 					@Override
 761 					public void onPositive(MaterialDialog dialog) {
 762 						super.onPositive(dialog);
 763 						Toast.makeText(context, R.string.selectFile,
 764 								Toast.LENGTH_LONG).show();
 765 
 766 						performFileSearch();
 767 					}
 768 				});
 769 	}
 770 
 771 	private abstract class AsyncClickListener implements View.OnClickListener {
 772 		private final CharSequence mProgressDlgText;
 773 
 774 		public AsyncClickListener(CharSequence progressDlgText) {
 775 			mProgressDlgText = progressDlgText;
 776 		}
 777 
 778 		@Override
 779 		public final void onClick(final View v) {
 780 			if (mProgressDlgText != null) {
 781 				dlgProgress.content(mProgressDlgText);
 782 				dlgProgress.show();
 783 			}
 784 			new Thread() {
 785 				public void run() {
 786 					onAsyncClick(v);
 787 					dlgProgress.build().dismiss();
 788 				}
 789 			}.start();
 790 		}
 791 
 792 		protected abstract void onAsyncClick(View v);
 793 	}
 794 
 795 	private abstract class AsyncDialogClickListener implements DialogInterface.OnClickListener {
 796 		private final CharSequence mProgressDlgText;
 797 
 798 		public AsyncDialogClickListener(CharSequence progressDlgText) {
 799 			mProgressDlgText = progressDlgText;
 800 		}
 801 
 802 		@Override
 803 		public void onClick(final DialogInterface dialog, final int which) {
 804 			if (mProgressDlgText != null) {
 805 				dlgProgress.content(mProgressDlgText);
 806 				dlgProgress.show();
 807 			}
 808 			new Thread() {
 809 				public void run() {
 810 					onAsyncClick(dialog, which);
 811 					dlgProgress.build().dismiss();
 812 				}
 813 			}.start();
 814 		}
 815 
 816 		protected abstract void onAsyncClick(DialogInterface dialog, int which);
 817 	}
 818 
 819 	private class JSONParser extends AsyncTask&lt;Void, Void, Boolean&gt; {
 820 		private URL mUrl;
 821 
 822 		public JSONParser(String mUrl) {
 823 			try {
 824 				this.mUrl = new URL(mUrl);
 825 			} catch (MalformedURLException e) {
 826 				e.printStackTrace();
 827 			}
 828 		}
 829 
 830 		@Override
 831 		protected void onPreExecute() {
 832 			super.onPreExecute();
 833 
 834 			mInstallersLoading.setVisibility(View.VISIBLE);
 835 			mUninstallersLoading.setVisibility(View.VISIBLE);
 836 			mInfoInstaller.setVisibility(View.GONE);
 837 			mInfoUninstaller.setVisibility(View.GONE);
 838 		}
 839 
 840 		@Override
 841 		protected Boolean doInBackground(Void... params) {
 842 			try {
 843 				HttpURLConnection c = (HttpURLConnection) mUrl.openConnection();
 844 				c.setRequestMethod(&quot;GET&quot;);
 845 				c.setDoOutput(true);
 846 				c.connect();
 847 
 848 				BufferedReader br = new BufferedReader(
 849 						new InputStreamReader(c.getInputStream()));
 850 				StringBuilder sb = new StringBuilder();
 851 				String line;
 852 				while ((line = br.readLine()) != null) {
 853 					sb.append(line).append(&quot;\n&quot;);
 854 				}
 855 				br.close();
 856 
 857 				JSONObject json = new JSONObject(sb.toString());
 858 				JSONArray installerArray = json.getJSONArray(&quot;installer&quot;);
 859 				JSONArray uninstallerArray = json.getJSONArray(&quot;uninstaller&quot;);
 860 
 861 				installers = new ArrayList&lt;&gt;();
 862 				uninstallers = new ArrayList&lt;&gt;();
 863 
 864 				for (int i = 0; i &lt; installerArray.length(); i++) {
 865 					JSONObject jsonObject = installerArray.getJSONObject(i);
 866 
 867 					String link = jsonObject.getString(&quot;link&quot;);
 868 					String name = jsonObject.getString(&quot;name&quot;);
 869 					String architecture = jsonObject.getString(&quot;architecture&quot;);
 870 					String version = jsonObject.getString(&quot;version&quot;);
 871 					int sdk = jsonObject.getInt(&quot;sdk&quot;);
 872 
 873 					installers.add(new XposedZip.Installer(link, name,
 874 							architecture, sdk, version));
 875 				}
 876 
 877 				if (Build.VERSION.SDK_INT &gt;= 21) {
 878 					for (int i = 0; i &lt; uninstallerArray.length(); i++) {
 879 						JSONObject jsonObject = uninstallerArray
 880 								.getJSONObject(i);
 881 
 882 						String link = jsonObject.getString(&quot;link&quot;);
 883 						String name = jsonObject.getString(&quot;name&quot;);
 884 						String architecture = jsonObject
 885 								.getString(&quot;architecture&quot;);
 886 						String date = jsonObject.getString(&quot;date&quot;);
 887 
 888 						uninstallers.add(new Uninstaller(link, name,
 889 								architecture, date));
 890 					}
 891 				} else {
 892 					uninstallers.add(new Uninstaller());
 893 				}
 894 
 895 				newApkVersion = json.getJSONObject(&quot;apk&quot;).getString(&quot;version&quot;);
 896 				newApkLink = json.getJSONObject(&quot;apk&quot;).getString(&quot;link&quot;);
 897 				newApkChangelog = json.getJSONObject(&quot;apk&quot;)
 898 						.getString(&quot;changelog&quot;);
 899 				return true;
 900 			} catch (Exception e) {
 901 				e.printStackTrace();
 902 				return false;
 903 			}
 904 		}
 905 
 906 		@Override
 907 		protected void onPostExecute(Boolean result) {
 908 			super.onPostExecute(result);
 909 			btnInstall.setEnabled(result);
 910 			btnUninstall.setEnabled(result);
 911 			mInstallersLoading.setVisibility(View.GONE);
 912 			mUninstallersLoading.setVisibility(View.GONE);
 913 			int i = (result) ? View.VISIBLE : View.GONE;
 914 			mInstallersChooser.setVisibility(i);
 915 			mUninstallersChooser.setVisibility(i);
 916 			mInfoInstaller.setVisibility(i);
 917 			mInfoUninstaller.setVisibility(i);
 918 			if (Build.VERSION.SDK_INT &lt; 21) {
 919 				btnInstall.setEnabled(false);
 920 				btnUninstall.setEnabled(false);
 921 				mInfoInstaller.setEnabled(false);
 922 				mInfoUninstaller.setEnabled(false);
 923 				mInstallersChooser.setEnabled(false);
 924 				mUninstallersChooser.setEnabled(false);
 925 				mInstallForbidden.setVisibility(View.VISIBLE);
 926 			}
 927 			try {
 928 				if (!result) {
 929 					Toast.makeText(getContext(), R.string.loadingError, Toast.LENGTH_LONG).show();
 930 					return;
 931 				}
<abbr title=" 932 				mInstallersChooser.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(), getInstallersBySdk(Build.VERSION.SDK_INT)));"> 932 				mInstallersChooser.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(), getInstallersBySdk(Build.VERSIOðŸ”µ</abbr>
 933 				mUninstallersChooser.setAdapter(new &lt;uninstallers&gt;XposedZip.MyAdapter&lt;&gt;(getContext()));
 934 				if (newApkChangelog != null) {
 935 					mInfoUpdate.setOnClickListener(new View.OnClickListener() {
 936 						@Override
 937 						public void onClick(View v) {
<abbr title=" 938 							new MaterialDialog.Builder(getContext()).title(R.string.changes).content(Html.fromHtml(newApkChangelog)).positiveText(android.R.string.ok).show();"> 938 							new MaterialDialog.Builder(getContext()).title(R.string.changes).content(Html.fromHtml(newApkChangðŸ”µ</abbr>
 939 						}
 940 					});
 941 				} else {
 942 					mInfoUpdate.setVisibility(View.GONE);
 943 				}
 944 				if (newApkVersion == null) {
 945 					return;
 946 				}
 947 				SharedPreferences prefs = null;
 948 				try {
<abbr title=" 949 					prefs = getContext().getSharedPreferences(getContext().getPackageName() + &quot;_preferences&quot;, MODE_PRIVATE);"> 949 					prefs = getContext().getSharedPreferences(getContext().getPackageName() + &quot;_preferences&quot;, MODE_PRIVAðŸ”µ</abbr>
 950 					prefs.edit().putString(&quot;changelog_&quot; + newApkVersion, newApkChangelog).apply();
 951 				} catch (java.lang.NullPointerException ignored) {
 952 				}
 953 				BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);
 954 				BigInteger b = new BigInteger(newApkVersion);
 955 				if (a.compareTo(b) == (-1)) {
 956 					mUpdateView.setVisibility(View.VISIBLE);
 957 					mUpdateButton.setOnClickListener(new View.OnClickListener() {
 958 						@Override
 959 						public void onClick(View v) {
 960 							if (write()) {
 961 								return;
 962 							}
<abbr title=" 963 							DownloadsUtil.add(getContext(), &quot;XposedInstaller_by_dvdandroid&quot;, newApkLink, new DownloadsUtil.DownloadFinishedCallback() {"> 963 							DownloadsUtil.add(getContext(), &quot;XposedInstaller_by_dvdandroid&quot;, newApkLink, new DownloadsUtil.DowðŸ”µ</abbr>
 964 								@Override
 965 								public void onDownloadFinished(Context context, DownloadsUtil.DownloadInfo info) {
 966 									Intent intent = new Intent(Intent.ACTION_VIEW);
<abbr title=" 967 									intent.setDataAndType(Uri.fromFile(new File(Environment.getExternalStorageDirectory().getAbsolutePath() + &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)), DownloadsUtil.MIME_TYPE_APK);"> 967 									intent.setDataAndType(Uri.fromFile(new File(Environment.getExternalStorageDirectory().getAbsolutðŸ”µ</abbr>
 968 									intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
 969 									context.startActivity(intent);
 970 								}
 971 							}, DownloadsUtil.MIME_TYPES.APK, true);
 972 						}
 973 					});
 974 				}
 975 			} catch (java.lang.NullPointerException ignored) {
 976 			}
 977 		}
 978 	}
 979 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package de.robv.android.xposed.installer;
   2  
   3  import static android.content.Context.MODE_PRIVATE;
   4  import static de.robv.android.xposed.installer.XposedApp.WRITE_EXTERNAL_PERMISSION;
   5  import static de.robv.android.xposed.installer.util.XposedZip.Installer;
   6  import static de.robv.android.xposed.installer.util.XposedZip.Uninstaller;
   7  
   8  import android.Manifest;
   9  import android.annotation.TargetApi;
  10  import android.app.Activity;
  11  import android.content.Context;
  12  import android.content.DialogInterface;
  13  import android.content.Intent;
  14  import android.content.SharedPreferences;
  15  import android.content.pm.PackageManager;
  16  import android.net.Uri;
  17  import android.os.AsyncTask;
  18  import android.os.Build;
  19  import android.os.Bundle;
  20  import android.os.Environment;
  21  import android.os.Looper;
  22  import android.os.ParcelFileDescriptor;
  23  import android.support.annotation.NonNull;
  24  import android.support.v4.app.ActivityCompat;
  25  import android.support.v4.app.Fragment;
  26  import android.support.v7.widget.CardView;
  27  import android.system.Os;
  28  import android.text.Html;
  29  import android.text.TextUtils;
  30  import android.util.Log;
  31  import android.view.LayoutInflater;
  32  import android.view.Menu;
  33  import android.view.MenuInflater;
  34  import android.view.MenuItem;
  35  import android.view.View;
  36  import android.view.ViewGroup;
  37  import android.widget.Button;
  38  import android.widget.CheckBox;
  39  import android.widget.ImageView;
  40  import android.widget.ProgressBar;
  41  import android.widget.Spinner;
  42  import android.widget.TextView;
  43  import android.widget.Toast;
  44  
  45  import com.afollestad.materialdialogs.MaterialDialog;
  46  
  47  import java.io.BufferedReader;
  48  import java.io.File;
  49  import java.io.IOException;
  50  import java.io.InputStreamReader;
  51  import java.math.BigInteger;
  52  import java.net.HttpURLConnection;
  53  import java.net.MalformedURLException;
  54  import java.net.URL;
  55  import java.util.ArrayList;
  56  import java.util.LinkedList;
  57  import java.util.List;
  58  import java.util.Locale;
  59  
  60  import org.json.JSONArray;
  61  import org.json.JSONObject;
  62  
  63  import de.robv.android.xposed.installer.util.AssetUtil;
  64  import de.robv.android.xposed.installer.util.DownloadsUtil;
  65  import de.robv.android.xposed.installer.util.NavUtil;
  66  import de.robv.android.xposed.installer.util.NotificationUtil;
  67  import de.robv.android.xposed.installer.util.RootUtil;
  68  import de.robv.android.xposed.installer.util.ThemeUtil;
  69  import de.robv.android.xposed.installer.util.XposedZip;
  70  
  71  public class InstallerFragment extends Fragment
  72  		implements ActivityCompat.OnRequestPermissionsResultCallback,
  73  		DownloadsUtil.DownloadFinishedCallback {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -	private static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +	public static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;</span>
  76  	private static final int INSTALL_MODE_NORMAL = 0;
  77  	private static final int INSTALL_MODE_RECOVERY_AUTO = 1;
  78  	private static final int INSTALL_MODE_RECOVERY_MANUAL = 2;
<abbr title="  79  	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposed.json&quot;;">  79  	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposðŸ”µ</abbr>
  80  	private static List&lt;String&gt; messages = new LinkedList&lt;&gt;();
  81  	private static ArrayList&lt;Installer&gt; installers;
  82  	private static ArrayList&lt;Uninstaller&gt; uninstallers;
  83  	private final LinkedList&lt;String&gt; mCompatibilityErrors = new LinkedList&lt;&gt;();
  84  	private String APP_PROCESS_NAME = null;
  85  	private RootUtil mRootUtil = new RootUtil();
  86  	private boolean mHadSegmentationFault = false;
  87  	private MaterialDialog.Builder dlgProgress;
  88  	private TextView txtInstallError, txtKnownIssue;
  89  	private Button btnInstall, btnUninstall;
  90  	private ProgressBar mInstallersLoading;
  91  	private Spinner mInstallersChooser;
  92  	private ProgressBar mUninstallersLoading;
  93  	private Spinner mUninstallersChooser;
  94  	private ImageView mInfoInstaller, mInfoUninstaller;
  95  	private String newApkVersion = XposedApp.THIS_APK_VERSION;
  96  	private String newApkLink;
  97  	private String newApkChangelog;
  98  	private CardView mUpdateView;
  99  	private Button mUpdateButton;
 100  	private TextView mInstallForbidden;
 101  	private ImageView mInfoUpdate;
 102  
 103  	private static int extractIntPart(String str) {
 104  		int result = 0, length = str.length();
 105  		for (int offset = 0; offset &lt; length; offset++) {
 106  			char c = str.charAt(offset);
 107  			if (&#x27;0&#x27; &lt;= c &amp;&amp; c &lt;= &#x27;9&#x27;)
 108  				result = result * 10 + (c - &#x27;0&#x27;);
 109  			else
 110  				break;
 111  		}
 112  		return result;
 113  	}
 114  
 115  	private static boolean checkClassExists(String className) {
 116  		try {
 117  			Class.forName(className);
 118  			return true;
 119  		} catch (ClassNotFoundException e) {
 120  			return false;
 121  		}
 122  	}
 123  
 124  	public static ArrayList&lt;Installer&gt; getInstallersBySdk(int sdk) {
 125  		ArrayList&lt;Installer&gt; list = new ArrayList&lt;&gt;();
 126  		for (Installer i : installers) {
 127  			if (i.sdk == sdk)
 128  				list.add(i);
 129  		}
 130  
 131  		if (list.size() == 0) {
 132  			list.add(new Installer());
 133  		}
 134  		return list;
 135  	}
 136  
 137  	/*
 138  	 * public static ArrayList&lt;Installer&gt; getInstallersBySdkAndArchitecture( int
 139  	 * sdk, String architecture) { ArrayList&lt;Installer&gt; list = new
 140  	 * ArrayList&lt;&gt;(); ArrayList&lt;Installer&gt; list2 = new ArrayList&lt;&gt;(); for
 141  	 * (Installer i : installers) { if (i.sdk == sdk) list.add(i); } for
 142  	 * (Installer i : list) { if (i.architecture.equals(architecture))
 143  	 * list2.add(i); } return list2; }
 144  	 *
 145  	 * public static ArrayList&lt;Uninstaller&gt; getUninstallersByArchitecture(
 146  	 * String architecture) { ArrayList&lt;Uninstaller&gt; list = new ArrayList&lt;&gt;();
 147  	 * for (Uninstaller u : uninstallers) { if
 148  	 * (u.architecture.equals(architecture)) list.add(u); } return list; }
 149  	 */
 150  
 151  	@Override
 152  	public void onActivityCreated(Bundle savedInstanceState) {
 153  		super.onActivityCreated(savedInstanceState);
 154  		Activity activity = getActivity();
 155  
 156  		dlgProgress = new MaterialDialog.Builder(activity).progress(true, 0);
 157  		setHasOptionsMenu(true);
 158  	}
 159  
 160  	@Override
 161  	public View onCreateView(LayoutInflater inflater, ViewGroup container,
 162  			Bundle savedInstanceState) {
 163  		View v = inflater.inflate(R.layout.tab_installer, container, false);
 164  
 165  		txtInstallError = (TextView) v
 166  				.findViewById(R.id.framework_install_errors);
 167  		txtKnownIssue = (TextView) v.findViewById(R.id.framework_known_issue);
 168  
 169  		btnInstall = (Button) v.findViewById(R.id.btnInstall);
 170  		btnUninstall = (Button) v.findViewById(R.id.btnUninstall);
 171  
 172  		mInstallersLoading = (ProgressBar) v
 173  				.findViewById(R.id.loadingInstallers);
 174  		mUninstallersLoading = (ProgressBar) v
 175  				.findViewById(R.id.loadingUninstallers);
 176  		mInstallersChooser = (Spinner) v.findViewById(R.id.chooserInstallers);
 177  		mUninstallersChooser = (Spinner) v
 178  				.findViewById(R.id.chooserUninstallers);
 179  		mUpdateView = (CardView) v.findViewById(R.id.updateView);
 180  		mUpdateButton = (Button) v.findViewById(R.id.updateButton);
 181  
 182  		mInfoInstaller = (ImageView) v.findViewById(R.id.infoInstaller);
 183  		mInfoUninstaller = (ImageView) v.findViewById(R.id.infoUninstaller);
 184  
 185  		mInstallForbidden = (TextView) v
 186  				.findViewById(R.id.installationForbidden);
 187  		mInfoUpdate = (ImageView) v.findViewById(R.id.infoUpdate);
 188  
 189  		String installedXposedVersion = XposedApp.getXposedProp()
 190  				.get(&quot;version&quot;);
 191  
 192  		if (Build.VERSION.SDK_INT &gt;= 21) {
 193  			if (installedXposedVersion == null) {
 194  				txtInstallError.setText(R.string.installation_lollipop);
 195  				txtInstallError
 196  						.setTextColor(getResources().getColor(R.color.warning));
 197  			} else {
 198  				int installedXposedVersionInt = extractIntPart(
 199  						installedXposedVersion);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -				if (installedXposedVersionInt == XposedApp</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -						.getActiveXposedVersion()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +				if (installedXposedVersionInt == XposedApp.getXposedVersion()) {</span>
 203  					txtInstallError
 204  							.setText(getString(R.string.installed_lollipop,
 205  									installedXposedVersion));
 206  					txtInstallError.setTextColor(
 207  							getResources().getColor(R.color.darker_green));
 208  				} else {
 209  					txtInstallError.setText(
 210  							getString(R.string.installed_lollipop_inactive,
 211  									installedXposedVersion));
 212  					txtInstallError.setTextColor(
 213  							getResources().getColor(R.color.warning));
 214  				}
 215  			}
 216  		} else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -			boolean backupXposed = new File(&quot;/system/bin/app_process.orig&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -					.exists();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -			if (backupXposed) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -				txtInstallError.setText(R.string.installed_no_lollipop);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +			if (XposedApp.getXposedVersion() != 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +				txtInstallError.setText(getString(R.string.installed_lollipop,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +						XposedApp.getXposedVersion()));</span>
 224  				txtInstallError.setTextColor(
 225  						getResources().getColor(R.color.darker_green));
 226  			} else {
 227  				txtInstallError
 228  						.setText(getString(R.string.not_installed_no_lollipop));
 229  				txtInstallError
 230  						.setTextColor(getResources().getColor(R.color.warning));
 231  			}
 232  		}
 233  
 234  		txtInstallError.setVisibility(View.VISIBLE);
 235  
 236  		if (!XposedApp.getPreferences().getBoolean(&quot;hide_install_warning&quot;,
 237  				false)) {
 238  			final View dontShowAgainView = inflater
 239  					.inflate(R.layout.dialog_install_warning, null);
 240  
 241  			new MaterialDialog.Builder(getActivity())
 242  					.title(R.string.install_warning_title)
 243  					.customView(dontShowAgainView, false)
 244  					.positiveText(android.R.string.ok)
 245  					.callback(new MaterialDialog.ButtonCallback() {
 246  						@Override
 247  						public void onPositive(MaterialDialog dialog) {
 248  							super.onPositive(dialog);
 249  							CheckBox checkBox = (CheckBox) dontShowAgainView
 250  									.findViewById(android.R.id.checkbox);
 251  							if (checkBox.isChecked())
 252  								XposedApp.getPreferences().edit().putBoolean(
 253  										&quot;hide_install_warning&quot;, true).apply();
 254  						}
 255  					}).cancelable(false).show();
 256  		}
 257  
 258  		new JSONParser(JSON_LINK).execute();
 259  
 260  		mInfoInstaller.setOnClickListener(new View.OnClickListener() {
 261  			@Override
 262  			public void onClick(View v) {
 263  				Installer selectedInstaller = (Installer) mInstallersChooser
 264  						.getSelectedItem();
 265  				String s = getString(R.string.infoInstaller,
 266  						selectedInstaller.name, selectedInstaller.sdk,
 267  						selectedInstaller.architecture,
 268  						selectedInstaller.version);
 269  
 270  				new MaterialDialog.Builder(getContext()).title(R.string.info)
 271  						.content(s).positiveText(android.R.string.ok).show();
 272  			}
 273  		});
 274  		mInfoUninstaller.setOnClickListener(new View.OnClickListener() {
 275  			@Override
 276  			public void onClick(View v) {
 277  				Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 278  						.getSelectedItem();
 279  				String s = getString(R.string.infoUninstaller,
 280  						selectedUninstaller.name,
 281  						selectedUninstaller.architecture,
 282  						selectedUninstaller.date);
 283  
 284  				new MaterialDialog.Builder(getContext()).title(R.string.info)
 285  						.content(s).positiveText(android.R.string.ok).show();
 286  			}
 287  		});
 288  
 289  		btnInstall.setOnClickListener(new View.OnClickListener() {
 290  			@Override
 291  			public void onClick(View v) {
 292  				if (write())
 293  					return;
 294  
 295  				areYouSure(R.string.warningArchitecture,
 296  						new MaterialDialog.ButtonCallback() {
 297  					@Override
 298  					public void onPositive(MaterialDialog dialog) {
 299  						super.onPositive(dialog);
 300  
 301  						Installer selectedInstaller = (Installer) mInstallersChooser
 302  								.getSelectedItem();
 303  
 304  						DownloadsUtil.add(getContext(), selectedInstaller.name,
 305  								selectedInstaller.link, InstallerFragment.this,
 306  								DownloadsUtil.MIME_TYPES.ZIP, true);
 307  					}
 308  				});
 309  			}
 310  		});
 311  
 312  		btnUninstall.setOnClickListener(new View.OnClickListener() {
 313  			@Override
 314  			public void onClick(View v) {
 315  				if (write())
 316  					return;
 317  				areYouSure(R.string.warningArchitecture,
 318  						new MaterialDialog.ButtonCallback() {
 319  					@Override
 320  					public void onPositive(MaterialDialog dialog) {
 321  						super.onPositive(dialog);
 322  
 323  						Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 324  								.getSelectedItem();
 325  
 326  						DownloadsUtil.add(getContext(),
 327  								selectedUninstaller.name,
 328  								selectedUninstaller.link,
 329  								InstallerFragment.this,
 330  								DownloadsUtil.MIME_TYPES.ZIP, true);
 331  					}
 332  				});
 333  			}
 334  		});
 335  
 336  		return v;
 337  	}
 338  
 339  	@Override
 340  	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 341  		inflater.inflate(R.menu.menu_installer, menu);
 342  	}
 343  
 344  	@Override
 345  	public boolean onOptionsItemSelected(MenuItem item) {
 346  
 347  		switch (item.getItemId()) {
 348  			case R.id.help:
 349  				new MaterialDialog.Builder(getContext()).title(R.string.help)
 350  						.content(R.string.helpChoose)
 351  						.positiveText(android.R.string.ok).show();
 352  				break;
 353  			case R.id.installation_mode:
 354  				Intent intent = new Intent(getActivity(),
 355  						SettingsActivity.class);
 356  				startActivity(intent);
 357  				break;
 358  			case R.id.reboot:
 359  				areYouSure(R.string.reboot,
 360  						new MaterialDialog.ButtonCallback() {
 361  							@Override
 362  							public void onPositive(MaterialDialog dialog) {
 363  								super.onPositive(dialog);
 364  								reboot(null);
 365  							}
 366  						});
 367  				break;
 368  			case R.id.soft_reboot:
 369  				areYouSure(R.string.reboot,
 370  						new MaterialDialog.ButtonCallback() {
 371  							@Override
 372  							public void onPositive(MaterialDialog dialog) {
 373  								super.onPositive(dialog);
 374  								softReboot();
 375  							}
 376  						});
 377  				break;
 378  		}
 379  
 380  		return super.onOptionsItemSelected(item);
 381  	}
 382  
 383  	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 384  	public void performFileSearch() {
 385  		Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 386  		intent.addCategory(Intent.CATEGORY_OPENABLE);
 387  		intent.setType(&quot;application/zip&quot;);
 388  		startActivityForResult(intent, 123);
 389  	}
 390  
 391  	@Override
 392  	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 393  	public void onActivityResult(int requestCode, int resultCode,
 394  			Intent resultData) {
 395  		if (requestCode == 123 &amp;&amp; resultCode == Activity.RESULT_OK) {
 396  			if (resultData != null) {
 397  				Uri uri = resultData.getData();
 398  				String resolved = null;
 399  				try (ParcelFileDescriptor fd = getActivity()
 400  						.getContentResolver().openFileDescriptor(uri, &quot;r&quot;)) {
 401  					final File procfsFdFile = new File(
 402  							&quot;/proc/self/fd/&quot; + fd.getFd());
 403  
 404  					resolved = Os.readlink(procfsFdFile.getAbsolutePath());
 405  
 406  					if (TextUtils.isEmpty(resolved) || resolved.charAt(0) != &#x27;/&#x27;
 407  							|| resolved.startsWith(&quot;/proc/&quot;)
 408  							|| resolved.startsWith(&quot;/fd/&quot;))
 409  						;
 410  				} catch (Exception errnoe) {
 411  					Log.e(XposedApp.TAG, &quot;ReadError&quot;);
 412  				}
 413  				mRootUtil.execute(&quot;cp &quot; + resolved + &quot; /cache/xposed.zip&quot;,
 414  						messages);
 415  				installXposedZip();
 416  			}
 417  		}
 418  	}
 419  
 420  	private void installXposedZip() {
 421  		mRootUtil.execute(
 422  				&quot;echo &#x27;install /cache/xposed.zip&#x27; &gt;/cache/recovery/openrecoveryscript &quot;,
 423  				messages);
 424  		mRootUtil.execute(&quot;sync&quot;, messages);
 425  		reboot(&quot;recovery&quot;);
 426  	}
 427  
 428  	@Override
 429  	public void onRequestPermissionsResult(int requestCode,
 430  			@NonNull String[] permissions, @NonNull int[] grantResults) {
 431  		if (requestCode == WRITE_EXTERNAL_PERMISSION) {
 432  			if (grantResults.length == 1
 433  					&amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {
 434  				Toast.makeText(getActivity(), R.string.permissionGranted,
 435  						Toast.LENGTH_LONG).show();
 436  			} else {
 437  				Toast.makeText(getActivity(), R.string.permissionNotGranted,
 438  						Toast.LENGTH_LONG).show();
 439  			}
 440  		} else {
 441  			super.onRequestPermissionsResult(requestCode, permissions,
 442  					grantResults);
 443  		}
 444  	}
 445  
 446  	private boolean write() {
 447  		if (ActivityCompat.checkSelfPermission(getContext(),
 448  				Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
 449  
 450  			ActivityCompat.requestPermissions(getActivity(),
 451  					new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE },
 452  					WRITE_EXTERNAL_PERMISSION);
 453  
 454  			return true;
 455  		} else {
 456  			return false;
 457  		}
 458  	}
 459  
 460  	@Override
 461  	public void onResume() {
 462  		super.onResume();
 463  		NotificationUtil.cancel(NotificationUtil.NOTIFICATION_MODULES_UPDATED);
 464  		mHadSegmentationFault = false;
 465  		refreshKnownIssue();
 466  	}
 467  
 468  	@Override
 469  	public void onDestroy() {
 470  		super.onDestroy();
 471  		mRootUtil.dispose();
 472  	}
 473  
 474  	private String versionToText(int version) {
 475  		return (version == 0) ? getString(R.string.none)
 476  				: Integer.toString(version);
 477  	}
 478  
 479  	private void refreshKnownIssue() {
 480  		String issueName = null;
 481  		String issueLink = null;
 482  
 483  		if (new File(&quot;/system/framework/core.jar.jex&quot;).exists()) {
 484  			issueName = &quot;Aliyun OS&quot;;
 485  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52289793&amp;postcount=5&quot;;
 486  
 487  		} else if (new File(&quot;/data/miui/DexspyInstaller.jar&quot;).exists()
 488  				|| checkClassExists(&quot;miui.dexspy.DexspyInstaller&quot;)) {
 489  			issueName = &quot;MIUI/Dexspy&quot;;
 490  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52291098&amp;postcount=6&quot;;
 491  
 492  		} else if (mHadSegmentationFault) {
 493  			issueName = &quot;Segmentation fault&quot;;
 494  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52292102&amp;postcount=7&quot;;
 495  
 496  		} else
 497  			if (checkClassExists(&quot;com.huawei.android.content.res.ResourcesEx&quot;)
 498  					|| checkClassExists(&quot;android.content.res.NubiaResources&quot;)) {
 499  			issueName = &quot;Resources subclass&quot;;
 500  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52801382&amp;postcount=8&quot;;
 501  		}
 502  
 503  		if (issueName != null) {
 504  			final String issueLinkFinal = issueLink;
 505  			txtKnownIssue.setText(
 506  					getString(R.string.install_known_issue, issueName));
 507  			txtKnownIssue.setVisibility(View.VISIBLE);
 508  			txtKnownIssue.setOnClickListener(new View.OnClickListener() {
 509  				@Override
 510  				public void onClick(View v) {
 511  					NavUtil.startURL(getActivity(), issueLinkFinal);
 512  				}
 513  			});
 514  
 515  			txtInstallError.setTextColor(ThemeUtil.getThemeColor(getActivity(),
 516  					android.R.attr.textColorTertiary));
 517  		} else {
 518  			txtKnownIssue.setVisibility(View.GONE);
 519  		}
 520  	}
 521  
 522  	private void showAlert(final String result) {
 523  		if (Looper.myLooper() != Looper.getMainLooper()) {
 524  			getActivity().runOnUiThread(new Runnable() {
 525  				@Override
 526  				public void run() {
 527  					showAlert(result);
 528  				}
 529  			});
 530  			return;
 531  		}
 532  
 533  		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 534  				.content(result).positiveText(android.R.string.ok).build();
 535  		dialog.show();
 536  
 537  		TextView txtMessage = (TextView) dialog
 538  				.findViewById(android.R.id.message);
 539  		try {
 540  			txtMessage.setTextSize(14);
 541  		} catch (NullPointerException ignored) {
 542  		}
 543  
 544  		mHadSegmentationFault = result.toLowerCase(Locale.US)
 545  				.contains(&quot;segmentation fault&quot;);
 546  		refreshKnownIssue();
 547  	}
 548  
 549  	private void areYouSure(int messageTextId,
 550  			MaterialDialog.ButtonCallback yesHandler) {
 551  		new MaterialDialog.Builder(getActivity()).title(messageTextId)
 552  				.content(R.string.areyousure)
 553  				.iconAttr(android.R.attr.alertDialogIcon)
 554  				.positiveText(android.R.string.yes)
 555  				.negativeText(android.R.string.no).callback(yesHandler).show();
 556  	}
 557  
 558  	private void showConfirmDialog(final String message,
 559  			final MaterialDialog.ButtonCallback callback) {
 560  		if (Looper.myLooper() != Looper.getMainLooper()) {
 561  			getActivity().runOnUiThread(new Runnable() {
 562  				@Override
 563  				public void run() {
 564  					showConfirmDialog(message, callback);
 565  				}
 566  			});
 567  			return;
 568  		}
 569  
 570  		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 571  				.content(message).positiveText(android.R.string.yes)
 572  				.negativeText(android.R.string.no).callback(callback).build();
 573  
 574  		TextView txtMessage = (TextView) dialog
 575  				.findViewById(android.R.id.message);
 576  		txtMessage.setTextSize(14);
 577  
 578  		mHadSegmentationFault = message.toLowerCase(Locale.US)
 579  				.contains(&quot;segmentation fault&quot;);
 580  		refreshKnownIssue();
 581  	}
 582  
 583  	private boolean checkCompatibility() {
 584  		mCompatibilityErrors.clear();
 585  		return checkAppProcessCompatibility();
 586  	}
 587  
 588  	private boolean checkAppProcessCompatibility() {
 589  		try {
 590  			if (APP_PROCESS_NAME == null)
 591  				return false;
 592  
 593  			File testFile = AssetUtil.writeAssetToCacheFile(APP_PROCESS_NAME,
 594  					&quot;app_process&quot;, 00700);
 595  			if (testFile == null) {
 596  				mCompatibilityErrors
 597  						.add(&quot;could not write app_process to cache&quot;);
 598  				return false;
 599  			}
 600  
 601  			Process p = Runtime.getRuntime().exec(new String[] {
 602  					testFile.getAbsolutePath(), &quot;--xposedversion&quot; });
 603  
 604  			BufferedReader stdout = new BufferedReader(
 605  					new InputStreamReader(p.getInputStream()));
 606  			String result = stdout.readLine();
 607  			stdout.close();
 608  
 609  			BufferedReader stderr = new BufferedReader(
 610  					new InputStreamReader(p.getErrorStream()));
 611  			String errorLine;
 612  			while ((errorLine = stderr.readLine()) != null) {
 613  				mCompatibilityErrors.add(errorLine);
 614  			}
 615  			stderr.close();
 616  
 617  			p.destroy();
 618  
 619  			testFile.delete();
 620  			return result != null &amp;&amp; result.startsWith(&quot;Xposed version: &quot;);
 621  		} catch (IOException e) {
 622  			mCompatibilityErrors.add(e.getMessage());
 623  			return false;
 624  		}
 625  	}
 626  
 627  	private boolean startShell() {
 628  		if (mRootUtil.startShell())
 629  			return true;
 630  
 631  		showAlert(getString(R.string.root_failed));
 632  		return false;
 633  	}
 634  
 635  	private int getInstallMode() {
 636  		int mode = XposedApp.getPreferences().getInt(&quot;install_mode&quot;,
 637  				INSTALL_MODE_NORMAL);
 638  		if (mode &lt; INSTALL_MODE_NORMAL || mode &gt; INSTALL_MODE_RECOVERY_MANUAL)
 639  			mode = INSTALL_MODE_NORMAL;
 640  		return mode;
 641  	}
 642  
 643  	private String getInstallModeText() {
 644  		final int installMode = getInstallMode();
 645  		switch (installMode) {
 646  			case INSTALL_MODE_NORMAL:
 647  				return getString(R.string.install_mode_normal);
 648  			case INSTALL_MODE_RECOVERY_AUTO:
 649  				return getString(R.string.install_mode_recovery_auto);
 650  			case INSTALL_MODE_RECOVERY_MANUAL:
 651  				return getString(R.string.install_mode_recovery_manual);
 652  		}
 653  		throw new IllegalStateException(&quot;unknown install mode &quot; + installMode);
 654  	}
 655  
 656  	private boolean prepareAutoFlash(List&lt;String&gt; messages, String file) {
 657  		if (mRootUtil.execute(&quot;ls /cache/recovery&quot;, null) != 0) {
 658  			messages.add(getString(R.string.file_creating_directory,
 659  					&quot;/cache/recovery&quot;));
 660  			if (mRootUtil.executeWithBusybox(&quot;mkdir /cache/recovery&quot;,
 661  					messages) != 0) {
 662  				messages.add(&quot;&quot;);
 663  				messages.add(getString(R.string.file_create_directory_failed,
 664  						&quot;/cache/recovery&quot;));
 665  				return false;
 666  			}
 667  		}
 668  
 669  		messages.add(getString(R.string.file_copying, file));
 670  		File tempFile = AssetUtil.writeAssetToCacheFile(file, 00644);
 671  		if (tempFile == null) {
 672  			messages.add(&quot;&quot;);
 673  			messages.add(getString(R.string.file_extract_failed, file));
 674  			return false;
 675  		}
 676  
 677  		if (mRootUtil.executeWithBusybox(&quot;cp -a &quot; + tempFile.getAbsolutePath()
 678  				+ &quot; /cache/recovery/&quot; + file, messages) != 0) {
 679  			messages.add(&quot;&quot;);
 680  			messages.add(getString(R.string.file_copy_failed, file, &quot;/cache&quot;));
 681  			tempFile.delete();
 682  			return false;
 683  		}
 684  
 685  		tempFile.delete();
 686  
 687  		messages.add(getString(R.string.file_writing_recovery_command));
 688  		if (mRootUtil.execute(
 689  				&quot;echo \&quot;--update_package=/cache/recovery/&quot; + file
 690  						+ &quot;\n--show_text\&quot; &gt; /cache/recovery/command&quot;,
 691  				messages) != 0) {
 692  			messages.add(&quot;&quot;);
 693  			messages.add(
 694  					getString(R.string.file_writing_recovery_command_failed));
 695  			return false;
 696  		}
 697  
 698  		return true;
 699  	}
 700  
 701  	private boolean prepareManualFlash(List&lt;String&gt; messages, String file) {
 702  		messages.add(getString(R.string.file_copying, file));
 703  		if (AssetUtil.writeAssetToSdcardFile(file, 00644) == null) {
 704  			messages.add(&quot;&quot;);
 705  			messages.add(getString(R.string.file_extract_failed, file));
 706  			return false;
 707  		}
 708  
 709  		return true;
 710  	}
 711  
 712  	private void offerReboot(List&lt;String&gt; messages) {
 713  		messages.add(getString(R.string.file_done));
 714  		messages.add(&quot;&quot;);
 715  		messages.add(getString(R.string.reboot_confirmation));
 716  		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 717  				new MaterialDialog.ButtonCallback() {
 718  					@Override
 719  					public void onPositive(MaterialDialog dialog) {
 720  						super.onPositive(dialog);
 721  						reboot(null);
 722  					}
 723  				});
 724  	}
 725  
 726  	private void offerRebootToRecovery(List&lt;String&gt; messages, final String file,
 727  			final int installMode) {
 728  		if (installMode == INSTALL_MODE_RECOVERY_AUTO)
 729  			messages.add(getString(R.string.auto_flash_note, file));
 730  		else
 731  			messages.add(getString(R.string.manual_flash_note, file));
 732  
 733  		messages.add(&quot;&quot;);
 734  		messages.add(getString(R.string.reboot_recovery_confirmation));
 735  		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 736  				new MaterialDialog.ButtonCallback() {
 737  					@Override
 738  					public void onPositive(MaterialDialog dialog) {
 739  						super.onPositive(dialog);
 740  						reboot(&quot;recovery&quot;);
 741  					}
 742  
 743  					@Override
 744  					public void onNegative(MaterialDialog dialog) {
 745  						super.onNegative(dialog);
 746  						if (installMode == INSTALL_MODE_RECOVERY_AUTO) {
 747  							// clean up to avoid unwanted flashing
 748  							mRootUtil.executeWithBusybox(
 749  									&quot;rm /cache/recovery/command&quot;, null);
 750  							mRootUtil.executeWithBusybox(
 751  									&quot;rm /cache/recovery/&quot; + file, null);
 752  							AssetUtil.removeBusybox();
 753  						}
 754  					}
 755  				}
 756  
 757  		);
 758  	}
 759  
 760  	private void softReboot() {
 761  		if (!startShell())
 762  			return;
 763  
 764  		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 765  		if (mRootUtil.execute(
 766  				&quot;setprop ctl.restart surfaceflinger; setprop ctl.restart zygote&quot;,
 767  				messages) != 0) {
 768  			messages.add(&quot;&quot;);
 769  			messages.add(getString(R.string.reboot_failed));
 770  			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 771  		}
 772  	}
 773  
 774  	private void reboot(String mode) {
 775  		if (!startShell())
 776  			return;
 777  
 778  		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 779  
 780  		String command = &quot;reboot&quot;;
 781  		if (mode != null) {
 782  			command += &quot; &quot; + mode;
 783  			if (mode.equals(&quot;recovery&quot;))
 784  				// create a flag used by some kernels to boot into recovery
 785  				mRootUtil.executeWithBusybox(&quot;touch /cache/recovery/boot&quot;,
 786  						messages);
 787  		}
 788  
 789  		if (mRootUtil.executeWithBusybox(command, messages) != 0) {
 790  			messages.add(&quot;&quot;);
 791  			messages.add(getString(R.string.reboot_failed));
 792  			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 793  		}
 794  		AssetUtil.removeBusybox();
 795  	}
 796  
 797  	@Override
 798  	public void onDownloadFinished(final Context context,
 799  			DownloadsUtil.DownloadInfo info) {
 800  		Toast.makeText(context,
 801  				getString(R.string.downloadZipOk, info.localFilename),
 802  				Toast.LENGTH_LONG).show();
 803  
 804  		if (getInstallMode() == INSTALL_MODE_RECOVERY_MANUAL)
 805  			return;
 806  
 807  		areYouSure(R.string.install_warning,
 808  				new MaterialDialog.ButtonCallback() {
 809  					@Override
 810  					public void onPositive(MaterialDialog dialog) {
 811  						super.onPositive(dialog);
 812  						Toast.makeText(context, R.string.selectFile,
 813  								Toast.LENGTH_LONG).show();
 814  
 815  						performFileSearch();
 816  					}
 817  				});
 818  	}
 819  
 820  	private abstract class AsyncClickListener implements View.OnClickListener {
 821  		private final CharSequence mProgressDlgText;
 822  
 823  		public AsyncClickListener(CharSequence progressDlgText) {
 824  			mProgressDlgText = progressDlgText;
 825  		}
 826  
 827  		@Override
 828  		public final void onClick(final View v) {
 829  			if (mProgressDlgText != null) {
 830  				dlgProgress.content(mProgressDlgText);
 831  				dlgProgress.show();
 832  			}
 833  			new Thread() {
 834  				public void run() {
 835  					onAsyncClick(v);
 836  					dlgProgress.build().dismiss();
 837  				}
 838  			}.start();
 839  		}
 840  
 841  		protected abstract void onAsyncClick(View v);
 842  	}
 843  
 844  	private abstract class AsyncDialogClickListener
 845  			implements DialogInterface.OnClickListener {
 846  		private final CharSequence mProgressDlgText;
 847  
 848  		public AsyncDialogClickListener(CharSequence progressDlgText) {
 849  			mProgressDlgText = progressDlgText;
 850  		}
 851  
 852  		@Override
 853  		public void onClick(final DialogInterface dialog, final int which) {
 854  			if (mProgressDlgText != null) {
 855  				dlgProgress.content(mProgressDlgText);
 856  				dlgProgress.show();
 857  			}
 858  			new Thread() {
 859  				public void run() {
 860  					onAsyncClick(dialog, which);
 861  					dlgProgress.build().dismiss();
 862  				}
 863  			}.start();
 864  		}
 865  
 866  		protected abstract void onAsyncClick(DialogInterface dialog, int which);
 867  	}
 868  
 869  	private class JSONParser extends AsyncTask&lt;Void, Void, Boolean&gt; {
 870  		private URL mUrl;
 871  
 872  		public JSONParser(String mUrl) {
 873  			try {
 874  				this.mUrl = new URL(mUrl);
 875  			} catch (MalformedURLException e) {
 876  				e.printStackTrace();
 877  			}
 878  		}
 879  
 880  		@Override
 881  		protected void onPreExecute() {
 882  			super.onPreExecute();
 883  
 884  			mInstallersLoading.setVisibility(View.VISIBLE);
 885  			mUninstallersLoading.setVisibility(View.VISIBLE);
 886  			mInfoInstaller.setVisibility(View.GONE);
 887  			mInfoUninstaller.setVisibility(View.GONE);
 888  		}
 889  
 890  		@Override
 891  		protected Boolean doInBackground(Void... params) {
 892  			try {
 893  				HttpURLConnection c = (HttpURLConnection) mUrl.openConnection();
 894  				c.setRequestMethod(&quot;GET&quot;);
 895  				c.setDoOutput(true);
 896  				c.connect();
 897  
 898  				BufferedReader br = new BufferedReader(
 899  						new InputStreamReader(c.getInputStream()));
 900  				StringBuilder sb = new StringBuilder();
 901  				String line;
 902  				while ((line = br.readLine()) != null) {
 903  					sb.append(line).append(&quot;\n&quot;);
 904  				}
 905  				br.close();
 906  
 907  				JSONObject json = new JSONObject(sb.toString());
 908  				JSONArray installerArray = json.getJSONArray(&quot;installer&quot;);
 909  				JSONArray uninstallerArray = json.getJSONArray(&quot;uninstaller&quot;);
 910  
 911  				installers = new ArrayList&lt;&gt;();
 912  				uninstallers = new ArrayList&lt;&gt;();
 913  
 914  				for (int i = 0; i &lt; installerArray.length(); i++) {
 915  					JSONObject jsonObject = installerArray.getJSONObject(i);
 916  
 917  					String link = jsonObject.getString(&quot;link&quot;);
 918  					String name = jsonObject.getString(&quot;name&quot;);
 919  					String architecture = jsonObject.getString(&quot;architecture&quot;);
 920  					String version = jsonObject.getString(&quot;version&quot;);
 921  					int sdk = jsonObject.getInt(&quot;sdk&quot;);
 922  
 923  					installers.add(new XposedZip.Installer(link, name,
 924  							architecture, sdk, version));
 925  				}
 926  
 927  				if (Build.VERSION.SDK_INT &gt;= 21) {
 928  					for (int i = 0; i &lt; uninstallerArray.length(); i++) {
 929  						JSONObject jsonObject = uninstallerArray
 930  								.getJSONObject(i);
 931  
 932  						String link = jsonObject.getString(&quot;link&quot;);
 933  						String name = jsonObject.getString(&quot;name&quot;);
 934  						String architecture = jsonObject
 935  								.getString(&quot;architecture&quot;);
 936  						String date = jsonObject.getString(&quot;date&quot;);
 937  
 938  						uninstallers.add(new Uninstaller(link, name,
 939  								architecture, date));
 940  					}
 941  				} else {
 942  					uninstallers.add(new Uninstaller());
 943  				}
 944  
 945  				newApkVersion = json.getJSONObject(&quot;apk&quot;).getString(&quot;version&quot;);
 946  				newApkLink = json.getJSONObject(&quot;apk&quot;).getString(&quot;link&quot;);
 947  				newApkChangelog = json.getJSONObject(&quot;apk&quot;)
 948  						.getString(&quot;changelog&quot;);
 949  				return true;
 950  			} catch (Exception e) {
 951  				e.printStackTrace();
 952  				return false;
 953  			}
 954  		}
 955  
 956  		@Override
 957  		protected void onPostExecute(Boolean result) {
 958  			super.onPostExecute(result);
 959  
 960  			btnInstall.setEnabled(result);
 961  			btnUninstall.setEnabled(result);
 962  
 963  			mInstallersLoading.setVisibility(View.GONE);
 964  			mUninstallersLoading.setVisibility(View.GONE);
 965  
 966  			int i = result ? View.VISIBLE : View.GONE;
 967  
 968  			mInstallersChooser.setVisibility(i);
 969  			mUninstallersChooser.setVisibility(i);
 970  
 971  			mInfoInstaller.setVisibility(i);
 972  			mInfoUninstaller.setVisibility(i);
 973  
 974  			if (Build.VERSION.SDK_INT &lt; 21) {
 975  				btnInstall.setEnabled(false);
 976  				btnUninstall.setEnabled(false);
 977  				mInfoInstaller.setEnabled(false);
 978  				mInfoUninstaller.setEnabled(false);
 979  				mInstallersChooser.setEnabled(false);
 980  				mUninstallersChooser.setEnabled(false);
 981  
 982  				mInstallForbidden.setVisibility(View.VISIBLE);
 983  			}
 984  
 985  			if (!result) {
 986  				Toast.makeText(getContext(), R.string.loadingError,
 987  						Toast.LENGTH_LONG).show();
 988  				return;
 989  			}
 990  
 991  			try {







 992  				mInstallersChooser
 993  						.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(),
 994  								getInstallersBySdk(Build.VERSION.SDK_INT)));
 995  
 996  				mUninstallersChooser.setAdapter(
 997  						new XposedZip.MyAdapter&lt;&gt;(getContext(), uninstallers));
 998  







































































 999  			} catch (NullPointerException ignored) {
1000  			}
1001  
1002  			if (newApkChangelog != null) {
1003  				mInfoUpdate.setOnClickListener(new View.OnClickListener() {
1004  					@Override
1005  					public void onClick(View v) {
1006  						new MaterialDialog.Builder(getContext())
1007  								.title(R.string.changes)
1008  								.content(Html.fromHtml(newApkChangelog))
1009  								.positiveText(android.R.string.ok).show();
1010  					}
1011  				});
1012  			} else {
1013  				mInfoUpdate.setVisibility(View.GONE);
1014  			}
1015  
1016  			if (newApkVersion == null)
1017  				return;
1018  
1019  			SharedPreferences prefs = null;
1020  			try {
1021  				prefs = getContext().getSharedPreferences(
1022  						getContext().getPackageName() + &quot;_preferences&quot;,
1023  						MODE_PRIVATE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1024 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1025 +				prefs.edit().putString(&quot;changelog_&quot; + newApkVersion,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1026 +						newApkChangelog).apply();</span>
1027  			} catch (NullPointerException ignored) {
1028  			}
1029  
1030  			BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);
1031  			BigInteger b = new BigInteger(newApkVersion);
1032  
1033  			if (a.compareTo(b) == -1) {
1034  				mUpdateView.setVisibility(View.VISIBLE);
1035  				mUpdateButton.setOnClickListener(new View.OnClickListener() {
1036  					@Override
1037  					public void onClick(View v) {
1038  						if (write())
1039  							return;
1040  
1041  						DownloadsUtil.add(getContext(),
1042  								&quot;XposedInstaller_by_dvdandroid&quot;, newApkLink,
1043  								new DownloadsUtil.DownloadFinishedCallback() {
1044  							@Override
1045  							public void onDownloadFinished(Context context,
1046  									DownloadsUtil.DownloadInfo info) {
1047  								Intent intent = new Intent(Intent.ACTION_VIEW);
1048  								intent.setDataAndType(
1049  										Uri.fromFile(new File(Environment
1050  												.getExternalStorageDirectory()
1051  												.getAbsolutePath()
1052  												+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),
1053  										DownloadsUtil.MIME_TYPE_APK);
1054  								intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
1055  								context.startActivity(intent);
1056  							}
1057  						}, DownloadsUtil.MIME_TYPES.APK, true);
1058  					}
1059  				});
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1060 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1061 -				if (prefs != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1062 -					prefs.edit()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1063 -							.putString(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1064 -									&quot;changelog_&quot; + XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1065 -									newApkChangelog)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1066 -							.apply();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1067 -				}</span>
1068  			}
1069  		}
1070  	}
1071  }</pre></td>
                            <td><pre>   1  package de.robv.android.xposed.installer;
   2  
   3  import static android.content.Context.MODE_PRIVATE;
   4  import static de.robv.android.xposed.installer.XposedApp.WRITE_EXTERNAL_PERMISSION;
   5  import static de.robv.android.xposed.installer.util.XposedZip.Installer;
   6  import static de.robv.android.xposed.installer.util.XposedZip.Uninstaller;
   7  
   8  import android.Manifest;
   9  import android.annotation.TargetApi;
  10  import android.app.Activity;
  11  import android.content.Context;
  12  import android.content.DialogInterface;
  13  import android.content.Intent;
  14  import android.content.SharedPreferences;
  15  import android.content.pm.PackageManager;
  16  import android.net.Uri;
  17  import android.os.AsyncTask;
  18  import android.os.Build;
  19  import android.os.Bundle;
  20  import android.os.Environment;
  21  import android.os.Looper;
  22  import android.os.ParcelFileDescriptor;
  23  import android.support.annotation.NonNull;
  24  import android.support.v4.app.ActivityCompat;
  25  import android.support.v4.app.Fragment;
  26  import android.support.v7.widget.CardView;
  27  import android.system.Os;
  28  import android.text.Html;
  29  import android.text.TextUtils;
  30  import android.util.Log;
  31  import android.view.LayoutInflater;
  32  import android.view.Menu;
  33  import android.view.MenuInflater;
  34  import android.view.MenuItem;
  35  import android.view.View;
  36  import android.view.ViewGroup;
  37  import android.widget.Button;
  38  import android.widget.CheckBox;
  39  import android.widget.ImageView;
  40  import android.widget.ProgressBar;
  41  import android.widget.Spinner;
  42  import android.widget.TextView;
  43  import android.widget.Toast;
  44  
  45  import com.afollestad.materialdialogs.MaterialDialog;
  46  
  47  import java.io.BufferedReader;
  48  import java.io.File;
  49  import java.io.IOException;
  50  import java.io.InputStreamReader;
  51  import java.math.BigInteger;
  52  import java.net.HttpURLConnection;
  53  import java.net.MalformedURLException;
  54  import java.net.URL;
  55  import java.util.ArrayList;
  56  import java.util.LinkedList;
  57  import java.util.List;
  58  import java.util.Locale;
  59  
  60  import org.json.JSONArray;
  61  import org.json.JSONObject;
  62  
  63  import de.robv.android.xposed.installer.util.AssetUtil;
  64  import de.robv.android.xposed.installer.util.DownloadsUtil;
  65  import de.robv.android.xposed.installer.util.NavUtil;
  66  import de.robv.android.xposed.installer.util.NotificationUtil;
  67  import de.robv.android.xposed.installer.util.RootUtil;
  68  import de.robv.android.xposed.installer.util.ThemeUtil;
  69  import de.robv.android.xposed.installer.util.XposedZip;
  70  
  71  public class InstallerFragment extends Fragment
  72  		implements ActivityCompat.OnRequestPermissionsResultCallback,
  73  		DownloadsUtil.DownloadFinishedCallback {
  74  	private static final String JAR_PATH = &quot;/system/framework/XposedBridge.jar&quot;;

  75  	private static final int INSTALL_MODE_NORMAL = 0;
  76  	private static final int INSTALL_MODE_RECOVERY_AUTO = 1;
  77  	private static final int INSTALL_MODE_RECOVERY_MANUAL = 2;
<abbr title="  78  	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposed.json&quot;;">  78  	private static String JSON_LINK = &quot;https://raw.githubusercontent.com/DVDAndroid/XposedInstaller/material/app/xposðŸ”µ</abbr>
  79  	private static List&lt;String&gt; messages = new LinkedList&lt;&gt;();
  80  	private static ArrayList&lt;Installer&gt; installers;
  81  	private static ArrayList&lt;Uninstaller&gt; uninstallers;
  82  	private final LinkedList&lt;String&gt; mCompatibilityErrors = new LinkedList&lt;&gt;();
  83  	private String APP_PROCESS_NAME = null;
  84  	private RootUtil mRootUtil = new RootUtil();
  85  	private boolean mHadSegmentationFault = false;
  86  	private MaterialDialog.Builder dlgProgress;
  87  	private TextView txtInstallError, txtKnownIssue;
  88  	private Button btnInstall, btnUninstall;
  89  	private ProgressBar mInstallersLoading;
  90  	private Spinner mInstallersChooser;
  91  	private ProgressBar mUninstallersLoading;
  92  	private Spinner mUninstallersChooser;
  93  	private ImageView mInfoInstaller, mInfoUninstaller;
  94  	private String newApkVersion = XposedApp.THIS_APK_VERSION;
  95  	private String newApkLink;
  96  	private String newApkChangelog;
  97  	private CardView mUpdateView;
  98  	private Button mUpdateButton;
  99  	private TextView mInstallForbidden;
 100  	private ImageView mInfoUpdate;
 101  
 102  	private static int extractIntPart(String str) {
 103  		int result = 0, length = str.length();
 104  		for (int offset = 0; offset &lt; length; offset++) {
 105  			char c = str.charAt(offset);
 106  			if (&#x27;0&#x27; &lt;= c &amp;&amp; c &lt;= &#x27;9&#x27;)
 107  				result = result * 10 + (c - &#x27;0&#x27;);
 108  			else
 109  				break;
 110  		}
 111  		return result;
 112  	}
 113  
 114  	private static boolean checkClassExists(String className) {
 115  		try {
 116  			Class.forName(className);
 117  			return true;
 118  		} catch (ClassNotFoundException e) {
 119  			return false;
 120  		}
 121  	}
 122  
 123  	public static ArrayList&lt;Installer&gt; getInstallersBySdk(int sdk) {
 124  		ArrayList&lt;Installer&gt; list = new ArrayList&lt;&gt;();
 125  		for (Installer i : installers) {
 126  			if (i.sdk == sdk)
 127  				list.add(i);
 128  		}
 129  
 130  		if (list.size() == 0) {
 131  			list.add(new Installer());
 132  		}
 133  		return list;
 134  	}
 135  
 136  	/*
 137  	 * public static ArrayList&lt;Installer&gt; getInstallersBySdkAndArchitecture( int
 138  	 * sdk, String architecture) { ArrayList&lt;Installer&gt; list = new
 139  	 * ArrayList&lt;&gt;(); ArrayList&lt;Installer&gt; list2 = new ArrayList&lt;&gt;(); for
 140  	 * (Installer i : installers) { if (i.sdk == sdk) list.add(i); } for
 141  	 * (Installer i : list) { if (i.architecture.equals(architecture))
 142  	 * list2.add(i); } return list2; }
 143  	 *
 144  	 * public static ArrayList&lt;Uninstaller&gt; getUninstallersByArchitecture(
 145  	 * String architecture) { ArrayList&lt;Uninstaller&gt; list = new ArrayList&lt;&gt;();
 146  	 * for (Uninstaller u : uninstallers) { if
 147  	 * (u.architecture.equals(architecture)) list.add(u); } return list; }
 148  	 */
 149  
 150  	@Override
 151  	public void onActivityCreated(Bundle savedInstanceState) {
 152  		super.onActivityCreated(savedInstanceState);
 153  		Activity activity = getActivity();
 154  
 155  		dlgProgress = new MaterialDialog.Builder(activity).progress(true, 0);
 156  		setHasOptionsMenu(true);
 157  	}
 158  
 159  	@Override
 160  	public View onCreateView(LayoutInflater inflater, ViewGroup container,
 161  			Bundle savedInstanceState) {
 162  		View v = inflater.inflate(R.layout.tab_installer, container, false);
 163  
 164  		txtInstallError = (TextView) v
 165  				.findViewById(R.id.framework_install_errors);
 166  		txtKnownIssue = (TextView) v.findViewById(R.id.framework_known_issue);
 167  
 168  		btnInstall = (Button) v.findViewById(R.id.btnInstall);
 169  		btnUninstall = (Button) v.findViewById(R.id.btnUninstall);
 170  
 171  		mInstallersLoading = (ProgressBar) v
 172  				.findViewById(R.id.loadingInstallers);
 173  		mUninstallersLoading = (ProgressBar) v
 174  				.findViewById(R.id.loadingUninstallers);
 175  		mInstallersChooser = (Spinner) v.findViewById(R.id.chooserInstallers);
 176  		mUninstallersChooser = (Spinner) v
 177  				.findViewById(R.id.chooserUninstallers);
 178  		mUpdateView = (CardView) v.findViewById(R.id.updateView);
 179  		mUpdateButton = (Button) v.findViewById(R.id.updateButton);
 180  
 181  		mInfoInstaller = (ImageView) v.findViewById(R.id.infoInstaller);
 182  		mInfoUninstaller = (ImageView) v.findViewById(R.id.infoUninstaller);
 183  
 184  		mInstallForbidden = (TextView) v
 185  				.findViewById(R.id.installationForbidden);
 186  		mInfoUpdate = (ImageView) v.findViewById(R.id.infoUpdate);
 187  
 188  		String installedXposedVersion = XposedApp.getXposedProp()
 189  				.get(&quot;version&quot;);
 190  
 191  		if (Build.VERSION.SDK_INT &gt;= 21) {
 192  			if (installedXposedVersion == null) {
 193  				txtInstallError.setText(R.string.installation_lollipop);
 194  				txtInstallError
 195  						.setTextColor(getResources().getColor(R.color.warning));
 196  			} else {
 197  				int installedXposedVersionInt = extractIntPart(
 198  						installedXposedVersion);
 199  				if (installedXposedVersionInt == XposedApp
 200  						.getActiveXposedVersion()) {

 201  					txtInstallError
 202  							.setText(getString(R.string.installed_lollipop,
 203  									installedXposedVersion));
 204  					txtInstallError.setTextColor(
 205  							getResources().getColor(R.color.darker_green));
 206  				} else {
 207  					txtInstallError.setText(
 208  							getString(R.string.installed_lollipop_inactive,
 209  									installedXposedVersion));
 210  					txtInstallError.setTextColor(
 211  							getResources().getColor(R.color.warning));
 212  				}
 213  			}
 214  		} else {
 215  			boolean backupXposed = new File(&quot;/system/bin/app_process.orig&quot;)
 216  					.exists();
 217  			if (backupXposed) {
 218  				txtInstallError.setText(R.string.installed_no_lollipop);



 219  				txtInstallError.setTextColor(
 220  						getResources().getColor(R.color.darker_green));
 221  			} else {
 222  				txtInstallError
 223  						.setText(getString(R.string.not_installed_no_lollipop));
 224  				txtInstallError
 225  						.setTextColor(getResources().getColor(R.color.warning));
 226  			}
 227  		}
 228  
 229  		txtInstallError.setVisibility(View.VISIBLE);
 230  
 231  		if (!XposedApp.getPreferences().getBoolean(&quot;hide_install_warning&quot;,
 232  				false)) {
 233  			final View dontShowAgainView = inflater
 234  					.inflate(R.layout.dialog_install_warning, null);
 235  
 236  			new MaterialDialog.Builder(getActivity())
 237  					.title(R.string.install_warning_title)
 238  					.customView(dontShowAgainView, false)
 239  					.positiveText(android.R.string.ok)
 240  					.callback(new MaterialDialog.ButtonCallback() {
 241  						@Override
 242  						public void onPositive(MaterialDialog dialog) {
 243  							super.onPositive(dialog);
 244  							CheckBox checkBox = (CheckBox) dontShowAgainView
 245  									.findViewById(android.R.id.checkbox);
 246  							if (checkBox.isChecked())
 247  								XposedApp.getPreferences().edit().putBoolean(
 248  										&quot;hide_install_warning&quot;, true).apply();
 249  						}
 250  					}).cancelable(false).show();
 251  		}
 252  
 253  		new JSONParser(JSON_LINK).execute();
 254  
 255  		mInfoInstaller.setOnClickListener(new View.OnClickListener() {
 256  			@Override
 257  			public void onClick(View v) {
 258  				Installer selectedInstaller = (Installer) mInstallersChooser
 259  						.getSelectedItem();
 260  				String s = getString(R.string.infoInstaller,
 261  						selectedInstaller.name, selectedInstaller.sdk,
 262  						selectedInstaller.architecture,
 263  						selectedInstaller.version);
 264  
 265  				new MaterialDialog.Builder(getContext()).title(R.string.info)
 266  						.content(s).positiveText(android.R.string.ok).show();
 267  			}
 268  		});
 269  		mInfoUninstaller.setOnClickListener(new View.OnClickListener() {
 270  			@Override
 271  			public void onClick(View v) {
 272  				Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 273  						.getSelectedItem();
 274  				String s = getString(R.string.infoUninstaller,
 275  						selectedUninstaller.name,
 276  						selectedUninstaller.architecture,
 277  						selectedUninstaller.date);
 278  
 279  				new MaterialDialog.Builder(getContext()).title(R.string.info)
 280  						.content(s).positiveText(android.R.string.ok).show();
 281  			}
 282  		});
 283  
 284  		btnInstall.setOnClickListener(new View.OnClickListener() {
 285  			@Override
 286  			public void onClick(View v) {
 287  				if (write())
 288  					return;
 289  
 290  				areYouSure(R.string.warningArchitecture,
 291  						new MaterialDialog.ButtonCallback() {
 292  					@Override
 293  					public void onPositive(MaterialDialog dialog) {
 294  						super.onPositive(dialog);
 295  
 296  						Installer selectedInstaller = (Installer) mInstallersChooser
 297  								.getSelectedItem();
 298  
 299  						DownloadsUtil.add(getContext(), selectedInstaller.name,
 300  								selectedInstaller.link, InstallerFragment.this,
 301  								DownloadsUtil.MIME_TYPES.ZIP, true);
 302  					}
 303  				});
 304  			}
 305  		});
 306  
 307  		btnUninstall.setOnClickListener(new View.OnClickListener() {
 308  			@Override
 309  			public void onClick(View v) {
 310  				if (write())
 311  					return;
 312  				areYouSure(R.string.warningArchitecture,
 313  						new MaterialDialog.ButtonCallback() {
 314  					@Override
 315  					public void onPositive(MaterialDialog dialog) {
 316  						super.onPositive(dialog);
 317  
 318  						Uninstaller selectedUninstaller = (Uninstaller) mUninstallersChooser
 319  								.getSelectedItem();
 320  
 321  						DownloadsUtil.add(getContext(),
 322  								selectedUninstaller.name,
 323  								selectedUninstaller.link,
 324  								InstallerFragment.this,
 325  								DownloadsUtil.MIME_TYPES.ZIP, true);
 326  					}
 327  				});
 328  			}
 329  		});
 330  
 331  		return v;
 332  	}
 333  
 334  	@Override
 335  	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 336  		inflater.inflate(R.menu.menu_installer, menu);
 337  	}
 338  
 339  	@Override
 340  	public boolean onOptionsItemSelected(MenuItem item) {
 341  
 342  		switch (item.getItemId()) {
 343  			case R.id.help:
 344  				new MaterialDialog.Builder(getContext()).title(R.string.help)
 345  						.content(R.string.helpChoose)
 346  						.positiveText(android.R.string.ok).show();
 347  				break;
 348  			case R.id.installation_mode:
 349  				Intent intent = new Intent(getActivity(),
 350  						SettingsActivity.class);
 351  				startActivity(intent);
 352  				break;
 353  			case R.id.reboot:
 354  				areYouSure(R.string.reboot,
 355  						new MaterialDialog.ButtonCallback() {
 356  							@Override
 357  							public void onPositive(MaterialDialog dialog) {
 358  								super.onPositive(dialog);
 359  								reboot(null);
 360  							}
 361  						});
 362  				break;
 363  			case R.id.soft_reboot:
 364  				areYouSure(R.string.reboot,
 365  						new MaterialDialog.ButtonCallback() {
 366  							@Override
 367  							public void onPositive(MaterialDialog dialog) {
 368  								super.onPositive(dialog);
 369  								softReboot();
 370  							}
 371  						});
 372  				break;
 373  		}
 374  
 375  		return super.onOptionsItemSelected(item);
 376  	}
 377  
 378  	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 379  	public void performFileSearch() {
 380  		Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 381  		intent.addCategory(Intent.CATEGORY_OPENABLE);
 382  		intent.setType(&quot;application/zip&quot;);
 383  		startActivityForResult(intent, 123);
 384  	}
 385  
 386  	@Override
 387  	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
 388  	public void onActivityResult(int requestCode, int resultCode,
 389  			Intent resultData) {
 390  		if (requestCode == 123 &amp;&amp; resultCode == Activity.RESULT_OK) {
 391  			if (resultData != null) {
 392  				Uri uri = resultData.getData();
 393  				String resolved = null;
 394  				try (ParcelFileDescriptor fd = getActivity()
 395  						.getContentResolver().openFileDescriptor(uri, &quot;r&quot;)) {
 396  					final File procfsFdFile = new File(
 397  							&quot;/proc/self/fd/&quot; + fd.getFd());
 398  
 399  					resolved = Os.readlink(procfsFdFile.getAbsolutePath());
 400  
 401  					if (TextUtils.isEmpty(resolved) || resolved.charAt(0) != &#x27;/&#x27;
 402  							|| resolved.startsWith(&quot;/proc/&quot;)
 403  							|| resolved.startsWith(&quot;/fd/&quot;))
 404  						;
 405  				} catch (Exception errnoe) {
 406  					Log.e(XposedApp.TAG, &quot;ReadError&quot;);
 407  				}
 408  				mRootUtil.execute(&quot;cp &quot; + resolved + &quot; /cache/xposed.zip&quot;,
 409  						messages);
 410  				installXposedZip();
 411  			}
 412  		}
 413  	}
 414  
 415  	private void installXposedZip() {
 416  		mRootUtil.execute(
 417  				&quot;echo &#x27;install /cache/xposed.zip&#x27; &gt;/cache/recovery/openrecoveryscript &quot;,
 418  				messages);
 419  		mRootUtil.execute(&quot;sync&quot;, messages);
 420  		reboot(&quot;recovery&quot;);
 421  	}
 422  
 423  	@Override
 424  	public void onRequestPermissionsResult(int requestCode,
 425  			@NonNull String[] permissions, @NonNull int[] grantResults) {
 426  		if (requestCode == WRITE_EXTERNAL_PERMISSION) {
 427  			if (grantResults.length == 1
 428  					&amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {
 429  				Toast.makeText(getActivity(), R.string.permissionGranted,
 430  						Toast.LENGTH_LONG).show();
 431  			} else {
 432  				Toast.makeText(getActivity(), R.string.permissionNotGranted,
 433  						Toast.LENGTH_LONG).show();
 434  			}
 435  		} else {
 436  			super.onRequestPermissionsResult(requestCode, permissions,
 437  					grantResults);
 438  		}
 439  	}
 440  
 441  	private boolean write() {
 442  		if (ActivityCompat.checkSelfPermission(getContext(),
 443  				Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
 444  
 445  			ActivityCompat.requestPermissions(getActivity(),
 446  					new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE },
 447  					WRITE_EXTERNAL_PERMISSION);
 448  
 449  			return true;
 450  		} else {
 451  			return false;
 452  		}
 453  	}
 454  
 455  	@Override
 456  	public void onResume() {
 457  		super.onResume();
 458  		NotificationUtil.cancel(NotificationUtil.NOTIFICATION_MODULES_UPDATED);
 459  		mHadSegmentationFault = false;
 460  		refreshKnownIssue();
 461  	}
 462  
 463  	@Override
 464  	public void onDestroy() {
 465  		super.onDestroy();
 466  		mRootUtil.dispose();
 467  	}
 468  
 469  	private String versionToText(int version) {
 470  		return (version == 0) ? getString(R.string.none)
 471  				: Integer.toString(version);
 472  	}
 473  
 474  	private void refreshKnownIssue() {
 475  		String issueName = null;
 476  		String issueLink = null;
 477  
 478  		if (new File(&quot;/system/framework/core.jar.jex&quot;).exists()) {
 479  			issueName = &quot;Aliyun OS&quot;;
 480  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52289793&amp;postcount=5&quot;;
 481  
 482  		} else if (new File(&quot;/data/miui/DexspyInstaller.jar&quot;).exists()
 483  				|| checkClassExists(&quot;miui.dexspy.DexspyInstaller&quot;)) {
 484  			issueName = &quot;MIUI/Dexspy&quot;;
 485  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52291098&amp;postcount=6&quot;;
 486  
 487  		} else if (mHadSegmentationFault) {
 488  			issueName = &quot;Segmentation fault&quot;;
 489  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52292102&amp;postcount=7&quot;;
 490  
 491  		} else
 492  			if (checkClassExists(&quot;com.huawei.android.content.res.ResourcesEx&quot;)
 493  					|| checkClassExists(&quot;android.content.res.NubiaResources&quot;)) {
 494  			issueName = &quot;Resources subclass&quot;;
 495  			issueLink = &quot;http://forum.xda-developers.com/showpost.php?p=52801382&amp;postcount=8&quot;;
 496  		}
 497  
 498  		if (issueName != null) {
 499  			final String issueLinkFinal = issueLink;
 500  			txtKnownIssue.setText(
 501  					getString(R.string.install_known_issue, issueName));
 502  			txtKnownIssue.setVisibility(View.VISIBLE);
 503  			txtKnownIssue.setOnClickListener(new View.OnClickListener() {
 504  				@Override
 505  				public void onClick(View v) {
 506  					NavUtil.startURL(getActivity(), issueLinkFinal);
 507  				}
 508  			});
 509  
 510  			txtInstallError.setTextColor(ThemeUtil.getThemeColor(getActivity(),
 511  					android.R.attr.textColorTertiary));
 512  		} else {
 513  			txtKnownIssue.setVisibility(View.GONE);
 514  		}
 515  	}
 516  
 517  	private void showAlert(final String result) {
 518  		if (Looper.myLooper() != Looper.getMainLooper()) {
 519  			getActivity().runOnUiThread(new Runnable() {
 520  				@Override
 521  				public void run() {
 522  					showAlert(result);
 523  				}
 524  			});
 525  			return;
 526  		}
 527  
 528  		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 529  				.content(result).positiveText(android.R.string.ok).build();
 530  		dialog.show();
 531  
 532  		TextView txtMessage = (TextView) dialog
 533  				.findViewById(android.R.id.message);
 534  		try {
 535  			txtMessage.setTextSize(14);
 536  		} catch (NullPointerException ignored) {
 537  		}
 538  
 539  		mHadSegmentationFault = result.toLowerCase(Locale.US)
 540  				.contains(&quot;segmentation fault&quot;);
 541  		refreshKnownIssue();
 542  	}
 543  
 544  	private void areYouSure(int messageTextId,
 545  			MaterialDialog.ButtonCallback yesHandler) {
 546  		new MaterialDialog.Builder(getActivity()).title(messageTextId)
 547  				.content(R.string.areyousure)
 548  				.iconAttr(android.R.attr.alertDialogIcon)
 549  				.positiveText(android.R.string.yes)
 550  				.negativeText(android.R.string.no).callback(yesHandler).show();
 551  	}
 552  
 553  	private void showConfirmDialog(final String message,
 554  			final MaterialDialog.ButtonCallback callback) {
 555  		if (Looper.myLooper() != Looper.getMainLooper()) {
 556  			getActivity().runOnUiThread(new Runnable() {
 557  				@Override
 558  				public void run() {
 559  					showConfirmDialog(message, callback);
 560  				}
 561  			});
 562  			return;
 563  		}
 564  
 565  		MaterialDialog dialog = new MaterialDialog.Builder(getActivity())
 566  				.content(message).positiveText(android.R.string.yes)
 567  				.negativeText(android.R.string.no).callback(callback).build();
 568  
 569  		TextView txtMessage = (TextView) dialog
 570  				.findViewById(android.R.id.message);
 571  		txtMessage.setTextSize(14);
 572  
 573  		mHadSegmentationFault = message.toLowerCase(Locale.US)
 574  				.contains(&quot;segmentation fault&quot;);
 575  		refreshKnownIssue();
 576  	}
 577  
 578  	private boolean checkCompatibility() {
 579  		mCompatibilityErrors.clear();
 580  		return checkAppProcessCompatibility();
 581  	}
 582  
 583  	private boolean checkAppProcessCompatibility() {
 584  		try {
 585  			if (APP_PROCESS_NAME == null)
 586  				return false;
 587  
 588  			File testFile = AssetUtil.writeAssetToCacheFile(APP_PROCESS_NAME,
 589  					&quot;app_process&quot;, 00700);
 590  			if (testFile == null) {
 591  				mCompatibilityErrors
 592  						.add(&quot;could not write app_process to cache&quot;);
 593  				return false;
 594  			}
 595  
 596  			Process p = Runtime.getRuntime().exec(new String[] {
 597  					testFile.getAbsolutePath(), &quot;--xposedversion&quot; });
 598  
 599  			BufferedReader stdout = new BufferedReader(
 600  					new InputStreamReader(p.getInputStream()));
 601  			String result = stdout.readLine();
 602  			stdout.close();
 603  
 604  			BufferedReader stderr = new BufferedReader(
 605  					new InputStreamReader(p.getErrorStream()));
 606  			String errorLine;
 607  			while ((errorLine = stderr.readLine()) != null) {
 608  				mCompatibilityErrors.add(errorLine);
 609  			}
 610  			stderr.close();
 611  
 612  			p.destroy();
 613  
 614  			testFile.delete();
 615  			return result != null &amp;&amp; result.startsWith(&quot;Xposed version: &quot;);
 616  		} catch (IOException e) {
 617  			mCompatibilityErrors.add(e.getMessage());
 618  			return false;
 619  		}
 620  	}
 621  
 622  	private boolean startShell() {
 623  		if (mRootUtil.startShell())
 624  			return true;
 625  
 626  		showAlert(getString(R.string.root_failed));
 627  		return false;
 628  	}
 629  
 630  	private int getInstallMode() {
 631  		int mode = XposedApp.getPreferences().getInt(&quot;install_mode&quot;,
 632  				INSTALL_MODE_NORMAL);
 633  		if (mode &lt; INSTALL_MODE_NORMAL || mode &gt; INSTALL_MODE_RECOVERY_MANUAL)
 634  			mode = INSTALL_MODE_NORMAL;
 635  		return mode;
 636  	}
 637  
 638  	private String getInstallModeText() {
 639  		final int installMode = getInstallMode();
 640  		switch (installMode) {
 641  			case INSTALL_MODE_NORMAL:
 642  				return getString(R.string.install_mode_normal);
 643  			case INSTALL_MODE_RECOVERY_AUTO:
 644  				return getString(R.string.install_mode_recovery_auto);
 645  			case INSTALL_MODE_RECOVERY_MANUAL:
 646  				return getString(R.string.install_mode_recovery_manual);
 647  		}
 648  		throw new IllegalStateException(&quot;unknown install mode &quot; + installMode);
 649  	}
 650  
 651  	private boolean prepareAutoFlash(List&lt;String&gt; messages, String file) {
 652  		if (mRootUtil.execute(&quot;ls /cache/recovery&quot;, null) != 0) {
 653  			messages.add(getString(R.string.file_creating_directory,
 654  					&quot;/cache/recovery&quot;));
 655  			if (mRootUtil.executeWithBusybox(&quot;mkdir /cache/recovery&quot;,
 656  					messages) != 0) {
 657  				messages.add(&quot;&quot;);
 658  				messages.add(getString(R.string.file_create_directory_failed,
 659  						&quot;/cache/recovery&quot;));
 660  				return false;
 661  			}
 662  		}
 663  
 664  		messages.add(getString(R.string.file_copying, file));
 665  		File tempFile = AssetUtil.writeAssetToCacheFile(file, 00644);
 666  		if (tempFile == null) {
 667  			messages.add(&quot;&quot;);
 668  			messages.add(getString(R.string.file_extract_failed, file));
 669  			return false;
 670  		}
 671  
 672  		if (mRootUtil.executeWithBusybox(&quot;cp -a &quot; + tempFile.getAbsolutePath()
 673  				+ &quot; /cache/recovery/&quot; + file, messages) != 0) {
 674  			messages.add(&quot;&quot;);
 675  			messages.add(getString(R.string.file_copy_failed, file, &quot;/cache&quot;));
 676  			tempFile.delete();
 677  			return false;
 678  		}
 679  
 680  		tempFile.delete();
 681  
 682  		messages.add(getString(R.string.file_writing_recovery_command));
 683  		if (mRootUtil.execute(
 684  				&quot;echo \&quot;--update_package=/cache/recovery/&quot; + file
 685  						+ &quot;\n--show_text\&quot; &gt; /cache/recovery/command&quot;,
 686  				messages) != 0) {
 687  			messages.add(&quot;&quot;);
 688  			messages.add(
 689  					getString(R.string.file_writing_recovery_command_failed));
 690  			return false;
 691  		}
 692  
 693  		return true;
 694  	}
 695  
 696  	private boolean prepareManualFlash(List&lt;String&gt; messages, String file) {
 697  		messages.add(getString(R.string.file_copying, file));
 698  		if (AssetUtil.writeAssetToSdcardFile(file, 00644) == null) {
 699  			messages.add(&quot;&quot;);
 700  			messages.add(getString(R.string.file_extract_failed, file));
 701  			return false;
 702  		}
 703  
 704  		return true;
 705  	}
 706  
 707  	private void offerReboot(List&lt;String&gt; messages) {
 708  		messages.add(getString(R.string.file_done));
 709  		messages.add(&quot;&quot;);
 710  		messages.add(getString(R.string.reboot_confirmation));
 711  		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 712  				new MaterialDialog.ButtonCallback() {
 713  					@Override
 714  					public void onPositive(MaterialDialog dialog) {
 715  						super.onPositive(dialog);
 716  						reboot(null);
 717  					}
 718  				});
 719  	}
 720  
 721  	private void offerRebootToRecovery(List&lt;String&gt; messages, final String file,
 722  			final int installMode) {
 723  		if (installMode == INSTALL_MODE_RECOVERY_AUTO)
 724  			messages.add(getString(R.string.auto_flash_note, file));
 725  		else
 726  			messages.add(getString(R.string.manual_flash_note, file));
 727  
 728  		messages.add(&quot;&quot;);
 729  		messages.add(getString(R.string.reboot_recovery_confirmation));
 730  		showConfirmDialog(TextUtils.join(&quot;\n&quot;, messages).trim(),
 731  				new MaterialDialog.ButtonCallback() {
 732  					@Override
 733  					public void onPositive(MaterialDialog dialog) {
 734  						super.onPositive(dialog);
 735  						reboot(&quot;recovery&quot;);
 736  					}
 737  
 738  					@Override
 739  					public void onNegative(MaterialDialog dialog) {
 740  						super.onNegative(dialog);
 741  						if (installMode == INSTALL_MODE_RECOVERY_AUTO) {
 742  							// clean up to avoid unwanted flashing
 743  							mRootUtil.executeWithBusybox(
 744  									&quot;rm /cache/recovery/command&quot;, null);
 745  							mRootUtil.executeWithBusybox(
 746  									&quot;rm /cache/recovery/&quot; + file, null);
 747  							AssetUtil.removeBusybox();
 748  						}
 749  					}
 750  				}
 751  
 752  		);
 753  	}
 754  
 755  	private void softReboot() {
 756  		if (!startShell())
 757  			return;
 758  
 759  		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 760  		if (mRootUtil.execute(
 761  				&quot;setprop ctl.restart surfaceflinger; setprop ctl.restart zygote&quot;,
 762  				messages) != 0) {
 763  			messages.add(&quot;&quot;);
 764  			messages.add(getString(R.string.reboot_failed));
 765  			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 766  		}
 767  	}
 768  
 769  	private void reboot(String mode) {
 770  		if (!startShell())
 771  			return;
 772  
 773  		List&lt;String&gt; messages = new LinkedList&lt;String&gt;();
 774  
 775  		String command = &quot;reboot&quot;;
 776  		if (mode != null) {
 777  			command += &quot; &quot; + mode;
 778  			if (mode.equals(&quot;recovery&quot;))
 779  				// create a flag used by some kernels to boot into recovery
 780  				mRootUtil.executeWithBusybox(&quot;touch /cache/recovery/boot&quot;,
 781  						messages);
 782  		}
 783  
 784  		if (mRootUtil.executeWithBusybox(command, messages) != 0) {
 785  			messages.add(&quot;&quot;);
 786  			messages.add(getString(R.string.reboot_failed));
 787  			showAlert(TextUtils.join(&quot;\n&quot;, messages).trim());
 788  		}
 789  		AssetUtil.removeBusybox();
 790  	}
 791  
 792  	@Override
 793  	public void onDownloadFinished(final Context context,
 794  			DownloadsUtil.DownloadInfo info) {
 795  		Toast.makeText(context,
 796  				getString(R.string.downloadZipOk, info.localFilename),
 797  				Toast.LENGTH_LONG).show();
 798  
 799  		if (getInstallMode() == INSTALL_MODE_RECOVERY_MANUAL)
 800  			return;
 801  
 802  		areYouSure(R.string.install_warning,
 803  				new MaterialDialog.ButtonCallback() {
 804  					@Override
 805  					public void onPositive(MaterialDialog dialog) {
 806  						super.onPositive(dialog);
 807  						Toast.makeText(context, R.string.selectFile,
 808  								Toast.LENGTH_LONG).show();
 809  
 810  						performFileSearch();
 811  					}
 812  				});
 813  	}
 814  
 815  	private abstract class AsyncClickListener implements View.OnClickListener {
 816  		private final CharSequence mProgressDlgText;
 817  
 818  		public AsyncClickListener(CharSequence progressDlgText) {
 819  			mProgressDlgText = progressDlgText;
 820  		}
 821  
 822  		@Override
 823  		public final void onClick(final View v) {
 824  			if (mProgressDlgText != null) {
 825  				dlgProgress.content(mProgressDlgText);
 826  				dlgProgress.show();
 827  			}
 828  			new Thread() {
 829  				public void run() {
 830  					onAsyncClick(v);
 831  					dlgProgress.build().dismiss();
 832  				}
 833  			}.start();
 834  		}
 835  
 836  		protected abstract void onAsyncClick(View v);
 837  	}
 838  
 839  	private abstract class AsyncDialogClickListener
 840  			implements DialogInterface.OnClickListener {
 841  		private final CharSequence mProgressDlgText;
 842  
 843  		public AsyncDialogClickListener(CharSequence progressDlgText) {
 844  			mProgressDlgText = progressDlgText;
 845  		}
 846  
 847  		@Override
 848  		public void onClick(final DialogInterface dialog, final int which) {
 849  			if (mProgressDlgText != null) {
 850  				dlgProgress.content(mProgressDlgText);
 851  				dlgProgress.show();
 852  			}
 853  			new Thread() {
 854  				public void run() {
 855  					onAsyncClick(dialog, which);
 856  					dlgProgress.build().dismiss();
 857  				}
 858  			}.start();
 859  		}
 860  
 861  		protected abstract void onAsyncClick(DialogInterface dialog, int which);
 862  	}
 863  
 864  	private class JSONParser extends AsyncTask&lt;Void, Void, Boolean&gt; {
 865  		private URL mUrl;
 866  
 867  		public JSONParser(String mUrl) {
 868  			try {
 869  				this.mUrl = new URL(mUrl);
 870  			} catch (MalformedURLException e) {
 871  				e.printStackTrace();
 872  			}
 873  		}
 874  
 875  		@Override
 876  		protected void onPreExecute() {
 877  			super.onPreExecute();
 878  
 879  			mInstallersLoading.setVisibility(View.VISIBLE);
 880  			mUninstallersLoading.setVisibility(View.VISIBLE);
 881  			mInfoInstaller.setVisibility(View.GONE);
 882  			mInfoUninstaller.setVisibility(View.GONE);
 883  		}
 884  
 885  		@Override
 886  		protected Boolean doInBackground(Void... params) {
 887  			try {
 888  				HttpURLConnection c = (HttpURLConnection) mUrl.openConnection();
 889  				c.setRequestMethod(&quot;GET&quot;);
 890  				c.setDoOutput(true);
 891  				c.connect();
 892  
 893  				BufferedReader br = new BufferedReader(
 894  						new InputStreamReader(c.getInputStream()));
 895  				StringBuilder sb = new StringBuilder();
 896  				String line;
 897  				while ((line = br.readLine()) != null) {
 898  					sb.append(line).append(&quot;\n&quot;);
 899  				}
 900  				br.close();
 901  
 902  				JSONObject json = new JSONObject(sb.toString());
 903  				JSONArray installerArray = json.getJSONArray(&quot;installer&quot;);
 904  				JSONArray uninstallerArray = json.getJSONArray(&quot;uninstaller&quot;);
 905  
 906  				installers = new ArrayList&lt;&gt;();
 907  				uninstallers = new ArrayList&lt;&gt;();
 908  
 909  				for (int i = 0; i &lt; installerArray.length(); i++) {
 910  					JSONObject jsonObject = installerArray.getJSONObject(i);
 911  
 912  					String link = jsonObject.getString(&quot;link&quot;);
 913  					String name = jsonObject.getString(&quot;name&quot;);
 914  					String architecture = jsonObject.getString(&quot;architecture&quot;);
 915  					String version = jsonObject.getString(&quot;version&quot;);
 916  					int sdk = jsonObject.getInt(&quot;sdk&quot;);
 917  
 918  					installers.add(new XposedZip.Installer(link, name,
 919  							architecture, sdk, version));
 920  				}
 921  
 922  				if (Build.VERSION.SDK_INT &gt;= 21) {
 923  					for (int i = 0; i &lt; uninstallerArray.length(); i++) {
 924  						JSONObject jsonObject = uninstallerArray
 925  								.getJSONObject(i);
 926  
 927  						String link = jsonObject.getString(&quot;link&quot;);
 928  						String name = jsonObject.getString(&quot;name&quot;);
 929  						String architecture = jsonObject
 930  								.getString(&quot;architecture&quot;);
 931  						String date = jsonObject.getString(&quot;date&quot;);
 932  
 933  						uninstallers.add(new Uninstaller(link, name,
 934  								architecture, date));
 935  					}
 936  				} else {
 937  					uninstallers.add(new Uninstaller());
 938  				}
 939  
 940  				newApkVersion = json.getJSONObject(&quot;apk&quot;).getString(&quot;version&quot;);
 941  				newApkLink = json.getJSONObject(&quot;apk&quot;).getString(&quot;link&quot;);
 942  				newApkChangelog = json.getJSONObject(&quot;apk&quot;)
 943  						.getString(&quot;changelog&quot;);
 944  				return true;
 945  			} catch (Exception e) {
 946  				e.printStackTrace();
 947  				return false;
 948  			}
 949  		}
 950  
 951  		@Override
 952  		protected void onPostExecute(Boolean result) {
 953  			super.onPostExecute(result);
 954  
 955  			btnInstall.setEnabled(result);
 956  			btnUninstall.setEnabled(result);
 957  
 958  			mInstallersLoading.setVisibility(View.GONE);
 959  			mUninstallersLoading.setVisibility(View.GONE);
 960  
 961  			int i = result ? View.VISIBLE : View.GONE;
 962  
 963  			mInstallersChooser.setVisibility(i);
 964  			mUninstallersChooser.setVisibility(i);
 965  
 966  			mInfoInstaller.setVisibility(i);
 967  			mInfoUninstaller.setVisibility(i);
 968  
 969  			if (Build.VERSION.SDK_INT &lt; 21) {
 970  				btnInstall.setEnabled(false);
 971  				btnUninstall.setEnabled(false);
 972  				mInfoInstaller.setEnabled(false);
 973  				mInfoUninstaller.setEnabled(false);
 974  				mInstallersChooser.setEnabled(false);
 975  				mUninstallersChooser.setEnabled(false);
 976  
 977  				mInstallForbidden.setVisibility(View.VISIBLE);
 978  			}
 979  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 980 -			if (!result) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 981 -				Toast.makeText(getContext(), R.string.loadingError,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 982 -						Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 983 -				return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 984 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 985 -</span>
 986  			try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 987 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 988 +				if (!result) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 989 +					Toast.makeText(getContext(), R.string.loadingError,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 990 +							Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 991 +					return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 992 +				}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 993 +</span>
 994  				mInstallersChooser
 995  						.setAdapter(new XposedZip.MyAdapter&lt;&gt;(getContext(),
 996  								getInstallersBySdk(Build.VERSION.SDK_INT)));
 997  
 998  				mUninstallersChooser.setAdapter(
 999  						new XposedZip.MyAdapter&lt;&gt;(getContext(), uninstallers));
1000  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1001 +				if (newApkChangelog != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1002 +					mInfoUpdate.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1003 +						@Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1004 +						public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1005 +							new MaterialDialog.Builder(getContext())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1006 +									.title(R.string.changes)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1007 +									.content(Html.fromHtml(newApkChangelog))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1008 +									.positiveText(android.R.string.ok).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1009 +						}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1010 +					});</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1011 +				} else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1012 +					mInfoUpdate.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1013 +				}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1014 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1015 +				if (newApkVersion == null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1016 +					return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1017 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1018 +				SharedPreferences prefs = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1019 +				try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1020 +					prefs = getContext().getSharedPreferences(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1021 +							getContext().getPackageName() + &quot;_preferences&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1022 +							MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1023 +				} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1024 +				}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1025 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1026 +				BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1027 +				BigInteger b = new BigInteger(newApkVersion);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1028 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1029 +				if (a.compareTo(b) == -1) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1030 +					mUpdateView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1031 +					mUpdateButton</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1032 +							.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1033 +								@Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1034 +								public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1035 +									if (write())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1036 +										return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1037 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1038 +									DownloadsUtil.add(getContext(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1039 +											&quot;XposedInstaller_by_dvdandroid&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1040 +											newApkLink,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1041 +											new DownloadsUtil.DownloadFinishedCallback() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1042 +										@Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1043 +										public void onDownloadFinished(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1044 +												Context context,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1045 +												DownloadsUtil.DownloadInfo info) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1046 +											Intent intent = new Intent(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1047 +													Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1048 +											intent.setDataAndType(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1049 +													Uri.fromFile(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1050 +															new File(Environment</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1051 +																	.getExternalStorageDirectory()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1052 +																	.getAbsolutePath()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1053 +																	+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1054 +													DownloadsUtil.MIME_TYPE_APK);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1055 +											intent.setFlags(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1056 +													Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1057 +											context.startActivity(intent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1058 +										}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1059 +									}, DownloadsUtil.MIME_TYPES.APK, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1060 +								}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1061 +							});</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1062 +				} else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1063 +					if (prefs != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1064 +						prefs.edit()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1065 +								.putString(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1066 +										&quot;changelog_&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1067 +												+ XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1068 +										newApkChangelog)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1069 +								.apply();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1070 +					}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1071 +				}</span>
1072  			} catch (NullPointerException ignored) {
1073  			}
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1074 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1075 -			if (newApkChangelog != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1076 -				mInfoUpdate.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1077 -					@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1078 -					public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1079 -						new MaterialDialog.Builder(getContext())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1080 -								.title(R.string.changes)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1081 -								.content(Html.fromHtml(newApkChangelog))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1082 -								.positiveText(android.R.string.ok).show();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1083 -					}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1084 -				});</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1085 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1086 -				mInfoUpdate.setVisibility(View.GONE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1087 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1088 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1089 -			if (newApkVersion == null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1090 -				return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1091 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1092 -			SharedPreferences prefs = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1093 -			try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1094 -				prefs = getContext().getSharedPreferences(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1095 -						getContext().getPackageName() + &quot;_preferences&quot;,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1096 -						MODE_PRIVATE);</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1097 -			} catch (NullPointerException ignored) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1098 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1099 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1100 -			BigInteger a = new BigInteger(XposedApp.THIS_APK_VERSION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1101 -			BigInteger b = new BigInteger(newApkVersion);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1102 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1103 -			if (a.compareTo(b) == -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1104 -				mUpdateView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1105 -				mUpdateButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1106 -					@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1107 -					public void onClick(View v) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1108 -						if (write())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1109 -							return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1110 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1111 -						DownloadsUtil.add(getContext(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1112 -								&quot;XposedInstaller_by_dvdandroid&quot;, newApkLink,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1113 -								new DownloadsUtil.DownloadFinishedCallback() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1114 -							@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1115 -							public void onDownloadFinished(Context context,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1116 -									DownloadsUtil.DownloadInfo info) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1117 -								Intent intent = new Intent(Intent.ACTION_VIEW);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1118 -								intent.setDataAndType(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1119 -										Uri.fromFile(new File(Environment</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1120 -												.getExternalStorageDirectory()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1121 -												.getAbsolutePath()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1122 -												+ &quot;/XposedInstaller/XposedInstaller_by_dvdandroid.apk&quot;)),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1123 -										DownloadsUtil.MIME_TYPE_APK);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1124 -								intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1125 -								context.startActivity(intent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1126 -							}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1127 -						}, DownloadsUtil.MIME_TYPES.APK, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1128 -					}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1129 -				});</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1130 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1131 -				if (prefs != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1132 -					prefs.edit()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1133 -							.putString(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1134 -									&quot;changelog_&quot; + XposedApp.THIS_APK_VERSION,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1135 -									newApkChangelog)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1136 -							.apply();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1137 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1138 -			}</span>
1139  		}
1140  	}
1141  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            