<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>228</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    228
                    <a href="227.html">prev</a>
                    <a href="229.html">next</a>
                    <a href="228_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_de3c38ccf75147f651391906e04cc9454d77660f_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;de3c38ccf75147f651391906e04cc9454d77660f:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;de3c38ccf75147f651391906e04cc9454d77660f^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;de3c38ccf75147f651391906e04cc9454d77660f^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;448dcf036249b943a729aa9c18b62998b9620bfa:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.view.GravityCompat;
  17 import android.support.v4.widget.DrawerLayout;
  18 import android.support.v7.app.ActionBar;
  19 import android.support.v7.app.ActionBarDrawerToggle;
  20 import android.support.v7.app.AppCompatActivity;
  21 import android.support.v7.preference.PreferenceManager;
  22 import android.support.v7.widget.SearchView;
  23 import android.support.v7.widget.Toolbar;
  24 import android.text.Spannable;
  25 import android.text.SpannableString;
  26 import android.text.TextUtils;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.WindowInsets;
  32 import android.widget.AdapterView;
  33 import android.widget.LinearLayout;
  34 import android.widget.ListView;
  35 import android.widget.ProgressBar;
  36 
  37 import com.automattic.simplenote.analytics.AnalyticsTracker;
  38 import com.automattic.simplenote.models.Note;
  39 import com.automattic.simplenote.models.Tag;
  40 import com.automattic.simplenote.utils.DisplayUtils;
  41 import com.automattic.simplenote.utils.DrawableUtils;
  42 import com.automattic.simplenote.utils.HtmlCompat;
  43 import com.automattic.simplenote.utils.PrefUtils;
  44 import com.automattic.simplenote.utils.StrUtils;
  45 import com.automattic.simplenote.utils.TagsAdapter;
  46 import com.automattic.simplenote.utils.ThemeUtils;
  47 import com.automattic.simplenote.utils.UndoBarController;
  48 import com.automattic.simplenote.widgets.TypefaceSpan;
  49 import com.simperium.Simperium;
  50 import com.simperium.client.Bucket;
  51 import com.simperium.client.BucketObjectMissingException;
  52 import com.simperium.client.BucketObjectNameInvalid;
  53 import com.simperium.client.Query;
  54 import com.simperium.client.User;
  55 
  56 import org.wordpress.passcodelock.AppLockManager;
  57 
  58 import java.util.ArrayList;
  59 import java.util.Calendar;
  60 import java.util.List;
  61 
  62 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 
  67 public class NotesActivity extends AppCompatActivity implements
<abbr title="  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  69         Bucket.Listener&lt;Note&gt; {
  70 
  71     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74     protected Bucket&lt;Tag&gt; mTagsBucket;
  75     private int TRASH_SELECTED_ID = 1;
  76     private boolean mIsShowingMarkdown;
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80     private UndoBarController mUndoBarController;
  81     private View mFragmentsContainer;
  82     private SearchView mSearchView;
  83     private MenuItem mSearchMenuItem;
  84     private NoteListFragment mNoteListFragment;
  85     private NoteEditorFragment mNoteEditorFragment;
  86     private Note mCurrentNote;
  87     private MenuItem mEmptyTrashMenuItem;
  88 
  89     // Menu drawer
  90     private DrawerLayout mDrawerLayout;
  91     private ListView mDrawerList;
  92     private NavigationView mNavigationView;
  93     private ActionBarDrawerToggle mDrawerToggle;
  94     private TagsAdapter mTagsAdapter;
  95     private TagsAdapter.TagMenuItem mSelectedTag;
  96     // Tags bucket listener
  97     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  98         void updateNavigationDrawer() {
  99             runOnUiThread(new Runnable() {
 100                 public void run() {
 101                     updateNavigationDrawerItems();
 102                 }
 103             });
 104         }
 105 
 106         @Override
 107         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 108             updateNavigationDrawer();
 109         }
 110 
 111         @Override
 112         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 113             updateNavigationDrawer();
 114         }
 115 
 116         @Override
 117         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 118             updateNavigationDrawer();
 119         }
 120 
 121         @Override
 122         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 123             // noop
 124         }
 125     };
 126 
 127     @Override
 128     protected void onCreate(Bundle savedInstanceState) {
 129 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132 </span>
 133 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     protected void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         // On lollipop, configure the translucent status bar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
 139 =======
 140 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 141         ThemeUtils.setTheme(this);
 142         super.onCreate(savedInstanceState);
 143 
 144         setContentView(R.layout.activity_notes);
 145 
 146         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 147 
 148         Simplenote currentApp = (Simplenote) getApplication();
 149         if (mNotesBucket == null) {
 150             mNotesBucket = currentApp.getNotesBucket();
 151         }
 152 
 153         if (mTagsBucket == null) {
 154             mTagsBucket = currentApp.getTagsBucket();
 155         }
 156 
 157         Toolbar toolbar = findViewById(R.id.toolbar);
 158         setSupportActionBar(toolbar);
 159         configureNavigationDrawer(toolbar);
 160 
 161         if (savedInstanceState == null) {
 162             mNoteListFragment = new NoteListFragment();
 163             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 164             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 165             fragmentTransaction.commit();
 166         } else {
<abbr title=" 167             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 167             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 168         }
 169 
 170         if (DisplayUtils.isLargeScreen(this)) {
 171             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 173             } else if (DisplayUtils.isLandscape(this)) {
 174                 addEditorFragment();
 175             }
 176         }
 177 
 178         // enable ActionBar app icon to behave as action to toggle nav drawer
 179         ActionBar actionBar = getSupportActionBar();
 180         if (actionBar != null) {
 181             actionBar.setDisplayHomeAsUpEnabled(true);
 182             actionBar.setHomeButtonEnabled(true);
 183 
 184             // Add loading indicator to show when indexing
<abbr title=" 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 186             actionBar.setDisplayShowCustomEnabled(true);
 187             actionBar.setCustomView(progressBar);
 188             setToolbarProgressVisibility(false);
 189         }
 190 
 191         mUndoBarController = new UndoBarController(this);
 192 
 193         // Creates &#x27;Welcome&#x27; note
 194         checkForFirstLaunch();
 195 
 196         checkForSharedContent();
 197 
 198         currentApp.getSimperium().setOnUserCreatedListener(this);
 199         currentApp.getSimperium().setUserStatusChangeListener(this);
 200     }
 201 
 202     @Override
 203     protected void onResume() {
 204         super.onResume();
 205 
 206         // Ensure user has valid authorization
 207         if (userAuthenticationIsInvalid()) {
 208             startLoginActivity(true);
 209             Intent intent = getIntent();
 210 
 211             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 212                 intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 213                 AnalyticsTracker.track(
 214                     NOTE_WIDGET_SIGN_IN_TAPPED,
 215                     CATEGORY_WIDGET,
 216                     &quot;note_widget_sign_in_tapped&quot;
 217                 );
 218             }
 219         }
 220 
 221         disableScreenshotsIfLocked(this);
 222 
 223         mNotesBucket.start();
 224         mTagsBucket.start();
 225 
 226         mNotesBucket.addOnNetworkChangeListener(this);
 227         mNotesBucket.addOnSaveObjectListener(this);
 228         mNotesBucket.addOnDeleteObjectListener(this);
 229         mTagsBucket.addListener(mTagsMenuUpdater);
 230 
 231         updateNavigationDrawerItems();
 232 
 233         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 234         if (userIsUnauthorized()) {
 235             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 236                 mSelectedTag = null;
 237                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 238             }
 239         }
 240 
 241         setSelectedTagActive();
 242 
 243         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 244             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 245             mShouldSelectNewNote = false;
 246         }
 247 
 248         if (mIsShowingMarkdown) {
 249             setMarkdownShowing(false);
 250         }
 251 
 252     }
 253 
 254     @Override
 255     protected void onPause() {
 256         super.onPause();  // Always call the superclass method first
 257         mTagsBucket.removeListener(mTagsMenuUpdater);
 258         mTagsBucket.stop();
 259 
 260         mNotesBucket.removeOnNetworkChangeListener(this);
 261         mNotesBucket.removeOnSaveObjectListener(this);
 262         mNotesBucket.removeOnDeleteObjectListener(this);
 263         mNotesBucket.stop();
 264     }
 265 
 266     @Override
 267     public void setTitle(CharSequence title) {
 268         if (title == null) {
 269             title = &quot;&quot;;
 270         }
 271 
 272         setTitleWithCustomFont(title);
 273     }
 274 
 275     @Override
 276     public void onBackPressed() {
 277         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 278             mDrawerLayout.closeDrawer(GravityCompat.START);
 279         } else {
 280             super.onBackPressed();
 281         }
 282     }
 283 
 284     private void setTitleWithCustomFont(CharSequence title) {
 285         if (getSupportActionBar() == null) {
 286             return;
 287         }
 288 
 289         SpannableString s = new SpannableString(title);
 290         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 291         getSupportActionBar().setTitle(s);
 292     }
 293 
 294     private void configureNavigationDrawer(Toolbar toolbar) {
 295         mDrawerLayout = findViewById(R.id.drawer_layout);
 296         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 297         mNavigationView = findViewById(R.id.navigation_view);
 298         mDrawerList = findViewById(R.id.drawer_list);
 299 
 300         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 301             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 302                 @Override
 303                 @SuppressLint(&quot;NewApi&quot;)
 304                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 305                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 306                     drawerView.setPadding(
 307                             drawerView.getPaddingLeft(),
 308                             windowInsets.getSystemWindowInsetTop(),
 309                             drawerView.getPaddingRight(),
 310                             drawerView.getPaddingBottom());
 311 
 312                     return windowInsets.consumeSystemWindowInsets();
 313                 }
 314             });
 315         }
 316 
 317         View settingsButton = findViewById(R.id.nav_settings);
 318         settingsButton.setOnClickListener(new View.OnClickListener() {
 319             @Override
 320             public void onClick(View v) {
 321                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 322                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 323             }
 324         });
 325 
 326         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 327         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 328         mDrawerList.setAdapter(mTagsAdapter);
 329         // Set the list&#x27;s click listener
 330         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 331 
 332         if (mSelectedTag == null)
 333             mSelectedTag = mTagsAdapter.getDefaultItem();
 334 
 335         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 336                 R.string.close_drawer) {
 337             public void onDrawerClosed(View view) {
 338                 supportInvalidateOptionsMenu();
 339             }
 340 
 341             public void onDrawerOpened(View drawerView) {
 342                 // noop
 343             }
 344 
 345             @Override
 346             public void onDrawerSlide(View drawerView, float slideOffset) {
 347                 super.onDrawerSlide(drawerView, 0f);
 348             }
 349         };
 350 
 351         mDrawerLayout.addDrawerListener(mDrawerToggle);
 352     }
 353 
 354     private void checkForFirstLaunch() {
 355         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 356             // Create the welcome note
 357             try {
 358                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 359                 welcomeNote.setCreationDate(Calendar.getInstance());
 360                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 361                 welcomeNote.setContent(getString(R.string.welcome_note));
 362                 welcomeNote.getTitle();
 363                 welcomeNote.save();
 364             } catch (BucketObjectNameInvalid e) {
 365                 // this won&#x27;t happen because welcome-android is a valid name
 366             }
 367 
 368             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 369             SharedPreferences.Editor editor = preferences.edit();
 370             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 371             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 372             editor.apply();
 373         }
 374     }
 375 
 376     private void checkForSharedContent() {
 377         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 378             // Check share action
 379             Intent intent = getIntent();
 380             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 381             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 382 
<abbr title=" 383             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 383             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 384             String intentAction = StrUtils.notNullStr(intent.getAction());
 385             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 386             if (!TextUtils.isEmpty(text)) {
 387                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 388                     text = subject + &quot;\n\n&quot; + text;
 389                 }
 390                 Note note = mNotesBucket.newObject();
 391                 note.setCreationDate(Calendar.getInstance());
 392                 note.setModificationDate(note.getCreationDate());
 393                 note.setContent(text);
 394                 note.save();
 395                 setCurrentNote(note);
 396                 mShouldSelectNewNote = true;
 397 
 398                 AnalyticsTracker.track(
 399                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 400                         AnalyticsTracker.CATEGORY_NOTE,
 401                         &quot;external_share&quot;
 402                 );
 403 
 404                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 405                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 406                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 407                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 408                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 409                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 410                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 411                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 412                     }
 413                 }
 414             }
 415         }
 416     }
 417 
 418     private void updateNavigationDrawerItems() {
 419         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 420         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 421         if (isAlphaSort) {
 422             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 423         } else {
 424             tagCursor = Tag.allWithName(mTagsBucket).execute();
 425         }
 426 
 427         mTagsAdapter.changeCursor(tagCursor);
 428     }
 429 
 430     private void setSelectedTagActive() {
 431         if (mSelectedTag == null)
 432             mSelectedTag = mTagsAdapter.getDefaultItem();
 433 
 434         setTitle(mSelectedTag.name);
<abbr title=" 435         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 435         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 436     }
 437 
 438     public TagsAdapter.TagMenuItem getSelectedTag() {
 439         if (mSelectedTag == null) {
 440             mSelectedTag = mTagsAdapter.getDefaultItem();
 441         }
 442 
 443         return mSelectedTag;
 444     }
 445 
 446     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 447     public void updateTrashMenuItem() {
 448         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 449             return;
 450 
 451         // Disable the trash icon if there are no notes trashed.
 452         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 453         if (query.count() == 0) {
 454             mEmptyTrashMenuItem.setEnabled(false);
 455         } else {
 456             mEmptyTrashMenuItem.setEnabled(true);
 457         }
 458     }
 459 
 460     private void addEditorFragment() {
 461         FragmentManager fm = getSupportFragmentManager();
 462         FragmentTransaction ft = fm.beginTransaction();
 463         mNoteEditorFragment = new NoteEditorFragment();
 464         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 465         ft.commitAllowingStateLoss();
 466         fm.executePendingTransactions();
 467     }
 468 
 469     private boolean userAccountRequired() {
 470         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 471     }
 472 
 473     /**
 474      * Checks for a previously valid user that is now not authenticated
 475      * Also checks if user account is required (added in version 1.5.6)
 476      *
 477      * @return true if user has invalid authorization
 478      */
 479     private boolean userAuthenticationIsInvalid() {
 480         Simplenote currentApp = (Simplenote) getApplication();
 481         Simperium simperium = currentApp.getSimperium();
 482         User user = simperium.getUser();
 483         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 484         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 485                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 486     }
 487 
 488     public boolean userIsUnauthorized() {
 489         Simplenote currentApp = (Simplenote) getApplication();
 490         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 491     }
 492 
 493     public void setCurrentNote(Note note) {
 494         mCurrentNote = note;
 495     }
 496 
 497     public NoteListFragment getNoteListFragment() {
 498         return mNoteListFragment;
 499     }
 500 
 501     @SuppressWarnings(&quot;ResourceType&quot;)
 502     @Override
 503     public boolean onCreateOptionsMenu(Menu menu) {
 504         super.onCreateOptionsMenu(menu);
 505         MenuInflater inflater = getMenuInflater();
 506         inflater.inflate(R.menu.notes_list, menu);
 507 
 508         // restore the search query if on a landscape tablet
 509         String searchQuery = null;
 510         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 511             searchQuery = mSearchView.getQuery().toString();
 512 
 513         mSearchMenuItem = menu.findItem(R.id.menu_search);
 514         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 515 
 516         if (!TextUtils.isEmpty(searchQuery)) {
 517             mSearchView.setQuery(searchQuery, false);
 518             mSearchMenuItem.expandActionView();
 519         } else {
 520             // Workaround for setting the search placeholder text color
 521             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 522                     getString(R.color.gray_light) :
 523                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 524             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 525                     hintHexColor,
 526                     getString(R.string.search))));
 527         }
 528 
 529         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 530             @Override
 531             public boolean onQueryTextChange(String newText) {
 532                 if (mSearchMenuItem.isActionViewExpanded()) {
 533                     getNoteListFragment().searchNotes(newText);
 534                 }
 535                 return true;
 536             }
 537 
 538             @Override
 539             public boolean onQueryTextSubmit(String queryText) {
 540                 getNoteListFragment().searchNotes(queryText);
 541                 return true;
 542             }
 543 
 544         });
 545 
 546         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 547             @Override
 548             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 549                 checkEmptyListText(true);
 550                 if (mNoteListFragment != null) {
 551                     mNoteListFragment.setFloatingActionButtonVisible(false);
 552                 }
 553                 AnalyticsTracker.track(
 554                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 555                         AnalyticsTracker.CATEGORY_NOTE,
 556                         &quot;action_bar_search_tap&quot;
 557                 );
 558                 return true;
 559             }
 560 
 561             @Override
 562             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 563                 // Show all notes again
 564                 if (mNoteListFragment != null) {
 565                     mNoteListFragment.setFloatingActionButtonVisible(true);
 566                 }
 567                 mTabletSearchQuery = &quot;&quot;;
 568                 mSearchView.setQuery(&quot;&quot;, false);
 569                 checkEmptyListText(false);
 570                 getNoteListFragment().clearSearch();
 571                 return true;
 572             }
 573         });
 574 
 575         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 576             @Override
 577             public boolean onMenuItemClick(MenuItem item) {
 578                 if (!mSearchMenuItem.isActionViewExpanded())
 579                     showDetailPlaceholder();
 580                 return false;
 581             }
 582         });
 583 
 584         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 585         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 586             trashItem.setTitle(R.string.undelete);
 587             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 588         } else {
 589             trashItem.setTitle(R.string.delete);
 590             trashItem.setIcon(R.drawable.ic_trash_24dp);
 591         }
 592 
 593         if (DisplayUtils.isLargeScreenLandscape(this)) {
 594             // Restore the search query on landscape tablets
 595             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 596                 mSearchMenuItem.expandActionView();
 597                 mSearchView.setQuery(mTabletSearchQuery, false);
 598                 mSearchView.clearFocus();
 599             }
 600 
 601             if (mCurrentNote != null) {
 602                 menu.findItem(R.id.menu_share).setVisible(true);
 603                 menu.findItem(R.id.menu_view_info).setVisible(true);
 604                 menu.findItem(R.id.menu_checklist).setVisible(true);
 605                 menu.findItem(R.id.menu_history).setVisible(true);
 606                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 607                 trashItem.setVisible(true);
 608             } else {
 609                 menu.findItem(R.id.menu_share).setVisible(false);
 610                 menu.findItem(R.id.menu_view_info).setVisible(false);
 611                 menu.findItem(R.id.menu_checklist).setVisible(false);
 612                 menu.findItem(R.id.menu_history).setVisible(false);
 613                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 614                 trashItem.setVisible(false);
 615             }
 616             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 617         } else {
 618             menu.findItem(R.id.menu_search).setVisible(true);
 619             menu.findItem(R.id.menu_share).setVisible(false);
 620             menu.findItem(R.id.menu_view_info).setVisible(false);
 621             menu.findItem(R.id.menu_checklist).setVisible(false);
 622             menu.findItem(R.id.menu_history).setVisible(false);
 623             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 624             trashItem.setVisible(false);
 625             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 626         }
 627 
 628         // Are we looking at the trash? Adjust menu accordingly.
 629         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 630             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 631             mEmptyTrashMenuItem.setVisible(true);
 632 
 633             updateTrashMenuItem();
 634 
 635             menu.findItem(R.id.menu_search).setVisible(false);
 636             menu.findItem(R.id.menu_share).setVisible(false);
 637             menu.findItem(R.id.menu_history).setVisible(false);
 638             menu.findItem(R.id.menu_checklist).setVisible(false);
 639         }
 640 
 641         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 642 
 643         return true;
 644     }
 645 
 646     @Override
 647     public boolean onOptionsItemSelected(MenuItem item) {
 648         if (mDrawerToggle.onOptionsItemSelected(item)) {
 649             return true;
 650         }
 651         switch (item.getItemId()) {
 652             case R.id.menu_markdown_preview:
 653                 if (mIsShowingMarkdown) {
 654                     item.setIcon(R.drawable.ic_preview_24dp);
 655                     item.setTitle(getString(R.string.markdown_show));
 656                     setMarkdownShowing(false);
 657                 } else {
 658                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 659                     item.setTitle(getString(R.string.markdown_hide));
 660                     setMarkdownShowing(true);
 661                 }
 662 
 663                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 664 
 665                 return true;
 666             case R.id.menu_delete:
 667                 if (mNoteEditorFragment != null) {
 668                     if (mCurrentNote != null) {
 669                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 670                         mCurrentNote.setModificationDate(Calendar.getInstance());
 671                         mCurrentNote.save();
 672 
 673                         updateViewsAfterTrashAction(mCurrentNote);
 674                     }
 675                 }
 676                 return true;
 677             case R.id.menu_empty_trash:
 678                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 679 
 680                 alert.setTitle(R.string.empty_trash);
 681                 alert.setMessage(R.string.confirm_empty_trash);
 682                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 683                     public void onClick(DialogInterface dialog, int whichButton) {
 684                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 685                         AnalyticsTracker.track(
 686                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 687                                 AnalyticsTracker.CATEGORY_NOTE,
 688                                 &quot;overflow_menu&quot;
 689                         );
 690                     }
 691                 });
 692                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 693                     public void onClick(DialogInterface dialog, int whichButton) {
 694                         // Do nothing, just closing the dialog
 695                     }
 696                 });
 697                 alert.show();
 698                 return true;
 699             case android.R.id.home:
 700                 invalidateOptionsMenu();
 701                 return true;
 702             default:
 703                 return super.onOptionsItemSelected(item);
 704         }
 705     }
 706 
 707     @Override
 708     public boolean onPrepareOptionsMenu(Menu menu) {
 709         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 710 
 711         if (mIsShowingMarkdown) {
 712             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 713             markdownItem.setTitle(getString(R.string.markdown_hide));
 714         } else {
 715             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 716             markdownItem.setTitle(getString(R.string.markdown_show));
 717         }
 718 
 719         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 720 
 721         return super.onPrepareOptionsMenu(menu);
 722     }
 723 
 724     public void updateViewsAfterTrashAction(Note note) {
 725         if (note == null || isFinishing()) {
 726             return;
 727         }
 728 
 729         if (note.isDeleted()) {
 730             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 731             deletedNoteIds.add(note.getSimperiumKey());
 732             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 733             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 734             AnalyticsTracker.track(
 735                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 736                     AnalyticsTracker.CATEGORY_NOTE,
 737                     &quot;overflow_menu&quot;
 738             );
 739         } else {
 740             AnalyticsTracker.track(
 741                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 742                     AnalyticsTracker.CATEGORY_NOTE,
 743                     &quot;overflow_menu&quot;
 744             );
 745         }
 746 
 747         // If we just deleted/restored the active note, show the placeholder
 748         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 749             showDetailPlaceholder();
 750         }
 751 
 752         NoteListFragment fragment = getNoteListFragment();
 753         if (fragment != null) {
 754             fragment.getPrefs();
 755             fragment.refreshList();
 756         }
 757 
 758         invalidateOptionsMenu();
 759     }
 760 
 761     public void setMarkdownShowing(boolean isMarkdownShowing) {
 762         mIsShowingMarkdown = isMarkdownShowing;
 763         if (mNoteEditorFragment != null) {
 764             if (isMarkdownShowing) {
 765                 mNoteEditorFragment.showMarkdown();
 766             } else {
 767                 mNoteEditorFragment.hideMarkdown();
 768             }
 769         }
 770         invalidateOptionsMenu();
 771     }
 772 
 773     /**
 774      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 775      * the item with the given ID was selected. Used for tablets only.
 776      */
 777     @Override
<abbr title=" 778     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 778     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 779         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 780             // Launch the editor activity
 781             Bundle arguments = new Bundle();
 782             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 783             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 784 
 785             if (matchOffsets != null)
 786                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 787 
 788             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 789             editNoteIntent.putExtras(arguments);
 790             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 791         } else {
 792             mNoteEditorFragment.setNote(noteID, matchOffsets);
 793             getNoteListFragment().setNoteSelected(noteID);
 794 
 795             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 796                 mTabletSearchQuery = mSearchView.getQuery().toString();
 797             }
 798 
 799             mNoteEditorFragment.clearMarkdown();
 800 
 801             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 802                 setMarkdownShowing(false);
 803             }
 804 
 805             invalidateOptionsMenu();
 806         }
 807 
 808         AnalyticsTracker.track(
 809                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 810                 AnalyticsTracker.CATEGORY_NOTE,
 811                 &quot;note_list_row_tap&quot;
 812         );
 813     }
 814 
 815     @Override
 816     public void onUserCreated(User user) {
 817         // New account created
 818         AnalyticsTracker.track(
 819                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 820                 AnalyticsTracker.CATEGORY_USER,
 821                 &quot;account_created_from_login_activity&quot;
 822         );
 823     }
 824 
 825     public void onUserStatusChange(User.Status status) {
 826         switch (status) {
 827             // successfully used access token to connect to simperium bucket
 828             case AUTHORIZED:
 829                 runOnUiThread(new Runnable() {
 830                     @Override
 831                     public void run() {
 832                         if (!mNotesBucket.hasChangeVersion()) {
 833                             setToolbarProgressVisibility(true);
 834                         }
 835                     }
 836                 });
 837                 break;
 838 
 839             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 840             case NOT_AUTHORIZED:
 841                 runOnUiThread(new Runnable() {
 842                     @Override
 843                     public void run() {
 844                         startLoginActivity(true);
 845                     }
 846                 });
 847                 break;
 848 
<abbr title=" 849             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 849             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 850             case UNKNOWN:
 851                 break;
 852         }
 853     }
 854 
 855     private void setToolbarProgressVisibility(boolean isVisible) {
 856         if (getSupportActionBar() != null) {
 857             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 858         }
 859     }
 860 
 861     public void startLoginActivity(boolean signInFirst) {
 862         // Clear some account-specific prefs
 863         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 864         editor.remove(PrefUtils.PREF_WP_TOKEN);
 865         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 866         editor.apply();
 867 
 868         Intent loginIntent = new Intent(this, SignInActivity.class);
 869         if (signInFirst) {
 870             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 871         }
 872         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 873     }
 874 
 875     @Override
 876     public void recreate() {
 877         Handler handler = new Handler();
 878         handler.post(new Runnable() {
 879             @Override
 880             public void run() {
 881                 NotesActivity.super.recreate();
 882             }
 883         });
 884     }
 885 
 886     @Override
 887     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 888         super.onActivityResult(requestCode, resultCode, data);
 889         switch (requestCode) {
 890             case Simplenote.INTENT_PREFERENCES:
 891                 if (ThemeUtils.themeWasChanged(data)) {
 892                     // Restart this activity to apply the new theme
 893                     recreate();
 894                     break;
 895                 }
<abbr title=" 896                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 896                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 897                 invalidateOptionsMenu();
 898                 NoteListFragment fragment = getNoteListFragment();
 899                 if (fragment != null) {
 900                     fragment.getPrefs();
 901                     fragment.refreshList();
 902                 }
 903 
 904                 break;
 905             case Simplenote.INTENT_EDIT_NOTE:
 906                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 907                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 908                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 909                         if (noteId != null) {
 910                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 911                             deletedNoteIds.add(noteId);
 912                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 913                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 913                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 914                         }
<abbr title=" 915                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 915                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 916                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 917                         mNoteListFragment.setNoteSelected(selectedNoteId);
 918                         if (mNoteEditorFragment != null) {
 919                             mNoteEditorFragment.setNote(selectedNoteId);
 920                         }
 921                     }
 922                 }
 923                 break;
 924             case Simperium.SIGNUP_SIGNIN_REQUEST:
 925                 invalidateOptionsMenu();
 926 
 927                 Simplenote app = (Simplenote) getApplication();
 928                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 929 
 930                 AnalyticsTracker.track(
 931                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 932                         AnalyticsTracker.CATEGORY_USER,
 933                         &quot;signed_in_from_login_activity&quot;
 934                 );
 935 
 936                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 937                     finish();
 938                 }
 939 
 940                 break;
 941         }
 942     }
 943 
 944     @Override
 945     public void onUndo() {
 946         if (mUndoBarController == null) return;
 947 
 948         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 949         if (deletedNoteIds != null) {
 950             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 951                 Note deletedNote;
 952                 try {
 953                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 954                 } catch (BucketObjectMissingException e) {
 955                     return;
 956                 }
 957                 if (deletedNote != null) {
 958                     deletedNote.setDeleted(false);
 959                     deletedNote.setModificationDate(Calendar.getInstance());
 960                     deletedNote.save();
 961                     NoteListFragment fragment = getNoteListFragment();
 962                     if (fragment != null) {
 963                         fragment.getPrefs();
 964                         fragment.refreshList();
 965                     }
 966                 }
 967             }
 968         }
 969     }
 970 
 971     @Override
 972     protected void onPostCreate(Bundle savedInstanceState) {
 973         super.onPostCreate(savedInstanceState);
 974         // Sync the toggle state after onRestoreInstanceState has occurred.
 975         mDrawerToggle.syncState();
 976     }
 977 
 978     @Override
 979     public void onConfigurationChanged(Configuration newConfig) {
 980         super.onConfigurationChanged(newConfig);
 981 
 982         mDrawerToggle.onConfigurationChanged(newConfig);
 983 
 984         if (DisplayUtils.isLargeScreen(this)) {
 985             mIsShowingMarkdown = false;
 986 
 987             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 988                 // Add the editor fragment
 989                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 990                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 990                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 991                 } else if (DisplayUtils.isLandscape(this)) {
 992                     addEditorFragment();
 993                 }
 994                 if (mNoteListFragment != null) {
 995                     mNoteListFragment.setActivateOnItemClick(true);
 996                     mNoteListFragment.setDividerVisible(true);
 997                 }
 998                 // Select the current note on a tablet
 999                 if (mCurrentNote != null)
<abbr title="1000                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());">1000                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
1001                 else {
1002                     mNoteEditorFragment.setPlaceholderVisible(true);
1003                     mNoteListFragment.getListView().clearChoices();
1004                 }
1005                 invalidateOptionsMenu();
1006             }
1007         }
1008 
1009         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1010             // Remove the editor fragment when rotating back to portrait
1011             mCurrentNote = null;
1012             if (mNoteListFragment != null) {
1013                 mNoteListFragment.setActivateOnItemClick(false);
1014                 mNoteListFragment.setDividerVisible(false);
1015                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1016                 mNoteListFragment.refreshList();
1017             }
1018             FragmentManager fm = getSupportFragmentManager();
1019             FragmentTransaction ft = fm.beginTransaction();
1020             ft.remove(mNoteEditorFragment);
1021             mNoteEditorFragment = null;
1022             ft.commitAllowingStateLoss();
1023             fm.executePendingTransactions();
1024             invalidateOptionsMenu();
1025         }
1026     }
1027 
1028     public void checkEmptyListText(boolean isSearch) {
1029         if (isSearch) {
<abbr title="1030             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1030             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1031             getNoteListFragment().setEmptyListViewClickable(false);
1032         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1033             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1033             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1034             AnalyticsTracker.track(
1035                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1036                     AnalyticsTracker.CATEGORY_NOTE,
1037                     &quot;trash_filter_selected&quot;
1038             );
1039             getNoteListFragment().setEmptyListViewClickable(false);
1040         } else {
<abbr title="1041             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1041             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1042             getNoteListFragment().setEmptyListViewClickable(true);
1043         }
1044     }
1045 
1046     public void showDetailPlaceholder() {
1047         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1048             mCurrentNote = null;
1049             mNoteEditorFragment.setPlaceholderVisible(true);
1050             mNoteEditorFragment.clearMarkdown();
1051             mNoteEditorFragment.hideMarkdown();
1052             mIsShowingMarkdown = false;
1053         }
1054     }
1055 
1056     public void stopListeningToNotesBucket() {
1057         mNotesBucket.removeOnNetworkChangeListener(this);
1058         mNotesBucket.removeOnSaveObjectListener(this);
1059         mNotesBucket.removeOnDeleteObjectListener(this);
1060     }
1061 
1062     // Returns the appropriate view to show the undo bar within
1063     private View getUndoView() {
1064         View undoView = mFragmentsContainer;
1065         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1066                 getNoteListFragment() != null &amp;&amp;
1067                 getNoteListFragment().getRootView() != null) {
1068             undoView = getNoteListFragment().getRootView();
1069         }
1070 
1071         return undoView;
1072     }
1073 
1074     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1075         if (mUndoBarController != null) {
1076             mUndoBarController.setDeletedNoteIds(noteIds);
1077             mUndoBarController.showUndoBar(
1078                     getUndoView(),
<abbr title="1079                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1079                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1080             );
1081         }
1082     }
1083 
1084     /* Simperium Bucket Listeners */
1085     // received a change from the network, refresh the list
1086     @Override
1087     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1088         runOnUiThread(new Runnable() {
1089             @Override
1090             public void run() {
1091                 if (type == Bucket.ChangeType.INDEX) {
1092                     setToolbarProgressVisibility(false);
1093                 }
1094                 mNoteListFragment.refreshList();
1095             }
1096         });
1097     }
1098 
1099     @Override
1100     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1101         runOnUiThread(new Runnable() {
1102             @Override
1103             public void run() {
1104                 mNoteListFragment.refreshList();
1105             }
1106         });
1107     }
1108 
1109     @Override
1110     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1111         runOnUiThread(new Runnable() {
1112             @Override
1113             public void run() {
1114                 mNoteListFragment.refreshList();
1115             }
1116         });
1117     }
1118 
1119     @Override
1120     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1121         // noop, NoteEditorFragment will handle this
1122     }
1123 
1124     /* The click listener for ListView in the navigation drawer */
1125     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1126         @Override
1127         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1128 
1129             // Adjust for header view
1130             position -= mDrawerList.getHeaderViewsCount();
1131             mSelectedTag = mTagsAdapter.getItem(position);
1132             checkEmptyListText(false);
1133             // Update checked item in navigation drawer and close it
1134             setSelectedTagActive();
1135             mDrawerLayout.closeDrawer(mNavigationView);
1136             updateNavigationDrawerItems();
1137 
1138             // Disable long press on notes if we&#x27;re viewing the trash
1139             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1140                 getNoteListFragment().getListView().setLongClickable(false);
1141             } else {
1142                 getNoteListFragment().getListView().setLongClickable(true);
1143             }
1144 
1145             getNoteListFragment().refreshListFromNavSelect();
1146             if (position &gt; 1) {
1147                 AnalyticsTracker.track(
1148                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1149                         AnalyticsTracker.CATEGORY_TAG,
1150                         &quot;selected_tag_in_navigation_drawer&quot;
1151                 );
1152             }
1153         }
1154     }
1155 
1156     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1157 
1158         @Override
1159         protected Void doInBackground(Void... voids) {
1160             if (mNotesBucket == null) return null;
1161 
1162             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1163             Bucket.ObjectCursor c = query.execute();
1164             while (c.moveToNext()) {
1165                 c.getObject().delete();
1166             }
1167 
1168             return null;
1169         }
1170 
1171         @Override
1172         protected void onPostExecute(Void nada) {
1173             showDetailPlaceholder();
1174         }
1175     }
1176 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.view.GravityCompat;
  17 import android.support.v4.widget.DrawerLayout;
  18 import android.support.v7.app.ActionBar;
  19 import android.support.v7.app.ActionBarDrawerToggle;
  20 import android.support.v7.app.AppCompatActivity;
  21 import android.support.v7.preference.PreferenceManager;
  22 import android.support.v7.widget.SearchView;
  23 import android.support.v7.widget.Toolbar;
  24 import android.text.Spannable;
  25 import android.text.SpannableString;
  26 import android.text.TextUtils;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.WindowInsets;
  32 import android.widget.AdapterView;
  33 import android.widget.LinearLayout;
  34 import android.widget.ListView;
  35 import android.widget.ProgressBar;
  36 
  37 import com.automattic.simplenote.analytics.AnalyticsTracker;
  38 import com.automattic.simplenote.models.Note;
  39 import com.automattic.simplenote.models.Tag;
  40 import com.automattic.simplenote.utils.DisplayUtils;
  41 import com.automattic.simplenote.utils.DrawableUtils;
  42 import com.automattic.simplenote.utils.HtmlCompat;
  43 import com.automattic.simplenote.utils.PrefUtils;
  44 import com.automattic.simplenote.utils.StrUtils;
  45 import com.automattic.simplenote.utils.TagsAdapter;
  46 import com.automattic.simplenote.utils.ThemeUtils;
  47 import com.automattic.simplenote.utils.UndoBarController;
  48 import com.automattic.simplenote.widgets.TypefaceSpan;
  49 import com.simperium.Simperium;
  50 import com.simperium.client.Bucket;
  51 import com.simperium.client.BucketObjectMissingException;
  52 import com.simperium.client.BucketObjectNameInvalid;
  53 import com.simperium.client.Query;
  54 import com.simperium.client.User;
  55 
  56 import org.wordpress.passcodelock.AppLockManager;
  57 
  58 import java.util.ArrayList;
  59 import java.util.Calendar;
  60 import java.util.List;
  61 
  62 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  63 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  64 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 
  67 public class NotesActivity extends AppCompatActivity implements
<abbr title="  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  69         Bucket.Listener&lt;Note&gt; {
  70 
  71     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74     protected Bucket&lt;Tag&gt; mTagsBucket;
  75     private int TRASH_SELECTED_ID = 1;
  76     private boolean mIsShowingMarkdown;
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80     private UndoBarController mUndoBarController;
  81     private View mFragmentsContainer;
  82     private SearchView mSearchView;
  83     private MenuItem mSearchMenuItem;
  84     private NoteListFragment mNoteListFragment;
  85     private NoteEditorFragment mNoteEditorFragment;
  86     private Note mCurrentNote;
  87     private MenuItem mEmptyTrashMenuItem;
  88 
  89     // Menu drawer
  90     private DrawerLayout mDrawerLayout;
  91     private ListView mDrawerList;
  92     private NavigationView mNavigationView;
  93     private ActionBarDrawerToggle mDrawerToggle;
  94     private TagsAdapter mTagsAdapter;
  95     private TagsAdapter.TagMenuItem mSelectedTag;
  96     // Tags bucket listener
  97     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  98         void updateNavigationDrawer() {
  99             runOnUiThread(new Runnable() {
 100                 public void run() {
 101                     updateNavigationDrawerItems();
 102                 }
 103             });
 104         }
 105 
 106         @Override
 107         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 108             updateNavigationDrawer();
 109         }
 110 
 111         @Override
 112         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 113             updateNavigationDrawer();
 114         }
 115 
 116         @Override
 117         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 118             updateNavigationDrawer();
 119         }
 120 
 121         @Override
 122         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 123             // noop
 124         }
 125     };
 126 
 127     @Override
 128     protected void onCreate(Bundle savedInstanceState) {
 129 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132 </span>
 133 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         // On lollipop, configure the translucent status bar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
 137 =======
 138 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 139         ThemeUtils.setTheme(this);
 140         super.onCreate(savedInstanceState);
 141 
 142         setContentView(R.layout.activity_notes);
 143 
 144         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 145 
 146         Simplenote currentApp = (Simplenote) getApplication();
 147         if (mNotesBucket == null) {
 148             mNotesBucket = currentApp.getNotesBucket();
 149         }
 150 
 151         if (mTagsBucket == null) {
 152             mTagsBucket = currentApp.getTagsBucket();
 153         }
 154 
 155         Toolbar toolbar = findViewById(R.id.toolbar);
 156         setSupportActionBar(toolbar);
 157         configureNavigationDrawer(toolbar);
 158 
 159         if (savedInstanceState == null) {
 160             mNoteListFragment = new NoteListFragment();
 161             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 162             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 163             fragmentTransaction.commit();
 164         } else {
<abbr title=" 165             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 165             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 166         }
 167 
 168         if (DisplayUtils.isLargeScreen(this)) {
 169             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 170                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 171             } else if (DisplayUtils.isLandscape(this)) {
 172                 addEditorFragment();
 173             }
 174         }
 175 
 176         // enable ActionBar app icon to behave as action to toggle nav drawer
 177         ActionBar actionBar = getSupportActionBar();
 178         if (actionBar != null) {
 179             actionBar.setDisplayHomeAsUpEnabled(true);
 180             actionBar.setHomeButtonEnabled(true);
 181 
 182             // Add loading indicator to show when indexing
<abbr title=" 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 183             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 184             actionBar.setDisplayShowCustomEnabled(true);
 185             actionBar.setCustomView(progressBar);
 186             setToolbarProgressVisibility(false);
 187         }
 188 
 189         mUndoBarController = new UndoBarController(this);
 190 
 191         // Creates &#x27;Welcome&#x27; note
 192         checkForFirstLaunch();
 193 
 194         checkForSharedContent();
 195 
 196         currentApp.getSimperium().setOnUserCreatedListener(this);
 197         currentApp.getSimperium().setUserStatusChangeListener(this);
 198     }
 199 
 200     @Override
 201     protected void onResume() {
 202         super.onResume();
 203 
 204         // Ensure user has valid authorization
 205         if (userAuthenticationIsInvalid()) {
 206             startLoginActivity(true);
 207             Intent intent = getIntent();
 208 
 209             if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;
 210                 intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {
 211                 AnalyticsTracker.track(
 212                     NOTE_WIDGET_SIGN_IN_TAPPED,
 213                     CATEGORY_WIDGET,
 214                     &quot;note_widget_sign_in_tapped&quot;
 215                 );
 216             }
 217         }
 218 
 219         disableScreenshotsIfLocked(this);
 220 
 221         mNotesBucket.start();
 222         mTagsBucket.start();
 223 
 224         mNotesBucket.addOnNetworkChangeListener(this);
 225         mNotesBucket.addOnSaveObjectListener(this);
 226         mNotesBucket.addOnDeleteObjectListener(this);
 227         mTagsBucket.addListener(mTagsMenuUpdater);
 228 
 229         updateNavigationDrawerItems();
 230 
 231         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 232         if (userIsUnauthorized()) {
 233             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 234                 mSelectedTag = null;
 235                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 236             }
 237         }
 238 
 239         setSelectedTagActive();
 240 
 241         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 242             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 243             mShouldSelectNewNote = false;
 244         }
 245 
 246         if (mIsShowingMarkdown) {
 247             setMarkdownShowing(false);
 248         }
 249 
 250     }
 251 
 252     @Override
 253     protected void onPause() {
 254         super.onPause();  // Always call the superclass method first
 255         mTagsBucket.removeListener(mTagsMenuUpdater);
 256         mTagsBucket.stop();
 257 
 258         mNotesBucket.removeOnNetworkChangeListener(this);
 259         mNotesBucket.removeOnSaveObjectListener(this);
 260         mNotesBucket.removeOnDeleteObjectListener(this);
 261         mNotesBucket.stop();
 262     }
 263 
 264     @Override
 265     public void setTitle(CharSequence title) {
 266         if (title == null) {
 267             title = &quot;&quot;;
 268         }
 269 
 270         setTitleWithCustomFont(title);
 271     }
 272 
 273     @Override
 274     public void onBackPressed() {
 275         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 276             mDrawerLayout.closeDrawer(GravityCompat.START);
 277         } else {
 278             super.onBackPressed();
 279         }
 280     }
 281 
 282     private void setTitleWithCustomFont(CharSequence title) {
 283         if (getSupportActionBar() == null) {
 284             return;
 285         }
 286 
 287         SpannableString s = new SpannableString(title);
 288         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 289         getSupportActionBar().setTitle(s);
 290     }
 291 
 292     private void configureNavigationDrawer(Toolbar toolbar) {
 293         mDrawerLayout = findViewById(R.id.drawer_layout);
 294         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 295         mNavigationView = findViewById(R.id.navigation_view);
 296         mDrawerList = findViewById(R.id.drawer_list);
 297 
 298         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 299             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 300                 @Override
 301                 @SuppressLint(&quot;NewApi&quot;)
 302                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 303                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 304                     drawerView.setPadding(
 305                             drawerView.getPaddingLeft(),
 306                             windowInsets.getSystemWindowInsetTop(),
 307                             drawerView.getPaddingRight(),
 308                             drawerView.getPaddingBottom());
 309 
 310                     return windowInsets.consumeSystemWindowInsets();
 311                 }
 312             });
 313         }
 314 
 315         View settingsButton = findViewById(R.id.nav_settings);
 316         settingsButton.setOnClickListener(new View.OnClickListener() {
 317             @Override
 318             public void onClick(View v) {
 319                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 320                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 321             }
 322         });
 323 
 324         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 325         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 326         mDrawerList.setAdapter(mTagsAdapter);
 327         // Set the list&#x27;s click listener
 328         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 329 
 330         if (mSelectedTag == null)
 331             mSelectedTag = mTagsAdapter.getDefaultItem();
 332 
 333         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 334                 R.string.close_drawer) {
 335             public void onDrawerClosed(View view) {
 336                 supportInvalidateOptionsMenu();
 337             }
 338 
 339             public void onDrawerOpened(View drawerView) {
 340                 // noop
 341             }
 342 
 343             @Override
 344             public void onDrawerSlide(View drawerView, float slideOffset) {
 345                 super.onDrawerSlide(drawerView, 0f);
 346             }
 347         };
 348 
 349         mDrawerLayout.addDrawerListener(mDrawerToggle);
 350     }
 351 
 352     private void checkForFirstLaunch() {
 353         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 354             // Create the welcome note
 355             try {
 356                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 357                 welcomeNote.setCreationDate(Calendar.getInstance());
 358                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 359                 welcomeNote.setContent(getString(R.string.welcome_note));
 360                 welcomeNote.getTitle();
 361                 welcomeNote.save();
 362             } catch (BucketObjectNameInvalid e) {
 363                 // this won&#x27;t happen because welcome-android is a valid name
 364             }
 365 
 366             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 367             SharedPreferences.Editor editor = preferences.edit();
 368             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 369             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 370             editor.apply();
 371         }
 372     }
 373 
 374     private void checkForSharedContent() {
 375         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 376             // Check share action
 377             Intent intent = getIntent();
 378             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 379             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 380 
<abbr title=" 381             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 381             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 382             String intentAction = StrUtils.notNullStr(intent.getAction());
 383             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 384             if (!TextUtils.isEmpty(text)) {
 385                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 386                     text = subject + &quot;\n\n&quot; + text;
 387                 }
 388                 Note note = mNotesBucket.newObject();
 389                 note.setCreationDate(Calendar.getInstance());
 390                 note.setModificationDate(note.getCreationDate());
 391                 note.setContent(text);
 392                 note.save();
 393                 setCurrentNote(note);
 394                 mShouldSelectNewNote = true;
 395 
 396                 AnalyticsTracker.track(
 397                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 398                         AnalyticsTracker.CATEGORY_NOTE,
 399                         &quot;external_share&quot;
 400                 );
 401 
 402                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 403                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 404                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 405                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 406                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 407                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 408                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 409                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 410                     }
 411                 }
 412             }
 413         }
 414     }
 415 
 416     private void updateNavigationDrawerItems() {
 417         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 418         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 419         if (isAlphaSort) {
 420             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 421         } else {
 422             tagCursor = Tag.allWithName(mTagsBucket).execute();
 423         }
 424 
 425         mTagsAdapter.changeCursor(tagCursor);
 426     }
 427 
 428     private void setSelectedTagActive() {
 429         if (mSelectedTag == null)
 430             mSelectedTag = mTagsAdapter.getDefaultItem();
 431 
 432         setTitle(mSelectedTag.name);
<abbr title=" 433         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 433         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 434     }
 435 
 436     public TagsAdapter.TagMenuItem getSelectedTag() {
 437         if (mSelectedTag == null) {
 438             mSelectedTag = mTagsAdapter.getDefaultItem();
 439         }
 440 
 441         return mSelectedTag;
 442     }
 443 
 444     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 445     public void updateTrashMenuItem() {
 446         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 447             return;
 448 
 449         // Disable the trash icon if there are no notes trashed.
 450         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 451         if (query.count() == 0) {
 452             mEmptyTrashMenuItem.setEnabled(false);
 453         } else {
 454             mEmptyTrashMenuItem.setEnabled(true);
 455         }
 456     }
 457 
 458     private void addEditorFragment() {
 459         FragmentManager fm = getSupportFragmentManager();
 460         FragmentTransaction ft = fm.beginTransaction();
 461         mNoteEditorFragment = new NoteEditorFragment();
 462         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 463         ft.commitAllowingStateLoss();
 464         fm.executePendingTransactions();
 465     }
 466 
 467     private boolean userAccountRequired() {
 468         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 469     }
 470 
 471     /**
 472      * Checks for a previously valid user that is now not authenticated
 473      * Also checks if user account is required (added in version 1.5.6)
 474      *
 475      * @return true if user has invalid authorization
 476      */
 477     private boolean userAuthenticationIsInvalid() {
 478         Simplenote currentApp = (Simplenote) getApplication();
 479         Simperium simperium = currentApp.getSimperium();
 480         User user = simperium.getUser();
 481         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 482         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 483                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 484     }
 485 
 486     public boolean userIsUnauthorized() {
 487         Simplenote currentApp = (Simplenote) getApplication();
 488         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 489     }
 490 
 491     public void setCurrentNote(Note note) {
 492         mCurrentNote = note;
 493     }
 494 
 495     public NoteListFragment getNoteListFragment() {
 496         return mNoteListFragment;
 497     }
 498 
 499     @SuppressWarnings(&quot;ResourceType&quot;)
 500     @Override
 501     public boolean onCreateOptionsMenu(Menu menu) {
 502         super.onCreateOptionsMenu(menu);
 503         MenuInflater inflater = getMenuInflater();
 504         inflater.inflate(R.menu.notes_list, menu);
 505 
 506         // restore the search query if on a landscape tablet
 507         String searchQuery = null;
 508         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 509             searchQuery = mSearchView.getQuery().toString();
 510 
 511         mSearchMenuItem = menu.findItem(R.id.menu_search);
 512         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 513 
 514         if (!TextUtils.isEmpty(searchQuery)) {
 515             mSearchView.setQuery(searchQuery, false);
 516             mSearchMenuItem.expandActionView();
 517         } else {
 518             // Workaround for setting the search placeholder text color
 519             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 520                     getString(R.color.gray_light) :
 521                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 522             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 523                     hintHexColor,
 524                     getString(R.string.search))));
 525         }
 526 
 527         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 528             @Override
 529             public boolean onQueryTextChange(String newText) {
 530                 if (mSearchMenuItem.isActionViewExpanded()) {
 531                     getNoteListFragment().searchNotes(newText);
 532                 }
 533                 return true;
 534             }
 535 
 536             @Override
 537             public boolean onQueryTextSubmit(String queryText) {
 538                 getNoteListFragment().searchNotes(queryText);
 539                 return true;
 540             }
 541 
 542         });
 543 
 544         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 545             @Override
 546             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 547                 checkEmptyListText(true);
 548                 if (mNoteListFragment != null) {
 549                     mNoteListFragment.setFloatingActionButtonVisible(false);
 550                 }
 551                 AnalyticsTracker.track(
 552                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 553                         AnalyticsTracker.CATEGORY_NOTE,
 554                         &quot;action_bar_search_tap&quot;
 555                 );
 556                 return true;
 557             }
 558 
 559             @Override
 560             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 561                 // Show all notes again
 562                 if (mNoteListFragment != null) {
 563                     mNoteListFragment.setFloatingActionButtonVisible(true);
 564                 }
 565                 mTabletSearchQuery = &quot;&quot;;
 566                 mSearchView.setQuery(&quot;&quot;, false);
 567                 checkEmptyListText(false);
 568                 getNoteListFragment().clearSearch();
 569                 return true;
 570             }
 571         });
 572 
 573         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 574             @Override
 575             public boolean onMenuItemClick(MenuItem item) {
 576                 if (!mSearchMenuItem.isActionViewExpanded())
 577                     showDetailPlaceholder();
 578                 return false;
 579             }
 580         });
 581 
 582         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 583         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 584             trashItem.setTitle(R.string.undelete);
 585             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 586         } else {
 587             trashItem.setTitle(R.string.delete);
 588             trashItem.setIcon(R.drawable.ic_trash_24dp);
 589         }
 590 
 591         if (DisplayUtils.isLargeScreenLandscape(this)) {
 592             // Restore the search query on landscape tablets
 593             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 594                 mSearchMenuItem.expandActionView();
 595                 mSearchView.setQuery(mTabletSearchQuery, false);
 596                 mSearchView.clearFocus();
 597             }
 598 
 599             if (mCurrentNote != null) {
 600                 menu.findItem(R.id.menu_share).setVisible(true);
 601                 menu.findItem(R.id.menu_view_info).setVisible(true);
 602                 menu.findItem(R.id.menu_checklist).setVisible(true);
 603                 menu.findItem(R.id.menu_history).setVisible(true);
 604                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 605                 trashItem.setVisible(true);
 606             } else {
 607                 menu.findItem(R.id.menu_share).setVisible(false);
 608                 menu.findItem(R.id.menu_view_info).setVisible(false);
 609                 menu.findItem(R.id.menu_checklist).setVisible(false);
 610                 menu.findItem(R.id.menu_history).setVisible(false);
 611                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 612                 trashItem.setVisible(false);
 613             }
 614             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 615         } else {
 616             menu.findItem(R.id.menu_search).setVisible(true);
 617             menu.findItem(R.id.menu_share).setVisible(false);
 618             menu.findItem(R.id.menu_view_info).setVisible(false);
 619             menu.findItem(R.id.menu_checklist).setVisible(false);
 620             menu.findItem(R.id.menu_history).setVisible(false);
 621             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 622             trashItem.setVisible(false);
 623             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 624         }
 625 
 626         // Are we looking at the trash? Adjust menu accordingly.
 627         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 628             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 629             mEmptyTrashMenuItem.setVisible(true);
 630 
 631             updateTrashMenuItem();
 632 
 633             menu.findItem(R.id.menu_search).setVisible(false);
 634             menu.findItem(R.id.menu_share).setVisible(false);
 635             menu.findItem(R.id.menu_history).setVisible(false);
 636             menu.findItem(R.id.menu_checklist).setVisible(false);
 637         }
 638 
 639         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 640 
 641         return true;
 642     }
 643 
 644     @Override
 645     public boolean onOptionsItemSelected(MenuItem item) {
 646         if (mDrawerToggle.onOptionsItemSelected(item)) {
 647             return true;
 648         }
 649         switch (item.getItemId()) {
 650             case R.id.menu_markdown_preview:
 651                 if (mIsShowingMarkdown) {
 652                     item.setIcon(R.drawable.ic_preview_24dp);
 653                     item.setTitle(getString(R.string.markdown_show));
 654                     setMarkdownShowing(false);
 655                 } else {
 656                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 657                     item.setTitle(getString(R.string.markdown_hide));
 658                     setMarkdownShowing(true);
 659                 }
 660 
 661                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 662 
 663                 return true;
 664             case R.id.menu_delete:
 665                 if (mNoteEditorFragment != null) {
 666                     if (mCurrentNote != null) {
 667                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 668                         mCurrentNote.setModificationDate(Calendar.getInstance());
 669                         mCurrentNote.save();
 670 
 671                         updateViewsAfterTrashAction(mCurrentNote);
 672                     }
 673                 }
 674                 return true;
 675             case R.id.menu_empty_trash:
 676                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 677 
 678                 alert.setTitle(R.string.empty_trash);
 679                 alert.setMessage(R.string.confirm_empty_trash);
 680                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 681                     public void onClick(DialogInterface dialog, int whichButton) {
 682                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 683                         AnalyticsTracker.track(
 684                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 685                                 AnalyticsTracker.CATEGORY_NOTE,
 686                                 &quot;overflow_menu&quot;
 687                         );
 688                     }
 689                 });
 690                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 691                     public void onClick(DialogInterface dialog, int whichButton) {
 692                         // Do nothing, just closing the dialog
 693                     }
 694                 });
 695                 alert.show();
 696                 return true;
 697             case android.R.id.home:
 698                 invalidateOptionsMenu();
 699                 return true;
 700             default:
 701                 return super.onOptionsItemSelected(item);
 702         }
 703     }
 704 
 705     @Override
 706     public boolean onPrepareOptionsMenu(Menu menu) {
 707         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 708 
 709         if (mIsShowingMarkdown) {
 710             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 711             markdownItem.setTitle(getString(R.string.markdown_hide));
 712         } else {
 713             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 714             markdownItem.setTitle(getString(R.string.markdown_show));
 715         }
 716 
 717         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 718 
 719         return super.onPrepareOptionsMenu(menu);
 720     }
 721 
 722     public void updateViewsAfterTrashAction(Note note) {
 723         if (note == null || isFinishing()) {
 724             return;
 725         }
 726 
 727         if (note.isDeleted()) {
 728             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 729             deletedNoteIds.add(note.getSimperiumKey());
 730             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 731             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 732             AnalyticsTracker.track(
 733                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 734                     AnalyticsTracker.CATEGORY_NOTE,
 735                     &quot;overflow_menu&quot;
 736             );
 737         } else {
 738             AnalyticsTracker.track(
 739                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 740                     AnalyticsTracker.CATEGORY_NOTE,
 741                     &quot;overflow_menu&quot;
 742             );
 743         }
 744 
 745         // If we just deleted/restored the active note, show the placeholder
 746         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 747             showDetailPlaceholder();
 748         }
 749 
 750         NoteListFragment fragment = getNoteListFragment();
 751         if (fragment != null) {
 752             fragment.getPrefs();
 753             fragment.refreshList();
 754         }
 755 
 756         invalidateOptionsMenu();
 757     }
 758 
 759     public void setMarkdownShowing(boolean isMarkdownShowing) {
 760         mIsShowingMarkdown = isMarkdownShowing;
 761         if (mNoteEditorFragment != null) {
 762             if (isMarkdownShowing) {
 763                 mNoteEditorFragment.showMarkdown();
 764             } else {
 765                 mNoteEditorFragment.hideMarkdown();
 766             }
 767         }
 768         invalidateOptionsMenu();
 769     }
 770 
 771     /**
 772      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 773      * the item with the given ID was selected. Used for tablets only.
 774      */
 775     @Override
<abbr title=" 776     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 776     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 777         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 778             // Launch the editor activity
 779             Bundle arguments = new Bundle();
 780             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 781             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 782 
 783             if (matchOffsets != null)
 784                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 785 
 786             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 787             editNoteIntent.putExtras(arguments);
 788             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 789         } else {
 790             mNoteEditorFragment.setNote(noteID, matchOffsets);
 791             getNoteListFragment().setNoteSelected(noteID);
 792 
 793             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 794                 mTabletSearchQuery = mSearchView.getQuery().toString();
 795             }
 796 
 797             mNoteEditorFragment.clearMarkdown();
 798 
 799             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 800                 setMarkdownShowing(false);
 801             }
 802 
 803             invalidateOptionsMenu();
 804         }
 805 
 806         AnalyticsTracker.track(
 807                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 808                 AnalyticsTracker.CATEGORY_NOTE,
 809                 &quot;note_list_row_tap&quot;
 810         );
 811     }
 812 
 813     @Override
 814     public void onUserCreated(User user) {
 815         // New account created
 816         AnalyticsTracker.track(
 817                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 818                 AnalyticsTracker.CATEGORY_USER,
 819                 &quot;account_created_from_login_activity&quot;
 820         );
 821     }
 822 
 823     public void onUserStatusChange(User.Status status) {
 824         switch (status) {
 825             // successfully used access token to connect to simperium bucket
 826             case AUTHORIZED:
 827                 runOnUiThread(new Runnable() {
 828                     @Override
 829                     public void run() {
 830                         if (!mNotesBucket.hasChangeVersion()) {
 831                             setToolbarProgressVisibility(true);
 832                         }
 833                     }
 834                 });
 835                 break;
 836 
 837             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 838             case NOT_AUTHORIZED:
 839                 runOnUiThread(new Runnable() {
 840                     @Override
 841                     public void run() {
 842                         startLoginActivity(true);
 843                     }
 844                 });
 845                 break;
 846 
<abbr title=" 847             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 847             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 848             case UNKNOWN:
 849                 break;
 850         }
 851     }
 852 
 853     private void setToolbarProgressVisibility(boolean isVisible) {
 854         if (getSupportActionBar() != null) {
 855             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 856         }
 857     }
 858 
 859     public void startLoginActivity(boolean signInFirst) {
 860         // Clear some account-specific prefs
 861         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 862         editor.remove(PrefUtils.PREF_WP_TOKEN);
 863         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 864         editor.apply();
 865 
 866         Intent loginIntent = new Intent(this, SignInActivity.class);
 867         if (signInFirst) {
 868             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 869         }
 870         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 871     }
 872 
 873     @Override
 874     public void recreate() {
 875         Handler handler = new Handler();
 876         handler.post(new Runnable() {
 877             @Override
 878             public void run() {
 879                 NotesActivity.super.recreate();
 880             }
 881         });
 882     }
 883 
 884     @Override
 885     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 886         super.onActivityResult(requestCode, resultCode, data);
 887         switch (requestCode) {
 888             case Simplenote.INTENT_PREFERENCES:
 889                 if (ThemeUtils.themeWasChanged(data)) {
 890                     // Restart this activity to apply the new theme
 891                     recreate();
 892                     break;
 893                 }
<abbr title=" 894                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 894                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 895                 invalidateOptionsMenu();
 896                 NoteListFragment fragment = getNoteListFragment();
 897                 if (fragment != null) {
 898                     fragment.getPrefs();
 899                     fragment.refreshList();
 900                 }
 901 
 902                 break;
 903             case Simplenote.INTENT_EDIT_NOTE:
 904                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 905                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 906                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 907                         if (noteId != null) {
 908                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 909                             deletedNoteIds.add(noteId);
 910                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 911                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 911                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 912                         }
<abbr title=" 913                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 913                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 914                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 915                         mNoteListFragment.setNoteSelected(selectedNoteId);
 916                         if (mNoteEditorFragment != null) {
 917                             mNoteEditorFragment.setNote(selectedNoteId);
 918                         }
 919                     }
 920                 }
 921                 break;
 922             case Simperium.SIGNUP_SIGNIN_REQUEST:
 923                 invalidateOptionsMenu();
 924 
 925                 Simplenote app = (Simplenote) getApplication();
 926                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 927 
 928                 AnalyticsTracker.track(
 929                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 930                         AnalyticsTracker.CATEGORY_USER,
 931                         &quot;signed_in_from_login_activity&quot;
 932                 );
 933 
 934                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 935                     finish();
 936                 }
 937 
 938                 break;
 939         }
 940     }
 941 
 942     @Override
 943     public void onUndo() {
 944         if (mUndoBarController == null) return;
 945 
 946         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 947         if (deletedNoteIds != null) {
 948             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 949                 Note deletedNote;
 950                 try {
 951                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 952                 } catch (BucketObjectMissingException e) {
 953                     return;
 954                 }
 955                 if (deletedNote != null) {
 956                     deletedNote.setDeleted(false);
 957                     deletedNote.setModificationDate(Calendar.getInstance());
 958                     deletedNote.save();
 959                     NoteListFragment fragment = getNoteListFragment();
 960                     if (fragment != null) {
 961                         fragment.getPrefs();
 962                         fragment.refreshList();
 963                     }
 964                 }
 965             }
 966         }
 967     }
 968 
 969     @Override
 970     protected void onPostCreate(Bundle savedInstanceState) {
 971         super.onPostCreate(savedInstanceState);
 972         // Sync the toggle state after onRestoreInstanceState has occurred.
 973         mDrawerToggle.syncState();
 974     }
 975 
 976     @Override
 977     public void onConfigurationChanged(Configuration newConfig) {
 978         super.onConfigurationChanged(newConfig);
 979 
 980         mDrawerToggle.onConfigurationChanged(newConfig);
 981 
 982         if (DisplayUtils.isLargeScreen(this)) {
 983             mIsShowingMarkdown = false;
 984 
 985             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 986                 // Add the editor fragment
 987                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 988                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 988                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 989                 } else if (DisplayUtils.isLandscape(this)) {
 990                     addEditorFragment();
 991                 }
 992                 if (mNoteListFragment != null) {
 993                     mNoteListFragment.setActivateOnItemClick(true);
 994                     mNoteListFragment.setDividerVisible(true);
 995                 }
 996                 // Select the current note on a tablet
 997                 if (mCurrentNote != null)
<abbr title=" 998                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 998                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 999                 else {
1000                     mNoteEditorFragment.setPlaceholderVisible(true);
1001                     mNoteListFragment.getListView().clearChoices();
1002                 }
1003                 invalidateOptionsMenu();
1004             }
1005         }
1006 
1007         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1008             // Remove the editor fragment when rotating back to portrait
1009             mCurrentNote = null;
1010             if (mNoteListFragment != null) {
1011                 mNoteListFragment.setActivateOnItemClick(false);
1012                 mNoteListFragment.setDividerVisible(false);
1013                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1014                 mNoteListFragment.refreshList();
1015             }
1016             FragmentManager fm = getSupportFragmentManager();
1017             FragmentTransaction ft = fm.beginTransaction();
1018             ft.remove(mNoteEditorFragment);
1019             mNoteEditorFragment = null;
1020             ft.commitAllowingStateLoss();
1021             fm.executePendingTransactions();
1022             invalidateOptionsMenu();
1023         }
1024     }
1025 
1026     public void checkEmptyListText(boolean isSearch) {
1027         if (isSearch) {
<abbr title="1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1029             getNoteListFragment().setEmptyListViewClickable(false);
1030         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1031             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1031             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1032             AnalyticsTracker.track(
1033                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1034                     AnalyticsTracker.CATEGORY_NOTE,
1035                     &quot;trash_filter_selected&quot;
1036             );
1037             getNoteListFragment().setEmptyListViewClickable(false);
1038         } else {
<abbr title="1039             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1039             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1040             getNoteListFragment().setEmptyListViewClickable(true);
1041         }
1042     }
1043 
1044     public void showDetailPlaceholder() {
1045         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1046             mCurrentNote = null;
1047             mNoteEditorFragment.setPlaceholderVisible(true);
1048             mNoteEditorFragment.clearMarkdown();
1049             mNoteEditorFragment.hideMarkdown();
1050             mIsShowingMarkdown = false;
1051         }
1052     }
1053 
1054     public void stopListeningToNotesBucket() {
1055         mNotesBucket.removeOnNetworkChangeListener(this);
1056         mNotesBucket.removeOnSaveObjectListener(this);
1057         mNotesBucket.removeOnDeleteObjectListener(this);
1058     }
1059 
1060     // Returns the appropriate view to show the undo bar within
1061     private View getUndoView() {
1062         View undoView = mFragmentsContainer;
1063         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1064                 getNoteListFragment() != null &amp;&amp;
1065                 getNoteListFragment().getRootView() != null) {
1066             undoView = getNoteListFragment().getRootView();
1067         }
1068 
1069         return undoView;
1070     }
1071 
1072     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1073         if (mUndoBarController != null) {
1074             mUndoBarController.setDeletedNoteIds(noteIds);
1075             mUndoBarController.showUndoBar(
1076                     getUndoView(),
<abbr title="1077                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1077                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1078             );
1079         }
1080     }
1081 
1082     /* Simperium Bucket Listeners */
1083     // received a change from the network, refresh the list
1084     @Override
1085     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1086         runOnUiThread(new Runnable() {
1087             @Override
1088             public void run() {
1089                 if (type == Bucket.ChangeType.INDEX) {
1090                     setToolbarProgressVisibility(false);
1091                 }
1092                 mNoteListFragment.refreshList();
1093             }
1094         });
1095     }
1096 
1097     @Override
1098     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1099         runOnUiThread(new Runnable() {
1100             @Override
1101             public void run() {
1102                 mNoteListFragment.refreshList();
1103             }
1104         });
1105     }
1106 
1107     @Override
1108     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1109         runOnUiThread(new Runnable() {
1110             @Override
1111             public void run() {
1112                 mNoteListFragment.refreshList();
1113             }
1114         });
1115     }
1116 
1117     @Override
1118     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1119         // noop, NoteEditorFragment will handle this
1120     }
1121 
1122     /* The click listener for ListView in the navigation drawer */
1123     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1124         @Override
1125         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1126 
1127             // Adjust for header view
1128             position -= mDrawerList.getHeaderViewsCount();
1129             mSelectedTag = mTagsAdapter.getItem(position);
1130             checkEmptyListText(false);
1131             // Update checked item in navigation drawer and close it
1132             setSelectedTagActive();
1133             mDrawerLayout.closeDrawer(mNavigationView);
1134             updateNavigationDrawerItems();
1135 
1136             // Disable long press on notes if we&#x27;re viewing the trash
1137             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1138                 getNoteListFragment().getListView().setLongClickable(false);
1139             } else {
1140                 getNoteListFragment().getListView().setLongClickable(true);
1141             }
1142 
1143             getNoteListFragment().refreshListFromNavSelect();
1144             if (position &gt; 1) {
1145                 AnalyticsTracker.track(
1146                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1147                         AnalyticsTracker.CATEGORY_TAG,
1148                         &quot;selected_tag_in_navigation_drawer&quot;
1149                 );
1150             }
1151         }
1152     }
1153 
1154     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1155 
1156         @Override
1157         protected Void doInBackground(Void... voids) {
1158             if (mNotesBucket == null) return null;
1159 
1160             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1161             Bucket.ObjectCursor c = query.execute();
1162             while (c.moveToNext()) {
1163                 c.getObject().delete();
1164             }
1165 
1166             return null;
1167         }
1168 
1169         @Override
1170         protected void onPostExecute(Void nada) {
1171             showDetailPlaceholder();
1172         }
1173     }
1174 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.support.design.widget.NavigationView;
  14 import android.support.v4.app.FragmentManager;
  15 import android.support.v4.app.FragmentTransaction;
  16 import android.support.v4.view.GravityCompat;
  17 import android.support.v4.widget.DrawerLayout;
  18 import android.support.v7.app.ActionBar;
  19 import android.support.v7.app.ActionBarDrawerToggle;
  20 import android.support.v7.app.AppCompatActivity;
  21 import android.support.v7.preference.PreferenceManager;
  22 import android.support.v7.widget.SearchView;
  23 import android.support.v7.widget.Toolbar;
  24 import android.text.Spannable;
  25 import android.text.SpannableString;
  26 import android.text.TextUtils;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.WindowInsets;
  32 import android.widget.AdapterView;
  33 import android.widget.LinearLayout;
  34 import android.widget.ListView;
  35 import android.widget.ProgressBar;
  36 import com.automattic.simplenote.analytics.AnalyticsTracker;
  37 import com.automattic.simplenote.models.Note;
  38 import com.automattic.simplenote.models.Tag;
  39 import com.automattic.simplenote.utils.DisplayUtils;
  40 import com.automattic.simplenote.utils.DrawableUtils;
  41 import com.automattic.simplenote.utils.HtmlCompat;
  42 import com.automattic.simplenote.utils.PrefUtils;
  43 import com.automattic.simplenote.utils.StrUtils;
  44 import com.automattic.simplenote.utils.TagsAdapter;
  45 import com.automattic.simplenote.utils.ThemeUtils;
  46 import com.automattic.simplenote.utils.UndoBarController;
  47 import com.automattic.simplenote.widgets.TypefaceSpan;
  48 import com.simperium.Simperium;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.BucketObjectMissingException;
  51 import com.simperium.client.BucketObjectNameInvalid;
  52 import com.simperium.client.Query;
  53 import com.simperium.client.User;
  54 import java.util.ArrayList;
  55 import java.util.Calendar;
  56 import java.util.List;
  57 import org.wordpress.passcodelock.AppLockManager;
  58 import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;
  59 import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;
  60 import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;
  61 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  62 
  63 
<abbr title="  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  65     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  66 
  67     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  68 
  69     protected Bucket&lt;Note&gt; mNotesBucket;
  70 
  71     protected Bucket&lt;Tag&gt; mTagsBucket;
  72 
  73     private int TRASH_SELECTED_ID = 1;
  74 
  75     private boolean mIsShowingMarkdown;
  76 
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80 
  81     private UndoBarController mUndoBarController;
  82 
  83     private View mFragmentsContainer;
  84 
  85     private SearchView mSearchView;
  86 
  87     private MenuItem mSearchMenuItem;
  88 
  89     private NoteListFragment mNoteListFragment;
  90 
  91     private NoteEditorFragment mNoteEditorFragment;
  92 
  93     private Note mCurrentNote;
  94 
  95     private MenuItem mEmptyTrashMenuItem;
  96 
  97     // Menu drawer
  98     // Menu drawer
  99     private DrawerLayout mDrawerLayout;
 100 
 101     private ListView mDrawerList;
 102 
 103     private NavigationView mNavigationView;
 104 
 105     private ActionBarDrawerToggle mDrawerToggle;
 106 
 107     private TagsAdapter mTagsAdapter;
 108 
 109     private TagsAdapter.TagMenuItem mSelectedTag;
 110 
 111     // Tags bucket listener
 112     // Tags bucket listener
 113     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 114         void updateNavigationDrawer() {
 115             runOnUiThread(new Runnable() {
 116                 public void run() {
 117                     updateNavigationDrawerItems();
 118                 }
 119             });
 120         }
 121 
 122         @Override
 123         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124             updateNavigationDrawer();
 125         }
 126 
 127         @Override
 128         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 129             updateNavigationDrawer();
 130         }
 131 
 132         @Override
 133         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 134             updateNavigationDrawer();
 135         }
 136 
 137         @Override
 138         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 139             // noop
 140         }
 141     };
 142 
 143     @Override
 144     protected void onCreate(Bundle savedInstanceState) {
 145         getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 146         getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));
 147         ThemeUtils.setTheme(this);
 148         super.onCreate(savedInstanceState);
 149         setContentView(R.layout.activity_notes);
 150         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 151         Simplenote currentApp = ((Simplenote) (getApplication()));
 152         if (mNotesBucket == null) {
 153             mNotesBucket = currentApp.getNotesBucket();
 154         }
 155         if (mTagsBucket == null) {
 156             mTagsBucket = currentApp.getTagsBucket();
 157         }
 158         Toolbar toolbar = findViewById(R.id.toolbar);
 159         setSupportActionBar(toolbar);
 160         configureNavigationDrawer(toolbar);
 161         if (savedInstanceState == null) {
 162             mNoteListFragment = new NoteListFragment();
 163             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 164             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 165             fragmentTransaction.commit();
 166         } else {
<abbr title=" 167             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));"> 167             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOðŸ”µ</abbr>
 168         }
 169         if (DisplayUtils.isLargeScreen(this)) {
 170             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 171                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 171                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTaðŸ”µ</abbr>
 172             } else if (DisplayUtils.isLandscape(this)) {
 173                 addEditorFragment();
 174             }
 175         }
 176         // enable ActionBar app icon to behave as action to toggle nav drawer
 177         ActionBar actionBar = getSupportActionBar();
 178         if (actionBar != null) {
 179             actionBar.setDisplayHomeAsUpEnabled(true);
 180             actionBar.setHomeButtonEnabled(true);
 181             // Add loading indicator to show when indexing
<abbr title=" 182             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toolbar, null)));"> 182             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toðŸ”µ</abbr>
 183             actionBar.setDisplayShowCustomEnabled(true);
 184             actionBar.setCustomView(progressBar);
 185             setToolbarProgressVisibility(false);
 186         }
 187         mUndoBarController = new UndoBarController(this);
 188         // Creates &#x27;Welcome&#x27; note
 189         checkForFirstLaunch();
 190         checkForSharedContent();
 191         currentApp.getSimperium().setOnUserCreatedListener(this);
 192         currentApp.getSimperium().setUserStatusChangeListener(this);
 193     }
 194 
 195     @Override
 196     protected void onResume() {
 197         super.onResume();
 198         // Ensure user has valid authorization
 199         if (userAuthenticationIsInvalid()) {
 200             startLoginActivity(true);
 201             Intent intent = getIntent();
<abbr title=" 202             if ((intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; (intent.getExtras() != null)) &amp;&amp; (intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED)) {"> 202             if ((intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; (intent.getExtras() != null)) &amp;&amp; (intent.getExtras(ðŸ”µ</abbr>
<abbr title=" 203                 AnalyticsTracker.track(NOTE_WIDGET_SIGN_IN_TAPPED, CATEGORY_WIDGET, &quot;note_widget_sign_in_tapped&quot;);"> 203                 AnalyticsTracker.track(NOTE_WIDGET_SIGN_IN_TAPPED, CATEGORY_WIDGET, &quot;note_widget_sign_in_ðŸ”µ</abbr>
 204             }
 205         }
 206         disableScreenshotsIfLocked(this);
 207         mNotesBucket.start();
 208         mTagsBucket.start();
 209         mNotesBucket.addOnNetworkChangeListener(this);
 210         mNotesBucket.addOnSaveObjectListener(this);
 211         mNotesBucket.addOnDeleteObjectListener(this);
 212         mTagsBucket.addListener(mTagsMenuUpdater);
 213         updateNavigationDrawerItems();
 214         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 215         if (userIsUnauthorized()) {
 216             if ((-1) == mTagsAdapter.getPosition(mSelectedTag)) {
 217                 mSelectedTag = null;
 218                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 219             }
 220         }
 221         setSelectedTagActive();
 222         if ((mCurrentNote != null) &amp;&amp; mShouldSelectNewNote) {
 223             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 224             mShouldSelectNewNote = false;
 225         }
 226         if (mIsShowingMarkdown) {
 227             setMarkdownShowing(false);
 228         }
 229     }
 230 
 231     @Override
 232     protected void onPause() {
 233         super.onPause();  // Always call the superclass method first
 234         mTagsBucket.removeListener(mTagsMenuUpdater);
 235         mTagsBucket.stop();
 236 
 237         mNotesBucket.removeOnNetworkChangeListener(this);
 238         mNotesBucket.removeOnSaveObjectListener(this);
 239         mNotesBucket.removeOnDeleteObjectListener(this);
 240         mNotesBucket.stop();
 241     }
 242 
 243     @Override
 244     public void setTitle(CharSequence title) {
 245         if (title == null) {
 246             title = &quot;&quot;;
 247         }
 248 
 249         setTitleWithCustomFont(title);
 250     }
 251 
 252     @Override
 253     public void onBackPressed() {
 254         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 255             mDrawerLayout.closeDrawer(GravityCompat.START);
 256         } else {
 257             super.onBackPressed();
 258         }
 259     }
 260 
 261     private void setTitleWithCustomFont(CharSequence title) {
 262         if (getSupportActionBar() == null) {
 263             return;
 264         }
 265         SpannableString s = new SpannableString(title);
 266         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 267         getSupportActionBar().setTitle(s);
 268     }
 269 
 270     private void configureNavigationDrawer(Toolbar toolbar) {
 271         mDrawerLayout = findViewById(R.id.drawer_layout);
 272         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 273         mNavigationView = findViewById(R.id.navigation_view);
 274         mDrawerList = findViewById(R.id.drawer_list);
 275         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 276             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 277                 @Override
 278                 @SuppressLint(&quot;NewApi&quot;)
 279                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 280                     LinearLayout drawerView = findViewById(R.id.drawer_view);
<abbr title=" 281                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTop(), drawerView.getPaddingRight(), drawerView.getPaddingBottom());"> 281                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTðŸ”µ</abbr>
 282                     return windowInsets.consumeSystemWindowInsets();
 283                 }
 284             });
 285         }
 286         View settingsButton = findViewById(R.id.nav_settings);
 287         settingsButton.setOnClickListener(new View.OnClickListener() {
 288             @Override
 289             public void onClick(View v) {
 290                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 291                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 292             }
 293         });
 294         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 295         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 296         mDrawerList.setAdapter(mTagsAdapter);
 297         // Set the list&#x27;s click listener
 298         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 299         if (mSelectedTag == null) {
 300             mSelectedTag = mTagsAdapter.getDefaultItem();
 301         }
<abbr title=" 302         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.string.close_drawer) {"> 302         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.sðŸ”µ</abbr>
 303             public void onDrawerClosed(View view) {
 304                 supportInvalidateOptionsMenu();
 305             }
 306 
 307             public void onDrawerOpened(View drawerView) {
 308                 // noop
 309             }
 310 
 311             @Override
 312             public void onDrawerSlide(View drawerView, float slideOffset) {
 313                 super.onDrawerSlide(drawerView, 0.0F);
 314             }
 315         };
 316         mDrawerLayout.addDrawerListener(mDrawerToggle);
 317     }
 318 
 319     private void checkForFirstLaunch() {
 320         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 321             // Create the welcome note
 322             try {
 323                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 324                 welcomeNote.setCreationDate(Calendar.getInstance());
 325                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 326                 welcomeNote.setContent(getString(R.string.welcome_note));
 327                 welcomeNote.getTitle();
 328                 welcomeNote.save();
 329             } catch (BucketObjectNameInvalid e) {
 330                 // this won&#x27;t happen because welcome-android is a valid name
 331             }
 332 
 333             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 334             SharedPreferences.Editor editor = preferences.edit();
 335             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 336             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 337             editor.apply();
 338         }
 339     }
 340 
 341     private void checkForSharedContent() {
 342         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 343             // Check share action
 344             Intent intent = getIntent();
 345             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 346             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 347 
<abbr title=" 348             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 348             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 349             String intentAction = StrUtils.notNullStr(intent.getAction());
 350             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 351             if (!TextUtils.isEmpty(text)) {
 352                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 353                     text = subject + &quot;\n\n&quot; + text;
 354                 }
 355                 Note note = mNotesBucket.newObject();
 356                 note.setCreationDate(Calendar.getInstance());
 357                 note.setModificationDate(note.getCreationDate());
 358                 note.setContent(text);
 359                 note.save();
 360                 setCurrentNote(note);
 361                 mShouldSelectNewNote = true;
 362 
 363                 AnalyticsTracker.track(
 364                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 365                         AnalyticsTracker.CATEGORY_NOTE,
 366                         &quot;external_share&quot;
 367                 );
 368 
 369                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 370                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 371                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 372                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 373                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 374                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 375                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 376                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 377                     }
 378                 }
 379             }
 380         }
 381     }
 382 
 383     private void updateNavigationDrawerItems() {
 384         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 385         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 386         if (isAlphaSort) {
 387             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 388         } else {
 389             tagCursor = Tag.allWithName(mTagsBucket).execute();
 390         }
 391 
 392         mTagsAdapter.changeCursor(tagCursor);
 393     }
 394 
 395     private void setSelectedTagActive() {
 396         if (mSelectedTag == null)
 397             mSelectedTag = mTagsAdapter.getDefaultItem();
 398 
 399         setTitle(mSelectedTag.name);
<abbr title=" 400         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 400         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 401     }
 402 
 403     public TagsAdapter.TagMenuItem getSelectedTag() {
 404         if (mSelectedTag == null) {
 405             mSelectedTag = mTagsAdapter.getDefaultItem();
 406         }
 407 
 408         return mSelectedTag;
 409     }
 410 
 411     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 412     public void updateTrashMenuItem() {
 413         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 414             return;
 415 
 416         // Disable the trash icon if there are no notes trashed.
 417         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 418         if (query.count() == 0) {
 419             mEmptyTrashMenuItem.setEnabled(false);
 420         } else {
 421             mEmptyTrashMenuItem.setEnabled(true);
 422         }
 423     }
 424 
 425     private void addEditorFragment() {
 426         FragmentManager fm = getSupportFragmentManager();
 427         FragmentTransaction ft = fm.beginTransaction();
 428         mNoteEditorFragment = new NoteEditorFragment();
 429         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 430         ft.commitAllowingStateLoss();
 431         fm.executePendingTransactions();
 432     }
 433 
 434     private boolean userAccountRequired() {
 435         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 436     }
 437 
 438     /**
 439      * Checks for a previously valid user that is now not authenticated
 440      * Also checks if user account is required (added in version 1.5.6)
 441      *
 442      * @return true if user has invalid authorization
 443      */
 444     private boolean userAuthenticationIsInvalid() {
 445         Simplenote currentApp = (Simplenote) getApplication();
 446         Simperium simperium = currentApp.getSimperium();
 447         User user = simperium.getUser();
 448         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 449         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 450                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 451     }
 452 
 453     public boolean userIsUnauthorized() {
 454         Simplenote currentApp = (Simplenote) getApplication();
 455         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 456     }
 457 
 458     public void setCurrentNote(Note note) {
 459         mCurrentNote = note;
 460     }
 461 
 462     public NoteListFragment getNoteListFragment() {
 463         return mNoteListFragment;
 464     }
 465 
 466     @SuppressWarnings(&quot;ResourceType&quot;)
 467     @Override
 468     public boolean onCreateOptionsMenu(Menu menu) {
 469         super.onCreateOptionsMenu(menu);
 470         MenuInflater inflater = getMenuInflater();
 471         inflater.inflate(R.menu.notes_list, menu);
 472         // restore the search query if on a landscape tablet
 473         String searchQuery = null;
 474         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 475             searchQuery = mSearchView.getQuery().toString();
 476         }
 477         mSearchMenuItem = menu.findItem(R.id.menu_search);
 478         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 479         if (!TextUtils.isEmpty(searchQuery)) {
 480             mSearchView.setQuery(searchQuery, false);
 481             mSearchMenuItem.expandActionView();
 482         } else {
 483             // Workaround for setting the search placeholder text color
<abbr title=" 484             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);"> 484             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getStrðŸ”µ</abbr>
<abbr title=" 485             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 485             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 486         }
 487         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 488             @Override
 489             public boolean onQueryTextChange(String newText) {
 490                 if (mSearchMenuItem.isActionViewExpanded()) {
 491                     getNoteListFragment().searchNotes(newText);
 492                 }
 493                 return true;
 494             }
 495 
 496             @Override
 497             public boolean onQueryTextSubmit(String queryText) {
 498                 getNoteListFragment().searchNotes(queryText);
 499                 return true;
 500             }
 501         });
 502         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 503             @Override
 504             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 505                 checkEmptyListText(true);
 506                 if (mNoteListFragment != null) {
 507                     mNoteListFragment.setFloatingActionButtonVisible(false);
 508                 }
 509                 AnalyticsTracker.track(
 510                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 511                         AnalyticsTracker.CATEGORY_NOTE,
 512                         &quot;action_bar_search_tap&quot;
 513                 );
 514                 return true;
 515             }
 516 
 517             @Override
 518             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 519                 // Show all notes again
 520                 if (mNoteListFragment != null) {
 521                     mNoteListFragment.setFloatingActionButtonVisible(true);
 522                 }
 523                 mTabletSearchQuery = &quot;&quot;;
 524                 mSearchView.setQuery(&quot;&quot;, false);
 525                 checkEmptyListText(false);
 526                 getNoteListFragment().clearSearch();
 527                 return true;
 528             }
 529         });
 530         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 531             @Override
 532             public boolean onMenuItemClick(MenuItem item) {
 533                 if (!mSearchMenuItem.isActionViewExpanded()) {
 534                     showDetailPlaceholder();
 535                 }
 536                 return false;
 537             }
 538         });
 539         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 540         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 541             trashItem.setTitle(R.string.undelete);
 542             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 543         } else {
 544             trashItem.setTitle(R.string.delete);
 545             trashItem.setIcon(R.drawable.ic_trash_24dp);
 546         }
 547         if (DisplayUtils.isLargeScreenLandscape(this)) {
 548             // Restore the search query on landscape tablets
 549             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 550                 mSearchMenuItem.expandActionView();
 551                 mSearchView.setQuery(mTabletSearchQuery, false);
 552                 mSearchView.clearFocus();
 553             }
 554             if (mCurrentNote != null) {
 555                 menu.findItem(R.id.menu_share).setVisible(true);
 556                 menu.findItem(R.id.menu_view_info).setVisible(true);
 557                 menu.findItem(R.id.menu_checklist).setVisible(true);
 558                 menu.findItem(R.id.menu_history).setVisible(true);
 559                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 560                 trashItem.setVisible(true);
 561             } else {
 562                 menu.findItem(R.id.menu_share).setVisible(false);
 563                 menu.findItem(R.id.menu_view_info).setVisible(false);
 564                 menu.findItem(R.id.menu_checklist).setVisible(false);
 565                 menu.findItem(R.id.menu_history).setVisible(false);
 566                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 567                 trashItem.setVisible(false);
 568             }
 569             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 570         } else {
 571             menu.findItem(R.id.menu_search).setVisible(true);
 572             menu.findItem(R.id.menu_share).setVisible(false);
 573             menu.findItem(R.id.menu_view_info).setVisible(false);
 574             menu.findItem(R.id.menu_checklist).setVisible(false);
 575             menu.findItem(R.id.menu_history).setVisible(false);
 576             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 577             trashItem.setVisible(false);
 578             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 579         }
 580         // Are we looking at the trash? Adjust menu accordingly.
 581         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 582             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 583             mEmptyTrashMenuItem.setVisible(true);
 584             updateTrashMenuItem();
 585             menu.findItem(R.id.menu_search).setVisible(false);
 586             menu.findItem(R.id.menu_share).setVisible(false);
 587             menu.findItem(R.id.menu_history).setVisible(false);
 588             menu.findItem(R.id.menu_checklist).setVisible(false);
 589         }
 590         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 591         return true;
 592     }
 593 
 594     @Override
 595     public boolean onOptionsItemSelected(MenuItem item) {
 596         if (mDrawerToggle.onOptionsItemSelected(item)) {
 597             return true;
 598         }
 599         switch (item.getItemId()) {
 600             case R.id.menu_markdown_preview:
 601                 if (mIsShowingMarkdown) {
 602                     item.setIcon(R.drawable.ic_preview_24dp);
 603                     item.setTitle(getString(R.string.markdown_show));
 604                     setMarkdownShowing(false);
 605                 } else {
 606                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 607                     item.setTitle(getString(R.string.markdown_hide));
 608                     setMarkdownShowing(true);
 609                 }
 610 
 611                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 612 
 613                 return true;
 614             case R.id.menu_delete:
 615                 if (mNoteEditorFragment != null) {
 616                     if (mCurrentNote != null) {
 617                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 618                         mCurrentNote.setModificationDate(Calendar.getInstance());
 619                         mCurrentNote.save();
 620 
 621                         updateViewsAfterTrashAction(mCurrentNote);
 622                     }
 623                 }
 624                 return true;
 625             case R.id.menu_empty_trash:
 626                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 627 
 628                 alert.setTitle(R.string.empty_trash);
 629                 alert.setMessage(R.string.confirm_empty_trash);
 630                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 631                     public void onClick(DialogInterface dialog, int whichButton) {
 632                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 633                         AnalyticsTracker.track(
 634                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 635                                 AnalyticsTracker.CATEGORY_NOTE,
 636                                 &quot;overflow_menu&quot;
 637                         );
 638                     }
 639                 });
 640                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 641                     public void onClick(DialogInterface dialog, int whichButton) {
 642                         // Do nothing, just closing the dialog
 643                     }
 644                 });
 645                 alert.show();
 646                 return true;
 647             case android.R.id.home:
 648                 invalidateOptionsMenu();
 649                 return true;
 650             default:
 651                 return super.onOptionsItemSelected(item);
 652         }
 653     }
 654 
 655     @Override
 656     public boolean onPrepareOptionsMenu(Menu menu) {
 657         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 658 
 659         if (mIsShowingMarkdown) {
 660             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 661             markdownItem.setTitle(getString(R.string.markdown_hide));
 662         } else {
 663             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 664             markdownItem.setTitle(getString(R.string.markdown_show));
 665         }
 666 
 667         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 668 
 669         return super.onPrepareOptionsMenu(menu);
 670     }
 671 
 672     public void updateViewsAfterTrashAction(Note note) {
 673         if (note == null || isFinishing()) {
 674             return;
 675         }
 676 
 677         if (note.isDeleted()) {
 678             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 679             deletedNoteIds.add(note.getSimperiumKey());
 680             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 681             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 682             AnalyticsTracker.track(
 683                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 684                     AnalyticsTracker.CATEGORY_NOTE,
 685                     &quot;overflow_menu&quot;
 686             );
 687         } else {
 688             AnalyticsTracker.track(
 689                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 690                     AnalyticsTracker.CATEGORY_NOTE,
 691                     &quot;overflow_menu&quot;
 692             );
 693         }
 694 
 695         // If we just deleted/restored the active note, show the placeholder
 696         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 697             showDetailPlaceholder();
 698         }
 699 
 700         NoteListFragment fragment = getNoteListFragment();
 701         if (fragment != null) {
 702             fragment.getPrefs();
 703             fragment.refreshList();
 704         }
 705 
 706         invalidateOptionsMenu();
 707     }
 708 
 709     public void setMarkdownShowing(boolean isMarkdownShowing) {
 710         mIsShowingMarkdown = isMarkdownShowing;
 711         if (mNoteEditorFragment != null) {
 712             if (isMarkdownShowing) {
 713                 mNoteEditorFragment.showMarkdown();
 714             } else {
 715                 mNoteEditorFragment.hideMarkdown();
 716             }
 717         }
 718         invalidateOptionsMenu();
 719     }
 720 
 721     /**
 722      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 723      * the item with the given ID was selected. Used for tablets only.
 724      */
 725     @Override
<abbr title=" 726     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 726     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 727         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 728             // Launch the editor activity
 729             Bundle arguments = new Bundle();
 730             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 731             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 732 
 733             if (matchOffsets != null)
 734                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 735 
 736             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 737             editNoteIntent.putExtras(arguments);
 738             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 739         } else {
 740             mNoteEditorFragment.setNote(noteID, matchOffsets);
 741             getNoteListFragment().setNoteSelected(noteID);
 742 
 743             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 744                 mTabletSearchQuery = mSearchView.getQuery().toString();
 745             }
 746 
 747             mNoteEditorFragment.clearMarkdown();
 748 
 749             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 750                 setMarkdownShowing(false);
 751             }
 752 
 753             invalidateOptionsMenu();
 754         }
 755 
 756         AnalyticsTracker.track(
 757                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 758                 AnalyticsTracker.CATEGORY_NOTE,
 759                 &quot;note_list_row_tap&quot;
 760         );
 761     }
 762 
 763     @Override
 764     public void onUserCreated(User user) {
 765         // New account created
 766         AnalyticsTracker.track(
 767                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 768                 AnalyticsTracker.CATEGORY_USER,
 769                 &quot;account_created_from_login_activity&quot;
 770         );
 771     }
 772 
 773     public void onUserStatusChange(User.Status status) {
 774         switch (status) {
 775             // successfully used access token to connect to simperium bucket
 776             case AUTHORIZED:
 777                 runOnUiThread(new Runnable() {
 778                     @Override
 779                     public void run() {
 780                         if (!mNotesBucket.hasChangeVersion()) {
 781                             setToolbarProgressVisibility(true);
 782                         }
 783                     }
 784                 });
 785                 break;
 786 
 787             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 788             case NOT_AUTHORIZED:
 789                 runOnUiThread(new Runnable() {
 790                     @Override
 791                     public void run() {
 792                         startLoginActivity(true);
 793                     }
 794                 });
 795                 break;
 796 
<abbr title=" 797             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 797             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 798             case UNKNOWN:
 799                 break;
 800         }
 801     }
 802 
 803     private void setToolbarProgressVisibility(boolean isVisible) {
 804         if (getSupportActionBar() != null) {
 805             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 806         }
 807     }
 808 
 809     public void startLoginActivity(boolean signInFirst) {
 810         // Clear some account-specific prefs
 811         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 812         editor.remove(PrefUtils.PREF_WP_TOKEN);
 813         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 814         editor.apply();
 815 
 816         Intent loginIntent = new Intent(this, SignInActivity.class);
 817         if (signInFirst) {
 818             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 819         }
 820         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 821     }
 822 
 823     @Override
 824     public void recreate() {
 825         Handler handler = new Handler();
 826         handler.post(new Runnable() {
 827             @Override
 828             public void run() {
 829                 NotesActivity.super.recreate();
 830             }
 831         });
 832     }
 833 
 834     @Override
 835     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 836         super.onActivityResult(requestCode, resultCode, data);
 837         switch (requestCode) {
 838             case Simplenote.INTENT_PREFERENCES:
 839                 if (ThemeUtils.themeWasChanged(data)) {
 840                     // Restart this activity to apply the new theme
 841                     recreate();
 842                     break;
 843                 }
<abbr title=" 844                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 844                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 845                 invalidateOptionsMenu();
 846                 NoteListFragment fragment = getNoteListFragment();
 847                 if (fragment != null) {
 848                     fragment.getPrefs();
 849                     fragment.refreshList();
 850                 }
 851 
 852                 break;
 853             case Simplenote.INTENT_EDIT_NOTE:
 854                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 855                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 856                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 857                         if (noteId != null) {
 858                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 859                             deletedNoteIds.add(noteId);
 860                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 861                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 861                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 862                         }
<abbr title=" 863                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 863                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 864                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 865                         mNoteListFragment.setNoteSelected(selectedNoteId);
 866                         if (mNoteEditorFragment != null) {
 867                             mNoteEditorFragment.setNote(selectedNoteId);
 868                         }
 869                     }
 870                 }
 871                 break;
 872             case Simperium.SIGNUP_SIGNIN_REQUEST:
 873                 invalidateOptionsMenu();
 874 
 875                 Simplenote app = (Simplenote) getApplication();
 876                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 877 
 878                 AnalyticsTracker.track(
 879                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 880                         AnalyticsTracker.CATEGORY_USER,
 881                         &quot;signed_in_from_login_activity&quot;
 882                 );
 883 
 884                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 885                     finish();
 886                 }
 887 
 888                 break;
 889         }
 890     }
 891 
 892     @Override
 893     public void onUndo() {
 894         if (mUndoBarController == null) return;
 895 
 896         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 897         if (deletedNoteIds != null) {
 898             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 899                 Note deletedNote;
 900                 try {
 901                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 902                 } catch (BucketObjectMissingException e) {
 903                     return;
 904                 }
 905                 if (deletedNote != null) {
 906                     deletedNote.setDeleted(false);
 907                     deletedNote.setModificationDate(Calendar.getInstance());
 908                     deletedNote.save();
 909                     NoteListFragment fragment = getNoteListFragment();
 910                     if (fragment != null) {
 911                         fragment.getPrefs();
 912                         fragment.refreshList();
 913                     }
 914                 }
 915             }
 916         }
 917     }
 918 
 919     @Override
 920     protected void onPostCreate(Bundle savedInstanceState) {
 921         super.onPostCreate(savedInstanceState);
 922         // Sync the toggle state after onRestoreInstanceState has occurred.
 923         mDrawerToggle.syncState();
 924     }
 925 
 926     @Override
 927     public void onConfigurationChanged(Configuration newConfig) {
 928         super.onConfigurationChanged(newConfig);
 929 
 930         mDrawerToggle.onConfigurationChanged(newConfig);
 931 
 932         if (DisplayUtils.isLargeScreen(this)) {
 933             mIsShowingMarkdown = false;
 934 
 935             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 936                 // Add the editor fragment
 937                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 938                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 938                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 939                 } else if (DisplayUtils.isLandscape(this)) {
 940                     addEditorFragment();
 941                 }
 942                 if (mNoteListFragment != null) {
 943                     mNoteListFragment.setActivateOnItemClick(true);
 944                     mNoteListFragment.setDividerVisible(true);
 945                 }
 946                 // Select the current note on a tablet
 947                 if (mCurrentNote != null)
<abbr title=" 948                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 948                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 949                 else {
 950                     mNoteEditorFragment.setPlaceholderVisible(true);
 951                     mNoteListFragment.getListView().clearChoices();
 952                 }
 953                 invalidateOptionsMenu();
 954             }
 955         }
 956 
 957         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 958             // Remove the editor fragment when rotating back to portrait
 959             mCurrentNote = null;
 960             if (mNoteListFragment != null) {
 961                 mNoteListFragment.setActivateOnItemClick(false);
 962                 mNoteListFragment.setDividerVisible(false);
 963                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 964                 mNoteListFragment.refreshList();
 965             }
 966             FragmentManager fm = getSupportFragmentManager();
 967             FragmentTransaction ft = fm.beginTransaction();
 968             ft.remove(mNoteEditorFragment);
 969             mNoteEditorFragment = null;
 970             ft.commitAllowingStateLoss();
 971             fm.executePendingTransactions();
 972             invalidateOptionsMenu();
 973         }
 974     }
 975 
 976     public void checkEmptyListText(boolean isSearch) {
 977         if (isSearch) {
<abbr title=" 978             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 978             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 979             getNoteListFragment().setEmptyListViewClickable(false);
 980         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 981             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 981             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 982             AnalyticsTracker.track(
 983                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
 984                     AnalyticsTracker.CATEGORY_NOTE,
 985                     &quot;trash_filter_selected&quot;
 986             );
 987             getNoteListFragment().setEmptyListViewClickable(false);
 988         } else {
<abbr title=" 989             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 989             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
 990             getNoteListFragment().setEmptyListViewClickable(true);
 991         }
 992     }
 993 
 994     public void showDetailPlaceholder() {
 995         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
 996             mCurrentNote = null;
 997             mNoteEditorFragment.setPlaceholderVisible(true);
 998             mNoteEditorFragment.clearMarkdown();
 999             mNoteEditorFragment.hideMarkdown();
1000             mIsShowingMarkdown = false;
1001         }
1002     }
1003 
1004     public void stopListeningToNotesBucket() {
1005         mNotesBucket.removeOnNetworkChangeListener(this);
1006         mNotesBucket.removeOnSaveObjectListener(this);
1007         mNotesBucket.removeOnDeleteObjectListener(this);
1008     }
1009 
1010     // Returns the appropriate view to show the undo bar within
1011     private View getUndoView() {
1012         View undoView = mFragmentsContainer;
1013         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1014                 getNoteListFragment() != null &amp;&amp;
1015                 getNoteListFragment().getRootView() != null) {
1016             undoView = getNoteListFragment().getRootView();
1017         }
1018 
1019         return undoView;
1020     }
1021 
1022     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1023         if (mUndoBarController != null) {
1024             mUndoBarController.setDeletedNoteIds(noteIds);
1025             mUndoBarController.showUndoBar(
1026                     getUndoView(),
<abbr title="1027                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1027                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1028             );
1029         }
1030     }
1031 
1032     /* Simperium Bucket Listeners */
1033     // received a change from the network, refresh the list
1034     @Override
1035     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1036         runOnUiThread(new Runnable() {
1037             @Override
1038             public void run() {
1039                 if (type == Bucket.ChangeType.INDEX) {
1040                     setToolbarProgressVisibility(false);
1041                 }
1042                 mNoteListFragment.refreshList();
1043             }
1044         });
1045     }
1046 
1047     @Override
1048     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1049         runOnUiThread(new Runnable() {
1050             @Override
1051             public void run() {
1052                 mNoteListFragment.refreshList();
1053             }
1054         });
1055     }
1056 
1057     @Override
1058     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1059         runOnUiThread(new Runnable() {
1060             @Override
1061             public void run() {
1062                 mNoteListFragment.refreshList();
1063             }
1064         });
1065     }
1066 
1067     @Override
1068     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1069         // noop, NoteEditorFragment will handle this
1070     }
1071 
1072     /* The click listener for ListView in the navigation drawer */
1073     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1074         @Override
1075         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1076             // Adjust for header view
1077             position -= mDrawerList.getHeaderViewsCount();
1078             mSelectedTag = mTagsAdapter.getItem(position);
1079             checkEmptyListText(false);
1080             // Update checked item in navigation drawer and close it
1081             setSelectedTagActive();
1082             mDrawerLayout.closeDrawer(mNavigationView);
1083             updateNavigationDrawerItems();
1084             // Disable long press on notes if we&#x27;re viewing the trash
1085             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1086                 getNoteListFragment().getListView().setLongClickable(false);
1087             } else {
1088                 getNoteListFragment().getListView().setLongClickable(true);
1089             }
1090             getNoteListFragment().refreshListFromNavSelect();
1091             if (position &gt; 1) {
<abbr title="1092                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;);">1092                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TðŸ”µ</abbr>
1093             }
1094         }
1095     }
1096 
1097     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1098         @Override
1099         protected Void doInBackground(Void... voids) {
1100             if (mNotesBucket == null) {
1101                 return null;
1102             }
1103             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1104             Bucket.ObjectCursor c = query.execute();
1105             while (c.moveToNext()) {
1106                 c.getObject().delete();
1107             }
1108             return null;
1109         }
1110 
1111         @Override
1112         protected void onPostExecute(Void nada) {
1113             showDetailPlaceholder();
1114         }
1115     }
1116 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  

   3  import android.app.Activity;
   4  import android.app.AlertDialog;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 -import android.os.Build;</span>
  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.support.design.widget.NavigationView;
  14  import android.support.v4.app.FragmentManager;
  15  import android.support.v4.app.FragmentTransaction;
  16  import android.support.v4.content.ContextCompat;
  17  import android.support.v4.view.GravityCompat;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.support.v7.app.ActionBar;
  20  import android.support.v7.app.ActionBarDrawerToggle;
  21  import android.support.v7.app.AppCompatActivity;
  22  import android.support.v7.preference.PreferenceManager;
  23  import android.support.v7.widget.SearchView;
  24  import android.support.v7.widget.Toolbar;
  25  import android.text.Spannable;
  26  import android.text.SpannableString;
  27  import android.text.TextUtils;
  28  import android.view.Menu;
  29  import android.view.MenuInflater;
  30  import android.view.MenuItem;
  31  import android.view.View;
  32  import android.view.WindowManager;

  33  import android.widget.AdapterView;

  34  import android.widget.ListView;
  35  import android.widget.ProgressBar;
  36  
  37  import com.automattic.simplenote.analytics.AnalyticsTracker;
  38  import com.automattic.simplenote.models.Note;
  39  import com.automattic.simplenote.models.Tag;
  40  import com.automattic.simplenote.utils.DisplayUtils;
  41  import com.automattic.simplenote.utils.DrawableUtils;
  42  import com.automattic.simplenote.utils.HtmlCompat;
  43  import com.automattic.simplenote.utils.PrefUtils;
  44  import com.automattic.simplenote.utils.StrUtils;
  45  import com.automattic.simplenote.utils.TagsAdapter;
  46  import com.automattic.simplenote.utils.ThemeUtils;
  47  import com.automattic.simplenote.utils.UndoBarController;
  48  import com.automattic.simplenote.widgets.TypefaceSpan;
  49  import com.simperium.Simperium;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Calendar;
  60  import java.util.List;
  61  



  62  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  63  
  64  public class NotesActivity extends AppCompatActivity implements
<abbr title="  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  66          Bucket.Listener&lt;Note&gt; {
  67  
  68      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  69      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  70      protected Bucket&lt;Note&gt; mNotesBucket;
  71      protected Bucket&lt;Tag&gt; mTagsBucket;
  72      private int TRASH_SELECTED_ID = 1;
  73      private boolean mIsShowingMarkdown;
  74      private boolean mShouldSelectNewNote;
  75  
  76      private String mTabletSearchQuery;
  77      private UndoBarController mUndoBarController;
  78      private View mFragmentsContainer;
  79      private SearchView mSearchView;
  80      private MenuItem mSearchMenuItem;
  81      private NoteListFragment mNoteListFragment;
  82      private NoteEditorFragment mNoteEditorFragment;
  83      private Note mCurrentNote;
  84      private MenuItem mEmptyTrashMenuItem;
  85  
  86      // Menu drawer
  87      private DrawerLayout mDrawerLayout;
  88      private ListView mDrawerList;
  89      private NavigationView mNavigationView;
  90      private ActionBarDrawerToggle mDrawerToggle;
  91      private TagsAdapter mTagsAdapter;
  92      private TagsAdapter.TagMenuItem mSelectedTag;
  93      // Tags bucket listener
  94      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  95          void updateNavigationDrawer() {
  96              runOnUiThread(new Runnable() {
  97                  public void run() {
  98                      updateNavigationDrawerItems();
  99                  }
 100              });
 101          }
 102  
 103          @Override
 104          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 105              updateNavigationDrawer();
 106          }
 107  
 108          @Override
 109          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 110              updateNavigationDrawer();
 111          }
 112  
 113          @Override
 114          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 115              updateNavigationDrawer();
 116          }
 117  
 118          @Override
 119          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 120              // noop
 121          }
 122      };
 123  
 124      @Override
 125      protected void onCreate(Bundle savedInstanceState) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        // On lollipop, configure the translucent status bar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
 133  
 134          ThemeUtils.setTheme(this);
 135          super.onCreate(savedInstanceState);
 136  
 137          setContentView(R.layout.activity_notes);
 138  
 139          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 140  
 141          Simplenote currentApp = (Simplenote) getApplication();
 142          if (mNotesBucket == null) {
 143              mNotesBucket = currentApp.getNotesBucket();
 144          }
 145  
 146          if (mTagsBucket == null) {
 147              mTagsBucket = currentApp.getTagsBucket();
 148          }
 149  
 150          Toolbar toolbar = findViewById(R.id.toolbar);
 151          setSupportActionBar(toolbar);
 152          configureNavigationDrawer(toolbar);
 153  
 154          if (savedInstanceState == null) {
 155              mNoteListFragment = new NoteListFragment();
 156              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 157              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 158              fragmentTransaction.commit();
 159          } else {
 160              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 161          }
 162  
 163          if (DisplayUtils.isLargeScreen(this)) {
 164              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 165                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 165                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 166              } else if (DisplayUtils.isLandscape(this)) {
 167                  addEditorFragment();
 168              }
 169          }
 170  
 171          // enable ActionBar app icon to behave as action to toggle nav drawer
 172          ActionBar actionBar = getSupportActionBar();
 173          if (actionBar != null) {
 174              actionBar.setDisplayHomeAsUpEnabled(true);
 175              actionBar.setHomeButtonEnabled(true);
 176  
 177              // Add loading indicator to show when indexing
<abbr title=" 178              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 178              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 179              actionBar.setDisplayShowCustomEnabled(true);
 180              actionBar.setCustomView(progressBar);
 181              setToolbarProgressVisibility(false);
 182          }
 183  
 184          mUndoBarController = new UndoBarController(this);
 185  
 186          // Creates &#x27;Welcome&#x27; note
 187          checkForFirstLaunch();
 188  
 189          checkForSharedContent();
 190  
 191          currentApp.getSimperium().setOnUserCreatedListener(this);
 192          currentApp.getSimperium().setUserStatusChangeListener(this);
 193      }
 194  
 195      @Override
 196      protected void onResume() {
 197          super.onResume();
 198  
 199          // Ensure user has valid authorization
 200          if (userAuthenticationIsInvalid()) {
 201              startLoginActivity(true);










 202          }
 203  
 204          disableScreenshotsIfLocked(this);
 205  
 206          mNotesBucket.start();
 207          mTagsBucket.start();
 208  
 209          mNotesBucket.addOnNetworkChangeListener(this);
 210          mNotesBucket.addOnSaveObjectListener(this);
 211          mNotesBucket.addOnDeleteObjectListener(this);
 212          mTagsBucket.addListener(mTagsMenuUpdater);
 213  
 214          updateNavigationDrawerItems();
 215  
 216          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 217          if (userIsUnauthorized()) {
 218              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 219                  mSelectedTag = null;
 220                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 221              }
 222          }
 223  
 224          setSelectedTagActive();
 225  
 226          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 227              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 228              mShouldSelectNewNote = false;
 229          }
 230  
 231          if (mIsShowingMarkdown) {
 232              setMarkdownShowing(false);
 233          }
 234  
 235      }
 236  
 237      @Override
 238      protected void onPause() {
 239          super.onPause();  // Always call the superclass method first
 240          mTagsBucket.removeListener(mTagsMenuUpdater);
 241          mTagsBucket.stop();
 242  
 243          mNotesBucket.removeOnNetworkChangeListener(this);
 244          mNotesBucket.removeOnSaveObjectListener(this);
 245          mNotesBucket.removeOnDeleteObjectListener(this);
 246          mNotesBucket.stop();
 247      }
 248  
 249      @Override
 250      public void setTitle(CharSequence title) {
 251          if (title == null) {
 252              title = &quot;&quot;;
 253          }
 254  
 255          setTitleWithCustomFont(title);
 256      }
 257  
 258      @Override
 259      public void onBackPressed() {
 260          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 261              mDrawerLayout.closeDrawer(GravityCompat.START);
 262          } else {
 263              super.onBackPressed();
 264          }
 265      }
 266  
 267      private void setTitleWithCustomFont(CharSequence title) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -        if (getSupportActionBar() == null) return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -        // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -        if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -            getSupportActionBar().setTitle(title);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +        if (getSupportActionBar() == null) {</span>
 275              return;
 276          }
 277  
 278          SpannableString s = new SpannableString(title);
 279          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 280          getSupportActionBar().setTitle(s);
 281      }
 282  
 283      private void configureNavigationDrawer(Toolbar toolbar) {
 284          mDrawerLayout = findViewById(R.id.drawer_layout);
 285          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 286          mNavigationView = findViewById(R.id.navigation_view);
 287          mDrawerList = findViewById(R.id.drawer_list);

















 288  
 289          View settingsButton = findViewById(R.id.nav_settings);
 290          settingsButton.setOnClickListener(new View.OnClickListener() {
 291              @Override
 292              public void onClick(View v) {
 293                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 294                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 295              }
 296          });
 297  
 298          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 299          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 300          mDrawerList.setAdapter(mTagsAdapter);
 301          // Set the list&#x27;s click listener
 302          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 303  
 304          if (mSelectedTag == null)
 305              mSelectedTag = mTagsAdapter.getDefaultItem();
 306  
 307          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 308                  R.string.close_drawer) {
 309              public void onDrawerClosed(View view) {
 310                  supportInvalidateOptionsMenu();
 311              }
 312  
 313              public void onDrawerOpened(View drawerView) {
 314                  // noop
 315              }
 316  
 317              @Override
 318              public void onDrawerSlide(View drawerView, float slideOffset) {
 319                  super.onDrawerSlide(drawerView, 0f);
 320              }
 321          };
 322  
 323          mDrawerLayout.addDrawerListener(mDrawerToggle);
 324      }
 325  
 326      private void checkForFirstLaunch() {
 327          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 328              // Create the welcome note
 329              try {
 330                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 331                  welcomeNote.setCreationDate(Calendar.getInstance());
 332                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 333                  welcomeNote.setContent(getString(R.string.welcome_note));
 334                  welcomeNote.getTitle();
 335                  welcomeNote.save();
 336              } catch (BucketObjectNameInvalid e) {
 337                  // this won&#x27;t happen because welcome-android is a valid name
 338              }
 339  
 340              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 341              SharedPreferences.Editor editor = preferences.edit();
 342              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 343              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 344              editor.apply();
 345          }
 346      }
 347  
 348      private void checkForSharedContent() {
 349          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 350              // Check share action
 351              Intent intent = getIntent();
 352              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 353              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 354  
 355              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 356              String intentAction = StrUtils.notNullStr(intent.getAction());
 357              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 358              if (!TextUtils.isEmpty(text)) {
 359                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 360                      text = subject + &quot;\n\n&quot; + text;
 361                  }
 362                  Note note = mNotesBucket.newObject();
 363                  note.setCreationDate(Calendar.getInstance());
 364                  note.setModificationDate(note.getCreationDate());
 365                  note.setContent(text);
 366                  note.save();
 367                  setCurrentNote(note);
 368                  mShouldSelectNewNote = true;
 369  
 370                  AnalyticsTracker.track(
 371                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 372                          AnalyticsTracker.CATEGORY_NOTE,
 373                          &quot;external_share&quot;
 374                  );
 375  
 376                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 377                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 378                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 379                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 380                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 381                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 382                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 383                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 384                      }
 385                  }
 386              }
 387          }
 388      }
 389  
 390      private void updateNavigationDrawerItems() {
 391          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 392          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 393          if (isAlphaSort) {
 394              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 395          } else {
 396              tagCursor = Tag.allWithName(mTagsBucket).execute();
 397          }
 398  
 399          mTagsAdapter.changeCursor(tagCursor);
 400      }
 401  
 402      private void setSelectedTagActive() {
 403          if (mSelectedTag == null)
 404              mSelectedTag = mTagsAdapter.getDefaultItem();
 405  
 406          setTitle(mSelectedTag.name);
<abbr title=" 407          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 407          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 408      }
 409  
 410      public TagsAdapter.TagMenuItem getSelectedTag() {
 411          if (mSelectedTag == null) {
 412              mSelectedTag = mTagsAdapter.getDefaultItem();
 413          }
 414  
 415          return mSelectedTag;
 416      }
 417  
 418      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 419      public void updateTrashMenuItem() {
 420          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 421              return;
 422  
 423          // Disable the trash icon if there are no notes trashed.
 424          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 425          if (query.count() == 0) {
 426              mEmptyTrashMenuItem.setEnabled(false);
 427          } else {
 428              mEmptyTrashMenuItem.setEnabled(true);
 429          }
 430      }
 431  
 432      private void addEditorFragment() {
 433          FragmentManager fm = getSupportFragmentManager();
 434          FragmentTransaction ft = fm.beginTransaction();
 435          mNoteEditorFragment = new NoteEditorFragment();
 436          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 437          ft.commitAllowingStateLoss();
 438          fm.executePendingTransactions();
 439      }
 440  
 441      private boolean userAccountRequired() {
 442          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 443      }
 444  
 445      /**
 446       * Checks for a previously valid user that is now not authenticated
 447       * Also checks if user account is required (added in version 1.5.6)
 448       *
 449       * @return true if user has invalid authorization
 450       */
 451      private boolean userAuthenticationIsInvalid() {
 452          Simplenote currentApp = (Simplenote) getApplication();
 453          Simperium simperium = currentApp.getSimperium();
 454          User user = simperium.getUser();
 455          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 456          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 457                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 458      }
 459  
 460      public boolean userIsUnauthorized() {
 461          Simplenote currentApp = (Simplenote) getApplication();
 462          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 463      }
 464  
 465      public void setCurrentNote(Note note) {
 466          mCurrentNote = note;
 467      }
 468  
 469      public NoteListFragment getNoteListFragment() {
 470          return mNoteListFragment;
 471      }
 472  
 473      @SuppressWarnings(&quot;ResourceType&quot;)
 474      @Override
 475      public boolean onCreateOptionsMenu(Menu menu) {
 476          super.onCreateOptionsMenu(menu);
 477          MenuInflater inflater = getMenuInflater();
 478          inflater.inflate(R.menu.notes_list, menu);
 479  
 480          // restore the search query if on a landscape tablet
 481          String searchQuery = null;
 482          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 483              searchQuery = mSearchView.getQuery().toString();
 484  
 485          mSearchMenuItem = menu.findItem(R.id.menu_search);
 486          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 487  
 488          if (!TextUtils.isEmpty(searchQuery)) {
 489              mSearchView.setQuery(searchQuery, false);
 490              mSearchMenuItem.expandActionView();
 491          } else {
 492              // Workaround for setting the search placeholder text color
 493              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 494                      getString(R.color.simplenote_light_grey) :
 495                      getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);


 496              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 497                      hintHexColor,
 498                      getString(R.string.search))));
 499          }
 500  
 501          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 502              @Override
 503              public boolean onQueryTextChange(String newText) {
 504                  if (mSearchMenuItem.isActionViewExpanded()) {
 505                      getNoteListFragment().searchNotes(newText);
 506                  }
 507                  return true;
 508              }
 509  
 510              @Override
 511              public boolean onQueryTextSubmit(String queryText) {
 512                  getNoteListFragment().searchNotes(queryText);
 513                  return true;
 514              }
 515  
 516          });
 517  
 518          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 519              @Override
 520              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 521                  checkEmptyListText(true);
 522                  if (mNoteListFragment != null) {
 523                      mNoteListFragment.setFloatingActionButtonVisible(false);
 524                  }
 525                  AnalyticsTracker.track(
 526                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 527                          AnalyticsTracker.CATEGORY_NOTE,
 528                          &quot;action_bar_search_tap&quot;
 529                  );
 530                  return true;
 531              }
 532  
 533              @Override
 534              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 535                  // Show all notes again
 536                  if (mNoteListFragment != null) {
 537                      mNoteListFragment.setFloatingActionButtonVisible(true);
 538                  }
 539                  mTabletSearchQuery = &quot;&quot;;
 540                  mSearchView.setQuery(&quot;&quot;, false);
 541                  checkEmptyListText(false);
 542                  getNoteListFragment().clearSearch();
 543                  return true;
 544              }
 545          });
 546  
 547          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 548              @Override
 549              public boolean onMenuItemClick(MenuItem item) {
 550                  if (!mSearchMenuItem.isActionViewExpanded())
 551                      showDetailPlaceholder();
 552                  return false;
 553              }
 554          });
 555  
 556          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 557          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 558              trashItem.setTitle(R.string.undelete);
 559              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 560          } else {
 561              trashItem.setTitle(R.string.delete);
 562              trashItem.setIcon(R.drawable.ic_trash_24dp);
 563          }
 564  
 565          if (DisplayUtils.isLargeScreenLandscape(this)) {
 566              // Restore the search query on landscape tablets
 567              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 568                  mSearchMenuItem.expandActionView();
 569                  mSearchView.setQuery(mTabletSearchQuery, false);
 570                  mSearchView.clearFocus();
 571              }
 572  
 573              if (mCurrentNote != null) {
 574                  menu.findItem(R.id.menu_share).setVisible(true);
 575                  menu.findItem(R.id.menu_view_info).setVisible(true);
 576                  menu.findItem(R.id.menu_checklist).setVisible(true);
 577                  menu.findItem(R.id.menu_history).setVisible(true);
 578                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 579                  trashItem.setVisible(true);
 580              } else {
 581                  menu.findItem(R.id.menu_share).setVisible(false);
 582                  menu.findItem(R.id.menu_view_info).setVisible(false);
 583                  menu.findItem(R.id.menu_checklist).setVisible(false);
 584                  menu.findItem(R.id.menu_history).setVisible(false);
 585                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 586                  trashItem.setVisible(false);
 587              }
 588              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 589          } else {
 590              menu.findItem(R.id.menu_search).setVisible(true);
 591              menu.findItem(R.id.menu_share).setVisible(false);
 592              menu.findItem(R.id.menu_view_info).setVisible(false);
 593              menu.findItem(R.id.menu_checklist).setVisible(false);
 594              menu.findItem(R.id.menu_history).setVisible(false);
 595              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 596              trashItem.setVisible(false);
 597              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 598          }
 599  
 600          // Are we looking at the trash? Adjust menu accordingly.
 601          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 602              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 603              mEmptyTrashMenuItem.setVisible(true);
 604  
 605              updateTrashMenuItem();
 606  
 607              menu.findItem(R.id.menu_search).setVisible(false);
 608              menu.findItem(R.id.menu_share).setVisible(false);
 609              menu.findItem(R.id.menu_history).setVisible(false);
 610              menu.findItem(R.id.menu_checklist).setVisible(false);
 611          }
 612  
 613          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 614  
 615          return true;
 616      }
 617  
 618      @Override
 619      public boolean onOptionsItemSelected(MenuItem item) {
 620          if (mDrawerToggle.onOptionsItemSelected(item)) {
 621              return true;
 622          }
 623          switch (item.getItemId()) {
 624              case R.id.menu_markdown_preview:
 625                  if (mIsShowingMarkdown) {
 626                      item.setIcon(R.drawable.ic_preview_24dp);
 627                      item.setTitle(getString(R.string.markdown_show));
 628                      setMarkdownShowing(false);
 629                  } else {
 630                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 631                      item.setTitle(getString(R.string.markdown_hide));
 632                      setMarkdownShowing(true);
 633                  }
 634  
 635                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 636  
 637                  return true;
 638              case R.id.menu_delete:
 639                  if (mNoteEditorFragment != null) {
 640                      if (mCurrentNote != null) {
 641                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 642                          mCurrentNote.setModificationDate(Calendar.getInstance());
 643                          mCurrentNote.save();
 644  
 645                          updateViewsAfterTrashAction(mCurrentNote);
 646                      }
 647                  }
 648                  return true;
 649              case R.id.menu_empty_trash:
 650                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 651  
 652                  alert.setTitle(R.string.empty_trash);
 653                  alert.setMessage(R.string.confirm_empty_trash);
 654                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 655                      public void onClick(DialogInterface dialog, int whichButton) {
 656                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 657                          AnalyticsTracker.track(
 658                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 659                                  AnalyticsTracker.CATEGORY_NOTE,
 660                                  &quot;overflow_menu&quot;
 661                          );
 662                      }
 663                  });
 664                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 665                      public void onClick(DialogInterface dialog, int whichButton) {
 666                          // Do nothing, just closing the dialog
 667                      }
 668                  });
 669                  alert.show();
 670                  return true;
 671              case android.R.id.home:
 672                  invalidateOptionsMenu();
 673                  return true;
 674              default:
 675                  return super.onOptionsItemSelected(item);
 676          }
 677      }
 678  
 679      @Override
 680      public boolean onPrepareOptionsMenu(Menu menu) {
 681          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 682  
 683          if (mIsShowingMarkdown) {
 684              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 685              markdownItem.setTitle(getString(R.string.markdown_hide));
 686          } else {
 687              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 688              markdownItem.setTitle(getString(R.string.markdown_show));
 689          }
 690  
 691          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 692  
 693          return super.onPrepareOptionsMenu(menu);
 694      }
 695  
 696      public void updateViewsAfterTrashAction(Note note) {
 697          if (note == null || isFinishing()) {
 698              return;
 699          }
 700  
 701          if (note.isDeleted()) {
 702              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 703              deletedNoteIds.add(note.getSimperiumKey());
 704              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 705              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 706              AnalyticsTracker.track(
 707                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 708                      AnalyticsTracker.CATEGORY_NOTE,
 709                      &quot;overflow_menu&quot;
 710              );
 711          } else {
 712              AnalyticsTracker.track(
 713                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 714                      AnalyticsTracker.CATEGORY_NOTE,
 715                      &quot;overflow_menu&quot;
 716              );
 717          }
 718  
 719          // If we just deleted/restored the active note, show the placeholder
 720          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 721              showDetailPlaceholder();
 722          }
 723  
 724          NoteListFragment fragment = getNoteListFragment();
 725          if (fragment != null) {
 726              fragment.getPrefs();
 727              fragment.refreshList();
 728          }
 729  
 730          invalidateOptionsMenu();
 731      }
 732  
 733      public void setMarkdownShowing(boolean isMarkdownShowing) {
 734          mIsShowingMarkdown = isMarkdownShowing;
 735          if (mNoteEditorFragment != null) {
 736              if (isMarkdownShowing) {
 737                  mNoteEditorFragment.showMarkdown();
 738              } else {
 739                  mNoteEditorFragment.hideMarkdown();
 740              }
 741          }
 742          invalidateOptionsMenu();
 743      }
 744  
 745      /**
 746       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 747       * the item with the given ID was selected. Used for tablets only.
 748       */
 749      @Override
 750      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 751          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 752              // Launch the editor activity
 753              Bundle arguments = new Bundle();
 754              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 755              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 756  
 757              if (matchOffsets != null)
 758                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 759  
 760              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 761              editNoteIntent.putExtras(arguments);
 762              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 763          } else {
 764              mNoteEditorFragment.setNote(noteID, matchOffsets);
 765              getNoteListFragment().setNoteSelected(noteID);
 766  
 767              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 768                  mTabletSearchQuery = mSearchView.getQuery().toString();
 769              }
 770  
 771              mNoteEditorFragment.clearMarkdown();
 772  
 773              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 774                  setMarkdownShowing(false);
 775              }
 776  
 777              invalidateOptionsMenu();
 778          }
 779  
 780          AnalyticsTracker.track(
 781                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 782                  AnalyticsTracker.CATEGORY_NOTE,
 783                  &quot;note_list_row_tap&quot;
 784          );
 785      }
 786  
 787      @Override
 788      public void onUserCreated(User user) {
 789          // New account created
 790          AnalyticsTracker.track(
 791                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 792                  AnalyticsTracker.CATEGORY_USER,
 793                  &quot;account_created_from_login_activity&quot;
 794          );
 795      }
 796  
 797      public void onUserStatusChange(User.Status status) {
 798          switch (status) {
 799              // successfully used access token to connect to simperium bucket
 800              case AUTHORIZED:
 801                  runOnUiThread(new Runnable() {
 802                      @Override
 803                      public void run() {
 804                          if (!mNotesBucket.hasChangeVersion()) {
 805                              setToolbarProgressVisibility(true);
 806                          }
 807                      }
 808                  });
 809                  break;
 810  
 811              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 812              case NOT_AUTHORIZED:
 813                  runOnUiThread(new Runnable() {
 814                      @Override
 815                      public void run() {
 816                          startLoginActivity(true);
 817                      }
 818                  });
 819                  break;
 820  
<abbr title=" 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 822              case UNKNOWN:
 823                  break;
 824          }
 825      }
 826  
 827      private void setToolbarProgressVisibility(boolean isVisible) {
 828          if (getSupportActionBar() != null) {
 829              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 830          }
 831      }
 832  
 833      public void startLoginActivity(boolean signInFirst) {
 834          // Clear some account-specific prefs
 835          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 836          editor.remove(PrefUtils.PREF_WP_TOKEN);
 837          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 838          editor.apply();
 839  
 840          Intent loginIntent = new Intent(this, SignInActivity.class);
 841          if (signInFirst) {
 842              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 843          }
 844          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 845      }
 846  
 847      @Override
 848      public void recreate() {
 849          Handler handler = new Handler();
 850          handler.post(new Runnable() {
 851              @Override
 852              public void run() {
 853                  NotesActivity.super.recreate();
 854              }
 855          });
 856      }
 857  
 858      @Override
 859      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 860          super.onActivityResult(requestCode, resultCode, data);
 861          switch (requestCode) {
 862              case Simplenote.INTENT_PREFERENCES:
 863                  if (ThemeUtils.themeWasChanged(data)) {
 864                      // Restart this activity to apply the new theme
 865                      recreate();
 866                      break;
 867                  }
<abbr title=" 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 869                  invalidateOptionsMenu();
 870                  NoteListFragment fragment = getNoteListFragment();
 871                  if (fragment != null) {
 872                      fragment.getPrefs();
 873                      fragment.refreshList();
 874                  }
 875  
 876                  break;
 877              case Simplenote.INTENT_EDIT_NOTE:
 878                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 879                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 880                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 881                          if (noteId != null) {
 882                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 883                              deletedNoteIds.add(noteId);
 884                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 885                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 886                          }
<abbr title=" 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 888                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 889                          mNoteListFragment.setNoteSelected(selectedNoteId);
 890                          if (mNoteEditorFragment != null) {
 891                              mNoteEditorFragment.setNote(selectedNoteId);
 892                          }
 893                      }
 894                  }
 895                  break;
 896              case Simperium.SIGNUP_SIGNIN_REQUEST:
 897                  invalidateOptionsMenu();
 898  
 899                  Simplenote app = (Simplenote) getApplication();
 900                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 901  
 902                  AnalyticsTracker.track(
 903                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 904                          AnalyticsTracker.CATEGORY_USER,
 905                          &quot;signed_in_from_login_activity&quot;
 906                  );
 907  
 908                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 909                      finish();
 910                  }
 911  
 912                  break;
 913          }
 914      }
 915  
 916      @Override
 917      public void onUndo() {
 918          if (mUndoBarController == null) return;
 919  
 920          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 921          if (deletedNoteIds != null) {
 922              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 923                  Note deletedNote;
 924                  try {
 925                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 926                  } catch (BucketObjectMissingException e) {
 927                      return;
 928                  }
 929                  if (deletedNote != null) {
 930                      deletedNote.setDeleted(false);
 931                      deletedNote.setModificationDate(Calendar.getInstance());
 932                      deletedNote.save();
 933                      NoteListFragment fragment = getNoteListFragment();
 934                      if (fragment != null) {
 935                          fragment.getPrefs();
 936                          fragment.refreshList();
 937                      }
 938                  }
 939              }
 940          }
 941      }
 942  
 943      @Override
 944      protected void onPostCreate(Bundle savedInstanceState) {
 945          super.onPostCreate(savedInstanceState);
 946          // Sync the toggle state after onRestoreInstanceState has occurred.
 947          mDrawerToggle.syncState();
 948      }
 949  
 950      @Override
 951      public void onConfigurationChanged(Configuration newConfig) {
 952          super.onConfigurationChanged(newConfig);
 953  
 954          mDrawerToggle.onConfigurationChanged(newConfig);
 955  
 956          if (DisplayUtils.isLargeScreen(this)) {
 957              mIsShowingMarkdown = false;
 958  
 959              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 960                  // Add the editor fragment
 961                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 963                  } else if (DisplayUtils.isLandscape(this)) {
 964                      addEditorFragment();
 965                  }
 966                  if (mNoteListFragment != null) {
 967                      mNoteListFragment.setActivateOnItemClick(true);
 968                      mNoteListFragment.setDividerVisible(true);
 969                  }
 970                  // Select the current note on a tablet
 971                  if (mCurrentNote != null)
 972                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 973                  else {
 974                      mNoteEditorFragment.setPlaceholderVisible(true);
 975                      mNoteListFragment.getListView().clearChoices();
 976                  }
 977                  invalidateOptionsMenu();
 978              }
 979          }
 980  
 981          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 982              // Remove the editor fragment when rotating back to portrait
 983              mCurrentNote = null;
 984              if (mNoteListFragment != null) {
 985                  mNoteListFragment.setActivateOnItemClick(false);
 986                  mNoteListFragment.setDividerVisible(false);
 987                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 988                  mNoteListFragment.refreshList();
 989              }
 990              FragmentManager fm = getSupportFragmentManager();
 991              FragmentTransaction ft = fm.beginTransaction();
 992              ft.remove(mNoteEditorFragment);
 993              mNoteEditorFragment = null;
 994              ft.commitAllowingStateLoss();
 995              fm.executePendingTransactions();
 996              invalidateOptionsMenu();
 997          }
 998      }
 999  
1000      public void checkEmptyListText(boolean isSearch) {
1001          if (isSearch) {
<abbr title="1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1003              getNoteListFragment().setEmptyListViewClickable(false);
1004          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1006              AnalyticsTracker.track(
1007                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1008                      AnalyticsTracker.CATEGORY_NOTE,
1009                      &quot;trash_filter_selected&quot;
1010              );
1011              getNoteListFragment().setEmptyListViewClickable(false);
1012          } else {
<abbr title="1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1014              getNoteListFragment().setEmptyListViewClickable(true);
1015          }
1016      }
1017  
1018      public void showDetailPlaceholder() {
1019          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1020              mCurrentNote = null;
1021              mNoteEditorFragment.setPlaceholderVisible(true);
1022              mNoteEditorFragment.clearMarkdown();
1023              mNoteEditorFragment.hideMarkdown();
1024              mIsShowingMarkdown = false;
1025          }
1026      }
1027  
1028      public void stopListeningToNotesBucket() {
1029          mNotesBucket.removeOnNetworkChangeListener(this);
1030          mNotesBucket.removeOnSaveObjectListener(this);
1031          mNotesBucket.removeOnDeleteObjectListener(this);
1032      }
1033  
1034      // Returns the appropriate view to show the undo bar within
1035      private View getUndoView() {
1036          View undoView = mFragmentsContainer;
1037          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1038                  getNoteListFragment() != null &amp;&amp;
1039                  getNoteListFragment().getRootView() != null) {
1040              undoView = getNoteListFragment().getRootView();
1041          }
1042  
1043          return undoView;
1044      }
1045  
1046      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1047          if (mUndoBarController != null) {
1048              mUndoBarController.setDeletedNoteIds(noteIds);
1049              mUndoBarController.showUndoBar(
1050                      getUndoView(),
1051                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1052              );
1053          }
1054      }
1055  
1056      /* Simperium Bucket Listeners */
1057      // received a change from the network, refresh the list
1058      @Override
1059      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1060          runOnUiThread(new Runnable() {
1061              @Override
1062              public void run() {
1063                  if (type == Bucket.ChangeType.INDEX) {
1064                      setToolbarProgressVisibility(false);
1065                  }
1066                  mNoteListFragment.refreshList();
1067              }
1068          });
1069      }
1070  
1071      @Override
1072      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1073          runOnUiThread(new Runnable() {
1074              @Override
1075              public void run() {
1076                  mNoteListFragment.refreshList();
1077              }
1078          });
1079      }
1080  
1081      @Override
1082      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1083          runOnUiThread(new Runnable() {
1084              @Override
1085              public void run() {
1086                  mNoteListFragment.refreshList();
1087              }
1088          });
1089      }
1090  
1091      @Override
1092      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1093          // noop, NoteEditorFragment will handle this
1094      }
1095  
1096      /* The click listener for ListView in the navigation drawer */
1097      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1098          @Override
1099          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1100  
1101              // Adjust for header view
1102              position -= mDrawerList.getHeaderViewsCount();
1103              mSelectedTag = mTagsAdapter.getItem(position);
1104              checkEmptyListText(false);
1105              // Update checked item in navigation drawer and close it
1106              setSelectedTagActive();
1107              mDrawerLayout.closeDrawer(mNavigationView);
1108              updateNavigationDrawerItems();
1109  
1110              // Disable long press on notes if we&#x27;re viewing the trash
1111              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1112                  getNoteListFragment().getListView().setLongClickable(false);
1113              } else {
1114                  getNoteListFragment().getListView().setLongClickable(true);
1115              }
1116  
1117              getNoteListFragment().refreshListFromNavSelect();
1118              if (position &gt; 1) {
1119                  AnalyticsTracker.track(
1120                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1121                          AnalyticsTracker.CATEGORY_TAG,
1122                          &quot;selected_tag_in_navigation_drawer&quot;
1123                  );
1124              }
1125          }
1126      }
1127  
1128      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1129  
1130          @Override
1131          protected Void doInBackground(Void... voids) {
1132              if (mNotesBucket == null) return null;
1133  
1134              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1135              Bucket.ObjectCursor c = query.execute();
1136              while (c.moveToNext()) {
1137                  c.getObject().delete();
1138              }
1139  
1140              return null;
1141          }
1142  
1143          @Override
1144          protected void onPostExecute(Void nada) {
1145              showDetailPlaceholder();
1146          }
1147      }
1148  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import android.annotation.SuppressLint;</span>
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.content.SharedPreferences;
   9  import android.content.res.Configuration;
  10  import android.os.AsyncTask;
  11  import android.os.Build;
  12  import android.os.Bundle;
  13  import android.os.Handler;
  14  import android.support.design.widget.NavigationView;
  15  import android.support.v4.app.FragmentManager;
  16  import android.support.v4.app.FragmentTransaction;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -import android.support.v4.content.ContextCompat;</span>
  18  import android.support.v4.view.GravityCompat;
  19  import android.support.v4.widget.DrawerLayout;
  20  import android.support.v7.app.ActionBar;
  21  import android.support.v7.app.ActionBarDrawerToggle;
  22  import android.support.v7.app.AppCompatActivity;
  23  import android.support.v7.preference.PreferenceManager;
  24  import android.support.v7.widget.SearchView;
  25  import android.support.v7.widget.Toolbar;
  26  import android.text.Spannable;
  27  import android.text.SpannableString;
  28  import android.text.TextUtils;
  29  import android.view.Menu;
  30  import android.view.MenuInflater;
  31  import android.view.MenuItem;
  32  import android.view.View;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import android.view.WindowManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import android.view.WindowInsets;</span>
  35  import android.widget.AdapterView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import android.widget.LinearLayout;</span>
  37  import android.widget.ListView;
  38  import android.widget.ProgressBar;
  39  
  40  import com.automattic.simplenote.analytics.AnalyticsTracker;
  41  import com.automattic.simplenote.models.Note;
  42  import com.automattic.simplenote.models.Tag;
  43  import com.automattic.simplenote.utils.DisplayUtils;
  44  import com.automattic.simplenote.utils.DrawableUtils;
  45  import com.automattic.simplenote.utils.HtmlCompat;
  46  import com.automattic.simplenote.utils.PrefUtils;
  47  import com.automattic.simplenote.utils.StrUtils;
  48  import com.automattic.simplenote.utils.TagsAdapter;
  49  import com.automattic.simplenote.utils.ThemeUtils;
  50  import com.automattic.simplenote.utils.UndoBarController;
  51  import com.automattic.simplenote.widgets.TypefaceSpan;
  52  import com.simperium.Simperium;
  53  import com.simperium.client.Bucket;
  54  import com.simperium.client.BucketObjectMissingException;
  55  import com.simperium.client.BucketObjectNameInvalid;
  56  import com.simperium.client.Query;
  57  import com.simperium.client.User;
  58  
  59  import org.wordpress.passcodelock.AppLockManager;
  60  
  61  import java.util.ArrayList;
  62  import java.util.Calendar;
  63  import java.util.List;
  64  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +import static com.automattic.simplenote.NoteWidget.KEY_WIDGET_CLICK;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +import static com.automattic.simplenote.analytics.AnalyticsTracker.CATEGORY_WIDGET;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +import static com.automattic.simplenote.analytics.AnalyticsTracker.Stat.NOTE_WIDGET_SIGN_IN_TAPPED;</span>
  68  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  69  
  70  public class NotesActivity extends AppCompatActivity implements
<abbr title="  71          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  71          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  72          Bucket.Listener&lt;Note&gt; {
  73  
  74      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  75      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  76      protected Bucket&lt;Note&gt; mNotesBucket;
  77      protected Bucket&lt;Tag&gt; mTagsBucket;
  78      private int TRASH_SELECTED_ID = 1;
  79      private boolean mIsShowingMarkdown;
  80      private boolean mShouldSelectNewNote;
  81  
  82      private String mTabletSearchQuery;
  83      private UndoBarController mUndoBarController;
  84      private View mFragmentsContainer;
  85      private SearchView mSearchView;
  86      private MenuItem mSearchMenuItem;
  87      private NoteListFragment mNoteListFragment;
  88      private NoteEditorFragment mNoteEditorFragment;
  89      private Note mCurrentNote;
  90      private MenuItem mEmptyTrashMenuItem;
  91  
  92      // Menu drawer
  93      private DrawerLayout mDrawerLayout;
  94      private ListView mDrawerList;
  95      private NavigationView mNavigationView;
  96      private ActionBarDrawerToggle mDrawerToggle;
  97      private TagsAdapter mTagsAdapter;
  98      private TagsAdapter.TagMenuItem mSelectedTag;
  99      // Tags bucket listener
 100      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 101          void updateNavigationDrawer() {
 102              runOnUiThread(new Runnable() {
 103                  public void run() {
 104                      updateNavigationDrawerItems();
 105                  }
 106              });
 107          }
 108  
 109          @Override
 110          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 111              updateNavigationDrawer();
 112          }
 113  
 114          @Override
 115          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 116              updateNavigationDrawer();
 117          }
 118  
 119          @Override
 120          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 121              updateNavigationDrawer();
 122          }
 123  
 124          @Override
 125          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 126              // noop
 127          }
 128      };
 129  
 130      @Override
 131      protected void onCreate(Bundle savedInstanceState) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        // On lollipop, configure the translucent status bar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        }</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
 138          ThemeUtils.setTheme(this);
 139          super.onCreate(savedInstanceState);
 140  
 141          setContentView(R.layout.activity_notes);
 142  
 143          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 144  
 145          Simplenote currentApp = (Simplenote) getApplication();
 146          if (mNotesBucket == null) {
 147              mNotesBucket = currentApp.getNotesBucket();
 148          }
 149  
 150          if (mTagsBucket == null) {
 151              mTagsBucket = currentApp.getTagsBucket();
 152          }
 153  
 154          Toolbar toolbar = findViewById(R.id.toolbar);
 155          setSupportActionBar(toolbar);
 156          configureNavigationDrawer(toolbar);
 157  
 158          if (savedInstanceState == null) {
 159              mNoteListFragment = new NoteListFragment();
 160              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 161              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 162              fragmentTransaction.commit();
 163          } else {
 164              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 165          }
 166  
 167          if (DisplayUtils.isLargeScreen(this)) {
 168              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 169                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 169                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 170              } else if (DisplayUtils.isLandscape(this)) {
 171                  addEditorFragment();
 172              }
 173          }
 174  
 175          // enable ActionBar app icon to behave as action to toggle nav drawer
 176          ActionBar actionBar = getSupportActionBar();
 177          if (actionBar != null) {
 178              actionBar.setDisplayHomeAsUpEnabled(true);
 179              actionBar.setHomeButtonEnabled(true);
 180  
 181              // Add loading indicator to show when indexing
<abbr title=" 182              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 182              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 183              actionBar.setDisplayShowCustomEnabled(true);
 184              actionBar.setCustomView(progressBar);
 185              setToolbarProgressVisibility(false);
 186          }
 187  
 188          mUndoBarController = new UndoBarController(this);
 189  
 190          // Creates &#x27;Welcome&#x27; note
 191          checkForFirstLaunch();
 192  
 193          checkForSharedContent();
 194  
 195          currentApp.getSimperium().setOnUserCreatedListener(this);
 196          currentApp.getSimperium().setUserStatusChangeListener(this);
 197      }
 198  
 199      @Override
 200      protected void onResume() {
 201          super.onResume();
 202  
 203          // Ensure user has valid authorization
 204          if (userAuthenticationIsInvalid()) {
 205              startLoginActivity(true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +            Intent intent = getIntent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +            if (intent.hasExtra(KEY_WIDGET_CLICK) &amp;&amp; intent.getExtras() != null &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +                intent.getExtras().getSerializable(KEY_WIDGET_CLICK) == NOTE_WIDGET_SIGN_IN_TAPPED) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +                AnalyticsTracker.track(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +                    NOTE_WIDGET_SIGN_IN_TAPPED,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +                    CATEGORY_WIDGET,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +                    &quot;note_widget_sign_in_tapped&quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +                );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +            }</span>
 216          }
 217  
 218          disableScreenshotsIfLocked(this);
 219  
 220          mNotesBucket.start();
 221          mTagsBucket.start();
 222  
 223          mNotesBucket.addOnNetworkChangeListener(this);
 224          mNotesBucket.addOnSaveObjectListener(this);
 225          mNotesBucket.addOnDeleteObjectListener(this);
 226          mTagsBucket.addListener(mTagsMenuUpdater);
 227  
 228          updateNavigationDrawerItems();
 229  
 230          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 231          if (userIsUnauthorized()) {
 232              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 233                  mSelectedTag = null;
 234                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 235              }
 236          }
 237  
 238          setSelectedTagActive();
 239  
 240          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 241              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 242              mShouldSelectNewNote = false;
 243          }
 244  
 245          if (mIsShowingMarkdown) {
 246              setMarkdownShowing(false);
 247          }
 248  
 249      }
 250  
 251      @Override
 252      protected void onPause() {
 253          super.onPause();  // Always call the superclass method first
 254          mTagsBucket.removeListener(mTagsMenuUpdater);
 255          mTagsBucket.stop();
 256  
 257          mNotesBucket.removeOnNetworkChangeListener(this);
 258          mNotesBucket.removeOnSaveObjectListener(this);
 259          mNotesBucket.removeOnDeleteObjectListener(this);
 260          mNotesBucket.stop();
 261      }
 262  
 263      @Override
 264      public void setTitle(CharSequence title) {
 265          if (title == null) {
 266              title = &quot;&quot;;
 267          }
 268  
 269          setTitleWithCustomFont(title);
 270      }
 271  
 272      @Override
 273      public void onBackPressed() {
 274          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 275              mDrawerLayout.closeDrawer(GravityCompat.START);
 276          } else {
 277              super.onBackPressed();
 278          }
 279      }
 280  
 281      private void setTitleWithCustomFont(CharSequence title) {
 282          if (getSupportActionBar() == null) return;
 283  
 284          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 285          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 286                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 287              getSupportActionBar().setTitle(title);

 288              return;
 289          }
 290  
 291          SpannableString s = new SpannableString(title);
 292          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 293          getSupportActionBar().setTitle(s);
 294      }
 295  
 296      private void configureNavigationDrawer(Toolbar toolbar) {
 297          mDrawerLayout = findViewById(R.id.drawer_layout);
 298          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 299          mNavigationView = findViewById(R.id.navigation_view);
 300          mDrawerList = findViewById(R.id.drawer_list);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +            mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                @SuppressLint(&quot;NewApi&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +                    LinearLayout drawerView = findViewById(R.id.drawer_view);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +                    drawerView.setPadding(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                            drawerView.getPaddingLeft(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                            windowInsets.getSystemWindowInsetTop(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +                            drawerView.getPaddingRight(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +                            drawerView.getPaddingBottom());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +                    return windowInsets.consumeSystemWindowInsets();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +        }</span>
 318  
 319          View settingsButton = findViewById(R.id.nav_settings);
 320          settingsButton.setOnClickListener(new View.OnClickListener() {
 321              @Override
 322              public void onClick(View v) {
 323                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 324                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 325              }
 326          });
 327  
 328          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 329          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 330          mDrawerList.setAdapter(mTagsAdapter);
 331          // Set the list&#x27;s click listener
 332          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 333  
 334          if (mSelectedTag == null)
 335              mSelectedTag = mTagsAdapter.getDefaultItem();
 336  
 337          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 338                  R.string.close_drawer) {
 339              public void onDrawerClosed(View view) {
 340                  supportInvalidateOptionsMenu();
 341              }
 342  
 343              public void onDrawerOpened(View drawerView) {
 344                  // noop
 345              }
 346  
 347              @Override
 348              public void onDrawerSlide(View drawerView, float slideOffset) {
 349                  super.onDrawerSlide(drawerView, 0f);
 350              }
 351          };
 352  
 353          mDrawerLayout.addDrawerListener(mDrawerToggle);
 354      }
 355  
 356      private void checkForFirstLaunch() {
 357          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 358              // Create the welcome note
 359              try {
 360                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 361                  welcomeNote.setCreationDate(Calendar.getInstance());
 362                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 363                  welcomeNote.setContent(getString(R.string.welcome_note));
 364                  welcomeNote.getTitle();
 365                  welcomeNote.save();
 366              } catch (BucketObjectNameInvalid e) {
 367                  // this won&#x27;t happen because welcome-android is a valid name
 368              }
 369  
 370              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 371              SharedPreferences.Editor editor = preferences.edit();
 372              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 373              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 374              editor.apply();
 375          }
 376      }
 377  
 378      private void checkForSharedContent() {
 379          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 380              // Check share action
 381              Intent intent = getIntent();
 382              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 383              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 384  
 385              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 386              String intentAction = StrUtils.notNullStr(intent.getAction());
 387              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 388              if (!TextUtils.isEmpty(text)) {
 389                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 390                      text = subject + &quot;\n\n&quot; + text;
 391                  }
 392                  Note note = mNotesBucket.newObject();
 393                  note.setCreationDate(Calendar.getInstance());
 394                  note.setModificationDate(note.getCreationDate());
 395                  note.setContent(text);
 396                  note.save();
 397                  setCurrentNote(note);
 398                  mShouldSelectNewNote = true;
 399  
 400                  AnalyticsTracker.track(
 401                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 402                          AnalyticsTracker.CATEGORY_NOTE,
 403                          &quot;external_share&quot;
 404                  );
 405  
 406                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 407                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 408                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 409                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 410                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 411                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 412                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 413                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 414                      }
 415                  }
 416              }
 417          }
 418      }
 419  
 420      private void updateNavigationDrawerItems() {
 421          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 422          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 423          if (isAlphaSort) {
 424              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 425          } else {
 426              tagCursor = Tag.allWithName(mTagsBucket).execute();
 427          }
 428  
 429          mTagsAdapter.changeCursor(tagCursor);
 430      }
 431  
 432      private void setSelectedTagActive() {
 433          if (mSelectedTag == null)
 434              mSelectedTag = mTagsAdapter.getDefaultItem();
 435  
 436          setTitle(mSelectedTag.name);
<abbr title=" 437          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 437          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 438      }
 439  
 440      public TagsAdapter.TagMenuItem getSelectedTag() {
 441          if (mSelectedTag == null) {
 442              mSelectedTag = mTagsAdapter.getDefaultItem();
 443          }
 444  
 445          return mSelectedTag;
 446      }
 447  
 448      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 449      public void updateTrashMenuItem() {
 450          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 451              return;
 452  
 453          // Disable the trash icon if there are no notes trashed.
 454          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 455          if (query.count() == 0) {
 456              mEmptyTrashMenuItem.setEnabled(false);
 457          } else {
 458              mEmptyTrashMenuItem.setEnabled(true);
 459          }
 460      }
 461  
 462      private void addEditorFragment() {
 463          FragmentManager fm = getSupportFragmentManager();
 464          FragmentTransaction ft = fm.beginTransaction();
 465          mNoteEditorFragment = new NoteEditorFragment();
 466          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 467          ft.commitAllowingStateLoss();
 468          fm.executePendingTransactions();
 469      }
 470  
 471      private boolean userAccountRequired() {
 472          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 473      }
 474  
 475      /**
 476       * Checks for a previously valid user that is now not authenticated
 477       * Also checks if user account is required (added in version 1.5.6)
 478       *
 479       * @return true if user has invalid authorization
 480       */
 481      private boolean userAuthenticationIsInvalid() {
 482          Simplenote currentApp = (Simplenote) getApplication();
 483          Simperium simperium = currentApp.getSimperium();
 484          User user = simperium.getUser();
 485          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 486          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 487                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 488      }
 489  
 490      public boolean userIsUnauthorized() {
 491          Simplenote currentApp = (Simplenote) getApplication();
 492          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 493      }
 494  
 495      public void setCurrentNote(Note note) {
 496          mCurrentNote = note;
 497      }
 498  
 499      public NoteListFragment getNoteListFragment() {
 500          return mNoteListFragment;
 501      }
 502  
 503      @SuppressWarnings(&quot;ResourceType&quot;)
 504      @Override
 505      public boolean onCreateOptionsMenu(Menu menu) {
 506          super.onCreateOptionsMenu(menu);
 507          MenuInflater inflater = getMenuInflater();
 508          inflater.inflate(R.menu.notes_list, menu);
 509  
 510          // restore the search query if on a landscape tablet
 511          String searchQuery = null;
 512          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 513              searchQuery = mSearchView.getQuery().toString();
 514  
 515          mSearchMenuItem = menu.findItem(R.id.menu_search);
 516          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 517  
 518          if (!TextUtils.isEmpty(searchQuery)) {
 519              mSearchView.setQuery(searchQuery, false);
 520              mSearchMenuItem.expandActionView();
 521          } else {
 522              // Workaround for setting the search placeholder text color
 523              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -                    getString(R.color.simplenote_light_grey) :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -                    getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 526 +                    getString(R.color.gray_light) :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 527 +                    getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
 528              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 529                      hintHexColor,
 530                      getString(R.string.search))));
 531          }
 532  
 533          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 534              @Override
 535              public boolean onQueryTextChange(String newText) {
 536                  if (mSearchMenuItem.isActionViewExpanded()) {
 537                      getNoteListFragment().searchNotes(newText);
 538                  }
 539                  return true;
 540              }
 541  
 542              @Override
 543              public boolean onQueryTextSubmit(String queryText) {
 544                  getNoteListFragment().searchNotes(queryText);
 545                  return true;
 546              }
 547  
 548          });
 549  
 550          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 551              @Override
 552              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 553                  checkEmptyListText(true);
 554                  if (mNoteListFragment != null) {
 555                      mNoteListFragment.setFloatingActionButtonVisible(false);
 556                  }
 557                  AnalyticsTracker.track(
 558                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 559                          AnalyticsTracker.CATEGORY_NOTE,
 560                          &quot;action_bar_search_tap&quot;
 561                  );
 562                  return true;
 563              }
 564  
 565              @Override
 566              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 567                  // Show all notes again
 568                  if (mNoteListFragment != null) {
 569                      mNoteListFragment.setFloatingActionButtonVisible(true);
 570                  }
 571                  mTabletSearchQuery = &quot;&quot;;
 572                  mSearchView.setQuery(&quot;&quot;, false);
 573                  checkEmptyListText(false);
 574                  getNoteListFragment().clearSearch();
 575                  return true;
 576              }
 577          });
 578  
 579          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 580              @Override
 581              public boolean onMenuItemClick(MenuItem item) {
 582                  if (!mSearchMenuItem.isActionViewExpanded())
 583                      showDetailPlaceholder();
 584                  return false;
 585              }
 586          });
 587  
 588          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 589          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 590              trashItem.setTitle(R.string.undelete);
 591              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 592          } else {
 593              trashItem.setTitle(R.string.delete);
 594              trashItem.setIcon(R.drawable.ic_trash_24dp);
 595          }
 596  
 597          if (DisplayUtils.isLargeScreenLandscape(this)) {
 598              // Restore the search query on landscape tablets
 599              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 600                  mSearchMenuItem.expandActionView();
 601                  mSearchView.setQuery(mTabletSearchQuery, false);
 602                  mSearchView.clearFocus();
 603              }
 604  
 605              if (mCurrentNote != null) {
 606                  menu.findItem(R.id.menu_share).setVisible(true);
 607                  menu.findItem(R.id.menu_view_info).setVisible(true);
 608                  menu.findItem(R.id.menu_checklist).setVisible(true);
 609                  menu.findItem(R.id.menu_history).setVisible(true);
 610                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 611                  trashItem.setVisible(true);
 612              } else {
 613                  menu.findItem(R.id.menu_share).setVisible(false);
 614                  menu.findItem(R.id.menu_view_info).setVisible(false);
 615                  menu.findItem(R.id.menu_checklist).setVisible(false);
 616                  menu.findItem(R.id.menu_history).setVisible(false);
 617                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 618                  trashItem.setVisible(false);
 619              }
 620              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 621          } else {
 622              menu.findItem(R.id.menu_search).setVisible(true);
 623              menu.findItem(R.id.menu_share).setVisible(false);
 624              menu.findItem(R.id.menu_view_info).setVisible(false);
 625              menu.findItem(R.id.menu_checklist).setVisible(false);
 626              menu.findItem(R.id.menu_history).setVisible(false);
 627              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 628              trashItem.setVisible(false);
 629              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 630          }
 631  
 632          // Are we looking at the trash? Adjust menu accordingly.
 633          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 634              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 635              mEmptyTrashMenuItem.setVisible(true);
 636  
 637              updateTrashMenuItem();
 638  
 639              menu.findItem(R.id.menu_search).setVisible(false);
 640              menu.findItem(R.id.menu_share).setVisible(false);
 641              menu.findItem(R.id.menu_history).setVisible(false);
 642              menu.findItem(R.id.menu_checklist).setVisible(false);
 643          }
 644  
 645          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 646  
 647          return true;
 648      }
 649  
 650      @Override
 651      public boolean onOptionsItemSelected(MenuItem item) {
 652          if (mDrawerToggle.onOptionsItemSelected(item)) {
 653              return true;
 654          }
 655          switch (item.getItemId()) {
 656              case R.id.menu_markdown_preview:
 657                  if (mIsShowingMarkdown) {
 658                      item.setIcon(R.drawable.ic_preview_24dp);
 659                      item.setTitle(getString(R.string.markdown_show));
 660                      setMarkdownShowing(false);
 661                  } else {
 662                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 663                      item.setTitle(getString(R.string.markdown_hide));
 664                      setMarkdownShowing(true);
 665                  }
 666  
 667                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 668  
 669                  return true;
 670              case R.id.menu_delete:
 671                  if (mNoteEditorFragment != null) {
 672                      if (mCurrentNote != null) {
 673                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 674                          mCurrentNote.setModificationDate(Calendar.getInstance());
 675                          mCurrentNote.save();
 676  
 677                          updateViewsAfterTrashAction(mCurrentNote);
 678                      }
 679                  }
 680                  return true;
 681              case R.id.menu_empty_trash:
 682                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 683  
 684                  alert.setTitle(R.string.empty_trash);
 685                  alert.setMessage(R.string.confirm_empty_trash);
 686                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 687                      public void onClick(DialogInterface dialog, int whichButton) {
 688                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 689                          AnalyticsTracker.track(
 690                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 691                                  AnalyticsTracker.CATEGORY_NOTE,
 692                                  &quot;overflow_menu&quot;
 693                          );
 694                      }
 695                  });
 696                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 697                      public void onClick(DialogInterface dialog, int whichButton) {
 698                          // Do nothing, just closing the dialog
 699                      }
 700                  });
 701                  alert.show();
 702                  return true;
 703              case android.R.id.home:
 704                  invalidateOptionsMenu();
 705                  return true;
 706              default:
 707                  return super.onOptionsItemSelected(item);
 708          }
 709      }
 710  
 711      @Override
 712      public boolean onPrepareOptionsMenu(Menu menu) {
 713          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 714  
 715          if (mIsShowingMarkdown) {
 716              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 717              markdownItem.setTitle(getString(R.string.markdown_hide));
 718          } else {
 719              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 720              markdownItem.setTitle(getString(R.string.markdown_show));
 721          }
 722  
 723          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 724  
 725          return super.onPrepareOptionsMenu(menu);
 726      }
 727  
 728      public void updateViewsAfterTrashAction(Note note) {
 729          if (note == null || isFinishing()) {
 730              return;
 731          }
 732  
 733          if (note.isDeleted()) {
 734              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 735              deletedNoteIds.add(note.getSimperiumKey());
 736              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 737              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 738              AnalyticsTracker.track(
 739                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 740                      AnalyticsTracker.CATEGORY_NOTE,
 741                      &quot;overflow_menu&quot;
 742              );
 743          } else {
 744              AnalyticsTracker.track(
 745                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 746                      AnalyticsTracker.CATEGORY_NOTE,
 747                      &quot;overflow_menu&quot;
 748              );
 749          }
 750  
 751          // If we just deleted/restored the active note, show the placeholder
 752          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 753              showDetailPlaceholder();
 754          }
 755  
 756          NoteListFragment fragment = getNoteListFragment();
 757          if (fragment != null) {
 758              fragment.getPrefs();
 759              fragment.refreshList();
 760          }
 761  
 762          invalidateOptionsMenu();
 763      }
 764  
 765      public void setMarkdownShowing(boolean isMarkdownShowing) {
 766          mIsShowingMarkdown = isMarkdownShowing;
 767          if (mNoteEditorFragment != null) {
 768              if (isMarkdownShowing) {
 769                  mNoteEditorFragment.showMarkdown();
 770              } else {
 771                  mNoteEditorFragment.hideMarkdown();
 772              }
 773          }
 774          invalidateOptionsMenu();
 775      }
 776  
 777      /**
 778       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 779       * the item with the given ID was selected. Used for tablets only.
 780       */
 781      @Override
 782      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 783          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 784              // Launch the editor activity
 785              Bundle arguments = new Bundle();
 786              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 787              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 788  
 789              if (matchOffsets != null)
 790                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 791  
 792              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 793              editNoteIntent.putExtras(arguments);
 794              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 795          } else {
 796              mNoteEditorFragment.setNote(noteID, matchOffsets);
 797              getNoteListFragment().setNoteSelected(noteID);
 798  
 799              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 800                  mTabletSearchQuery = mSearchView.getQuery().toString();
 801              }
 802  
 803              mNoteEditorFragment.clearMarkdown();
 804  
 805              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 806                  setMarkdownShowing(false);
 807              }
 808  
 809              invalidateOptionsMenu();
 810          }
 811  
 812          AnalyticsTracker.track(
 813                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 814                  AnalyticsTracker.CATEGORY_NOTE,
 815                  &quot;note_list_row_tap&quot;
 816          );
 817      }
 818  
 819      @Override
 820      public void onUserCreated(User user) {
 821          // New account created
 822          AnalyticsTracker.track(
 823                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 824                  AnalyticsTracker.CATEGORY_USER,
 825                  &quot;account_created_from_login_activity&quot;
 826          );
 827      }
 828  
 829      public void onUserStatusChange(User.Status status) {
 830          switch (status) {
 831              // successfully used access token to connect to simperium bucket
 832              case AUTHORIZED:
 833                  runOnUiThread(new Runnable() {
 834                      @Override
 835                      public void run() {
 836                          if (!mNotesBucket.hasChangeVersion()) {
 837                              setToolbarProgressVisibility(true);
 838                          }
 839                      }
 840                  });
 841                  break;
 842  
 843              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 844              case NOT_AUTHORIZED:
 845                  runOnUiThread(new Runnable() {
 846                      @Override
 847                      public void run() {
 848                          startLoginActivity(true);
 849                      }
 850                  });
 851                  break;
 852  
<abbr title=" 853              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 853              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 854              case UNKNOWN:
 855                  break;
 856          }
 857      }
 858  
 859      private void setToolbarProgressVisibility(boolean isVisible) {
 860          if (getSupportActionBar() != null) {
 861              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 862          }
 863      }
 864  
 865      public void startLoginActivity(boolean signInFirst) {
 866          // Clear some account-specific prefs
 867          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 868          editor.remove(PrefUtils.PREF_WP_TOKEN);
 869          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 870          editor.apply();
 871  
 872          Intent loginIntent = new Intent(this, SignInActivity.class);
 873          if (signInFirst) {
 874              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 875          }
 876          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 877      }
 878  
 879      @Override
 880      public void recreate() {
 881          Handler handler = new Handler();
 882          handler.post(new Runnable() {
 883              @Override
 884              public void run() {
 885                  NotesActivity.super.recreate();
 886              }
 887          });
 888      }
 889  
 890      @Override
 891      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 892          super.onActivityResult(requestCode, resultCode, data);
 893          switch (requestCode) {
 894              case Simplenote.INTENT_PREFERENCES:
 895                  if (ThemeUtils.themeWasChanged(data)) {
 896                      // Restart this activity to apply the new theme
 897                      recreate();
 898                      break;
 899                  }
<abbr title=" 900                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 900                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 901                  invalidateOptionsMenu();
 902                  NoteListFragment fragment = getNoteListFragment();
 903                  if (fragment != null) {
 904                      fragment.getPrefs();
 905                      fragment.refreshList();
 906                  }
 907  
 908                  break;
 909              case Simplenote.INTENT_EDIT_NOTE:
 910                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 911                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 912                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 913                          if (noteId != null) {
 914                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 915                              deletedNoteIds.add(noteId);
 916                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 917                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 918                          }
<abbr title=" 919                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 919                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 920                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 921                          mNoteListFragment.setNoteSelected(selectedNoteId);
 922                          if (mNoteEditorFragment != null) {
 923                              mNoteEditorFragment.setNote(selectedNoteId);
 924                          }
 925                      }
 926                  }
 927                  break;
 928              case Simperium.SIGNUP_SIGNIN_REQUEST:
 929                  invalidateOptionsMenu();
 930  
 931                  Simplenote app = (Simplenote) getApplication();
 932                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 933  
 934                  AnalyticsTracker.track(
 935                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 936                          AnalyticsTracker.CATEGORY_USER,
 937                          &quot;signed_in_from_login_activity&quot;
 938                  );
 939  
 940                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 941                      finish();
 942                  }
 943  
 944                  break;
 945          }
 946      }
 947  
 948      @Override
 949      public void onUndo() {
 950          if (mUndoBarController == null) return;
 951  
 952          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 953          if (deletedNoteIds != null) {
 954              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 955                  Note deletedNote;
 956                  try {
 957                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 958                  } catch (BucketObjectMissingException e) {
 959                      return;
 960                  }
 961                  if (deletedNote != null) {
 962                      deletedNote.setDeleted(false);
 963                      deletedNote.setModificationDate(Calendar.getInstance());
 964                      deletedNote.save();
 965                      NoteListFragment fragment = getNoteListFragment();
 966                      if (fragment != null) {
 967                          fragment.getPrefs();
 968                          fragment.refreshList();
 969                      }
 970                  }
 971              }
 972          }
 973      }
 974  
 975      @Override
 976      protected void onPostCreate(Bundle savedInstanceState) {
 977          super.onPostCreate(savedInstanceState);
 978          // Sync the toggle state after onRestoreInstanceState has occurred.
 979          mDrawerToggle.syncState();
 980      }
 981  
 982      @Override
 983      public void onConfigurationChanged(Configuration newConfig) {
 984          super.onConfigurationChanged(newConfig);
 985  
 986          mDrawerToggle.onConfigurationChanged(newConfig);
 987  
 988          if (DisplayUtils.isLargeScreen(this)) {
 989              mIsShowingMarkdown = false;
 990  
 991              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 992                  // Add the editor fragment
 993                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 994                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 994                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 995                  } else if (DisplayUtils.isLandscape(this)) {
 996                      addEditorFragment();
 997                  }
 998                  if (mNoteListFragment != null) {
 999                      mNoteListFragment.setActivateOnItemClick(true);
1000                      mNoteListFragment.setDividerVisible(true);
1001                  }
1002                  // Select the current note on a tablet
1003                  if (mCurrentNote != null)
1004                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
1005                  else {
1006                      mNoteEditorFragment.setPlaceholderVisible(true);
1007                      mNoteListFragment.getListView().clearChoices();
1008                  }
1009                  invalidateOptionsMenu();
1010              }
1011          }
1012  
1013          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1014              // Remove the editor fragment when rotating back to portrait
1015              mCurrentNote = null;
1016              if (mNoteListFragment != null) {
1017                  mNoteListFragment.setActivateOnItemClick(false);
1018                  mNoteListFragment.setDividerVisible(false);
1019                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1020                  mNoteListFragment.refreshList();
1021              }
1022              FragmentManager fm = getSupportFragmentManager();
1023              FragmentTransaction ft = fm.beginTransaction();
1024              ft.remove(mNoteEditorFragment);
1025              mNoteEditorFragment = null;
1026              ft.commitAllowingStateLoss();
1027              fm.executePendingTransactions();
1028              invalidateOptionsMenu();
1029          }
1030      }
1031  
1032      public void checkEmptyListText(boolean isSearch) {
1033          if (isSearch) {
<abbr title="1034              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1034              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1035              getNoteListFragment().setEmptyListViewClickable(false);
1036          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1037              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1037              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1038              AnalyticsTracker.track(
1039                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1040                      AnalyticsTracker.CATEGORY_NOTE,
1041                      &quot;trash_filter_selected&quot;
1042              );
1043              getNoteListFragment().setEmptyListViewClickable(false);
1044          } else {
<abbr title="1045              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1045              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1046              getNoteListFragment().setEmptyListViewClickable(true);
1047          }
1048      }
1049  
1050      public void showDetailPlaceholder() {
1051          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1052              mCurrentNote = null;
1053              mNoteEditorFragment.setPlaceholderVisible(true);
1054              mNoteEditorFragment.clearMarkdown();
1055              mNoteEditorFragment.hideMarkdown();
1056              mIsShowingMarkdown = false;
1057          }
1058      }
1059  
1060      public void stopListeningToNotesBucket() {
1061          mNotesBucket.removeOnNetworkChangeListener(this);
1062          mNotesBucket.removeOnSaveObjectListener(this);
1063          mNotesBucket.removeOnDeleteObjectListener(this);
1064      }
1065  
1066      // Returns the appropriate view to show the undo bar within
1067      private View getUndoView() {
1068          View undoView = mFragmentsContainer;
1069          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1070                  getNoteListFragment() != null &amp;&amp;
1071                  getNoteListFragment().getRootView() != null) {
1072              undoView = getNoteListFragment().getRootView();
1073          }
1074  
1075          return undoView;
1076      }
1077  
1078      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1079          if (mUndoBarController != null) {
1080              mUndoBarController.setDeletedNoteIds(noteIds);
1081              mUndoBarController.showUndoBar(
1082                      getUndoView(),
1083                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1084              );
1085          }
1086      }
1087  
1088      /* Simperium Bucket Listeners */
1089      // received a change from the network, refresh the list
1090      @Override
1091      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1092          runOnUiThread(new Runnable() {
1093              @Override
1094              public void run() {
1095                  if (type == Bucket.ChangeType.INDEX) {
1096                      setToolbarProgressVisibility(false);
1097                  }
1098                  mNoteListFragment.refreshList();
1099              }
1100          });
1101      }
1102  
1103      @Override
1104      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1105          runOnUiThread(new Runnable() {
1106              @Override
1107              public void run() {
1108                  mNoteListFragment.refreshList();
1109              }
1110          });
1111      }
1112  
1113      @Override
1114      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1115          runOnUiThread(new Runnable() {
1116              @Override
1117              public void run() {
1118                  mNoteListFragment.refreshList();
1119              }
1120          });
1121      }
1122  
1123      @Override
1124      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1125          // noop, NoteEditorFragment will handle this
1126      }
1127  
1128      /* The click listener for ListView in the navigation drawer */
1129      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1130          @Override
1131          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1132  
1133              // Adjust for header view
1134              position -= mDrawerList.getHeaderViewsCount();
1135              mSelectedTag = mTagsAdapter.getItem(position);
1136              checkEmptyListText(false);
1137              // Update checked item in navigation drawer and close it
1138              setSelectedTagActive();
1139              mDrawerLayout.closeDrawer(mNavigationView);
1140              updateNavigationDrawerItems();
1141  
1142              // Disable long press on notes if we&#x27;re viewing the trash
1143              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1144                  getNoteListFragment().getListView().setLongClickable(false);
1145              } else {
1146                  getNoteListFragment().getListView().setLongClickable(true);
1147              }
1148  
1149              getNoteListFragment().refreshListFromNavSelect();
1150              if (position &gt; 1) {
1151                  AnalyticsTracker.track(
1152                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1153                          AnalyticsTracker.CATEGORY_TAG,
1154                          &quot;selected_tag_in_navigation_drawer&quot;
1155                  );
1156              }
1157          }
1158      }
1159  
1160      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1161  
1162          @Override
1163          protected Void doInBackground(Void... voids) {
1164              if (mNotesBucket == null) return null;
1165  
1166              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1167              Bucket.ObjectCursor c = query.execute();
1168              while (c.moveToNext()) {
1169                  c.getObject().delete();
1170              }
1171  
1172              return null;
1173          }
1174  
1175          @Override
1176          protected void onPostExecute(Void nada) {
1177              showDetailPlaceholder();
1178          }
1179      }
1180  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            