<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>212</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    212
                    <a href="211.html">prev</a>
                    <a href="213.html">next</a>
                    <a href="212_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_d0d1497e996c0cad318f85c45cd5046de4e2c6f9_Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;d0d1497e996c0cad318f85c45cd5046de4e2c6f9:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;d0d1497e996c0cad318f85c45cd5046de4e2c6f9^1:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;d0d1497e996c0cad318f85c45cd5046de4e2c6f9^2:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;11c2f60a601c737a58eee19c40a47e5c73be2873:Simplenote/src/main/java/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Dialog;
   5 import android.app.Fragment;
   6 import android.content.ClipData;
   7 import android.content.ClipboardManager;
   8 import android.content.Context;
   9 import android.content.Intent;
  10 import android.content.res.TypedArray;
  11 import android.database.Cursor;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.text.Editable;
  18 import android.text.SpannableString;
  19 import android.text.Spanned;
  20 import android.text.TextUtils;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.view.ActionMode;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.Window;
  33 import android.view.WindowManager;
  34 import android.view.inputmethod.InputMethodManager;
  35 import android.widget.Button;
  36 import android.widget.CursorAdapter;
  37 import android.widget.LinearLayout;
  38 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  39 import android.widget.TextView;
  40 import android.widget.Toast;
  41 import android.widget.ToggleButton;
  42 
  43 import com.automattic.simplenote.models.Note;
  44 import com.automattic.simplenote.models.Tag;
  45 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  46 import com.automattic.simplenote.utils.SimplenoteEditText;
  47 import com.automattic.simplenote.utils.SimplenoteLinkify;
  48 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  49 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  50 import com.automattic.simplenote.utils.TextHighlighter;
  51 import com.automattic.simplenote.utils.Typefaces;
  52 import com.google.analytics.tracking.android.EasyTracker;
  53 import com.google.analytics.tracking.android.Tracker;
  54 import com.simperium.client.Bucket;
  55 import com.simperium.client.BucketObjectMissingException;
  56 import com.simperium.client.Query;
  57 
  58 import java.util.Calendar;
  59 
<abbr title="  60 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  60 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddeðŸ”µ</abbr>
  61 
  62     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  63     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  64     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  65     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  66 
  67     private Note mNote;
  68     private Bucket&lt;Note&gt; mNotesBucket;
  69 
  70     private SimplenoteEditText mContentEditText;
  71     private TagsMultiAutoCompleteTextView mTagView;
  72     private ToggleButton mPinButton;
  73     private Handler mAutoSaveHandler;
  74     private LinearLayout mPlaceholderView;
  75     private Dialog mPublishDialog;
  76     private CursorAdapter mAutocompleteAdapter;
  77     private boolean mIsNewNote, mIsLoadingNote;
  78     private ActionMode mActionMode;
  79     private MenuItem mViewLinkMenuItem;
  80     private String mLinkUrl;
  81     private String mLinkText;
  82     private MatchOffsetHighlighter mHighlighter;
  83     private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  84     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  85     private String mMatchOffsets;
  86 
  87     /**
  88      * Mandatory empty constructor for the fragment manager to instantiate the
  89      * fragment (e.g. upon screen orientation changes).
  90      */
  91     public NoteEditorFragment() {
  92     }
  93 
  94     @Override
  95     public void onCreate(Bundle savedInstanceState) {
  96         super.onCreate(savedInstanceState);
  97 
  98         if (getActivity() != null) {
  99             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100             mNotesBucket = currentApp.getNotesBucket();
 101 
<abbr title=" 102             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 102             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 103             if (a != null) {
 104                 mEmailIconResId = a.getResourceId(0, 0);
 105                 mWebIconResId = a.getResourceId(1, 0);
 106                 mMapIconResId = a.getResourceId(2, 0);
 107                 mCallIconResId = a.getResourceId(3, 0);
 108                 a.recycle();
 109             }
 110         }
 111 
 112         mAutoSaveHandler = new Handler();
 113 
 114         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 115                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 115                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 116         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 117 
 118             @Override
 119             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 120                 Activity activity = (Activity) context;
 121                 if (activity == null) return null;
 122                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 123             }
 124 
 125             @Override
 126             public void bindView(View view, Context context, Cursor cursor) {
 127                 TextView textView = (TextView) view;
 128                 textView.setText(convertToString(cursor));
 129             }
 130 
 131             @Override
 132             public CharSequence convertToString(Cursor cursor){
 133                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 134             }
 135 
 136             @Override
 137             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 138                 Activity activity = getActivity();
 139                 if (activity == null) return null;
 140                 Simplenote application = (Simplenote) activity.getApplication();
 141                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 142                 // make the tag name available to the cursor
 143                 query.include(Tag.NAME_PROPERTY);
 144                 // sort the tags by their names
 145                 query.order(Tag.NAME_PROPERTY);
 146                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 147                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 147                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 148                 return query.execute();
 149             }
 150         };
 151     }
 152 
 153 
 154     @Override
 155     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 156         setHasOptionsMenu(true);
 157         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 158         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 159         if (getActivity() != null) {
<abbr title=" 160             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 160             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_ðŸ”µ</abbr>
 161         }
 162         mContentEditText.addOnSelectionChangedListener(this);
 163         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 164         mTagView.setTokenizer(new SpaceTokenizer());
 165         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 166         mTagView.setOnFocusChangeListener(this);
 167 
 168         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 169 
 170         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 171         mPinButton.setOnClickListener(new View.OnClickListener() {
 172             @Override
 173             public void onClick(View v) {
 174                 if (mPinButton.isChecked()) {
 175                     // Friendly message to the user as to what this button does.
 176                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 177                 }
 178             }
 179         });
 180 
 181         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<abbr title=" 182         if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 182         if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandðŸ”µ</abbr>
 183             mPlaceholderView.setVisibility(View.VISIBLE);
 184 
 185         mTagView.setAdapter(mAutocompleteAdapter);
 186 
 187         // Load note if we were passed a note Id
 188         Bundle arguments = getArguments();
 189         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 190             String key = arguments.getString(ARG_ITEM_ID);
 191             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 192                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 193             }
 194             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 195             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 196         }
 197 
 198 		return rootView;
 199 	}
 200 
 201     @Override
 202     public void onResume() {
 203         super.onResume();
 204         mNotesBucket.start();
 205         mNotesBucket.addListener(this);
 206 
 207         mTagView.setOnTagAddedListener(this);
 208 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210         Bundle arguments = getArguments();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214             if (arguments.containsKey(ARG_MATCH_OFFSETS))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         }</span>
 219 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         mNotesBucket.removeListener(this);</span>
 230 =======
 231 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 232     }
 233 
 234     @Override
 235     public void onPause() {
 236         mNotesBucket.removeListener(this);
 237         // Hide soft keyboard if it is showing...
 238         if (getActivity() != null) {
<abbr title=" 239             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 239             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 240             if (inputMethodManager != null) {
 241                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 242             }
 243         }
 244 
 245         // Delete the note if it is new and has empty fields
 246         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 247             mNote.delete();
 248         } else {
 249             saveNote();
 250         }
 251 
 252         mTagView.setOnTagAddedListener(null);
 253 
 254         if (mAutoSaveHandler != null) {
 255             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 256         }
 257 
 258         mHighlighter.stop();
 259 
 260         super.onPause();
 261     }
 262 
 263     @Override
 264     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 265         inflater.inflate(R.menu.note_editor, menu);
 266 
 267         if (mNote != null) {
 268             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_published_note);
 269             viewPublishedNoteItem.setVisible(true);
 270 
 271             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 272             if (mNote.isDeleted())
 273                 trashItem.setTitle(R.string.undelete);
 274             else
 275                 trashItem.setTitle(R.string.delete);
 276         }
 277 
 278         super.onCreateOptionsMenu(menu, inflater);
 279     }
 280 
 281     @Override
 282     public boolean onOptionsItemSelected(MenuItem item) {
 283         switch (item.getItemId()) {
 284             case R.id.menu_view_published_note:
 285                 if (mNote != null) {
 286                     showNotePublishDialog();
 287                 }
 288                 return true;
 289             case R.id.menu_share:
 290                 if (mNote != null) {
 291                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 292                     shareIntent.setType(&quot;text/plain&quot;);
 293                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 295                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);"> 295                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, ðŸ”µ</abbr>
 296                 }
 297                 return true;
 298             case R.id.menu_delete:
 299                 if (mNote != null) {
 300                     mNote.setDeleted(!mNote.isDeleted());
 301                     mNote.setModificationDate(Calendar.getInstance());
 302                     mNote.save();
 303                     Intent resultIntent = new Intent();
 304                     if (mNote.isDeleted())
 305                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 306                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 307                 }
 308                 getActivity().finish();
 309                 return true;
 310             case android.R.id.home:
 311                 getActivity().finish();
 312                 return true;
 313             default:
 314                 return super.onOptionsItemSelected(item);
 315         }
 316     }
 317 
 318     private void showNotePublishDialog() {
 319         if (mPublishDialog == null) {
 320             mPublishDialog = new Dialog(getActivity(), R.style.SimplenotePublishDialog);
 321             mPublishDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
 322             mPublishDialog.setContentView(R.layout.publish_settings);
 323 
<abbr title=" 324             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.WRAP_CONTENT);"> 324             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LðŸ”µ</abbr>
 325 
 326             Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 327             TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 328 
 329             publishButton.setOnClickListener(new View.OnClickListener() {
 330                 @Override
 331                 public void onClick(View v) {
 332                     if (mNote != null) {
 333                         Button button = (Button) v;
 334                         boolean newPublishedStatus = !mNote.isPublished();
 335                         mNote.setPublished(newPublishedStatus);
 336                         if (newPublishedStatus) {
 337                             button.setText(&quot;Publishing...&quot;);
 338                         } else {
 339                             button.setText(&quot;Publish&quot;);
 340                         }
 341                         mNote.save();
 342                     }
 343                 }
 344             });
 345 
 346             publishTextView.setOnClickListener(new View.OnClickListener() {
 347                 @Override
 348                 public void onClick(View v) {
 349                     TextView textView = (TextView) v;
<abbr title=" 350                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 350                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ContextðŸ”µ</abbr>
<abbr title=" 351                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText());"> 351                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText()ðŸ”µ</abbr>
 352                     clipboard.setPrimaryClip(clip);
<abbr title=" 353                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 353                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).shðŸ”µ</abbr>
 354                 }
 355             });
 356         } else if (mPublishDialog.isShowing()) {
 357             mPublishDialog.dismiss();
 358             return;
 359         }
 360 
 361         updatePublishDialogContent();
 362 
 363         mPublishDialog.show();
 364     }
 365 
 366     public void updatePublishDialogContent() {
 367         if (mPublishDialog == null || mNote == null)
 368             return;
 369         Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 370         TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 371 
 372         if (mNote.isPublished()) {
 373             publishButton.setText(&quot;Published&quot;);
 374             publishTextView.setTextColor(getResources().getColor(R.color.white));
 375             publishTextView.setText(mNote.getPublishedUrl());
 376         } else {
 377             publishButton.setText(&quot;Publish note&quot;);
 378             publishTextView.setTextColor(getResources().getColor(R.color.light_gray));
 379             publishTextView.setText(&quot;Note not published&quot;);
 380         }
 381 
 382     }
 383 
 384     private boolean noteIsEmpty() {
 385         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 386     }
 387 
 388     public void setNote(String noteID){
 389         setNote(noteID, null);
 390     }
 391 
 392     public void setNote(String noteID, String matchOffsets) {
 393         if (mAutoSaveHandler != null)
 394             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 395 
 396         mPlaceholderView.setVisibility(View.GONE);
 397 
 398         if (matchOffsets != null)
 399             mMatchOffsets = matchOffsets;
 400 
 401         // If we have a note already (on a tablet in landscape), save the note.
 402         if (mNote != null) {
 403             if (mIsNewNote &amp;&amp; noteIsEmpty())
 404                 mNote.delete();
 405             else if (mNote != null)
 406                 saveNote();
 407         }
 408 
 409         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 410     }
 411 
 412     public void updateNote(Note updatedNote) {
 413         // update note if network change arrived
 414         mNote = updatedNote;
 415         refreshContent(true);
 416     }
 417 
 418     public void refreshContent(boolean isNoteUpdate) {
 419         if (mNote != null) {
 420             // Restore the cursor position if possible.
 421 
<abbr title=" 422             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 422             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 423 
 424             mContentEditText.setText(mNote.getContent());
 425 
 426             if (isNoteUpdate) {
 427                 // Save the note so any local changes get synced
 428                 mNote.save();
 429 
<abbr title=" 430                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 430                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 431                     mContentEditText.setSelection(cursorPosition);
 432                 }
 433             }
 434 
 435             afterTextChanged(mContentEditText.getText());
 436 
 437             mPinButton.setChecked(mNote.isPinned());
 438 
 439             updateTagList();
 440         }
 441     }
 442 
 443     public void updateTagList() {
 444         Activity activity = getActivity();
 445         if (activity == null) return;
 446 
 447         // Populate this note&#x27;s tags in the tagView
 448         mTagView.setChips(mNote.getTagString());
 449     }
 450 
 451     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 452         // Ported from the iOS app :)
 453         // Cases:
 454         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 455         // 1. Text was added after the cursor ==&gt; no change
 456         // 2. Text was added before the cursor ==&gt; location advances
 457         // 3. Text was removed after the cursor ==&gt; no change
 458         // 4. Text was removed before the cursor ==&gt; location retreats
 459         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 460 
 461         int newCursorLocation = cursorLocation;
 462 
 463         int deltaLength = newText.length() - oldText.length();
 464 
 465         // Case 0
 466         if (newText.length() &lt; cursorLocation)
 467             return newText.length();
 468 
 469         boolean beforeCursorMatches = false;
 470         boolean afterCursorMatches = false;
 471 
 472         try {
<abbr title=" 473             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 473             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 474             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 474             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 475         } catch (Exception e) {
 476             e.printStackTrace();
 477         }
 478 
 479         // Cases 2 and 4
 480         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 481             newCursorLocation += deltaLength;
 482 
 483         // Cases 1, 3 and 5 have no change
 484         return newCursorLocation;
 485     }
 486 
 487     private Runnable autoSaveRunnable = new Runnable() {
 488         @Override
 489         public void run() {
 490             saveAndSyncNote();
 491         }
 492     };
 493 
 494     @Override
 495     public void onTagsChanged(String tagString) {
 496         if (mNote == null)
 497             return;
<abbr title=" 498         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length())"> 498         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagStrðŸ”µ</abbr>
 499             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 500         else
 501             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;removed_tag&quot;, &quot;tag_removed_from_note&quot;, null);
 502 
 503         mNote.setTagString(tagString);
 504         mNote.setModificationDate(Calendar.getInstance());
 505         updateTagList();
 506         mNote.save();
 507     }
 508 
 509     @Override
 510     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 511         // Unused
 512     }
 513 
 514     @Override
 515     public void afterTextChanged(Editable editable) {
 516         // Set the note title to be a larger size
 517         // Remove any existing size spans
 518         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 519         for (RelativeSizeSpan span : spans) {
 520             editable.removeSpan(span);
 521         }
 522         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 523         if (newLinePosition == 0)
 524             return;
<abbr title=" 525         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 525         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 526     }
 527 
 528     @Override
 529     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 530 
 531         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 532         if (mAutoSaveHandler != null) {
 533             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 534             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 535         }
 536 
 537         // Remove search highlight spans when note content changes
 538         if (mMatchOffsets != null) {
 539             mMatchOffsets = null;
 540             mHighlighter.removeMatches();
 541         }
 542     }
 543 
 544     private void saveAndSyncNote() {
 545         if (mNote == null)
 546             return;
 547 
 548         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 549     }
 550 
 551     public void setPlaceholderVisible(boolean isVisible) {
 552         if (isVisible) {
 553             mNote = null;
 554             mContentEditText.setText(&quot;&quot;);
 555             mTagView.setText(&quot;&quot;);
 556             if (mPlaceholderView != null)
 557                 mPlaceholderView.setVisibility(View.VISIBLE);
 558         } else {
 559             if (mPlaceholderView != null)
 560                 mPlaceholderView.setVisibility(View.GONE);
 561         }
 562     }
 563 
 564     public void setIsNewNote(boolean isNewNote) {
 565         this.mIsNewNote = isNewNote;
 566     }
 567 
 568     @Override
 569     public void onFocusChange(View v, boolean hasFocus) {
 570         if (!hasFocus) {
 571             String tagString = getNoteTagsString().trim();
 572             if (tagString.length() &gt; 0) {
 573                 mTagView.setChips(tagString);
 574             }
 575         }
 576     }
 577 
 578     public Note getNote() {
 579         return mNote;
 580     }
 581 
 582     public String getNoteContentString() {
 583         if (mContentEditText == null || mContentEditText.getText() == null) {
 584             return &quot;&quot;;
 585         } else {
 586             return mContentEditText.getText().toString();
 587         }
 588     }
 589 
 590     public String getNoteTagsString() {
 591         if (mTagView == null || mTagView.getText() == null) {
 592             return &quot;&quot;;
 593         } else {
 594             return mTagView.getText().toString();
 595         }
 596     }
 597 
 598     // Use spaces in tag autocompletion list
<abbr title=" 599     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 599     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 600     public class SpaceTokenizer implements Tokenizer {
 601 
 602         public int findTokenStart(CharSequence text, int cursor) {
 603             int i = cursor;
 604 
 605             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 606                 i--;
 607             }
 608             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 609                 i++;
 610             }
 611 
 612             return i;
 613         }
 614 
 615         public int findTokenEnd(CharSequence text, int cursor) {
 616             int i = cursor;
 617             int len = text.length();
 618 
 619             while (i &lt; len) {
 620                 if (text.charAt(i) == &#x27; &#x27;) {
 621                     return i;
 622                 } else {
 623                     i++;
 624                 }
 625             }
 626 
 627             return len;
 628         }
 629 
 630         public CharSequence terminateToken(CharSequence text) {
 631             int i = text.length();
 632 
 633             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 634                 i--;
 635             }
 636 
 637             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 638                 return text;
 639             } else {
 640                 if (text instanceof Spanned) {
 641                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 642                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 643                             Object.class, sp, 0);
 644                     return sp;
 645                 } else {
 646                     return text + &quot; &quot;;
 647                 }
 648             }
 649         }
 650     }
 651 
 652     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 653 
 654         @Override
 655         protected void onPreExecute() {
 656             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 657             mIsLoadingNote = true;
 658         }
 659 
 660         @Override
 661         protected Void doInBackground(String... args) {
 662             if (getActivity() == null) {
 663                 return null;
 664             }
 665 
 666             String noteID = args[0];
 667             Simplenote application = (Simplenote) getActivity().getApplication();
 668             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 669             try {
 670                 mNote = notesBucket.get(noteID);
 671                 // Set the current note in NotesActivity when on a tablet
 672                 if (getActivity() instanceof NotesActivity) {
 673                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 674                 }
 675             } catch (BucketObjectMissingException e) {
 676                 // TODO: Handle a missing note
 677             }
 678             return null;
 679         }
 680 
 681         @Override
 682         protected void onPostExecute(Void nada) {
 683             if (getActivity() == null || getActivity().isFinishing())
 684                 return;
 685             refreshContent(false);
 686             if (mMatchOffsets != null) {
<abbr title=" 687                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 687                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 688                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 689             }
 690             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 691             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 692                 // Show soft keyboard
 693                 mContentEditText.requestFocus();
 694                 new Handler().postDelayed(new Runnable() {
 695                     @Override
 696                     public void run() {
<abbr title=" 697                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 697                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 698                         if (inputMethodManager != null)
 699                             inputMethodManager.showSoftInput(mContentEditText, 0);
 700                     }
 701                 }, 100);
 702 
 703             }
 704 
 705             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 706 
 707             mIsLoadingNote = false;
 708         }
 709     }
 710 
 711     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 712 
 713         @Override
 714         protected Void doInBackground(Void... args) {
 715             saveNote();
 716             return null;
 717         }
 718 
 719         @Override
 720         protected void onPostExecute(Void nada) {
 721             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 722                 // Update links
 723                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 724             }
 725         }
 726     }
 727 
 728     private void saveNote() {
 729         if (mNote == null) {
 730             return;
 731         }
 732 
 733         String content = getNoteContentString();
 734         String tagString = getNoteTagsString();
 735         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 736             mNote.setContent(content);
 737             mNote.setTagString(tagString);
 738             mNote.setModificationDate(Calendar.getInstance());
 739             // Send pinned event to google analytics if changed
 740             mNote.setPinned(mPinButton.isChecked());
 741             mNote.save();
 742             if (getActivity() != null) {
 743                 Tracker tracker = EasyTracker.getTracker();
 744                 if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 745                     tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 745                     tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;,ðŸ”µ</abbr>
 746                 tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 747             }
 748         }
 749     }
 750 
 751     // Contextual action bar for dealing with links
 752     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 753 
 754         // Called when the action mode is created; startActionMode() was called
 755         @Override
 756         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 757             // Inflate a menu resource providing context menu items
 758             MenuInflater inflater = mode.getMenuInflater();
 759             if (inflater != null){
 760                 inflater.inflate(R.menu.view_link, menu);
 761                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 762                 mode.setTitle(getString(R.string.link));
 763                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 764                     mode.setTitleOptionalHint(false);
 765                 }
 766             }
 767             return true;
 768         }
 769 
 770         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 771         // may be called multiple times if the mode is invalidated.
 772         @Override
 773         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 774             return false; // Return false if nothing is done
 775         }
 776 
 777         // Called when the user selects a contextual menu item
 778         @Override
 779         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 780             switch (item.getItemId()) {
 781                 case R.id.menu_view_link:
 782                     if (mLinkUrl != null) {
 783                         try {
 784                             Uri uri = Uri.parse(mLinkUrl);
 785                             Intent i = new Intent(Intent.ACTION_VIEW);
 786                             i.setData(uri);
 787                             startActivity(i);
 788                         } catch (Exception e) {
 789                             e.printStackTrace();
 790                         }
 791                         mode.finish(); // Action picked, so close the CAB
 792                     }
 793                     return true;
 794                 case R.id.menu_copy:
 795                     if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 796                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 796                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr>
 797                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 798                         clipboard.setPrimaryClip(clip);
<abbr title=" 799                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 799                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 800                         mode.finish();
 801                     }
 802                     return true;
 803                 case R.id.menu_share:
 804                     if (mLinkText != null) {
 805                         try {
 806                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 807                             shareIntent.setType(&quot;text/plain&quot;);
 808                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 809                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 809                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 810                         } catch (Exception e) {
 811                             e.printStackTrace();
 812                         }
 813                         mode.finish();
 814                     }
 815                     return true;
 816                 default:
 817                     return false;
 818             }
 819         }
 820 
 821         // Called when the user exits the action mode
 822         @Override
 823         public void onDestroyActionMode(ActionMode mode) {
 824             mActionMode = null;
 825         }
 826     };
 827 
 828     // Checks if cursor is at a URL when the selection changes
 829     // If it is a URL, show the contextual action bar
 830     @Override
 831     public void onSelectionChanged(int selStart, int selEnd) {
 832         if (selStart == selEnd) {
 833             Editable noteContent = mContentEditText.getText();
 834             if (noteContent == null)
 835                 return;
 836 
 837             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 838             if (urlSpans.length &gt; 0) {
 839                 URLSpan urlSpan = urlSpans[0];
 840                 mLinkUrl = urlSpan.getURL();
<abbr title=" 841                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 841                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 842                 if (mActionMode != null) {
 843                     mActionMode.setSubtitle(mLinkText);
 844                     setLinkMenuItem();
 845                     return;
 846                 }
 847 
 848                 // Show the Contextual Action Bar
 849                 if (getActivity() != null) {
 850                     mActionMode = getActivity().startActionMode(mActionModeCallback);
 851                     if (mActionMode != null) {
 852                         mActionMode.setSubtitle(mLinkText);
 853                     }
 854                     setLinkMenuItem();
 855                 }
 856             } else if (mActionMode != null) {
 857                 mActionMode.finish();
 858                 mActionMode = null;
 859             }
 860         } else if (mActionMode != null) {
 861             mActionMode.finish();
 862             mActionMode = null;
 863         }
 864     }
 865 
 866     private void setLinkMenuItem() {
 867         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 868             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 869                 mViewLinkMenuItem.setIcon(mCallIconResId);
 870                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 871             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 872                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 873                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 874             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 875                 mViewLinkMenuItem.setIcon(mMapIconResId);
 876                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 877             } else {
 878                 mViewLinkMenuItem.setIcon(mWebIconResId);
 879                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 880             }
 881         }
 882     }
 883 
 884     @Override
 885     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 886 
 887     }
 888 
 889     @Override
 890     public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
 891         if (changeType == Bucket.ChangeType.MODIFY) {
 892             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 893                 try {
 894                     final Note updatedNote = mNotesBucket.get(key);
 895                     if (getActivity() != null) {
 896                         getActivity().runOnUiThread(new Runnable() {
 897                             @Override
 898                             public void run() {
 899                                 updateNote(updatedNote);
 900                                 updatePublishDialogContent();
 901                             }
 902                         });
 903                     }
 904                 } catch (BucketObjectMissingException e) {
 905                     e.printStackTrace();
 906                 }
 907             }
 908         }
 909     }
 910 
 911     @Override
 912     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 913         // noop
 914     }
 915 
 916     @Override
 917     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 918         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 919         if (mIsLoadingNote)
 920             return;
 921 
 922         Note openNote = getNote();
 923         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
 924             return;
 925 
 926         note.setContent(getNoteContentString());
 927     }
 928 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Dialog;
   5 import android.app.Fragment;
   6 import android.content.ClipData;
   7 import android.content.ClipboardManager;
   8 import android.content.Context;
   9 import android.content.Intent;
  10 import android.content.res.TypedArray;
  11 import android.database.Cursor;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.text.Editable;
  18 import android.text.SpannableString;
  19 import android.text.Spanned;
  20 import android.text.TextUtils;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.view.ActionMode;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.Window;
  33 import android.view.WindowManager;
  34 import android.view.inputmethod.InputMethodManager;
  35 import android.widget.Button;
  36 import android.widget.CursorAdapter;
  37 import android.widget.LinearLayout;
  38 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  39 import android.widget.TextView;
  40 import android.widget.Toast;
  41 import android.widget.ToggleButton;
  42 
  43 import com.automattic.simplenote.models.Note;
  44 import com.automattic.simplenote.models.Tag;
  45 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  46 import com.automattic.simplenote.utils.SimplenoteEditText;
  47 import com.automattic.simplenote.utils.SimplenoteLinkify;
  48 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  49 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  50 import com.automattic.simplenote.utils.TextHighlighter;
  51 import com.automattic.simplenote.utils.Typefaces;
  52 import com.google.analytics.tracking.android.EasyTracker;
  53 import com.google.analytics.tracking.android.Tracker;
  54 import com.simperium.client.Bucket;
  55 import com.simperium.client.BucketObjectMissingException;
  56 import com.simperium.client.Query;
  57 
  58 import java.util.Calendar;
  59 
<abbr title="  60 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  60 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddeðŸ”µ</abbr>
  61 
  62     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  63     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  64     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  65     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  66 
  67     private Note mNote;
  68     private Bucket&lt;Note&gt; mNotesBucket;
  69 
  70     private SimplenoteEditText mContentEditText;
  71     private TagsMultiAutoCompleteTextView mTagView;
  72     private ToggleButton mPinButton;
  73     private Handler mAutoSaveHandler;
  74     private LinearLayout mPlaceholderView;
  75     private Dialog mPublishDialog;
  76     private CursorAdapter mAutocompleteAdapter;
  77     private boolean mIsNewNote, mIsLoadingNote;
  78     private ActionMode mActionMode;
  79     private MenuItem mViewLinkMenuItem;
  80     private String mLinkUrl;
  81     private String mLinkText;
  82     private MatchOffsetHighlighter mHighlighter;
  83     private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  84     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  85     private String mMatchOffsets;
  86 
  87     /**
  88      * Mandatory empty constructor for the fragment manager to instantiate the
  89      * fragment (e.g. upon screen orientation changes).
  90      */
  91     public NoteEditorFragment() {
  92     }
  93 
  94     @Override
  95     public void onCreate(Bundle savedInstanceState) {
  96         super.onCreate(savedInstanceState);
  97 
  98         if (getActivity() != null) {
  99             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100             mNotesBucket = currentApp.getNotesBucket();
 101 
<abbr title=" 102             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 102             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 103             if (a != null) {
 104                 mEmailIconResId = a.getResourceId(0, 0);
 105                 mWebIconResId = a.getResourceId(1, 0);
 106                 mMapIconResId = a.getResourceId(2, 0);
 107                 mCallIconResId = a.getResourceId(3, 0);
 108                 a.recycle();
 109             }
 110         }
 111 
 112         mAutoSaveHandler = new Handler();
 113 
 114         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 115                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 115                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 116         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 117 
 118             @Override
 119             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 120                 Activity activity = (Activity) context;
 121                 if (activity == null) return null;
 122                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 123             }
 124 
 125             @Override
 126             public void bindView(View view, Context context, Cursor cursor) {
 127                 TextView textView = (TextView) view;
 128                 textView.setText(convertToString(cursor));
 129             }
 130 
 131             @Override
 132             public CharSequence convertToString(Cursor cursor){
 133                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 134             }
 135 
 136             @Override
 137             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 138                 Activity activity = getActivity();
 139                 if (activity == null) return null;
 140                 Simplenote application = (Simplenote) activity.getApplication();
 141                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 142                 // make the tag name available to the cursor
 143                 query.include(Tag.NAME_PROPERTY);
 144                 // sort the tags by their names
 145                 query.order(Tag.NAME_PROPERTY);
 146                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 147                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 147                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 148                 return query.execute();
 149             }
 150         };
 151     }
 152 
 153 
 154     @Override
 155     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 156         setHasOptionsMenu(true);
 157         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 158         mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 159         if (getActivity() != null) {
<abbr title=" 160             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 160             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_ðŸ”µ</abbr>
 161         }
 162         mContentEditText.addOnSelectionChangedListener(this);
 163         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 164         mTagView.setTokenizer(new SpaceTokenizer());
 165         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 166         mTagView.setOnFocusChangeListener(this);
 167 
 168         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 169 
 170         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 171         mPinButton.setOnClickListener(new View.OnClickListener() {
 172             @Override
 173             public void onClick(View v) {
 174                 if (mPinButton.isChecked()) {
 175                     // Friendly message to the user as to what this button does.
 176                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 177                 }
 178             }
 179         });
 180 
 181         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<abbr title=" 182         if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 182         if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandðŸ”µ</abbr>
 183             mPlaceholderView.setVisibility(View.VISIBLE);
 184 
 185         mTagView.setAdapter(mAutocompleteAdapter);
 186 
 187         // Load note if we were passed a note Id
 188         Bundle arguments = getArguments();
 189         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 190             String key = arguments.getString(ARG_ITEM_ID);
 191             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 192                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 193             }
 194             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 195             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 196         }
 197 
 198 		return rootView;
 199 	}
 200 
 201     @Override
 202     public void onResume() {
 203         super.onResume();
 204         mNotesBucket.start();
 205         mNotesBucket.addListener(this);
 206 
 207         mTagView.setOnTagAddedListener(this);
 208 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210         Bundle arguments = getArguments();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214             if (arguments.containsKey(ARG_MATCH_OFFSETS))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         }</span>
 219 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221         Bundle arguments = getArguments();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223         if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225             if (arguments.containsKey(ARG_MATCH_OFFSETS))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         }</span>
 230 =======
 231 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 232     }
 233 
 234     @Override
 235     public void onPause() {
 236         mNotesBucket.removeListener(this);
 237         // Hide soft keyboard if it is showing...
 238         if (getActivity() != null) {
<abbr title=" 239             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 239             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(CðŸ”µ</abbr>
 240             if (inputMethodManager != null) {
 241                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 242         }
 243         }
 244 
 245         // Delete the note if it is new and has empty fields
 246         if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {
 247             mNote.delete();
 248         } else {
 249             saveNote();
 250         }
 251 
 252         mTagView.setOnTagAddedListener(null);
 253 
 254         if (mAutoSaveHandler != null) {
 255             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 256         }
 257 
 258         mHighlighter.stop();
 259 
 260         super.onPause();
 261     }
 262 
 263     @Override
 264     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 265         inflater.inflate(R.menu.note_editor, menu);
 266 
 267         if (mNote != null) {
 268             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_published_note);
 269             viewPublishedNoteItem.setVisible(true);
 270 
 271             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 272             if (mNote.isDeleted())
 273                 trashItem.setTitle(R.string.undelete);
 274             else
 275                 trashItem.setTitle(R.string.delete);
 276         }
 277 
 278         super.onCreateOptionsMenu(menu, inflater);
 279     }
 280 
 281     @Override
 282     public boolean onOptionsItemSelected(MenuItem item) {
 283         switch (item.getItemId()) {
 284             case R.id.menu_view_published_note:
 285                 if (mNote != null) {
 286                     showNotePublishDialog();
 287                 }
 288                 return true;
 289             case R.id.menu_share:
 290                 if (mNote != null) {
 291                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 292                     shareIntent.setType(&quot;text/plain&quot;);
 293                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 294                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 295                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);"> 295                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, ðŸ”µ</abbr>
 296                 }
 297                 return true;
 298             case R.id.menu_delete:
 299                 if (mNote != null) {
 300                     mNote.setDeleted(!mNote.isDeleted());
 301                     mNote.setModificationDate(Calendar.getInstance());
 302                     mNote.save();
 303                     Intent resultIntent = new Intent();
 304                     if (mNote.isDeleted())
 305                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 306                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 307                 }
 308                 getActivity().finish();
 309                 return true;
 310             case android.R.id.home:
 311                 getActivity().finish();
 312                 return true;
 313             default:
 314                 return super.onOptionsItemSelected(item);
 315         }
 316     }
 317 
 318     private void showNotePublishDialog() {
 319         if (mPublishDialog == null) {
 320             mPublishDialog = new Dialog(getActivity(), R.style.SimplenotePublishDialog);
 321             mPublishDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
 322             mPublishDialog.setContentView(R.layout.publish_settings);
 323 
<abbr title=" 324             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.WRAP_CONTENT);"> 324             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LðŸ”µ</abbr>
 325 
 326             Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 327             TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 328 
 329             publishButton.setOnClickListener(new View.OnClickListener() {
 330                 @Override
 331                 public void onClick(View v) {
 332                     if (mNote != null) {
 333                         Button button = (Button) v;
 334                         boolean newPublishedStatus = !mNote.isPublished();
 335                         mNote.setPublished(newPublishedStatus);
 336                         if (newPublishedStatus) {
 337                             button.setText(&quot;Publishing...&quot;);
 338                         } else {
 339                             button.setText(&quot;Publish&quot;);
 340                         }
 341                         mNote.save();
 342                     }
 343                 }
 344             });
 345 
 346             publishTextView.setOnClickListener(new View.OnClickListener() {
 347                 @Override
 348                 public void onClick(View v) {
 349                     TextView textView = (TextView) v;
<abbr title=" 350                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 350                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ContextðŸ”µ</abbr>
<abbr title=" 351                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText());"> 351                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText()ðŸ”µ</abbr>
 352                     clipboard.setPrimaryClip(clip);
<abbr title=" 353                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 353                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).shðŸ”µ</abbr>
 354                 }
 355             });
 356         } else if (mPublishDialog.isShowing()) {
 357             mPublishDialog.dismiss();
 358             return;
 359         }
 360 
 361         updatePublishDialogContent();
 362 
 363         mPublishDialog.show();
 364     }
 365 
 366     public void updatePublishDialogContent() {
 367         if (mPublishDialog == null || mNote == null)
 368             return;
 369         Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 370         TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 371 
 372         if (mNote.isPublished()) {
 373             publishButton.setText(&quot;Published&quot;);
 374             publishTextView.setTextColor(getResources().getColor(R.color.white));
 375             publishTextView.setText(mNote.getPublishedUrl());
 376         } else {
 377             publishButton.setText(&quot;Publish note&quot;);
 378             publishTextView.setTextColor(getResources().getColor(R.color.light_gray));
 379             publishTextView.setText(&quot;Note not published&quot;);
 380         }
 381 
 382     }
 383 
 384     private boolean noteIsEmpty() {
 385         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 386     }
 387 
 388     public void setNote(String noteID){
 389         setNote(noteID, null);
 390     }
 391 
 392     public void setNote(String noteID, String matchOffsets) {
 393         if (mAutoSaveHandler != null)
 394             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 395 
 396         mPlaceholderView.setVisibility(View.GONE);
 397 
 398         if (matchOffsets != null)
 399             mMatchOffsets = matchOffsets;
 400 
 401         // If we have a note already (on a tablet in landscape), save the note.
 402         if (mNote != null) {
 403             if (mIsNewNote &amp;&amp; noteIsEmpty())
 404                 mNote.delete();
 405             else if (mNote != null)
 406                 saveNote();
 407         }
 408 
 409         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 410     }
 411 
 412     public void updateNote(Note updatedNote) {
 413         // update note if network change arrived
 414         mNote = updatedNote;
 415         refreshContent(true);
 416     }
 417 
 418     public void refreshContent(boolean isNoteUpdate) {
 419         if (mNote != null) {
 420             // Restore the cursor position if possible.
 421 
<abbr title=" 422             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 422             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 423 
 424             mContentEditText.setText(mNote.getContent());
 425 
 426             if (isNoteUpdate) {
 427                 // Save the note so any local changes get synced
 428                 mNote.save();
 429 
<abbr title=" 430                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {"> 430                 if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) ðŸ”µ</abbr>
 431                 mContentEditText.setSelection(cursorPosition);
 432                 }
 433             }
 434 
 435             afterTextChanged(mContentEditText.getText());
 436 
 437             mPinButton.setChecked(mNote.isPinned());
 438 
 439             updateTagList();
 440         }
 441     }
 442 
 443     public void updateTagList() {
 444         Activity activity = getActivity();
 445         if (activity == null) return;
 446 
 447         // Populate this note&#x27;s tags in the tagView
 448         mTagView.setChips(mNote.getTagString());
 449     }
 450 
 451     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 452         // Ported from the iOS app :)
 453         // Cases:
 454         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 455         // 1. Text was added after the cursor ==&gt; no change
 456         // 2. Text was added before the cursor ==&gt; location advances
 457         // 3. Text was removed after the cursor ==&gt; no change
 458         // 4. Text was removed before the cursor ==&gt; location retreats
 459         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 460 
 461         int newCursorLocation = cursorLocation;
 462 
 463         int deltaLength = newText.length() - oldText.length();
 464 
 465         // Case 0
 466         if (newText.length() &lt; cursorLocation)
 467             return newText.length();
 468 
 469         boolean beforeCursorMatches = false;
 470         boolean afterCursorMatches = false;
 471 
 472         try {
<abbr title=" 473             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 473             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 474             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 474             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 475         } catch (Exception e) {
 476             e.printStackTrace();
 477         }
 478 
 479         // Cases 2 and 4
 480         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 481             newCursorLocation += deltaLength;
 482 
 483         // Cases 1, 3 and 5 have no change
 484         return newCursorLocation;
 485     }
 486 
 487     private Runnable autoSaveRunnable = new Runnable() {
 488         @Override
 489         public void run() {
 490             saveAndSyncNote();
 491         }
 492     };
 493 
 494     @Override
 495     public void onTagsChanged(String tagString) {
 496         if (mNote == null)
 497             return;
<abbr title=" 498         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length())"> 498         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagStrðŸ”µ</abbr>
 499             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 500         else
 501             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;removed_tag&quot;, &quot;tag_removed_from_note&quot;, null);
 502 
 503         mNote.setTagString(tagString);
 504         mNote.setModificationDate(Calendar.getInstance());
 505         updateTagList();
 506         mNote.save();
 507     }
 508 
 509     @Override
 510     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 511         // Unused
 512     }
 513 
 514     @Override
 515     public void afterTextChanged(Editable editable) {
 516         // Set the note title to be a larger size
 517         // Remove any existing size spans
 518         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 519         for (RelativeSizeSpan span : spans) {
 520             editable.removeSpan(span);
 521         }
 522         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 523         if (newLinePosition == 0)
 524             return;
<abbr title=" 525         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 525         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 526     }
 527 
 528     @Override
 529     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 530 
 531         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 532         if (mAutoSaveHandler != null) {
 533             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 534             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 535         }
 536 
 537         // Remove search highlight spans when note content changes
 538         if (mMatchOffsets != null) {
 539             mMatchOffsets = null;
 540             mHighlighter.removeMatches();
 541         }
 542     }
 543 
 544     private void saveAndSyncNote() {
 545         if (mNote == null)
 546             return;
 547 
 548         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 549     }
 550 
 551     public void setPlaceholderVisible(boolean isVisible) {
 552         if (isVisible) {
 553             mNote = null;
 554             mContentEditText.setText(&quot;&quot;);
 555             mTagView.setText(&quot;&quot;);
 556             if (mPlaceholderView != null)
 557                 mPlaceholderView.setVisibility(View.VISIBLE);
 558         } else {
 559             if (mPlaceholderView != null)
 560                 mPlaceholderView.setVisibility(View.GONE);
 561         }
 562     }
 563 
 564     public void setIsNewNote(boolean isNewNote) {
 565         this.mIsNewNote = isNewNote;
 566     }
 567 
 568     @Override
 569     public void onFocusChange(View v, boolean hasFocus) {
 570         if (!hasFocus) {
 571             String tagString = getNoteTagsString().trim();
 572             if (tagString.length() &gt; 0) {
 573                 mTagView.setChips(tagString);
 574             }
 575         }
 576     }
 577 
 578     public Note getNote() {
 579         return mNote;
 580     }
 581 
 582     public String getNoteContentString() {
 583         if (mContentEditText == null || mContentEditText.getText() == null) {
 584             return &quot;&quot;;
 585         } else {
 586             return mContentEditText.getText().toString();
 587         }
 588     }
 589 
 590     public String getNoteTagsString() {
 591         if (mTagView == null || mTagView.getText() == null) {
 592             return &quot;&quot;;
 593         } else {
 594             return mTagView.getText().toString();
 595         }
 596     }
 597 
 598     // Use spaces in tag autocompletion list
<abbr title=" 599     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 599     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 600     public class SpaceTokenizer implements Tokenizer {
 601 
 602         public int findTokenStart(CharSequence text, int cursor) {
 603             int i = cursor;
 604 
 605             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 606                 i--;
 607             }
 608             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 609                 i++;
 610             }
 611 
 612             return i;
 613         }
 614 
 615         public int findTokenEnd(CharSequence text, int cursor) {
 616             int i = cursor;
 617             int len = text.length();
 618 
 619             while (i &lt; len) {
 620                 if (text.charAt(i) == &#x27; &#x27;) {
 621                     return i;
 622                 } else {
 623                     i++;
 624                 }
 625             }
 626 
 627             return len;
 628         }
 629 
 630         public CharSequence terminateToken(CharSequence text) {
 631             int i = text.length();
 632 
 633             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 634                 i--;
 635             }
 636 
 637             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 638                 return text;
 639             } else {
 640                 if (text instanceof Spanned) {
 641                     SpannableString sp = new SpannableString(text + &quot; &quot;);
 642                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 643                             Object.class, sp, 0);
 644                     return sp;
 645                 } else {
 646                     return text + &quot; &quot;;
 647                 }
 648             }
 649         }
 650     }
 651 
 652     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 653 
 654         @Override
 655         protected void onPreExecute() {
 656             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 657             mIsLoadingNote = true;
 658         }
 659 
 660         @Override
 661         protected Void doInBackground(String... args) {
 662             if (getActivity() == null) {
 663                 return null;
 664             }
 665 
 666             String noteID = args[0];
 667             Simplenote application = (Simplenote) getActivity().getApplication();
 668             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 669             try {
 670                 mNote = notesBucket.get(noteID);
 671                 // Set the current note in NotesActivity when on a tablet
 672                 if (getActivity() instanceof NotesActivity) {
 673                     ((NotesActivity) getActivity()).setCurrentNote(mNote);
 674                 }
 675             } catch (BucketObjectMissingException e) {
 676                 // TODO: Handle a missing note
 677             }
 678             return null;
 679         }
 680 
 681         @Override
 682         protected void onPostExecute(Void nada) {
 683             if (getActivity() == null || getActivity().isFinishing())
 684                 return;
 685             refreshContent(false);
 686             if (mMatchOffsets != null) {
<abbr title=" 687                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 687                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 688                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 689             }
 690             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 691             if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 692                 // Show soft keyboard
 693                 mContentEditText.requestFocus();
 694                 new Handler().postDelayed(new Runnable() {
 695                     @Override
 696                     public void run() {
<abbr title=" 697                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 697                         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSysðŸ”µ</abbr>
 698                         if (inputMethodManager != null)
 699                             inputMethodManager.showSoftInput(mContentEditText, 0);
 700                     }
 701                 }, 100);
 702 
 703             }
 704 
 705             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 706 
 707             mIsLoadingNote = false;
 708         }
 709     }
 710 
 711     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 712 
 713         @Override
 714         protected Void doInBackground(Void... args) {
 715             saveNote();
 716             return null;
 717         }
 718 
 719         @Override
 720         protected void onPostExecute(Void nada) {
 721             if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 722                 // Update links
 723                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 724             }
 725         }
 726     }
 727 
 728     private void saveNote() {
 729         if (mNote == null) {
 730             return;
 731         }
 732 
 733         String content = getNoteContentString();
 734         String tagString = getNoteTagsString();
 735         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 736             mNote.setContent(content);
 737             mNote.setTagString(tagString);
 738             mNote.setModificationDate(Calendar.getInstance());
 739             // Send pinned event to google analytics if changed
 740             mNote.setPinned(mPinButton.isChecked());
 741             mNote.save();
 742             if (getActivity() != null) {
 743                 Tracker tracker = EasyTracker.getTracker();
 744                 if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 745                     tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 745                     tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;,ðŸ”µ</abbr>
 746                 tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 747             }
 748         }
 749     }
 750 
 751     // Contextual action bar for dealing with links
 752     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 753 
 754         // Called when the action mode is created; startActionMode() was called
 755         @Override
 756         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 757             // Inflate a menu resource providing context menu items
 758             MenuInflater inflater = mode.getMenuInflater();
 759             if (inflater != null){
 760                 inflater.inflate(R.menu.view_link, menu);
 761                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 762                 mode.setTitle(getString(R.string.link));
 763                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 764                     mode.setTitleOptionalHint(false);
 765                 }
 766             }
 767             return true;
 768         }
 769 
 770         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 771         // may be called multiple times if the mode is invalidated.
 772         @Override
 773         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 774             return false; // Return false if nothing is done
 775         }
 776 
 777         // Called when the user selects a contextual menu item
 778         @Override
 779         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 780             switch (item.getItemId()) {
 781                 case R.id.menu_view_link:
 782                     if (mLinkUrl != null) {
 783                         try {
 784                             Uri uri = Uri.parse(mLinkUrl);
 785                             Intent i = new Intent(Intent.ACTION_VIEW);
 786                             i.setData(uri);
 787                             startActivity(i);
 788                         } catch (Exception e) {
 789                             e.printStackTrace();
 790                         }
 791                         mode.finish(); // Action picked, so close the CAB
 792                     }
 793                     return true;
 794                 case R.id.menu_copy:
 795                     if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 796                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 796                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr>
 797                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 798                         clipboard.setPrimaryClip(clip);
<abbr title=" 799                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 799                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 800                         mode.finish();
 801                     }
 802                     return true;
 803                 case R.id.menu_share:
 804                     if (mLinkText != null) {
 805                         try {
 806                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 807                             shareIntent.setType(&quot;text/plain&quot;);
 808                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 809                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 809                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 810                         } catch (Exception e) {
 811                             e.printStackTrace();
 812                         }
 813                         mode.finish();
 814                     }
 815                     return true;
 816                 default:
 817                     return false;
 818             }
 819         }
 820 
 821         // Called when the user exits the action mode
 822         @Override
 823         public void onDestroyActionMode(ActionMode mode) {
 824             mActionMode = null;
 825         }
 826     };
 827 
 828     // Checks if cursor is at a URL when the selection changes
 829     // If it is a URL, show the contextual action bar
 830     @Override
 831     public void onSelectionChanged(int selStart, int selEnd) {
 832         if (selStart == selEnd) {
 833             Editable noteContent = mContentEditText.getText();
 834             if (noteContent == null)
 835                 return;
 836 
 837             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 838             if (urlSpans.length &gt; 0) {
 839                 URLSpan urlSpan = urlSpans[0];
 840                 mLinkUrl = urlSpan.getURL();
<abbr title=" 841                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 841                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 842                 if (mActionMode != null) {
 843                     mActionMode.setSubtitle(mLinkText);
 844                     setLinkMenuItem();
 845                     return;
 846                 }
 847 
 848                 // Show the Contextual Action Bar
 849                 if (getActivity() != null) {
 850                     mActionMode = getActivity().startActionMode(mActionModeCallback);
 851                     if (mActionMode != null) {
 852                         mActionMode.setSubtitle(mLinkText);
 853                     }
 854                     setLinkMenuItem();
 855                 }
 856             } else if (mActionMode != null) {
 857                 mActionMode.finish();
 858                 mActionMode = null;
 859             }
 860         } else if (mActionMode != null) {
 861             mActionMode.finish();
 862             mActionMode = null;
 863         }
 864     }
 865 
 866     private void setLinkMenuItem() {
 867         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 868             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 869                 mViewLinkMenuItem.setIcon(mCallIconResId);
 870                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 871             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 872                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 873                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 874             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 875                 mViewLinkMenuItem.setIcon(mMapIconResId);
 876                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 877             } else {
 878                 mViewLinkMenuItem.setIcon(mWebIconResId);
 879                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 880             }
 881         }
 882     }
 883 
 884     @Override
 885     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 886 
 887     }
 888 
 889     @Override
 890     public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
 891         if (changeType == Bucket.ChangeType.MODIFY) {
 892             if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 893                 try {
 894                     final Note updatedNote = mNotesBucket.get(key);
 895                     if (getActivity() != null) {
 896                         getActivity().runOnUiThread(new Runnable() {
 897                             @Override
 898                             public void run() {
 899                                 updateNote(updatedNote);
 900                                 updatePublishDialogContent();
 901                             }
 902                         });
 903                     }
 904                 } catch (BucketObjectMissingException e) {
 905                     e.printStackTrace();
 906                 }
 907             }
 908         }
 909     }
 910 
 911     @Override
 912     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 913         // noop
 914     }
 915 
 916     @Override
 917     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 918         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 919         if (mIsLoadingNote)
 920             return;
 921 
 922         Note openNote = getNote();
 923         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
 924             return;
 925 
 926         note.setContent(getNoteContentString());
 927     }
 928 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Dialog;
   5 import android.app.Fragment;
   6 import android.content.ClipData;
   7 import android.content.ClipboardManager;
   8 import android.content.Context;
   9 import android.content.Intent;
  10 import android.content.res.TypedArray;
  11 import android.database.Cursor;
  12 import android.net.Uri;
  13 import android.os.AsyncTask;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.text.Editable;
  18 import android.text.SpannableString;
  19 import android.text.Spanned;
  20 import android.text.TextUtils;
  21 import android.text.TextWatcher;
  22 import android.text.style.RelativeSizeSpan;
  23 import android.text.style.URLSpan;
  24 import android.text.util.Linkify;
  25 import android.view.ActionMode;
  26 import android.view.LayoutInflater;
  27 import android.view.Menu;
  28 import android.view.MenuInflater;
  29 import android.view.MenuItem;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.Window;
  33 import android.view.WindowManager;
  34 import android.view.inputmethod.InputMethodManager;
  35 import android.widget.Button;
  36 import android.widget.CursorAdapter;
  37 import android.widget.LinearLayout;
  38 import android.widget.MultiAutoCompleteTextView.Tokenizer;
  39 import android.widget.TextView;
  40 import android.widget.Toast;
  41 import android.widget.ToggleButton;
  42 import com.automattic.simplenote.models.Note;
  43 import com.automattic.simplenote.models.Tag;
  44 import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  45 import com.automattic.simplenote.utils.SimplenoteEditText;
  46 import com.automattic.simplenote.utils.SimplenoteLinkify;
  47 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  48 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  49 import com.automattic.simplenote.utils.TextHighlighter;
  50 import com.automattic.simplenote.utils.Typefaces;
  51 import com.google.analytics.tracking.android.EasyTracker;
  52 import com.google.analytics.tracking.android.Tracker;
  53 import com.simperium.client.Bucket;
  54 import com.simperium.client.BucketObjectMissingException;
  55 import com.simperium.client.Query;
  56 import java.util.Calendar;
  57 
  58 
<abbr title="  59 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt; , TextWatcher , OnTagAddedListener , View.OnFocusChangeListener , SimplenoteEditText.OnSelectionChangedListener {">  59 public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt; , TextWatcher , OnTagAdðŸ”µ</abbr>
  60     public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  61 
  62     public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  63 
  64     static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  65 
  66     private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  67 
  68     private Note mNote;
  69 
  70     private Bucket&lt;Note&gt; mNotesBucket;
  71 
  72     private SimplenoteEditText mContentEditText;
  73 
  74     private TagsMultiAutoCompleteTextView mTagView;
  75 
  76     private ToggleButton mPinButton;
  77 
  78     private Handler mAutoSaveHandler;
  79 
  80     private LinearLayout mPlaceholderView;
  81 
  82     private Dialog mPublishDialog;
  83 
  84     private CursorAdapter mAutocompleteAdapter;
  85 
  86     private boolean mIsNewNote;
  87 
  88     private boolean mIsLoadingNote;
  89 
  90     private ActionMode mActionMode;
  91 
  92     private MenuItem mViewLinkMenuItem;
  93 
  94     private String mLinkUrl;
  95 
  96     private String mLinkText;
  97 
  98     private MatchOffsetHighlighter mHighlighter;
  99 
 100     private int mEmailIconResId;
 101 
 102     private int mWebIconResId;
 103 
 104     private int mMapIconResId;
 105 
 106     private int mCallIconResId;
 107 
 108     private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
 109 
 110     private String mMatchOffsets;
 111 
 112     /**
 113      * Mandatory empty constructor for the fragment manager to instantiate the
 114      * fragment (e.g. upon screen orientation changes).
 115      */
 116     public NoteEditorFragment() {
 117     }
 118 
 119     @Override
 120     public void onCreate(Bundle savedInstanceState) {
 121         super.onCreate(savedInstanceState);
 122 
 123         if (getActivity() != null) {
 124             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 125             mNotesBucket = currentApp.getNotesBucket();
 126 
<abbr title=" 127             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 127             TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.atðŸ”µ</abbr>
 128             if (a != null) {
 129                 mEmailIconResId = a.getResourceId(0, 0);
 130                 mWebIconResId = a.getResourceId(1, 0);
 131                 mMapIconResId = a.getResourceId(2, 0);
 132                 mCallIconResId = a.getResourceId(3, 0);
 133                 a.recycle();
 134             }
 135         }
 136 
 137         mAutoSaveHandler = new Handler();
 138 
 139         mMatchHighlighter = new TextHighlighter(getActivity(),
<abbr title=" 140                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);"> 140                 R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor)ðŸ”µ</abbr>
 141         mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 142 
 143             @Override
 144             public View newView(Context context, Cursor cursor, ViewGroup parent) {
 145                 Activity activity = (Activity) context;
 146                 if (activity == null) return null;
 147                 return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 148             }
 149 
 150             @Override
 151             public void bindView(View view, Context context, Cursor cursor) {
 152                 TextView textView = (TextView) view;
 153                 textView.setText(convertToString(cursor));
 154             }
 155 
 156             @Override
 157             public CharSequence convertToString(Cursor cursor){
 158                 return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 159             }
 160 
 161             @Override
 162             public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 163                 Activity activity = getActivity();
 164                 if (activity == null) return null;
 165                 Simplenote application = (Simplenote) activity.getApplication();
 166                 Query&lt;Tag&gt; query = application.getTagsBucket().query();
 167                 // make the tag name available to the cursor
 168                 query.include(Tag.NAME_PROPERTY);
 169                 // sort the tags by their names
 170                 query.order(Tag.NAME_PROPERTY);
 171                 // if there&#x27;s a filter string find only matching tag names
<abbr title=" 172                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 172                 if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.forðŸ”µ</abbr>
 173                 return query.execute();
 174             }
 175         };
 176     }
 177 
 178     @Override
 179     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 180         setHasOptionsMenu(true);
 181         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 182         mContentEditText = ((SimplenoteEditText) (rootView.findViewById(R.id.note_content)));
 183         if (getActivity() != null) {
<abbr title=" 184             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 184             mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_ðŸ”µ</abbr>
 185         }
 186         mContentEditText.addOnSelectionChangedListener(this);
 187         mTagView = ((TagsMultiAutoCompleteTextView) (rootView.findViewById(R.id.tag_view)));
 188         mTagView.setTokenizer(new SpaceTokenizer());
 189         mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 190         mTagView.setOnFocusChangeListener(this);
 191         mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 192         mPinButton = ((ToggleButton) (rootView.findViewById(R.id.pinButton)));
 193         mPinButton.setOnClickListener(new View.OnClickListener() {
 194             @Override
 195             public void onClick(View v) {
 196                 if (mPinButton.isChecked()) {
 197                     // Friendly message to the user as to what this button does.
 198                     Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 199                 }
 200             }
 201         });
 202         mPlaceholderView = ((LinearLayout) (rootView.findViewById(R.id.placeholder)));
<abbr title=" 203         if (((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) (getActivity())).isLargeScreenLandscape()) &amp;&amp; (mNote == null)) {"> 203         if (((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) (getActivity())).isLargeScreenLðŸ”µ</abbr>
 204             mPlaceholderView.setVisibility(View.VISIBLE);
 205         }
 206         mTagView.setAdapter(mAutocompleteAdapter);
 207         // Load note if we were passed a note Id
 208         Bundle arguments = getArguments();
 209         if ((arguments != null) &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 210             String key = arguments.getString(ARG_ITEM_ID);
 211             if (arguments.containsKey(ARG_MATCH_OFFSETS)) {
 212                 mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 213             }
 214             new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 215             setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 216         }
 217         return rootView;
 218     }
 219 
 220     @Override
 221     public void onResume() {
 222         super.onResume();
 223         mNotesBucket.start();
 224         mNotesBucket.addListener(this);
 225         mTagView.setOnTagAddedListener(this);
 226     }
 227 
 228     @Override
 229     public void onPause() {
 230         mNotesBucket.removeListener(this);
 231         // Hide soft keyboard if it is showing...
 232         if (getActivity() != null) {
<abbr title=" 233             InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSystemService(Context.INPUT_METHOD_SERVICE)));"> 233             InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSystemServiceðŸ”µ</abbr>
 234             if (inputMethodManager != null) {
 235                 inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 236             }
 237         }
 238         // Delete the note if it is new and has empty fields
 239         if (((mNote != null) &amp;&amp; mIsNewNote) &amp;&amp; noteIsEmpty()) {
 240             mNote.delete();
 241         } else {
 242             saveNote();
 243         }
 244         mTagView.setOnTagAddedListener(null);
 245         if (mAutoSaveHandler != null) {
 246             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 247         }
 248         mHighlighter.stop();
 249         super.onPause();
 250     }
 251 
 252     @Override
 253     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 254         inflater.inflate(R.menu.note_editor, menu);
 255 
 256         if (mNote != null) {
 257             MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_published_note);
 258             viewPublishedNoteItem.setVisible(true);
 259 
 260             MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 261             if (mNote.isDeleted())
 262                 trashItem.setTitle(R.string.undelete);
 263             else
 264                 trashItem.setTitle(R.string.delete);
 265         }
 266 
 267         super.onCreateOptionsMenu(menu, inflater);
 268     }
 269 
 270     @Override
 271     public boolean onOptionsItemSelected(MenuItem item) {
 272         switch (item.getItemId()) {
 273             case R.id.menu_view_published_note:
 274                 if (mNote != null) {
 275                     showNotePublishDialog();
 276                 }
 277                 return true;
 278             case R.id.menu_share:
 279                 if (mNote != null) {
 280                     Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 281                     shareIntent.setType(&quot;text/plain&quot;);
 282                     shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());
<abbr title=" 283                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 283                     startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.shaðŸ”µ</abbr>
<abbr title=" 284                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);"> 284                     EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, ðŸ”µ</abbr>
 285                 }
 286                 return true;
 287             case R.id.menu_delete:
 288                 if (mNote != null) {
 289                     mNote.setDeleted(!mNote.isDeleted());
 290                     mNote.setModificationDate(Calendar.getInstance());
 291                     mNote.save();
 292                     Intent resultIntent = new Intent();
 293                     if (mNote.isDeleted())
 294                         resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());
 295                     getActivity().setResult(Activity.RESULT_OK, resultIntent);
 296                 }
 297                 getActivity().finish();
 298                 return true;
 299             case android.R.id.home:
 300                 getActivity().finish();
 301                 return true;
 302             default:
 303                 return super.onOptionsItemSelected(item);
 304         }
 305     }
 306 
 307     private void showNotePublishDialog() {
 308         if (mPublishDialog == null) {
 309             mPublishDialog = new Dialog(getActivity(), R.style.SimplenotePublishDialog);
 310             mPublishDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
 311             mPublishDialog.setContentView(R.layout.publish_settings);
 312 
<abbr title=" 313             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.WRAP_CONTENT);"> 313             mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LðŸ”µ</abbr>
 314 
 315             Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 316             TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 317 
 318             publishButton.setOnClickListener(new View.OnClickListener() {
 319                 @Override
 320                 public void onClick(View v) {
 321                     if (mNote != null) {
 322                         Button button = (Button) v;
 323                         boolean newPublishedStatus = !mNote.isPublished();
 324                         mNote.setPublished(newPublishedStatus);
 325                         if (newPublishedStatus) {
 326                             button.setText(&quot;Publishing...&quot;);
 327                         } else {
 328                             button.setText(&quot;Publish&quot;);
 329                         }
 330                         mNote.save();
 331                     }
 332                 }
 333             });
 334 
 335             publishTextView.setOnClickListener(new View.OnClickListener() {
 336                 @Override
 337                 public void onClick(View v) {
 338                     TextView textView = (TextView) v;
<abbr title=" 339                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 339                     ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ContextðŸ”µ</abbr>
<abbr title=" 340                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText());"> 340                     ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText()ðŸ”µ</abbr>
 341                     clipboard.setPrimaryClip(clip);
<abbr title=" 342                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 342                     Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).shðŸ”µ</abbr>
 343                 }
 344             });
 345         } else if (mPublishDialog.isShowing()) {
 346             mPublishDialog.dismiss();
 347             return;
 348         }
 349 
 350         updatePublishDialogContent();
 351 
 352         mPublishDialog.show();
 353     }
 354 
 355     public void updatePublishDialogContent() {
 356         if (mPublishDialog == null || mNote == null)
 357             return;
 358         Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);
 359         TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);
 360 
 361         if (mNote.isPublished()) {
 362             publishButton.setText(&quot;Published&quot;);
 363             publishTextView.setTextColor(getResources().getColor(R.color.white));
 364             publishTextView.setText(mNote.getPublishedUrl());
 365         } else {
 366             publishButton.setText(&quot;Publish note&quot;);
 367             publishTextView.setTextColor(getResources().getColor(R.color.light_gray));
 368             publishTextView.setText(&quot;Note not published&quot;);
 369         }
 370 
 371     }
 372 
 373     private boolean noteIsEmpty() {
 374         return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 375     }
 376 
 377     public void setNote(String noteID){
 378         setNote(noteID, null);
 379     }
 380 
 381     public void setNote(String noteID, String matchOffsets) {
 382         if (mAutoSaveHandler != null)
 383             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 384 
 385         mPlaceholderView.setVisibility(View.GONE);
 386 
 387         if (matchOffsets != null)
 388             mMatchOffsets = matchOffsets;
 389 
 390         // If we have a note already (on a tablet in landscape), save the note.
 391         if (mNote != null) {
 392             if (mIsNewNote &amp;&amp; noteIsEmpty())
 393                 mNote.delete();
 394             else if (mNote != null)
 395                 saveNote();
 396         }
 397 
 398         new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 399     }
 400 
 401     public void updateNote(Note updatedNote) {
 402         // update note if network change arrived
 403         mNote = updatedNote;
 404         refreshContent(true);
 405     }
 406 
 407     public void refreshContent(boolean isNoteUpdate) {
 408         if (mNote != null) {
 409             // Restore the cursor position if possible.
<abbr title=" 410             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 410             int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEdðŸ”µ</abbr>
 411             mContentEditText.setText(mNote.getContent());
 412             if (isNoteUpdate) {
 413                 // Save the note so any local changes get synced
 414                 mNote.save();
<abbr title=" 415                 if (mContentEditText.hasFocus() &amp;&amp; (cursorPosition != mContentEditText.getSelectionEnd())) {"> 415                 if (mContentEditText.hasFocus() &amp;&amp; (cursorPosition != mContentEditText.getSelectionEnd())ðŸ”µ</abbr>
 416                     mContentEditText.setSelection(cursorPosition);
 417                 }
 418             }
 419             afterTextChanged(mContentEditText.getText());
 420             mPinButton.setChecked(mNote.isPinned());
 421             updateTagList();
 422         }
 423     }
 424 
 425     public void updateTagList() {
 426         Activity activity = getActivity();
 427         if (activity == null) return;
 428 
 429         // Populate this note&#x27;s tags in the tagView
 430         mTagView.setChips(mNote.getTagString());
 431     }
 432 
 433     int newCursorLocation(String newText, String oldText, int cursorLocation) {
 434         // Ported from the iOS app :)
 435         // Cases:
 436         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 437         // 1. Text was added after the cursor ==&gt; no change
 438         // 2. Text was added before the cursor ==&gt; location advances
 439         // 3. Text was removed after the cursor ==&gt; no change
 440         // 4. Text was removed before the cursor ==&gt; location retreats
 441         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 442 
 443         int newCursorLocation = cursorLocation;
 444 
 445         int deltaLength = newText.length() - oldText.length();
 446 
 447         // Case 0
 448         if (newText.length() &lt; cursorLocation)
 449             return newText.length();
 450 
 451         boolean beforeCursorMatches = false;
 452         boolean afterCursorMatches = false;
 453 
 454         try {
<abbr title=" 455             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 455             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorðŸ”µ</abbr>
<abbr title=" 456             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 456             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substðŸ”µ</abbr>
 457         } catch (Exception e) {
 458             e.printStackTrace();
 459         }
 460 
 461         // Cases 2 and 4
 462         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 463             newCursorLocation += deltaLength;
 464 
 465         // Cases 1, 3 and 5 have no change
 466         return newCursorLocation;
 467     }
 468 
 469     private Runnable autoSaveRunnable = new Runnable() {
 470         @Override
 471         public void run() {
 472             saveAndSyncNote();
 473         }
 474     };
 475 
 476     @Override
 477     public void onTagsChanged(String tagString) {
 478         if (mNote == null)
 479             return;
<abbr title=" 480         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length())"> 480         if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagStrðŸ”µ</abbr>
 481             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 482         else
 483             EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;removed_tag&quot;, &quot;tag_removed_from_note&quot;, null);
 484 
 485         mNote.setTagString(tagString);
 486         mNote.setModificationDate(Calendar.getInstance());
 487         updateTagList();
 488         mNote.save();
 489     }
 490 
 491     @Override
 492     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 493         // Unused
 494     }
 495 
 496     @Override
 497     public void afterTextChanged(Editable editable) {
 498         // Set the note title to be a larger size
 499         // Remove any existing size spans
 500         RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 501         for (RelativeSizeSpan span : spans) {
 502             editable.removeSpan(span);
 503         }
 504         int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 505         if (newLinePosition == 0)
 506             return;
<abbr title=" 507         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 507         editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editaðŸ”µ</abbr>
 508     }
 509 
 510     @Override
 511     public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 512 
 513         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 514         if (mAutoSaveHandler != null) {
 515             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 516             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 517         }
 518 
 519         // Remove search highlight spans when note content changes
 520         if (mMatchOffsets != null) {
 521             mMatchOffsets = null;
 522             mHighlighter.removeMatches();
 523         }
 524     }
 525 
 526     private void saveAndSyncNote() {
 527         if (mNote == null)
 528             return;
 529 
 530         new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 531     }
 532 
 533     public void setPlaceholderVisible(boolean isVisible) {
 534         if (isVisible) {
 535             mNote = null;
 536             mContentEditText.setText(&quot;&quot;);
 537             mTagView.setText(&quot;&quot;);
 538             if (mPlaceholderView != null)
 539                 mPlaceholderView.setVisibility(View.VISIBLE);
 540         } else {
 541             if (mPlaceholderView != null)
 542                 mPlaceholderView.setVisibility(View.GONE);
 543         }
 544     }
 545 
 546     public void setIsNewNote(boolean isNewNote) {
 547         this.mIsNewNote = isNewNote;
 548     }
 549 
 550     @Override
 551     public void onFocusChange(View v, boolean hasFocus) {
 552         if (!hasFocus) {
 553             String tagString = getNoteTagsString().trim();
 554             if (tagString.length() &gt; 0) {
 555                 mTagView.setChips(tagString);
 556             }
 557         }
 558     }
 559 
 560     public Note getNote() {
 561         return mNote;
 562     }
 563 
 564     public String getNoteContentString() {
 565         if (mContentEditText == null || mContentEditText.getText() == null) {
 566             return &quot;&quot;;
 567         } else {
 568             return mContentEditText.getText().toString();
 569         }
 570     }
 571 
 572     public String getNoteTagsString() {
 573         if (mTagView == null || mTagView.getText() == null) {
 574             return &quot;&quot;;
 575         } else {
 576             return mTagView.getText().toString();
 577         }
 578     }
 579 
 580     // Use spaces in tag autocompletion list
<abbr title=" 581     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 581     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-tðŸ”µ</abbr>
 582     public class SpaceTokenizer implements Tokenizer {
 583         public int findTokenStart(CharSequence text, int cursor) {
 584             int i = cursor;
 585             while ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) != &#x27; &#x27;)) {
 586                 i--;
 587             }
 588             while ((i &lt; cursor) &amp;&amp; (text.charAt(i) == &#x27; &#x27;)) {
 589                 i++;
 590             }
 591             return i;
 592         }
 593 
 594         public int findTokenEnd(CharSequence text, int cursor) {
 595             int i = cursor;
 596             int len = text.length();
 597             while (i &lt; len) {
 598                 if (text.charAt(i) == &#x27; &#x27;) {
 599                     return i;
 600                 } else {
 601                     i++;
 602                 }
 603             }
 604             return len;
 605         }
 606 
 607         public CharSequence terminateToken(CharSequence text) {
 608             int i = text.length();
 609             while ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) == &#x27; &#x27;)) {
 610                 i--;
 611             }
 612             if ((i &gt; 0) &amp;&amp; (text.charAt(i - 1) == &#x27; &#x27;)) {
 613                 return text;
 614             } else if (text instanceof Spanned) {
 615                 SpannableString sp = new SpannableString(text + &quot; &quot;);
<abbr title=" 616                 TextUtils.copySpansFrom(((Spanned) (text)), 0, text.length(), java.lang.Object.class, sp, 0);"> 616                 TextUtils.copySpansFrom(((Spanned) (text)), 0, text.length(), java.lang.Object.class, sp,ðŸ”µ</abbr>
 617                 return sp;
 618             } else {
 619                 return text + &quot; &quot;;
 620             }
 621         }
 622     }
 623 
 624     private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 625         @Override
 626         protected void onPreExecute() {
 627             mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 628             mIsLoadingNote = true;
 629         }
 630 
 631         @Override
 632         protected Void doInBackground(String... args) {
 633             if (getActivity() == null) {
 634                 return null;
 635             }
 636             String noteID = args[0];
 637             Simplenote application = ((Simplenote) (getActivity().getApplication()));
 638             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 639             try {
 640                 mNote = notesBucket.get(noteID);
 641                 // Set the current note in NotesActivity when on a tablet
 642                 if (getActivity() instanceof NotesActivity) {
 643                     ((NotesActivity) (getActivity())).setCurrentNote(mNote);
 644                 }
 645             } catch (BucketObjectMissingException e) {
 646                 // TODO: Handle a missing note
 647             }
 648             return null;
 649         }
 650 
 651         @Override
 652         protected void onPostExecute(Void nada) {
 653             if ((getActivity() == null) || getActivity().isFinishing()) {
 654                 return;
 655             }
 656             refreshContent(false);
 657             if (mMatchOffsets != null) {
<abbr title=" 658                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 658                 int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.COðŸ”µ</abbr>
 659                 mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 660             }
 661             mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 662             if ((mNote != null) &amp;&amp; mNote.getContent().isEmpty()) {
 663                 // Show soft keyboard
 664                 mContentEditText.requestFocus();
 665                 new Handler().postDelayed(new Runnable() {
 666                     @Override
 667                     public void run() {
<abbr title=" 668                         InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSystemService(Context.INPUT_METHOD_SERVICE)));"> 668                         InputMethodManager inputMethodManager = ((InputMethodManager) (getActivity().getSðŸ”µ</abbr>
 669                         if (inputMethodManager != null) {
 670                             inputMethodManager.showSoftInput(mContentEditText, 0);
 671                         }
 672                     }
 673                 }, 100);
 674             }
 675             SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 676             mIsLoadingNote = false;
 677         }
 678     }
 679 
 680     private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 681         @Override
 682         protected Void doInBackground(Void... args) {
 683             saveNote();
 684             return null;
 685         }
 686 
 687         @Override
 688         protected void onPostExecute(Void nada) {
 689             if ((getActivity() != null) &amp;&amp; (!getActivity().isFinishing())) {
 690                 // Update links
 691                 SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 692             }
 693         }
 694     }
 695 
 696     private void saveNote() {
 697         if (mNote == null) {
 698             return;
 699         }
 700         String content = getNoteContentString();
 701         String tagString = getNoteTagsString();
 702         if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 703             mNote.setContent(content);
 704             mNote.setTagString(tagString);
 705             mNote.setModificationDate(Calendar.getInstance());
 706             // Send pinned event to google analytics if changed
 707             mNote.setPinned(mPinButton.isChecked());
 708             mNote.save();
 709             if (getActivity() != null) {
 710                 Tracker tracker = EasyTracker.getTracker();
 711                 if (mNote.isPinned() != mPinButton.isChecked()) {
<abbr title=" 712                     tracker.sendEvent(&quot;note&quot;, mPinButton.isChecked() ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 712                     tracker.sendEvent(&quot;note&quot;, mPinButton.isChecked() ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;ðŸ”µ</abbr>
 713                 }
 714                 tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 715             }
 716         }
 717     }
 718 
 719     // Contextual action bar for dealing with links
 720     // Contextual action bar for dealing with links
 721     private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 722 
 723         // Called when the action mode is created; startActionMode() was called
 724         @Override
 725         public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 726             // Inflate a menu resource providing context menu items
 727             MenuInflater inflater = mode.getMenuInflater();
 728             if (inflater != null){
 729                 inflater.inflate(R.menu.view_link, menu);
 730                 mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 731                 mode.setTitle(getString(R.string.link));
 732                 if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 733                     mode.setTitleOptionalHint(false);
 734                 }
 735             }
 736             return true;
 737         }
 738 
 739         // Called each time the action mode is shown. Always called after onCreateActionMode, but
 740         // may be called multiple times if the mode is invalidated.
 741         @Override
 742         public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 743             return false; // Return false if nothing is done
 744         }
 745 
 746         // Called when the user selects a contextual menu item
 747         @Override
 748         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 749             switch (item.getItemId()) {
 750                 case R.id.menu_view_link:
 751                     if (mLinkUrl != null) {
 752                         try {
 753                             Uri uri = Uri.parse(mLinkUrl);
 754                             Intent i = new Intent(Intent.ACTION_VIEW);
 755                             i.setData(uri);
 756                             startActivity(i);
 757                         } catch (Exception e) {
 758                             e.printStackTrace();
 759                         }
 760                         mode.finish(); // Action picked, so close the CAB
 761                     }
 762                     return true;
 763                 case R.id.menu_copy:
 764                     if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 765                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 765                         ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(ConðŸ”µ</abbr>
 766                         ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 767                         clipboard.setPrimaryClip(clip);
<abbr title=" 768                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();"> 768                         Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORTðŸ”µ</abbr>
 769                         mode.finish();
 770                     }
 771                     return true;
 772                 case R.id.menu_share:
 773                     if (mLinkText != null) {
 774                         try {
 775                             Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 776                             shareIntent.setType(&quot;text/plain&quot;);
 777                             shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 778                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 778                             startActivity(Intent.createChooser(shareIntent, getResources().getString(R.stðŸ”µ</abbr>
 779                         } catch (Exception e) {
 780                             e.printStackTrace();
 781                         }
 782                         mode.finish();
 783                     }
 784                     return true;
 785                 default:
 786                     return false;
 787             }
 788         }
 789 
 790         // Called when the user exits the action mode
 791         @Override
 792         public void onDestroyActionMode(ActionMode mode) {
 793             mActionMode = null;
 794         }
 795     };
 796 
 797     // Checks if cursor is at a URL when the selection changes
 798     // If it is a URL, show the contextual action bar
 799     @Override
 800     public void onSelectionChanged(int selStart, int selEnd) {
 801         if (selStart == selEnd) {
 802             Editable noteContent = mContentEditText.getText();
 803             if (noteContent == null)
 804                 return;
 805 
 806             URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 807             if (urlSpans.length &gt; 0) {
 808                 URLSpan urlSpan = urlSpans[0];
 809                 mLinkUrl = urlSpan.getURL();
<abbr title=" 810                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 810                 mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpaðŸ”µ</abbr>
 811                 if (mActionMode != null) {
 812                     mActionMode.setSubtitle(mLinkText);
 813                     setLinkMenuItem();
 814                     return;
 815                 }
 816 
 817                 // Show the Contextual Action Bar
 818                 if (getActivity() != null) {
 819                     mActionMode = getActivity().startActionMode(mActionModeCallback);
 820                     if (mActionMode != null) {
 821                         mActionMode.setSubtitle(mLinkText);
 822                     }
 823                     setLinkMenuItem();
 824                 }
 825             } else if (mActionMode != null) {
 826                 mActionMode.finish();
 827                 mActionMode = null;
 828             }
 829         } else if (mActionMode != null) {
 830             mActionMode.finish();
 831             mActionMode = null;
 832         }
 833     }
 834 
 835     private void setLinkMenuItem() {
 836         if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 837             if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 838                 mViewLinkMenuItem.setIcon(mCallIconResId);
 839                 mViewLinkMenuItem.setTitle(getString(R.string.call));
 840             } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 841                 mViewLinkMenuItem.setIcon(mEmailIconResId);
 842                 mViewLinkMenuItem.setTitle(getString(R.string.email));
 843             } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 844                 mViewLinkMenuItem.setIcon(mMapIconResId);
 845                 mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 846             } else {
 847                 mViewLinkMenuItem.setIcon(mWebIconResId);
 848                 mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 849             }
 850         }
 851     }
 852 
 853     @Override
 854     public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 855 
 856     }
 857 
 858     @Override
 859     public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
 860         if (changeType == Bucket.ChangeType.MODIFY) {
 861             if ((getNote() != null) &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 862                 try {
 863                     final Note updatedNote = mNotesBucket.get(key);
 864                     if (getActivity() != null) {
 865                         getActivity().runOnUiThread(new Runnable() {
 866                             @Override
 867                             public void run() {
 868                                 updateNote(updatedNote);
 869                                 updatePublishDialogContent();
 870                             }
 871                         });
 872                     }
 873                 } catch (BucketObjectMissingException e) {
 874                     e.printStackTrace();
 875                 }
 876             }
 877         }
 878     }
 879 
 880     @Override
 881     public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 882         // noop
 883     }
 884 
 885     @Override
 886     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 887         // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 888         if (mIsLoadingNote)
 889             return;
 890 
 891         Note openNote = getNote();
 892         if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
 893             return;
 894 
 895         note.setContent(getNoteContentString());
 896     }
 897 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import android.app.Dialog;</span>
   5  import android.app.Fragment;
   6  import android.content.ClipData;
   7  import android.content.ClipboardManager;
   8  import android.content.Context;
   9  import android.content.Intent;
  10  import android.content.res.TypedArray;
  11  import android.database.Cursor;
  12  import android.net.Uri;
  13  import android.os.AsyncTask;
  14  import android.os.Build;
  15  import android.os.Bundle;
  16  import android.os.Handler;
  17  import android.text.Editable;
  18  import android.text.SpannableString;
  19  import android.text.Spanned;
  20  import android.text.TextUtils;
  21  import android.text.TextWatcher;
  22  import android.text.style.RelativeSizeSpan;
  23  import android.text.style.URLSpan;
  24  import android.text.util.Linkify;
  25  import android.view.ActionMode;
  26  import android.view.LayoutInflater;
  27  import android.view.Menu;
  28  import android.view.MenuInflater;
  29  import android.view.MenuItem;
  30  import android.view.View;
  31  import android.view.ViewGroup;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import android.view.Window;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import android.view.WindowManager;</span>
  34  import android.view.inputmethod.InputMethodManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import android.widget.Button;</span>
  36  import android.widget.CursorAdapter;
  37  import android.widget.LinearLayout;
  38  import android.widget.MultiAutoCompleteTextView.Tokenizer;
  39  import android.widget.TextView;
  40  import android.widget.Toast;
  41  import android.widget.ToggleButton;
  42  
  43  import com.automattic.simplenote.models.Note;
  44  import com.automattic.simplenote.models.Tag;
  45  import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  46  import com.automattic.simplenote.utils.SimplenoteEditText;
  47  import com.automattic.simplenote.utils.SimplenoteLinkify;
  48  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  49  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  50  import com.automattic.simplenote.utils.TextHighlighter;
  51  import com.automattic.simplenote.utils.Typefaces;
  52  import com.google.analytics.tracking.android.EasyTracker;
  53  import com.google.analytics.tracking.android.Tracker;
  54  import com.simperium.client.Bucket;
  55  import com.simperium.client.BucketObjectMissingException;
  56  import com.simperium.client.Query;
  57  
  58  import java.util.Calendar;
  59  
<abbr title="  60  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  60  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr>
  61  
  62      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  63      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  64      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  65      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  66  
  67      private Note mNote;
  68      private Bucket&lt;Note&gt; mNotesBucket;
  69  
  70      private SimplenoteEditText mContentEditText;
  71      private TagsMultiAutoCompleteTextView mTagView;
  72      private ToggleButton mPinButton;
  73      private Handler mAutoSaveHandler;
  74      private LinearLayout mPlaceholderView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    private Dialog mPublishDialog;</span>
  76      private CursorAdapter mAutocompleteAdapter;
  77      private boolean mIsNewNote, mIsLoadingNote;
  78      private ActionMode mActionMode;
  79      private MenuItem mViewLinkMenuItem;
  80      private String mLinkUrl;
  81      private String mLinkText;
  82      private MatchOffsetHighlighter mHighlighter;
  83      private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  84      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  85      private String mMatchOffsets;
  86  
  87      /**
  88       * Mandatory empty constructor for the fragment manager to instantiate the
  89       * fragment (e.g. upon screen orientation changes).
  90       */
  91      public NoteEditorFragment() {
  92      }
  93  
  94      @Override
  95      public void onCreate(Bundle savedInstanceState) {
  96          super.onCreate(savedInstanceState);
  97  
  98          if (getActivity() != null) {
  99              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 100              mNotesBucket = currentApp.getNotesBucket();
 101  
<abbr title=" 102              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});"> 102              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr>
 103              if (a != null) {
 104                  mEmailIconResId = a.getResourceId(0, 0);
 105                  mWebIconResId = a.getResourceId(1, 0);
 106                  mMapIconResId = a.getResourceId(2, 0);
 107                  mCallIconResId = a.getResourceId(3, 0);
 108                  a.recycle();
 109              }
 110          }
 111  
 112          mAutoSaveHandler = new Handler();
 113  
 114          mMatchHighlighter = new TextHighlighter(getActivity(),
 115                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 116          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 117  
 118              @Override
 119              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 120                  Activity activity = (Activity) context;
 121                  if (activity == null) return null;
 122                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 123              }
 124  
 125              @Override
 126              public void bindView(View view, Context context, Cursor cursor) {
 127                  TextView textView = (TextView) view;
 128                  textView.setText(convertToString(cursor));
 129              }
 130  
 131              @Override
 132              public CharSequence convertToString(Cursor cursor){
 133                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 134              }
 135  
 136              @Override
 137              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 138                  Activity activity = getActivity();
 139                  if (activity == null) return null;
 140                  Simplenote application = (Simplenote) activity.getApplication();
 141                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 142                  // make the tag name available to the cursor
 143                  query.include(Tag.NAME_PROPERTY);
 144                  // sort the tags by their names
 145                  query.order(Tag.NAME_PROPERTY);
 146                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 147                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 147                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 148                  return query.execute();
 149              }
 150          };
 151      }
 152  
 153  
 154      @Override
 155      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        setHasOptionsMenu(true);</span>
 157          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 158          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 159          if (getActivity() != null) {
<abbr title=" 160              mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 160              mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATHðŸ”µ</abbr>
 161          }
 162          mContentEditText.addOnSelectionChangedListener(this);
 163          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 164          mTagView.setTokenizer(new SpaceTokenizer());
 165          mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 166          mTagView.setOnFocusChangeListener(this);
 167  
 168          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 169  
 170          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 171          mPinButton.setOnClickListener(new View.OnClickListener() {
 172              @Override
 173              public void onClick(View v) {
 174                  if (mPinButton.isChecked()) {
 175                      // Friendly message to the user as to what this button does.
 176                      Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 177                  }
 178              }
 179          });
 180  
 181          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<abbr title=" 182          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 182          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;ðŸ”µ</abbr>
 183              mPlaceholderView.setVisibility(View.VISIBLE);
 184  
 185          mTagView.setAdapter(mAutocompleteAdapter);












 186  		return rootView;
 187  	}
 188  
 189      @Override
 190      public void onResume() {
 191          super.onResume();
 192          mNotesBucket.start();
 193          mNotesBucket.addListener(this);
 194  
 195          mTagView.setOnTagAddedListener(this);
 196  
 197          Bundle arguments = getArguments();
 198  
 199          if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {
 200              String key = arguments.getString(ARG_ITEM_ID);
 201              if (arguments.containsKey(ARG_MATCH_OFFSETS))
 202                  mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);
 203              new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);
 204              setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));
 205          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -</span>
 207      }
 208  
 209      @Override
 210      public void onPause() {
 211          mNotesBucket.removeListener(this);
 212          // Hide soft keyboard if it is showing...
 213          if (getActivity() != null) {
<abbr title=" 214              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 214              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
 215              if (inputMethodManager != null)

 216                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 217          }



 218          // Delete the note if it is new and has empty fields
 219          if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty())

 220              mNote.delete();
 221          else

 222              saveNote();

 223  
 224          mTagView.setOnTagAddedListener(null);
 225  
 226          if (mAutoSaveHandler != null)

 227              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);

 228  
 229          mHighlighter.stop();
 230  
 231          super.onPause();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +        inflater.inflate(R.menu.note_editor, menu);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +            MenuItem viewPublishedNoteItem = menu.findItem(R.id.menu_view_published_note);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +            viewPublishedNoteItem.setVisible(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +            MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +            if (mNote.isDeleted())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                trashItem.setTitle(R.string.undelete);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +            else</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                trashItem.setTitle(R.string.delete);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +        super.onCreateOptionsMenu(menu, inflater);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +    public boolean onOptionsItemSelected(MenuItem item) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +        switch (item.getItemId()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +            case R.id.menu_view_published_note:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +                if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +                    showNotePublishDialog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +            case R.id.menu_share:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                    Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                    shareIntent.setType(&quot;text/plain&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +                    shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mNote.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 265 +                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 265 +                    startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +                    EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;shared_note&quot;, &quot;action_bar_share_button&quot;, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +            case R.id.menu_delete:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +                if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +                    mNote.setDeleted(!mNote.isDeleted());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                    mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                    mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    Intent resultIntent = new Intent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                    if (mNote.isDeleted())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +                        resultIntent.putExtra(Simplenote.DELETED_NOTE_ID, mNote.getSimperiumKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +                    getActivity().setResult(Activity.RESULT_OK, resultIntent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +                getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +            case android.R.id.home:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +                getActivity().finish();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +                return super.onOptionsItemSelected(item);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +    private void showNotePublishDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        if (mPublishDialog == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +            mPublishDialog = new Dialog(getActivity(), R.style.SimplenotePublishDialog);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +            mPublishDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +            mPublishDialog.setContentView(R.layout.publish_settings);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 295 +            mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.WRAP_CONTENT);"> 295 +            mPublishDialog.getWindow().setLayout(WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +            Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +            TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +            publishButton.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                    if (mNote != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +                        Button button = (Button) v;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +                        boolean newPublishedStatus = !mNote.isPublished();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                        mNote.setPublished(newPublishedStatus);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +                        if (newPublishedStatus) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +                            button.setText(&quot;Publishing...&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                            button.setText(&quot;Publish&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +                        mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +            publishTextView.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +                public void onClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +                    TextView textView = (TextView) v;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 321 +                    ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 321 +                    ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +                    ClipData clip = ClipData.newPlainText(getString(R.string.app_name),textView.getText());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +                    clipboard.setPrimaryClip(clip);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +                    Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        } else if (mPublishDialog.isShowing()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +            mPublishDialog.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +        updatePublishDialogContent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +        mPublishDialog.show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +    public void updatePublishDialogContent() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        if (mPublishDialog == null || mNote == null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +        Button publishButton = (Button)mPublishDialog.findViewById(R.id.publish_note_button);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +        TextView publishTextView = (TextView)mPublishDialog.findViewById(R.id.publish_url_textview);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        if (mNote.isPublished()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +            publishButton.setText(&quot;Published&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            publishTextView.setTextColor(getResources().getColor(R.color.white));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +            publishTextView.setText(mNote.getPublishedUrl());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +            publishButton.setText(&quot;Publish note&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +            publishTextView.setTextColor(getResources().getColor(R.color.light_gray));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            publishTextView.setText(&quot;Note not published&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +</span>
 353      }
 354  
 355      private boolean noteIsEmpty() {
 356          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 357      }
 358  
 359      public void setNote(String noteID){
 360          setNote(noteID, null);
 361      }
 362  
 363      public void setNote(String noteID, String matchOffsets) {
 364          if (mAutoSaveHandler != null)
 365              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 366  
 367          mPlaceholderView.setVisibility(View.GONE);
 368  
 369          if (matchOffsets != null)
 370              mMatchOffsets = matchOffsets;
 371  
 372          // If we have a note already (on a tablet in landscape), save the note.
 373          if (mNote != null) {
 374              if (mIsNewNote &amp;&amp; noteIsEmpty())
 375                  mNote.delete();
 376              else if (mNote != null)
 377                  saveNote();
 378          }
 379  
 380          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 381      }
 382  
 383      public void updateNote(Note updatedNote) {
 384          // update note if network change arrived
 385          mNote = updatedNote;
 386          refreshContent(true);
 387      }
 388  
 389      public void refreshContent(boolean isNoteUpdate) {
 390          if (mNote != null) {
 391              // Restore the cursor position if possible.
 392  
<abbr title=" 393              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 393              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 394  
 395              mContentEditText.setText(mNote.getContent());
 396  
<abbr title=" 397              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 397              if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd(ðŸ”µ</abbr>
 398                  mContentEditText.setSelection(cursorPosition);








 399  
 400              afterTextChanged(mContentEditText.getText());
 401  
 402              mPinButton.setChecked(mNote.isPinned());
 403  
 404              updateTagList();
 405          }
 406      }
 407  
 408      public void updateTagList() {
 409          Activity activity = getActivity();
 410          if (activity == null) return;
 411  
 412          // Populate this note&#x27;s tags in the tagView
 413          mTagView.setChips(mNote.getTagString());
 414      }
 415  
 416      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 417          // Ported from the iOS app :)
 418          // Cases:
 419          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 420          // 1. Text was added after the cursor ==&gt; no change
 421          // 2. Text was added before the cursor ==&gt; location advances
 422          // 3. Text was removed after the cursor ==&gt; no change
 423          // 4. Text was removed before the cursor ==&gt; location retreats
 424          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 425  
 426          int newCursorLocation = cursorLocation;
 427  
 428          int deltaLength = newText.length() - oldText.length();
 429  
 430          // Case 0
 431          if (newText.length() &lt; cursorLocation)
 432              return newText.length();
 433  
 434          boolean beforeCursorMatches = false;
 435          boolean afterCursorMatches = false;
 436  
 437          try {
<abbr title=" 438              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 438              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 439              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 439              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 440          } catch (Exception e) {
 441              e.printStackTrace();
 442          }
 443  
 444          // Cases 2 and 4
 445          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 446              newCursorLocation += deltaLength;
 447  
 448          // Cases 1, 3 and 5 have no change
 449          return newCursorLocation;
 450      }
 451  
 452      private Runnable autoSaveRunnable = new Runnable() {
 453          @Override
 454          public void run() {
 455              saveAndSyncNote();
 456          }
 457      };
 458  
 459      @Override
 460      public void onTagsChanged(String tagString) {
 461          if (mNote == null)
 462              return;
<abbr title=" 463          if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length())"> 463          if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().lenðŸ”µ</abbr>
 464              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 465          else
 466              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;removed_tag&quot;, &quot;tag_removed_from_note&quot;, null);
 467  
 468          mNote.setTagString(tagString);
 469          mNote.setModificationDate(Calendar.getInstance());
 470          updateTagList();
 471          mNote.save();
 472      }
 473  
 474      @Override
 475      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 476          // Unused
 477      }
 478  
 479      @Override
 480      public void afterTextChanged(Editable editable) {
 481          // Set the note title to be a larger size
 482          // Remove any existing size spans
 483          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 484          for (RelativeSizeSpan span : spans) {
 485              editable.removeSpan(span);
 486          }
 487          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 488          if (newLinePosition == 0)
 489              return;
<abbr title=" 490          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 490          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr>
 491      }
 492  
 493      @Override
 494      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 495  
 496          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 497          if (mAutoSaveHandler != null) {
 498              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 499              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 500          }
 501  
 502          // Remove search highlight spans when note content changes
 503          if (mMatchOffsets != null) {
 504              mMatchOffsets = null;
 505              mHighlighter.removeMatches();
 506          }
 507      }
 508  
 509      private void saveAndSyncNote() {
 510          if (mNote == null)
 511              return;
 512  
 513          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 514      }
 515  
 516      public void setPlaceholderVisible(boolean isVisible) {
 517          if (isVisible) {
 518              mNote = null;
 519              mContentEditText.setText(&quot;&quot;);
 520              mTagView.setText(&quot;&quot;);
 521              if (mPlaceholderView != null)
 522                  mPlaceholderView.setVisibility(View.VISIBLE);
 523          } else {
 524              if (mPlaceholderView != null)
 525                  mPlaceholderView.setVisibility(View.GONE);
 526          }
 527      }
 528  
 529      public void setIsNewNote(boolean isNewNote) {
 530          this.mIsNewNote = isNewNote;
 531      }
 532  
 533      @Override
 534      public void onFocusChange(View v, boolean hasFocus) {
 535          if (!hasFocus) {
 536              String tagString = getNoteTagsString().trim();
 537              if (tagString.length() &gt; 0) {
 538                  mTagView.setChips(tagString);
 539              }
 540          }
 541      }
 542  
 543      public Note getNote() {
 544          return mNote;
 545      }
 546  
 547      public String getNoteContentString() {
 548          if (mContentEditText == null || mContentEditText.getText() == null) {
 549              return &quot;&quot;;
 550          } else {
 551              return mContentEditText.getText().toString();
 552          }
 553      }
 554  
 555      public String getNoteTagsString() {
 556          if (mTagView == null || mTagView.getText() == null) {
 557              return &quot;&quot;;
 558          } else {
 559              return mTagView.getText().toString();
 560          }
 561      }
 562  
 563      // Use spaces in tag autocompletion list
<abbr title=" 564      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 564      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiaðŸ”µ</abbr>
 565      public class SpaceTokenizer implements Tokenizer {
 566  
 567          public int findTokenStart(CharSequence text, int cursor) {
 568              int i = cursor;
 569  
 570              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 571                  i--;
 572              }
 573              while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 574                  i++;
 575              }
 576  
 577              return i;
 578          }
 579  
 580          public int findTokenEnd(CharSequence text, int cursor) {
 581              int i = cursor;
 582              int len = text.length();
 583  
 584              while (i &lt; len) {
 585                  if (text.charAt(i) == &#x27; &#x27;) {
 586                      return i;
 587                  } else {
 588                      i++;
 589                  }
 590              }
 591  
 592              return len;
 593          }
 594  
 595          public CharSequence terminateToken(CharSequence text) {
 596              int i = text.length();
 597  
 598              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 599                  i--;
 600              }
 601  
 602              if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 603                  return text;
 604              } else {
 605                  if (text instanceof Spanned) {
 606                      SpannableString sp = new SpannableString(text + &quot; &quot;);
 607                      TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 608                              Object.class, sp, 0);
 609                      return sp;
 610                  } else {
 611                      return text + &quot; &quot;;
 612                  }
 613              }
 614          }
 615      }
 616  
 617      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 618  
 619          @Override
 620          protected void onPreExecute() {
 621              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 622              mIsLoadingNote = true;
 623          }
 624  
 625          @Override
 626          protected Void doInBackground(String... args) {



 627  
 628              String noteID = args[0];
 629              if (getActivity() == null)
 630                  return null;
 631              Simplenote application = (Simplenote) getActivity().getApplication();
 632              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 633              try {
 634                  mNote = notesBucket.get(noteID);
 635                  // Set the current note in NotesActivity when on a tablet
 636                  if (getActivity() instanceof NotesActivity) {
 637                      ((NotesActivity) getActivity()).setCurrentNote(mNote);
 638                  }
 639              } catch (BucketObjectMissingException e) {
 640                  // TODO: Handle a missing note
 641              }
 642              return null;
 643          }
 644  
 645          @Override
 646          protected void onPostExecute(Void nada) {
 647              if (getActivity() == null || getActivity().isFinishing())
 648                  return;
 649              refreshContent(true);

 650              if (mMatchOffsets != null) {
<abbr title=" 651                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 651                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 652                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 653              }
 654              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 655              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 656                  // Show soft keyboard
 657                  mContentEditText.requestFocus();
 658                  new Handler().postDelayed(new Runnable() {
 659                      @Override
 660                      public void run() {
<abbr title=" 661                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 661                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 662                          if (inputMethodManager != null)
 663                              inputMethodManager.showSoftInput(mContentEditText, 0);
 664                      }
 665                  }, 100);
 666  
 667              }
 668  
 669              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 670  
 671              mIsLoadingNote = false;
 672          }
 673      }
 674  
 675      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 676  
 677          @Override
 678          protected Void doInBackground(Void... args) {
 679              saveNote();
 680              return null;
 681          }
 682  
 683          @Override
 684          protected void onPostExecute(Void nada) {
 685              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 686                  // Update links
 687                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 688              }
 689          }
 690      }
 691  
 692      private void saveNote() {




 693          String content = getNoteContentString();
 694          String tagString = getNoteTagsString();
 695          if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 696              mNote.setContent(content);
 697              mNote.setTagString(tagString);
 698              mNote.setModificationDate(Calendar.getInstance());
 699              // Send pinned event to google analytics if changed
 700              mNote.setPinned(mPinButton.isChecked());
 701              mNote.save();
 702              if (getActivity() != null) {
 703                  Tracker tracker = EasyTracker.getTracker();
 704                  if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 705                      tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 705                      tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_butðŸ”µ</abbr>
 706                  tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 707              }
 708          }
 709      }
 710  
 711      // Contextual action bar for dealing with links
 712      private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 713  
 714          // Called when the action mode is created; startActionMode() was called
 715          @Override
 716          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 717              // Inflate a menu resource providing context menu items
 718              MenuInflater inflater = mode.getMenuInflater();
 719              if (inflater != null){
 720                  inflater.inflate(R.menu.view_link, menu);
 721                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 722                  mode.setTitle(getString(R.string.link));
 723                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 724                      mode.setTitleOptionalHint(false);
 725                  }
 726              }
 727              return true;
 728          }
 729  
 730          // Called each time the action mode is shown. Always called after onCreateActionMode, but
 731          // may be called multiple times if the mode is invalidated.
 732          @Override
 733          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 734              return false; // Return false if nothing is done
 735          }
 736  
 737          // Called when the user selects a contextual menu item
 738          @Override
 739          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 740              switch (item.getItemId()) {
 741                  case R.id.menu_view_link:
 742                      if (mLinkUrl != null) {
 743                          try {
 744                              Uri uri = Uri.parse(mLinkUrl);
 745                              Intent i = new Intent(Intent.ACTION_VIEW);
 746                              i.setData(uri);
 747                              startActivity(i);
 748                          } catch (Exception e) {
 749                              e.printStackTrace();
 750                          }
 751                          mode.finish(); // Action picked, so close the CAB
 752                      }
 753                      return true;
 754                  case R.id.menu_copy:
 755                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 756                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 756                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr>
 757                          ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 758                          clipboard.setPrimaryClip(clip);
 759                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 760                          mode.finish();
 761                      }
 762                      return true;
 763                  case R.id.menu_share:
 764                      if (mLinkText != null) {
 765                          try {
 766                              Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 767                              shareIntent.setType(&quot;text/plain&quot;);
 768                              shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 769                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 769                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr>
 770                          } catch (Exception e) {
 771                              e.printStackTrace();
 772                          }
 773                          mode.finish();
 774                      }
 775                      return true;
 776                  default:
 777                      return false;
 778              }
 779          }
 780  
 781          // Called when the user exits the action mode
 782          @Override
 783          public void onDestroyActionMode(ActionMode mode) {
 784              mActionMode = null;
 785          }
 786      };
 787  
 788      // Checks if cursor is at a URL when the selection changes
 789      // If it is a URL, show the contextual action bar
 790      @Override
 791      public void onSelectionChanged(int selStart, int selEnd) {
 792          if (selStart == selEnd) {
 793              Editable noteContent = mContentEditText.getText();
 794              if (noteContent == null)
 795                  return;
 796  
 797              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 798              if (urlSpans.length &gt; 0) {
 799                  URLSpan urlSpan = urlSpans[0];
 800                  mLinkUrl = urlSpan.getURL();
<abbr title=" 801                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 801                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
 802                  if (mActionMode != null) {
 803                      mActionMode.setSubtitle(mLinkText);
 804                      setLinkMenuItem();
 805                      return;
 806                  }
 807  
 808                  // Show the Contextual Action Bar
 809                  if (getActivity() != null) {
 810                      mActionMode = getActivity().startActionMode(mActionModeCallback);
 811                      if (mActionMode != null) {
 812                          mActionMode.setSubtitle(mLinkText);
 813                      }
 814                      setLinkMenuItem();
 815                  }
 816              } else if (mActionMode != null) {
 817                  mActionMode.finish();
 818                  mActionMode = null;
 819              }
 820          } else if (mActionMode != null) {
 821              mActionMode.finish();
 822              mActionMode = null;
 823          }
 824      }
 825  
 826      private void setLinkMenuItem() {
 827          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 828              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 829                  mViewLinkMenuItem.setIcon(mCallIconResId);
 830                  mViewLinkMenuItem.setTitle(getString(R.string.call));
 831              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 832                  mViewLinkMenuItem.setIcon(mEmailIconResId);
 833                  mViewLinkMenuItem.setTitle(getString(R.string.email));
 834              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 835                  mViewLinkMenuItem.setIcon(mMapIconResId);
 836                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 837              } else {
 838                  mViewLinkMenuItem.setIcon(mWebIconResId);
 839                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 840              }
 841          }
 842      }
 843  
 844      @Override
 845      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 846  
 847      }
 848  
 849      @Override
 850      public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
 851          if (changeType == Bucket.ChangeType.MODIFY) {
 852              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 853                  try {
 854                      final Note updatedNote = mNotesBucket.get(key);
 855                      if (getActivity() != null) {
 856                          getActivity().runOnUiThread(new Runnable() {
 857                              @Override
 858                              public void run() {
 859                                  updateNote(updatedNote);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 860 +                                updatePublishDialogContent();</span>
 861                              }
 862                          });
 863                      }
 864                  } catch (BucketObjectMissingException e) {
 865                      e.printStackTrace();
 866                  }
 867              }
 868          }
 869      }
 870  
 871      @Override
 872      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 873          // noop
 874      }
 875  
 876      @Override
 877      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 878          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 879          if (mIsLoadingNote)
 880              return;
 881  
 882          Note openNote = getNote();
 883          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
 884              return;
 885  
 886          note.setContent(getNoteContentString());
 887      }
 888  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;

   4  import android.app.Fragment;
   5  import android.content.ClipData;
   6  import android.content.ClipboardManager;
   7  import android.content.Context;
   8  import android.content.Intent;
   9  import android.content.res.TypedArray;
  10  import android.database.Cursor;
  11  import android.net.Uri;
  12  import android.os.AsyncTask;
  13  import android.os.Build;
  14  import android.os.Bundle;
  15  import android.os.Handler;
  16  import android.text.Editable;
  17  import android.text.SpannableString;
  18  import android.text.Spanned;
  19  import android.text.TextUtils;
  20  import android.text.TextWatcher;
  21  import android.text.style.RelativeSizeSpan;
  22  import android.text.style.URLSpan;
  23  import android.text.util.Linkify;
  24  import android.view.ActionMode;
  25  import android.view.LayoutInflater;
  26  import android.view.Menu;
  27  import android.view.MenuInflater;
  28  import android.view.MenuItem;
  29  import android.view.View;
  30  import android.view.ViewGroup;


  31  import android.view.inputmethod.InputMethodManager;

  32  import android.widget.CursorAdapter;
  33  import android.widget.LinearLayout;
  34  import android.widget.MultiAutoCompleteTextView.Tokenizer;
  35  import android.widget.TextView;
  36  import android.widget.Toast;
  37  import android.widget.ToggleButton;
  38  
  39  import com.automattic.simplenote.models.Note;
  40  import com.automattic.simplenote.models.Tag;
  41  import com.automattic.simplenote.utils.MatchOffsetHighlighter;
  42  import com.automattic.simplenote.utils.SimplenoteEditText;
  43  import com.automattic.simplenote.utils.SimplenoteLinkify;
  44  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
  45  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;
  46  import com.automattic.simplenote.utils.TextHighlighter;
  47  import com.automattic.simplenote.utils.Typefaces;
  48  import com.google.analytics.tracking.android.EasyTracker;
  49  import com.google.analytics.tracking.android.Tracker;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.Query;
  53  
  54  import java.util.Calendar;
  55  
<abbr title="  56  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListener, View.OnFocusChangeListener, SimplenoteEditText.OnSelectionChangedListener {">  56  public class NoteEditorFragment extends Fragment implements Bucket.Listener&lt;Note&gt;, TextWatcher, OnTagAddedListenerðŸ”µ</abbr>
  57  
  58      public static final String ARG_ITEM_ID = &quot;item_id&quot;;
  59      public static final String ARG_NEW_NOTE = &quot;new_note&quot;;
  60      static public final String ARG_MATCH_OFFSETS = &quot;match_offsets&quot;;
  61      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  62  
  63      private Note mNote;
  64      private Bucket&lt;Note&gt; mNotesBucket;
  65  
  66      private SimplenoteEditText mContentEditText;
  67      private TagsMultiAutoCompleteTextView mTagView;
  68      private ToggleButton mPinButton;
  69      private Handler mAutoSaveHandler;
  70      private LinearLayout mPlaceholderView;

  71      private CursorAdapter mAutocompleteAdapter;
  72      private boolean mIsNewNote, mIsLoadingNote;
  73      private ActionMode mActionMode;
  74      private MenuItem mViewLinkMenuItem;
  75      private String mLinkUrl;
  76      private String mLinkText;
  77      private MatchOffsetHighlighter mHighlighter;
  78      private int mEmailIconResId, mWebIconResId, mMapIconResId, mCallIconResId;
  79      private MatchOffsetHighlighter.SpanFactory mMatchHighlighter;
  80      private String mMatchOffsets;
  81  
  82      /**
  83       * Mandatory empty constructor for the fragment manager to instantiate the
  84       * fragment (e.g. upon screen orientation changes).
  85       */
  86      public NoteEditorFragment() {
  87      }
  88  
  89      @Override
  90      public void onCreate(Bundle savedInstanceState) {
  91          super.onCreate(savedInstanceState);
  92  
  93          if (getActivity() != null) {
  94              Simplenote currentApp = (Simplenote) getActivity().getApplication();
  95              mNotesBucket = currentApp.getNotesBucket();
  96  
<abbr title="  97              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionBarIconWeb, R.attr.actionBarIconMap, R.attr.actionBarIconCall});">  97              TypedArray a = getActivity().obtainStyledAttributes(new int[]{R.attr.actionBarIconEmail, R.attr.actionðŸ”µ</abbr>
  98              if (a != null) {
  99                  mEmailIconResId = a.getResourceId(0, 0);
 100                  mWebIconResId = a.getResourceId(1, 0);
 101                  mMapIconResId = a.getResourceId(2, 0);
 102                  mCallIconResId = a.getResourceId(3, 0);
 103                  a.recycle();
 104              }
 105          }
 106  
 107          mAutoSaveHandler = new Handler();
 108  
 109          mMatchHighlighter = new TextHighlighter(getActivity(),
 110                  R.attr.editorSearchHighlightForegroundColor, R.attr.editorSearchHighlightBackgroundColor);
 111          mAutocompleteAdapter = new CursorAdapter(getActivity(), null, 0x0){
 112  
 113              @Override
 114              public View newView(Context context, Cursor cursor, ViewGroup parent) {
 115                  Activity activity = (Activity) context;
 116                  if (activity == null) return null;
 117                  return activity.getLayoutInflater().inflate(R.layout.tag_autocomplete_list_item, null);
 118              }
 119  
 120              @Override
 121              public void bindView(View view, Context context, Cursor cursor) {
 122                  TextView textView = (TextView) view;
 123                  textView.setText(convertToString(cursor));
 124              }
 125  
 126              @Override
 127              public CharSequence convertToString(Cursor cursor){
 128                  return cursor.getString(cursor.getColumnIndex(Tag.NAME_PROPERTY));
 129              }
 130  
 131              @Override
 132              public Cursor runQueryOnBackgroundThread(CharSequence filter) {
 133                  Activity activity = getActivity();
 134                  if (activity == null) return null;
 135                  Simplenote application = (Simplenote) activity.getApplication();
 136                  Query&lt;Tag&gt; query = application.getTagsBucket().query();
 137                  // make the tag name available to the cursor
 138                  query.include(Tag.NAME_PROPERTY);
 139                  // sort the tags by their names
 140                  query.order(Tag.NAME_PROPERTY);
 141                  // if there&#x27;s a filter string find only matching tag names
<abbr title=" 142                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%&quot;, filter));"> 142                  if (filter != null ) query.where(Tag.NAME_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%s%%ðŸ”µ</abbr>
 143                  return query.execute();
 144              }
 145          };
 146      }
 147  
 148  
 149      @Override
 150      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {

 151          View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);
 152          mContentEditText = ((SimplenoteEditText) rootView.findViewById(R.id.note_content));
 153          if (getActivity() != null) {
<abbr title=" 154              mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 154              mContentEditText.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATHðŸ”µ</abbr>
 155          }
 156          mContentEditText.addOnSelectionChangedListener(this);
 157          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
 158          mTagView.setTokenizer(new SpaceTokenizer());
 159          mTagView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));
 160          mTagView.setOnFocusChangeListener(this);
 161  
 162          mHighlighter = new MatchOffsetHighlighter(mMatchHighlighter, mContentEditText);
 163  
 164          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
 165          mPinButton.setOnClickListener(new View.OnClickListener() {
 166              @Override
 167              public void onClick(View v) {
 168                  if (mPinButton.isChecked()) {
 169                      // Friendly message to the user as to what this button does.
 170                      Toast.makeText(getActivity(), R.string.note_pinned, Toast.LENGTH_SHORT).show();
 171                  }
 172              }
 173          });
 174  
 175          mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);
<abbr title=" 176          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;&amp; mNote == null)"> 176          if ((getActivity() instanceof NotesActivity) &amp;&amp; ((NotesActivity) getActivity()).isLargeScreenLandscape() &amp;ðŸ”µ</abbr>
 177              mPlaceholderView.setVisibility(View.VISIBLE);
 178  
 179          mTagView.setAdapter(mAutocompleteAdapter);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +        // Load note if we were passed a note Id</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +        Bundle arguments = getArguments();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +        if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +            String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +            if (arguments.containsKey(ARG_MATCH_OFFSETS)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +            new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +            setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +</span>
 192  		return rootView;
 193  	}
 194  
 195      @Override
 196      public void onResume() {
 197          super.onResume();
 198          mNotesBucket.start();
 199          mNotesBucket.addListener(this);
 200  
 201          mTagView.setOnTagAddedListener(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -        Bundle arguments = getArguments();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        if (arguments != null &amp;&amp; arguments.containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -            String key = arguments.getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -            if (arguments.containsKey(ARG_MATCH_OFFSETS))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                mMatchOffsets = arguments.getString(ARG_MATCH_OFFSETS);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -            new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -            setIsNewNote(getArguments().getBoolean(ARG_NEW_NOTE, false));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -</span>
 213      }
 214  
 215      @Override
 216      public void onPause() {
 217          mNotesBucket.removeListener(this);
 218          // Hide soft keyboard if it is showing...
 219          if (getActivity() != null) {
<abbr title=" 220              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 220              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -            if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            if (inputMethodManager != null) {</span>
 223                  inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +</span>
 228          // Delete the note if it is new and has empty fields
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -        if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        if (mNote != null &amp;&amp; mIsNewNote &amp;&amp; noteIsEmpty()) {</span>
 231              mNote.delete();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        else</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        } else {</span>
 234              saveNote();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        }</span>
 236  
 237          mTagView.setOnTagAddedListener(null);
 238  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -        if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        if (mAutoSaveHandler != null) {</span>
 241              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        }</span>
 243  
 244          mHighlighter.stop();
 245  
 246          super.onPause();

























































































































 247      }
 248  
 249      private boolean noteIsEmpty() {
 250          return (getNoteContentString().trim().length() == 0 &amp;&amp; getNoteTagsString().trim().length() == 0);
 251      }
 252  
 253      public void setNote(String noteID){
 254          setNote(noteID, null);
 255      }
 256  
 257      public void setNote(String noteID, String matchOffsets) {
 258          if (mAutoSaveHandler != null)
 259              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 260  
 261          mPlaceholderView.setVisibility(View.GONE);
 262  
 263          if (matchOffsets != null)
 264              mMatchOffsets = matchOffsets;
 265  
 266          // If we have a note already (on a tablet in landscape), save the note.
 267          if (mNote != null) {
 268              if (mIsNewNote &amp;&amp; noteIsEmpty())
 269                  mNote.delete();
 270              else if (mNote != null)
 271                  saveNote();
 272          }
 273  
 274          new loadNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, noteID);
 275      }
 276  
 277      public void updateNote(Note updatedNote) {
 278          // update note if network change arrived
 279          mNote = updatedNote;
 280          refreshContent(true);
 281      }
 282  
 283      public void refreshContent(boolean isNoteUpdate) {
 284          if (mNote != null) {
 285              // Restore the cursor position if possible.
 286  
<abbr title=" 287              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.getSelectionEnd());"> 287              int cursorPosition = newCursorLocation(mNote.getContent(), getNoteContentString(), mContentEditText.geðŸ”µ</abbr>
 288  
 289              mContentEditText.setText(mNote.getContent());
 290  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 291 -            if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())"> 291 -            if (isNoteUpdate &amp;&amp; mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd(ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -                mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +            if (isNoteUpdate) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +                // Save the note so any local changes get synced</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +                mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                    mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +            }</span>
 301  
 302              afterTextChanged(mContentEditText.getText());
 303  
 304              mPinButton.setChecked(mNote.isPinned());
 305  
 306              updateTagList();
 307          }
 308      }
 309  
 310      public void updateTagList() {
 311          Activity activity = getActivity();
 312          if (activity == null) return;
 313  
 314          // Populate this note&#x27;s tags in the tagView
 315          mTagView.setChips(mNote.getTagString());
 316      }
 317  
 318      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 319          // Ported from the iOS app :)
 320          // Cases:
 321          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 322          // 1. Text was added after the cursor ==&gt; no change
 323          // 2. Text was added before the cursor ==&gt; location advances
 324          // 3. Text was removed after the cursor ==&gt; no change
 325          // 4. Text was removed before the cursor ==&gt; location retreats
 326          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 327  
 328          int newCursorLocation = cursorLocation;
 329  
 330          int deltaLength = newText.length() - oldText.length();
 331  
 332          // Case 0
 333          if (newText.length() &lt; cursorLocation)
 334              return newText.length();
 335  
 336          boolean beforeCursorMatches = false;
 337          boolean afterCursorMatches = false;
 338  
 339          try {
<abbr title=" 340              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 340              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)ðŸ”µ</abbr>
<abbr title=" 341              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 341              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursðŸ”µ</abbr>
 342          } catch (Exception e) {
 343              e.printStackTrace();
 344          }
 345  
 346          // Cases 2 and 4
 347          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 348              newCursorLocation += deltaLength;
 349  
 350          // Cases 1, 3 and 5 have no change
 351          return newCursorLocation;
 352      }
 353  
 354      private Runnable autoSaveRunnable = new Runnable() {
 355          @Override
 356          public void run() {
 357              saveAndSyncNote();
 358          }
 359      };
 360  
 361      @Override
 362      public void onTagsChanged(String tagString) {
 363          if (mNote == null)
 364              return;
<abbr title=" 365          if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().length())"> 365          if (getActivity() != null &amp;&amp; mNote.getTagString() != null &amp;&amp; tagString.length() &gt; mNote.getTagString().lenðŸ”µ</abbr>
 366              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;added_tag&quot;, &quot;tag_added_to_note&quot;, null);
 367          else
 368              EasyTracker.getTracker().sendEvent(&quot;note&quot;, &quot;removed_tag&quot;, &quot;tag_removed_from_note&quot;, null);
 369  
 370          mNote.setTagString(tagString);
 371          mNote.setModificationDate(Calendar.getInstance());
 372          updateTagList();
 373          mNote.save();
 374      }
 375  
 376      @Override
 377      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 378          // Unused
 379      }
 380  
 381      @Override
 382      public void afterTextChanged(Editable editable) {
 383          // Set the note title to be a larger size
 384          // Remove any existing size spans
 385          RelativeSizeSpan spans[] = editable.getSpans(0, editable.length(), RelativeSizeSpan.class);
 386          for (RelativeSizeSpan span : spans) {
 387              editable.removeSpan(span);
 388          }
 389          int newLinePosition = getNoteContentString().indexOf(&quot;\n&quot;);
 390          if (newLinePosition == 0)
 391              return;
<abbr title=" 392          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);"> 392          editable.setSpan(new RelativeSizeSpan(1.222f), 0, (newLinePosition &gt; 0) ? newLinePosition : editable.lengtðŸ”µ</abbr>
 393      }
 394  
 395      @Override
 396      public void onTextChanged(CharSequence charSequence, int start, int before, int count) {
 397  
 398          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 399          if (mAutoSaveHandler != null) {
 400              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 401              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 402          }
 403  
 404          // Remove search highlight spans when note content changes
 405          if (mMatchOffsets != null) {
 406              mMatchOffsets = null;
 407              mHighlighter.removeMatches();
 408          }
 409      }
 410  
 411      private void saveAndSyncNote() {
 412          if (mNote == null)
 413              return;
 414  
 415          new saveNoteTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 416      }
 417  
 418      public void setPlaceholderVisible(boolean isVisible) {
 419          if (isVisible) {
 420              mNote = null;
 421              mContentEditText.setText(&quot;&quot;);
 422              mTagView.setText(&quot;&quot;);
 423              if (mPlaceholderView != null)
 424                  mPlaceholderView.setVisibility(View.VISIBLE);
 425          } else {
 426              if (mPlaceholderView != null)
 427                  mPlaceholderView.setVisibility(View.GONE);
 428          }
 429      }
 430  
 431      public void setIsNewNote(boolean isNewNote) {
 432          this.mIsNewNote = isNewNote;
 433      }
 434  
 435      @Override
 436      public void onFocusChange(View v, boolean hasFocus) {
 437          if (!hasFocus) {
 438              String tagString = getNoteTagsString().trim();
 439              if (tagString.length() &gt; 0) {
 440                  mTagView.setChips(tagString);
 441              }
 442          }
 443      }
 444  
 445      public Note getNote() {
 446          return mNote;
 447      }
 448  
 449      public String getNoteContentString() {
 450          if (mContentEditText == null || mContentEditText.getText() == null) {
 451              return &quot;&quot;;
 452          } else {
 453              return mContentEditText.getText().toString();
 454          }
 455      }
 456  
 457      public String getNoteTagsString() {
 458          if (mTagView == null || mTagView.getText() == null) {
 459              return &quot;&quot;;
 460          } else {
 461              return mTagView.getText().toString();
 462          }
 463      }
 464  
 465      // Use spaces in tag autocompletion list
<abbr title=" 466      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 466      // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiaðŸ”µ</abbr>
 467      public class SpaceTokenizer implements Tokenizer {
 468  
 469          public int findTokenStart(CharSequence text, int cursor) {
 470              int i = cursor;
 471  
 472              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {
 473                  i--;
 474              }
 475              while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {
 476                  i++;
 477              }
 478  
 479              return i;
 480          }
 481  
 482          public int findTokenEnd(CharSequence text, int cursor) {
 483              int i = cursor;
 484              int len = text.length();
 485  
 486              while (i &lt; len) {
 487                  if (text.charAt(i) == &#x27; &#x27;) {
 488                      return i;
 489                  } else {
 490                      i++;
 491                  }
 492              }
 493  
 494              return len;
 495          }
 496  
 497          public CharSequence terminateToken(CharSequence text) {
 498              int i = text.length();
 499  
 500              while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 501                  i--;
 502              }
 503  
 504              if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {
 505                  return text;
 506              } else {
 507                  if (text instanceof Spanned) {
 508                      SpannableString sp = new SpannableString(text + &quot; &quot;);
 509                      TextUtils.copySpansFrom((Spanned) text, 0, text.length(),
 510                              Object.class, sp, 0);
 511                      return sp;
 512                  } else {
 513                      return text + &quot; &quot;;
 514                  }
 515              }
 516          }
 517      }
 518  
 519      private class loadNoteTask extends AsyncTask&lt;String, Void, Void&gt; {
 520  
 521          @Override
 522          protected void onPreExecute() {
 523              mContentEditText.removeTextChangedListener(NoteEditorFragment.this);
 524              mIsLoadingNote = true;
 525          }
 526  
 527          @Override
 528          protected Void doInBackground(String... args) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 529 +            if (getActivity() == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 530 +                return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 531 +            }</span>
 532  
 533              String noteID = args[0];
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 534 -            if (getActivity() == null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 535 -                return null;</span>
 536              Simplenote application = (Simplenote) getActivity().getApplication();
 537              Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 538              try {
 539                  mNote = notesBucket.get(noteID);
 540                  // Set the current note in NotesActivity when on a tablet
 541                  if (getActivity() instanceof NotesActivity) {
 542                      ((NotesActivity) getActivity()).setCurrentNote(mNote);
 543                  }
 544              } catch (BucketObjectMissingException e) {
 545                  // TODO: Handle a missing note
 546              }
 547              return null;
 548          }
 549  
 550          @Override
 551          protected void onPostExecute(Void nada) {
 552              if (getActivity() == null || getActivity().isFinishing())
 553                  return;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -            refreshContent(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +            refreshContent(false);</span>
 556              if (mMatchOffsets != null) {
<abbr title=" 557                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROPERTY);"> 557                  int columnIndex = mNote.getBucket().getSchema().getFullTextIndex().getColumnIndex(Note.CONTENT_PROðŸ”µ</abbr>
 558                  mHighlighter.highlightMatches(mMatchOffsets, columnIndex);
 559              }
 560              mContentEditText.addTextChangedListener(NoteEditorFragment.this);
 561              if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 562                  // Show soft keyboard
 563                  mContentEditText.requestFocus();
 564                  new Handler().postDelayed(new Runnable() {
 565                      @Override
 566                      public void run() {
<abbr title=" 567                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 567                          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemServicðŸ”µ</abbr>
 568                          if (inputMethodManager != null)
 569                              inputMethodManager.showSoftInput(mContentEditText, 0);
 570                      }
 571                  }, 100);
 572  
 573              }
 574  
 575              SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 576  
 577              mIsLoadingNote = false;
 578          }
 579      }
 580  
 581      private class saveNoteTask extends AsyncTask&lt;Void, Void, Void&gt; {
 582  
 583          @Override
 584          protected Void doInBackground(Void... args) {
 585              saveNote();
 586              return null;
 587          }
 588  
 589          @Override
 590          protected void onPostExecute(Void nada) {
 591              if (getActivity() != null &amp;&amp; !getActivity().isFinishing()) {
 592                  // Update links
 593                  SimplenoteLinkify.addLinks(mContentEditText, Linkify.ALL);
 594              }
 595          }
 596      }
 597  
 598      private void saveNote() {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +        if (mNote == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +</span>
 603          String content = getNoteContentString();
 604          String tagString = getNoteTagsString();
 605          if (mNote.hasChanges(content, tagString.trim(), mPinButton.isChecked())) {
 606              mNote.setContent(content);
 607              mNote.setTagString(tagString);
 608              mNote.setModificationDate(Calendar.getInstance());
 609              // Send pinned event to google analytics if changed
 610              mNote.setPinned(mPinButton.isChecked());
 611              mNote.save();
 612              if (getActivity() != null) {
 613                  Tracker tracker = EasyTracker.getTracker();
 614                  if (mNote.isPinned() != mPinButton.isChecked())
<abbr title=" 615                      tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_button&quot;, null);"> 615                      tracker.sendEvent(&quot;note&quot;, (mPinButton.isChecked()) ? &quot;pinned_note&quot; : &quot;unpinned_note&quot;, &quot;pin_butðŸ”µ</abbr>
 616                  tracker.sendEvent(&quot;note&quot;, &quot;edited_note&quot;, &quot;editor_save&quot;, null);
 617              }
 618          }
 619      }
 620  
 621      // Contextual action bar for dealing with links
 622      private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
 623  
 624          // Called when the action mode is created; startActionMode() was called
 625          @Override
 626          public boolean onCreateActionMode(ActionMode mode, Menu menu) {
 627              // Inflate a menu resource providing context menu items
 628              MenuInflater inflater = mode.getMenuInflater();
 629              if (inflater != null){
 630                  inflater.inflate(R.menu.view_link, menu);
 631                  mViewLinkMenuItem = menu.findItem(R.id.menu_view_link);
 632                  mode.setTitle(getString(R.string.link));
 633                  if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) {
 634                      mode.setTitleOptionalHint(false);
 635                  }
 636              }
 637              return true;
 638          }
 639  
 640          // Called each time the action mode is shown. Always called after onCreateActionMode, but
 641          // may be called multiple times if the mode is invalidated.
 642          @Override
 643          public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 644              return false; // Return false if nothing is done
 645          }
 646  
 647          // Called when the user selects a contextual menu item
 648          @Override
 649          public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 650              switch (item.getItemId()) {
 651                  case R.id.menu_view_link:
 652                      if (mLinkUrl != null) {
 653                          try {
 654                              Uri uri = Uri.parse(mLinkUrl);
 655                              Intent i = new Intent(Intent.ACTION_VIEW);
 656                              i.setData(uri);
 657                              startActivity(i);
 658                          } catch (Exception e) {
 659                              e.printStackTrace();
 660                          }
 661                          mode.finish(); // Action picked, so close the CAB
 662                      }
 663                      return true;
 664                  case R.id.menu_copy:
 665                      if (mLinkText != null &amp;&amp; getActivity() != null) {
<abbr title=" 666                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);"> 666                          ClipboardManager clipboard = (ClipboardManager)getActivity().getSystemService(Context.CLIPðŸ”µ</abbr>
 667                          ClipData clip = ClipData.newPlainText(getString(R.string.app_name),mLinkText);
 668                          clipboard.setPrimaryClip(clip);
 669                          Toast.makeText(getActivity(), getString(R.string.link_copied), Toast.LENGTH_SHORT).show();
 670                          mode.finish();
 671                      }
 672                      return true;
 673                  case R.id.menu_share:
 674                      if (mLinkText != null) {
 675                          try {
 676                              Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);
 677                              shareIntent.setType(&quot;text/plain&quot;);
 678                              shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, mLinkText);
<abbr title=" 679                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_note)));"> 679                              startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.sharðŸ”µ</abbr>
 680                          } catch (Exception e) {
 681                              e.printStackTrace();
 682                          }
 683                          mode.finish();
 684                      }
 685                      return true;
 686                  default:
 687                      return false;
 688              }
 689          }
 690  
 691          // Called when the user exits the action mode
 692          @Override
 693          public void onDestroyActionMode(ActionMode mode) {
 694              mActionMode = null;
 695          }
 696      };
 697  
 698      // Checks if cursor is at a URL when the selection changes
 699      // If it is a URL, show the contextual action bar
 700      @Override
 701      public void onSelectionChanged(int selStart, int selEnd) {
 702          if (selStart == selEnd) {
 703              Editable noteContent = mContentEditText.getText();
 704              if (noteContent == null)
 705                  return;
 706  
 707              URLSpan[] urlSpans = noteContent.getSpans(selStart, selStart, URLSpan.class);
 708              if (urlSpans.length &gt; 0) {
 709                  URLSpan urlSpan = urlSpans[0];
 710                  mLinkUrl = urlSpan.getURL();
<abbr title=" 711                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSpan)).toString();"> 711                  mLinkText = noteContent.subSequence(noteContent.getSpanStart(urlSpan), noteContent.getSpanEnd(urlSðŸ”µ</abbr>
 712                  if (mActionMode != null) {
 713                      mActionMode.setSubtitle(mLinkText);
 714                      setLinkMenuItem();
 715                      return;
 716                  }
 717  
 718                  // Show the Contextual Action Bar
 719                  if (getActivity() != null) {
 720                      mActionMode = getActivity().startActionMode(mActionModeCallback);
 721                      if (mActionMode != null) {
 722                          mActionMode.setSubtitle(mLinkText);
 723                      }
 724                      setLinkMenuItem();
 725                  }
 726              } else if (mActionMode != null) {
 727                  mActionMode.finish();
 728                  mActionMode = null;
 729              }
 730          } else if (mActionMode != null) {
 731              mActionMode.finish();
 732              mActionMode = null;
 733          }
 734      }
 735  
 736      private void setLinkMenuItem() {
 737          if (mViewLinkMenuItem != null &amp;&amp; mLinkUrl != null) {
 738              if (mLinkUrl.startsWith(&quot;tel:&quot;)) {
 739                  mViewLinkMenuItem.setIcon(mCallIconResId);
 740                  mViewLinkMenuItem.setTitle(getString(R.string.call));
 741              } else if (mLinkUrl.startsWith(&quot;mailto:&quot;)) {
 742                  mViewLinkMenuItem.setIcon(mEmailIconResId);
 743                  mViewLinkMenuItem.setTitle(getString(R.string.email));
 744              } else if (mLinkUrl.startsWith(&quot;geo:&quot;)) {
 745                  mViewLinkMenuItem.setIcon(mMapIconResId);
 746                  mViewLinkMenuItem.setTitle(getString(R.string.view_map));
 747              } else {
 748                  mViewLinkMenuItem.setIcon(mWebIconResId);
 749                  mViewLinkMenuItem.setTitle(getString(R.string.view_in_browser));
 750              }
 751          }
 752      }
 753  
 754      @Override
 755      public void onDeleteObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 756  
 757      }
 758  
 759      @Override
 760      public void onChange(Bucket&lt;Note&gt; noteBucket, Bucket.ChangeType changeType, final String key) {
 761          if (changeType == Bucket.ChangeType.MODIFY) {
 762              if (getNote() != null &amp;&amp; getNote().getSimperiumKey().equals(key)) {
 763                  try {
 764                      final Note updatedNote = mNotesBucket.get(key);
 765                      if (getActivity() != null) {
 766                          getActivity().runOnUiThread(new Runnable() {
 767                              @Override
 768                              public void run() {
 769                                  updateNote(updatedNote);

 770                              }
 771                          });
 772                      }
 773                  } catch (BucketObjectMissingException e) {
 774                      e.printStackTrace();
 775                  }
 776              }
 777          }
 778      }
 779  
 780      @Override
 781      public void onSaveObject(Bucket&lt;Note&gt; noteBucket, Note note) {
 782          // noop
 783      }
 784  
 785      @Override
 786      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
 787          // Don&#x27;t apply updates if we haven&#x27;t loaded the note yet
 788          if (mIsLoadingNote)
 789              return;
 790  
 791          Note openNote = getNote();
 792          if (openNote == null || !openNote.getSimperiumKey().equals(note.getSimperiumKey()))
 793              return;
 794  
 795          note.setContent(getNoteContentString());
 796      }
 797  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            