<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>77</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    77
                    <a href="76.html">prev</a>
                    <a href="78.html">next</a>
                    <a href="77_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_4e1fa0199c788f410832032e7aff720f0bc7c32d_Simplenote/src/main/java/com/automattic/simplenote/Simplenote.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;4e1fa0199c788f410832032e7aff720f0bc7c32d:Simplenote/src/main/java/com/automattic/simplenote/Simplenote.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;4e1fa0199c788f410832032e7aff720f0bc7c32d^1:Simplenote/src/main/java/com/automattic/simplenote/Simplenote.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;4e1fa0199c788f410832032e7aff720f0bc7c32d^2:Simplenote/src/main/java/com/automattic/simplenote/Simplenote.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;3a764d7c3f78240be2e14be35d5bf4517e6f794e:Simplenote/src/main/java/com/automattic/simplenote/Simplenote.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   4 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5 import android.annotation.SuppressLint;</span>
   6 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7 import static com.automattic.simplenote.models.Account.KEY_EMAIL_VERIFICATION;</span>
   8 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
   9 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  10 import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;
  11 import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;
  12 
  13 import android.annotation.SuppressLint;
  14 import android.app.Activity;
  15 import android.app.Application;
  16 import android.content.ComponentCallbacks2;
  17 import android.content.Context;
  18 import android.content.SharedPreferences;
  19 import android.content.res.Configuration;
  20 import android.os.Build;
  21 import android.os.Bundle;
  22 import android.os.Handler;
  23 import android.util.Log;
  24 
  25 import androidx.annotation.IdRes;
  26 import androidx.annotation.NonNull;
  27 import androidx.appcompat.app.AppCompatDelegate;
  28 import androidx.fragment.app.Fragment;
  29 import androidx.fragment.app.FragmentManager;
  30 import androidx.work.BackoffPolicy;
  31 import androidx.work.Constraints;
  32 import androidx.work.ExistingPeriodicWorkPolicy;
  33 import androidx.work.NetworkType;
  34 import androidx.work.PeriodicWorkRequest;
  35 import androidx.work.WorkManager;
  36 
  37 import com.automattic.simplenote.analytics.AnalyticsTracker;
  38 import com.automattic.simplenote.analytics.AnalyticsTrackerNosara;
  39 import com.automattic.simplenote.models.Account;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.NoteCountIndexer;
  42 import com.automattic.simplenote.models.NoteTagger;
  43 import com.automattic.simplenote.models.Preferences;
  44 import com.automattic.simplenote.models.Tag;
  45 import com.automattic.simplenote.utils.AccountVerificationWatcher;
  46 import com.automattic.simplenote.utils.AppLog;
  47 import com.automattic.simplenote.utils.AppLog.Type;
  48 import com.automattic.simplenote.utils.CrashUtils;
  49 import com.automattic.simplenote.utils.DisplayUtils;
  50 import com.automattic.simplenote.utils.PrefUtils;
  51 import com.automattic.simplenote.utils.SyncWorker;
  52 import com.simperium.Simperium;
  53 import com.simperium.android.AndroidClient;
  54 import com.simperium.android.WebSocketManager;
  55 import com.simperium.client.Bucket;
  56 import com.simperium.client.BucketNameInvalid;
  57 import com.simperium.client.BucketObjectMissingException;
  58 import com.simperium.client.ChannelProvider.HeartbeatListener;
  59 import com.simperium.client.User;
  60 
  61 import org.wordpress.passcodelock.AppLockManager;
  62 
  63 import java.util.Calendar;
  64 import java.util.HashMap;
  65 import java.util.Map;
  66 import java.util.concurrent.TimeUnit;
  67 
  68 import dagger.hilt.android.HiltAndroidApp;
  69 
  70 @HiltAndroidApp
  71 public class Simplenote extends Application implements HeartbeatListener {
  72     public static final String DELETED_NOTE_ID = &quot;deletedNoteId&quot;;
  73     public static final String SELECTED_NOTE_ID = &quot;selectedNoteId&quot;;
  74     public static final String SCROLL_POSITION_PREFERENCES = &quot;scroll_position&quot;;
  75     public static final String SYNC_TIME_PREFERENCES = &quot;sync_time&quot;;
  76     public static final String TAG = &quot;Simplenote&quot;;
  77     public static final int INTENT_EDIT_NOTE = 2;
  78     public static final int INTENT_PREFERENCES = 1;
  79     public static final int ONE_MINUTE_MILLIS = 60 * 1000;  // 60 seconds
  80     public static final int TEN_SECONDS_MILLIS = 10 * 1000;  // 10 seconds
  81     public static final int TWENTY_SECONDS_MILLIS = 20 * 1000;  // 20 seconds
  82 
  83     private static final String AUTH_PROVIDER = &quot;simplenote.com&quot;;
  84     private static final String TAG_SYNC = &quot;sync&quot;;
  85     private static final long HEARTBEAT_TIMEOUT =  WebSocketManager.HEARTBEAT_INTERVAL * 2;
  86 
  87     private Activity mCurrentActivity;
  88 
  89     private static Bucket&lt;Account&gt; mAccountBucket;
  90     private static Bucket&lt;Preferences&gt; mPreferencesBucket;
  91 
  92     private Bucket&lt;Note&gt; mNotesBucket;
  93     private Bucket&lt;Tag&gt; mTagsBucket;
  94     private SyncTimes&lt;Note&gt; mNoteSyncTimes;
  95     private Handler mHeartbeatHandler;
  96     private Runnable mHeartbeatRunnable;
  97     private Simperium mSimperium;
  98     private boolean mIsInBackground = true;
  99 
 100     public void onCreate() {
 101         super.onCreate();
 102 
 103         CrashUtils.initWithContext(this);
 104 
 105         SimplenoteAppLock appLock = new SimplenoteAppLock(this);
 106         AppLockManager.getInstance().setCurrentAppLock(appLock);
 107         appLock.enable();
 108 
 109         mSimperium = Simperium.newClient(
 110                 BuildConfig.SIMPERIUM_APP_ID,
 111                 BuildConfig.SIMPERIUM_APP_KEY,
 112                 this
 113         );
 114 
 115         mSimperium.setAuthProvider(AUTH_PROVIDER);
 116         mSimperium.addHeartbeatListener(this);
 117 
 118         mHeartbeatHandler = new Handler();
 119         mHeartbeatRunnable = new Runnable() {
 120             @Override
 121             public void run() {
 122                 AppLog.add(Type.NETWORK, &quot;Heartbeat stopped&quot;);
 123                 mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 124                 mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 125             }
 126         };
 127 
 128         SyncTimePersister syncTimePersister = new SyncTimePersister();
 129         mNoteSyncTimes = new SyncTimes&lt;&gt;(syncTimePersister.load());
 130         mNoteSyncTimes.addListener(syncTimePersister);
 131 
 132         try {
 133             mNotesBucket = mSimperium.bucket(new Note.Schema());
 134             mNotesBucket.addListener(mNoteSyncTimes.bucketListener);
 135             Tag.Schema tagSchema = new Tag.Schema();
 136             tagSchema.addIndex(new NoteCountIndexer(mNotesBucket));
 137             mTagsBucket = mSimperium.bucket(tagSchema);
 138             mPreferencesBucket = mSimperium.bucket(new Preferences.Schema());
 139             mAccountBucket = mSimperium.bucket(new Account.Schema());
 140             mAccountBucket.addOnNetworkChangeListener(
 141                     new AccountVerificationWatcher(this, new VerificationListener())
 142             );
 143             // Every time a note changes or is deleted we need to reindex the tag counts
 144             mNotesBucket.addListener(new NoteTagger(mTagsBucket));
 145         } catch (BucketNameInvalid e) {
 146             throw new RuntimeException(&quot;Could not create bucket&quot;, e);
 147         }
 148 
 149         AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);
 150 
 151         ApplicationLifecycleMonitor applicationLifecycleMonitor = new ApplicationLifecycleMonitor();
 152         registerComponentCallbacks(applicationLifecycleMonitor);
 153         registerActivityLifecycleCallbacks(applicationLifecycleMonitor);
 154 
 155         AnalyticsTracker.registerTracker(new AnalyticsTrackerNosara(this));
 156         AnalyticsTracker.refreshMetadata(mSimperium.getUser().getEmail());
 157         CrashUtils.setCurrentUser(mSimperium.getUser());
 158 
 159         AppLog.add(Type.DEVICE, getDeviceInfo());
 160         AppLog.add(Type.ACCOUNT, getAccountInfo());
 161         AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 162     }
 163 
 164     @Override
 165     public void onBeat() {
 166         AppLog.add(Type.NETWORK, &quot;Heartbeat received&quot;);
 167         mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 168         mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 169     }
 170 
 171     public static boolean analyticsIsEnabled() {
 172         if (mPreferencesBucket == null) {
 173             return true;
 174         }
 175 
 176         try {
 177             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 178             return prefs.getAnalyticsEnabled();
 179         } catch (BucketObjectMissingException e) {
 180             return true;
 181         }
 182     }
 183 
 184     private String getAccountInfo() {
<abbr title=" 185         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEmail() : &quot;?&quot;);"> 185         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUsðŸ”µ</abbr>
 186         String notes = &quot;Notes: &quot; + (mNotesBucket != null ? mNotesBucket.count() : &quot;?&quot;);
 187         String tags = &quot;Tags: &quot; + (mTagsBucket != null ? mTagsBucket.count() : &quot;?&quot;);
 188         return email + &quot;\n&quot; + notes + &quot;\n&quot; + tags + &quot;\n\n&quot;;
 189     }
 190 
 191     private String getDeviceInfo() {
<abbr title=" 192         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; : &quot;Android &quot;;"> 192         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;ChroðŸ”µ</abbr>
 193         String device = &quot;Device: &quot; + Build.MANUFACTURER + &quot; &quot; + Build.MODEL + &quot; (&quot; + Build.DEVICE + &quot;)&quot;;
<abbr title=" 194         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT + &quot;)&quot;;"> 194         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT ðŸ”µ</abbr>
 195         String app = &quot;App: Simplenote &quot; + PrefUtils.versionInfo();
 196         return device + &quot;\n&quot; + system + &quot;\n&quot; + app + &quot;\n\n&quot;;
 197     }
 198 
 199     public Simperium getSimperium() {
 200         return mSimperium;
 201     }
 202 
 203     public Bucket&lt;Note&gt; getNotesBucket() {
 204         return mNotesBucket;
 205     }
 206 
 207     public SyncTimes getNoteSyncTimes() {
 208         return mNoteSyncTimes;
 209     }
 210 
 211     public Bucket&lt;Tag&gt; getTagsBucket() {
 212         return mTagsBucket;
 213     }
 214 
 215     public Bucket&lt;Preferences&gt; getPreferencesBucket() {
 216         return mPreferencesBucket;
 217     }
 218 
 219     public Bucket&lt;Account&gt; getAccountBucket() {
 220         return mAccountBucket;
 221     }
 222 
 223     public boolean isInBackground() {
 224         return mIsInBackground;
 225     }
 226 
 227     public void loginWithToken(String email, String spToken) {
 228         // Manually authorize the user with Simperium
 229         User user = mSimperium.getUser();
 230         user.setAccessToken(spToken);
 231         user.setEmail(email);
 232         user.setStatus(User.Status.AUTHORIZED);
 233 
 234         // Store the user data in Simperium shared preferences
 235         SharedPreferences.Editor editor = AndroidClient.sharedPreferences(this).edit();
 236         editor.putString(USER_ACCESS_TOKEN_PREFERENCE, user.getAccessToken());
 237         editor.putString(USER_EMAIL_PREFERENCE, user.getEmail());
 238         editor.apply();
 239     }
 240 
 241     public boolean isLoggedIn() {
 242         User user = mSimperium.getUser();
 243         return user != null &amp;&amp; user.getStatus() == User.Status.AUTHORIZED;
 244     }
 245 
 246     public String getUserEmail() {
 247         User user = mSimperium.getUser();
 248         return user != null ? user.getEmail() : null;
 249     }
 250 
 251     private void showUnverifiedAccount() {
 252         showReviewAccountOrVerifyEmail(mCurrentActivity, false);
 253     }
 254 
 255     private void showWaitingOnEmailConfirmation() {
 256         showReviewAccountOrVerifyEmail(mCurrentActivity, true);
 257     }
 258 
 259     private void dismissReviewAccountDialog() {
 260         FragmentManager fragmentManager;
 261         if (mCurrentActivity instanceof NotesActivity) {
 262             fragmentManager = ((NotesActivity) mCurrentActivity).getSupportFragmentManager();
 263         } else if (mCurrentActivity instanceof NoteEditorActivity) {
 264             fragmentManager = ((NoteEditorActivity) mCurrentActivity).getSupportFragmentManager();
 265         } else {
 266             return;
 267         }
 268 
 269         for (Fragment fragment : fragmentManager.getFragments()) {
 270             if (fragment instanceof FullScreenDialogFragment) {
 271                 ((FullScreenDialogFragment) fragment).dismiss();
 272 
 273                 return;
 274             }
 275         }
 276     }
 277     private void showReviewAccountOrVerifyEmail(final Activity activity, boolean hasSentEmail) {
 278         final FragmentManager fragmentManager;
 279         final @IdRes int container;
 280 
 281         if (activity instanceof NotesActivity) {
 282             fragmentManager = ((NotesActivity) activity).getSupportFragmentManager();
 283             container = R.id.drawer_layout;
 284         } else if (activity instanceof NoteEditorActivity) {
 285             fragmentManager = ((NoteEditorActivity) activity).getSupportFragmentManager();
 286             container = android.R.id.content;
 287         } else {
 288             return;
 289         }
 290 
 291         final Bundle bundle = ReviewAccountVerifyEmailFragment.newBundle(hasSentEmail);
 292 
 293         new FullScreenDialogFragment.Builder(activity)
 294             .setContent(ReviewAccountVerifyEmailFragment.class, bundle)
 295             .setOnConfirmListener(null)
 296             .setOnDismissListener(null)
 297             .setToolbarElevation(0)
 298             .setViewContainer(container)
 299             .build()
 300             .show(fragmentManager, FullScreenDialogFragment.TAG);
 301     }
 302 
<abbr title=" 303     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbacks2 {"> 303     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponenðŸ”µ</abbr>
 304         // ComponentCallbacks
 305         @Override
 306         public void onTrimMemory(int level) {
 307             if (level == ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN) {
 308                 mIsInBackground = true;
 309 
 310                 // Give the buckets some time to finish sync, then stop them
 311                 new Handler().postDelayed(new Runnable() {
 312                     @Override
 313                     public void run() {
 314                         if (!mIsInBackground) {
 315                             return;
 316                         }
 317 
 318                         if (mAccountBucket != null) {
 319                             mAccountBucket.stop();
 320                             AppLog.add(Type.SYNC, &quot;Stopped account bucket (Simplenote)&quot;);
 321                         }
 322 
 323                         if (mNotesBucket != null) {
 324                             mNotesBucket.stop();
 325                             AppLog.add(Type.SYNC, &quot;Stopped note bucket (Simplenote)&quot;);
 326                         }
 327 
 328                         if (mTagsBucket != null) {
 329                             mTagsBucket.stop();
 330                             AppLog.add(Type.SYNC, &quot;Stopped tag bucket (Simplenote)&quot;);
 331                         }
 332 
 333                         if (mPreferencesBucket != null) {
 334                             mPreferencesBucket.stop();
 335                             AppLog.add(Type.SYNC, &quot;Stopped preference bucket (Simplenote)&quot;);
 336                         }
 337                     }
 338                 }, TEN_SECONDS_MILLIS);
 339 
 340                 PeriodicWorkRequest syncWorkRequest = new PeriodicWorkRequest.Builder(
 341                     SyncWorker.class,
 342                     PeriodicWorkRequest.MIN_PERIODIC_INTERVAL_MILLIS,
 343                     TimeUnit.MILLISECONDS
 344                 )
<abbr title=" 345                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build())"> 345                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTEðŸ”µ</abbr>
 346                     .setBackoffCriteria(BackoffPolicy.LINEAR, ONE_MINUTE_MILLIS, TimeUnit.MILLISECONDS)
 347                     .setInitialDelay(TWENTY_SECONDS_MILLIS, TimeUnit.MILLISECONDS)
 348                     .addTag(TAG_SYNC)
 349                     .build();
 350                 WorkManager.getInstance(getApplicationContext()).enqueueUniquePeriodicWork(
 351                     TAG_SYNC,
 352                     ExistingPeriodicWorkPolicy.REPLACE,
 353                     syncWorkRequest
 354                 );
 355                 Log.d(&quot;Simplenote.onTrimMemory&quot;, &quot;Started worker&quot;);
 356 
 357                 // Send analytics if app is in the background
 358                 AnalyticsTracker.track(
 359                         AnalyticsTracker.Stat.APPLICATION_CLOSED,
 360                         AnalyticsTracker.CATEGORY_USER,
 361                         &quot;application_closed&quot;
 362                 );
 363                 AnalyticsTracker.flush();
 364                 AppLog.add(Type.ACTION, &quot;App closed&quot;);
 365             } else {
 366                 mIsInBackground = false;
 367             }
 368         }
 369 
 370         @Override
 371         public void onConfigurationChanged(@NonNull Configuration newConfig) {
 372             AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 373         }
 374 
 375         @Override
 376         public void onLowMemory() {
 377         }
 378 
 379         // ActivityLifecycleCallbacks
 380         @SuppressLint(&quot;LongLogTag&quot;)
 381         @Override
 382         public void onActivityResumed(@NonNull Activity activity) {
 383             if (mIsInBackground) {
 384                 AnalyticsTracker.track(
 385                         AnalyticsTracker.Stat.APPLICATION_OPENED,
 386                         AnalyticsTracker.CATEGORY_USER,
 387                         &quot;application_opened&quot;
 388                 );
 389 
 390                 mIsInBackground = false;
 391                 AppLog.add(Type.ACTION, &quot;App opened&quot;);
 392                 WorkManager.getInstance(getApplicationContext()).cancelUniqueWork(TAG_SYNC);
 393                 Log.d(&quot;Simplenote.onActivityResumed&quot;, &quot;Stopped worker&quot;);
 394             }
 395 
 396             String activitySimpleName = activity.getClass().getSimpleName();
 397 
 398             mAccountBucket.start();
 399             AppLog.add(Type.SYNC, &quot;Started account bucket (&quot; + activitySimpleName + &quot;)&quot;);
 400             mPreferencesBucket.start();
 401             AppLog.add(Type.SYNC, &quot;Started preference bucket (&quot; + activitySimpleName + &quot;)&quot;);
 402             mNotesBucket.start();
 403             AppLog.add(Type.SYNC, &quot;Started note bucket (&quot; + activitySimpleName + &quot;)&quot;);
 404             mTagsBucket.start();
 405             AppLog.add(Type.SYNC, &quot;Started tag bucket (&quot; + activitySimpleName + &quot;)&quot;);
 406         }
 407 
 408         @Override
 409         public void onActivityCreated(@NonNull Activity activity, Bundle savedInstanceState) {
 410 
 411         }
 412 
 413         @Override
 414         public void onActivityStarted(@NonNull Activity activity) {
 415             mCurrentActivity = activity;
 416         }
 417 
 418         @Override
 419         public void onActivityPaused(@NonNull Activity activity) {
 420         }
 421 
 422         @Override
 423         public void onActivityStopped(@NonNull Activity activity) {
 424         }
 425 
 426         @Override
 427         public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle outState) {
 428         }
 429 
 430         @Override
 431         public void onActivityDestroyed(@NonNull Activity activity) {
 432         }
 433     }
 434 
 435     private class SyncTimePersister implements SyncTimes.SyncTimeListener {
 436         private final SharedPreferences mPreferences;
 437 
 438         public SyncTimePersister() {
 439             mPreferences = getSharedPreferences(SYNC_TIME_PREFERENCES, Context.MODE_PRIVATE);
 440         }
 441 
 442         public HashMap&lt;String, Calendar&gt; load() {
 443             HashMap&lt;String, Calendar&gt; syncTimes = new HashMap&lt;&gt;();
 444 
 445             //noinspection unchecked
<abbr title=" 446             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet()) {"> 446             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet(ðŸ”µ</abbr>
 447                 Calendar instant = Calendar.getInstance();
 448                 instant.setTimeInMillis(syncTime.getValue());
 449                 syncTimes.put(syncTime.getKey(), instant);
 450             }
 451 
 452             return syncTimes;
 453         }
 454 
 455         @Override
 456         public void onRemove(String entityId) {
 457             mPreferences.edit().remove(entityId).apply();
 458         }
 459 
 460         @Override
 461         public void onUpdate(String entityId, Calendar lastSyncTime, boolean isSynced) {
 462             mPreferences.edit().putLong(entityId, lastSyncTime.getTimeInMillis()).apply();
 463         }
 464     }
 465 
 466     private class VerificationListener implements AccountVerificationWatcher.VerificationStateListener {
 467         @Override
 468         public void onUpdate(AccountVerificationWatcher.Status status) {
 469             switch (status) {
 470                 case VERIFIED:
 471                     dismissReviewAccountDialog();
 472                     return;
 473 
 474                 case SENT_EMAIL:
 475                     showWaitingOnEmailConfirmation();
 476                     return;
 477 
 478                 case UNVERIFIED:
 479                     showUnverifiedAccount();
 480             }
 481         }
 482     }
 483 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
   4 import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;
   5 import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;
   6 
   7 import android.annotation.SuppressLint;
   8 import android.app.Activity;
   9 import android.app.Application;
  10 import android.content.ComponentCallbacks2;
  11 import android.content.Context;
  12 import android.content.SharedPreferences;
  13 import android.content.res.Configuration;
  14 import android.os.Build;
  15 import android.os.Bundle;
  16 import android.os.Handler;
  17 import android.util.Log;
  18 
  19 import androidx.annotation.IdRes;
  20 import androidx.annotation.NonNull;
  21 import androidx.appcompat.app.AppCompatDelegate;
  22 import androidx.fragment.app.Fragment;
  23 import androidx.fragment.app.FragmentManager;
  24 import androidx.work.BackoffPolicy;
  25 import androidx.work.Constraints;
  26 import androidx.work.ExistingPeriodicWorkPolicy;
  27 import androidx.work.NetworkType;
  28 import androidx.work.PeriodicWorkRequest;
  29 import androidx.work.WorkManager;
  30 
  31 import com.automattic.simplenote.analytics.AnalyticsTracker;
  32 import com.automattic.simplenote.analytics.AnalyticsTrackerNosara;
  33 import com.automattic.simplenote.models.Account;
  34 import com.automattic.simplenote.models.Note;
  35 import com.automattic.simplenote.models.NoteCountIndexer;
  36 import com.automattic.simplenote.models.NoteTagger;
  37 import com.automattic.simplenote.models.Preferences;
  38 import com.automattic.simplenote.models.Tag;
  39 import com.automattic.simplenote.utils.AccountVerificationWatcher;
  40 import com.automattic.simplenote.utils.AppLog;
  41 import com.automattic.simplenote.utils.AppLog.Type;
  42 import com.automattic.simplenote.utils.CrashUtils;
  43 import com.automattic.simplenote.utils.DisplayUtils;
  44 import com.automattic.simplenote.utils.PrefUtils;
  45 import com.automattic.simplenote.utils.SyncWorker;
  46 import com.simperium.Simperium;
  47 import com.simperium.android.AndroidClient;
  48 import com.simperium.android.WebSocketManager;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.BucketNameInvalid;
  51 import com.simperium.client.BucketObjectMissingException;
  52 import com.simperium.client.ChannelProvider.HeartbeatListener;
  53 import com.simperium.client.User;
  54 
  55 import org.wordpress.passcodelock.AppLockManager;
  56 
  57 import java.util.Calendar;
  58 import java.util.HashMap;
  59 import java.util.Map;
  60 import java.util.concurrent.TimeUnit;
  61 
  62 import dagger.hilt.android.HiltAndroidApp;
  63 
  64 @HiltAndroidApp
  65 public class Simplenote extends Application implements HeartbeatListener {
  66     public static final String DELETED_NOTE_ID = &quot;deletedNoteId&quot;;
  67     public static final String SELECTED_NOTE_ID = &quot;selectedNoteId&quot;;
  68     public static final String SCROLL_POSITION_PREFERENCES = &quot;scroll_position&quot;;
  69     public static final String SYNC_TIME_PREFERENCES = &quot;sync_time&quot;;
  70     public static final String TAG = &quot;Simplenote&quot;;
  71     public static final int INTENT_EDIT_NOTE = 2;
  72     public static final int INTENT_PREFERENCES = 1;
  73     public static final int ONE_MINUTE_MILLIS = 60 * 1000;  // 60 seconds
  74     public static final int TEN_SECONDS_MILLIS = 10 * 1000;  // 10 seconds
  75     public static final int TWENTY_SECONDS_MILLIS = 20 * 1000;  // 20 seconds
  76 
  77     private static final String AUTH_PROVIDER = &quot;simplenote.com&quot;;
  78     private static final String TAG_SYNC = &quot;sync&quot;;
  79     private static final long HEARTBEAT_TIMEOUT =  WebSocketManager.HEARTBEAT_INTERVAL * 2;
  80 
  81     private Activity mCurrentActivity;
  82 
  83     private static Bucket&lt;Account&gt; mAccountBucket;
  84     private static Bucket&lt;Preferences&gt; mPreferencesBucket;
  85 
  86     private Bucket&lt;Note&gt; mNotesBucket;
  87     private Bucket&lt;Tag&gt; mTagsBucket;
  88     private SyncTimes&lt;Note&gt; mNoteSyncTimes;
  89     private Handler mHeartbeatHandler;
  90     private Runnable mHeartbeatRunnable;
  91     private Simperium mSimperium;
  92     private boolean mIsInBackground = true;
  93 
  94     public void onCreate() {
  95         super.onCreate();
  96 
  97         CrashUtils.initWithContext(this);
  98 
  99         SimplenoteAppLock appLock = new SimplenoteAppLock(this);
 100         AppLockManager.getInstance().setCurrentAppLock(appLock);
 101         appLock.enable();
 102 
 103         mSimperium = Simperium.newClient(
 104                 BuildConfig.SIMPERIUM_APP_ID,
 105                 BuildConfig.SIMPERIUM_APP_KEY,
 106                 this
 107         );
 108 
 109         mSimperium.setAuthProvider(AUTH_PROVIDER);
 110         mSimperium.addHeartbeatListener(this);
 111 
 112         mHeartbeatHandler = new Handler();
 113         mHeartbeatRunnable = new Runnable() {
 114             @Override
 115             public void run() {
 116                 AppLog.add(Type.NETWORK, &quot;Heartbeat stopped&quot;);
 117                 mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 118                 mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 119             }
 120         };
 121 
 122         SyncTimePersister syncTimePersister = new SyncTimePersister();
 123         mNoteSyncTimes = new SyncTimes&lt;&gt;(syncTimePersister.load());
 124         mNoteSyncTimes.addListener(syncTimePersister);
 125 
 126         try {
 127             mNotesBucket = mSimperium.bucket(new Note.Schema());
 128             mNotesBucket.addListener(mNoteSyncTimes.bucketListener);
 129             Tag.Schema tagSchema = new Tag.Schema();
 130             tagSchema.addIndex(new NoteCountIndexer(mNotesBucket));
 131             mTagsBucket = mSimperium.bucket(tagSchema);
 132             mPreferencesBucket = mSimperium.bucket(new Preferences.Schema());
 133             mAccountBucket = mSimperium.bucket(new Account.Schema());
 134             mAccountBucket.addOnNetworkChangeListener(
 135                     new AccountVerificationWatcher(this, new VerificationListener())
 136             );
 137             // Every time a note changes or is deleted we need to reindex the tag counts
 138             mNotesBucket.addListener(new NoteTagger(mTagsBucket));
 139         } catch (BucketNameInvalid e) {
 140             throw new RuntimeException(&quot;Could not create bucket&quot;, e);
 141         }
 142 
 143         AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);
 144 
 145         ApplicationLifecycleMonitor applicationLifecycleMonitor = new ApplicationLifecycleMonitor();
 146         registerComponentCallbacks(applicationLifecycleMonitor);
 147         registerActivityLifecycleCallbacks(applicationLifecycleMonitor);
 148 
 149         AnalyticsTracker.registerTracker(new AnalyticsTrackerNosara(this));
 150         AnalyticsTracker.refreshMetadata(mSimperium.getUser().getEmail());
 151         CrashUtils.setCurrentUser(mSimperium.getUser());
 152 
 153         AppLog.add(Type.DEVICE, getDeviceInfo());
 154         AppLog.add(Type.ACCOUNT, getAccountInfo());
 155         AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 156     }
 157 
 158     @Override
 159     public void onBeat() {
 160         AppLog.add(Type.NETWORK, &quot;Heartbeat received&quot;);
 161         mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 162         mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 163     }
 164 
 165     public static boolean analyticsIsEnabled() {
 166         if (mPreferencesBucket == null) {
 167             return true;
 168         }
 169 
 170         try {
 171             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 172             return prefs.getAnalyticsEnabled();
 173         } catch (BucketObjectMissingException e) {
 174             return true;
 175         }
 176     }
 177 
 178     private String getAccountInfo() {
<abbr title=" 179         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEmail() : &quot;?&quot;);"> 179         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUsðŸ”µ</abbr>
 180         String notes = &quot;Notes: &quot; + (mNotesBucket != null ? mNotesBucket.count() : &quot;?&quot;);
 181         String tags = &quot;Tags: &quot; + (mTagsBucket != null ? mTagsBucket.count() : &quot;?&quot;);
 182         return email + &quot;\n&quot; + notes + &quot;\n&quot; + tags + &quot;\n\n&quot;;
 183     }
 184 
 185     private String getDeviceInfo() {
<abbr title=" 186         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; : &quot;Android &quot;;"> 186         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;ChroðŸ”µ</abbr>
 187         String device = &quot;Device: &quot; + Build.MANUFACTURER + &quot; &quot; + Build.MODEL + &quot; (&quot; + Build.DEVICE + &quot;)&quot;;
<abbr title=" 188         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT + &quot;)&quot;;"> 188         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT ðŸ”µ</abbr>
 189         String app = &quot;App: Simplenote &quot; + PrefUtils.versionInfo();
 190         return device + &quot;\n&quot; + system + &quot;\n&quot; + app + &quot;\n\n&quot;;
 191     }
 192 
 193     public Simperium getSimperium() {
 194         return mSimperium;
 195     }
 196 
 197     public Bucket&lt;Note&gt; getNotesBucket() {
 198         return mNotesBucket;
 199     }
 200 
 201     public SyncTimes getNoteSyncTimes() {
 202         return mNoteSyncTimes;
 203     }
 204 
 205     public Bucket&lt;Tag&gt; getTagsBucket() {
 206         return mTagsBucket;
 207     }
 208 
 209     public Bucket&lt;Preferences&gt; getPreferencesBucket() {
 210         return mPreferencesBucket;
 211     }
 212 
 213     public Bucket&lt;Account&gt; getAccountBucket() {
 214         return mAccountBucket;
 215     }
 216 
 217     public boolean isInBackground() {
 218         return mIsInBackground;
 219     }
 220 
 221     public void loginWithToken(String email, String spToken) {
 222         // Manually authorize the user with Simperium
 223         User user = mSimperium.getUser();
 224         user.setAccessToken(spToken);
 225         user.setEmail(email);
 226         user.setStatus(User.Status.AUTHORIZED);
 227 
 228         // Store the user data in Simperium shared preferences
 229         SharedPreferences.Editor editor = AndroidClient.sharedPreferences(this).edit();
 230         editor.putString(USER_ACCESS_TOKEN_PREFERENCE, user.getAccessToken());
 231         editor.putString(USER_EMAIL_PREFERENCE, user.getEmail());
 232         editor.apply();
 233     }
 234 
 235     public boolean isLoggedIn() {
 236         User user = mSimperium.getUser();
 237         return user != null &amp;&amp; user.getStatus() == User.Status.AUTHORIZED;
 238     }
 239 
 240     public String getUserEmail() {
 241         User user = mSimperium.getUser();
 242         return user != null ? user.getEmail() : null;
 243     }
 244 
 245     private void showUnverifiedAccount() {
 246         showReviewAccountOrVerifyEmail(mCurrentActivity, false);
 247     }
 248 
 249     private void showWaitingOnEmailConfirmation() {
 250         showReviewAccountOrVerifyEmail(mCurrentActivity, true);
 251     }
 252 
 253     private void dismissReviewAccountDialog() {
 254         FragmentManager fragmentManager;
 255         if (mCurrentActivity instanceof NotesActivity) {
 256             fragmentManager = ((NotesActivity) mCurrentActivity).getSupportFragmentManager();
 257         } else if (mCurrentActivity instanceof NoteEditorActivity) {
 258             fragmentManager = ((NoteEditorActivity) mCurrentActivity).getSupportFragmentManager();
 259         } else {
 260             return;
 261         }
 262 
 263         for (Fragment fragment : fragmentManager.getFragments()) {
 264             if (fragment instanceof FullScreenDialogFragment) {
 265                 ((FullScreenDialogFragment) fragment).dismiss();
 266 
 267                 return;
 268             }
 269         }
 270     }
 271     private void showReviewAccountOrVerifyEmail(final Activity activity, boolean hasSentEmail) {
 272         final FragmentManager fragmentManager;
 273         final @IdRes int container;
 274 
 275         if (activity instanceof NotesActivity) {
 276             fragmentManager = ((NotesActivity) activity).getSupportFragmentManager();
 277             container = R.id.drawer_layout;
 278         } else if (activity instanceof NoteEditorActivity) {
 279             fragmentManager = ((NoteEditorActivity) activity).getSupportFragmentManager();
 280             container = android.R.id.content;
 281         } else {
 282             return;
 283         }
 284 
 285         final Bundle bundle = ReviewAccountVerifyEmailFragment.newBundle(hasSentEmail);
 286 
 287         new FullScreenDialogFragment.Builder(activity)
 288             .setContent(ReviewAccountVerifyEmailFragment.class, bundle)
 289             .setOnConfirmListener(null)
 290             .setOnDismissListener(null)
 291             .setToolbarElevation(0)
 292             .setViewContainer(container)
 293             .build()
 294             .show(fragmentManager, FullScreenDialogFragment.TAG);
 295     }
 296 
<abbr title=" 297     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbacks2 {"> 297     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponenðŸ”µ</abbr>
 298         // ComponentCallbacks
 299         @Override
 300         public void onTrimMemory(int level) {
 301             if (level == ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN) {
 302                 mIsInBackground = true;
 303 
 304                 // Give the buckets some time to finish sync, then stop them
 305                 new Handler().postDelayed(new Runnable() {
 306                     @Override
 307                     public void run() {
 308                         if (!mIsInBackground) {
 309                             return;
 310                         }
 311 
 312                         if (mAccountBucket != null) {
 313                             mAccountBucket.stop();
 314                             AppLog.add(Type.SYNC, &quot;Stopped account bucket (Simplenote)&quot;);
 315                         }
 316 
 317                         if (mNotesBucket != null) {
 318                             mNotesBucket.stop();
 319                             AppLog.add(Type.SYNC, &quot;Stopped note bucket (Simplenote)&quot;);
 320                         }
 321 
 322                         if (mTagsBucket != null) {
 323                             mTagsBucket.stop();
 324                             AppLog.add(Type.SYNC, &quot;Stopped tag bucket (Simplenote)&quot;);
 325                         }
 326 
 327                         if (mPreferencesBucket != null) {
 328                             mPreferencesBucket.stop();
 329                             AppLog.add(Type.SYNC, &quot;Stopped preference bucket (Simplenote)&quot;);
 330                         }
 331                     }
 332                 }, TEN_SECONDS_MILLIS);
 333 
 334                 PeriodicWorkRequest syncWorkRequest = new PeriodicWorkRequest.Builder(
 335                     SyncWorker.class,
 336                     PeriodicWorkRequest.MIN_PERIODIC_INTERVAL_MILLIS,
 337                     TimeUnit.MILLISECONDS
 338                 )
<abbr title=" 339                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build())"> 339                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTEðŸ”µ</abbr>
 340                     .setBackoffCriteria(BackoffPolicy.LINEAR, ONE_MINUTE_MILLIS, TimeUnit.MILLISECONDS)
 341                     .setInitialDelay(TWENTY_SECONDS_MILLIS, TimeUnit.MILLISECONDS)
 342                     .addTag(TAG_SYNC)
 343                     .build();
 344                 WorkManager.getInstance(getApplicationContext()).enqueueUniquePeriodicWork(
 345                     TAG_SYNC,
 346                     ExistingPeriodicWorkPolicy.REPLACE,
 347                     syncWorkRequest
 348                 );
 349                 Log.d(&quot;Simplenote.onTrimMemory&quot;, &quot;Started worker&quot;);
 350 
 351                 // Send analytics if app is in the background
 352                 AnalyticsTracker.track(
 353                         AnalyticsTracker.Stat.APPLICATION_CLOSED,
 354                         AnalyticsTracker.CATEGORY_USER,
 355                         &quot;application_closed&quot;
 356                 );
 357                 AnalyticsTracker.flush();
 358                 AppLog.add(Type.ACTION, &quot;App closed&quot;);
 359             } else {
 360                 mIsInBackground = false;
 361             }
 362         }
 363 
 364         @Override
 365         public void onConfigurationChanged(@NonNull Configuration newConfig) {
 366             AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 367         }
 368 
 369         @Override
 370         public void onLowMemory() {
 371         }
 372 
 373         // ActivityLifecycleCallbacks
 374         @SuppressLint(&quot;LongLogTag&quot;)
 375         @Override
 376         public void onActivityResumed(@NonNull Activity activity) {
 377             if (mIsInBackground) {
 378                 AnalyticsTracker.track(
 379                         AnalyticsTracker.Stat.APPLICATION_OPENED,
 380                         AnalyticsTracker.CATEGORY_USER,
 381                         &quot;application_opened&quot;
 382                 );
 383 
 384                 mIsInBackground = false;
 385                 AppLog.add(Type.ACTION, &quot;App opened&quot;);
 386                 WorkManager.getInstance(getApplicationContext()).cancelUniqueWork(TAG_SYNC);
 387                 Log.d(&quot;Simplenote.onActivityResumed&quot;, &quot;Stopped worker&quot;);
 388             }
 389 
 390             String activitySimpleName = activity.getClass().getSimpleName();
 391 
 392             mAccountBucket.start();
 393             AppLog.add(Type.SYNC, &quot;Started account bucket (&quot; + activitySimpleName + &quot;)&quot;);
 394             mPreferencesBucket.start();
 395             AppLog.add(Type.SYNC, &quot;Started preference bucket (&quot; + activitySimpleName + &quot;)&quot;);
 396             mNotesBucket.start();
 397             AppLog.add(Type.SYNC, &quot;Started note bucket (&quot; + activitySimpleName + &quot;)&quot;);
 398             mTagsBucket.start();
 399             AppLog.add(Type.SYNC, &quot;Started tag bucket (&quot; + activitySimpleName + &quot;)&quot;);
 400         }
 401 
 402         @Override
 403         public void onActivityCreated(@NonNull Activity activity, Bundle savedInstanceState) {
 404 
 405         }
 406 
 407         @Override
 408         public void onActivityStarted(@NonNull Activity activity) {
 409             mCurrentActivity = activity;
 410         }
 411 
 412         @Override
 413         public void onActivityPaused(@NonNull Activity activity) {
 414         }
 415 
 416         @Override
 417         public void onActivityStopped(@NonNull Activity activity) {
 418         }
 419 
 420         @Override
 421         public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle outState) {
 422         }
 423 
 424         @Override
 425         public void onActivityDestroyed(@NonNull Activity activity) {
 426         }
 427     }
 428 
 429     private class SyncTimePersister implements SyncTimes.SyncTimeListener {
 430         private final SharedPreferences mPreferences;
 431 
 432         public SyncTimePersister() {
 433             mPreferences = getSharedPreferences(SYNC_TIME_PREFERENCES, Context.MODE_PRIVATE);
 434         }
 435 
 436         public HashMap&lt;String, Calendar&gt; load() {
 437             HashMap&lt;String, Calendar&gt; syncTimes = new HashMap&lt;&gt;();
 438 
 439             //noinspection unchecked
<abbr title=" 440             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet()) {"> 440             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet(ðŸ”µ</abbr>
 441                 Calendar instant = Calendar.getInstance();
 442                 instant.setTimeInMillis(syncTime.getValue());
 443                 syncTimes.put(syncTime.getKey(), instant);
 444             }
 445 
 446             return syncTimes;
 447         }
 448 
 449         @Override
 450         public void onRemove(String entityId) {
 451             mPreferences.edit().remove(entityId).apply();
 452         }
 453 
 454         @Override
 455         public void onUpdate(String entityId, Calendar lastSyncTime, boolean isSynced) {
 456             mPreferences.edit().putLong(entityId, lastSyncTime.getTimeInMillis()).apply();
 457         }
 458     }
 459 
 460     private class VerificationListener implements AccountVerificationWatcher.VerificationStateListener {
 461         @Override
 462         public void onUpdate(AccountVerificationWatcher.Status status) {
 463             switch (status) {
 464                 case VERIFIED:
 465                     dismissReviewAccountDialog();
 466                     return;
 467 
 468                 case SENT_EMAIL:
 469                     showWaitingOnEmailConfirmation();
 470                     return;
 471 
 472                 case UNVERIFIED:
 473                     showUnverifiedAccount();
 474             }
 475         }
 476     }
 477 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.Application;
   6 import android.content.ComponentCallbacks2;
   7 import android.content.Context;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.Build;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.util.Log;
  14 import androidx.annotation.IdRes;
  15 import androidx.annotation.NonNull;
  16 import androidx.appcompat.app.AppCompatDelegate;
  17 import androidx.fragment.app.Fragment;
  18 import androidx.fragment.app.FragmentManager;
  19 import androidx.work.BackoffPolicy;
  20 import androidx.work.Constraints;
  21 import androidx.work.ExistingPeriodicWorkPolicy;
  22 import androidx.work.NetworkType;
  23 import androidx.work.PeriodicWorkRequest;
  24 import androidx.work.WorkManager;
  25 import com.automattic.simplenote.analytics.AnalyticsTracker;
  26 import com.automattic.simplenote.analytics.AnalyticsTrackerNosara;
  27 import com.automattic.simplenote.models.Account;
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.models.NoteCountIndexer;
  30 import com.automattic.simplenote.models.NoteTagger;
  31 import com.automattic.simplenote.models.Preferences;
  32 import com.automattic.simplenote.models.Tag;
  33 import com.automattic.simplenote.utils.AccountVerificationWatcher;
  34 import com.automattic.simplenote.utils.AppLog.Type;
  35 import com.automattic.simplenote.utils.AppLog;
  36 import com.automattic.simplenote.utils.CrashUtils;
  37 import com.automattic.simplenote.utils.DisplayUtils;
  38 import com.automattic.simplenote.utils.PrefUtils;
  39 import com.automattic.simplenote.utils.SyncWorker;
  40 import com.simperium.Simperium;
  41 import com.simperium.android.AndroidClient;
  42 import com.simperium.android.WebSocketManager;
  43 import com.simperium.client.Bucket;
  44 import com.simperium.client.BucketNameInvalid;
  45 import com.simperium.client.BucketObjectMissingException;
  46 import com.simperium.client.ChannelProvider.HeartbeatListener;
  47 import com.simperium.client.User;
  48 import dagger.hilt.android.HiltAndroidApp;
  49 import java.util.Calendar;
  50 import java.util.HashMap;
  51 import java.util.Map;
  52 import java.util.concurrent.TimeUnit;
  53 import org.wordpress.passcodelock.AppLockManager;
  54 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  55 import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;
  56 import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;
  57 
  58 
  59 @HiltAndroidApp
  60 public class Simplenote extends Application implements HeartbeatListener {
  61     public static final String DELETED_NOTE_ID = &quot;deletedNoteId&quot;;
  62 
  63     public static final String SELECTED_NOTE_ID = &quot;selectedNoteId&quot;;
  64 
  65     public static final String SCROLL_POSITION_PREFERENCES = &quot;scroll_position&quot;;
  66 
  67     public static final String SYNC_TIME_PREFERENCES = &quot;sync_time&quot;;
  68 
  69     public static final String TAG = &quot;Simplenote&quot;;
  70 
  71     public static final int INTENT_EDIT_NOTE = 2;
  72 
  73     public static final int INTENT_PREFERENCES = 1;
  74 
  75     // 60 seconds
  76     public static final int ONE_MINUTE_MILLIS = 60 * 1000;  // 60 seconds
  77 
  78     // 10 seconds
  79     public static final int TEN_SECONDS_MILLIS = 10 * 1000;  // 10 seconds
  80 
  81     // 20 seconds
  82     public static final int TWENTY_SECONDS_MILLIS = 20 * 1000;  // 20 seconds
  83 
  84     private static final String AUTH_PROVIDER = &quot;simplenote.com&quot;;
  85 
  86     private static final String TAG_SYNC = &quot;sync&quot;;
  87 
  88     private static final long HEARTBEAT_TIMEOUT =  WebSocketManager.HEARTBEAT_INTERVAL * 2;
  89 
  90     private Activity mCurrentActivity;
  91 
  92     private static Bucket&lt;Account&gt; mAccountBucket;
  93 
  94     private static Bucket&lt;Preferences&gt; mPreferencesBucket;
  95 
  96     private Bucket&lt;Note&gt; mNotesBucket;
  97 
  98     private Bucket&lt;Tag&gt; mTagsBucket;
  99 
 100     private SyncTimes&lt;Note&gt; mNoteSyncTimes;
 101 
 102     private Handler mHeartbeatHandler;
 103 
 104     private Runnable mHeartbeatRunnable;
 105 
 106     private Simperium mSimperium;
 107 
 108     private boolean mIsInBackground = true;
 109 
 110     public void onCreate() {
 111         super.onCreate();
 112         CrashUtils.initWithContext(this);
 113         SimplenoteAppLock appLock = new SimplenoteAppLock(this);
 114         AppLockManager.getInstance().setCurrentAppLock(appLock);
 115         appLock.enable();
<abbr title=" 116         mSimperium = Simperium.newClient(BuildConfig.SIMPERIUM_APP_ID, BuildConfig.SIMPERIUM_APP_KEY, this);"> 116         mSimperium = Simperium.newClient(BuildConfig.SIMPERIUM_APP_ID, BuildConfig.SIMPERIUM_APP_KEY, thiðŸ”µ</abbr>
 117         mSimperium.setAuthProvider(AUTH_PROVIDER);
 118         mSimperium.addHeartbeatListener(this);
 119         mHeartbeatHandler = new Handler();
 120         mHeartbeatRunnable = new Runnable() {
 121             @Override
 122             public void run() {
 123                 AppLog.add(Type.NETWORK, &quot;Heartbeat stopped&quot;);
 124                 mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 125                 mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 126             }
 127         };
 128         SyncTimePersister syncTimePersister = new SyncTimePersister();
 129         mNoteSyncTimes = new SyncTimes&lt;&gt;(syncTimePersister.load());
 130         mNoteSyncTimes.addListener(syncTimePersister);
 131         try {
 132             mNotesBucket = mSimperium.bucket(new Note.Schema());
 133             mNotesBucket.addListener(mNoteSyncTimes.bucketListener);
 134             Tag.Schema tagSchema = new Tag.Schema();
 135             tagSchema.addIndex(new NoteCountIndexer(mNotesBucket));
 136             mTagsBucket = mSimperium.bucket(tagSchema);
 137             mPreferencesBucket = mSimperium.bucket(new Preferences.Schema());
 138             mAccountBucket = mSimperium.bucket(new Account.Schema());
<abbr title=" 139             mAccountBucket.addOnNetworkChangeListener(new AccountVerificationWatcher(this, new VerificationListener()));"> 139             mAccountBucket.addOnNetworkChangeListener(new AccountVerificationWatcher(this, new VerificatiðŸ”µ</abbr>
 140             // Every time a note changes or is deleted we need to reindex the tag counts
 141             mNotesBucket.addListener(new NoteTagger(mTagsBucket));
 142         } catch (BucketNameInvalid e) {
 143             throw new RuntimeException(&quot;Could not create bucket&quot;, e);
 144         }
 145         AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);
 146         ApplicationLifecycleMonitor applicationLifecycleMonitor = new ApplicationLifecycleMonitor();
 147         registerComponentCallbacks(applicationLifecycleMonitor);
 148         registerActivityLifecycleCallbacks(applicationLifecycleMonitor);
 149         AnalyticsTracker.registerTracker(new AnalyticsTrackerNosara(this));
 150         AnalyticsTracker.refreshMetadata(mSimperium.getUser().getEmail());
 151         CrashUtils.setCurrentUser(mSimperium.getUser());
 152         AppLog.add(Type.DEVICE, getDeviceInfo());
 153         AppLog.add(Type.ACCOUNT, getAccountInfo());
 154         AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(this));
 155     }
 156 
 157     @Override
 158     public void onBeat() {
 159         AppLog.add(Type.NETWORK, &quot;Heartbeat received&quot;);
 160         mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 161         mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 162     }
 163 
 164     public static boolean analyticsIsEnabled() {
 165         if (mPreferencesBucket == null) {
 166             return true;
 167         }
 168 
 169         try {
 170             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 171             return prefs.getAnalyticsEnabled();
 172         } catch (BucketObjectMissingException e) {
 173             return true;
 174         }
 175     }
 176 
 177     private String getAccountInfo() {
<abbr title=" 178         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEmail() : &quot;?&quot;);"> 178         String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUsðŸ”µ</abbr>
 179         String notes = &quot;Notes: &quot; + (mNotesBucket != null ? mNotesBucket.count() : &quot;?&quot;);
 180         String tags = &quot;Tags: &quot; + (mTagsBucket != null ? mTagsBucket.count() : &quot;?&quot;);
 181         return email + &quot;\n&quot; + notes + &quot;\n&quot; + tags + &quot;\n\n&quot;;
 182     }
 183 
 184     private String getDeviceInfo() {
<abbr title=" 185         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; : &quot;Android &quot;;"> 185         String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;ChroðŸ”µ</abbr>
 186         String device = &quot;Device: &quot; + Build.MANUFACTURER + &quot; &quot; + Build.MODEL + &quot; (&quot; + Build.DEVICE + &quot;)&quot;;
<abbr title=" 187         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT + &quot;)&quot;;"> 187         String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT ðŸ”µ</abbr>
 188         String app = &quot;App: Simplenote &quot; + PrefUtils.versionInfo();
 189         return device + &quot;\n&quot; + system + &quot;\n&quot; + app + &quot;\n\n&quot;;
 190     }
 191 
 192     public Simperium getSimperium() {
 193         return mSimperium;
 194     }
 195 
 196     public Bucket&lt;Note&gt; getNotesBucket() {
 197         return mNotesBucket;
 198     }
 199 
 200     public SyncTimes getNoteSyncTimes() {
 201         return mNoteSyncTimes;
 202     }
 203 
 204     public Bucket&lt;Tag&gt; getTagsBucket() {
 205         return mTagsBucket;
 206     }
 207 
 208     public Bucket&lt;Preferences&gt; getPreferencesBucket() {
 209         return mPreferencesBucket;
 210     }
 211 
 212     public Bucket&lt;Account&gt; getAccountBucket() {
 213         return mAccountBucket;
 214     }
 215 
 216     public boolean isInBackground() {
 217         return mIsInBackground;
 218     }
 219 
 220     public void loginWithToken(String email, String spToken) {
 221         // Manually authorize the user with Simperium
 222         User user = mSimperium.getUser();
 223         user.setAccessToken(spToken);
 224         user.setEmail(email);
 225         user.setStatus(User.Status.AUTHORIZED);
 226 
 227         // Store the user data in Simperium shared preferences
 228         SharedPreferences.Editor editor = AndroidClient.sharedPreferences(this).edit();
 229         editor.putString(USER_ACCESS_TOKEN_PREFERENCE, user.getAccessToken());
 230         editor.putString(USER_EMAIL_PREFERENCE, user.getEmail());
 231         editor.apply();
 232     }
 233 
 234     public boolean isLoggedIn() {
 235         User user = mSimperium.getUser();
 236         return user != null &amp;&amp; user.getStatus() == User.Status.AUTHORIZED;
 237     }
 238 
 239     public String getUserEmail() {
 240         User user = mSimperium.getUser();
 241         return user != null ? user.getEmail() : null;
 242     }
 243 
 244     private void showUnverifiedAccount() {
 245         showReviewAccountOrVerifyEmail(mCurrentActivity, false);
 246     }
 247 
 248     private void showWaitingOnEmailConfirmation() {
 249         showReviewAccountOrVerifyEmail(mCurrentActivity, true);
 250     }
 251 
 252     private void dismissReviewAccountDialog() {
 253         FragmentManager fragmentManager;
 254         if (mCurrentActivity instanceof NotesActivity) {
 255             fragmentManager = ((NotesActivity) (mCurrentActivity)).getSupportFragmentManager();
 256         } else if (mCurrentActivity instanceof NoteEditorActivity) {
 257             fragmentManager = ((NoteEditorActivity) (mCurrentActivity)).getSupportFragmentManager();
 258         } else {
 259             return;
 260         }
 261         for (Fragment fragment : fragmentManager.getFragments()) {
 262             if (fragment instanceof FullScreenDialogFragment) {
 263                 ((FullScreenDialogFragment) (fragment)).dismiss();
 264                 return;
 265             }
 266         }
 267     }
 268 
 269     private void showReviewAccountOrVerifyEmail(final Activity activity, boolean hasSentEmail) {
 270         final FragmentManager fragmentManager;
 271         @IdRes
 272         final int container;
 273         if (activity instanceof NotesActivity) {
 274             fragmentManager = ((NotesActivity) (activity)).getSupportFragmentManager();
 275             container = R.id.drawer_layout;
 276         } else if (activity instanceof NoteEditorActivity) {
 277             fragmentManager = ((NoteEditorActivity) (activity)).getSupportFragmentManager();
 278             container = android.R.id.content;
 279         } else {
 280             return;
 281         }
 282         final Bundle bundle = ReviewAccountVerifyEmailFragment.newBundle(hasSentEmail);
<abbr title=" 283         new FullScreenDialogFragment.Builder(activity).setContent(ReviewAccountVerifyEmailFragment.class, bundle).setOnConfirmListener(null).setOnDismissListener(null).setToolbarElevation(0).setViewContainer(container).build().show(fragmentManager, FullScreenDialogFragment.TAG);"> 283         new FullScreenDialogFragment.Builder(activity).setContent(ReviewAccountVerifyEmailFragment.class,ðŸ”µ</abbr>
 284     }
 285 
<abbr title=" 286     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks , ComponentCallbacks2 {"> 286     private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks , ComponeðŸ”µ</abbr>
 287         // ComponentCallbacks
 288         @Override
 289         public void onTrimMemory(int level) {
 290             if (level == ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN) {
 291                 mIsInBackground = true;
 292 
 293                 // Give the buckets some time to finish sync, then stop them
 294                 new Handler().postDelayed(new Runnable() {
 295                     @Override
 296                     public void run() {
 297                         if (!mIsInBackground) {
 298                             return;
 299                         }
 300 
 301                         if (mAccountBucket != null) {
 302                             mAccountBucket.stop();
 303                             AppLog.add(Type.SYNC, &quot;Stopped account bucket (Simplenote)&quot;);
 304                         }
 305 
 306                         if (mNotesBucket != null) {
 307                             mNotesBucket.stop();
 308                             AppLog.add(Type.SYNC, &quot;Stopped note bucket (Simplenote)&quot;);
 309                         }
 310 
 311                         if (mTagsBucket != null) {
 312                             mTagsBucket.stop();
 313                             AppLog.add(Type.SYNC, &quot;Stopped tag bucket (Simplenote)&quot;);
 314                         }
 315 
 316                         if (mPreferencesBucket != null) {
 317                             mPreferencesBucket.stop();
 318                             AppLog.add(Type.SYNC, &quot;Stopped preference bucket (Simplenote)&quot;);
 319                         }
 320                     }
 321                 }, TEN_SECONDS_MILLIS);
 322 
 323                 PeriodicWorkRequest syncWorkRequest = new PeriodicWorkRequest.Builder(
 324                     SyncWorker.class,
 325                     PeriodicWorkRequest.MIN_PERIODIC_INTERVAL_MILLIS,
 326                     TimeUnit.MILLISECONDS
 327                 )
<abbr title=" 328                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build())"> 328                     .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTEðŸ”µ</abbr>
 329                     .setBackoffCriteria(BackoffPolicy.LINEAR, ONE_MINUTE_MILLIS, TimeUnit.MILLISECONDS)
 330                     .setInitialDelay(TWENTY_SECONDS_MILLIS, TimeUnit.MILLISECONDS)
 331                     .addTag(TAG_SYNC)
 332                     .build();
 333                 WorkManager.getInstance(getApplicationContext()).enqueueUniquePeriodicWork(
 334                     TAG_SYNC,
 335                     ExistingPeriodicWorkPolicy.REPLACE,
 336                     syncWorkRequest
 337                 );
 338                 Log.d(&quot;Simplenote.onTrimMemory&quot;, &quot;Started worker&quot;);
 339 
 340                 // Send analytics if app is in the background
 341                 AnalyticsTracker.track(
 342                         AnalyticsTracker.Stat.APPLICATION_CLOSED,
 343                         AnalyticsTracker.CATEGORY_USER,
 344                         &quot;application_closed&quot;
 345                 );
 346                 AnalyticsTracker.flush();
 347                 AppLog.add(Type.ACTION, &quot;App closed&quot;);
 348             } else {
 349                 mIsInBackground = false;
 350             }
 351         }
 352 
 353         @Override
 354         public void onConfigurationChanged(@NonNull Configuration newConfig) {
 355             AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 356         }
 357 
 358         @Override
 359         public void onLowMemory() {
 360         }
 361 
 362         // ActivityLifecycleCallbacks
 363         @SuppressLint(&quot;LongLogTag&quot;)
 364         @Override
 365         public void onActivityResumed(@NonNull Activity activity) {
 366             if (mIsInBackground) {
 367                 AnalyticsTracker.track(
 368                         AnalyticsTracker.Stat.APPLICATION_OPENED,
 369                         AnalyticsTracker.CATEGORY_USER,
 370                         &quot;application_opened&quot;
 371                 );
 372 
 373                 mIsInBackground = false;
 374                 AppLog.add(Type.ACTION, &quot;App opened&quot;);
 375                 WorkManager.getInstance(getApplicationContext()).cancelUniqueWork(TAG_SYNC);
 376                 Log.d(&quot;Simplenote.onActivityResumed&quot;, &quot;Stopped worker&quot;);
 377             }
 378 
 379             String activitySimpleName = activity.getClass().getSimpleName();
 380 
 381             mAccountBucket.start();
 382             AppLog.add(Type.SYNC, &quot;Started account bucket (&quot; + activitySimpleName + &quot;)&quot;);
 383             mPreferencesBucket.start();
 384             AppLog.add(Type.SYNC, &quot;Started preference bucket (&quot; + activitySimpleName + &quot;)&quot;);
 385             mNotesBucket.start();
 386             AppLog.add(Type.SYNC, &quot;Started note bucket (&quot; + activitySimpleName + &quot;)&quot;);
 387             mTagsBucket.start();
 388             AppLog.add(Type.SYNC, &quot;Started tag bucket (&quot; + activitySimpleName + &quot;)&quot;);
 389         }
 390 
 391         @Override
 392         public void onActivityCreated(@NonNull
 393         Activity activity, Bundle savedInstanceState) {
 394         }
 395 
 396         @Override
 397         public void onActivityStarted(@NonNull
 398         Activity activity) {
 399             mCurrentActivity = activity;
 400         }
 401 
 402         @Override
 403         public void onActivityPaused(@NonNull Activity activity) {
 404         }
 405 
 406         @Override
 407         public void onActivityStopped(@NonNull Activity activity) {
 408         }
 409 
 410         @Override
 411         public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle outState) {
 412         }
 413 
 414         @Override
 415         public void onActivityDestroyed(@NonNull Activity activity) {
 416         }
 417     }
 418 
 419     private class SyncTimePersister implements SyncTimes.SyncTimeListener {
 420         private final SharedPreferences mPreferences;
 421 
 422         public SyncTimePersister() {
 423             mPreferences = getSharedPreferences(SYNC_TIME_PREFERENCES, Context.MODE_PRIVATE);
 424         }
 425 
 426         public HashMap&lt;String, Calendar&gt; load() {
 427             HashMap&lt;String, Calendar&gt; syncTimes = new HashMap&lt;&gt;();
 428             // noinspection unchecked
<abbr title=" 429             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) (mPreferences.getAll())).entrySet()) {"> 429             for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) (mPreferences.getAll())).entrySeðŸ”µ</abbr>
 430                 Calendar instant = Calendar.getInstance();
 431                 instant.setTimeInMillis(syncTime.getValue());
 432                 syncTimes.put(syncTime.getKey(), instant);
 433             }
 434             return syncTimes;
 435         }
 436 
 437         @Override
 438         public void onRemove(String entityId) {
 439             mPreferences.edit().remove(entityId).apply();
 440         }
 441 
 442         @Override
 443         public void onUpdate(String entityId, Calendar lastSyncTime, boolean isSynced) {
 444             mPreferences.edit().putLong(entityId, lastSyncTime.getTimeInMillis()).apply();
 445         }
 446     }
 447 
 448     private class VerificationListener implements AccountVerificationWatcher.VerificationStateListener {
 449         @Override
 450         public void onUpdate(AccountVerificationWatcher.Status status) {
 451             switch (status) {
 452                 case VERIFIED :
 453                     dismissReviewAccountDialog();
 454                     return;
 455                 case SENT_EMAIL :
 456                     showWaitingOnEmailConfirmation();
 457                     return;
 458                 case UNVERIFIED :
 459                     showUnverifiedAccount();
 460             }
 461         }
 462     }
 463 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;</span>

   6  
   7  import android.annotation.SuppressLint;
   8  import android.app.Activity;
   9  import android.app.Application;
  10  import android.content.ComponentCallbacks2;
  11  import android.content.Context;
  12  import android.content.SharedPreferences;
  13  import android.content.res.Configuration;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 -import android.net.Uri;</span>
  15  import android.os.Build;
  16  import android.os.Bundle;
  17  import android.os.Handler;
  18  import android.util.Log;
  19  
  20  import androidx.annotation.IdRes;
  21  import androidx.annotation.NonNull;
  22  import androidx.appcompat.app.AppCompatDelegate;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import androidx.fragment.app.Fragment;</span>
  24  import androidx.fragment.app.FragmentManager;
  25  import androidx.work.BackoffPolicy;
  26  import androidx.work.Constraints;
  27  import androidx.work.ExistingPeriodicWorkPolicy;
  28  import androidx.work.NetworkType;
  29  import androidx.work.PeriodicWorkRequest;
  30  import androidx.work.WorkManager;
  31  
  32  import com.automattic.simplenote.analytics.AnalyticsTracker;
  33  import com.automattic.simplenote.analytics.AnalyticsTrackerNosara;
  34  import com.automattic.simplenote.models.Account;
  35  import com.automattic.simplenote.models.Note;
  36  import com.automattic.simplenote.models.NoteCountIndexer;
  37  import com.automattic.simplenote.models.NoteTagger;
  38  import com.automattic.simplenote.models.Preferences;
  39  import com.automattic.simplenote.models.Tag;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.automattic.simplenote.utils.AccountVerificationWatcher;</span>
  41  import com.automattic.simplenote.utils.AppLog;
  42  import com.automattic.simplenote.utils.AppLog.Type;
  43  import com.automattic.simplenote.utils.CrashUtils;
  44  import com.automattic.simplenote.utils.DisplayUtils;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import com.automattic.simplenote.utils.NetworkUtils;</span>
  46  import com.automattic.simplenote.utils.PrefUtils;
  47  import com.automattic.simplenote.utils.SyncWorker;
  48  import com.simperium.Simperium;
  49  import com.simperium.android.AndroidClient;
  50  import com.simperium.android.WebSocketManager;
  51  import com.simperium.client.Bucket;
  52  import com.simperium.client.BucketNameInvalid;
  53  import com.simperium.client.BucketObjectMissingException;
  54  import com.simperium.client.ChannelProvider.HeartbeatListener;
  55  import com.simperium.client.User;
  56  
  57  import org.wordpress.passcodelock.AppLockManager;
  58  
  59  import java.util.Calendar;
  60  import java.util.HashMap;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -import java.util.Locale;</span>
  62  import java.util.Map;
  63  import java.util.concurrent.TimeUnit;
  64  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import static com.automattic.simplenote.models.Account.KEY_EMAIL_VERIFICATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +import dagger.hilt.android.HiltAndroidApp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +@HiltAndroidApp</span>
  73  public class Simplenote extends Application implements HeartbeatListener {
  74      public static final String DELETED_NOTE_ID = &quot;deletedNoteId&quot;;
  75      public static final String SELECTED_NOTE_ID = &quot;selectedNoteId&quot;;
  76      public static final String SCROLL_POSITION_PREFERENCES = &quot;scroll_position&quot;;
  77      public static final String SYNC_TIME_PREFERENCES = &quot;sync_time&quot;;
  78      public static final String TAG = &quot;Simplenote&quot;;
  79      public static final int INTENT_EDIT_NOTE = 2;
  80      public static final int INTENT_PREFERENCES = 1;
  81      public static final int ONE_MINUTE_MILLIS = 60 * 1000;  // 60 seconds
  82      public static final int TEN_SECONDS_MILLIS = 10 * 1000;  // 10 seconds
  83      public static final int TWENTY_SECONDS_MILLIS = 20 * 1000;  // 20 seconds
  84  
  85      private static final String AUTH_PROVIDER = &quot;simplenote.com&quot;;
  86      private static final String TAG_SYNC = &quot;sync&quot;;
  87      private static final long HEARTBEAT_TIMEOUT =  WebSocketManager.HEARTBEAT_INTERVAL * 2;
  88  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +    private Activity mCurrentActivity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
  91      private static Bucket&lt;Account&gt; mAccountBucket;
  92      private static Bucket&lt;Preferences&gt; mPreferencesBucket;
  93  
  94      private Bucket&lt;Note&gt; mNotesBucket;
  95      private Bucket&lt;Tag&gt; mTagsBucket;
  96      private SyncTimes&lt;Note&gt; mNoteSyncTimes;
  97      private Handler mHeartbeatHandler;
  98      private Runnable mHeartbeatRunnable;
  99      private Simperium mSimperium;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -    private boolean mHasShownReviewOrVerify;</span>
 101      private boolean mIsInBackground = true;
 102  
 103      public void onCreate() {
 104          super.onCreate();
 105  
 106          CrashUtils.initWithContext(this);
 107  
 108          SimplenoteAppLock appLock = new SimplenoteAppLock(this);
 109          AppLockManager.getInstance().setCurrentAppLock(appLock);
 110          appLock.enable();
 111  
 112          mSimperium = Simperium.newClient(
 113                  BuildConfig.SIMPERIUM_APP_ID,
 114                  BuildConfig.SIMPERIUM_APP_KEY,
 115                  this
 116          );
 117  
 118          mSimperium.setAuthProvider(AUTH_PROVIDER);
 119          mSimperium.addHeartbeatListener(this);
 120  
 121          mHeartbeatHandler = new Handler();
 122          mHeartbeatRunnable = new Runnable() {
 123              @Override
 124              public void run() {
 125                  AppLog.add(Type.NETWORK, &quot;Heartbeat stopped&quot;);
 126                  mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 127                  mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 128              }
 129          };
 130  
 131          SyncTimePersister syncTimePersister = new SyncTimePersister();
 132          mNoteSyncTimes = new SyncTimes&lt;&gt;(syncTimePersister.load());
 133          mNoteSyncTimes.addListener(syncTimePersister);
 134  
 135          try {
 136              mNotesBucket = mSimperium.bucket(new Note.Schema());
 137              mNotesBucket.addListener(mNoteSyncTimes.bucketListener);
 138              Tag.Schema tagSchema = new Tag.Schema();
 139              tagSchema.addIndex(new NoteCountIndexer(mNotesBucket));
 140              mTagsBucket = mSimperium.bucket(tagSchema);
 141              mPreferencesBucket = mSimperium.bucket(new Preferences.Schema());
 142              mAccountBucket = mSimperium.bucket(new Account.Schema());
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +            mAccountBucket.addOnNetworkChangeListener(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    new AccountVerificationWatcher(this, new VerificationListener())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +            );</span>
 146              // Every time a note changes or is deleted we need to reindex the tag counts
 147              mNotesBucket.addListener(new NoteTagger(mTagsBucket));
 148          } catch (BucketNameInvalid e) {
 149              throw new RuntimeException(&quot;Could not create bucket&quot;, e);
 150          }
 151  
 152          AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);
 153  
 154          ApplicationLifecycleMonitor applicationLifecycleMonitor = new ApplicationLifecycleMonitor();
 155          registerComponentCallbacks(applicationLifecycleMonitor);
 156          registerActivityLifecycleCallbacks(applicationLifecycleMonitor);
 157  
 158          AnalyticsTracker.registerTracker(new AnalyticsTrackerNosara(this));
 159          AnalyticsTracker.refreshMetadata(mSimperium.getUser().getEmail());
 160          CrashUtils.setCurrentUser(mSimperium.getUser());
 161  
 162          AppLog.add(Type.DEVICE, getDeviceInfo());
 163          AppLog.add(Type.ACCOUNT, getAccountInfo());
 164          AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 165      }
 166  
 167      @Override
 168      public void onBeat() {
 169          AppLog.add(Type.NETWORK, &quot;Heartbeat received&quot;);
 170          mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 171          mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -    private boolean isFirstLaunch() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        // NotesActivity sets this pref to false after first launch</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -        return PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true);</span>
 177      }
 178  
 179      public static boolean analyticsIsEnabled() {
 180          if (mPreferencesBucket == null) {
 181              return true;
 182          }
 183  
 184          try {
 185              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 186              return prefs.getAnalyticsEnabled();
 187          } catch (BucketObjectMissingException e) {
 188              return true;
 189          }
 190      }
 191  
 192      private String getAccountInfo() {
<abbr title=" 193          String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEmail() : &quot;?&quot;);"> 193          String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEðŸ”µ</abbr>
 194          String notes = &quot;Notes: &quot; + (mNotesBucket != null ? mNotesBucket.count() : &quot;?&quot;);
 195          String tags = &quot;Tags: &quot; + (mTagsBucket != null ? mTagsBucket.count() : &quot;?&quot;);
 196          return email + &quot;\n&quot; + notes + &quot;\n&quot; + tags + &quot;\n\n&quot;;
 197      }
 198  
 199      private String getDeviceInfo() {
<abbr title=" 200          String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; : &quot;Android &quot;;"> 200          String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; :ðŸ”µ</abbr>
 201          String device = &quot;Device: &quot; + Build.MANUFACTURER + &quot; &quot; + Build.MODEL + &quot; (&quot; + Build.DEVICE + &quot;)&quot;;
 202          String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT + &quot;)&quot;;
 203          String app = &quot;App: Simplenote &quot; + PrefUtils.versionInfo();
 204          return device + &quot;\n&quot; + system + &quot;\n&quot; + app + &quot;\n\n&quot;;
 205      }
 206  
 207      public Simperium getSimperium() {
 208          return mSimperium;
 209      }
 210  
 211      public Bucket&lt;Note&gt; getNotesBucket() {
 212          return mNotesBucket;
 213      }
 214  
 215      public SyncTimes getNoteSyncTimes() {
 216          return mNoteSyncTimes;
 217      }
 218  
 219      public Bucket&lt;Tag&gt; getTagsBucket() {
 220          return mTagsBucket;
 221      }
 222  
 223      public Bucket&lt;Preferences&gt; getPreferencesBucket() {
 224          return mPreferencesBucket;
 225      }
 226  
 227      public Bucket&lt;Account&gt; getAccountBucket() {
 228          return mAccountBucket;
 229      }
 230  
 231      public boolean isInBackground() {
 232          return mIsInBackground;
 233      }
 234  
 235      public void loginWithToken(String email, String spToken) {
 236          // Manually authorize the user with Simperium
 237          User user = mSimperium.getUser();
 238          user.setAccessToken(spToken);
 239          user.setEmail(email);
 240          user.setStatus(User.Status.AUTHORIZED);
 241  
 242          // Store the user data in Simperium shared preferences
 243          SharedPreferences.Editor editor = AndroidClient.sharedPreferences(this).edit();
 244          editor.putString(USER_ACCESS_TOKEN_PREFERENCE, user.getAccessToken());
 245          editor.putString(USER_EMAIL_PREFERENCE, user.getEmail());
 246          editor.apply();
 247      }
 248  
 249      public boolean isLoggedIn() {
 250          User user = mSimperium.getUser();
 251          return user != null &amp;&amp; user.getStatus() == User.Status.AUTHORIZED;
 252      }
 253  
 254      public String getUserEmail() {
 255          User user = mSimperium.getUser();
 256          return user != null ? user.getEmail() : null;
 257      }
 258  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -    private void checkReviewAccountOrVerifyEmail(final Activity activity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -        if (isFirstLaunch() || !NetworkUtils.isNetworkAvailable(this) || mHasShownReviewOrVerify) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -            // Show nothing on first launch, no network connection, or has already shown review/verify.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +    private void showUnverifiedAccount() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +        showReviewAccountOrVerifyEmail(mCurrentActivity, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +    private void showWaitingOnEmailConfirmation() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +        showReviewAccountOrVerifyEmail(mCurrentActivity, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +    private void dismissReviewAccountDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        FragmentManager fragmentManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        if (mCurrentActivity instanceof NotesActivity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            fragmentManager = ((NotesActivity) mCurrentActivity).getSupportFragmentManager();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +        } else if (mCurrentActivity instanceof NoteEditorActivity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            fragmentManager = ((NoteEditorActivity) mCurrentActivity).getSupportFragmentManager();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +        } else {</span>
 277              return;
 278          }
 279  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        Account account;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -            account = mAccountBucket.get(KEY_EMAIL_VERIFICATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -        } catch (BucketObjectMissingException bucketObjectMissingException) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -            // Show review account when entity does not exist.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -            showReviewAccountOrVerifyEmail(activity, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -        if (mSimperium == null || mSimperium.getUser() == null || mSimperium.getUser().getEmail() == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -            // Show nothing when Simperium, user, or email cannot be retrieved.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        String email = mSimperium.getUser().getEmail();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -        if (account.hasVerifiedEmail(email)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -            // Show nothing when email has been verified.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -        // Show verify email when email has been sent to account address.  Show review account otherwise.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -        showReviewAccountOrVerifyEmail(activity, account.hasSentEmail(email));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +        for (Fragment fragment : fragmentManager.getFragments()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +            if (fragment instanceof FullScreenDialogFragment) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +                ((FullScreenDialogFragment) fragment).dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +    }</span>
 314      private void showReviewAccountOrVerifyEmail(final Activity activity, boolean hasSentEmail) {
 315          final FragmentManager fragmentManager;
 316          final @IdRes int container;
 317  
 318          if (activity instanceof NotesActivity) {
 319              fragmentManager = ((NotesActivity) activity).getSupportFragmentManager();
 320              container = R.id.drawer_layout;
 321          } else if (activity instanceof NoteEditorActivity) {
 322              fragmentManager = ((NoteEditorActivity) activity).getSupportFragmentManager();
 323              container = android.R.id.content;
 324          } else {
 325              return;
 326          }
 327  
 328          final Bundle bundle = ReviewAccountVerifyEmailFragment.newBundle(hasSentEmail);
 329  
 330          new FullScreenDialogFragment.Builder(activity)
 331              .setContent(ReviewAccountVerifyEmailFragment.class, bundle)
 332              .setOnConfirmListener(null)
 333              .setOnDismissListener(null)
 334              .setToolbarElevation(0)
 335              .setViewContainer(container)
 336              .build()
 337              .show(fragmentManager, FullScreenDialogFragment.TAG);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -        mHasShownReviewOrVerify = true;</span>
 340      }
 341  
<abbr title=" 342      private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbacks2 {"> 342      private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbackðŸ”µ</abbr>
 343          // ComponentCallbacks
 344          @Override
 345          public void onTrimMemory(int level) {
 346              if (level == ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN) {
 347                  mIsInBackground = true;
 348  
 349                  // Give the buckets some time to finish sync, then stop them
 350                  new Handler().postDelayed(new Runnable() {
 351                      @Override
 352                      public void run() {
 353                          if (!mIsInBackground) {
 354                              return;
 355                          }
 356  
 357                          if (mAccountBucket != null) {
 358                              mAccountBucket.stop();
 359                              AppLog.add(Type.SYNC, &quot;Stopped account bucket (Simplenote)&quot;);
 360                          }
 361  
 362                          if (mNotesBucket != null) {
 363                              mNotesBucket.stop();
 364                              AppLog.add(Type.SYNC, &quot;Stopped note bucket (Simplenote)&quot;);
 365                          }
 366  
 367                          if (mTagsBucket != null) {
 368                              mTagsBucket.stop();
 369                              AppLog.add(Type.SYNC, &quot;Stopped tag bucket (Simplenote)&quot;);
 370                          }
 371  
 372                          if (mPreferencesBucket != null) {
 373                              mPreferencesBucket.stop();
 374                              AppLog.add(Type.SYNC, &quot;Stopped preference bucket (Simplenote)&quot;);
 375                          }
 376                      }
 377                  }, TEN_SECONDS_MILLIS);
 378  
 379                  PeriodicWorkRequest syncWorkRequest = new PeriodicWorkRequest.Builder(
 380                      SyncWorker.class,
 381                      PeriodicWorkRequest.MIN_PERIODIC_INTERVAL_MILLIS,
 382                      TimeUnit.MILLISECONDS
 383                  )
<abbr title=" 384                      .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build())"> 384                      .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build(ðŸ”µ</abbr>
 385                      .setBackoffCriteria(BackoffPolicy.LINEAR, ONE_MINUTE_MILLIS, TimeUnit.MILLISECONDS)
 386                      .setInitialDelay(TWENTY_SECONDS_MILLIS, TimeUnit.MILLISECONDS)
 387                      .addTag(TAG_SYNC)
 388                      .build();
 389                  WorkManager.getInstance(getApplicationContext()).enqueueUniquePeriodicWork(
 390                      TAG_SYNC,
 391                      ExistingPeriodicWorkPolicy.REPLACE,
 392                      syncWorkRequest
 393                  );
 394                  Log.d(&quot;Simplenote.onTrimMemory&quot;, &quot;Started worker&quot;);
 395  
 396                  // Send analytics if app is in the background
 397                  AnalyticsTracker.track(
 398                          AnalyticsTracker.Stat.APPLICATION_CLOSED,
 399                          AnalyticsTracker.CATEGORY_USER,
 400                          &quot;application_closed&quot;
 401                  );
 402                  AnalyticsTracker.flush();
 403                  AppLog.add(Type.ACTION, &quot;App closed&quot;);
 404              } else {
 405                  mIsInBackground = false;
 406              }
 407          }
 408  
 409          @Override
 410          public void onConfigurationChanged(@NonNull Configuration newConfig) {
 411              AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 412          }
 413  
 414          @Override
 415          public void onLowMemory() {
 416          }
 417  
 418          // ActivityLifecycleCallbacks
 419          @SuppressLint(&quot;LongLogTag&quot;)
 420          @Override
 421          public void onActivityResumed(@NonNull Activity activity) {
 422              if (mIsInBackground) {
 423                  AnalyticsTracker.track(
 424                          AnalyticsTracker.Stat.APPLICATION_OPENED,
 425                          AnalyticsTracker.CATEGORY_USER,
 426                          &quot;application_opened&quot;
 427                  );
 428  
 429                  mIsInBackground = false;
 430                  AppLog.add(Type.ACTION, &quot;App opened&quot;);
 431                  WorkManager.getInstance(getApplicationContext()).cancelUniqueWork(TAG_SYNC);
 432                  Log.d(&quot;Simplenote.onActivityResumed&quot;, &quot;Stopped worker&quot;);
 433              }
 434  
 435              String activitySimpleName = activity.getClass().getSimpleName();
 436  
 437              mAccountBucket.start();
 438              AppLog.add(Type.SYNC, &quot;Started account bucket (&quot; + activitySimpleName + &quot;)&quot;);
 439              mPreferencesBucket.start();
 440              AppLog.add(Type.SYNC, &quot;Started preference bucket (&quot; + activitySimpleName + &quot;)&quot;);
 441              mNotesBucket.start();
 442              AppLog.add(Type.SYNC, &quot;Started note bucket (&quot; + activitySimpleName + &quot;)&quot;);
 443              mTagsBucket.start();
 444              AppLog.add(Type.SYNC, &quot;Started tag bucket (&quot; + activitySimpleName + &quot;)&quot;);
 445          }
 446  
 447          @Override
 448          public void onActivityCreated(@NonNull Activity activity, Bundle savedInstanceState) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -            checkReviewAccountOrVerifyEmail(activity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 450 +</span>
 451          }
 452  
 453          @Override
 454          public void onActivityStarted(@NonNull Activity activity) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            mCurrentActivity = activity;</span>
 456          }
 457  
 458          @Override
 459          public void onActivityPaused(@NonNull Activity activity) {
 460          }
 461  
 462          @Override
 463          public void onActivityStopped(@NonNull Activity activity) {
 464          }
 465  
 466          @Override
 467          public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle outState) {
 468          }
 469  
 470          @Override
 471          public void onActivityDestroyed(@NonNull Activity activity) {
 472          }
 473      }
 474  
 475      private class SyncTimePersister implements SyncTimes.SyncTimeListener {
 476          private final SharedPreferences mPreferences;
 477  
 478          public SyncTimePersister() {
 479              mPreferences = getSharedPreferences(SYNC_TIME_PREFERENCES, Context.MODE_PRIVATE);
 480          }
 481  
 482          public HashMap&lt;String, Calendar&gt; load() {
 483              HashMap&lt;String, Calendar&gt; syncTimes = new HashMap&lt;&gt;();
 484  
 485              //noinspection unchecked
 486              for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet()) {
 487                  Calendar instant = Calendar.getInstance();
 488                  instant.setTimeInMillis(syncTime.getValue());
 489                  syncTimes.put(syncTime.getKey(), instant);
 490              }
 491  
 492              return syncTimes;
 493          }
 494  
 495          @Override
 496          public void onRemove(String entityId) {
 497              mPreferences.edit().remove(entityId).apply();
 498          }
 499  
 500          @Override
 501          public void onUpdate(String entityId, Calendar lastSyncTime, boolean isSynced) {
 502              mPreferences.edit().putLong(entityId, lastSyncTime.getTimeInMillis()).apply();
 503          }
 504      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +    private class VerificationListener implements AccountVerificationWatcher.VerificationStateListener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +        public void onUpdate(AccountVerificationWatcher.Status status) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +            switch (status) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +                case VERIFIED:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +                    dismissReviewAccountDialog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +                    return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +                case SENT_EMAIL:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +                    showWaitingOnEmailConfirmation();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +                    return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +                case UNVERIFIED:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +                    showUnverifiedAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 520 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 521 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 522 +    }</span>
 523  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import static com.automattic.simplenote.models.Account.KEY_EMAIL_VERIFICATION;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 +import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 +import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;</span>
   7  
   8  import android.annotation.SuppressLint;
   9  import android.app.Activity;
  10  import android.app.Application;
  11  import android.content.ComponentCallbacks2;
  12  import android.content.Context;
  13  import android.content.SharedPreferences;
  14  import android.content.res.Configuration;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import android.net.Uri;</span>
  16  import android.os.Build;
  17  import android.os.Bundle;
  18  import android.os.Handler;
  19  import android.util.Log;
  20  
  21  import androidx.annotation.IdRes;
  22  import androidx.annotation.NonNull;
  23  import androidx.appcompat.app.AppCompatDelegate;

  24  import androidx.fragment.app.FragmentManager;
  25  import androidx.work.BackoffPolicy;
  26  import androidx.work.Constraints;
  27  import androidx.work.ExistingPeriodicWorkPolicy;
  28  import androidx.work.NetworkType;
  29  import androidx.work.PeriodicWorkRequest;
  30  import androidx.work.WorkManager;
  31  
  32  import com.automattic.simplenote.analytics.AnalyticsTracker;
  33  import com.automattic.simplenote.analytics.AnalyticsTrackerNosara;
  34  import com.automattic.simplenote.models.Account;
  35  import com.automattic.simplenote.models.Note;
  36  import com.automattic.simplenote.models.NoteCountIndexer;
  37  import com.automattic.simplenote.models.NoteTagger;
  38  import com.automattic.simplenote.models.Preferences;
  39  import com.automattic.simplenote.models.Tag;

  40  import com.automattic.simplenote.utils.AppLog;
  41  import com.automattic.simplenote.utils.AppLog.Type;
  42  import com.automattic.simplenote.utils.CrashUtils;
  43  import com.automattic.simplenote.utils.DisplayUtils;
  44  import com.automattic.simplenote.utils.NetworkUtils;
  45  import com.automattic.simplenote.utils.PrefUtils;
  46  import com.automattic.simplenote.utils.SyncWorker;
  47  import com.simperium.Simperium;
  48  import com.simperium.android.AndroidClient;
  49  import com.simperium.android.WebSocketManager;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketNameInvalid;
  52  import com.simperium.client.BucketObjectMissingException;
  53  import com.simperium.client.ChannelProvider.HeartbeatListener;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.Calendar;
  59  import java.util.HashMap;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -import java.util.Locale;</span>
  61  import java.util.Map;
  62  import java.util.concurrent.TimeUnit;
  63  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -import static com.automattic.simplenote.models.Account.KEY_EMAIL_VERIFICATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import static com.simperium.android.AsyncAuthClient.USER_ACCESS_TOKEN_PREFERENCE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -import static com.simperium.android.AsyncAuthClient.USER_EMAIL_PREFERENCE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import dagger.hilt.android.HiltAndroidApp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +@HiltAndroidApp</span>
  72  public class Simplenote extends Application implements HeartbeatListener {
  73      public static final String DELETED_NOTE_ID = &quot;deletedNoteId&quot;;
  74      public static final String SELECTED_NOTE_ID = &quot;selectedNoteId&quot;;
  75      public static final String SCROLL_POSITION_PREFERENCES = &quot;scroll_position&quot;;
  76      public static final String SYNC_TIME_PREFERENCES = &quot;sync_time&quot;;
  77      public static final String TAG = &quot;Simplenote&quot;;
  78      public static final int INTENT_EDIT_NOTE = 2;
  79      public static final int INTENT_PREFERENCES = 1;
  80      public static final int ONE_MINUTE_MILLIS = 60 * 1000;  // 60 seconds
  81      public static final int TEN_SECONDS_MILLIS = 10 * 1000;  // 10 seconds
  82      public static final int TWENTY_SECONDS_MILLIS = 20 * 1000;  // 20 seconds
  83  
  84      private static final String AUTH_PROVIDER = &quot;simplenote.com&quot;;
  85      private static final String TAG_SYNC = &quot;sync&quot;;
  86      private static final long HEARTBEAT_TIMEOUT =  WebSocketManager.HEARTBEAT_INTERVAL * 2;
  87  


  88      private static Bucket&lt;Account&gt; mAccountBucket;
  89      private static Bucket&lt;Preferences&gt; mPreferencesBucket;
  90  
  91      private Bucket&lt;Note&gt; mNotesBucket;
  92      private Bucket&lt;Tag&gt; mTagsBucket;
  93      private SyncTimes&lt;Note&gt; mNoteSyncTimes;
  94      private Handler mHeartbeatHandler;
  95      private Runnable mHeartbeatRunnable;
  96      private Simperium mSimperium;
  97      private boolean mHasShownReviewOrVerify;
  98      private boolean mIsInBackground = true;
  99  
 100      public void onCreate() {
 101          super.onCreate();
 102  
 103          CrashUtils.initWithContext(this);
 104  
 105          SimplenoteAppLock appLock = new SimplenoteAppLock(this);
 106          AppLockManager.getInstance().setCurrentAppLock(appLock);
 107          appLock.enable();
 108  
 109          mSimperium = Simperium.newClient(
 110                  BuildConfig.SIMPERIUM_APP_ID,
 111                  BuildConfig.SIMPERIUM_APP_KEY,
 112                  this
 113          );
 114  
 115          mSimperium.setAuthProvider(AUTH_PROVIDER);
 116          mSimperium.addHeartbeatListener(this);
 117  
 118          mHeartbeatHandler = new Handler();
 119          mHeartbeatRunnable = new Runnable() {
 120              @Override
 121              public void run() {
 122                  AppLog.add(Type.NETWORK, &quot;Heartbeat stopped&quot;);
 123                  mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 124                  mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 125              }
 126          };
 127  
 128          SyncTimePersister syncTimePersister = new SyncTimePersister();
 129          mNoteSyncTimes = new SyncTimes&lt;&gt;(syncTimePersister.load());
 130          mNoteSyncTimes.addListener(syncTimePersister);
 131  
 132          try {
 133              mNotesBucket = mSimperium.bucket(new Note.Schema());
 134              mNotesBucket.addListener(mNoteSyncTimes.bucketListener);
 135              Tag.Schema tagSchema = new Tag.Schema();
 136              tagSchema.addIndex(new NoteCountIndexer(mNotesBucket));
 137              mTagsBucket = mSimperium.bucket(tagSchema);
 138              mPreferencesBucket = mSimperium.bucket(new Preferences.Schema());
 139              mAccountBucket = mSimperium.bucket(new Account.Schema());



 140              // Every time a note changes or is deleted we need to reindex the tag counts
 141              mNotesBucket.addListener(new NoteTagger(mTagsBucket));
 142          } catch (BucketNameInvalid e) {
 143              throw new RuntimeException(&quot;Could not create bucket&quot;, e);
 144          }
 145  
 146          AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);
 147  
 148          ApplicationLifecycleMonitor applicationLifecycleMonitor = new ApplicationLifecycleMonitor();
 149          registerComponentCallbacks(applicationLifecycleMonitor);
 150          registerActivityLifecycleCallbacks(applicationLifecycleMonitor);
 151  
 152          AnalyticsTracker.registerTracker(new AnalyticsTrackerNosara(this));
 153          AnalyticsTracker.refreshMetadata(mSimperium.getUser().getEmail());
 154          CrashUtils.setCurrentUser(mSimperium.getUser());
 155  
 156          AppLog.add(Type.DEVICE, getDeviceInfo());
 157          AppLog.add(Type.ACCOUNT, getAccountInfo());
 158          AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 159      }
 160  
 161      @Override
 162      public void onBeat() {
 163          AppLog.add(Type.NETWORK, &quot;Heartbeat received&quot;);
 164          mHeartbeatHandler.removeCallbacks(mHeartbeatRunnable);
 165          mHeartbeatHandler.postDelayed(mHeartbeatRunnable, HEARTBEAT_TIMEOUT);
 166      }
 167  
 168      private boolean isFirstLaunch() {
 169          // NotesActivity sets this pref to false after first launch
 170          return PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true);
 171      }
 172  
 173      public static boolean analyticsIsEnabled() {
 174          if (mPreferencesBucket == null) {
 175              return true;
 176          }
 177  
 178          try {
 179              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 180              return prefs.getAnalyticsEnabled();
 181          } catch (BucketObjectMissingException e) {
 182              return true;
 183          }
 184      }
 185  
 186      private String getAccountInfo() {
<abbr title=" 187          String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEmail() : &quot;?&quot;);"> 187          String email = &quot;Email: &quot; + (mSimperium != null &amp;&amp; mSimperium.getUser() != null ? mSimperium.getUser().getEðŸ”µ</abbr>
 188          String notes = &quot;Notes: &quot; + (mNotesBucket != null ? mNotesBucket.count() : &quot;?&quot;);
 189          String tags = &quot;Tags: &quot; + (mTagsBucket != null ? mTagsBucket.count() : &quot;?&quot;);
 190          return email + &quot;\n&quot; + notes + &quot;\n&quot; + tags + &quot;\n\n&quot;;
 191      }
 192  
 193      private String getDeviceInfo() {
<abbr title=" 194          String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; : &quot;Android &quot;;"> 194          String architecture = Build.DEVICE != null &amp;&amp; Build.DEVICE.matches(&quot;.+_cheets|cheets_.+&quot;) ? &quot;Chrome OS &quot; :ðŸ”µ</abbr>
 195          String device = &quot;Device: &quot; + Build.MANUFACTURER + &quot; &quot; + Build.MODEL + &quot; (&quot; + Build.DEVICE + &quot;)&quot;;
 196          String system = &quot;System: &quot; + architecture + Build.VERSION.RELEASE + &quot; (&quot; + Build.VERSION.SDK_INT + &quot;)&quot;;
 197          String app = &quot;App: Simplenote &quot; + PrefUtils.versionInfo();
 198          return device + &quot;\n&quot; + system + &quot;\n&quot; + app + &quot;\n\n&quot;;
 199      }
 200  
 201      public Simperium getSimperium() {
 202          return mSimperium;
 203      }
 204  
 205      public Bucket&lt;Note&gt; getNotesBucket() {
 206          return mNotesBucket;
 207      }
 208  
 209      public SyncTimes getNoteSyncTimes() {
 210          return mNoteSyncTimes;
 211      }
 212  
 213      public Bucket&lt;Tag&gt; getTagsBucket() {
 214          return mTagsBucket;
 215      }
 216  
 217      public Bucket&lt;Preferences&gt; getPreferencesBucket() {
 218          return mPreferencesBucket;
 219      }
 220  
 221      public Bucket&lt;Account&gt; getAccountBucket() {
 222          return mAccountBucket;
 223      }
 224  
 225      public boolean isInBackground() {
 226          return mIsInBackground;
 227      }
 228  
 229      public void loginWithToken(String email, String spToken) {
 230          // Manually authorize the user with Simperium
 231          User user = mSimperium.getUser();
 232          user.setAccessToken(spToken);
 233          user.setEmail(email);
 234          user.setStatus(User.Status.AUTHORIZED);
 235  
 236          // Store the user data in Simperium shared preferences
 237          SharedPreferences.Editor editor = AndroidClient.sharedPreferences(this).edit();
 238          editor.putString(USER_ACCESS_TOKEN_PREFERENCE, user.getAccessToken());
 239          editor.putString(USER_EMAIL_PREFERENCE, user.getEmail());
 240          editor.apply();
 241      }
 242  
 243      public boolean isLoggedIn() {
 244          User user = mSimperium.getUser();
 245          return user != null &amp;&amp; user.getStatus() == User.Status.AUTHORIZED;
 246      }
 247  
 248      public String getUserEmail() {
 249          User user = mSimperium.getUser();
 250          return user != null ? user.getEmail() : null;
 251      }
 252  
 253      private void checkReviewAccountOrVerifyEmail(final Activity activity) {
 254          if (isFirstLaunch() || !NetworkUtils.isNetworkAvailable(this) || mHasShownReviewOrVerify) {
 255              // Show nothing on first launch, no network connection, or has already shown review/verify.















 256              return;
 257          }
 258  
 259          Account account;
 260  
 261          try {
 262              account = mAccountBucket.get(KEY_EMAIL_VERIFICATION);
 263          } catch (BucketObjectMissingException bucketObjectMissingException) {
 264              // Show review account when entity does not exist.
 265              showReviewAccountOrVerifyEmail(activity, false);
 266              return;
 267          }
 268  
 269          if (mSimperium == null || mSimperium.getUser() == null || mSimperium.getUser().getEmail() == null) {
 270              // Show nothing when Simperium, user, or email cannot be retrieved.
 271              return;
 272          }
 273  
 274          String email = mSimperium.getUser().getEmail();
 275  
 276          if (account.hasVerifiedEmail(email)) {
 277              // Show nothing when email has been verified.
 278              return;
 279          }
 280  
 281          // Show verify email when email has been sent to account address.  Show review account otherwise.
 282          showReviewAccountOrVerifyEmail(activity, account.hasSentEmail(email));
 283      }
 284  








 285      private void showReviewAccountOrVerifyEmail(final Activity activity, boolean hasSentEmail) {
 286          final FragmentManager fragmentManager;
 287          final @IdRes int container;
 288  
 289          if (activity instanceof NotesActivity) {
 290              fragmentManager = ((NotesActivity) activity).getSupportFragmentManager();
 291              container = R.id.drawer_layout;
 292          } else if (activity instanceof NoteEditorActivity) {
 293              fragmentManager = ((NoteEditorActivity) activity).getSupportFragmentManager();
 294              container = android.R.id.content;
 295          } else {
 296              return;
 297          }
 298  
 299          final Bundle bundle = ReviewAccountVerifyEmailFragment.newBundle(hasSentEmail);
 300  
 301          new FullScreenDialogFragment.Builder(activity)
 302              .setContent(ReviewAccountVerifyEmailFragment.class, bundle)
 303              .setOnConfirmListener(null)
 304              .setOnDismissListener(null)
 305              .setToolbarElevation(0)
 306              .setViewContainer(container)
 307              .build()
 308              .show(fragmentManager, FullScreenDialogFragment.TAG);
 309  
 310          mHasShownReviewOrVerify = true;
 311      }
 312  
<abbr title=" 313      private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbacks2 {"> 313      private class ApplicationLifecycleMonitor implements Application.ActivityLifecycleCallbacks, ComponentCallbackðŸ”µ</abbr>
 314          // ComponentCallbacks
 315          @Override
 316          public void onTrimMemory(int level) {
 317              if (level == ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN) {
 318                  mIsInBackground = true;
 319  
 320                  // Give the buckets some time to finish sync, then stop them
 321                  new Handler().postDelayed(new Runnable() {
 322                      @Override
 323                      public void run() {
 324                          if (!mIsInBackground) {
 325                              return;
 326                          }
 327  
 328                          if (mAccountBucket != null) {
 329                              mAccountBucket.stop();
 330                              AppLog.add(Type.SYNC, &quot;Stopped account bucket (Simplenote)&quot;);
 331                          }
 332  
 333                          if (mNotesBucket != null) {
 334                              mNotesBucket.stop();
 335                              AppLog.add(Type.SYNC, &quot;Stopped note bucket (Simplenote)&quot;);
 336                          }
 337  
 338                          if (mTagsBucket != null) {
 339                              mTagsBucket.stop();
 340                              AppLog.add(Type.SYNC, &quot;Stopped tag bucket (Simplenote)&quot;);
 341                          }
 342  
 343                          if (mPreferencesBucket != null) {
 344                              mPreferencesBucket.stop();
 345                              AppLog.add(Type.SYNC, &quot;Stopped preference bucket (Simplenote)&quot;);
 346                          }
 347                      }
 348                  }, TEN_SECONDS_MILLIS);
 349  
 350                  PeriodicWorkRequest syncWorkRequest = new PeriodicWorkRequest.Builder(
 351                      SyncWorker.class,
 352                      PeriodicWorkRequest.MIN_PERIODIC_INTERVAL_MILLIS,
 353                      TimeUnit.MILLISECONDS
 354                  )
<abbr title=" 355                      .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build())"> 355                      .setConstraints(new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build(ðŸ”µ</abbr>
 356                      .setBackoffCriteria(BackoffPolicy.LINEAR, ONE_MINUTE_MILLIS, TimeUnit.MILLISECONDS)
 357                      .setInitialDelay(TWENTY_SECONDS_MILLIS, TimeUnit.MILLISECONDS)
 358                      .addTag(TAG_SYNC)
 359                      .build();
 360                  WorkManager.getInstance(getApplicationContext()).enqueueUniquePeriodicWork(
 361                      TAG_SYNC,
 362                      ExistingPeriodicWorkPolicy.REPLACE,
 363                      syncWorkRequest
 364                  );
 365                  Log.d(&quot;Simplenote.onTrimMemory&quot;, &quot;Started worker&quot;);
 366  
 367                  // Send analytics if app is in the background
 368                  AnalyticsTracker.track(
 369                          AnalyticsTracker.Stat.APPLICATION_CLOSED,
 370                          AnalyticsTracker.CATEGORY_USER,
 371                          &quot;application_closed&quot;
 372                  );
 373                  AnalyticsTracker.flush();
 374                  AppLog.add(Type.ACTION, &quot;App closed&quot;);
 375              } else {
 376                  mIsInBackground = false;
 377              }
 378          }
 379  
 380          @Override
 381          public void onConfigurationChanged(@NonNull Configuration newConfig) {
 382              AppLog.add(Type.LAYOUT, DisplayUtils.getDisplaySizeAndOrientation(Simplenote.this));
 383          }
 384  
 385          @Override
 386          public void onLowMemory() {
 387          }
 388  
 389          // ActivityLifecycleCallbacks
 390          @SuppressLint(&quot;LongLogTag&quot;)
 391          @Override
 392          public void onActivityResumed(@NonNull Activity activity) {
 393              if (mIsInBackground) {
 394                  AnalyticsTracker.track(
 395                          AnalyticsTracker.Stat.APPLICATION_OPENED,
 396                          AnalyticsTracker.CATEGORY_USER,
 397                          &quot;application_opened&quot;
 398                  );
 399  
 400                  mIsInBackground = false;
 401                  AppLog.add(Type.ACTION, &quot;App opened&quot;);
 402                  WorkManager.getInstance(getApplicationContext()).cancelUniqueWork(TAG_SYNC);
 403                  Log.d(&quot;Simplenote.onActivityResumed&quot;, &quot;Stopped worker&quot;);
 404              }
 405  
 406              String activitySimpleName = activity.getClass().getSimpleName();
 407  
 408              mAccountBucket.start();
 409              AppLog.add(Type.SYNC, &quot;Started account bucket (&quot; + activitySimpleName + &quot;)&quot;);
 410              mPreferencesBucket.start();
 411              AppLog.add(Type.SYNC, &quot;Started preference bucket (&quot; + activitySimpleName + &quot;)&quot;);
 412              mNotesBucket.start();
 413              AppLog.add(Type.SYNC, &quot;Started note bucket (&quot; + activitySimpleName + &quot;)&quot;);
 414              mTagsBucket.start();
 415              AppLog.add(Type.SYNC, &quot;Started tag bucket (&quot; + activitySimpleName + &quot;)&quot;);
 416          }
 417  
 418          @Override
 419          public void onActivityCreated(@NonNull Activity activity, Bundle savedInstanceState) {
 420              checkReviewAccountOrVerifyEmail(activity);

 421          }
 422  
 423          @Override
 424          public void onActivityStarted(@NonNull Activity activity) {

 425          }
 426  
 427          @Override
 428          public void onActivityPaused(@NonNull Activity activity) {
 429          }
 430  
 431          @Override
 432          public void onActivityStopped(@NonNull Activity activity) {
 433          }
 434  
 435          @Override
 436          public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle outState) {
 437          }
 438  
 439          @Override
 440          public void onActivityDestroyed(@NonNull Activity activity) {
 441          }
 442      }
 443  
 444      private class SyncTimePersister implements SyncTimes.SyncTimeListener {
 445          private final SharedPreferences mPreferences;
 446  
 447          public SyncTimePersister() {
 448              mPreferences = getSharedPreferences(SYNC_TIME_PREFERENCES, Context.MODE_PRIVATE);
 449          }
 450  
 451          public HashMap&lt;String, Calendar&gt; load() {
 452              HashMap&lt;String, Calendar&gt; syncTimes = new HashMap&lt;&gt;();
 453  
 454              //noinspection unchecked
 455              for (Map.Entry&lt;String, Long&gt; syncTime : ((Map&lt;String, Long&gt;) mPreferences.getAll()).entrySet()) {
 456                  Calendar instant = Calendar.getInstance();
 457                  instant.setTimeInMillis(syncTime.getValue());
 458                  syncTimes.put(syncTime.getKey(), instant);
 459              }
 460  
 461              return syncTimes;
 462          }
 463  
 464          @Override
 465          public void onRemove(String entityId) {
 466              mPreferences.edit().remove(entityId).apply();
 467          }
 468  
 469          @Override
 470          public void onUpdate(String entityId, Calendar lastSyncTime, boolean isSynced) {
 471              mPreferences.edit().putLong(entityId, lastSyncTime.getTimeInMillis()).apply();
 472          }
 473      }


















 474  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            