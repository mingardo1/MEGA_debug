<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>207</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    207
                    <a href="206.html">prev</a>
                    <a href="208.html">next</a>
                    <a href="207_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CyanogenMod/android_packages_apps_Trebuchet_65d076b2ffe7ca96f014a95bd362c7d1ce004b97_src/com/android/launcher3/LauncherAccessibilityDelegate.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;65d076b2ffe7ca96f014a95bd362c7d1ce004b97:src/com/android/launcher3/LauncherAccessibilityDelegate.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;65d076b2ffe7ca96f014a95bd362c7d1ce004b97^1:src/com/android/launcher3/LauncherAccessibilityDelegate.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;65d076b2ffe7ca96f014a95bd362c7d1ce004b97^2:src/com/android/launcher3/LauncherAccessibilityDelegate.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;559d90d0dafbac1d97a1e6f18062309831a25d51:src/com/android/launcher3/LauncherAccessibilityDelegate.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.android.launcher3;
   2 
   3 import android.annotation.TargetApi;
   4 import android.graphics.Rect;
   5 import android.os.Build;
   6 import android.os.Bundle;
   7 import android.text.TextUtils;
   8 import android.util.Log;
   9 import android.util.SparseArray;
  10 import android.view.View;
  11 import android.view.View.AccessibilityDelegate;
  12 import android.view.accessibility.AccessibilityNodeInfo;
  13 import android.view.accessibility.AccessibilityNodeInfo.AccessibilityAction;
  14 
  15 import com.android.launcher3.util.Thunk;
  16 
  17 import java.util.ArrayList;
  18 
  19 @TargetApi(Build.VERSION_CODES.LOLLIPOP)
  20 public class LauncherAccessibilityDelegate extends AccessibilityDelegate {
  21 
  22     private static final String TAG = &quot;LauncherAccessibilityDelegate&quot;;
  23 
  24     private static final int REMOVE = R.id.action_remove;
  25     private static final int INFO = R.id.action_info;
  26     private static final int UNINSTALL = R.id.action_uninstall;
  27     private static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;
  28     private static final int MOVE = R.id.action_move;
  29 
  30     public enum DragType {
  31         ICON,
  32         FOLDER,
  33         WIDGET
  34     }
  35 
  36     public static class DragInfo {
  37         public DragType dragType;
  38         public ItemInfo info;
  39         public View item;
  40     }
  41 
  42 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43     private DragInfo mDragInfo = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45     private final SparseArray&lt;AccessibilityAction&gt; mActions = new SparseArray&lt;&gt;();</span>
  46 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47     private DragInfo mDragInfo = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49     private final SparseArray&lt;AccessibilityAction&gt; mActions =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50             new SparseArray&lt;AccessibilityAction&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     @Thunk final Launcher mLauncher;</span>
  52 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53     private final SparseArray&lt;AccessibilityAction&gt; mActions =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54             new SparseArray&lt;AccessibilityAction&gt;();</span>
  55 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  56     @Thunk final Launcher mLauncher;
  57 
  58     private DragInfo mDragInfo = null;
  59     private AccessibilityDragSource mDragSource = null;
  60 
  61     public LauncherAccessibilityDelegate(Launcher launcher) {
  62         mLauncher = launcher;
  63 
  64         mActions.put(REMOVE, new AccessibilityAction(REMOVE,
  65                 launcher.getText(R.string.delete_target_label)));
  66         mActions.put(INFO, new AccessibilityAction(INFO,
  67                 launcher.getText(R.string.info_target_label)));
  68         mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL,
  69                 launcher.getText(R.string.delete_target_uninstall_label)));
  70         mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE,
  71                 launcher.getText(R.string.action_add_to_workspace)));
  72         mActions.put(MOVE, new AccessibilityAction(MOVE,
  73                 launcher.getText(R.string.action_move)));
  74     }
  75 
  76     @Override
  77     public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
  78         super.onInitializeAccessibilityNodeInfo(host, info);
  79         if (!(host.getTag() instanceof ItemInfo)) return;
  80         ItemInfo item = (ItemInfo) host.getTag();
  81 
  82         if (DeleteDropTarget.supportsDrop(item)) {
  83             info.addAction(mActions.get(REMOVE));
  84         }
  85         if (UninstallDropTarget.supportsDrop(host.getContext(), item)) {
  86             info.addAction(mActions.get(UNINSTALL));
  87         }
  88         if (InfoDropTarget.supportsDrop(host.getContext(), item)) {
  89             info.addAction(mActions.get(INFO));
  90         }
  91 
  92         if ((item instanceof ShortcutInfo)
  93                 || (item instanceof LauncherAppWidgetInfo)
  94                 || (item instanceof FolderInfo)) {
  95             info.addAction(mActions.get(MOVE));
  96         } if ((item instanceof AppInfo) || (item instanceof PendingAddItemInfo)) {
  97             info.addAction(mActions.get(ADD_TO_WORKSPACE));
  98         }
  99     }
 100 
 101     @Override
 102     public boolean performAccessibilityAction(View host, int action, Bundle args) {
 103         if ((host.getTag() instanceof ItemInfo)
 104                 &amp;&amp; performAction(host, (ItemInfo) host.getTag(), action)) {
 105             return true;
 106         }
 107         return super.performAccessibilityAction(host, action, args);
 108     }
 109 
 110     public boolean performAction(View host, final ItemInfo item, int action) {
 111         if (action == REMOVE) {
 112             if (DeleteDropTarget.removeWorkspaceOrFolderItem(mLauncher, item, host)) {
 113                 announceConfirmation(R.string.item_removed);
 114                 return true;
 115             }
 116             return false;
 117         } else if (action == INFO) {
 118             InfoDropTarget.startDetailsActivityForInfo(item, mLauncher);
 119             return true;
 120         } else if (action == UNINSTALL) {
 121             return UninstallDropTarget.startUninstallActivity(mLauncher, item);
 122         } else if (action == MOVE) {
 123             beginAccessibleDrag(host, item);
 124         } else if (action == ADD_TO_WORKSPACE) {
 125             final int[] coordinates = new int[2];
 126             final long screenId = findSpaceOnWorkspace(item, coordinates);
 127             mLauncher.showWorkspace(true, new Runnable() {
 128 
 129                 @Override
 130                 public void run() {
 131                     if (item instanceof AppInfo) {
 132                         ShortcutInfo info = ((AppInfo) item).makeShortcut();
 133                         LauncherModel.addItemToDatabase(mLauncher, info,
 134                                 LauncherSettings.Favorites.CONTAINER_DESKTOP,
 135                                 screenId, coordinates[0], coordinates[1]);
 136 
 137                         ArrayList&lt;ItemInfo&gt; itemList = new ArrayList&lt;&gt;();
 138                         itemList.add(info);
 139                         mLauncher.bindItems(itemList, 0, itemList.size(), true);
 140                     } else if (item instanceof PendingAddItemInfo) {
 141                         PendingAddItemInfo info = (PendingAddItemInfo) item;
 142                         Workspace workspace = mLauncher.getWorkspace();
 143                         workspace.snapToPage(workspace.getPageIndexForScreenId(screenId));
 144                         mLauncher.addPendingItem(info, LauncherSettings.Favorites.CONTAINER_DESKTOP,
 145                                 screenId, coordinates, info.spanX, info.spanY);
 146                     }
 147                     announceConfirmation(R.string.item_added_to_workspace);
 148                 }
 149             });
 150             return true;
 151         }
 152         return false;
 153     }
 154 
 155     @Thunk void announceConfirmation(int resId) {
 156         announceConfirmation(mLauncher.getResources().getString(resId));
 157     }
 158 
 159     @Thunk void announceConfirmation(String confirmation) {
 160         mLauncher.getDragLayer().announceForAccessibility(confirmation);
 161 
 162     }
 163 
 164     public boolean isInAccessibleDrag() {
 165         return mDragInfo != null;
 166     }
 167 
 168     public DragInfo getDragInfo() {
 169         return mDragInfo;
 170     }
 171 
 172     /**
 173      * @param clickedTarget the actual view that was clicked
 174      * @param dropLocation relative to {@param clickedTarget}. If provided, its center is used
 175      * as the actual drop location otherwise the views center is used.
 176      */
 177     public void handleAccessibleDrop(View clickedTarget, Rect dropLocation,
 178             String confirmation) {
 179         if (!isInAccessibleDrag()) return;
 180 
 181         int[] loc = new int[2];
 182         if (dropLocation == null) {
 183             loc[0] = clickedTarget.getWidth() / 2;
 184             loc[1] = clickedTarget.getHeight() / 2;
 185         } else {
 186             loc[0] = dropLocation.centerX();
 187             loc[1] = dropLocation.centerY();
 188         }
 189 
 190         mLauncher.getDragLayer().getDescendantCoordRelativeToSelf(clickedTarget, loc);
 191         mLauncher.getDragController().completeAccessibleDrag(loc);
 192 
 193         endAccessibleDrag();
 194         if (!TextUtils.isEmpty(confirmation)) {
 195             announceConfirmation(confirmation);
 196         }
 197     }
 198 
 199     public void beginAccessibleDrag(View item, ItemInfo info) {
 200         mDragInfo = new DragInfo();
 201         mDragInfo.info = info;
 202         mDragInfo.item = item;
 203         mDragInfo.dragType = DragType.ICON;
 204         if (info instanceof FolderInfo) {
 205             mDragInfo.dragType = DragType.FOLDER;
 206         } else if (info instanceof LauncherAppWidgetInfo) {
 207             mDragInfo.dragType = DragType.WIDGET;
 208         }
 209 
 210         CellLayout.CellInfo cellInfo = new CellLayout.CellInfo(item, info);
 211 
 212         Rect pos = new Rect();
 213         mLauncher.getDragLayer().getDescendantRectRelativeToSelf(item, pos);
 214         mLauncher.getDragController().prepareAccessibleDrag(pos.centerX(), pos.centerY());
 215 
 216         Workspace workspace = mLauncher.getWorkspace();
 217 
 218         Folder folder = workspace.getOpenFolder();
 219         if (folder != null) {
 220             if (folder.getItemsInReadingOrder().contains(item)) {
 221                 mDragSource = folder;
 222             } else {
 223                 mLauncher.closeFolder();
 224             }
 225         }
 226         if (mDragSource == null) {
 227             mDragSource = workspace;
 228         }
 229         mDragSource.enableAccessibleDrag(true);
 230         mDragSource.startDrag(cellInfo, true);
 231     }
 232 
 233     public boolean onBackPressed() {
 234         if (isInAccessibleDrag()) {
 235             cancelAccessibleDrag();
 236             return true;
 237         }
 238         return false;
 239     }
 240 
 241     private void cancelAccessibleDrag() {
 242         mLauncher.getDragController().cancelDrag();
 243         endAccessibleDrag();
 244     }
 245 
 246     private void endAccessibleDrag() {
 247         mDragInfo = null;
 248         if (mDragSource != null) {
 249             mDragSource.enableAccessibleDrag(false);
 250             mDragSource = null;
 251         }
 252     }
 253 
 254     public static interface AccessibilityDragSource {
 255         void startDrag(CellLayout.CellInfo cellInfo, boolean accessible);
 256 
 257         void enableAccessibleDrag(boolean enable);
 258     }
 259 
 260     /**
 261      * Find empty space on the workspace and returns the screenId.
 262      */
 263     private long findSpaceOnWorkspace(ItemInfo info, int[] outCoordinates) {
 264         Workspace workspace = mLauncher.getWorkspace();
 265         ArrayList&lt;Long&gt; workspaceScreens = workspace.getScreenOrder();
 266         long screenId;
 267 
 268         // First check if there is space on the current screen.
 269         int screenIndex = workspace.getCurrentPage();
 270         screenId = workspaceScreens.get(screenIndex);
 271         CellLayout layout = (CellLayout) workspace.getPageAt(screenIndex);
 272 
 273         boolean found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 274         screenIndex = workspace.hasCustomContent() ? 1 : 0;
 275         while (!found &amp;&amp; screenIndex &lt; workspaceScreens.size()) {
 276             screenId = workspaceScreens.get(screenIndex);
 277             layout = (CellLayout) workspace.getPageAt(screenIndex);
 278             found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 279             screenIndex++;
 280         }
 281 
 282         if (found) {
 283             return screenId;
 284         }
 285 
 286         workspace.addExtraEmptyScreen();
 287         screenId = workspace.commitExtraEmptyScreen();
 288         layout = workspace.getScreenWithId(screenId);
 289         found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 290 
 291         if (!found) {
 292             Log.wtf(TAG, &quot;Not enough space on an empty screen&quot;);
 293         }
 294         return screenId;
 295     }
 296 }</pre></td>
                            <td><pre>   1 package com.android.launcher3;
   2 
   3 import android.annotation.TargetApi;
   4 import android.graphics.Rect;
   5 import android.os.Build;
   6 import android.os.Bundle;
   7 import android.text.TextUtils;
   8 import android.util.Log;
   9 import android.util.SparseArray;
  10 import android.view.View;
  11 import android.view.View.AccessibilityDelegate;
  12 import android.view.accessibility.AccessibilityNodeInfo;
  13 import android.view.accessibility.AccessibilityNodeInfo.AccessibilityAction;
  14 
  15 import com.android.launcher3.util.Thunk;
  16 
  17 import java.util.ArrayList;
  18 
  19 @TargetApi(Build.VERSION_CODES.LOLLIPOP)
  20 public class LauncherAccessibilityDelegate extends AccessibilityDelegate {
  21 
  22     private static final String TAG = &quot;LauncherAccessibilityDelegate&quot;;
  23 
  24     private static final int REMOVE = R.id.action_remove;
  25     private static final int INFO = R.id.action_info;
  26     private static final int UNINSTALL = R.id.action_uninstall;
  27     private static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;
  28     private static final int MOVE = R.id.action_move;
  29 
  30 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  31 ||||||| BASE
  32 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 public</span>
  34 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  35  enum DragType {
  36         ICON,
  37         FOLDER,
  38         WIDGET
  39     }
  40 
  41     public static class DragInfo {
  42         public DragType dragType;
  43         public ItemInfo info;
  44         public View item;
  45     }
  46 
  47     private final SparseArray&lt;AccessibilityAction&gt; mActions = new SparseArray&lt;&gt;();
  48     @Thunk final Launcher mLauncher;
  49 
  50     private DragInfo mDragInfo = null;
  51     private AccessibilityDragSource mDragSource = null;
  52 
  53     public LauncherAccessibilityDelegate(Launcher launcher) {
  54         mLauncher = launcher;
  55 
  56         mActions.put(REMOVE, new AccessibilityAction(REMOVE,
  57                 launcher.getText(R.string.delete_target_label)));
  58         mActions.put(INFO, new AccessibilityAction(INFO,
  59                 launcher.getText(R.string.info_target_label)));
  60         mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL,
  61                 launcher.getText(R.string.delete_target_uninstall_label)));
  62         mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE,
  63                 launcher.getText(R.string.action_add_to_workspace)));
  64         mActions.put(MOVE, new AccessibilityAction(MOVE,
  65                 launcher.getText(R.string.action_move)));
  66     }
  67 
  68     @Override
  69     public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
  70         super.onInitializeAccessibilityNodeInfo(host, info);
  71         if (!(host.getTag() instanceof ItemInfo)) return;
  72         ItemInfo item = (ItemInfo) host.getTag();
  73 
  74         if (DeleteDropTarget.supportsDrop(item)) {
  75             info.addAction(mActions.get(REMOVE));
  76         }
  77         if (UninstallDropTarget.supportsDrop(host.getContext(), item)) {
  78             info.addAction(mActions.get(UNINSTALL));
  79         }
  80         if (InfoDropTarget.supportsDrop(host.getContext(), item)) {
  81             info.addAction(mActions.get(INFO));
  82         }
  83 
  84         if ((item instanceof ShortcutInfo)
  85                 || (item instanceof LauncherAppWidgetInfo)
  86                 || (item instanceof FolderInfo)) {
  87             info.addAction(mActions.get(MOVE));
  88         } if ((item instanceof AppInfo) || (item instanceof PendingAddItemInfo)) {
  89             info.addAction(mActions.get(ADD_TO_WORKSPACE));
  90         }
  91     }
  92 
  93     @Override
  94     public boolean performAccessibilityAction(View host, int action, Bundle args) {
  95         if ((host.getTag() instanceof ItemInfo)
  96                 &amp;&amp; performAction(host, (ItemInfo) host.getTag(), action)) {
  97             return true;
  98         }
  99         return super.performAccessibilityAction(host, action, args);
 100     }
 101 
 102     public boolean performAction(View host, final ItemInfo item, int action) {
 103         if (action == REMOVE) {
 104             if (DeleteDropTarget.removeWorkspaceOrFolderItem(mLauncher, item, host)) {
 105                 announceConfirmation(R.string.item_removed);
 106                 return true;
 107             }
 108             return false;
 109         } else if (action == INFO) {
 110             InfoDropTarget.startDetailsActivityForInfo(item, mLauncher);
 111             return true;
 112         } else if (action == UNINSTALL) {
 113             return UninstallDropTarget.startUninstallActivity(mLauncher, item);
 114         } else if (action == MOVE) {
 115             beginAccessibleDrag(host, item);
 116         } else if (action == ADD_TO_WORKSPACE) {
 117             final int[] coordinates = new int[2];
 118             final long screenId = findSpaceOnWorkspace(item, coordinates);
 119             mLauncher.showWorkspace(true, new Runnable() {
 120 
 121                 @Override
 122                     public void run() {
 123                     if (item instanceof AppInfo) {
 124                         ShortcutInfo info = ((AppInfo) item).makeShortcut();
 125                         LauncherModel.addItemToDatabase(mLauncher, info,
 126                                 LauncherSettings.Favorites.CONTAINER_DESKTOP,
 127                                 screenId, coordinates[0], coordinates[1]);
 128 
 129                         ArrayList&lt;ItemInfo&gt; itemList = new ArrayList&lt;&gt;();
 130                         itemList.add(info);
 131                         mLauncher.bindItems(itemList, 0, itemList.size(), true);
 132                     } else if (item instanceof PendingAddItemInfo) {
 133                         PendingAddItemInfo info = (PendingAddItemInfo) item;
 134                         Workspace workspace = mLauncher.getWorkspace();
 135                         workspace.snapToPage(workspace.getPageIndexForScreenId(screenId));
 136                         mLauncher.addPendingItem(info, LauncherSettings.Favorites.CONTAINER_DESKTOP,
 137                                 screenId, coordinates, info.spanX, info.spanY);
 138                     }
 139                         announceConfirmation(R.string.item_added_to_workspace);
 140                     }
 141                 });
 142                 return true;
 143         }
 144         return false;
 145     }
 146 
 147     @Thunk void announceConfirmation(int resId) {
 148         announceConfirmation(mLauncher.getResources().getString(resId));
 149     }
 150 
 151     @Thunk void announceConfirmation(String confirmation) {
 152         mLauncher.getDragLayer().announceForAccessibility(confirmation);
 153 
 154     }
 155 
 156     public boolean isInAccessibleDrag() {
 157         return mDragInfo != null;
 158     }
 159 
 160     public DragInfo getDragInfo() {
 161         return mDragInfo;
 162     }
 163 
 164     /**
 165      * @param clickedTarget the actual view that was clicked
 166      * @param dropLocation relative to {@param clickedTarget}. If provided, its center is used
 167      * as the actual drop location otherwise the views center is used.
 168      */
 169     public void handleAccessibleDrop(View clickedTarget, Rect dropLocation,
 170             String confirmation) {
 171         if (!isInAccessibleDrag()) return;
 172 
 173         int[] loc = new int[2];
 174         if (dropLocation == null) {
 175             loc[0] = clickedTarget.getWidth() / 2;
 176             loc[1] = clickedTarget.getHeight() / 2;
 177         } else {
 178             loc[0] = dropLocation.centerX();
 179             loc[1] = dropLocation.centerY();
 180         }
 181 
 182         mLauncher.getDragLayer().getDescendantCoordRelativeToSelf(clickedTarget, loc);
 183         mLauncher.getDragController().completeAccessibleDrag(loc);
 184 
 185         endAccessibleDrag();
 186         if (!TextUtils.isEmpty(confirmation)) {
 187             announceConfirmation(confirmation);
 188         }
 189     }
 190 
 191     public void beginAccessibleDrag(View item, ItemInfo info) {
 192         mDragInfo = new DragInfo();
 193         mDragInfo.info = info;
 194         mDragInfo.item = item;
 195         mDragInfo.dragType = DragType.ICON;
 196         if (info instanceof FolderInfo) {
 197             mDragInfo.dragType = DragType.FOLDER;
 198         } else if (info instanceof LauncherAppWidgetInfo) {
 199             mDragInfo.dragType = DragType.WIDGET;
 200         }
 201 
 202         CellLayout.CellInfo cellInfo = new CellLayout.CellInfo(item, info);
 203 
 204         Rect pos = new Rect();
 205         mLauncher.getDragLayer().getDescendantRectRelativeToSelf(item, pos);
 206         mLauncher.getDragController().prepareAccessibleDrag(pos.centerX(), pos.centerY());
 207 
 208         Workspace workspace = mLauncher.getWorkspace();
 209 
 210         Folder folder = workspace.getOpenFolder();
 211         if (folder != null) {
 212             if (folder.getItemsInReadingOrder().contains(item)) {
 213                 mDragSource = folder;
 214             } else {
 215                 mLauncher.closeFolder();
 216             }
 217         }
 218         if (mDragSource == null) {
 219             mDragSource = workspace;
 220         }
 221         mDragSource.enableAccessibleDrag(true);
 222         mDragSource.startDrag(cellInfo, true);
 223     }
 224 
 225     public boolean onBackPressed() {
 226         if (isInAccessibleDrag()) {
 227             cancelAccessibleDrag();
 228             return true;
 229         }
 230         return false;
 231     }
 232 
 233     private void cancelAccessibleDrag() {
 234         mLauncher.getDragController().cancelDrag();
 235         endAccessibleDrag();
 236     }
 237 
 238     private void endAccessibleDrag() {
 239         mDragInfo = null;
 240         if (mDragSource != null) {
 241             mDragSource.enableAccessibleDrag(false);
 242             mDragSource = null;
 243         }
 244     }
 245 
 246     /**
 247      * Find empty space on the workspace and returns the screenId.
 248      */
 249     private long findSpaceOnWorkspace(ItemInfo info, int[] outCoordinates) {
 250         Workspace workspace = mLauncher.getWorkspace();
 251         ArrayList&lt;Long&gt; workspaceScreens = workspace.getScreenOrder();
 252         long screenId;
 253 
 254         // First check if there is space on the current screen.
 255         int screenIndex = workspace.getCurrentPage();
 256         screenId = workspaceScreens.get(screenIndex);
 257         CellLayout layout = (CellLayout) workspace.getPageAt(screenIndex);
 258 
 259         boolean found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 260         screenIndex = workspace.hasCustomContent() ? 1 : 0;
 261         while (!found &amp;&amp; screenIndex &lt; workspaceScreens.size()) {
 262             screenId = workspaceScreens.get(screenIndex);
 263             layout = (CellLayout) workspace.getPageAt(screenIndex);
 264             found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 265             screenIndex++;
 266         }
 267 
 268         if (found) {
 269             return screenId;
 270         }
 271 
 272         workspace.addExtraEmptyScreen();
 273         screenId = workspace.commitExtraEmptyScreen();
 274         layout = workspace.getScreenWithId(screenId);
 275         found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 276 
 277         if (!found) {
 278             Log.wtf(TAG, &quot;Not enough space on an empty screen&quot;);
 279         }
 280         return screenId;
 281     }
 282 
 283     public static interface AccessibilityDragSource {
 284         void startDrag(CellLayout.CellInfo cellInfo, boolean accessible);
 285 
 286         void enableAccessibleDrag(boolean enable);
 287     }
 288 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.android.launcher3;
   2 
   3 import android.annotation.TargetApi;
   4 import android.graphics.Rect;
   5 import android.os.Build;
   6 import android.os.Bundle;
   7 import android.text.TextUtils;
   8 import android.util.Log;
   9 import android.util.SparseArray;
  10 import android.view.View.AccessibilityDelegate;
  11 import android.view.View;
  12 import android.view.accessibility.AccessibilityNodeInfo.AccessibilityAction;
  13 import android.view.accessibility.AccessibilityNodeInfo;
  14 import com.android.launcher3.util.Thunk;
  15 import java.util.ArrayList;
  16 
  17 
  18 @TargetApi(Build.VERSION_CODES.LOLLIPOP)
  19 public class LauncherAccessibilityDelegate extends AccessibilityDelegate {
  20     private static final String TAG = &quot;LauncherAccessibilityDelegate&quot;;
  21 
  22     private static final int REMOVE = R.id.action_remove;
  23 
  24     private static final int INFO = R.id.action_info;
  25 
  26     private static final int UNINSTALL = R.id.action_uninstall;
  27 
  28     private static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;
  29 
  30     private static final int MOVE = R.id.action_move;
  31 
  32     public enum DragType {
  33 
  34         ICON,
  35         FOLDER,
  36         WIDGET;}
  37 
  38     public static class DragInfo {
  39         public DragType dragType;
  40 
  41         public ItemInfo info;
  42 
  43         public View item;
  44     }
  45 
  46     private final SparseArray&lt;AccessibilityAction&gt; mActions = new SparseArray&lt;&gt;();
  47 
  48     @Thunk final Launcher mLauncher;
  49 
  50     private DragInfo mDragInfo = null;
  51 
  52     private AccessibilityDragSource mDragSource = null;
  53 
  54     public LauncherAccessibilityDelegate(Launcher launcher) {
  55         mLauncher = launcher;
<abbr title="  56         mActions.put(REMOVE, new AccessibilityAction(REMOVE, launcher.getText(R.string.delete_target_label)));">  56         mActions.put(REMOVE, new AccessibilityAction(REMOVE, launcher.getText(R.string.delete_target_labeðŸ”µ</abbr>
  57         mActions.put(INFO, new AccessibilityAction(INFO, launcher.getText(R.string.info_target_label)));
<abbr title="  58         mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL, launcher.getText(R.string.delete_target_uninstall_label)));">  58         mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL, launcher.getText(R.string.delete_targeðŸ”µ</abbr>
<abbr title="  59         mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE, launcher.getText(R.string.action_add_to_workspace)));">  59         mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE, launcher.getText(R.strinðŸ”µ</abbr>
  60         mActions.put(MOVE, new AccessibilityAction(MOVE, launcher.getText(R.string.action_move)));
  61     }
  62 
  63     @Override
  64     public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
  65         super.onInitializeAccessibilityNodeInfo(host, info);
  66         if (!(host.getTag() instanceof ItemInfo)) return;
  67         ItemInfo item = (ItemInfo) host.getTag();
  68 
  69         if (DeleteDropTarget.supportsDrop(item)) {
  70             info.addAction(mActions.get(REMOVE));
  71         }
  72         if (UninstallDropTarget.supportsDrop(host.getContext(), item)) {
  73             info.addAction(mActions.get(UNINSTALL));
  74         }
  75         if (InfoDropTarget.supportsDrop(host.getContext(), item)) {
  76             info.addAction(mActions.get(INFO));
  77         }
  78 
  79         if ((item instanceof ShortcutInfo)
  80                 || (item instanceof LauncherAppWidgetInfo)
  81                 || (item instanceof FolderInfo)) {
  82             info.addAction(mActions.get(MOVE));
  83         } if ((item instanceof AppInfo) || (item instanceof PendingAddItemInfo)) {
  84             info.addAction(mActions.get(ADD_TO_WORKSPACE));
  85         }
  86     }
  87 
  88     @Override
  89     public boolean performAccessibilityAction(View host, int action, Bundle args) {
  90         if ((host.getTag() instanceof ItemInfo)
  91                 &amp;&amp; performAction(host, (ItemInfo) host.getTag(), action)) {
  92             return true;
  93         }
  94         return super.performAccessibilityAction(host, action, args);
  95     }
  96 
  97     public boolean performAction(View host, final ItemInfo item, int action) {
  98         if (action == REMOVE) {
  99             if (DeleteDropTarget.removeWorkspaceOrFolderItem(mLauncher, item, host)) {
 100                 announceConfirmation(R.string.item_removed);
 101                 return true;
 102             }
 103             return false;
 104         } else if (action == INFO) {
 105             InfoDropTarget.startDetailsActivityForInfo(item, mLauncher);
 106             return true;
 107         } else if (action == UNINSTALL) {
 108             return UninstallDropTarget.startUninstallActivity(mLauncher, item);
 109         } else if (action == MOVE) {
 110             beginAccessibleDrag(host, item);
 111         } else if (action == ADD_TO_WORKSPACE) {
 112             final int[] coordinates = new int[2];
 113             final long screenId = findSpaceOnWorkspace(item, coordinates);
 114             mLauncher.showWorkspace(true, new Runnable() {
 115                 @Override
 116                 public void run() {
 117                     if (item instanceof AppInfo) {
 118                         ShortcutInfo info = ((AppInfo) (item)).makeShortcut();
<abbr title=" 119                         LauncherModel.addItemToDatabase(mLauncher, info, LauncherSettings.Favorites.CONTAINER_DESKTOP, screenId, coordinates[0], coordinates[1]);"> 119                         LauncherModel.addItemToDatabase(mLauncher, info, LauncherSettings.Favorites.CONTAðŸ”µ</abbr>
 120                         ArrayList&lt;ItemInfo&gt; itemList = new ArrayList&lt;&gt;();
 121                         itemList.add(info);
 122                         mLauncher.bindItems(itemList, 0, itemList.size(), true);
 123                     } else if (item instanceof PendingAddItemInfo) {
 124                         PendingAddItemInfo info = ((PendingAddItemInfo) (item));
 125                         Workspace workspace = mLauncher.getWorkspace();
 126                         workspace.snapToPage(workspace.getPageIndexForScreenId(screenId));
<abbr title=" 127                         mLauncher.addPendingItem(info, LauncherSettings.Favorites.CONTAINER_DESKTOP, screenId, coordinates, info.spanX, info.spanY);"> 127                         mLauncher.addPendingItem(info, LauncherSettings.Favorites.CONTAINER_DESKTOP, screðŸ”µ</abbr>
 128                     }
 129                     announceConfirmation(R.string.item_added_to_workspace);
 130                 }
 131             });
 132             return true;
 133         }
 134         return false;
 135     }
 136 
 137     @Thunk void announceConfirmation(int resId) {
 138         announceConfirmation(mLauncher.getResources().getString(resId));
 139     }
 140 
 141     @Thunk void announceConfirmation(String confirmation) {
 142         mLauncher.getDragLayer().announceForAccessibility(confirmation);
 143 
 144     }
 145 
 146     public boolean isInAccessibleDrag() {
 147         return mDragInfo != null;
 148     }
 149 
 150     public DragInfo getDragInfo() {
 151         return mDragInfo;
 152     }
 153 
 154     /**
 155      * @param clickedTarget the actual view that was clicked
 156      * @param dropLocation relative to {@param clickedTarget}. If provided, its center is used
 157      * as the actual drop location otherwise the views center is used.
 158      */
 159     public void handleAccessibleDrop(View clickedTarget, Rect dropLocation,
 160             String confirmation) {
 161         if (!isInAccessibleDrag()) return;
 162 
 163         int[] loc = new int[2];
 164         if (dropLocation == null) {
 165             loc[0] = clickedTarget.getWidth() / 2;
 166             loc[1] = clickedTarget.getHeight() / 2;
 167         } else {
 168             loc[0] = dropLocation.centerX();
 169             loc[1] = dropLocation.centerY();
 170         }
 171 
 172         mLauncher.getDragLayer().getDescendantCoordRelativeToSelf(clickedTarget, loc);
 173         mLauncher.getDragController().completeAccessibleDrag(loc);
 174 
 175         endAccessibleDrag();
 176         if (!TextUtils.isEmpty(confirmation)) {
 177             announceConfirmation(confirmation);
 178         }
 179     }
 180 
 181     public void beginAccessibleDrag(View item, ItemInfo info) {
 182         mDragInfo = new DragInfo();
 183         mDragInfo.info = info;
 184         mDragInfo.item = item;
 185         mDragInfo.dragType = DragType.ICON;
 186         if (info instanceof FolderInfo) {
 187             mDragInfo.dragType = DragType.FOLDER;
 188         } else if (info instanceof LauncherAppWidgetInfo) {
 189             mDragInfo.dragType = DragType.WIDGET;
 190         }
 191         CellLayout.CellInfo cellInfo = new CellLayout.CellInfo(item, info);
 192         Rect pos = new Rect();
 193         mLauncher.getDragLayer().getDescendantRectRelativeToSelf(item, pos);
 194         mLauncher.getDragController().prepareAccessibleDrag(pos.centerX(), pos.centerY());
 195         Workspace workspace = mLauncher.getWorkspace();
 196         Folder folder = workspace.getOpenFolder();
 197         if (folder != null) {
 198             if (folder.getItemsInReadingOrder().contains(item)) {
 199                 mDragSource = folder;
 200             } else {
 201                 mLauncher.closeFolder();
 202             }
 203         }
 204         if (mDragSource == null) {
 205             mDragSource = workspace;
 206         }
 207         mDragSource.enableAccessibleDrag(true);
 208         mDragSource.startDrag(cellInfo, true);
 209     }
 210 
 211     public boolean onBackPressed() {
 212         if (isInAccessibleDrag()) {
 213             cancelAccessibleDrag();
 214             return true;
 215         }
 216         return false;
 217     }
 218 
 219     private void cancelAccessibleDrag() {
 220         mLauncher.getDragController().cancelDrag();
 221         endAccessibleDrag();
 222     }
 223 
 224     private void endAccessibleDrag() {
 225         mDragInfo = null;
 226         if (mDragSource != null) {
 227             mDragSource.enableAccessibleDrag(false);
 228             mDragSource = null;
 229         }
 230     }
 231 
 232     /**
 233      * Find empty space on the workspace and returns the screenId.
 234      */
 235     private long findSpaceOnWorkspace(ItemInfo info, int[] outCoordinates) {
 236         Workspace workspace = mLauncher.getWorkspace();
 237         ArrayList&lt;Long&gt; workspaceScreens = workspace.getScreenOrder();
 238         long screenId;
 239 
 240         // First check if there is space on the current screen.
 241         int screenIndex = workspace.getCurrentPage();
 242         screenId = workspaceScreens.get(screenIndex);
 243         CellLayout layout = (CellLayout) workspace.getPageAt(screenIndex);
 244 
 245         boolean found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 246         screenIndex = workspace.hasCustomContent() ? 1 : 0;
 247         while (!found &amp;&amp; screenIndex &lt; workspaceScreens.size()) {
 248             screenId = workspaceScreens.get(screenIndex);
 249             layout = (CellLayout) workspace.getPageAt(screenIndex);
 250             found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 251             screenIndex++;
 252         }
 253 
 254         if (found) {
 255             return screenId;
 256         }
 257 
 258         workspace.addExtraEmptyScreen();
 259         screenId = workspace.commitExtraEmptyScreen();
 260         layout = workspace.getScreenWithId(screenId);
 261         found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);
 262 
 263         if (!found) {
 264             Log.wtf(TAG, &quot;Not enough space on an empty screen&quot;);
 265         }
 266         return screenId;
 267     }
 268 
 269     public static interface AccessibilityDragSource {
 270         public abstract void startDrag(CellLayout.CellInfo cellInfo, boolean accessible);
 271 
 272         public abstract void enableAccessibleDrag(boolean enable);
 273     }
 274 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.android.launcher3;
   2  
   3  import android.annotation.TargetApi;
   4  import android.graphics.Rect;
   5  import android.os.Build;
   6  import android.os.Bundle;
   7  import android.text.TextUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +import android.util.Log;</span>
   9  import android.util.SparseArray;
  10  import android.view.View;
  11  import android.view.View.AccessibilityDelegate;
  12  import android.view.accessibility.AccessibilityNodeInfo;
  13  import android.view.accessibility.AccessibilityNodeInfo.AccessibilityAction;
  14  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import com.android.launcher3.LauncherModel.ScreenPosProvider;</span>
  16  import com.android.launcher3.util.Thunk;
  17  
  18  import java.util.ArrayList;
  19  
  20  @TargetApi(Build.VERSION_CODES.LOLLIPOP)
  21  public class LauncherAccessibilityDelegate extends AccessibilityDelegate {
  22  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -    public static final int REMOVE = R.id.action_remove;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -    public static final int INFO = R.id.action_info;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -    public static final int UNINSTALL = R.id.action_uninstall;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -    public static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -    public static final int MOVE = R.id.action_move;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +    private static final String TAG = &quot;LauncherAccessibilityDelegate&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +    private static final int REMOVE = R.id.action_remove;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +    private static final int INFO = R.id.action_info;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +    private static final int UNINSTALL = R.id.action_uninstall;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +    private static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +    private static final int MOVE = R.id.action_move;</span>
  35  
  36      enum DragType {

  37          ICON,
  38          FOLDER,
  39          WIDGET
  40      }
  41  
  42      public static class DragInfo {
  43          DragType dragType;
  44          ItemInfo info;
  45          View item;
  46      }
  47  
  48      private DragInfo mDragInfo = null;




  49  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -    private final SparseArray&lt;AccessibilityAction&gt; mActions =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -            new SparseArray&lt;AccessibilityAction&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +    private final SparseArray&lt;AccessibilityAction&gt; mActions = new SparseArray&lt;&gt;();</span>
  53      @Thunk final Launcher mLauncher;



  54  
  55      public LauncherAccessibilityDelegate(Launcher launcher) {
  56          mLauncher = launcher;
  57  
  58          mActions.put(REMOVE, new AccessibilityAction(REMOVE,
  59                  launcher.getText(R.string.delete_target_label)));
  60          mActions.put(INFO, new AccessibilityAction(INFO,
  61                  launcher.getText(R.string.info_target_label)));
  62          mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL,
  63                  launcher.getText(R.string.delete_target_uninstall_label)));
  64          mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE,
  65                  launcher.getText(R.string.action_add_to_workspace)));
  66          mActions.put(MOVE, new AccessibilityAction(MOVE,
  67                  launcher.getText(R.string.action_move)));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
  69      }
  70  
  71      @Override
  72      public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
  73          super.onInitializeAccessibilityNodeInfo(host, info);
  74          if (!(host.getTag() instanceof ItemInfo)) return;
  75          ItemInfo item = (ItemInfo) host.getTag();
  76  
  77          if (DeleteDropTarget.supportsDrop(item)) {
  78              info.addAction(mActions.get(REMOVE));
  79          }
  80          if (UninstallDropTarget.supportsDrop(host.getContext(), item)) {
  81              info.addAction(mActions.get(UNINSTALL));
  82          }
  83          if (InfoDropTarget.supportsDrop(host.getContext(), item)) {
  84              info.addAction(mActions.get(INFO));
  85          }
  86  
  87          if ((item instanceof ShortcutInfo)
  88                  || (item instanceof LauncherAppWidgetInfo)
  89                  || (item instanceof FolderInfo)) {
  90              info.addAction(mActions.get(MOVE));
  91          } if ((item instanceof AppInfo) || (item instanceof PendingAddItemInfo)) {
  92              info.addAction(mActions.get(ADD_TO_WORKSPACE));
  93          }
  94      }
  95  
  96      @Override
  97      public boolean performAccessibilityAction(View host, int action, Bundle args) {
  98          if ((host.getTag() instanceof ItemInfo)
  99                  &amp;&amp; performAction(host, (ItemInfo) host.getTag(), action)) {
 100              return true;
 101          }
 102          return super.performAccessibilityAction(host, action, args);
 103      }
 104  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    public boolean performAction(View host, ItemInfo item, int action) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    public boolean performAction(View host, final ItemInfo item, int action) {</span>
 107          if (action == REMOVE) {
 108              if (DeleteDropTarget.removeWorkspaceOrFolderItem(mLauncher, item, host)) {
 109                  announceConfirmation(R.string.item_removed);
 110                  return true;
 111              }
 112              return false;
 113          } else if (action == INFO) {
 114              InfoDropTarget.startDetailsActivityForInfo(item, mLauncher);
 115              return true;
 116          } else if (action == UNINSTALL) {
 117              return UninstallDropTarget.startUninstallActivity(mLauncher, item);
 118          } else if (action == MOVE) {
 119              beginAccessibleDrag(host, item);
 120          } else if (action == ADD_TO_WORKSPACE) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -            final int preferredPage = mLauncher.getWorkspace().getCurrentPage();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -            final ScreenPosProvider screenProvider = new ScreenPosProvider() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +            final int[] coordinates = new int[2];</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +            final long screenId = findSpaceOnWorkspace(item, coordinates);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            mLauncher.showWorkspace(true, new Runnable() {</span>
 126  
 127                  @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -                public int getScreenIndex(ArrayList&lt;Long&gt; screenIDs) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                    return preferredPage;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +                    if (item instanceof AppInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                        ShortcutInfo info = ((AppInfo) item).makeShortcut();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +                        LauncherModel.addItemToDatabase(mLauncher, info,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                                LauncherSettings.Favorites.CONTAINER_DESKTOP,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +                                screenId, coordinates[0], coordinates[1]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                        ArrayList&lt;ItemInfo&gt; itemList = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                        itemList.add(info);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +                        mLauncher.bindItems(itemList, 0, itemList.size(), true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                    } else if (item instanceof PendingAddItemInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                        PendingAddItemInfo info = (PendingAddItemInfo) item;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                        Workspace workspace = mLauncher.getWorkspace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                        workspace.snapToPage(workspace.getPageIndexForScreenId(screenId));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                        mLauncher.addPendingItem(info, LauncherSettings.Favorites.CONTAINER_DESKTOP,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                                screenId, coordinates, info.spanX, info.spanY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                    announceConfirmation(R.string.item_added_to_workspace);</span>
 148                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            if (item instanceof AppInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                final ArrayList&lt;ItemInfo&gt; addShortcuts = new ArrayList&lt;ItemInfo&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                addShortcuts.add(((AppInfo) item).makeShortcut());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                mLauncher.showWorkspace(true, new Runnable() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                    public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                        mLauncher.getModel().addAndBindAddedWorkspaceItems(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                                mLauncher, addShortcuts, screenProvider, 0, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                        announceConfirmation(R.string.item_added_to_workspace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -            } else if (item instanceof PendingAddItemInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                mLauncher.getModel().addAndBindPendingItem(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -                        mLauncher, (PendingAddItemInfo) item, screenProvider, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                announceConfirmation(R.string.item_added_to_workspace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +            return true;</span>
 170          }
 171          return false;
 172      }
 173  
 174      @Thunk void announceConfirmation(int resId) {
 175          announceConfirmation(mLauncher.getResources().getString(resId));
 176      }
 177  
 178      @Thunk void announceConfirmation(String confirmation) {
 179          mLauncher.getDragLayer().announceForAccessibility(confirmation);
 180  
 181      }
 182  
 183      public boolean isInAccessibleDrag() {
 184          return mDragInfo != null;
 185      }
 186  
 187      public DragInfo getDragInfo() {
 188          return mDragInfo;
 189      }
 190  
 191      /**
 192       * @param clickedTarget the actual view that was clicked
 193       * @param dropLocation relative to {@param clickedTarget}. If provided, its center is used
 194       * as the actual drop location otherwise the views center is used.
 195       */
 196      public void handleAccessibleDrop(View clickedTarget, Rect dropLocation,
 197              String confirmation) {
 198          if (!isInAccessibleDrag()) return;
 199  
 200          int[] loc = new int[2];
 201          if (dropLocation == null) {
 202              loc[0] = clickedTarget.getWidth() / 2;
 203              loc[1] = clickedTarget.getHeight() / 2;
 204          } else {
 205              loc[0] = dropLocation.centerX();
 206              loc[1] = dropLocation.centerY();
 207          }
 208  
 209          mLauncher.getDragLayer().getDescendantCoordRelativeToSelf(clickedTarget, loc);
 210          mLauncher.getDragController().completeAccessibleDrag(loc);
 211  
 212          endAccessibleDrag();
 213          if (!TextUtils.isEmpty(confirmation)) {
 214              announceConfirmation(confirmation);
 215          }
 216      }
 217  
 218      public void beginAccessibleDrag(View item, ItemInfo info) {
 219          mDragInfo = new DragInfo();
 220          mDragInfo.info = info;
 221          mDragInfo.item = item;
 222          mDragInfo.dragType = DragType.ICON;
 223          if (info instanceof FolderInfo) {
 224              mDragInfo.dragType = DragType.FOLDER;
 225          } else if (info instanceof LauncherAppWidgetInfo) {
 226              mDragInfo.dragType = DragType.WIDGET;
 227          }
 228  
 229          CellLayout.CellInfo cellInfo = new CellLayout.CellInfo(item, info);
 230  
 231          Rect pos = new Rect();
 232          mLauncher.getDragLayer().getDescendantRectRelativeToSelf(item, pos);
 233  
 234          mLauncher.getDragController().prepareAccessibleDrag(pos.centerX(), pos.centerY());
 235          mLauncher.getWorkspace().enableAccessibleDrag(true);
 236          mLauncher.getWorkspace().startDrag(cellInfo, true);
















 237      }
 238  
 239      public boolean onBackPressed() {
 240          if (isInAccessibleDrag()) {
 241              cancelAccessibleDrag();
 242              return true;
 243          }
 244          return false;
 245      }
 246  
 247      private void cancelAccessibleDrag() {
 248          mLauncher.getDragController().cancelDrag();
 249          endAccessibleDrag();
 250      }
 251  
 252      private void endAccessibleDrag() {
 253          mDragInfo = null;
 254          mLauncher.getWorkspace().enableAccessibleDrag(false);










 255      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +     * Find empty space on the workspace and returns the screenId.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +    private long findSpaceOnWorkspace(ItemInfo info, int[] outCoordinates) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +        Workspace workspace = mLauncher.getWorkspace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +        ArrayList&lt;Long&gt; workspaceScreens = workspace.getScreenOrder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +        long screenId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +        // First check if there is space on the current screen.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +        int screenIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +        screenId = workspaceScreens.get(screenIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +        CellLayout layout = (CellLayout) workspace.getPageAt(screenIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        boolean found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        screenIndex = workspace.hasCustomContent() ? 1 : 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        while (!found &amp;&amp; screenIndex &lt; workspaceScreens.size()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            screenId = workspaceScreens.get(screenIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +            layout = (CellLayout) workspace.getPageAt(screenIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            screenIndex++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +        if (found) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +            return screenId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +        workspace.addExtraEmptyScreen();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +        screenId = workspace.commitExtraEmptyScreen();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +        layout = workspace.getScreenWithId(screenId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +        found = layout.findCellForSpan(outCoordinates, info.spanX, info.spanY);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +        if (!found) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +            Log.wtf(TAG, &quot;Not enough space on an empty screen&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +        return screenId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +    }</span>
 293  }</pre></td>
                            <td><pre>   1  package com.android.launcher3;
   2  
   3  import android.annotation.TargetApi;
   4  import android.graphics.Rect;
   5  import android.os.Build;
   6  import android.os.Bundle;
   7  import android.text.TextUtils;

   8  import android.util.SparseArray;
   9  import android.view.View;
  10  import android.view.View.AccessibilityDelegate;
  11  import android.view.accessibility.AccessibilityNodeInfo;
  12  import android.view.accessibility.AccessibilityNodeInfo.AccessibilityAction;
  13  
  14  import com.android.launcher3.LauncherModel.ScreenPosProvider;
  15  import com.android.launcher3.util.Thunk;
  16  
  17  import java.util.ArrayList;
  18  
  19  @TargetApi(Build.VERSION_CODES.LOLLIPOP)
  20  public class LauncherAccessibilityDelegate extends AccessibilityDelegate {
  21  
  22      public static final int REMOVE = R.id.action_remove;
  23      public static final int INFO = R.id.action_info;
  24      public static final int UNINSTALL = R.id.action_uninstall;
  25      public static final int ADD_TO_WORKSPACE = R.id.action_add_to_workspace;
  26      public static final int MOVE = R.id.action_move;







  27  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -    enum DragType {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +    public enum DragType {</span>
  30          ICON,
  31          FOLDER,
  32          WIDGET
  33      }
  34  
  35      public static class DragInfo {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -        DragType dragType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -        ItemInfo info;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -        View item;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -    private DragInfo mDragInfo = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +        public DragType dragType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +        public ItemInfo info;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +        public View item;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +    }</span>
  46  
  47      private final SparseArray&lt;AccessibilityAction&gt; mActions =
  48              new SparseArray&lt;AccessibilityAction&gt;();

  49      @Thunk final Launcher mLauncher;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +    private DragInfo mDragInfo = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +    private AccessibilityDragSource mDragSource = null;</span>
  53  
  54      public LauncherAccessibilityDelegate(Launcher launcher) {
  55          mLauncher = launcher;
  56  
  57          mActions.put(REMOVE, new AccessibilityAction(REMOVE,
  58                  launcher.getText(R.string.delete_target_label)));
  59          mActions.put(INFO, new AccessibilityAction(INFO,
  60                  launcher.getText(R.string.info_target_label)));
  61          mActions.put(UNINSTALL, new AccessibilityAction(UNINSTALL,
  62                  launcher.getText(R.string.delete_target_uninstall_label)));
  63          mActions.put(ADD_TO_WORKSPACE, new AccessibilityAction(ADD_TO_WORKSPACE,
  64                  launcher.getText(R.string.action_add_to_workspace)));
  65          mActions.put(MOVE, new AccessibilityAction(MOVE,
  66                  launcher.getText(R.string.action_move)));
  67  
  68      }
  69  
  70      @Override
  71      public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
  72          super.onInitializeAccessibilityNodeInfo(host, info);
  73          if (!(host.getTag() instanceof ItemInfo)) return;
  74          ItemInfo item = (ItemInfo) host.getTag();
  75  
  76          if (DeleteDropTarget.supportsDrop(item)) {
  77              info.addAction(mActions.get(REMOVE));
  78          }
  79          if (UninstallDropTarget.supportsDrop(host.getContext(), item)) {
  80              info.addAction(mActions.get(UNINSTALL));
  81          }
  82          if (InfoDropTarget.supportsDrop(host.getContext(), item)) {
  83              info.addAction(mActions.get(INFO));
  84          }
  85  
  86          if ((item instanceof ShortcutInfo)
  87                  || (item instanceof LauncherAppWidgetInfo)
  88                  || (item instanceof FolderInfo)) {
  89              info.addAction(mActions.get(MOVE));
  90          } if ((item instanceof AppInfo) || (item instanceof PendingAddItemInfo)) {
  91              info.addAction(mActions.get(ADD_TO_WORKSPACE));
  92          }
  93      }
  94  
  95      @Override
  96      public boolean performAccessibilityAction(View host, int action, Bundle args) {
  97          if ((host.getTag() instanceof ItemInfo)
  98                  &amp;&amp; performAction(host, (ItemInfo) host.getTag(), action)) {
  99              return true;
 100          }
 101          return super.performAccessibilityAction(host, action, args);
 102      }
 103  
 104      public boolean performAction(View host, ItemInfo item, int action) {

 105          if (action == REMOVE) {
 106              if (DeleteDropTarget.removeWorkspaceOrFolderItem(mLauncher, item, host)) {
 107                  announceConfirmation(R.string.item_removed);
 108                  return true;
 109              }
 110              return false;
 111          } else if (action == INFO) {
 112              InfoDropTarget.startDetailsActivityForInfo(item, mLauncher);
 113              return true;
 114          } else if (action == UNINSTALL) {
 115              return UninstallDropTarget.startUninstallActivity(mLauncher, item);
 116          } else if (action == MOVE) {
 117              beginAccessibleDrag(host, item);
 118          } else if (action == ADD_TO_WORKSPACE) {
 119              final int preferredPage = mLauncher.getWorkspace().getCurrentPage();
 120              final ScreenPosProvider screenProvider = new ScreenPosProvider() {



 121  
 122                  @Override
 123                  public int getScreenIndex(ArrayList&lt;Long&gt; screenIDs) {
 124                      return preferredPage;


















 125                  }
 126              };
 127              if (item instanceof AppInfo) {
 128                  final ArrayList&lt;ItemInfo&gt; addShortcuts = new ArrayList&lt;ItemInfo&gt;();
 129                  addShortcuts.add(((AppInfo) item).makeShortcut());
 130                  mLauncher.showWorkspace(true, new Runnable() {
 131                      @Override
 132                      public void run() {
 133                          mLauncher.getModel().addAndBindAddedWorkspaceItems(
 134                                  mLauncher, addShortcuts, screenProvider, 0, true);
 135                          announceConfirmation(R.string.item_added_to_workspace);
 136                      }
 137                  });
 138                  return true;
 139              } else if (item instanceof PendingAddItemInfo) {
 140                  mLauncher.getModel().addAndBindPendingItem(
 141                          mLauncher, (PendingAddItemInfo) item, screenProvider, 0);
 142                  announceConfirmation(R.string.item_added_to_workspace);
 143                  return true;
 144              }


 145          }
 146          return false;
 147      }
 148  
 149      @Thunk void announceConfirmation(int resId) {
 150          announceConfirmation(mLauncher.getResources().getString(resId));
 151      }
 152  
 153      @Thunk void announceConfirmation(String confirmation) {
 154          mLauncher.getDragLayer().announceForAccessibility(confirmation);
 155  
 156      }
 157  
 158      public boolean isInAccessibleDrag() {
 159          return mDragInfo != null;
 160      }
 161  
 162      public DragInfo getDragInfo() {
 163          return mDragInfo;
 164      }
 165  
 166      /**
 167       * @param clickedTarget the actual view that was clicked
 168       * @param dropLocation relative to {@param clickedTarget}. If provided, its center is used
 169       * as the actual drop location otherwise the views center is used.
 170       */
 171      public void handleAccessibleDrop(View clickedTarget, Rect dropLocation,
 172              String confirmation) {
 173          if (!isInAccessibleDrag()) return;
 174  
 175          int[] loc = new int[2];
 176          if (dropLocation == null) {
 177              loc[0] = clickedTarget.getWidth() / 2;
 178              loc[1] = clickedTarget.getHeight() / 2;
 179          } else {
 180              loc[0] = dropLocation.centerX();
 181              loc[1] = dropLocation.centerY();
 182          }
 183  
 184          mLauncher.getDragLayer().getDescendantCoordRelativeToSelf(clickedTarget, loc);
 185          mLauncher.getDragController().completeAccessibleDrag(loc);
 186  
 187          endAccessibleDrag();
 188          if (!TextUtils.isEmpty(confirmation)) {
 189              announceConfirmation(confirmation);
 190          }
 191      }
 192  
 193      public void beginAccessibleDrag(View item, ItemInfo info) {
 194          mDragInfo = new DragInfo();
 195          mDragInfo.info = info;
 196          mDragInfo.item = item;
 197          mDragInfo.dragType = DragType.ICON;
 198          if (info instanceof FolderInfo) {
 199              mDragInfo.dragType = DragType.FOLDER;
 200          } else if (info instanceof LauncherAppWidgetInfo) {
 201              mDragInfo.dragType = DragType.WIDGET;
 202          }
 203  
 204          CellLayout.CellInfo cellInfo = new CellLayout.CellInfo(item, info);
 205  
 206          Rect pos = new Rect();
 207          mLauncher.getDragLayer().getDescendantRectRelativeToSelf(item, pos);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -</span>
 209          mLauncher.getDragController().prepareAccessibleDrag(pos.centerX(), pos.centerY());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        mLauncher.getWorkspace().enableAccessibleDrag(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        mLauncher.getWorkspace().startDrag(cellInfo, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        Workspace workspace = mLauncher.getWorkspace();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        Folder folder = workspace.getOpenFolder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +        if (folder != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            if (folder.getItemsInReadingOrder().contains(item)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                mDragSource = folder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                mLauncher.closeFolder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +        if (mDragSource == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +            mDragSource = workspace;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +        mDragSource.enableAccessibleDrag(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        mDragSource.startDrag(cellInfo, true);</span>
 228      }
 229  
 230      public boolean onBackPressed() {
 231          if (isInAccessibleDrag()) {
 232              cancelAccessibleDrag();
 233              return true;
 234          }
 235          return false;
 236      }
 237  
 238      private void cancelAccessibleDrag() {
 239          mLauncher.getDragController().cancelDrag();
 240          endAccessibleDrag();
 241      }
 242  
 243      private void endAccessibleDrag() {
 244          mDragInfo = null;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -        mLauncher.getWorkspace().enableAccessibleDrag(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +        if (mDragSource != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +            mDragSource.enableAccessibleDrag(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +            mDragSource = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +    public static interface AccessibilityDragSource {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        void startDrag(CellLayout.CellInfo cellInfo, boolean accessible);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +        void enableAccessibleDrag(boolean enable);</span>
 256      }





































 257  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            