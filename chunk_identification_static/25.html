<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>25</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    25
                    <a href="24.html">prev</a>
                    <a href="26.html">next</a>
                    <a href="25_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_1469ca1ceaae9c691eee7790de89a3ee1f571403_Aria/src/main/java/com/arialyy/aria/core/common/ThreadStateManager.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403:Aria/src/main/java/com/arialyy/aria/core/common/ThreadStateManager.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^1:Aria/src/main/java/com/arialyy/aria/core/common/ThreadStateManager.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;1469ca1ceaae9c691eee7790de89a3ee1f571403^2:Aria/src/main/java/com/arialyy/aria/core/common/ThreadStateManager.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;39a43c836d3309cbbf82de6d51309fe71fc25292:Aria/src/main/java/com/arialyy/aria/core/common/ThreadStateManager.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.os.Bundle;
  19 import android.os.Handler;
  20 import android.os.Looper;
  21 import android.os.Message;
  22 import com.arialyy.aria.core.inf.IEventListener;
  23 import com.arialyy.aria.exception.BaseException;
  24 import com.arialyy.aria.util.ALog;
  25 import com.arialyy.aria.util.FileUtil;
  26 import java.io.File;
  27 import java.util.ArrayList;
  28 import java.util.List;
  29 
  30 /**
  31  * 线程任务管理器，用于处理多线程下载时任务的状态回调
  32  */
  33 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 public class ThreadStateManager implements IThreadState {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38    * 任务状态回调</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private IEventListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private Looper mLooper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52    * @param listener 任务事件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     mLooper = looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     switch (msg.what) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       case STATE_STOP:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64         mStopNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65         if (isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70       case STATE_CANCEL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         mCancelNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72         if (isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78       case STATE_FAIL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79         mFailNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         if (isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81           Bundle b = msg.getData();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       case STATE_COMPLETE:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         mCompleteNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         if (isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92             if (mergeFile()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93               mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95               mListener.onFail(false, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103       case STATE_RUNNING:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107         if (msg.obj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118    * 退出looper循环</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120   private void quitLooper() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121     mLooper.quit();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125    * 获取当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127    * @return 当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130   public long getCurrentProgress() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     return mProgress;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   public boolean isStop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   public boolean isFail() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161   public boolean isComplete() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     //        mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172   @Override</span>
 173 ||||||| GitAnalyzerPlus_base
 174 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 public class ThreadStateManager implements Handler.Callback {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177   public static final int STATE_STOP = 0x01;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178   public static final int STATE_FAIL = 0x02;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179   public static final int STATE_CANCEL = 0x03;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180   public static final int STATE_COMPLETE = 0x04;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181   public static final int STATE_RUNNING = 0x05;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182   public static final int STATE_UPDATE_PROGRESS = 0x06;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183   public static final String KEY_RETRY = &quot;KEY_RETRY&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184   public static final String KEY_ERROR_INFO = &quot;KEY_ERROR_INFO&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187    * 任务状态回调</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189   private IEventListener mListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197   private Looper mLooper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201    * @param listener 任务事件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204     mLooper = looper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207     mListener = listener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211     switch (msg.what) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212       case STATE_STOP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         mStopNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         if (isStop()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219       case STATE_CANCEL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         mCancelNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         if (isCancel()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223           mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227       case STATE_FAIL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         mFailNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229         if (isFail()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230           Bundle b = msg.getData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236       case STATE_COMPLETE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         mCompleteNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         if (isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241             if (mergeFile()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242               mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244               mListener.onFail(false, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246           } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247             mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252       case STATE_RUNNING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         if (msg.obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267    * 退出looper循环</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269   private void quitLooper() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270     mLooper.quit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274    * 获取当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276    * @return 当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278   public long getCurrentProgress() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279     return mProgress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285   public boolean isStop() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295   public boolean isFail() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306   public boolean isComplete() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309     //        mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316    */</span>
 317 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 318   public boolean isCancel() {
 319     //ALog.d(TAG, String.format(&quot;isCancel; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,
 320     //    mStopNum,
 321     //    mCancelNum, mFailNum, mCompleteNum));
 322     return mCancelNum == mThreadNum;
 323   }
 324 
 325   /**
 326    * 更新分块任务s的真实进度
 327    */
 328   private long updateBlockProgress() {
 329     long size = 0;
 330     for (int i = 0, len = mTaskRecord.threadRecords.size(); i &lt; len; i++) {
 331       File temp = new File(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 332       if (temp.exists()) {
 333         size += temp.length();
 334       }
 335     }
 336     return size;
 337   }
 338 
 339   /**
 340    * 合并文件
 341    *
 342    * @return {@code true} 合并成功，{@code false}合并失败
 343    */
 344   private boolean mergeFile() {
 345     List&lt;String&gt; partPath = new ArrayList&lt;&gt;();
 346     for (int i = 0, len = mTaskRecord.threadNum; i &lt; len; i++) {
 347       partPath.add(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 348     }
 349     boolean isSuccess = FileUtil.mergeFile(mTaskRecord.filePath, partPath);
 350     if (isSuccess) {
 351       for (String pp : partPath) {
 352         File f = new File(pp);
 353         if (f.exists()) {
 354           f.delete();
 355         }
 356       }
 357       File targetFile = new File(mTaskRecord.filePath);
 358       if (targetFile.exists() &amp;&amp; targetFile.length() &gt; mTaskRecord.fileLength) {
 359         ALog.e(TAG, String.format(&quot;任务【%s】分块文件合并失败，下载长度超出文件真实长度，downloadLen: %s，fileSize: %s&quot;,
 360             targetFile.getName(), targetFile.length(), mTaskRecord.fileLength));
 361         return false;
 362       }
 363       return true;
 364     } else {
 365       ALog.e(TAG, &quot;合并失败&quot;);
 366       return false;
 367     }
 368   }
 369 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.os.Bundle;
  19 import android.os.Handler;
  20 import android.os.Looper;
  21 import android.os.Message;
  22 import com.arialyy.aria.core.inf.IEventListener;
  23 import com.arialyy.aria.exception.BaseException;
  24 import com.arialyy.aria.util.ALog;
  25 import com.arialyy.aria.util.FileUtil;
  26 import java.io.File;
  27 import java.util.ArrayList;
  28 import java.util.List;
  29 
  30 /**
  31  * 线程任务管理器，用于处理多线程下载时任务的状态回调
  32  */
  33 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 public class ThreadStateManager implements IThreadState {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38    * 任务状态回调</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private IEventListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private Looper mLooper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52    * @param listener 任务事件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     mLooper = looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     switch (msg.what) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       case STATE_STOP:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64         mStopNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65         if (isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70       case STATE_CANCEL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         mCancelNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72         if (isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78       case STATE_FAIL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79         mFailNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         if (isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81           Bundle b = msg.getData();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       case STATE_COMPLETE:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         mCompleteNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         if (isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92             if (mergeFile()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93               mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95               mListener.onFail(false, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103       case STATE_RUNNING:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107         if (msg.obj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118    * 退出looper循环</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120   private void quitLooper() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121     mLooper.quit();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125    * 获取当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127    * @return 当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130   public long getCurrentProgress() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     return mProgress;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   public boolean isStop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   public boolean isFail() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161   public boolean isComplete() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     //        mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172   @Override</span>
 173 ||||||| BASE
 174 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 public class ThreadStateManager implements Handler.Callback {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177   public static final int STATE_STOP = 0x01;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178   public static final int STATE_FAIL = 0x02;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179   public static final int STATE_CANCEL = 0x03;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180   public static final int STATE_COMPLETE = 0x04;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181   public static final int STATE_RUNNING = 0x05;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182   public static final int STATE_UPDATE_PROGRESS = 0x06;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183   public static final String KEY_RETRY = &quot;KEY_RETRY&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184   public static final String KEY_ERROR_INFO = &quot;KEY_ERROR_INFO&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187    * 任务状态回调</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189   private IEventListener mListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197   private Looper mLooper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201    * @param listener 任务事件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204     mLooper = looper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207     mListener = listener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211     switch (msg.what) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212       case STATE_STOP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         mStopNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214         if (isStop()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219       case STATE_CANCEL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         mCancelNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         if (isCancel()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223           mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227       case STATE_FAIL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         mFailNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229         if (isFail()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230           Bundle b = msg.getData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236       case STATE_COMPLETE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         mCompleteNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         if (isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241             if (mergeFile()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242               mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244               mListener.onFail(false, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246           } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247             mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252       case STATE_RUNNING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         if (msg.obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263     return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267    * 退出looper循环</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269   private void quitLooper() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270     mLooper.quit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274    * 获取当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276    * @return 当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278   public long getCurrentProgress() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279     return mProgress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285   public boolean isStop() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295   public boolean isFail() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306   public boolean isComplete() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309     //        mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316    */</span>
 317 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 318   public boolean isCancel() {
 319     //ALog.d(TAG, String.format(&quot;isCancel; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,
 320     //    mStopNum,
 321     //    mCancelNum, mFailNum, mCompleteNum));
 322     return mCancelNum == mThreadNum;
 323   }
 324 
 325   /**
 326    * 更新分块任务s的真实进度
 327    */
 328   private long updateBlockProgress() {
 329     long size = 0;
 330     for (int i = 0, len = mTaskRecord.threadRecords.size(); i &lt; len; i++) {
 331       File temp = new File(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 332       if (temp.exists()) {
 333         size += temp.length();
 334       }
 335     }
 336     return size;
 337   }
 338 
 339   /**
 340    * 合并文件
 341    *
 342    * @return {@code true} 合并成功，{@code false}合并失败
 343    */
 344   private boolean mergeFile() {
 345     List&lt;String&gt; partPath = new ArrayList&lt;&gt;();
 346     for (int i = 0, len = mTaskRecord.threadNum; i &lt; len; i++) {
 347       partPath.add(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 348     }
 349     boolean isSuccess = FileUtil.mergeFile(mTaskRecord.filePath, partPath);
 350     if (isSuccess) {
 351       for (String pp : partPath) {
 352         File f = new File(pp);
 353         if (f.exists()) {
 354           f.delete();
 355         }
 356       }
 357       File targetFile = new File(mTaskRecord.filePath);
 358       if (targetFile.exists() &amp;&amp; targetFile.length() &gt; mTaskRecord.fileLength) {
 359         ALog.e(TAG, String.format(&quot;任务【%s】分块文件合并失败，下载长度超出文件真实长度，downloadLen: %s，fileSize: %s&quot;,
 360             targetFile.getName(), targetFile.length(), mTaskRecord.fileLength));
 361         return false;
 362       }
 363       return true;
 364     } else {
 365       ALog.e(TAG, &quot;合并失败&quot;);
 366       return false;
 367     }
 368   }
 369 }
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.common;
  17 
  18 import android.os.Bundle;
  19 import android.os.Handler;
  20 import android.os.Looper;
  21 import android.os.Message;
  22 import com.arialyy.aria.core.inf.IEventListener;
  23 import com.arialyy.aria.exception.BaseException;
  24 import com.arialyy.aria.util.ALog;
  25 import com.arialyy.aria.util.FileUtil;
  26 import java.io.File;
  27 import java.util.ArrayList;
  28 import java.util.List;
  29 
  30 /**
  31  * 线程任务管理器，用于处理多线程下载时任务的状态回调
  32  */
  33 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 public class ThreadStateManager implements IThreadState {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38    * 任务状态回调</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private IEventListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private Looper mLooper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52    * @param listener 任务事件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     mLooper = looper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58     mListener = listener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     switch (msg.what) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63       case STATE_STOP:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64         mStopNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65         if (isStop()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70       case STATE_CANCEL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         mCancelNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72         if (isCancel()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74           mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78       case STATE_FAIL:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79         mFailNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80         if (isFail()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81           Bundle b = msg.getData();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       case STATE_COMPLETE:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88         mCompleteNum++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89         if (isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92             if (mergeFile()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93               mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94             } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95               mListener.onFail(false, null);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97           } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98             mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100           quitLooper();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103       case STATE_RUNNING:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107         if (msg.obj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118    * 退出looper循环</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120   private void quitLooper() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121     mLooper.quit();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125    * 获取当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126    *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127    * @return 当前任务下载进度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130   public long getCurrentProgress() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     return mProgress;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138   public boolean isStop() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   public boolean isFail() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160   @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161   public boolean isComplete() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     //ALog.d(TAG,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164     //        mStopNum,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172   @Override</span>
 173 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 174 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 174 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 175 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 public class ThreadStateManager implements Handler.Callback {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178   private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179   public static final int STATE_STOP = 0x01;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180   public static final int STATE_FAIL = 0x02;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181   public static final int STATE_CANCEL = 0x03;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182   public static final int STATE_COMPLETE = 0x04;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183   public static final int STATE_RUNNING = 0x05;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184   public static final int STATE_UPDATE_PROGRESS = 0x06;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185   public static final String KEY_RETRY = &quot;KEY_RETRY&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186   public static final String KEY_ERROR_INFO = &quot;KEY_ERROR_INFO&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189    * 任务状态回调</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191   private IEventListener mListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192   private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193   private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194   private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195   private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196   private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197   private long mProgress; //当前总进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198   private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199   private Looper mLooper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202    * @param taskRecord 任务记录</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203    * @param listener 任务事件</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205   ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206     mLooper = looper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207     mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208     mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209     mListener = listener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213     switch (msg.what) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214       case STATE_STOP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         mStopNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216         if (isStop()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217           mListener.onStop(mProgress);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221       case STATE_CANCEL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222         mCancelNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223         if (isCancel()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224           ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225           mListener.onCancel();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229       case STATE_FAIL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230         mFailNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         if (isFail()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232           Bundle b = msg.getData();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233           mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234               (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238       case STATE_COMPLETE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         mCompleteNum++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         if (isComplete()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241           ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242           if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243             if (mergeFile()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244               mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246               mListener.onFail(false, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248           } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249             mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251           quitLooper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254       case STATE_RUNNING:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257       case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         if (msg.obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259           mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261           mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269    * 退出looper循环</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271   private void quitLooper() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272     mLooper.quit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276    * 获取当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277    *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278    * @return 当前任务下载进度</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280   public long getCurrentProgress() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281     return mProgress;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285    * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287   public boolean isStop() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289     //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291     return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295    * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297   public boolean isFail() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302         &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306    * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307    */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308   public boolean isComplete() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309     //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     //        mStopNum,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313     return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314   }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316   /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317    * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318    */</span>
 319 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 320   public boolean isCancel() {
 321     //ALog.d(TAG, String.format(&quot;isCancel; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,
 322     //    mStopNum,
 323     //    mCancelNum, mFailNum, mCompleteNum));
 324     return mCancelNum == mThreadNum;
 325   }
 326 
 327   /**
 328    * 更新分块任务s的真实进度
 329    */
 330   private long updateBlockProgress() {
 331     long size = 0;
 332     for (int i = 0, len = mTaskRecord.threadRecords.size(); i &lt; len; i++) {
 333       File temp = new File(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 334       if (temp.exists()) {
 335         size += temp.length();
 336       }
 337     }
 338     return size;
 339   }
 340 
 341   /**
 342    * 合并文件
 343    *
 344    * @return {@code true} 合并成功，{@code false}合并失败
 345    */
 346   private boolean mergeFile() {
 347     List&lt;String&gt; partPath = new ArrayList&lt;&gt;();
 348     for (int i = 0, len = mTaskRecord.threadNum; i &lt; len; i++) {
 349       partPath.add(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));
 350     }
 351     boolean isSuccess = FileUtil.mergeFile(mTaskRecord.filePath, partPath);
 352     if (isSuccess) {
 353       for (String pp : partPath) {
 354         File f = new File(pp);
 355         if (f.exists()) {
 356           f.delete();
 357         }
 358       }
 359       File targetFile = new File(mTaskRecord.filePath);
 360       if (targetFile.exists() &amp;&amp; targetFile.length() &gt; mTaskRecord.fileLength) {
 361         ALog.e(TAG, String.format(&quot;任务【%s】分块文件合并失败，下载长度超出文件真实长度，downloadLen: %s，fileSize: %s&quot;,
 362             targetFile.getName(), targetFile.length(), mTaskRecord.fileLength));
 363         return false;
 364       }
 365       return true;
 366     } else {
 367       ALog.e(TAG, &quot;合并失败&quot;);
 368       return false;
 369     }
 370   }
 371 }</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +package com.arialyy.aria.core.common;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.os.Bundle;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.os.Handler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import android.os.Looper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import android.os.Message;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.arialyy.aria.core.inf.IEventListener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 + * 线程任务管理器，用于处理多线程下载时任务的状态回调</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +public class ThreadStateManager implements IThreadState {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +  private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +   * 任务状态回调</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +  private IEventListener mListener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +  private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +  private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +  private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +  private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +  private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +  private long mProgress; //当前总进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +  private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +  private Looper mLooper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +   * @param taskRecord 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +   * @param listener 任务事件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +  ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +    mLooper = looper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +    mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    mListener = listener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +  @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    switch (msg.what) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +      case STATE_STOP:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +        mStopNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +        if (isStop()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +          mListener.onStop(mProgress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +      case STATE_CANCEL:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +        mCancelNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        if (isCancel()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +          ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +          mListener.onCancel();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +      case STATE_FAIL:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        mFailNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        if (isFail()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +          Bundle b = msg.getData();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +          mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +              (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +      case STATE_COMPLETE:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +        mCompleteNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        if (isComplete()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +          ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +          if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +            if (mergeFile()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +              mListener.onComplete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +              mListener.onFail(false, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +          } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            mListener.onComplete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +      case STATE_RUNNING:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +        mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +      case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        if (msg.obj == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +          mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +          mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +   * 退出looper循环</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +  private void quitLooper() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    mLooper.quit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +   * 获取当前任务下载进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +   * @return 当前任务下载进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +  @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +  public long getCurrentProgress() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    return mProgress;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +   * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +  @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +  public boolean isStop() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +    return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +   * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +  @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +  public boolean isFail() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +    //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +    return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +   * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +  @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +  public boolean isComplete() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +    //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +    //        mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +    return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +   * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +  @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +  public boolean isCancel() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +    //ALog.d(TAG, String.format(&quot;isCancel; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +    //    mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +    //    mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    return mCancelNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +   * 更新分块任务s的真实进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +  private long updateBlockProgress() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +    long size = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    for (int i = 0, len = mTaskRecord.threadRecords.size(); i &lt; len; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +      File temp = new File(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +      if (temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +        size += temp.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +    return size;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +   * 合并文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +   * @return {@code true} 合并成功，{@code false}合并失败</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +  private boolean mergeFile() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +    List&lt;String&gt; partPath = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +    for (int i = 0, len = mTaskRecord.threadNum; i &lt; len; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +      partPath.add(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +    boolean isSuccess = FileUtil.mergeFile(mTaskRecord.filePath, partPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +    if (isSuccess) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +      for (String pp : partPath) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        File f = new File(pp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +        if (f.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +          f.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +      File targetFile = new File(mTaskRecord.filePath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +      if (targetFile.exists() &amp;&amp; targetFile.length() &gt; mTaskRecord.fileLength) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        ALog.e(TAG, String.format(&quot;任务【%s】分块文件合并失败，下载长度超出文件真实长度，downloadLen: %s，fileSize: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +            targetFile.getName(), targetFile.length(), mTaskRecord.fileLength));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +      return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +      ALog.e(TAG, &quot;合并失败&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +      return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +}</span></pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +package com.arialyy.aria.core.common;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import android.os.Bundle;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +import android.os.Handler;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import android.os.Looper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import android.os.Message;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.arialyy.aria.core.inf.IEventListener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.exception.BaseException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import com.arialyy.aria.util.ALog;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.arialyy.aria.util.FileUtil;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import java.io.File;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import java.util.List;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 + * 线程任务管理器，用于处理多线程下载时任务的状态回调</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +public class ThreadStateManager implements Handler.Callback {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +  private final String TAG = &quot;ThreadTaskStateManager&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +  public static final int STATE_STOP = 0x01;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +  public static final int STATE_FAIL = 0x02;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +  public static final int STATE_CANCEL = 0x03;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +  public static final int STATE_COMPLETE = 0x04;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +  public static final int STATE_RUNNING = 0x05;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +  public static final int STATE_UPDATE_PROGRESS = 0x06;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +  public static final String KEY_RETRY = &quot;KEY_RETRY&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +  public static final String KEY_ERROR_INFO = &quot;KEY_ERROR_INFO&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +   * 任务状态回调</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +  private IEventListener mListener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +  private int mThreadNum;    // 启动的线程总数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +  private int mCancelNum = 0; // 已经取消的线程的数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +  private int mStopNum = 0;  // 已经停止的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +  private int mFailNum = 0;  // 失败的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +  private int mCompleteNum = 0;  // 完成的线程数</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +  private long mProgress; //当前总进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +  private TaskRecord mTaskRecord; // 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +  private Looper mLooper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +   * @param taskRecord 任务记录</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +   * @param listener 任务事件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +  ThreadStateManager(Looper looper, TaskRecord taskRecord, IEventListener listener) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    mLooper = looper;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +    mTaskRecord = taskRecord;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +    mThreadNum = mTaskRecord.threadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +    mListener = listener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +  @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    switch (msg.what) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +      case STATE_STOP:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        mStopNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +        if (isStop()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +          mListener.onStop(mProgress);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +      case STATE_CANCEL:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        mCancelNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +        if (isCancel()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +          ALog.d(TAG, &quot;icCancel&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +          mListener.onCancel();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +      case STATE_FAIL:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        mFailNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +        if (isFail()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +          Bundle b = msg.getData();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +          mListener.onFail(b.getBoolean(KEY_RETRY, true),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +              (BaseException) b.getSerializable(KEY_ERROR_INFO));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +      case STATE_COMPLETE:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        mCompleteNum++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +        if (isComplete()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +          ALog.d(TAG, &quot;isComplete, completeNum = &quot; + mCompleteNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +          if (mTaskRecord.isBlock) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +            if (mergeFile()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +              mListener.onComplete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +              mListener.onFail(false, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +          } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            mListener.onComplete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +          }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +          quitLooper();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +      case STATE_RUNNING:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        mProgress += (long) msg.obj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +      case STATE_UPDATE_PROGRESS:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        if (msg.obj == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +          mProgress = updateBlockProgress();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +          mProgress = (long) msg.obj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +   * 退出looper循环</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +  private void quitLooper() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    mLooper.quit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +   * 获取当前任务下载进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +   * @return 当前任务下载进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +  public long getCurrentProgress() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    return mProgress;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +   * 所有子线程是否都已经停止</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +  public boolean isStop() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    //    String.format(&quot;isStop; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +    return mStopNum == mThreadNum || mStopNum + mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +   * 所有子线程是否都已经失败</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +  public boolean isFail() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +    //    String.format(&quot;isFail; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;, mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    return mCompleteNum != mThreadNum</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        &amp;&amp; (mFailNum == mThreadNum || mFailNum + mCompleteNum == mThreadNum);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +   * 所有子线程是否都已经完成</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +  public boolean isComplete() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +    //ALog.d(TAG,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +    //    String.format(&quot;isComplete; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +    //        mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +    //        mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +    return mCompleteNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +   * 所有子线程是否都已经取消</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +  public boolean isCancel() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    //ALog.d(TAG, String.format(&quot;isCancel; stopNum: %s, cancelNum: %s, failNum: %s, completeNum: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +    //    mStopNum,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +    //    mCancelNum, mFailNum, mCompleteNum));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +    return mCancelNum == mThreadNum;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +   * 更新分块任务s的真实进度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +  private long updateBlockProgress() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +    long size = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +    for (int i = 0, len = mTaskRecord.threadRecords.size(); i &lt; len; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +      File temp = new File(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +      if (temp.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +        size += temp.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +    return size;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +  /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +   * 合并文件</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +   *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +   * @return {@code true} 合并成功，{@code false}合并失败</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +  private boolean mergeFile() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 202 +    List&lt;String&gt; partPath = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 203 +    for (int i = 0, len = mTaskRecord.threadNum; i &lt; len; i++) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +      partPath.add(String.format(RecordHandler.SUB_PATH, mTaskRecord.filePath, i));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +    boolean isSuccess = FileUtil.mergeFile(mTaskRecord.filePath, partPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +    if (isSuccess) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +      for (String pp : partPath) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +        File f = new File(pp);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +        if (f.exists()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +          f.delete();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +      File targetFile = new File(mTaskRecord.filePath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +      if (targetFile.exists() &amp;&amp; targetFile.length() &gt; mTaskRecord.fileLength) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +        ALog.e(TAG, String.format(&quot;任务【%s】分块文件合并失败，下载长度超出文件真实长度，downloadLen: %s，fileSize: %s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            targetFile.getName(), targetFile.length(), mTaskRecord.fileLength));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +      }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +      return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +    } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +      ALog.e(TAG, &quot;合并失败&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +      return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            