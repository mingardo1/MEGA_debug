<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>113</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    113
                    <a href="112.html">prev</a>
                    <a href="114.html">next</a>
                    <a href="113_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_0a9ff96569b9adb2db37b43aa22a3dce5d85d677_common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;0a9ff96569b9adb2db37b43aa22a3dce5d85d677:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;0a9ff96569b9adb2db37b43aa22a3dce5d85d677^1:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;0a9ff96569b9adb2db37b43aa22a3dce5d85d677^2:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;663624d07914531cc9dcf0b72abc3508805a327e:common/src/main/java/org/broadleafcommerce/common/i18n/service/TranslationServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import org.apache.commons.lang3.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.cache.StatisticsService;
  24 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25 import org.broadleafcommerce.common.extension.ItemStatus;
  26 import org.broadleafcommerce.common.extension.ResultType;
  27 import org.broadleafcommerce.common.extension.StandardCacheItem;
  28 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30 import org.broadleafcommerce.common.i18n.domain.Translation;
  31 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32 import org.broadleafcommerce.common.locale.service.LocaleService;
  33 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.springframework.beans.factory.annotation.Value;
  37 import org.springframework.stereotype.Service;
  38 import org.springframework.transaction.annotation.Transactional;
  39 
  40 import java.util.ArrayList;
  41 import java.util.List;
  42 import java.util.Locale;
  43 import java.util.Map;
  44 import java.util.Map.Entry;
  45 
  46 import javax.annotation.Resource;
  47 import javax.cache.Cache;
  48 import javax.cache.CacheManager;
  49 
  50 @Service(&quot;blTranslationService&quot;)
  51 public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  52 
  53     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  54 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     private static final Translation DELETED_TRANSLATION = new TranslationImpl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57     </span>
  58 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private static final Translation DELETED_TRANSLATION = new TranslationImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     </span>
  62 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
  64 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  65     @Resource(name = &quot;blTranslationDao&quot;)
  66     protected TranslationDao dao;
  67 
  68     @Resource(name=&quot;blStatisticsService&quot;)
  69     protected StatisticsService statisticsService;
  70 
  71     @Resource(name=&quot;blSandBoxHelper&quot;)
  72     protected SandBoxHelper sandBoxHelper;
  73     
  74     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  75     protected TranslationServiceExtensionManager extensionManager;
  76 
  77     /**
  78      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  79      */
  80     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  81     protected int thresholdForFullCache;
  82 
  83     /**
  84      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  85      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  86      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  86      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  87      */
  88     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  89     protected int templateThresholdForFullCache;
  90 
  91     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  92     protected boolean returnBlankTranslationForNotDefaultLocale;
  93 
  94     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  95     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  96 
  97     @Resource(name = &quot;blLocaleService&quot;)
  98     protected LocaleService localeService;
  99 
 100     @Resource
 101     protected List&lt;TranslationOverrideStrategy&gt; strategies;
 102     
 103     @Resource(name = &quot;blCacheManager&quot;)
 104     protected CacheManager cacheManager;
 105     
 106     protected Cache&lt;String, Object&gt; cache;
 107     
 108     @Override
 109     @Transactional(&quot;blTransactionManager&quot;)
 110     public Translation save(Translation translation) {
 111         return dao.save(translation);
 112     }
 113     
 114     @Override
 115     @Transactional(&quot;blTransactionManager&quot;)
 116     public Translation save(String entityType, String entityId, String fieldName, String localeCode, 
 117             String translatedValue) {
 118         TranslatedEntity te = getAssignableEntityType(entityType);
 119         
 120         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 121         
 122         if (translation == null) {
 123             translation = dao.create();
 124             translation.setEntityType(te);
 125             translation.setEntityId(entityId);
 126             translation.setFieldName(fieldName);
 127             translation.setLocaleCode(localeCode);
 128         }
 129         
 130         translation.setTranslatedValue(translatedValue);
 131         return save(translation);
 132     }
 133 
 134     @Override
 135     public Translation findTranslationById(Long id) {
 136         return dao.readTranslationById(id);
 137     }
 138     
 139     @Override
 140     @Transactional(&quot;blTransactionManager&quot;)
 141     public Translation update(Long translationId, String localeCode, String translatedValue) {
 142         Translation t = dao.readTranslationById(translationId);
 143         
<abbr title=" 144         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 144         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 145         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 145         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 146         if (t2 != null &amp;&amp; t != t2) {
 147             dao.delete(t2);
 148         }
 149         
 150         t.setLocaleCode(localeCode);
 151         t.setTranslatedValue(translatedValue);
 152         return save(t);
 153     }
 154     
 155     @Override
 156     @Transactional(&quot;blTransactionManager&quot;)
 157     public void deleteTranslationById(Long translationId) {
 158         Translation t = dao.readTranslationById(translationId);
 159         dao.delete(t);
 160     }
 161     
 162     @Override
<abbr title=" 163     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 163     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 164         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 165     }
 166     
 167     @Override
<abbr title=" 168     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 168     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 169         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 170         return dao.readTranslations(entityType, entityId, property);
 171     }
 172 
 173     @Override
 174     public Cache&lt;String, Object&gt; getCache() {
 175         if (cache == null) {
 176             synchronized (this) {
 177                 if (cache == null) {
 178                     cache = cacheManager.getCache(getCacheName());
 179                 }
 180             }
 181         }
 182         return cache;
 183     }
 184 
 185     protected String getCacheName() {
 186         return TRANSLATION_CACHE_NAME;
 187     }
 188 
 189     @Override
 190     public String getTranslatedValue(Object entity, String property, Locale locale) {
 191         String localeCode = locale.getLanguage();
 192         String localeCountryCode = localeCode;
 193         if (StringUtils.isNotBlank(locale.getCountry())) {
 194             localeCountryCode += &quot;_&quot; + locale.getCountry();
 195         }
 196 
 197         if (!shouldTranslateLocale(localeCountryCode)) {
 198             return null;
 199         }
 200 
 201         TranslatedEntity entityType = getEntityType(entity);
 202         String entityId = dao.getEntityId(entityType, entity);
 203         
 204         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 205             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 205             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 206             if (translation != null) {
 207                 return translation.getTranslatedValue();
 208             } else {
 209                 // There is no translation for this entity if it is not in the cache
 210                 return null;
 211             }
 212         }
 213         
 214         boolean isValidForCache = false;
 215         if (extensionManager != null) {
 216             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 217             response.setResult(false);
 218             extensionManager.getProxy().isValidState(response);
 219             isValidForCache = response.getResult();
 220         }
<abbr title=" 221         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {"> 221         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCacðŸ”µ</abbr>
<abbr title=" 222             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 222             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 223                     ResultType.CATALOG_ONLY);
 224             if (translation != null) {
 225                 return translation.getTranslatedValue();
 226             } else {
 227                 return null;
 228             }
 229         }
 230 
 231         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 232     }
 233 
 234     /**
 235      * Whether translations should be gathered for the provided locale.
 236      *
 237      * @param localeCode
 238      * @return Whether translations should be gathered for the provided locale.
 239      */
 240     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 241         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 241         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 242 
 243         if (locale == null) {
 244             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);
 245             return true;
 246         }
 247 
 248         return !locale.getDefaultFlag();
 249     }
 250 
 251     @Override
 252     public void removeTranslationFromCache(Translation translation) {
 253         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 254             ResultType resultType = ResultType.STANDARD;
 255             if (extensionManager != null) {
 256                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 257                 extensionManager.getProxy().getResultType(translation, response);
 258                 resultType = response.getResult();
 259                 if (ResultType.STANDARD == resultType) {
 260                     String key = getCacheKey(resultType, translation.getEntityType());
 261                     LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 262                     getCache().remove(key);
 263                 } else {
 264                     List&lt;String&gt; cacheKeysList =
<abbr title=" 265                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 265                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType())ðŸ”µ</abbr>
 266                     for (String key: cacheKeysList) {
 267                         LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 268                         getCache().remove(key);
 269                     }
 270                 }
 271             }
 272         }
 273     }
 274 
 275     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 276                                                 String entityId, String localeCode, String localeCountryCode) {"> 276                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 277         boolean specificTranslationDeleted = false;
 278         boolean generalTranslationDeleted = false;
 279         StandardCacheItem specificTranslation = null;
 280         StandardCacheItem generalTranslation = null;
 281         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 282         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 283         String response = null;
 284         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 285         LocalePair override = null;
 286         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 287             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 287             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 288             if(override != null) {
 289                 specificTranslation = override.getSpecificItem();
 290                 generalTranslation = override.getGeneralItem();
 291                 break;
 292             }
 293         }
 294         if (override == null) {
<abbr title=" 295             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 295             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 296         }
 297 
 298         if (specificTranslation != null) {
 299             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 300                 specificTranslationDeleted = true;
 301             } else {
 302                 if (specificTranslation.getCacheItem() instanceof Translation) {
 303                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 304                 } else {
 305                     response = (String) specificTranslation.getCacheItem();
 306                 }
 307                 return replaceEmptyWithNullResponse(response);
 308             }
 309         }
 310 
 311         if (generalTranslation != null) {
 312             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 313                 generalTranslationDeleted = true;
 314                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 315                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 315                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 316                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 317                     return null;
 318                 }
 319             } else {
 320                 if (generalTranslation.getCacheItem() instanceof Translation) {
 321                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 322                 } else {
 323                     response = (String) generalTranslation.getCacheItem();
 324                 }
 325                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 326                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 326                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 327                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 328                     return replaceEmptyWithNullResponse(response);
 329                 }
 330                 //We have a valid general override - don&#x27;t check for general template value
 331                 generalTranslationDeleted = true;
 332             }
 333         }
 334 
 335         // Check for a Template Match
 336         if (specificTranslationDeleted) {
<abbr title=" 337             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 337             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 338             specificPropertyKey = generalPropertyKey;
 339         } else if (generalTranslationDeleted) {
<abbr title=" 340             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 340             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 341             generalPropertyKey = specificPropertyKey;
 342         }
 343 
<abbr title=" 344         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 344         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 345                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 346         if (templateResponse != null) {
 347             response = templateResponse;
 348         }
 349         return response;
 350     }
 351 
 352     protected String replaceEmptyWithNullResponse(String response) {
 353         if (!StringUtils.isEmpty(response)) {
 354             return response;
 355         }
 356         return null;
 357     }
 358 
<abbr title=" 359     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 359     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 360                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 360                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 361         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 362         StandardCacheItem translation = null;
 363         LocalePair override = null;
 364         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 365             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 365             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 366             if(override != null) {
 367                 translation = override.getSpecificItem();
 368                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 369                     return null;
 370                 }
 371                 break;
 372             }
 373         }
 374         if (override == null) {
<abbr title=" 375             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 375             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 376         }
<abbr title=" 377         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 377         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 378     }
 379 
 380     @Override
 381     public StandardCacheItem lookupTranslationFromMap(String key,
 382             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 383 
 384         StandardCacheItem cacheItem = null;
 385         if (propertyTranslationMap.containsKey(key)) {
 386             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 387             cacheItem = byEntity.get(entityId);
 388         }
 389         return cacheItem;
 390     }
 391 
 392     @Override
<abbr title=" 393     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 393     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 394         Translation translation = null;
 395         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 396             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 397             translation = byEntity.get(entityId);
 398         }
 399         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 400             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 401             translation = byEntity.get(entityId);
 402         }
 403         return translation;
 404     }
 405     
 406     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 407         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 408             try {
 409                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 410                 if (clazz.isAssignableFrom(entityClass)) {
 411                     return entry.getValue();
 412                 }
 413             } catch (ClassNotFoundException e) {
<abbr title=" 414                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 414                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 415             }
 416         }
 417         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 418     }
 419     
 420     protected TranslatedEntity getEntityType(Object entity) {
 421         return getEntityType(entity.getClass());
 422     }
 423     
 424     @Override
 425     public TranslatedEntity getAssignableEntityType(String className) {
 426         try {
 427             Class&lt;?&gt; clazz = Class.forName(className);
 428             return getEntityType(clazz);
 429         } catch (ClassNotFoundException e) {
 430             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 431         }
 432     }
 433 
 434     @Override
 435     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 436         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 437         if (extensionManager != null) {
 438             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 439             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 440             if (result.getResult() != null) {
 441                 cacheKey = result.getResult();
 442             }
 443         }
 444         return cacheKey;
 445     }
 446 
 447     @Override
 448     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 449         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 450         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 451         if (extensionManager != null) {
 452             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 453             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 454             if (result.getResult() != null) {
 455                 cacheKeyList = result.getResult();
 456             }
 457         }
 458         return cacheKeyList;
 459     }
 460 
 461     @Override
 462     public int getThresholdForFullCache() {
 463         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 464             return thresholdForFullCache;
 465         } else {
 466             // don&#x27;t cache when not in a SandBox
 467             return -1;
 468         }
 469     }
 470 
 471     @Override
 472     public void setThresholdForFullCache(int thresholdForFullCache) {
 473         this.thresholdForFullCache = thresholdForFullCache;
 474     }
 475 
 476     @Override
 477     public int getTemplateThresholdForFullCache() {
 478         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 479             return templateThresholdForFullCache;
 480         } else {
 481             // don&#x27;t cache when not in a SandBox
 482             return -1;
 483         }
 484     }
 485 
 486     @Override
 487     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 488         this.templateThresholdForFullCache = templateThresholdForFullCache;
 489     }
 490 
 491     @Override
 492     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 493             String requestedDefaultValue) {
 494 
 495         if (returnBlankTranslationForNotDefaultLocale
 496                 &amp;&amp; !localeMatchesDefaultLocale(locale)
 497                 &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 498             return &quot;&quot;;
 499         }
 500 
 501         return requestedDefaultValue;
 502     }
 503 
 504     @Override
<abbr title=" 505     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 505     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 506         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 507     }
 508 
 509     /**
 510      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 511      * 
 512      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 513      * property matches one of the regularExpressions in that list.
 514      * 
 515      * Implementors are expected to override this method for implementation specific needs. 
 516      * 
 517      * @param entity
 518      * @param property
 519      * @return
 520      */
 521     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 522         TranslatedEntity entityType = getEntityType(entity);
 523         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 524             for (String exceptionProperty : translationExceptionProperties) {
 525                 if (property.matches(exceptionProperty)) {
 526                     return true;
 527                 }
 528             }
 529         }
 530         return false;
 531     }
 532 
 533     /**
 534      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 535      * @param locale
 536      * @return
 537      */
 538     protected boolean localeMatchesDefaultLocale(Locale locale) {
 539         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 540 
 541         if (defaultLanguage != null &amp;&amp; locale != null) {
 542             return defaultLanguage.equals(locale.getLanguage());
 543         }
 544         return false;
 545     }
 546 
 547 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import org.apache.commons.lang3.StringUtils;
  21 import org.apache.commons.logging.Log;
  22 import org.apache.commons.logging.LogFactory;
  23 import org.broadleafcommerce.common.cache.StatisticsService;
  24 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25 import org.broadleafcommerce.common.extension.ItemStatus;
  26 import org.broadleafcommerce.common.extension.ResultType;
  27 import org.broadleafcommerce.common.extension.StandardCacheItem;
  28 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30 import org.broadleafcommerce.common.i18n.domain.Translation;
  31 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32 import org.broadleafcommerce.common.locale.service.LocaleService;
  33 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36 import org.springframework.beans.factory.annotation.Value;
  37 import org.springframework.stereotype.Service;
  38 import org.springframework.transaction.annotation.Transactional;
  39 
  40 import java.util.ArrayList;
  41 import java.util.List;
  42 import java.util.Locale;
  43 import java.util.Map;
  44 import java.util.Map.Entry;
  45 
  46 import javax.annotation.Resource;
  47 import javax.cache.Cache;
  48 import javax.cache.CacheManager;
  49 
  50 @Service(&quot;blTranslationService&quot;)
  51 public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  52 
  53     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  54     private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;
  55 
  56     @Resource(name = &quot;blTranslationDao&quot;)
  57     protected TranslationDao dao;
  58 
  59     @Resource(name=&quot;blStatisticsService&quot;)
  60     protected StatisticsService statisticsService;
  61 
  62     @Resource(name=&quot;blSandBoxHelper&quot;)
  63     protected SandBoxHelper sandBoxHelper;
  64 
  65     protected Cache&lt;String, Object&gt; cache;
  66 
  67     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  68     protected TranslationServiceExtensionManager extensionManager;
  69 
  70     /**
  71      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  72      */
  73     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  74     protected int thresholdForFullCache;
  75 
  76     /**
  77      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  78      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  79      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  79      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  80      */
  81     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  82     protected int templateThresholdForFullCache;
  83 
  84     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  85     protected boolean returnBlankTranslationForNotDefaultLocale;
  86 
  87     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  88     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  89 
  90     @Resource(name = &quot;blLocaleService&quot;)
  91     protected LocaleService localeService;
  92 
  93     @Resource
  94     protected List&lt;TranslationOverrideStrategy&gt; strategies;
  95 
  96     @Resource(name = &quot;blCacheManager&quot;)
  97     protected CacheManager cacheManager;
  98 
  99     @Override
 100     @Transactional(&quot;blTransactionManager&quot;)
 101     public Translation save(Translation translation) {
 102         return dao.save(translation);
 103     }
 104 
 105     @Override
 106     @Transactional(&quot;blTransactionManager&quot;)
 107     public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 108             String translatedValue) {
 109         TranslatedEntity te = getAssignableEntityType(entityType);
 110 
 111         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 112 
 113         if (translation == null) {
 114             translation = dao.create();
 115             translation.setEntityType(te);
 116             translation.setEntityId(entityId);
 117             translation.setFieldName(fieldName);
 118             translation.setLocaleCode(localeCode);
 119         }
 120 
 121         translation.setTranslatedValue(translatedValue);
 122         return save(translation);
 123     }
 124 
 125     @Override
 126     public Translation findTranslationById(Long id) {
 127         return dao.readTranslationById(id);
 128     }
 129 
 130     @Override
 131     @Transactional(&quot;blTransactionManager&quot;)
 132     public Translation update(Long translationId, String localeCode, String translatedValue) {
 133         Translation t = dao.readTranslationById(translationId);
 134 
<abbr title=" 135         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 135         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 136         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 136         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 137         if (t2 != null &amp;&amp; t != t2) {
 138             dao.delete(t2);
 139         }
 140 
 141         t.setLocaleCode(localeCode);
 142         t.setTranslatedValue(translatedValue);
 143         return save(t);
 144     }
 145 
 146     @Override
 147     @Transactional(&quot;blTransactionManager&quot;)
 148     public void deleteTranslationById(Long translationId) {
 149         Translation t = dao.readTranslationById(translationId);
 150         dao.delete(t);
 151     }
 152 
 153     @Override
<abbr title=" 154     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 154     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 155         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 156     }
 157 
 158     @Override
<abbr title=" 159     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 159     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 160         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 161         return dao.readTranslations(entityType, entityId, property);
 162     }
 163 
 164     @Override
 165     public Cache&lt;String, Object&gt; getCache() {
 166         if (cache == null) {
 167             synchronized (this) {
 168                 if (cache == null) {
 169                     cache = cacheManager.getCache(getCacheName());
 170                 }
 171             }
 172         }
 173         return cache;
 174     }
 175 
 176     protected String getCacheName() {
 177         return TRANSLATION_CACHE_NAME;
 178     }
 179 
 180     @Override
 181     public String getTranslatedValue(Object entity, String property, Locale locale) {
 182         String localeCode = locale.getLanguage();
 183         String localeCountryCode = localeCode;
 184         if (StringUtils.isNotBlank(locale.getCountry())) {
 185             localeCountryCode += &quot;_&quot; + locale.getCountry();
 186         }
 187 
 188         if (!shouldTranslateLocale(localeCountryCode)) {
 189             return null;
 190         }
 191 
 192         TranslatedEntity entityType = getEntityType(entity);
 193         String entityId = dao.getEntityId(entityType, entity);
 194 
 195         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 196             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 196             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 197             if (translation != null) {
 198                 return translation.getTranslatedValue();
 199             } else {
 200                 // There is no translation for this entity if it is not in the cache
 201                 return null;
 202             }
 203         }
 204 
 205         boolean isValidForCache = false;
 206         if (extensionManager != null) {
 207             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 208             response.setResult(false);
 209             extensionManager.getProxy().isValidState(response);
 210             isValidForCache = response.getResult();
 211         }
<abbr title=" 212         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {"> 212         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCacðŸ”µ</abbr>
<abbr title=" 213             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 213             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 214                     ResultType.CATALOG_ONLY);
 215             if (translation != null) {
 216                 return translation.getTranslatedValue();
 217             } else {
 218                 return null;
 219             }
 220         }
 221 
 222         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 223     }
 224 
 225     /**
 226      * Whether translations should be gathered for the provided locale.
 227      *
 228      * @param localeCode
 229      * @return Whether translations should be gathered for the provided locale.
 230      */
 231     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 232         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 232         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 233 
 234         if (locale == null) {
 235             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);
 236             return true;
 237         }
 238 
 239         return !locale.getDefaultFlag();
 240     }
 241 
 242     @Override
 243     public void removeTranslationFromCache(Translation translation) {
 244         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 245             ResultType resultType = ResultType.STANDARD;
 246             if (extensionManager != null) {
 247                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 248                 extensionManager.getProxy().getResultType(translation, response);
 249                 resultType = response.getResult();
 250                 if (ResultType.STANDARD == resultType) {
 251                     String key = getCacheKey(resultType, translation.getEntityType());
 252                     LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 253                     getCache().remove(key);
 254                 } else {
 255                     List&lt;String&gt; cacheKeysList =
<abbr title=" 256                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 256                             getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType())ðŸ”µ</abbr>
 257                     for (String key: cacheKeysList) {
 258                         LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 259                         getCache().remove(key);
 260                     }
 261                 }
 262             }
 263         }
 264     }
 265 
 266     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 267                                                 String entityId, String localeCode, String localeCountryCode) {"> 267                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 268         boolean specificTranslationDeleted = false;
 269         boolean generalTranslationDeleted = false;
 270         StandardCacheItem specificTranslation = null;
 271         StandardCacheItem generalTranslation = null;
 272         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 273         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 274         String response = null;
 275         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 276         LocalePair override = null;
 277         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 278             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 278             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 279             if(override != null) {
 280                 specificTranslation = override.getSpecificItem();
 281                 generalTranslation = override.getGeneralItem();
 282                 break;
 283             }
 284         }
 285         if (override == null) {
<abbr title=" 286             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 286             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 287         }
 288 
 289         if (specificTranslation != null) {
 290             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 291                 specificTranslationDeleted = true;
 292             } else {
 293                 if (specificTranslation.getCacheItem() instanceof Translation) {
 294                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 295                 } else {
 296                     response = (String) specificTranslation.getCacheItem();
 297                 }
 298                 return replaceEmptyWithNullResponse(response);
 299             }
 300         }
 301 
 302         if (generalTranslation != null) {
 303             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 304                 generalTranslationDeleted = true;
 305                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 306                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 306                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 307                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 308                     return null;
 309                 }
 310             } else {
 311                 if (generalTranslation.getCacheItem() instanceof Translation) {
 312                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 313                 } else {
 314                     response = (String) generalTranslation.getCacheItem();
 315                 }
 316                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 317                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 317                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 318                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 319                     return replaceEmptyWithNullResponse(response);
 320                 }
 321                 //We have a valid general override - don&#x27;t check for general template value
 322                 generalTranslationDeleted = true;
 323             }
 324         }
 325 
 326         // Check for a Template Match
 327         if (specificTranslationDeleted) {
<abbr title=" 328             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 328             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 329             specificPropertyKey = generalPropertyKey;
 330         } else if (generalTranslationDeleted) {
<abbr title=" 331             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 331             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 332             generalPropertyKey = specificPropertyKey;
 333         }
 334 
<abbr title=" 335         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 335         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 336                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 337         if (templateResponse != null) {
 338             response = templateResponse;
 339         }
 340         return response;
 341     }
 342 
 343     protected String replaceEmptyWithNullResponse(String response) {
 344         if (!StringUtils.isEmpty(response)) {
 345             return response;
 346         }
 347         return null;
 348     }
 349 
<abbr title=" 350     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 350     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 351                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 351                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 352         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 353         StandardCacheItem translation = null;
 354         LocalePair override = null;
 355         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 356             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 356             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 357             if(override != null) {
 358                 translation = override.getSpecificItem();
 359                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 360                     return null;
 361                 }
 362                 break;
 363             }
 364         }
 365         if (override == null) {
<abbr title=" 366             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 366             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 367         }
<abbr title=" 368         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 368         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 369     }
 370 
 371     @Override
 372     public StandardCacheItem lookupTranslationFromMap(String key,
 373             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 374 
 375         StandardCacheItem cacheItem = null;
 376         if (propertyTranslationMap.containsKey(key)) {
 377             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 378             cacheItem = byEntity.get(entityId);
 379         }
 380         return cacheItem;
 381     }
 382 
 383     @Override
<abbr title=" 384     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 384     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 385         Translation translation = null;
 386         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 387             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 388             translation = byEntity.get(entityId);
 389         }
 390         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 391             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 392             translation = byEntity.get(entityId);
 393         }
 394         return translation;
 395     }
 396 
 397     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 398         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 399             try {
 400                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 401                 if (clazz.isAssignableFrom(entityClass)) {
 402                     return entry.getValue();
 403                 }
 404             } catch (ClassNotFoundException e) {
<abbr title=" 405                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 405                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 406             }
 407         }
 408         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 409     }
 410 
 411     protected TranslatedEntity getEntityType(Object entity) {
 412         return getEntityType(entity.getClass());
 413     }
 414 
 415     @Override
 416 public TranslatedEntity getAssignableEntityType(String className) {
 417         try {
 418             Class&lt;?&gt; clazz = Class.forName(className);
 419             return getEntityType(clazz);
 420         } catch (ClassNotFoundException e) {
 421             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 422         }
 423     }
 424 
 425     @Override
 426     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 427         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 428         if (extensionManager != null) {
 429             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 430             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 431             if (result.getResult() != null) {
 432                 cacheKey = result.getResult();
 433             }
 434         }
 435         return cacheKey;
 436     }
 437 
 438     @Override
 439     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 440         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 441         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 442         if (extensionManager != null) {
 443             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 444             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 445             if (result.getResult() != null) {
 446                 cacheKeyList = result.getResult();
 447             }
 448         }
 449         return cacheKeyList;
 450     }
 451 
 452     @Override
 453     public int getThresholdForFullCache() {
 454         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 455             return thresholdForFullCache;
 456         } else {
 457             // don&#x27;t cache when not in a SandBox
 458             return -1;
 459         }
 460     }
 461 
 462     @Override
 463     public void setThresholdForFullCache(int thresholdForFullCache) {
 464         this.thresholdForFullCache = thresholdForFullCache;
 465     }
 466 
 467     @Override
 468     public int getTemplateThresholdForFullCache() {
 469         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 470             return templateThresholdForFullCache;
 471         } else {
 472             // don&#x27;t cache when not in a SandBox
 473             return -1;
 474         }
 475     }
 476 
 477     @Override
 478     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 479         this.templateThresholdForFullCache = templateThresholdForFullCache;
 480     }
 481 
 482     @Override
 483     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 484             String requestedDefaultValue) {
 485 
 486         if (returnBlankTranslationForNotDefaultLocale
 487                 &amp;&amp; !localeMatchesDefaultLocale(locale)
 488                 &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 489             return &quot;&quot;;
 490         }
 491 
 492         return requestedDefaultValue;
 493     }
 494 
 495     @Override
<abbr title=" 496     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 496     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 497         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 498     }
 499 
 500     /**
 501      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 502      *
 503      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 504      * property matches one of the regularExpressions in that list.
 505      *
 506      * Implementors are expected to override this method for implementation specific needs.
 507      *
 508      * @param entity
 509      * @param property
 510      * @return
 511      */
 512     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 513         TranslatedEntity entityType = getEntityType(entity);
 514         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 515             for (String exceptionProperty : translationExceptionProperties) {
 516                 if (property.matches(exceptionProperty)) {
 517                     return true;
 518                 }
 519             }
 520         }
 521         return false;
 522     }
 523 
 524     /**
 525      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 526      * @param locale
 527      * @return
 528      */
 529     protected boolean localeMatchesDefaultLocale(Locale locale) {
 530         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 531 
 532         if (defaultLanguage != null &amp;&amp; locale != null) {
 533             return defaultLanguage.equals(locale.getLanguage());
 534         }
 535         return false;
 536     }
 537 
 538 }
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.i18n.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.List;
  22 import java.util.Locale;
  23 import java.util.Map.Entry;
  24 import java.util.Map;
  25 import javax.annotation.Resource;
  26 import javax.cache.Cache;
  27 import javax.cache.CacheManager;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.commons.logging.Log;
  30 import org.apache.commons.logging.LogFactory;
  31 import org.broadleafcommerce.common.cache.StatisticsService;
  32 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  33 import org.broadleafcommerce.common.extension.ItemStatus;
  34 import org.broadleafcommerce.common.extension.ResultType;
  35 import org.broadleafcommerce.common.extension.StandardCacheItem;
  36 import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  37 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  38 import org.broadleafcommerce.common.i18n.domain.Translation;
  39 import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  40 import org.broadleafcommerce.common.locale.service.LocaleService;
  41 import org.broadleafcommerce.common.locale.util.LocaleUtil;
  42 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  43 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  44 import org.springframework.beans.factory.annotation.Value;
  45 import org.springframework.stereotype.Service;
  46 import org.springframework.transaction.annotation.Transactional;
  47 
  48 
  49 @Service(&quot;blTranslationService&quot;)
  50 public class TranslationServiceImpl implements TranslationService , TranslationSupport {
  51     protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  52 
  53     @Resource(name = &quot;blTranslationDao&quot;)
  54     protected TranslationDao dao;
  55 
  56     @Resource(name=&quot;blStatisticsService&quot;)
  57     protected StatisticsService statisticsService;
  58 
  59     @Resource(name=&quot;blSandBoxHelper&quot;)
  60     protected SandBoxHelper sandBoxHelper;
  61 
  62     @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  63     protected TranslationServiceExtensionManager extensionManager;
  64 
  65     /**
  66      * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  67      */
  68     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  69     protected int thresholdForFullCache;
  70 
  71     /**
  72      * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  73      * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  74      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  74      * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholðŸ”µ</abbr>
  75      */
  76     @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  77     protected int templateThresholdForFullCache;
  78 
  79     @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  80     protected boolean returnBlankTranslationForNotDefaultLocale;
  81 
  82     @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  83     protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  84 
  85     @Resource(name = &quot;blLocaleService&quot;)
  86     protected LocaleService localeService;
  87 
  88     @Resource
  89     protected List&lt;TranslationOverrideStrategy&gt; strategies;
  90 
  91     @Resource(name = &quot;blCacheManager&quot;)
  92     protected CacheManager cacheManager;
  93 
  94     protected Cache&lt;String, Object&gt; cache;
  95 
  96     @Override
  97     @Transactional(&quot;blTransactionManager&quot;)
  98     public Translation save(Translation translation) {
  99         return dao.save(translation);
 100     }
 101 
 102     @Override
 103     @Transactional(&quot;blTransactionManager&quot;)
 104     public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 105             String translatedValue) {
 106         TranslatedEntity te = getAssignableEntityType(entityType);
 107 
 108         Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 109 
 110         if (translation == null) {
 111             translation = dao.create();
 112             translation.setEntityType(te);
 113             translation.setEntityId(entityId);
 114             translation.setFieldName(fieldName);
 115             translation.setLocaleCode(localeCode);
 116         }
 117 
 118         translation.setTranslatedValue(translatedValue);
 119         return save(translation);
 120     }
 121 
 122     @Override
 123     public Translation findTranslationById(Long id) {
 124         return dao.readTranslationById(id);
 125     }
 126 
 127     @Override
 128     @Transactional(&quot;blTransactionManager&quot;)
 129     public Translation update(Long translationId, String localeCode, String translatedValue) {
 130         Translation t = dao.readTranslationById(translationId);
 131 
<abbr title=" 132         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 132         // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it ifðŸ”µ</abbr>
<abbr title=" 133         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);"> 133         Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeðŸ”µ</abbr>
 134         if (t2 != null &amp;&amp; t != t2) {
 135             dao.delete(t2);
 136         }
 137 
 138         t.setLocaleCode(localeCode);
 139         t.setTranslatedValue(translatedValue);
 140         return save(t);
 141     }
 142 
 143     @Override
 144     @Transactional(&quot;blTransactionManager&quot;)
 145     public void deleteTranslationById(Long translationId) {
 146         Translation t = dao.readTranslationById(translationId);
 147         dao.delete(t);
 148     }
 149 
 150     @Override
<abbr title=" 151     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 151     public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String ðŸ”µ</abbr>
 152         return dao.readTranslation(entity, entityId, fieldName, localeCode);
 153     }
 154 
 155     @Override
<abbr title=" 156     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {"> 156     public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String propeðŸ”µ</abbr>
 157         TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 158         return dao.readTranslations(entityType, entityId, property);
 159     }
 160 
 161     @Override
 162     public Cache&lt;String, Object&gt; getCache() {
 163         if (cache == null) {
 164             synchronized(this) {
 165                 if (cache == null) {
 166                     cache = cacheManager.getCache(getCacheName());
 167                 }
 168             }
 169         }
 170         return cache;
 171     }
 172 
 173     protected String getCacheName() {
 174         return TRANSLATION_CACHE_NAME;
 175     }
 176 
 177     @Override
 178     public String getTranslatedValue(Object entity, String property, Locale locale) {
 179         String localeCode = locale.getLanguage();
 180         String localeCountryCode = localeCode;
 181         if (StringUtils.isNotBlank(locale.getCountry())) {
 182             localeCountryCode += &quot;_&quot; + locale.getCountry();
 183         }
 184 
 185         if (!shouldTranslateLocale(localeCountryCode)) {
 186             return null;
 187         }
 188 
 189         TranslatedEntity entityType = getEntityType(entity);
 190         String entityId = dao.getEntityId(entityType, entity);
 191 
 192         if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 193             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 193             Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, properðŸ”µ</abbr>
 194             if (translation != null) {
 195                 return translation.getTranslatedValue();
 196             } else {
 197                 // There is no translation for this entity if it is not in the cache
 198                 return null;
 199             }
 200         }
 201 
 202         boolean isValidForCache = false;
 203         if (extensionManager != null) {
 204             ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 205             response.setResult(false);
 206             extensionManager.getProxy().isValidState(response);
 207             isValidForCache = response.getResult();
 208         }
<abbr title=" 209         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {"> 209         if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCacðŸ”µ</abbr>
<abbr title=" 210             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 210             Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, locðŸ”µ</abbr>
 211                     ResultType.CATALOG_ONLY);
 212             if (translation != null) {
 213                 return translation.getTranslatedValue();
 214             } else {
 215                 return null;
 216             }
 217         }
 218 
 219         return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 220     }
 221 
 222     /**
 223      * Whether translations should be gathered for the provided locale.
 224      *
 225      * @param localeCode
 226      * @return Whether translations should be gathered for the provided locale.
 227      */
 228     protected boolean shouldTranslateLocale(String localeCode) {
<abbr title=" 229         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);"> 229         org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCðŸ”µ</abbr>
 230 
 231         if (locale == null) {
 232             LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);
 233             return true;
 234         }
 235 
 236         return !locale.getDefaultFlag();
 237     }
 238 
 239     @Override
 240     public void removeTranslationFromCache(Translation translation) {
 241         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 242             ResultType resultType = ResultType.STANDARD;
 243             if (extensionManager != null) {
 244                 ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 245                 extensionManager.getProxy().getResultType(translation, response);
 246                 resultType = response.getResult();
 247                 if (ResultType.STANDARD == resultType) {
 248                     String key = getCacheKey(resultType, translation.getEntityType());
 249                     LOG.debug((&quot;Removing key [&quot; + key) + &quot;] for STANDARD site&quot;);
 250                     getCache().remove(key);
 251                 } else {
<abbr title=" 252                     List&lt;String&gt; cacheKeysList = getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());"> 252                     List&lt;String&gt; cacheKeysList = getCacheKeyListForTemplateSite(translation.getEntityTypeðŸ”µ</abbr>
 253                     for (String key : cacheKeysList) {
 254                         LOG.debug((&quot;Removing key [&quot; + key) + &quot;] for TEMPLATE site&quot;);
 255                         getCache().remove(key);
 256                     }
 257                 }
 258             }
 259         }
 260     }
 261 
 262     protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
<abbr title=" 263                                                 String entityId, String localeCode, String localeCountryCode) {"> 263                                                 String entityId, String localeCode, String localeCountryCðŸ”µ</abbr>
 264         boolean specificTranslationDeleted = false;
 265         boolean generalTranslationDeleted = false;
 266         StandardCacheItem specificTranslation = null;
 267         StandardCacheItem generalTranslation = null;
 268         String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 269         String generalPropertyKey = property + &quot;_&quot; + localeCode;
 270         String response = null;
 271         String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 272         LocalePair override = null;
 273         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 274             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 274             override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeðŸ”µ</abbr>
 275             if(override != null) {
 276                 specificTranslation = override.getSpecificItem();
 277                 generalTranslation = override.getGeneralItem();
 278                 break;
 279             }
 280         }
 281         if (override == null) {
<abbr title=" 282             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 282             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 283         }
 284 
 285         if (specificTranslation != null) {
 286             if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 287                 specificTranslationDeleted = true;
 288             } else {
 289                 if (specificTranslation.getCacheItem() instanceof Translation) {
 290                     response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 291                 } else {
 292                     response = (String) specificTranslation.getCacheItem();
 293                 }
 294                 return replaceEmptyWithNullResponse(response);
 295             }
 296         }
 297 
 298         if (generalTranslation != null) {
 299             if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 300                 generalTranslationDeleted = true;
 301                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 302                 //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 302                 //If the general translation is override deleted and we&#x27;ve only got a general local code ðŸ”µ</abbr>
 303                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 304                     return null;
 305                 }
 306             } else {
 307                 if (generalTranslation.getCacheItem() instanceof Translation) {
 308                     response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 309                 } else {
 310                     response = (String) generalTranslation.getCacheItem();
 311                 }
 312                 //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 313                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done"> 313                 //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re ðŸ”µ</abbr>
 314                 if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 315                     return replaceEmptyWithNullResponse(response);
 316                 }
 317                 //We have a valid general override - don&#x27;t check for general template value
 318                 generalTranslationDeleted = true;
 319             }
 320         }
 321 
 322         // Check for a Template Match
 323         if (specificTranslationDeleted) {
<abbr title=" 324             // only check general properties since we explicitly deleted specific properties at standard (site) level"> 324             // only check general properties since we explicitly deleted specific properties at standard ðŸ”µ</abbr>
 325             specificPropertyKey = generalPropertyKey;
 326         } else if (generalTranslationDeleted) {
<abbr title=" 327             // only check specific properties since we explicitly deleted general properties at standard (site) level"> 327             // only check specific properties since we explicitly deleted general properties at standard ðŸ”µ</abbr>
 328             generalPropertyKey = specificPropertyKey;
 329         }
 330 
<abbr title=" 331         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,"> 331         String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, loðŸ”µ</abbr>
 332                     localeCountryCode, specificPropertyKey, generalPropertyKey);
 333         if (templateResponse != null) {
 334             response = templateResponse;
 335         }
 336         return response;
 337     }
 338 
 339     protected String replaceEmptyWithNullResponse(String response) {
 340         if (!StringUtils.isEmpty(response)) {
 341             return response;
 342         }
 343         return null;
 344     }
 345 
<abbr title=" 346     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 346     protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntitðŸ”µ</abbr>
<abbr title=" 347                         String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 347                         String entityId, String localeCode, String localeCountryCode, String specificPropðŸ”µ</abbr>
 348         String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 349         StandardCacheItem translation = null;
 350         LocalePair override = null;
 351         for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 352             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 352             override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, locðŸ”µ</abbr>
 353             if(override != null) {
 354                 translation = override.getSpecificItem();
 355                 if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 356                     return null;
 357                 }
 358                 break;
 359             }
 360         }
 361         if (override == null) {
<abbr title=" 362             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 362             throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return ðŸ”µ</abbr>
 363         }
<abbr title=" 364         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 364         return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheIteðŸ”µ</abbr>
 365     }
 366 
 367     @Override
 368     public StandardCacheItem lookupTranslationFromMap(String key,
 369             Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 370 
 371         StandardCacheItem cacheItem = null;
 372         if (propertyTranslationMap.containsKey(key)) {
 373             Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 374             cacheItem = byEntity.get(entityId);
 375         }
 376         return cacheItem;
 377     }
 378 
 379     @Override
<abbr title=" 380     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 380     public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey,ðŸ”µ</abbr>
 381         Translation translation = null;
 382         if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 383             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 384             translation = byEntity.get(entityId);
 385         }
 386         if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 387             Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 388             translation = byEntity.get(entityId);
 389         }
 390         return translation;
 391     }
 392 
 393     protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 394         for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 395             try {
 396                 Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 397                 if (clazz.isAssignableFrom(entityClass)) {
 398                     return entry.getValue();
 399                 }
 400             } catch (ClassNotFoundException e) {
<abbr title=" 401                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);"> 401                 throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, ðŸ”µ</abbr>
 402             }
 403         }
 404         throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 405     }
 406 
 407     protected TranslatedEntity getEntityType(Object entity) {
 408         return getEntityType(entity.getClass());
 409     }
 410 
 411     @Override
 412     public TranslatedEntity getAssignableEntityType(String className) {
 413         try {
 414             Class&lt;?&gt; clazz = Class.forName(className);
 415             return getEntityType(clazz);
 416         } catch (java.lang.ClassNotFoundException e) {
 417             throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 418         }
 419     }
 420 
 421     @Override
 422     public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 423         String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 424         if (extensionManager != null) {
 425             ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 426             extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 427             if (result.getResult() != null) {
 428                 cacheKey = result.getResult();
 429             }
 430         }
 431         return cacheKey;
 432     }
 433 
 434     @Override
 435     public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 436         List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 437         String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 438         if (extensionManager != null) {
 439             ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 440             extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 441             if (result.getResult() != null) {
 442                 cacheKeyList = result.getResult();
 443             }
 444         }
 445         return cacheKeyList;
 446     }
 447 
 448     @Override
 449     public int getThresholdForFullCache() {
 450         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 451             return thresholdForFullCache;
 452         } else {
 453             // don&#x27;t cache when not in a SandBox
 454             return -1;
 455         }
 456     }
 457 
 458     @Override
 459     public void setThresholdForFullCache(int thresholdForFullCache) {
 460         this.thresholdForFullCache = thresholdForFullCache;
 461     }
 462 
 463     @Override
 464     public int getTemplateThresholdForFullCache() {
 465         if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 466             return templateThresholdForFullCache;
 467         } else {
 468             // don&#x27;t cache when not in a SandBox
 469             return -1;
 470         }
 471     }
 472 
 473     @Override
 474     public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 475         this.templateThresholdForFullCache = templateThresholdForFullCache;
 476     }
 477 
 478     @Override
 479     public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 480             String requestedDefaultValue) {
 481 
 482         if (returnBlankTranslationForNotDefaultLocale
 483                 &amp;&amp; !localeMatchesDefaultLocale(locale)
 484                 &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 485             return &quot;&quot;;
 486         }
 487 
 488         return requestedDefaultValue;
 489     }
 490 
 491     @Override
<abbr title=" 492     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 492     public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType stanðŸ”µ</abbr>
 493         return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 494     }
 495 
 496     /**
 497      * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 498      *
 499      * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 500      * property matches one of the regularExpressions in that list.
 501      *
 502      * Implementors are expected to override this method for implementation specific needs.
 503      *
 504      * @param entity
 505      * @param property
 506      * @return
 507      */
 508     protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 509         TranslatedEntity entityType = getEntityType(entity);
 510         if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 511             for (String exceptionProperty : translationExceptionProperties) {
 512                 if (property.matches(exceptionProperty)) {
 513                     return true;
 514                 }
 515             }
 516         }
 517         return false;
 518     }
 519 
 520     /**
 521      * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 522      * @param locale
 523      * @return
 524      */
 525     protected boolean localeMatchesDefaultLocale(Locale locale) {
 526         String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 527 
 528         if (defaultLanguage != null &amp;&amp; locale != null) {
 529             return defaultLanguage.equals(locale.getLanguage());
 530         }
 531         return false;
 532     }
 533 }
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.i18n.service;
  19  
  20  import org.apache.commons.lang3.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.cache.StatisticsService;
  24  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25  import org.broadleafcommerce.common.extension.ItemStatus;
  26  import org.broadleafcommerce.common.extension.ResultType;
  27  import org.broadleafcommerce.common.extension.StandardCacheItem;
  28  import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30  import org.broadleafcommerce.common.i18n.domain.Translation;
  31  import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32  import org.broadleafcommerce.common.locale.service.LocaleService;
  33  import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36  import org.springframework.beans.factory.annotation.Value;
  37  import org.springframework.stereotype.Service;
  38  import org.springframework.transaction.annotation.Transactional;
  39  
  40  import java.util.ArrayList;
  41  import java.util.List;
  42  import java.util.Locale;
  43  import java.util.Map;
  44  import java.util.Map.Entry;
  45  
  46  import javax.annotation.Resource;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import net.sf.ehcache.Cache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import net.sf.ehcache.CacheManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +import javax.cache.Cache;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +import javax.cache.CacheManager;</span>
  52  
  53  @Service(&quot;blTranslationService&quot;)
  54  public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  55  
  56      protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
  57      private static final Translation DELETED_TRANSLATION = new TranslationImpl();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    private static final String TRANSLATION_CACHE_NAME = &quot;blTranslationElements&quot;;</span>
  59  
  60      @Resource(name = &quot;blTranslationDao&quot;)
  61      protected TranslationDao dao;
  62  
  63      @Resource(name=&quot;blStatisticsService&quot;)
  64      protected StatisticsService statisticsService;
  65  
  66      @Resource(name=&quot;blSandBoxHelper&quot;)
  67      protected SandBoxHelper sandBoxHelper;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    protected Cache cache;</span>
  70  
  71      @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  72      protected TranslationServiceExtensionManager extensionManager;
  73  
  74      /**
  75       * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  76       */
  77      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  78      protected int thresholdForFullCache;
  79  
  80      /**
  81       * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  82       * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  83       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  83       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCðŸ”µ</abbr>
  84       */
  85      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  86      protected int templateThresholdForFullCache;
  87  
  88      @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  89      protected boolean returnBlankTranslationForNotDefaultLocale;
  90  
  91      @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  92      protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  93  
  94      @Resource(name = &quot;blLocaleService&quot;)
  95      protected LocaleService localeService;
  96  
  97      @Resource
  98      protected List&lt;TranslationOverrideStrategy&gt; strategies;
  99  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    @Resource(name = &quot;blCacheManager&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    protected CacheManager cacheManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    protected Cache&lt;String, Object&gt; cache;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +</span>
 105      @Override
 106      @Transactional(&quot;blTransactionManager&quot;)
 107      public Translation save(Translation translation) {
 108          return dao.save(translation);
 109      }
 110  
 111      @Override
 112      @Transactional(&quot;blTransactionManager&quot;)
 113      public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 114              String translatedValue) {
 115          TranslatedEntity te = getAssignableEntityType(entityType);
 116  
 117          Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 118  
 119          if (translation == null) {
 120              translation = dao.create();
 121              translation.setEntityType(te);
 122              translation.setEntityId(entityId);
 123              translation.setFieldName(fieldName);
 124              translation.setLocaleCode(localeCode);
 125          }
 126  
 127          translation.setTranslatedValue(translatedValue);
 128          return save(translation);
 129      }
 130  
 131      @Override
 132      public Translation findTranslationById(Long id) {
 133          return dao.readTranslationById(id);
 134      }
 135  
 136      @Override
 137      @Transactional(&quot;blTransactionManager&quot;)
 138      public Translation update(Long translationId, String localeCode, String translatedValue) {
 139          Translation t = dao.readTranslationById(translationId);
 140  
<abbr title=" 141          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 141          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it existðŸ”µ</abbr>
 142          Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);
 143          if (t2 != null &amp;&amp; t != t2) {
 144              dao.delete(t2);
 145          }
 146  
 147          t.setLocaleCode(localeCode);
 148          t.setTranslatedValue(translatedValue);
 149          return save(t);
 150      }
 151  
 152      @Override
 153      @Transactional(&quot;blTransactionManager&quot;)
 154      public void deleteTranslationById(Long translationId) {
 155          Translation t = dao.readTranslationById(translationId);
 156          dao.delete(t);
 157      }
 158  
 159      @Override
<abbr title=" 160      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 160      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCodðŸ”µ</abbr>
 161          return dao.readTranslation(entity, entityId, fieldName, localeCode);
 162      }
 163  
 164      @Override
 165      public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {
 166          TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 167          return dao.readTranslations(entityType, entityId, property);
 168      }
 169  
 170      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -    public Cache getCache() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    public Cache&lt;String, Object&gt; getCache() {</span>
 173          if (cache == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -            cache = CacheManager.getInstance().getCache(&quot;blTranslationElements&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +            synchronized (this) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                if (cache == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                    cache = cacheManager.getCache(getCacheName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +            }</span>
 180          }
 181          return cache;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +    protected String getCacheName() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +        return TRANSLATION_CACHE_NAME;</span>
 186      }
 187  
 188      @Override
 189      public String getTranslatedValue(Object entity, String property, Locale locale) {
 190          String localeCode = locale.getLanguage();
 191          String localeCountryCode = localeCode;
 192          if (StringUtils.isNotBlank(locale.getCountry())) {
 193              localeCountryCode += &quot;_&quot; + locale.getCountry();
 194          }
 195  
 196          if (!shouldTranslateLocale(localeCountryCode)) {
 197              return null;
 198          }
 199  
 200          TranslatedEntity entityType = getEntityType(entity);
 201          String entityId = dao.getEntityId(entityType, entity);
 202  
 203          if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 204              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 204              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localðŸ”µ</abbr>
 205              if (translation != null) {
 206                  return translation.getTranslatedValue();
 207              } else {
 208                  // There is no translation for this entity if it is not in the cache
 209                  return null;
 210              }
 211          }
 212  
 213          boolean isValidForCache = false;
 214          if (extensionManager != null) {
 215              ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 216              response.setResult(false);
 217              extensionManager.getProxy().isValidState(response);
 218              isValidForCache = response.getResult();
 219          }
 220          if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {
<abbr title=" 221              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 221              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountrðŸ”µ</abbr>
 222                      ResultType.CATALOG_ONLY);
 223              if (translation != null) {
 224                  return translation.getTranslatedValue();
 225              } else {
 226                  return null;
 227              }
 228          }
 229  
 230          return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 231      }
 232  
 233      /**
 234       * Whether translations should be gathered for the provided locale.
 235       *
 236       * @param localeCode
 237       * @return Whether translations should be gathered for the provided locale.
 238       */
 239      protected boolean shouldTranslateLocale(String localeCode) {
 240          org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);
 241  
 242          if (locale == null) {
 243              LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);
 244              return true;
 245          }
 246  
 247          return !locale.getDefaultFlag();
 248      }
 249  
 250      @Override
 251      public void removeTranslationFromCache(Translation translation) {
 252          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 253              ResultType resultType = ResultType.STANDARD;
 254              if (extensionManager != null) {
 255                  ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 256                  extensionManager.getProxy().getResultType(translation, response);
 257                  resultType = response.getResult();
 258                  if (ResultType.STANDARD == resultType) {
 259                      String key = getCacheKey(resultType, translation.getEntityType());
 260                      LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 261                      getCache().remove(key);
 262                  } else {
 263                      List&lt;String&gt; cacheKeysList =
 264                              getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());
 265                      for (String key: cacheKeysList) {
 266                          LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 267                          getCache().remove(key);
 268                      }
 269                  }
 270              }
 271          }
 272      }
 273  
 274      protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
 275                                                  String entityId, String localeCode, String localeCountryCode) {
 276          boolean specificTranslationDeleted = false;
 277          boolean generalTranslationDeleted = false;
 278          StandardCacheItem specificTranslation = null;
 279          StandardCacheItem generalTranslation = null;
 280          String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 281          String generalPropertyKey = property + &quot;_&quot; + localeCode;
 282          String response = null;
 283          String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 284          LocalePair override = null;
 285          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 286              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 286              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCoðŸ”µ</abbr>
 287              if(override != null) {
 288                  specificTranslation = override.getSpecificItem();
 289                  generalTranslation = override.getGeneralItem();
 290                  break;
 291              }
 292          }
 293          if (override == null) {
<abbr title=" 294              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 294              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 295          }
 296  
 297          if (specificTranslation != null) {
 298              if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 299                  specificTranslationDeleted = true;
 300              } else {
 301                  if (specificTranslation.getCacheItem() instanceof Translation) {
 302                      response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 303                  } else {
 304                      response = (String) specificTranslation.getCacheItem();
 305                  }
 306                  return replaceEmptyWithNullResponse(response);
 307              }
 308          }
 309  
 310          if (generalTranslation != null) {
 311              if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 312                  generalTranslationDeleted = true;
 313                  //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 314                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 314                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re dðŸ”µ</abbr>
 315                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 316                      return null;
 317                  }
 318              } else {
 319                  if (generalTranslation.getCacheItem() instanceof Translation) {
 320                      response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 321                  } else {
 322                      response = (String) generalTranslation.getCacheItem();
 323                  }
 324                  //If the specific translation is override deleted as well, we&#x27;re done
 325                  //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done
 326                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 327                      return replaceEmptyWithNullResponse(response);
 328                  }
 329                  //We have a valid general override - don&#x27;t check for general template value
 330                  generalTranslationDeleted = true;
 331              }
 332          }
 333  
 334          // Check for a Template Match
 335          if (specificTranslationDeleted) {
<abbr title=" 336              // only check general properties since we explicitly deleted specific properties at standard (site) level"> 336              // only check general properties since we explicitly deleted specific properties at standard (site) leðŸ”µ</abbr>
 337              specificPropertyKey = generalPropertyKey;
 338          } else if (generalTranslationDeleted) {
<abbr title=" 339              // only check specific properties since we explicitly deleted general properties at standard (site) level"> 339              // only check specific properties since we explicitly deleted general properties at standard (site) leðŸ”µ</abbr>
 340              generalPropertyKey = specificPropertyKey;
 341          }
 342  
 343          String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,
 344                      localeCountryCode, specificPropertyKey, generalPropertyKey);
 345          if (templateResponse != null) {
 346              response = templateResponse;
 347          }
 348          return response;
 349      }
 350  
 351      protected String replaceEmptyWithNullResponse(String response) {
 352          if (!StringUtils.isEmpty(response)) {
 353              return response;
 354          }
 355          return null;
 356      }
 357  
<abbr title=" 358      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 358      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityTðŸ”µ</abbr>
<abbr title=" 359                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 359                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, ðŸ”µ</abbr>
 360          String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 361          StandardCacheItem translation = null;
 362          LocalePair override = null;
 363          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 364              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 364              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, ðŸ”µ</abbr>
 365              if(override != null) {
 366                  translation = override.getSpecificItem();
 367                  if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 368                      return null;
 369                  }
 370                  break;
 371              }
 372          }
 373          if (override == null) {
<abbr title=" 374              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 374              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 375          }
<abbr title=" 376          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 376          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTðŸ”µ</abbr>
 377      }
 378  
 379      @Override
 380      public StandardCacheItem lookupTranslationFromMap(String key,
 381              Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 382  
 383          StandardCacheItem cacheItem = null;
 384          if (propertyTranslationMap.containsKey(key)) {
 385              Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 386              cacheItem = byEntity.get(entityId);
 387          }
 388          return cacheItem;
 389      }
 390  
 391      @Override
<abbr title=" 392      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 392      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;StriðŸ”µ</abbr>
 393          Translation translation = null;
 394          if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 395              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 396              translation = byEntity.get(entityId);
 397          }
 398          if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 399              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 400              translation = byEntity.get(entityId);
 401          }
 402          return translation;
 403      }
 404  
 405      protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 406          for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 407              try {
 408                  Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 409                  if (clazz.isAssignableFrom(entityClass)) {
 410                      return entry.getValue();
 411                  }
 412              } catch (ClassNotFoundException e) {
 413                  throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);
 414              }
 415          }
 416          throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 417      }
 418  
 419      protected TranslatedEntity getEntityType(Object entity) {
 420          return getEntityType(entity.getClass());
 421      }
 422  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +    @Override</span>
 424      public TranslatedEntity getAssignableEntityType(String className) {
 425          try {
 426              Class&lt;?&gt; clazz = Class.forName(className);
 427              return getEntityType(clazz);
 428          } catch (ClassNotFoundException e) {
 429              throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 430          }
 431      }
 432  
 433      @Override
 434      public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 435          String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 436          if (extensionManager != null) {
 437              ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 438              extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 439              if (result.getResult() != null) {
 440                  cacheKey = result.getResult();
 441              }
 442          }
 443          return cacheKey;
 444      }
 445  
 446      @Override
 447      public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 448          List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 449          String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 450          if (extensionManager != null) {
 451              ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 452              extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 453              if (result.getResult() != null) {
 454                  cacheKeyList = result.getResult();
 455              }
 456          }
 457          return cacheKeyList;
 458      }
 459  
 460      @Override
 461      public int getThresholdForFullCache() {
 462          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 463              return thresholdForFullCache;
 464          } else {
 465              // don&#x27;t cache when not in a SandBox
 466              return -1;
 467          }
 468      }
 469  
 470      @Override
 471      public void setThresholdForFullCache(int thresholdForFullCache) {
 472          this.thresholdForFullCache = thresholdForFullCache;
 473      }
 474  
 475      @Override
 476      public int getTemplateThresholdForFullCache() {
 477          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 478              return templateThresholdForFullCache;
 479          } else {
 480              // don&#x27;t cache when not in a SandBox
 481              return -1;
 482          }
 483      }
 484  
 485      @Override
 486      public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 487          this.templateThresholdForFullCache = templateThresholdForFullCache;
 488      }
 489  
 490      @Override
 491      public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 492              String requestedDefaultValue) {
 493  
 494          if (returnBlankTranslationForNotDefaultLocale
 495                  &amp;&amp; !localeMatchesDefaultLocale(locale)
 496                  &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 497              return &quot;&quot;;
 498          }
 499  
 500          return requestedDefaultValue;
 501      }
 502  
 503      @Override
<abbr title=" 504      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 504      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, LisðŸ”µ</abbr>
 505          return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 506      }
 507  
 508      /**
 509       * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 510       *
 511       * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 512       * property matches one of the regularExpressions in that list.
 513       *
 514       * Implementors are expected to override this method for implementation specific needs.
 515       *
 516       * @param entity
 517       * @param property
 518       * @return
 519       */
 520      protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 521          TranslatedEntity entityType = getEntityType(entity);
 522          if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 523              for (String exceptionProperty : translationExceptionProperties) {
 524                  if (property.matches(exceptionProperty)) {
 525                      return true;
 526                  }
 527              }
 528          }
 529          return false;
 530      }
 531  
 532      /**
 533       * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 534       * @param locale
 535       * @return
 536       */
 537      protected boolean localeMatchesDefaultLocale(Locale locale) {
 538          String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 539  
 540          if (defaultLanguage != null &amp;&amp; locale != null) {
 541              return defaultLanguage.equals(locale.getLanguage());
 542          }
 543          return false;
 544      }
 545  
 546  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.i18n.service;
  19  
  20  import org.apache.commons.lang3.StringUtils;
  21  import org.apache.commons.logging.Log;
  22  import org.apache.commons.logging.LogFactory;
  23  import org.broadleafcommerce.common.cache.StatisticsService;
  24  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  25  import org.broadleafcommerce.common.extension.ItemStatus;
  26  import org.broadleafcommerce.common.extension.ResultType;
  27  import org.broadleafcommerce.common.extension.StandardCacheItem;
  28  import org.broadleafcommerce.common.i18n.dao.TranslationDao;
  29  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  30  import org.broadleafcommerce.common.i18n.domain.Translation;
  31  import org.broadleafcommerce.common.i18n.domain.TranslationImpl;
  32  import org.broadleafcommerce.common.locale.service.LocaleService;
  33  import org.broadleafcommerce.common.locale.util.LocaleUtil;
  34  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  35  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  36  import org.springframework.beans.factory.annotation.Value;
  37  import org.springframework.stereotype.Service;
  38  import org.springframework.transaction.annotation.Transactional;
  39  
  40  import java.util.ArrayList;
  41  import java.util.List;
  42  import java.util.Locale;
  43  import java.util.Map;
  44  import java.util.Map.Entry;
  45  
  46  import javax.annotation.Resource;
  47  
  48  import net.sf.ehcache.Cache;
  49  import net.sf.ehcache.CacheManager;


  50  
  51  @Service(&quot;blTranslationService&quot;)
  52  public class TranslationServiceImpl implements TranslationService, TranslationSupport {
  53  
  54      protected static final Log LOG = LogFactory.getLog(TranslationServiceImpl.class);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    private static final Translation DELETED_TRANSLATION = new TranslationImpl();</span>

  56  
  57      @Resource(name = &quot;blTranslationDao&quot;)
  58      protected TranslationDao dao;
  59  
  60      @Resource(name=&quot;blStatisticsService&quot;)
  61      protected StatisticsService statisticsService;
  62  
  63      @Resource(name=&quot;blSandBoxHelper&quot;)
  64      protected SandBoxHelper sandBoxHelper;
  65  
  66      protected Cache cache;
  67  
  68      @Resource(name=&quot;blTranslationServiceExtensionManager&quot;)
  69      protected TranslationServiceExtensionManager extensionManager;
  70  
  71      /**
  72       * The default is 1000. Use the &#x27;translation.thresholdForFullCache&#x27; to change the value.
  73       */
  74      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  75      protected int thresholdForFullCache;
  76  
  77      /**
  78       * The default is 1000. This property also uses &#x27;translation.thresholdForFullCache&#x27; for
  79       * backwards compatibility. If you wish to change this value, you&#x27;ll need to extend
<abbr title="  80       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCache()}">  80       * TranslationServiceImpl and return a custom value for {@link TranslationSupport#getTemplateThresholdForFullCðŸ”µ</abbr>
  81       */
  82      @Value(&quot;${translation.thresholdForFullCache:1000}&quot;)
  83      protected int templateThresholdForFullCache;
  84  
  85      @Value(&quot;${returnBlankTranslationForNotDefaultLocale:false}&quot;)
  86      protected boolean returnBlankTranslationForNotDefaultLocale;
  87  
  88      @Resource(name = &quot;blTranslationExceptionProperties&quot;)
  89      protected List&lt;String&gt; translationExceptionProperties = new ArrayList&lt;String&gt;();
  90  
  91      @Resource(name = &quot;blLocaleService&quot;)
  92      protected LocaleService localeService;
  93  
  94      @Resource
  95      protected List&lt;TranslationOverrideStrategy&gt; strategies;
  96  





  97      @Override
  98      @Transactional(&quot;blTransactionManager&quot;)
  99      public Translation save(Translation translation) {
 100          return dao.save(translation);
 101      }
 102  
 103      @Override
 104      @Transactional(&quot;blTransactionManager&quot;)
 105      public Translation save(String entityType, String entityId, String fieldName, String localeCode,
 106              String translatedValue) {
 107          TranslatedEntity te = getAssignableEntityType(entityType);
 108  
 109          Translation translation = getTranslation(te, entityId, fieldName, localeCode);
 110  
 111          if (translation == null) {
 112              translation = dao.create();
 113              translation.setEntityType(te);
 114              translation.setEntityId(entityId);
 115              translation.setFieldName(fieldName);
 116              translation.setLocaleCode(localeCode);
 117          }
 118  
 119          translation.setTranslatedValue(translatedValue);
 120          return save(translation);
 121      }
 122  
 123      @Override
 124      public Translation findTranslationById(Long id) {
 125          return dao.readTranslationById(id);
 126      }
 127  
 128      @Override
 129      @Transactional(&quot;blTransactionManager&quot;)
 130      public Translation update(Long translationId, String localeCode, String translatedValue) {
 131          Translation t = dao.readTranslationById(translationId);
 132  
<abbr title=" 133          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it exists"> 133          // Check to see if there is another translation that matches this updated one. We&#x27;ll remove it if it existðŸ”µ</abbr>
 134          Translation t2 = dao.readTranslation(t.getEntityType(), t.getEntityId(), t.getFieldName(), localeCode);
 135          if (t2 != null &amp;&amp; t != t2) {
 136              dao.delete(t2);
 137          }
 138  
 139          t.setLocaleCode(localeCode);
 140          t.setTranslatedValue(translatedValue);
 141          return save(t);
 142      }
 143  
 144      @Override
 145      @Transactional(&quot;blTransactionManager&quot;)
 146      public void deleteTranslationById(Long translationId) {
 147          Translation t = dao.readTranslationById(translationId);
 148          dao.delete(t);
 149      }
 150  
 151      @Override
<abbr title=" 152      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCode) {"> 152      public Translation getTranslation(TranslatedEntity entity, String entityId, String fieldName, String localeCodðŸ”µ</abbr>
 153          return dao.readTranslation(entity, entityId, fieldName, localeCode);
 154      }
 155  
 156      @Override
 157      public List&lt;Translation&gt; getTranslations(String ceilingEntityClassname, String entityId, String property) {
 158          TranslatedEntity entityType = getAssignableEntityType(ceilingEntityClassname);
 159          return dao.readTranslations(entityType, entityId, property);
 160      }
 161  
 162      @Override
 163      public Cache getCache() {

 164          if (cache == null) {
 165              cache = CacheManager.getInstance().getCache(&quot;blTranslationElements&quot;);





 166          }
 167          return cache;




 168      }
 169  
 170      @Override
 171      public String getTranslatedValue(Object entity, String property, Locale locale) {
 172          String localeCode = locale.getLanguage();
 173          String localeCountryCode = localeCode;
 174          if (StringUtils.isNotBlank(locale.getCountry())) {
 175              localeCountryCode += &quot;_&quot; + locale.getCountry();
 176          }
 177  
 178          if (!shouldTranslateLocale(localeCountryCode)) {
 179              return null;
 180          }
 181  
 182          TranslatedEntity entityType = getEntityType(entity);
 183          String entityId = dao.getEntityId(entityType, entity);
 184  
 185          if (TranslationBatchReadCache.hasCache()) {
<abbr title=" 186              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localeCountryCode);"> 186              Translation translation = TranslationBatchReadCache.getFromCache(entityType, entityId, property, localðŸ”µ</abbr>
 187              if (translation != null) {
 188                  return translation.getTranslatedValue();
 189              } else {
 190                  // There is no translation for this entity if it is not in the cache
 191                  return null;
 192              }
 193          }
 194  
 195          boolean isValidForCache = false;
 196          if (extensionManager != null) {
 197              ExtensionResultHolder&lt;Boolean&gt; response = new ExtensionResultHolder&lt;Boolean&gt;();
 198              response.setResult(false);
 199              extensionManager.getProxy().isValidState(response);
 200              isValidForCache = response.getResult();
 201          }
 202          if (!BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox() || !isValidForCache) {
<abbr title=" 203              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountryCode,"> 203              Translation translation = dao.readTranslation(entityType, entityId, property, localeCode, localeCountrðŸ”µ</abbr>
 204                      ResultType.CATALOG_ONLY);
 205              if (translation != null) {
 206                  return translation.getTranslatedValue();
 207              } else {
 208                  return null;
 209              }
 210          }
 211  
 212          return getOverrideTranslatedValue(property, entityType, entityId, localeCode, localeCountryCode);
 213      }
 214  
 215      /**
 216       * Whether translations should be gathered for the provided locale.
 217       *
 218       * @param localeCode
 219       * @return Whether translations should be gathered for the provided locale.
 220       */
 221      protected boolean shouldTranslateLocale(String localeCode) {
 222          org.broadleafcommerce.common.locale.domain.Locale locale = localeService.findLocaleByCode(localeCode);
 223  
 224          if (locale == null) {
 225              LOG.warn(&quot;A locale could not be found for the provided localeCode: &quot;+ localeCode);
 226              return true;
 227          }
 228  
 229          return !locale.getDefaultFlag();
 230      }
 231  
 232      @Override
 233      public void removeTranslationFromCache(Translation translation) {
 234          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 235              ResultType resultType = ResultType.STANDARD;
 236              if (extensionManager != null) {
 237                  ExtensionResultHolder&lt;ResultType&gt; response = new ExtensionResultHolder&lt;ResultType&gt;();
 238                  extensionManager.getProxy().getResultType(translation, response);
 239                  resultType = response.getResult();
 240                  if (ResultType.STANDARD == resultType) {
 241                      String key = getCacheKey(resultType, translation.getEntityType());
 242                      LOG.debug(&quot;Removing key [&quot; + key + &quot;] for STANDARD site&quot;);
 243                      getCache().remove(key);
 244                  } else {
 245                      List&lt;String&gt; cacheKeysList =
 246                              getCacheKeyListForTemplateSite(translation.getEntityType().getFriendlyType());
 247                      for (String key: cacheKeysList) {
 248                          LOG.debug(&quot;Removing key [&quot; + key + &quot;] for TEMPLATE site&quot;);
 249                          getCache().remove(key);
 250                      }
 251                  }
 252              }
 253          }
 254      }
 255  
 256      protected String getOverrideTranslatedValue(String property, TranslatedEntity entityType,
 257                                                  String entityId, String localeCode, String localeCountryCode) {
 258          boolean specificTranslationDeleted = false;
 259          boolean generalTranslationDeleted = false;
 260          StandardCacheItem specificTranslation = null;
 261          StandardCacheItem generalTranslation = null;
 262          String specificPropertyKey = property + &quot;_&quot; + localeCountryCode;
 263          String generalPropertyKey = property + &quot;_&quot; + localeCode;
 264          String response = null;
 265          String cacheKey = getCacheKey(ResultType.STANDARD, entityType);
 266          LocalePair override = null;
 267          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 268              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCode, cacheKey);"> 268              override = strategy.getLocaleBasedOverride(property, entityType, entityId, localeCode, localeCountryCoðŸ”µ</abbr>
 269              if(override != null) {
 270                  specificTranslation = override.getSpecificItem();
 271                  generalTranslation = override.getGeneralItem();
 272                  break;
 273              }
 274          }
 275          if (override == null) {
<abbr title=" 276              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 276              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 277          }
 278  
 279          if (specificTranslation != null) {
 280              if (ItemStatus.DELETED.equals(specificTranslation.getItemStatus())) {
 281                  specificTranslationDeleted = true;
 282              } else {
 283                  if (specificTranslation.getCacheItem() instanceof Translation) {
 284                      response = ((Translation) specificTranslation.getCacheItem()).getTranslatedValue();
 285                  } else {
 286                      response = (String) specificTranslation.getCacheItem();
 287                  }
 288                  return replaceEmptyWithNullResponse(response);
 289              }
 290          }
 291  
 292          if (generalTranslation != null) {
 293              if (ItemStatus.DELETED.equals(generalTranslation.getItemStatus())) {
 294                  generalTranslationDeleted = true;
 295                  //If the specific translation is override deleted as well, we&#x27;re done
<abbr title=" 296                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re done"> 296                  //If the general translation is override deleted and we&#x27;ve only got a general local code - we&#x27;re dðŸ”µ</abbr>
 297                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 298                      return null;
 299                  }
 300              } else {
 301                  if (generalTranslation.getCacheItem() instanceof Translation) {
 302                      response = ((Translation) generalTranslation.getCacheItem()).getTranslatedValue();
 303                  } else {
 304                      response = (String) generalTranslation.getCacheItem();
 305                  }
 306                  //If the specific translation is override deleted as well, we&#x27;re done
 307                  //If the general translation is override and we&#x27;ve only got a general local code - we&#x27;re done
 308                  if (specificTranslationDeleted || !localeCountryCode.contains(&quot;_&quot;)) {
 309                      return replaceEmptyWithNullResponse(response);
 310                  }
 311                  //We have a valid general override - don&#x27;t check for general template value
 312                  generalTranslationDeleted = true;
 313              }
 314          }
 315  
 316          // Check for a Template Match
 317          if (specificTranslationDeleted) {
<abbr title=" 318              // only check general properties since we explicitly deleted specific properties at standard (site) level"> 318              // only check general properties since we explicitly deleted specific properties at standard (site) leðŸ”µ</abbr>
 319              specificPropertyKey = generalPropertyKey;
 320          } else if (generalTranslationDeleted) {
<abbr title=" 321              // only check specific properties since we explicitly deleted general properties at standard (site) level"> 321              // only check specific properties since we explicitly deleted general properties at standard (site) leðŸ”µ</abbr>
 322              generalPropertyKey = specificPropertyKey;
 323          }
 324  
 325          String templateResponse = getTemplateTranslatedValue(cacheKey, property, entityType, entityId, localeCode,
 326                      localeCountryCode, specificPropertyKey, generalPropertyKey);
 327          if (templateResponse != null) {
 328              response = templateResponse;
 329          }
 330          return response;
 331      }
 332  
 333      protected String replaceEmptyWithNullResponse(String response) {
 334          if (!StringUtils.isEmpty(response)) {
 335              return response;
 336          }
 337          return null;
 338      }
 339  
<abbr title=" 340      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityType,"> 340      protected String getTemplateTranslatedValue(String standardCacheKey, String property, TranslatedEntity entityTðŸ”µ</abbr>
<abbr title=" 341                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, String generalPropertyKey) {"> 341                          String entityId, String localeCode, String localeCountryCode, String specificPropertyKey, ðŸ”µ</abbr>
 342          String cacheKey = getCacheKey(ResultType.TEMPLATE, entityType);
 343          StandardCacheItem translation = null;
 344          LocalePair override = null;
 345          for (TranslationOverrideStrategy strategy : strategies) {
<abbr title=" 346              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, localeCountryCode, specificPropertyKey, generalPropertyKey);"> 346              override = strategy.getLocaleBasedTemplateValue(cacheKey, property, entityType, entityId, localeCode, ðŸ”µ</abbr>
 347              if(override != null) {
 348                  translation = override.getSpecificItem();
 349                  if (!strategy.validateTemplateProcessing(standardCacheKey, cacheKey)) {
 350                      return null;
 351                  }
 352                  break;
 353              }
 354          }
 355          if (override == null) {
<abbr title=" 356              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid value&quot;);"> 356              throw new IllegalStateException(&quot;Expected at least one TranslationOverrideStrategy to return a valid vðŸ”µ</abbr>
 357          }
<abbr title=" 358          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTranslatedValue());"> 358          return translation==null?null:replaceEmptyWithNullResponse(((Translation) translation.getCacheItem()).getTðŸ”µ</abbr>
 359      }
 360  
 361      @Override
 362      public StandardCacheItem lookupTranslationFromMap(String key,
 363              Map&lt;String, Map&lt;String, StandardCacheItem&gt;&gt; propertyTranslationMap, String entityId) {
 364  
 365          StandardCacheItem cacheItem = null;
 366          if (propertyTranslationMap.containsKey(key)) {
 367              Map&lt;String, StandardCacheItem&gt; byEntity = propertyTranslationMap.get(key);
 368              cacheItem = byEntity.get(entityId);
 369          }
 370          return cacheItem;
 371      }
 372  
 373      @Override
<abbr title=" 374      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;String, Map&lt;String, Translation&gt;&gt; propertyTranslationMap, String entityId) {"> 374      public Translation findBestTemplateTranslation(String specificPropertyKey, String generalPropertyKey, Map&lt;StriðŸ”µ</abbr>
 375          Translation translation = null;
 376          if (propertyTranslationMap.containsKey(specificPropertyKey)) {
 377              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(specificPropertyKey);
 378              translation = byEntity.get(entityId);
 379          }
 380          if (translation == null &amp;&amp; propertyTranslationMap.containsKey(generalPropertyKey)) {
 381              Map&lt;String, Translation&gt; byEntity = propertyTranslationMap.get(generalPropertyKey);
 382              translation = byEntity.get(entityId);
 383          }
 384          return translation;
 385      }
 386  
 387      protected TranslatedEntity getEntityType(Class&lt;?&gt; entityClass) {
 388          for (Entry&lt;String, TranslatedEntity&gt; entry : TranslatedEntity.getTypes().entrySet()) {
 389              try {
 390                  Class&lt;?&gt; clazz = Class.forName(entry.getKey());
 391                  if (clazz.isAssignableFrom(entityClass)) {
 392                      return entry.getValue();
 393                  }
 394              } catch (ClassNotFoundException e) {
 395                  throw new IllegalArgumentException(&quot;TranslatedEntity type was not set to a known class&quot;, e);
 396              }
 397          }
 398          throw new IllegalArgumentException(entityClass.getName() + &quot; is not a known translatable class&quot;);
 399      }
 400  
 401      protected TranslatedEntity getEntityType(Object entity) {
 402          return getEntityType(entity.getClass());
 403      }
 404  

 405      public TranslatedEntity getAssignableEntityType(String className) {
 406          try {
 407              Class&lt;?&gt; clazz = Class.forName(className);
 408              return getEntityType(clazz);
 409          } catch (ClassNotFoundException e) {
 410              throw new IllegalArgumentException(className + &quot; is not a known translatable class&quot;);
 411          }
 412      }
 413  
 414      @Override
 415      public String getCacheKey(ResultType resultType, TranslatedEntity entityType) {
 416          String cacheKey = StringUtils.join(new String[] { entityType.getFriendlyType()}, &quot;|&quot;);
 417          if (extensionManager != null) {
 418              ExtensionResultHolder&lt;String&gt; result = new ExtensionResultHolder&lt;String&gt;();
 419              extensionManager.getProxy().getCacheKey(cacheKey, resultType, result);
 420              if (result.getResult() != null) {
 421                  cacheKey = result.getResult();
 422              }
 423          }
 424          return cacheKey;
 425      }
 426  
 427      @Override
 428      public List&lt;String&gt; getCacheKeyListForTemplateSite(String propertyName) {
 429          List&lt;String&gt; cacheKeyList = new ArrayList&lt;&gt;();
 430          String cacheKey = StringUtils.join(new String[] {propertyName}, &quot;|&quot;);
 431          if (extensionManager != null) {
 432              ExtensionResultHolder&lt;List&lt;String&gt;&gt; result = new ExtensionResultHolder&lt;List&lt;String&gt;&gt;();
 433              extensionManager.getProxy().getCacheKeyListForTemplateSite(cacheKey, result);
 434              if (result.getResult() != null) {
 435                  cacheKeyList = result.getResult();
 436              }
 437          }
 438          return cacheKeyList;
 439      }
 440  
 441      @Override
 442      public int getThresholdForFullCache() {
 443          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 444              return thresholdForFullCache;
 445          } else {
 446              // don&#x27;t cache when not in a SandBox
 447              return -1;
 448          }
 449      }
 450  
 451      @Override
 452      public void setThresholdForFullCache(int thresholdForFullCache) {
 453          this.thresholdForFullCache = thresholdForFullCache;
 454      }
 455  
 456      @Override
 457      public int getTemplateThresholdForFullCache() {
 458          if (BroadleafRequestContext.getBroadleafRequestContext().isProductionSandBox()) {
 459              return templateThresholdForFullCache;
 460          } else {
 461              // don&#x27;t cache when not in a SandBox
 462              return -1;
 463          }
 464      }
 465  
 466      @Override
 467      public void setTemplateThresholdForFullCache(int templateThresholdForFullCache) {
 468          this.templateThresholdForFullCache = templateThresholdForFullCache;
 469      }
 470  
 471      @Override
 472      public String getDefaultTranslationValue(Object entity, String property, Locale locale,
 473              String requestedDefaultValue) {
 474  
 475          if (returnBlankTranslationForNotDefaultLocale
 476                  &amp;&amp; !localeMatchesDefaultLocale(locale)
 477                  &amp;&amp; !propertyInDefaultLocaleExceptionList(entity, property)) {
 478              return &quot;&quot;;
 479          }
 480  
 481          return requestedDefaultValue;
 482      }
 483  
 484      @Override
<abbr title=" 485      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, List&lt;String&gt; entityIds) {"> 485      public List&lt;Translation&gt; findAllTranslationEntries(TranslatedEntity translatedEntity, ResultType standard, LisðŸ”µ</abbr>
 486          return dao.readAllTranslationEntries(translatedEntity, standard, entityIds);
 487      }
 488  
 489      /**
 490       * Returns true if the passed in entity / property combination is in the defaultLocaleExceptionList
 491       *
 492       * The default implementation checks the &quot;translationExceptionProperties&quot; list to see if the
 493       * property matches one of the regularExpressions in that list.
 494       *
 495       * Implementors are expected to override this method for implementation specific needs.
 496       *
 497       * @param entity
 498       * @param property
 499       * @return
 500       */
 501      protected boolean propertyInDefaultLocaleExceptionList(Object entity, String property) {
 502          TranslatedEntity entityType = getEntityType(entity);
 503          if (entityType != null &amp;&amp; entityType.getFriendlyType() != null) {
 504              for (String exceptionProperty : translationExceptionProperties) {
 505                  if (property.matches(exceptionProperty)) {
 506                      return true;
 507                  }
 508              }
 509          }
 510          return false;
 511      }
 512  
 513      /**
 514       * Returns true if the passed in locale&#x27;s language matches the Broadleaf default locale.
 515       * @param locale
 516       * @return
 517       */
 518      protected boolean localeMatchesDefaultLocale(Locale locale) {
 519          String defaultLanguage = LocaleUtil.findLanguageCode(localeService.findDefaultLocale());
 520  
 521          if (defaultLanguage != null &amp;&amp; locale != null) {
 522              return defaultLanguage.equals(locale.getLanguage());
 523          }
 524          return false;
 525      }
 526  
 527  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            